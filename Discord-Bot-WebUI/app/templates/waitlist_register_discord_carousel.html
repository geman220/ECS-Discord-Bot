{% extends "base_unauthenticated.html" %}

{% block title %}Complete Waitlist Registration - ECS FC Pub League{% endblock %}

{% block head %}
{{ super() }}
<!-- Simple Cropper CSS -->
<style>
    #cropCanvas {
        max-width: 300px;
        max-height: 300px;
        border: 2px solid #007bff;
        border-radius: 8px;
        cursor: move;
    }
    
    .cropper-container {
        position: relative;
        display: inline-block;
    }
    
    #cropperInterface {
        text-align: center;
    }
</style>
{% endblock %}

{% block main_content %}
{% block page_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/waitlist-registration.css') }}" />
{% endblock %}

<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Enhanced Waitlist Registration Modal -->
    <div class="modal fade show" id="waitlistRegistrationModal" tabindex="-1" aria-labelledby="waitlistModalLabel" 
         data-bs-backdrop="static" style="display: block;" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <!-- Modal Header -->
                <div class="modal-header bg-light border-bottom-0 py-3">
                    <h5 class="modal-title fw-bold" id="waitlistModalLabel">
                        <i class="ti ti-user-plus me-2 text-primary"></i>Waitlist Registration
                    </h5>
                </div>
                
                <!-- Modal Body -->
                <div class="modal-body p-0" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                    <form method="POST" action="{{ url_for('auth.waitlist_register_with_discord') }}" 
                          class="needs-validation" enctype="multipart/form-data" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" id="form_action" name="form_action" value="">
                        <input type="hidden" id="cropped_image_data" name="cropped_image_data">
                        
                        <!-- Waitlist Notice -->
                        <div class="alert alert-warning m-3">
                            <h6 class="alert-heading mb-1">
                                <i class="ti ti-clock me-2"></i>You're Joining the Waitlist
                            </h6>
                            <p class="mb-0">All spots for the current season are filled, but you'll be first in line for future openings!</p>
                        </div>

                        <!-- Progress Bar -->
                        <div class="progress mb-3 mx-3">
                            <div id="waitlistProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 14%;" aria-valuenow="14" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="text-center mb-4">
                            <small class="text-muted" id="currentStep">Step 1 of 7</small>
                        </div>

                        <!-- Carousel for Registration Steps -->
                        <div id="waitlistCarousel" class="carousel slide" data-bs-interval="false">
                            <div class="carousel-inner">
                                
                                <!-- Step 1: Contact Information -->
                                <div class="carousel-item active" data-step="1">
                                    <div class="registration-content px-3 pb-4">
                                        <div class="section-header d-flex align-items-center mb-3">
                                            <div class="me-3 text-primary">
                                                <i class="ti ti-user-circle" style="font-size: 2rem;"></i>
                                            </div>
                                            <div>
                                                <h5 class="fw-bold text-primary mb-1">Contact Information</h5>
                                                <small class="text-muted">Let's start with your basic info</small>
                                            </div>
                                        </div>

                                        <div class="card shadow-sm p-3">
                                            <div class="mb-3">
                                                <label for="name" class="form-label">
                                                    <i class="ti ti-id-badge me-1"></i>Full Name <span class="text-danger">*</span>
                                                </label>
                                                <input type="text" class="form-control form-control-lg" id="name" name="name" 
                                                       placeholder="First and Last name" required value="">
                                                <div class="invalid-feedback">Please provide your full name.</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="email" class="form-label">
                                                    <i class="ti ti-mail me-1"></i>Email Address
                                                </label>
                                                <input type="email" class="form-control form-control-lg" id="email" name="email" 
                                                       value="{{ discord_email }}" readonly>
                                                <small class="text-muted">Connected via Discord: {{ discord_username }}</small>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="phone" class="form-label">
                                                    <i class="ti ti-phone me-1"></i>Phone Number <span class="text-danger">*</span>
                                                </label>
                                                <input type="tel" class="form-control form-control-lg" id="phone" name="phone" 
                                                       placeholder="(555) 555-5555" required>
                                                <div class="invalid-feedback">Please provide your phone number.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 2: Profile Picture -->
                                <div class="carousel-item" data-step="2">
                                    <div class="registration-content px-4 pb-4">
                                        <div class="section-header d-flex align-items-center mb-4">
                                            <div class="me-3 text-primary">
                                                <i class="ti ti-camera" style="font-size: 2.5rem;"></i>
                                            </div>
                                            <div>
                                                <h4 class="fw-bold text-primary mb-1">Profile Picture</h4>
                                                <p class="text-muted mb-0">Add a photo to personalize your profile (optional)</p>
                                            </div>
                                        </div>

                                        <div class="card shadow-sm p-4">
                                            <!-- Instructions at top to avoid text overlap -->
                                            <div class="text-center mb-4">
                                                <p class="text-muted mb-0">Upload a clear photo of yourself. This helps teammates and coaches recognize you.</p>
                                            </div>
                                            
                                            <div class="row">
                                                <!-- Profile Picture / Cropper Area -->
                                                <div class="col-md-6 text-center mb-4 mb-md-0">
                                                    <!-- Default Profile Picture Preview -->
                                                    <div id="profilePicturePreview" class="mb-3">
                                                        <div class="avatar-preview mx-auto" style="width: 200px; height: 200px; overflow: hidden; border-radius: 50%; border: 3px solid var(--bs-primary); box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                                            <img id="currentProfilePicture" src="/static/img/default_player.png" 
                                                                 alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover;">
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Cropper Interface (hidden initially) -->
                                                    <div id="cropperInterface" class="d-none">
                                                        <div class="text-center mb-3">
                                                            <canvas id="cropCanvas" class="mx-auto d-block"></canvas>
                                                        </div>
                                                        <div class="text-muted small text-center">
                                                            <i class="ti ti-info-circle me-1"></i>
                                                            Drag to move • Mouse wheel to zoom
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Controls Column -->
                                                <div class="col-md-6">
                                                    <div class="text-center text-md-start" style="margin-top: 4rem;">
                                                        <!-- Initial Instructions -->
                                                        <div id="uploadInstructions">
                                                            <!-- Hidden file input -->
                                                            <input type="file" name="image" id="image" accept="image/*" class="form-control d-none">
                                                            <!-- Button that triggers file input -->
                                                            <button type="button" class="btn btn-lg btn-primary w-100 mb-3" 
                                                                    onclick="document.getElementById('image').click();">
                                                                <i class="ti ti-upload me-1"></i> Select Image
                                                            </button>
                                                            <button type="button" class="btn btn-outline-secondary w-100" 
                                                                    onclick="skipProfilePicture()">
                                                                <i class="ti ti-arrow-right me-1"></i> Skip This Step
                                                            </button>
                                                        </div>
                                                        
                                                        <!-- Cropper Controls (hidden initially) -->
                                                        <div id="cropperControls" class="d-none">
                                                            <p class="mb-4">Perfect! Now adjust your photo using the controls.</p>
                                                            <div class="d-grid gap-2">
                                                                <button type="button" class="btn btn-outline-secondary" 
                                                                        onclick="resetImageSelection()">
                                                                    <i class="ti ti-photo me-1"></i> Choose Different Image
                                                                </button>
                                                                <button type="button" class="btn btn-lg btn-success" 
                                                                        onclick="cropAndSaveProfileImage()">
                                                                    <i class="ti ti-device-floppy me-1"></i> Save Photo & Continue
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 3: League Selection -->
                                <div class="carousel-item" data-step="3">
                                    <div class="registration-content px-3 pb-4">
                                        <div class="section-header d-flex align-items-center mb-3">
                                            <div class="me-3 text-primary">
                                                <i class="ti ti-trophy" style="font-size: 2rem;"></i>
                                            </div>
                                            <div>
                                                <h5 class="fw-bold text-primary mb-1">League Preference</h5>
                                                <small class="text-muted">Which league interests you?</small>
                                            </div>
                                        </div>

                                        <div class="card shadow-sm p-3">
                                            <div class="alert alert-info mb-3 py-2">
                                                <small><i class="ti ti-info-circle me-1"></i>Select the league that best matches your skill level:</small>
                                            </div>
                                            
                                            <div class="mb-2 border rounded p-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" 
                                                           name="preferred_league" id="pub_league_classic" value="pub_league_classic" required>
                                                    <label class="form-check-label" for="pub_league_classic">
                                                        <strong>🏆 Pub League Classic</strong>
                                                        <div class="text-muted small mt-1">
                                                            Our beginner-friendly classic division - it's all about having fun and improving your game. No experience necessary.
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-2 border rounded p-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" 
                                                           name="preferred_league" id="pub_league_premier" value="pub_league_premier" required>
                                                    <label class="form-check-label" for="pub_league_premier">
                                                        <strong>🌟 Pub League Premier</strong>
                                                        <div class="text-muted small mt-1">
                                                            Our Premier Division for low to intermediate recreational players. Bring your C game!
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-2 border rounded p-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" 
                                                           name="preferred_league" id="not_sure" value="not_sure" required>
                                                    <label class="form-check-label" for="not_sure">
                                                        <strong>🤔 Not Sure</strong>
                                                        <div class="text-muted small mt-1">
                                                            We'll help you find the right league based on your experience and preferences.
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="invalid-feedback">Please select a league preference.</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 4: Player Preferences -->
                                <div class="carousel-item" data-step="4">
                                    <div class="registration-content px-4 pb-4">
                                        <div class="section-header d-flex align-items-center mb-4">
                                            <div class="me-3 text-primary">
                                                <i class="ti ti-soccer-field" style="font-size: 2.5rem;"></i>
                                            </div>
                                            <div>
                                                <h4 class="fw-bold text-primary mb-1">Player Information</h4>
                                                <p class="text-muted mb-0">Tell us about your playing preferences</p>
                                            </div>
                                        </div>

                                        <div class="card shadow-sm p-4">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="jersey_size" class="form-label">
                                                        <i class="ti ti-shirt me-1"></i>Jersey Size
                                                    </label>
                                                    <select class="form-select form-select-lg select2-single" id="jersey_size" name="jersey_size">
                                                        <option value="">Select size</option>
                                                        <option value="WS">WS</option>
                                                        <option value="WM">WM</option>
                                                        <option value="WL">WL</option>
                                                        <option value="WXL">WXL</option>
                                                        <option value="AS">AS</option>
                                                        <option value="AM">AM</option>
                                                        <option value="AL">AL</option>
                                                        <option value="AXL">AXL</option>
                                                        <option value="AXXL">AXXL</option>
                                                        <option value="A3XL">A3XL</option>
                                                        <option value="N/A">N/A</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="col-md-6 mb-3">
                                                    <label for="pronouns" class="form-label">
                                                        <i class="ti ti-user me-1"></i>Preferred Pronouns
                                                    </label>
                                                    <select class="form-select form-select-lg select2-single" id="pronouns" name="pronouns">
                                                        <option value="">Select pronouns</option>
                                                        <option value="he/him">He/Him</option>
                                                        <option value="she/her">She/Her</option>
                                                        <option value="they/them">They/Them</option>
                                                        <option value="other">Other</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="col-md-6 mb-3">
                                                    <label for="favorite_position" class="form-label">
                                                        <i class="ti ti-star me-1"></i>Favorite Position
                                                    </label>
                                                    <select class="form-select form-select-lg select2-single" id="favorite_position" name="favorite_position">
                                                        <option value="">Select position</option>
                                                        <option value="goalkeeper">Goalkeeper</option>
                                                        <option value="defender">Defender</option>
                                                        <option value="midfielder">Midfielder</option>
                                                        <option value="forward">Forward</option>
                                                        <option value="winger">Winger</option>
                                                        <option value="striker">Striker</option>
                                                        <option value="center_back">Center Back</option>
                                                        <option value="full_back">Full Back</option>
                                                        <option value="wing_back">Wing Back</option>
                                                        <option value="attacking_midfielder">Attacking Midfielder</option>
                                                        <option value="defensive_midfielder">Defensive Midfielder</option>
                                                        <option value="central_midfielder">Central Midfielder</option>
                                                        <option value="no_preference">No Preference</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="col-md-6 mb-3">
                                                    <label for="frequency_play_goal" class="form-label">
                                                        <i class="ti ti-target me-1"></i>Willingness to Play Goal
                                                    </label>
                                                    <select class="form-select form-select-lg select2-single" id="frequency_play_goal" name="frequency_play_goal">
                                                        <option value="">Select frequency</option>
                                                        <option value="0">Never</option>
                                                        <option value="1">Only if our normal GK is unavailable</option>
                                                        <option value="2">I will fill in as needed</option>
                                                        <option value="3">Half of the time</option>
                                                        <option value="4">Every Game</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="col-12 mb-3">
                                                    <label for="jersey_number" class="form-label">
                                                        <i class="ti ti-hash me-1"></i>Preferred Jersey Number (Optional)
                                                    </label>
                                                    <input type="number" class="form-control form-control-lg" id="jersey_number" 
                                                           name="jersey_number" min="1" max="99" placeholder="1-99">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 5: Availability -->
                                <div class="carousel-item" data-step="5">
                                    <div class="registration-content px-4 pb-4">
                                        <div class="section-header d-flex align-items-center mb-4">
                                            <div class="me-3 text-primary">
                                                <i class="ti ti-calendar me-1" style="font-size: 2.5rem;"></i>
                                            </div>
                                            <div>
                                                <h4 class="fw-bold text-primary mb-1">Availability & Preferences</h4>
                                                <p class="text-muted mb-0">Help us understand your schedule</p>
                                            </div>
                                        </div>

                                        <div class="card shadow-sm p-4">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="expected_weeks_available" class="form-label">
                                                        <i class="ti ti-calendar-stats me-1"></i>Expected Weekly Availability
                                                    </label>
                                                    <select class="form-select form-select-lg select2-single" id="expected_weeks_available" 
                                                            name="expected_weeks_available">
                                                        <option value="">Select availability</option>
                                                        <option value="1-2">1-2 weeks per season</option>
                                                        <option value="3-4">3-4 weeks per season</option>
                                                        <option value="5-6">5-6 weeks per season</option>
                                                        <option value="7-8">7-8 weeks per season</option>
                                                        <option value="9-10">9-10 weeks per season</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="col-md-6 mb-3">
                                                    <label for="willing_to_referee" class="form-label">
                                                        <i class="ti ti-whistle me-1"></i>Interested in Refereeing?
                                                    </label>
                                                    <select class="form-select form-select-lg select2-single" id="willing_to_referee" 
                                                            name="willing_to_referee">
                                                        <option value="">Select option</option>
                                                        <option value="No">No</option>
                                                        <option value="Yes - I'll ref in Classic only">Yes - Classic only</option>
                                                        <option value="Yes - I'll ref in Premier only">Yes - Premier only</option>
                                                        <option value="Yes - I'll ref in Premier or Classic">Yes - Either league</option>
                                                        <option value="I am interested in receiving ref training only">Interested in training only</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="col-12 mb-3">
                                                    <label for="unavailable_dates" class="form-label">
                                                        <i class="ti ti-calendar-off me-1"></i>Unavailable Dates
                                                    </label>
                                                    <input type="text" class="form-control form-control-lg" id="unavailable_dates" 
                                                           name="unavailable_dates" placeholder="e.g., June 15-20, July 4">
                                                    <div class="form-text">List any dates you know you won't be available</div>
                                                </div>
                                                
                                                <div class="col-12">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="available_for_subbing" 
                                                               name="available_for_subbing" value="true" checked>
                                                        <label class="form-check-label" for="available_for_subbing">
                                                            <strong>I'm interested in substitute opportunities while on the waitlist</strong>
                                                        </label>
                                                    </div>
                                                    <div class="form-text">This helps us connect you with teams that need temporary players</div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mt-3">
                                                <div class="col-12">
                                                    <label for="player_notes" class="form-label">
                                                        <i class="ti ti-notes me-1"></i>Additional Notes
                                                    </label>
                                                    <textarea class="form-control form-control-lg" id="player_notes" name="player_notes" 
                                                              rows="3" placeholder="Any specific notes or accommodations needed (optional)"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 6: Positions -->
                                <div class="carousel-item" data-step="6">
                                    <div class="registration-content px-4 pb-4">
                                        <div class="section-header d-flex align-items-center mb-4">
                                            <div class="me-3 text-primary">
                                                <i class="ti ti-list-check" style="font-size: 2.5rem;"></i>
                                            </div>
                                            <div>
                                                <h4 class="fw-bold text-primary mb-1">Position Preferences</h4>
                                                <p class="text-muted mb-0">Select positions you enjoy and prefer to avoid</p>
                                            </div>
                                        </div>

                                        <div class="card shadow-sm p-4">
                                            <div class="row">
                                                <div class="col-md-6 mb-4">
                                                    <label class="form-label fw-semibold mb-3">
                                                        <i class="ti ti-heart me-1 text-success"></i>Other Positions You Enjoy
                                                    </label>
                                                    <div class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                                                        <div class="row g-2">
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="other_positions" value="goalkeeper" id="other_goalkeeper">
                                                                    <label class="form-check-label small" for="other_goalkeeper">Goalkeeper</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="other_positions" value="defender" id="other_defender">
                                                                    <label class="form-check-label small" for="other_defender">Defender</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="other_positions" value="midfielder" id="other_midfielder">
                                                                    <label class="form-check-label small" for="other_midfielder">Midfielder</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="other_positions" value="forward" id="other_forward">
                                                                    <label class="form-check-label small" for="other_forward">Forward</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="other_positions" value="winger" id="other_winger">
                                                                    <label class="form-check-label small" for="other_winger">Winger</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="other_positions" value="striker" id="other_striker">
                                                                    <label class="form-check-label small" for="other_striker">Striker</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="other_positions" value="center_back" id="other_center_back">
                                                                    <label class="form-check-label small" for="other_center_back">Center Back</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="other_positions" value="full_back" id="other_full_back">
                                                                    <label class="form-check-label small" for="other_full_back">Full Back</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="other_positions" value="wing_back" id="other_wing_back">
                                                                    <label class="form-check-label small" for="other_wing_back">Wing Back</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="other_positions" value="attacking_midfielder" id="other_attacking_midfielder">
                                                                    <label class="form-check-label small" for="other_attacking_midfielder">Attack Mid</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="other_positions" value="defensive_midfielder" id="other_defensive_midfielder">
                                                                    <label class="form-check-label small" for="other_defensive_midfielder">Def Mid</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="other_positions" value="central_midfielder" id="other_central_midfielder">
                                                                    <label class="form-check-label small" for="other_central_midfielder">Central Mid</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-12">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="other_positions" value="no_preference" id="other_no_preference">
                                                                    <label class="form-check-label small" for="other_no_preference">No Preference</label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-text mt-2">Select multiple positions you enjoy playing</div>
                                                </div>
                                                
                                                <div class="col-md-6 mb-4">
                                                    <label class="form-label fw-semibold mb-3">
                                                        <i class="ti ti-x me-1 text-danger"></i>Positions to Avoid
                                                    </label>
                                                    <div class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                                                        <div class="row g-2">
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="positions_not_to_play" value="goalkeeper" id="avoid_goalkeeper">
                                                                    <label class="form-check-label small" for="avoid_goalkeeper">Goalkeeper</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="positions_not_to_play" value="defender" id="avoid_defender">
                                                                    <label class="form-check-label small" for="avoid_defender">Defender</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="positions_not_to_play" value="midfielder" id="avoid_midfielder">
                                                                    <label class="form-check-label small" for="avoid_midfielder">Midfielder</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="positions_not_to_play" value="forward" id="avoid_forward">
                                                                    <label class="form-check-label small" for="avoid_forward">Forward</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="positions_not_to_play" value="winger" id="avoid_winger">
                                                                    <label class="form-check-label small" for="avoid_winger">Winger</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="positions_not_to_play" value="striker" id="avoid_striker">
                                                                    <label class="form-check-label small" for="avoid_striker">Striker</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="positions_not_to_play" value="center_back" id="avoid_center_back">
                                                                    <label class="form-check-label small" for="avoid_center_back">Center Back</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="positions_not_to_play" value="full_back" id="avoid_full_back">
                                                                    <label class="form-check-label small" for="avoid_full_back">Full Back</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="positions_not_to_play" value="wing_back" id="avoid_wing_back">
                                                                    <label class="form-check-label small" for="avoid_wing_back">Wing Back</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="positions_not_to_play" value="attacking_midfielder" id="avoid_attacking_midfielder">
                                                                    <label class="form-check-label small" for="avoid_attacking_midfielder">Attack Mid</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="positions_not_to_play" value="defensive_midfielder" id="avoid_defensive_midfielder">
                                                                    <label class="form-check-label small" for="avoid_defensive_midfielder">Def Mid</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="positions_not_to_play" value="central_midfielder" id="avoid_central_midfielder">
                                                                    <label class="form-check-label small" for="avoid_central_midfielder">Central Mid</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-12">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="positions_not_to_play" value="no_preference" id="avoid_no_preference">
                                                                    <label class="form-check-label small" for="avoid_no_preference">No Preference</label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-text mt-2">Select positions you prefer to avoid</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 7: Waiver & Terms -->
                                <div class="carousel-item" data-step="7">
                                    <div class="registration-content px-4 pb-4">
                                        <div class="section-header d-flex align-items-center mb-4">
                                            <div class="me-3 text-primary">
                                                <i class="ti ti-file-text" style="font-size: 2.5rem;"></i>
                                            </div>
                                            <div>
                                                <h4 class="fw-bold text-primary mb-1">Terms & Conditions</h4>
                                                <p class="text-muted mb-0">Please review and accept our terms</p>
                                            </div>
                                        </div>

                                        <div class="card shadow-sm p-4">
                                            <div class="alert alert-warning mb-3">
                                                <h6>⚠️ Please Read Before Completing Registration</h6>
                                                <p class="small mb-0">Registration requires acceptance of our liability waiver and code of conduct.</p>
                                            </div>
                                            
                                            <div class="waiver-content" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
                                                <h6><strong>Waiver of Liability and Hold Harmless Agreement</strong></h6>
                                                <p class="small">"Participant" hereby releases, waives, discharges and covenants not to sue ECS Pub League, a Washington nonprofit organization, and its affiliated associations, officers, directors, employees, agents, and contractors (collectively, the "Released Parties") from any and all liability, claims, demands, actions and causes of action whatsoever arising out of or related to any loss, damage, or injury, including death, that may be sustained by Participant, or to any property belonging to Participant, whether caused by the negligence of the Released Parties, or otherwise, while participating in such athletic and related event activities, or while in, on or upon the premises where the activities are being conducted.</p>
                                                
                                                <p class="small">Participant is fully aware of risks and hazards connected with the proposed soccer activity, including the risk of injury to a participant's neck, back, spine, knees or other parts of their body, and Participant hereby elects to participate as a voluntary participant in said activity, and to enter the premises of the various fields used to conduct soccer games or training and engage in such activity knowing that the activity may be hazardous to Participant or Participant's property. PARTICIPANT VOLUNTARILY ASSUMES FULL RESPONSIBILITY FOR ANY RISKS OF LOSS, PROPERTY DAMAGE OR PERSONAL INJURY, INCLUDING DEATH, that may be sustained by any of its players, coaches, opponents, or fans, or any loss or damage to property owned by Participant, as a result of being engaged in such an activity, whether caused by the negligence of the Released Parties or otherwise.</p>
                                                
                                                <p class="small">Participant acknowledges that ECS Pub League does not carry insurance on behalf of the Participant. Participant further hereby agrees to indemnify and hold harmless the Released Parties from and against any loss, liability, damage or costs, including court costs and attorney's fees, that they may incur due to Participant's participation in the proposed league activities, whether caused by the negligence of the Released Parties or otherwise. Participant agrees that this Waiver of Liability and Hold Harmless Agreement shall be construed in accordance with the laws of the State of Washington. Participant acknowledges full, adequate and complete consideration and intends to be bound by the terms contained herein.</p>
                                                
                                                <h6><strong>ECS Pub League Code of Conduct</strong></h6>
                                                <p class="small">Participant further acknowledges and accepts as a condition of participation that ECS Pub League is a 21+ adult recreational league for very casual no/low contact soccer for beginners and beginner-friendly low-intermediate recreational players. We're not for everyone. Our level of skill, physicality, and competitiveness is typically well below even the lowest divisions of other leagues.</p>
                                                
                                                <p class="small">We do not discriminate based on race, color, religion, gender, gender expression, age, national origin, ancestry, disability, marital status, sexual orientation, or military status, in any of our activities or operations.</p>
                                                
                                                <p class="small">We do, however, reserve the right to deny play at any time for anyone who is deemed a poor fit for the league's mission and the culture of the unique community we serve because of skill, experience, physicality, competitiveness, or similar reasons.</p>
                                                
                                                <p class="small"><strong>More serious infractions may result in yellow cards, red cards, suspensions, or expulsion from the league:</strong></p>
                                                <ul class="small">
                                                    <li>Excessive physical play and tackling, whether called as fouls or not. The bar is set intentionally lower in this league.</li>
                                                    <li>Repeated dissent and/or unsporting behavior by words or action, including excessive arguing with referees and/or other players.</li>
                                                    <li>Playing in a dangerous manner that causes or threatens to cause injury.</li>
                                                </ul>
                                                
                                                <p class="small"><strong>PARTICIPANT HAS READ THIS WAIVER OF LIABILITY AND CODE OF CONDUCT AND FULLY UNDERSTAND ITS TERMS, UNDERSTANDS THAT THEY HAVE GIVEN UP SUBSTANTIAL RIGHTS AND AGREES TO IT BY REGISTERING TO PLAY IN THE LEAGUE, DOING SO FREELY AND VOLUNTARILY WITHOUT ANY INDUCEMENT.</strong></p>
                                            </div>
                                            
                                            <div class="form-check mt-3">
                                                <input type="checkbox" class="form-check-input" id="terms-agreement-waitlist" 
                                                       name="terms_agreement" required>
                                                <label class="form-check-label" for="terms-agreement-waitlist">
                                                    <strong>I have read and agree to the ECS FC terms and conditions, liability waiver, and code of conduct</strong>
                                                </label>
                                                <div class="invalid-feedback">You must accept the terms and conditions to continue.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Navigation Buttons -->
                            <div class="d-flex justify-content-between mt-3 px-4 pb-3" id="carouselControls">
                                <button class="btn btn-lg btn-outline-secondary" type="button" id="previousButton">
                                    <i class="ti ti-chevron-left me-2"></i> Previous
                                </button>
                                <button class="btn btn-lg btn-primary" type="button" id="nextOrSaveButton">
                                    Next <i class="ti ti-chevron-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Registration content styling */
    .registration-content {
        max-height: 60vh;
        overflow-y: auto;
        padding-bottom: 80px;
    }
    
    .registration-content::-webkit-scrollbar {
        width: 6px;
    }
    
    .registration-content::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .registration-content::-webkit-scrollbar-thumb {
        background: var(--bs-primary);
        border-radius: 4px;
    }
    
    /* Modal improvements */
    #waitlistRegistrationModal .modal-dialog {
        max-width: 900px;
    }
    
    /* Step indicators */
    .section-header {
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
    }
    
    /* Form control styling */
    .form-control:required,
    .form-select:required {
        border-left: 3px solid var(--bs-primary);
    }
    
    /* Waiver content */
    .waiver-content {
        scrollbar-width: thin;
        scrollbar-color: var(--bs-primary) #f1f1f1;
    }
    
    .waiver-content::-webkit-scrollbar {
        width: 8px;
    }
    
    .waiver-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .waiver-content::-webkit-scrollbar-thumb {
        background: var(--bs-primary);
        border-radius: 4px;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .registration-content {
            max-height: 55vh;
            padding: 15px;
        }
        
        #carouselControls .btn {
            padding: 8px 16px;
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block custom_js %}
<!-- Include the simple cropper script -->
<script src="{{ url_for('static', filename='custom_js/simple-cropper.js') }}"></script>

<!-- Waitlist Registration Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Core elements
    const modalElement = document.getElementById('waitlistRegistrationModal');
    const carouselElement = document.getElementById('waitlistCarousel');
    const nextOrSaveButton = document.getElementById('nextOrSaveButton');
    const previousButton = document.getElementById('previousButton');
    const progressIndicator = document.getElementById('waitlistProgress');
    const form = modalElement ? modalElement.querySelector('form.needs-validation') : null;
    const formActionInput = document.getElementById('form_action');
    const imageInput = document.getElementById('image');
    const croppedImageHiddenInput = document.getElementById('cropped_image_data');
    
    // State variables
    let totalSteps = 7;
    let bootstrapCarousel;
    
    // Initialize modal
    if (modalElement) {
        const waitlistModal = new bootstrap.Modal(modalElement, {
            backdrop: 'static',
            keyboard: false
        });
        
        modalElement.addEventListener('shown.bs.modal', function() {
            updateProgress();
        });
        
    }
    
    // Initialize carousel
    if (carouselElement) {
        bootstrapCarousel = new bootstrap.Carousel(carouselElement, {
            interval: false,
            ride: false,
            touch: false,
            wrap: false,
            keyboard: false
        });
        
        carouselElement.addEventListener('slid.bs.carousel', function() {
            updateNavButtons();
            updateProgress();
        });
    }
    
    // Initialize Simple Cropper
    if (modalElement) {
        if (!window.SimpleCropperInstance) {
            window.SimpleCropperInstance = initializeSimpleCropper('cropCanvas');
        }
        
        // File input listener
        if (imageInput && !imageInput.hasAttribute('data-listener-added')) {
            imageInput.setAttribute('data-listener-added', 'true');
            imageInput.addEventListener('change', function(e) {
                window.loadImageIntoCropper(this);
            });
        }
    }
    
    // Navigation button handlers
    if (nextOrSaveButton) {
        nextOrSaveButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const step = getCurrentStep();
            
            // Final step - submit form
            if (step === totalSteps) {
                if (formActionInput) formActionInput.value = 'complete_registration';
                
                // Check if cropper has image
                if (window.cropper) {
                    try {
                        const canvas = window.cropper.getCroppedCanvas();
                        if (canvas) {
                            croppedImageHiddenInput.value = canvas.toDataURL('image/png');
                        }
                    } catch (err) {
                        console.error('Error getting cropped image:', err);
                    }
                }
                
                // Validate and submit
                if (form && form.checkValidity()) {
                    form.submit();
                } else {
                    form.classList.add('was-validated');
                    
                    const firstInvalid = form.querySelector(':invalid');
                    if (firstInvalid) {
                        firstInvalid.focus();
                        firstInvalid.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                }
            } else {
                // Validate current step before moving to next
                const activeItem = carouselElement.querySelector('.carousel-item.active');
                const requiredFields = activeItem ? activeItem.querySelectorAll('input[required]:not([type="checkbox"]):not([type="radio"]), select[required], textarea[required]') : [];
                const requiredRadios = activeItem ? activeItem.querySelectorAll('input[type="radio"][required]') : [];
                const requiredCheckboxes = activeItem ? activeItem.querySelectorAll('input[type="checkbox"][required]') : [];
                
                let isValid = true;
                
                // Validate text inputs and selects
                requiredFields.forEach(field => {
                    if (field.offsetParent === null) return; // Skip hidden fields
                    
                    if (!field.checkValidity()) {
                        isValid = false;
                        field.classList.add('is-invalid');
                        
                        if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('invalid-feedback')) {
                            const feedback = document.createElement('div');
                            feedback.className = 'invalid-feedback';
                            feedback.textContent = field.validationMessage || 'This field is required.';
                            field.parentNode.insertBefore(feedback, field.nextSibling);
                        }
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });
                
                // Validate radio groups
                if (requiredRadios.length > 0) {
                    const radioName = requiredRadios[0].name;
                    const checkedRadio = activeItem.querySelector(`input[type="radio"][name="${radioName}"]:checked`);
                    if (!checkedRadio) {
                        isValid = false;
                        requiredRadios.forEach(radio => {
                            radio.classList.add('is-invalid');
                        });
                    } else {
                        requiredRadios.forEach(radio => {
                            radio.classList.remove('is-invalid');
                        });
                    }
                }
                
                // Validate required checkboxes (like terms agreement)
                requiredCheckboxes.forEach(checkbox => {
                    if (!checkbox.checked) {
                        isValid = false;
                        checkbox.classList.add('is-invalid');
                    } else {
                        checkbox.classList.remove('is-invalid');
                    }
                });
                
                if (isValid) {
                    if (bootstrapCarousel) {
                        bootstrapCarousel.next();
                    }
                } else {
                    const firstInvalid = activeItem.querySelector('.is-invalid');
                    if (firstInvalid) {
                        firstInvalid.focus();
                        firstInvalid.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                }
            }
        });
    }
    
    if (previousButton) {
        previousButton.addEventListener('click', function() {
            if (bootstrapCarousel) bootstrapCarousel.prev();
        });
    }
    
    // Helper functions
    function getCurrentStep() {
        if (!carouselElement) return -1;
        const activeItem = carouselElement.querySelector('.carousel-item.active');
        if (!activeItem) return -1;
        const stepAttr = activeItem.getAttribute('data-step');
        return stepAttr ? parseInt(stepAttr) : -1;
    }
    
    function updateNavButtons() {
        const step = getCurrentStep();
        
        // Hide previous button on first step
        if (step === 1 && previousButton) {
            previousButton.classList.add('d-none');
        } else if (previousButton) {
            previousButton.classList.remove('d-none');
        }
        
        // Change next button to submit on final step
        if (step === totalSteps && nextOrSaveButton) {
            nextOrSaveButton.innerHTML = '<i class="ti ti-check me-2"></i>Complete Registration';
            nextOrSaveButton.classList.remove('btn-primary');
            nextOrSaveButton.classList.add('btn-success');
        } else if (nextOrSaveButton) {
            nextOrSaveButton.innerHTML = 'Next <i class="ti ti-chevron-right ms-2"></i>';
            nextOrSaveButton.classList.remove('btn-success');
            nextOrSaveButton.classList.add('btn-primary');
        }
    }
    
    function updateProgress() {
        if (!progressIndicator) return;
        
        const step = getCurrentStep();
        const progress = Math.floor((step / totalSteps) * 100);
        
        progressIndicator.style.width = `${progress}%`;
        progressIndicator.setAttribute('aria-valuenow', progress);
        
        const stepDisplay = document.getElementById('currentStep');
        if (stepDisplay) {
            stepDisplay.textContent = `Step ${step} of ${totalSteps}`;
        }
    }
    
    // Real-time validation feedback
    modalElement?.addEventListener('input', function(e) {
        if (e.target.matches('input[required], select[required], textarea[required]')) {
            if (e.target.checkValidity()) {
                e.target.classList.remove('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
            }
        }
    });
    
    // Initialize everything
    updateNavButtons();
    updateProgress();
});

// Skip profile picture function
function skipProfilePicture() {
    const carousel = bootstrap.Carousel.getInstance(document.getElementById('waitlistCarousel'));
    if (carousel) {
        carousel.next();
    }
}

// Reset image selection
function resetImageSelection() {
    document.getElementById('image').value = '';
    document.getElementById('cropperInterface').classList.add('d-none');
    document.getElementById('uploadInstructions').classList.remove('d-none');
    document.getElementById('profilePicturePreview').classList.remove('d-none');
    document.getElementById('cropperControls').classList.add('d-none');
    
    if (window.cropper) {
        window.cropper.destroy();
        window.cropper = null;
    }
}

// Crop and save profile image
function cropAndSaveProfileImage() {
    if (window.cropper) {
        try {
            const canvas = window.cropper.getCroppedCanvas({
                width: 300,
                height: 300,
                imageSmoothingQuality: 'high'
            });
            
            if (canvas) {
                const dataUrl = canvas.toDataURL('image/png');
                document.getElementById('cropped_image_data').value = dataUrl;
                document.getElementById('currentProfilePicture').src = dataUrl;
                
                // Reset UI
                resetImageSelection();
                
                // Move to next step
                const carousel = bootstrap.Carousel.getInstance(document.getElementById('waitlistCarousel'));
                if (carousel) {
                    carousel.next();
                }
            }
        } catch (err) {
            console.error('Error cropping image:', err);
            alert('Error cropping image. Please try again.');
        }
    }
}
</script>
{% endblock %}