{% extends "base_unauthenticated.html" %}

{% block title %}Join the Waitlist - ECS FC Pub League{% endblock %}

{% block page_css %}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/authentication.css') }}" />
{% endif %}
{% endblock %}

{% block main_content %}
<div class="c-auth-wrapper c-auth-wrapper--wide" data-component="auth-wrapper">
    <!-- Logo Section -->
    <div class="c-auth-logo" data-component="auth-logo">
        <img src="{{ url_for('static', filename='img/ecs_logo.png') }}"
             alt="ECS Logo"
             class="c-auth-logo__image">
        <div class="c-auth-logo__divider"></div>
        <img src="{{ url_for('static', filename='img/ecs_pl_logo.png') }}"
             alt="ECS FC Pub League Logo"
             class="c-auth-logo__image">
    </div>

    <!-- Waitlist Registration Form -->
    <div class="c-auth-form" data-component="auth-form">
        <div class="c-auth-form__header">
            <h1 class="c-auth-form__title">Join the Waitlist</h1>
            <p class="c-auth-form__subtitle">Step <span id="currentStepNum">1</span> of 4</p>
        </div>

        <!-- Progress Bar -->
        <div class="c-auth-progress">
            <div class="c-auth-progress__bar" id="progressBar" style="width: 25%"></div>
        </div>

        <div class="c-auth-form__body">
            <form method="POST" action="{{ url_for('auth.waitlist_register_with_discord') }}"
                  id="waitlistForm" data-form="waitlist-register" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" id="cropped_image_data" name="cropped_image_data">

                <!-- Step 1: Contact Information -->
                <div class="c-auth-step" id="step1" data-step="1">
                    <!-- Waitlist Notice -->
                    <div class="c-auth-alert c-auth-alert--warning" data-alert>
                        <h6 class="c-auth-alert__title">
                            <i class="ti ti-clock"></i>
                            You're Joining the Waitlist
                        </h6>
                        <p class="c-auth-alert__text">
                            All spots for the current season are filled, but you'll be first in line for future openings!
                        </p>
                    </div>

                    <!-- Discord Account Info -->
                    <div class="c-auth-alert c-auth-alert--info" data-alert>
                        <h6 class="c-auth-alert__title">
                            <i class="ti ti-brand-discord"></i>
                            Discord Connected
                        </h6>
                        <p class="c-auth-alert__text">
                            <strong>{{ discord_username }}</strong>
                        </p>
                    </div>

                    <div class="c-auth-input-group">
                        <label class="c-auth-input-group__label" for="waitlist-name">
                            Full Name <span class="c-auth-input-group__required">*</span>
                        </label>
                        <input type="text"
                               class="c-auth-input"
                               id="waitlist-name"
                               name="name"
                               placeholder="First and Last name"
                               required>
                    </div>

                    <div class="c-auth-input-group">
                        <label class="c-auth-input-group__label" for="waitlist-email">
                            Email Address
                        </label>
                        <input type="email"
                               class="c-auth-input c-auth-input--readonly"
                               id="waitlist-email"
                               name="email"
                               value="{{ discord_email }}"
                               readonly>
                    </div>

                    <div class="c-auth-input-group">
                        <label class="c-auth-input-group__label" for="waitlist-phone">
                            Phone Number <span class="c-auth-input-group__required">*</span>
                        </label>
                        <input type="tel"
                               class="c-auth-input"
                               id="waitlist-phone"
                               name="phone"
                               placeholder="(555) 555-5555"
                               inputmode="tel"
                               required>
                    </div>
                </div>

                <!-- Step 2: League Preference -->
                <div class="c-auth-step c-auth-step--hidden" id="step2" data-step="2">
                    <h6 class="c-auth-section__title">
                        <i class="ti ti-trophy"></i>
                        Which league interests you?
                    </h6>

                    <div class="c-auth-radio-group">
                        <label class="c-auth-radio">
                            <input type="radio" name="preferred_league" value="pub_league_classic" class="c-auth-radio__input" required>
                            <span class="c-auth-radio__box"></span>
                            <span class="c-auth-radio__content">
                                <strong class="c-auth-radio__title">Pub League Classic</strong>
                                <span class="c-auth-radio__desc">Beginner-friendly - all about having fun!</span>
                            </span>
                        </label>

                        <label class="c-auth-radio">
                            <input type="radio" name="preferred_league" value="pub_league_premier" class="c-auth-radio__input">
                            <span class="c-auth-radio__box"></span>
                            <span class="c-auth-radio__content">
                                <strong class="c-auth-radio__title">Pub League Premier</strong>
                                <span class="c-auth-radio__desc">Low-intermediate recreational players</span>
                            </span>
                        </label>

                        <label class="c-auth-radio">
                            <input type="radio" name="preferred_league" value="not_sure" class="c-auth-radio__input">
                            <span class="c-auth-radio__box"></span>
                            <span class="c-auth-radio__content">
                                <strong class="c-auth-radio__title">Not Sure</strong>
                                <span class="c-auth-radio__desc">We'll help you find the right fit</span>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Step 3: Player Information -->
                <div class="c-auth-step c-auth-step--hidden" id="step3" data-step="3">
                    <h6 class="c-auth-section__title">
                        <i class="ti ti-user"></i>
                        Tell us about yourself
                    </h6>

                    <div class="c-auth-input-row">
                        <div class="c-auth-input-group c-auth-input-group--half">
                            <label class="c-auth-input-group__label" for="waitlist-jersey">Jersey Size</label>
                            <select class="c-auth-select" id="waitlist-jersey" name="jersey_size">
                                <option value="">Select size</option>
                                <option value="WS">WS</option>
                                <option value="WM">WM</option>
                                <option value="WL">WL</option>
                                <option value="WXL">WXL</option>
                                <option value="AS">AS</option>
                                <option value="AM">AM</option>
                                <option value="AL">AL</option>
                                <option value="AXL">AXL</option>
                                <option value="AXXL">AXXL</option>
                                <option value="A3XL">A3XL</option>
                            </select>
                        </div>

                        <div class="c-auth-input-group c-auth-input-group--half">
                            <label class="c-auth-input-group__label" for="waitlist-pronouns">Pronouns</label>
                            <select class="c-auth-select" id="waitlist-pronouns" name="pronouns">
                                <option value="">Select pronouns</option>
                                <option value="he/him">He/Him</option>
                                <option value="she/her">She/Her</option>
                                <option value="they/them">They/Them</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="c-auth-input-row">
                        <div class="c-auth-input-group c-auth-input-group--half">
                            <label class="c-auth-input-group__label" for="waitlist-position">Favorite Position</label>
                            <select class="c-auth-select" id="waitlist-position" name="favorite_position">
                                <option value="">Select position</option>
                                <option value="goalkeeper">Goalkeeper</option>
                                <option value="defender">Defender</option>
                                <option value="midfielder">Midfielder</option>
                                <option value="forward">Forward</option>
                                <option value="no_preference">No Preference</option>
                            </select>
                        </div>

                        <div class="c-auth-input-group c-auth-input-group--half">
                            <label class="c-auth-input-group__label" for="waitlist-goal">Willingness to Play Goal</label>
                            <select class="c-auth-select" id="waitlist-goal" name="frequency_play_goal">
                                <option value="">Select</option>
                                <option value="0">Never</option>
                                <option value="1">Only if needed</option>
                                <option value="2">I'll fill in</option>
                                <option value="4">Every game</option>
                            </select>
                        </div>
                    </div>

                    <div class="c-auth-input-group">
                        <label class="c-auth-input-group__label" for="waitlist-weeks">Expected Availability</label>
                        <select class="c-auth-select" id="waitlist-weeks" name="expected_weeks_available">
                            <option value="">Select availability</option>
                            <option value="1-2">1-2 weeks per season</option>
                            <option value="3-4">3-4 weeks per season</option>
                            <option value="5-6">5-6 weeks per season</option>
                            <option value="7-8">7-8 weeks per season</option>
                            <option value="9-10">9-10 weeks per season</option>
                        </select>
                    </div>

                    <div class="c-auth-checkbox">
                        <input type="checkbox"
                               class="c-auth-checkbox__input"
                               id="waitlist-subbing"
                               name="available_for_subbing"
                               value="true"
                               checked>
                        <label class="c-auth-checkbox__label" for="waitlist-subbing">
                            I'm interested in substitute opportunities while on the waitlist
                        </label>
                    </div>
                </div>

                <!-- Step 4: Terms & Submit -->
                <div class="c-auth-step c-auth-step--hidden" id="step4" data-step="4">
                    <div class="c-waiver" data-component="waiver">
                        <div class="c-waiver__header">
                            <h6 class="c-waiver__header-title">Terms & Conditions</h6>
                            <p class="c-auth-alert__text c-auth-alert__text--mt-xs">
                                Please read and accept our liability waiver and code of conduct.
                            </p>
                        </div>

                        <div class="c-waiver__content">
                            <h6 class="c-waiver__section-title">Waiver of Liability</h6>
                            <p>"Participant" hereby releases, waives, discharges and covenants not to sue ECS Pub League from any and all liability, claims, demands, actions and causes of action whatsoever arising out of or related to any loss, damage, or injury, including death, that may be sustained by Participant while participating in athletic activities.</p>

                            <p>Participant is fully aware of risks and hazards connected with the proposed soccer activity and VOLUNTARILY ASSUMES FULL RESPONSIBILITY FOR ANY RISKS OF LOSS, PROPERTY DAMAGE OR PERSONAL INJURY.</p>

                            <h6 class="c-waiver__section-title">Code of Conduct</h6>
                            <p>ECS Pub League is a 21+ adult recreational league for casual, low-contact soccer. We reserve the right to deny play for anyone deemed a poor fit for the league's mission.</p>

                            <p><strong>Infractions may result in yellow cards, red cards, suspensions, or expulsion:</strong></p>
                            <ul class="c-waiver__list">
                                <li class="c-waiver__list-item">Excessive physical play and tackling</li>
                                <li class="c-waiver__list-item">Repeated dissent or unsporting behavior</li>
                                <li class="c-waiver__list-item">Playing in a dangerous manner</li>
                            </ul>
                        </div>
                    </div>

                    <div class="c-auth-checkbox">
                        <input type="checkbox"
                               class="c-auth-checkbox__input"
                               id="terms-agreement"
                               name="terms_agreement"
                               required>
                        <label class="c-auth-checkbox__label" for="terms-agreement">
                            I agree to the ECS FC terms, liability waiver, and code of conduct
                        </label>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="c-auth-btn-row c-auth-btn-row--wizard">
                    <button type="button"
                            class="c-auth-btn c-auth-btn--outline"
                            id="prevBtn"
                            style="display: none;">
                        <i class="ti ti-chevron-left"></i> Back
                    </button>
                    <button type="button"
                            class="c-auth-btn c-auth-btn--primary c-auth-btn--flex-grow"
                            id="nextBtn">
                        Next <i class="ti ti-chevron-right"></i>
                    </button>
                    <button type="submit"
                            class="c-auth-btn c-auth-btn--primary c-auth-btn--flex-grow"
                            id="submitBtn"
                            style="display: none;"
                            disabled>
                        Join Waitlist
                    </button>
                </div>
            </form>

            <!-- Footer Links -->
            <div class="c-auth-form__footer">
                <p class="c-auth-form__footer-text">
                    Already have an account?
                    <a href="{{ url_for('auth.login') }}" class="c-auth-link">Sign in</a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
(function() {
    const form = document.getElementById('waitlistForm');
    const steps = document.querySelectorAll('.c-auth-step');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const progressBar = document.getElementById('progressBar');
    const stepNum = document.getElementById('currentStepNum');
    const totalSteps = steps.length;
    let currentStep = 1;

    function showStep(step) {
        steps.forEach((s, i) => {
            s.classList.toggle('c-auth-step--hidden', i + 1 !== step);
        });

        // Update progress
        const progress = (step / totalSteps) * 100;
        progressBar.style.width = progress + '%';
        stepNum.textContent = step;

        // Update buttons
        prevBtn.style.display = step === 1 ? 'none' : 'inline-flex';

        if (step === totalSteps) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'inline-flex';
            updateSubmitState();
        } else {
            nextBtn.style.display = 'inline-flex';
            submitBtn.style.display = 'none';
        }
    }

    function validateStep(step) {
        const stepEl = document.getElementById('step' + step);
        const requiredInputs = stepEl.querySelectorAll('[required]');
        let valid = true;

        requiredInputs.forEach(input => {
            if (input.type === 'radio') {
                const name = input.name;
                const checked = stepEl.querySelector(`input[name="${name}"]:checked`);
                if (!checked) valid = false;
            } else if (!input.value.trim()) {
                valid = false;
                input.classList.add('c-auth-input--error');
            } else {
                input.classList.remove('c-auth-input--error');
            }
        });

        return valid;
    }

    function updateSubmitState() {
        const termsCheckbox = document.getElementById('terms-agreement');
        submitBtn.disabled = !termsCheckbox.checked;
    }

    // Event Listeners
    nextBtn.addEventListener('click', function() {
        if (validateStep(currentStep)) {
            currentStep++;
            showStep(currentStep);
        }
    });

    prevBtn.addEventListener('click', function() {
        currentStep--;
        showStep(currentStep);
    });

    // Terms checkbox
    document.getElementById('terms-agreement').addEventListener('change', updateSubmitState);

    // Phone formatting
    const phoneInput = document.getElementById('waitlist-phone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 6) {
                value = '(' + value.substring(0,3) + ') ' + value.substring(3,6) + '-' + value.substring(6,10);
            } else if (value.length >= 3) {
                value = '(' + value.substring(0,3) + ') ' + value.substring(3);
            }
            e.target.value = value;
        });
    }

    // Initialize
    showStep(1);
})();
</script>
{% endblock %}
