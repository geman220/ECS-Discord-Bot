{# Integrations Settings Tab Partial #}
<div class="c-settings-tab" id="tab-integrations" role="tabpanel" data-component="settings-tab" data-tab-pane="integrations">
    <div class="row">
        <!-- Discord Integration -->
        <div class="col-lg-6 mb-4">
            <div class="c-settings-c-card" data-component="settings-card">
                <div class="c-settings-card__header">
                    <div class="c-settings-card__icon c-settings-card__icon--discord">
                        <i class="ti ti-brand-discord"></i>
                    </div>
                    <div class="c-settings-card__header-info">
                        <h5 class="c-settings-card__title">Discord</h5>
                        <small class="c-settings-card__subtitle">Connect your Discord account</small>
                    </div>
                </div>
                <div class="c-settings-card__body c-settings-card__body--centered">
                    {% if safe_current_user.player and safe_current_user.player.discord_id %}
                    <div class="c-status-circle c-status-circle--discord">
                        <i class="ti ti-brand-discord"></i>
                    </div>
                    <h6 class="c-status-text c-status-text--success">
                        <i class="ti ti-check"></i> Connected
                    </h6>
                    <p class="c-status-description">Discord ID: {{ safe_current_user.player.discord_id }}</p>

                    <div class="c-btn-group c-btn-group--stacked mt-4" data-component="button-group">
                        <form id="syncDiscordRolesForm" action="{{ url_for('auth.sync_discord_roles') }}" method="POST">
                            <button type="submit" class="c-settings-btn c-settings-btn--outline-primary c-settings-btn--block" data-action="sync-roles">
                                <i class="ti ti-refresh"></i>
                                Sync Discord Roles
                            </button>
                        </form>
                        <form id="unlinkDiscordForm" action="{{ url_for('account.unlink_discord') }}" method="POST">
                            <button type="submit" class="c-settings-btn c-settings-btn--outline-danger c-settings-btn--block" data-action="unlink-discord">
                                <i class="ti ti-link-off"></i>
                                Disconnect Discord
                            </button>
                        </form>
                    </div>
                    {% else %}
                    <div class="c-status-circle c-status-circle--muted">
                        <i class="ti ti-brand-discord"></i>
                    </div>
                    <h6 class="c-status-text c-status-text--muted">Not Connected</h6>
                    <p class="c-status-description">Link your Discord to access more features</p>

                    <div class="c-info-box mt-3 mb-4" data-component="info-box">
                        <h6 class="c-info-box__title">Benefits of connecting:</h6>
                        <ul class="c-info-box__list">
                            <li>Receive DM notifications</li>
                            <li>Automatic server role sync</li>
                            <li>Quick player lookup</li>
                        </ul>
                    </div>

                    <a href="{{ url_for('account.link_discord') }}" class="c-settings-btn c-settings-btn--primary c-settings-btn--block" data-action="connect-discord">
                        <i class="ti ti-brand-discord"></i>
                        Connect Discord
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Calendar Subscription -->
        <div class="col-lg-6 mb-4">
            <div class="c-settings-c-card" id="calendarSubscriptionCard" data-component="settings-card">
                <div class="c-settings-card__header">
                    <div class="c-settings-card__icon c-settings-card__icon--info">
                        <i class="ti ti-calendar-share"></i>
                    </div>
                    <div class="c-settings-card__header-info">
                        <h5 class="c-settings-card__title">Calendar Subscription</h5>
                        <small class="c-settings-card__subtitle">Sync your schedule</small>
                    </div>
                </div>
                <div class="c-settings-card__body">
                    <!-- Loading State -->
                    <div id="subscriptionLoading" class="c-settings-card__body--centered py-4" data-state="loading">
                        <div class="spinner-border text-primary" role="status" data-spinner>
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="c-status-description mt-2">Loading subscription...</p>
                    </div>

                    <!-- Error State -->
                    <div id="subscriptionError" class="c-info-box c-info-box--warning is-hidden" data-state="error" data-alert></div>

                    <!-- Content -->
                    <div id="subscriptionContent" class="is-hidden" data-state="content">
                        <div class="c-settings-field mb-3">
                            <label class="c-settings-field__label">Your Subscription URL</label>
                            <div class="c-input-group" data-component="input-group">
                                <input type="text" class="c-input-group__input" id="subscriptionUrl" readonly placeholder="Loading..." data-input="subscription-url">
                                <button class="c-input-group__btn" type="button" id="copySubscriptionUrl" data-action="copy-subscription-url" aria-label="Copy"><i class="ti ti-copy"></i></button>
                            </div>
                        </div>

                        <div class="c-btn-group c-btn-group--fill mb-3" data-component="button-group">
                            <button type="button" class="c-settings-btn c-settings-btn--secondary c-settings-btn--sm" id="subscribeWebcal" data-action="subscribe-webcal">
                                <i class="ti ti-device-mobile"></i>
                                iOS/macOS
                            </button>
                            <button type="button" class="c-settings-btn c-settings-btn--secondary c-settings-btn--sm" id="subscribeGoogle" data-action="subscribe-google">
                                <i class="ti ti-brand-google"></i>
                                Google
                            </button>
                        </div>

                        <div class="c-settings-field mb-3">
                            <label class="c-settings-field__label">Include in Calendar</label>
                            <div class="c-notification-card__body">
                                <div class="c-notification-switch mb-2" data-component="notification-switch">
                                    <label class="d-flex align-items-center gap-2 cursor-pointer">
                                        <input class="c-notification-switch__input" type="checkbox" id="subIncludeMatches" checked data-on-change="update-calendar-preferences">
                                        <span class="c-settings-field__help c-settings-field__help--inline">Team Matches</span>
                                    </label>
                                </div>
                                <div class="c-notification-switch mb-2" data-component="notification-switch">
                                    <label class="d-flex align-items-center gap-2 cursor-pointer">
                                        <input class="c-notification-switch__input" type="checkbox" id="subIncludeLeagueEvents" checked data-on-change="update-calendar-preferences">
                                        <span class="c-settings-field__help c-settings-field__help--inline">League Events</span>
                                    </label>
                                </div>
                                {% if is_referee %}
                                <div class="c-notification-switch" data-component="notification-switch">
                                    <label class="d-flex align-items-center gap-2 cursor-pointer">
                                        <input class="c-notification-switch__input" type="checkbox" id="subIncludeRefAssignments" checked data-on-change="update-calendar-preferences">
                                        <span class="c-settings-field__help c-settings-field__help--inline">Referee Assignments</span>
                                    </label>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="c-stat-box" data-component="stat-box">
                                    <small class="c-stat-box__label">Last Synced</small>
                                    <span class="c-stat-box__value" id="subLastAccessed">Never</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="c-stat-box" data-component="stat-box">
                                    <small class="c-stat-box__label">Total Syncs</small>
                                    <span class="c-stat-box__value" id="subAccessCount">0</span>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="c-settings-btn c-settings-btn--outline-danger c-settings-btn--sm c-settings-btn--block" id="regenerateSubscriptionToken" data-action="regenerate-subscription-token">
                            <i class="ti ti-refresh"></i>
                            Regenerate URL
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Apple Wallet Section -->
    {% set has_any_team = (safe_current_user.player.primary_team) or (user_team and user_team|length > 0) or (safe_current_user.player.teams and safe_current_user.player.teams|length > 0) %}
    {% if safe_current_user.player and safe_current_user.player.is_current_player and safe_current_user.is_authenticated and has_any_team %}
    <div class="row">
        <div class="col-12">
            <div class="c-settings-c-card" data-component="settings-card">
                <div class="c-settings-card__header">
                    <div class="c-settings-card__icon c-settings-card__icon--dark">
                        <i class="ti ti-device-mobile"></i>
                    </div>
                    <div class="c-settings-card__header-info">
                        <h5 class="c-settings-card__title">Apple Wallet Pass</h5>
                        <small class="c-settings-card__subtitle">Your ECS FC membership card</small>
                    </div>
                </div>
                <div class="c-settings-card__body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <p class="c-settings-card__subtitle mb-3">
                                Add your ECS FC membership pass to Apple Wallet for easy access during games and events.
                                The pass updates automatically when your team or league information changes.
                            </p>

                            <div class="row g-3 mb-3">
                                <div class="col-sm-4">
                                    <div class="c-stat-box" data-component="stat-box">
                                        <small class="c-stat-box__label">Player</small>
                                        <span class="c-stat-box__value">{{ safe_current_user.player.name }}</span>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="c-stat-box" data-component="stat-box">
                                        <small class="c-stat-box__label">Team</small>
                                        <span class="c-stat-box__value">
                                            {% if safe_current_user.player.primary_team %}
                                            {{ safe_current_user.player.primary_team.name }}
                                            {% elif user_team and user_team|length > 0 %}
                                            {{ user_team[0].name }}
                                            {% else %}
                                            Team Member
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="c-stat-box" data-component="stat-box">
                                        <small class="c-stat-box__label">Status</small>
                                        <span class="c-badge c-badge--success">Active</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 text-center">
                            <a href="{{ url_for('wallet.get_wallet_pass', user_id=safe_current_user.id) }}"
                               class="c-wallet-badge"
                               data-action="download-wallet-pass">
                                <svg width="160" height="44" viewBox="0 0 180 50" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="180" height="50" rx="8" fill="#000000"/>
                                    <g transform="translate(12, 12)">
                                        <path d="M16.23 9.5c0-1.95.8-3.74 2.1-5.02A7.5 7.5 0 0 0 12.77 2c-1.41 0-2.94.83-3.7.83-.76 0-1.94-.81-3.19-.79a5.87 5.87 0 0 0-4.94 3.01c-2.1 3.65-.54 9.05 1.51 12.01 1 1.45 2.2 3.08 3.77 3.02 1.53-.06 2.1-.99 3.94-.99s2.35.99 3.95.96c1.63-.03 2.69-1.47 3.69-2.93a12.85 12.85 0 0 0 1.68-3.43 7.18 7.18 0 0 1-4.36-6.59zm-2.52-7.47c.83-1 1.39-2.38 1.24-3.76-1.2.05-2.66.8-3.52 1.8-.77.89-1.45 2.31-1.27 3.67 1.34.1 2.72-.68 3.55-1.71z" fill="white"/>
                                    </g>
                                    <text x="45" y="20" font-family="SF Pro Display, -apple-system, BlinkMacSystemFont, sans-serif" font-size="9" font-weight="400" fill="white">Add to</text>
                                    <text x="45" y="35" font-family="SF Pro Display, -apple-system, BlinkMacSystemFont, sans-serif" font-size="18" font-weight="500" fill="white">Apple Wallet</text>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
