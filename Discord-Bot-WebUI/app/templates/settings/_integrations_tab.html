{# Integrations Settings Tab Partial #}
<div class="tab-pane fade" id="tab-integrations" role="tabpanel">
    <div class="row">
        <!-- Discord Integration -->
        <div class="col-lg-6 mb-4">
            <div class="card settings-card h-100">
                <div class="card-header d-flex align-items-center pb-2 border-bottom">
                    <div class="settings-icon me-3" style="background-color: rgba(88, 101, 242, 0.1); color: #5865F2;">
                        <i class="ti ti-brand-discord"></i>
                    </div>
                    <div>
                        <h5 class="card-title mb-0">Discord</h5>
                        <small class="text-muted">Connect your Discord account</small>
                    </div>
                </div>
                <div class="card-body pt-3">
                    {% if safe_current_user.player and safe_current_user.player.discord_id %}
                    <div class="text-center mb-4">
                        <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                             style="width: 80px; height: 80px; background-color: rgba(88, 101, 242, 0.1);">
                            <i class="ti ti-brand-discord" style="font-size: 2.5rem; color: #5865F2;"></i>
                        </div>
                        <h6 class="fw-semibold text-success">
                            <i class="ti ti-check me-1"></i>Connected
                        </h6>
                        <p class="text-muted small mb-0">Discord ID: {{ safe_current_user.player.discord_id }}</p>
                    </div>

                    <div class="d-grid gap-2">
                        <form id="syncDiscordRolesForm" action="{{ url_for('auth.sync_discord_roles') }}" method="POST" class="d-grid">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="ti ti-refresh me-2"></i>Sync Discord Roles
                            </button>
                        </form>
                        <form id="unlinkDiscordForm" action="{{ url_for('account.unlink_discord') }}" method="POST" class="d-grid">
                            <button type="submit" class="btn btn-outline-danger">
                                <i class="ti ti-link-off me-2"></i>Disconnect Discord
                            </button>
                        </form>
                    </div>
                    {% else %}
                    <div class="text-center mb-4">
                        <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-3"
                             style="width: 80px; height: 80px;">
                            <i class="ti ti-brand-discord text-muted" style="font-size: 2.5rem;"></i>
                        </div>
                        <h6 class="fw-semibold text-muted">Not Connected</h6>
                        <p class="text-muted small mb-0">Link your Discord to access more features</p>
                    </div>

                    <div class="alert alert-light border mb-3">
                        <h6 class="fw-semibold mb-2 small">Benefits of connecting:</h6>
                        <ul class="mb-0 small text-muted ps-3">
                            <li>Receive DM notifications</li>
                            <li>Automatic server role sync</li>
                            <li>Quick player lookup</li>
                        </ul>
                    </div>

                    <div class="d-grid">
                        <a href="{{ url_for('account.link_discord') }}" class="btn btn-primary">
                            <i class="ti ti-brand-discord me-2"></i>Connect Discord
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Calendar Subscription -->
        <div class="col-lg-6 mb-4">
            <div class="card settings-card h-100" id="calendarSubscriptionCard">
                <div class="card-header d-flex align-items-center pb-2 border-bottom">
                    <div class="settings-icon bg-info bg-opacity-10 text-info me-3">
                        <i class="ti ti-calendar-share"></i>
                    </div>
                    <div>
                        <h5 class="card-title mb-0">Calendar Subscription</h5>
                        <small class="text-muted">Sync your schedule</small>
                    </div>
                </div>
                <div class="card-body pt-3">
                    <!-- Loading State -->
                    <div id="subscriptionLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2 mb-0 small">Loading subscription...</p>
                    </div>

                    <!-- Error State -->
                    <div id="subscriptionError" class="alert alert-danger" style="display: none;"></div>

                    <!-- Content -->
                    <div id="subscriptionContent" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label fw-semibold small">Your Subscription URL</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="subscriptionUrl" readonly placeholder="Loading...">
                                <button class="btn btn-outline-primary" type="button" id="copySubscriptionUrl">
                                    <i class="ti ti-copy"></i>
                                </button>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mb-3">
                            <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" id="subscribeWebcal">
                                <i class="ti ti-device-mobile me-1"></i>iOS/macOS
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" id="subscribeGoogle">
                                <i class="ti ti-brand-google me-1"></i>Google
                            </button>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold small">Include in Calendar</label>
                            <div class="form-check form-switch mb-1">
                                <input class="form-check-input" type="checkbox" id="subIncludeMatches" checked>
                                <label class="form-check-label small" for="subIncludeMatches">Team Matches</label>
                            </div>
                            <div class="form-check form-switch mb-1">
                                <input class="form-check-input" type="checkbox" id="subIncludeLeagueEvents" checked>
                                <label class="form-check-label small" for="subIncludeLeagueEvents">League Events</label>
                            </div>
                            {% if is_referee %}
                            <div class="form-check form-switch mb-1">
                                <input class="form-check-input" type="checkbox" id="subIncludeRefAssignments" checked>
                                <label class="form-check-label small" for="subIncludeRefAssignments">Referee Assignments</label>
                            </div>
                            {% endif %}
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="bg-light rounded p-2 text-center">
                                    <small class="text-muted d-block">Last Synced</small>
                                    <span class="fw-semibold small" id="subLastAccessed">Never</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-light rounded p-2 text-center">
                                    <small class="text-muted d-block">Total Syncs</small>
                                    <span class="fw-semibold small" id="subAccessCount">0</span>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-outline-danger btn-sm w-100" id="regenerateSubscriptionToken">
                            <i class="ti ti-refresh me-1"></i>Regenerate URL
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Apple Wallet Section -->
    {% set has_any_team = (safe_current_user.player.primary_team) or (user_team and user_team|length > 0) or (safe_current_user.player.teams and safe_current_user.player.teams|length > 0) %}
    {% if safe_current_user.player and safe_current_user.player.is_current_player and safe_current_user.is_authenticated and has_any_team %}
    <div class="row">
        <div class="col-12">
            <div class="card settings-card">
                <div class="card-header d-flex align-items-center pb-2 border-bottom">
                    <div class="settings-icon bg-dark bg-opacity-10 text-dark me-3">
                        <i class="ti ti-device-mobile"></i>
                    </div>
                    <div>
                        <h5 class="card-title mb-0">Apple Wallet Pass</h5>
                        <small class="text-muted">Your ECS FC membership card</small>
                    </div>
                </div>
                <div class="card-body pt-3">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <p class="text-muted mb-3">
                                Add your ECS FC membership pass to Apple Wallet for easy access during games and events.
                                The pass updates automatically when your team or league information changes.
                            </p>

                            <div class="row g-3 mb-3">
                                <div class="col-sm-4">
                                    <div class="bg-light rounded p-2 text-center">
                                        <small class="text-muted d-block">Player</small>
                                        <span class="fw-semibold small">{{ safe_current_user.player.name }}</span>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="bg-light rounded p-2 text-center">
                                        <small class="text-muted d-block">Team</small>
                                        <span class="fw-semibold small">
                                            {% if safe_current_user.player.primary_team %}
                                            {{ safe_current_user.player.primary_team.name }}
                                            {% elif user_team and user_team|length > 0 %}
                                            {{ user_team[0].name }}
                                            {% else %}
                                            Team Member
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="bg-light rounded p-2 text-center">
                                        <small class="text-muted d-block">Status</small>
                                        <span class="badge bg-success">Active</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 text-center">
                            <a href="{{ url_for('wallet.get_wallet_pass', user_id=safe_current_user.id) }}"
                               class="d-inline-block wallet-badge">
                                <svg width="160" height="44" viewBox="0 0 180 50" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="180" height="50" rx="8" fill="#000000"/>
                                    <g transform="translate(12, 12)">
                                        <path d="M16.23 9.5c0-1.95.8-3.74 2.1-5.02A7.5 7.5 0 0 0 12.77 2c-1.41 0-2.94.83-3.7.83-.76 0-1.94-.81-3.19-.79a5.87 5.87 0 0 0-4.94 3.01c-2.1 3.65-.54 9.05 1.51 12.01 1 1.45 2.2 3.08 3.77 3.02 1.53-.06 2.1-.99 3.94-.99s2.35.99 3.95.96c1.63-.03 2.69-1.47 3.69-2.93a12.85 12.85 0 0 0 1.68-3.43 7.18 7.18 0 0 1-4.36-6.59zm-2.52-7.47c.83-1 1.39-2.38 1.24-3.76-1.2.05-2.66.8-3.52 1.8-.77.89-1.45 2.31-1.27 3.67 1.34.1 2.72-.68 3.55-1.71z" fill="white"/>
                                    </g>
                                    <text x="45" y="20" font-family="SF Pro Display, -apple-system, BlinkMacSystemFont, sans-serif" font-size="9" font-weight="400" fill="white">Add to</text>
                                    <text x="45" y="35" font-family="SF Pro Display, -apple-system, BlinkMacSystemFont, sans-serif" font-size="18" font-weight="500" fill="white">Apple Wallet</text>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
