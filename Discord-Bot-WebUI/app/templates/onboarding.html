{% extends "base.html" %}
{% import 'macros.html' as macros %}

{% block title %}Complete Your Profile{% endblock %}

{% block page_css %}

{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/onboarding.css') }}" />
{% endif %}
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y c-onboarding-page">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="c-onboarding" data-component="onboarding-wizard">
                <!-- Header -->
                <div class="c-onboarding__header">
                    <h1 class="c-onboarding__title">Complete Your Profile</h1>
                    <p class="c-onboarding__subtitle">Please complete your profile information below to help us get to know you better.</p>
                </div>

                <!-- Body -->
                <div class="c-onboarding__body">
                    <!-- Welcome Alert -->
                    <div class="alert alert-info mb-4" data-alert role="alert">
                        <h6 class="alert-heading fw-bold mb-1">Welcome to ECS FC!</h6>
                        <p class="mb-0">
                            Please complete your profile information below to help us get to know you better.
                        </p>
                    </div>

                    {% if needs_discord_join %}
                    <!-- Discord Join Prompt -->
                    <div class="c-discord-prompt" data-component="discord-prompt">
                        <div class="c-discord-prompt__icon">
                            <i class="fab fa-discord"></i>
                        </div>
                        <h6 class="c-discord-prompt__title">Join our Discord Server!</h6>
                        <p class="c-discord-prompt__description">
                            To fully participate in ECS FC, you need to join our Discord server. This is where match announcements, team discussions, and important notifications take place.
                        </p>
                        <a href="{{ discord_invite_link }}"
                           target="_blank"
                           rel="noopener"
                           class="c-discord-prompt__btn"
                           data-action="join-discord">
                            <i class="fab fa-discord"></i>
                            <span>Join Discord Server</span>
                        </a>
                    </div>
                    {% endif %}

                    <!-- Onboarding Form -->
                    <form method="post"
                          action="{{ url_for('main.onboarding') }}"
                          enctype="multipart/form-data"
                          class="c-onboarding-form needs-validation"
                          novalidate
                          data-component="onboarding-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="form_action" value="create_profile" id="form_action">
                        {% if player %}
                        <input type="hidden" name="playerId" id="playerId" value="{{ player.id }}">
                        {% endif %}

                        <!-- Personal Information Section -->
                        <div class="c-onboarding-form__section">
                            <div class="c-onboarding-form__section-header">
                                <i class="ti ti-user c-onboarding-form__section-icon"></i>
                                <h5 class="c-onboarding-form__section-title">Personal Information</h5>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="name">Full Name</label>
                                    {{ onboarding_form.name(class="form-control", placeholder="Your full name", required=True) }}
                                    <div class="invalid-feedback">Please provide your name.</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="email">Email</label>
                                    {{ onboarding_form.email(class="form-control", placeholder="Your email", required=True) }}
                                    <div class="invalid-feedback">Please provide a valid email.</div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="phone">Phone Number</label>
                                    {{ onboarding_form.phone(class="form-control", placeholder="Your phone number") }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="jersey_size">Jersey Size</label>
                                    {{ onboarding_form.jersey_size(class="form-select select2-single") }}
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="jersey_number">Preferred Jersey Number</label>
                                    {{ onboarding_form.jersey_number(class="form-control", placeholder="Jersey number") }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="pronouns">Preferred Pronouns</label>
                                    {{ onboarding_form.pronouns(class="form-select select2-single") }}
                                </div>
                            </div>
                        </div>

                        <!-- League Selection Section -->
                        <div class="c-onboarding-form__section">
                            <div class="c-onboarding-form__section-header">
                                <i class="ti ti-trophy c-onboarding-form__section-icon"></i>
                                <h5 class="c-onboarding-form__section-title">League Selection</h5>
                            </div>

                            <div class="alert alert-primary mb-3" data-alert role="alert">
                                <h6 class="alert-heading fw-bold mb-1">
                                    <i class="ti ti-trophy me-2"></i>Which league are you interested in joining?
                                </h6>
                                <p class="mb-0">Please select the league that best matches your skill level and availability:</p>
                            </div>

                            <div class="c-league-selector">
                                <label class="c-league-option">
                                    <input class="c-league-option__input"
                                           type="radio"
                                           name="preferred_league"
                                           id="pub_league_classic"
                                           value="pub_league_classic"
                                           required>
                                    <div class="c-league-option__card">
                                        <div class="c-league-option__title">üèÜ Pub League Classic</div>
                                        <div class="c-league-option__description">
                                            Our beginner-friendly classic division- it's all about having fun and improving your game. No experience necessary
                                        </div>
                                    </div>
                                </label>

                                <label class="c-league-option">
                                    <input class="c-league-option__input"
                                           type="radio"
                                           name="preferred_league"
                                           id="pub_league_premier"
                                           value="pub_league_premier"
                                           required>
                                    <div class="c-league-option__card">
                                        <div class="c-league-option__title">üåü Pub League Premier</div>
                                        <div class="c-league-option__description">
                                            Our Premier Division for low to intermediate recreational players. Bring your C game!
                                        </div>
                                    </div>
                                </label>

                                <label class="c-league-option">
                                    <input class="c-league-option__input"
                                           type="radio"
                                           name="preferred_league"
                                           id="ecs_fc"
                                           value="ecs_fc"
                                           required>
                                    <div class="c-league-option__card">
                                        <div class="c-league-option__title">‚öΩ ECS FC</div>
                                        <div class="c-league-option__description">
                                            Our club team for dedicated players who want to represent ECS in organized competition.
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="invalid-feedback is-hidden" id="league-error" data-error="league">
                                Please select a league to continue.
                            </div>
                        </div>

                        <!-- Playing Preferences Section -->
                        <div class="c-onboarding-form__section">
                            <div class="c-onboarding-form__section-header">
                                <i class="ti ti-soccer c-onboarding-form__section-icon"></i>
                                <h5 class="c-onboarding-form__section-title">Playing Preferences</h5>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="favorite_position">Favorite Position</label>
                                    {{ onboarding_form.favorite_position(class="form-select select2-single") }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="other_positions">Other Positions You Enjoy</label>
                                    {{ onboarding_form.other_positions(class="form-select select2-multiple", multiple="multiple") }}
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="positions_not_to_play">Positions to Avoid</label>
                                    {{ onboarding_form.positions_not_to_play(class="form-select select2-multiple", multiple="multiple") }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="frequency_play_goal">Willingness to Play Goal</label>
                                    {{ onboarding_form.frequency_play_goal(class="form-select select2-single") }}
                                </div>
                            </div>
                        </div>

                        <!-- Availability Section -->
                        <div class="c-onboarding-form__section">
                            <div class="c-onboarding-form__section-header">
                                <i class="ti ti-calendar c-onboarding-form__section-icon"></i>
                                <h5 class="c-onboarding-form__section-title">Availability</h5>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="expected_weeks_available">Expected Availability (# of weeks)</label>
                                    {{ onboarding_form.expected_weeks_available(class="form-select select2-single") }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="team_swap">Willing to Switch Teams if Needed?</label>
                                    {{ onboarding_form.team_swap(class="form-select select2-single") }}
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="unavailable_dates">Unavailable Dates</label>
                                    {{ onboarding_form.unavailable_dates(class="form-control", placeholder="List any dates you're unavailable") }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="willing_to_referee">Interested in Refereeing?</label>
                                    {{ onboarding_form.willing_to_referee(class="form-select select2-single") }}
                                </div>
                            </div>
                        </div>

                        <!-- Profile Picture Section -->
                        <div class="c-onboarding-form__section">
                            <div class="c-onboarding-form__section-header">
                                <i class="ti ti-camera c-onboarding-form__section-icon"></i>
                                <h5 class="c-onboarding-form__section-title">Profile Picture</h5>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label" for="profile_picture">Upload Profile Picture</label>
                                    {{ onboarding_form.profile_picture(class="form-control", id="image") }}
                                    <input type="hidden" name="cropped_image_data" id="cropped_image_data">
                                </div>
                                <div class="col-md-4">
                                    <div class="c-onboarding-cropper__preview" id="currentProfilePicture">
                                        <img src="{{ player.profile_picture_url if player and player.profile_picture_url else url_for('static', filename='img/default_player.png') }}"
                                             alt="Profile Picture"
                                             class="c-onboarding-cropper__preview-img">
                                    </div>
                                </div>
                            </div>

                            <div class="c-onboarding-cropper c-onboarding-cropper__container u-hidden" data-component="cropper-container">
                                <img id="imagecan" src="" alt="Preview">
                                <button type="button"
                                        id="cropAndSaveButton"
                                        class="c-sms-verify__btn c-sms-verify__btn--primary mt-3"
                                        data-action="crop-save">
                                    <i class="ti ti-crop"></i>
                                    <span>Crop and Save</span>
                                </button>
                            </div>
                        </div>

                        <!-- Additional Information Section -->
                        <div class="c-onboarding-form__section">
                            <div class="c-onboarding-form__section-header">
                                <i class="ti ti-notes c-onboarding-form__section-icon"></i>
                                <h5 class="c-onboarding-form__section-title">Additional Information</h5>
                            </div>
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label" for="additional_info">Additional Information</label>
                                    {{ onboarding_form.additional_info(class="form-control", rows="3", placeholder="Any additional information we should know") }}
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label" for="player_notes">Player Notes</label>
                                    {{ onboarding_form.player_notes(class="form-control", rows="3", placeholder="Any notes about your playing style or preferences") }}
                                </div>
                            </div>
                        </div>

                        <!-- Notification Preferences Section -->
                        <div class="c-onboarding-form__section">
                            <div class="c-onboarding-form__section-header">
                                <i class="ti ti-bell c-onboarding-form__section-icon"></i>
                                <h5 class="c-onboarding-form__section-title">Notification Preferences</h5>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-check form-switch mb-2 ms-0 ps-0">
                                        {{ onboarding_form.email_notifications(class="form-check-input ms-0", id="emailNotifications") }}
                                        <label class="form-check-label ms-4" for="emailNotifications">Email Notifications</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check form-switch mb-2 ms-0 ps-0">
                                        {{ onboarding_form.sms_notifications(class="form-check-input ms-0", id="smsNotifications", **{"data-on-change": "toggle-sms-consent"}) }}
                                        <label class="form-check-label ms-4" for="smsNotifications">SMS Notifications</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check form-switch mb-2 ms-0 ps-0">
                                        {{ onboarding_form.discord_notifications(class="form-check-input ms-0", id="discordNotifications") }}
                                        <label class="form-check-label ms-4" for="discordNotifications">Discord Notifications</label>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="profile_visibility">Profile Visibility</label>
                                    {{ onboarding_form.profile_visibility(class="form-select select2-single") }}
                                </div>
                            </div>

                            <!-- SMS Opt-in section -->
                            <div class="row">
                                <div class="col-12">
                                    <div id="smsOptInSection" class="c-sms-verify u-hidden" data-component="sms-opt-in">
                                        <div class="c-sms-verify__consent">
                                            <input class="c-sms-verify__consent-checkbox"
                                                   type="checkbox"
                                                   id="smsConsent"
                                                   name="sms_consent"
                                                   data-on-change="toggle-sms-verification">
                                            <label class="c-sms-verify__consent-label" for="smsConsent">
                                                I consent to receive text messages from ECS FC about team updates, schedule changes, and important announcements.
                                                Standard message and data rates may apply. You can opt out at any time by texting STOP or updating your preferences.
                                            </label>
                                        </div>

                                        <div id="smsVerificationSection" class="c-sms-verify__workflow u-hidden" data-component="sms-verification">
                                            <h6 class="c-sms-verify__title">Verify Your Phone Number</h6>
                                            <p class="c-sms-verify__description">
                                                We'll send a verification code to confirm your phone number. <strong>This step is required</strong> if you want to receive SMS notifications.
                                            </p>

                                            <div class="c-sms-verify__actions mb-3">
                                                {% if player and player.is_phone_verified %}
                                                <button type="button"
                                                        id="sendVerificationBtn"
                                                        class="c-sms-verify__btn c-sms-verify__btn--verified"
                                                        disabled>
                                                    <i class="ti ti-check"></i>
                                                    <span>Phone Verified</span>
                                                </button>
                                                {% else %}
                                                <button type="button"
                                                        id="sendVerificationBtn"
                                                        class="c-sms-verify__btn c-sms-verify__btn--primary"
                                                        data-action="send-code">
                                                    <i class="ti ti-send"></i>
                                                    <span>Send Verification Code</span>
                                                </button>
                                                {% endif %}
                                            </div>

                                            <div id="verificationCodeInput" class="u-hidden" data-component="verification-code-input">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label for="verificationCode" class="form-label">Verification Code</label>
                                                        <input type="text"
                                                               class="c-sms-verify__input form-control"
                                                               id="verificationCode"
                                                               placeholder="Enter 6-digit code"
                                                               data-form-control>
                                                    </div>
                                                    <div class="col-md-6 d-flex align-items-end">
                                                        <button type="button"
                                                                id="verifyCodeBtn"
                                                                class="c-sms-verify__btn c-sms-verify__btn--success"
                                                                data-action="verify-code">
                                                            <i class="ti ti-check"></i>
                                                            <span>Verify Code</span>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-12">
                                                        <button type="button"
                                                                id="resendCodeBtn"
                                                                class="c-sms-verify__link"
                                                                data-action="resend-code">
                                                            <i class="ti ti-refresh"></i>
                                                            <span>Resend Code</span>
                                                        </button>
                                                        <span id="resendTimer" class="c-sms-verify__timer"></span>
                                                    </div>
                                                </div>
                                            </div>

                                            <input type="hidden"
                                                   id="smsVerified"
                                                   name="sms_verified"
                                                   value="{{ 'true' if player and player.is_phone_verified else 'false' }}">

                                            <!-- Verification status alerts -->
                                            <div class="c-sms-verify__alert c-sms-verify__alert--warning{% if player and player.is_phone_verified %} u-hidden{% endif %}"
                                                 id="verificationRequiredAlert"
                                                 data-alert="verification-required">
                                                <i class="ti ti-alert-triangle"></i>
                                                <strong>Verification Required:</strong> You must verify your phone number to enable SMS notifications.
                                            </div>

                                            {% if player and player.is_phone_verified %}
                                            <div class="c-sms-verify__alert c-sms-verify__alert--success">
                                                <i class="ti ti-check-circle"></i>
                                                <strong>Phone Verified:</strong> Your phone number has already been verified.
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="c-onboarding-form__actions">
                            <button type="submit" class="c-onboarding-form__submit" data-action="submit-profile">
                                <i class="ti ti-check"></i>
                                <span>Save Profile</span>
                            </button>
                            <a href="{{ url_for('main.index') }}" class="c-onboarding-form__cancel">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="{{ url_for('static', filename='vendor/libs/select2/select2.full.min.js') }}"></script>
<!-- Simple Cropper (Custom implementation) -->
<script src="{{ url_for('static', filename='custom_js/simple-cropper.js') }}"></script>

{# SMS verification is handled by:
   - sms-verification.js (provides toggle/send/verify functions)
   - event-delegation/handlers/onboarding-wizard.js (registers toggle-sms-consent, toggle-sms-verification, send-code, verify-code handlers)
   Data attributes data-on-change and data-action are used in the template HTML above #}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set initial visibility based on checkboxes
    const smsToggle = document.getElementById('smsNotifications');
    const smsConsent = document.getElementById('smsConsent');
    if (smsToggle && smsToggle.checked && typeof window.toggleSmsConsent === 'function') {
        window.toggleSmsConsent(true);
        if (smsConsent && smsConsent.checked && typeof window.toggleSmsVerification === 'function') {
            window.toggleSmsVerification(true);
        }
    }
});
</script>

{% if needs_discord_join %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show Discord join modal when page loads
    setTimeout(function() {
        Swal.fire({
            title: 'Join our Discord Server',
            html: '<div class="text-left"><p>To fully participate in ECS FC, you need to join our Discord server!</p><p>This is where:</p><ul class="text-left"><li>Match announcements are posted</li><li>Substitution requests are made</li><li>Team discussions happen</li><li>Important notifications are sent</li></ul><p>Click the button below to join now:</p></div>',
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Join Discord Server',
            cancelButtonText: 'Later',
            showClass: { popup: 'animate__animated animate__fadeInDown' },
            hideClass: { popup: 'animate__animated animate__fadeOutUp' }
        }).then((result) => {
            if (result.isConfirmed) {
                window.open('{{ discord_invite_link }}', '_blank');
            }
        });
    }, 500);
});
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize select2 for multiple selection dropdowns
    $('.select2-single').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Select an option',
        allowClear: true
    });

    $('.select2-multiple').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Select options',
        allowClear: true
    });

    // Form validation
    const form = document.querySelector('form.needs-validation');
    if (form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                const firstInvalid = form.querySelector(':invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            form.classList.add('was-validated');
        }, false);
    }
});
</script>
{% endif %}
{% endblock %}
