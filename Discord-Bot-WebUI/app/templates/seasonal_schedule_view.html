{% extends "base.html" %}

{% block custom_css %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/seasonal-schedule.css') }}">
{% endif %}
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card bg-primary">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-white">
                            <h2 class="mb-1">{{ season.name }} Schedule</h2>
                            <p class="mb-0">Complete season schedule for all leagues and divisions</p>
                        </div>
                        <div>
                            <a href="{{ url_for('auto_schedule.schedule_manager') }}" class="c-btn c-btn--light">
                                <i class="ti ti-arrow-left me-1"></i>Back to Season Builder
                            </a>
                            {% if current_user.has_role('Pub League Admin') or current_user.has_role('Global Admin') %}
                            <div class="btn-group ms-2">
                                <button type="button" class="c-btn c-btn--primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-dropdown-toggle>
                                    <i class="ti ti-settings me-1"></i>Admin Tools
                                </button>
                                <ul class="dropdown-menu" data-dropdown-menu>
                                    <li><a class="dropdown-item js-toggle-edit" href="#" data-action="toggle-edit">
                                        <i class="ti ti-edit me-1"></i>Toggle Edit Mode
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    {% for league in leagues %}
                                    <li><a class="dropdown-item" href="{{ url_for('playoff.manage_playoffs', league_id=league.id) }}">
                                        <i class="ti ti-trophy me-1"></i>Manage {{ league.name }} Playoffs
                                    </a></li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__body">
                    <h5 class="c-card__title mb-3">Filter Schedule</h5>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">League/Division</label>
                            <select class="form-select" id="leagueFilter" data-form-select>
                                <option value="">All Leagues</option>
                                {% for league in leagues %}
                                <option value="{{ league.id }}">{{ league.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Team</label>
                            <select class="form-select" id="teamFilter" data-form-select>
                                <option value="">All Teams</option>
                                {% for league in leagues %}
                                    <optgroup label="{{ league.name }}">
                                        {% for team in league.teams %}
                                        <option value="{{ team.id }}" data-league="{{ league.id }}">{{ team.name }}</option>
                                        {% endfor %}
                                    </optgroup>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Week Type</label>
                            <select class="form-select" id="weekTypeFilter" data-form-select>
                                <option value="">All Weeks</option>
                                <option value="REGULAR">Regular Season</option>
                                <option value="TST">TST Week</option>
                                <option value="FUN">Fun Week</option>
                                <option value="BYE">Bye Weeks</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Actions</label>
                            <div>
                                <button class="c-btn c-btn--primary w-100 js-apply-filters" data-action="apply-filters">
                                    <i class="ti ti-filter me-1"></i>Apply Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Display -->
    <div id="scheduleContainer">
        {% for week_num, week_data in schedule_by_week.items() %}
        <div class="week-container mb-4" data-week="{{ week_num }}" data-week-type="{{ week_data.week_type }}">
            <div class="c-card">
                <div class="c-card__header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 week-header" data-week="{{ week_num }}">
                            <span class="week-title">Week {{ week_num }} - {{ week_data.date.strftime('%B %d, %Y') }}</span>
                            <span class="week-edit-form week-edit-form-hidden">
                                <input type="date" class="form-control week-edit-date-input"
                                       value="{{ week_data.date.strftime('%Y-%m-%d') }}" id="week-date-{{ week_num }}" data-form-control>
                                <input type="time" class="form-control week-edit-time-input"
                                       id="week-time-{{ week_num }}" data-form-control>
                                <button class="c-btn c-btn--sm c-btn--success me-1 js-save-week" data-action="save-week" data-week="{{ week_num }}" aria-label="Confirm"><i class="ti ti-check"></i></button>
                                <button class="c-btn c-btn--sm c-btn--secondary js-cancel-week-edit" data-action="cancel-week-edit" data-week="{{ week_num }}" aria-label="Button"><i class="ti ti-x"></i></button>
                            </span>
                            {% if week_data.week_type == 'TST' %}
                            <span class="badge bg-info ms-2" data-badge>TST Week</span>
                            {% elif week_data.week_type == 'FUN' %}
                            <span class="badge bg-warning ms-2" data-badge>Fun Week</span>
                            {% elif week_data.week_type == 'BYE' %}
                            <span class="badge bg-secondary ms-2" data-badge>Bye Week</span>
                            {% endif %}
                        </h5>
                        <div>
                            <span class="text-muted">{{ week_data.matches|length }} matches</span>
                            <div class="btn-group ms-2">
                                <button class="c-btn c-btn--sm c-btn--outline-primary js-toggle-week" data-action="toggle-week" data-week="{{ week_num }}" aria-label="Expand"><i class="ti ti-chevron-down"></i></button>
                                <button class="c-btn c-btn--sm c-btn--outline-secondary edit-controls js-edit-week" data-action="edit-week" data-week="{{ week_num }}" title="Edit Week">
                                    <i class="ti ti-edit"></i>
                                </button>
                                <button class="c-btn c-btn--sm c-btn--outline-success edit-controls js-add-match" data-action="add-match" data-week="{{ week_num }}" title="Add Match">
                                    <i class="ti ti-plus"></i>
                                </button>
                                <button class="c-btn c-btn--sm c-btn--outline-danger edit-controls js-delete-week" data-action="delete-week" data-week="{{ week_num }}" title="Delete Week">
                                    <i class="ti ti-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="c-card__body week-content" id="week-{{ week_num }}">
                    {% if week_data.week_type == 'BYE' %}
                    <div class="alert alert-secondary mb-0" data-alert>
                        <i class="ti ti-moon me-2"></i>
                        <strong>Bye Week</strong> - No matches scheduled. Teams have the week off.
                    </div>
                    {% elif week_data.week_type == 'FUN' %}
                    <div class="alert alert-warning mb-3" data-alert>
                        <i class="ti ti-confetti me-2"></i>
                        <strong>Fun Week</strong> - Special activities and fun matches for all teams.
                    </div>
                    {% elif week_data.week_type == 'TST' %}
                    <div class="alert alert-info mb-3" data-alert>
                        <i class="ti ti-trophy me-2"></i>
                        <strong>TST Week</strong> - The Soccer Tournament competition week.
                    </div>
                    {% endif %}
                    
                    {% if week_data.matches %}
                    <div class="c-table-wrapper" data-table-responsive>
                        <table class="c-c-table c-table--hoverable" data-table data-mobile-table data-table-type="schedule">
                            <thead scope="col">
                                <tr>
                                    <th scope="col">Time</th>
                                    <th scope="col">Field</th>
                                    <th scope="col">League</th>
                                    <th scope="col">Home Team</th>
                                    <th scope="col">Away Team</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Actions</th>
                                    <th class="edit-controls" scope="col">Edit</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for match in week_data.matches|sort(attribute='time') %}
                                <tr class="match-row" 
                                    data-league="{{ match.home_team.league_id }}" 
                                    data-home-team="{{ match.home_team_id }}"
                                    data-away-team="{{ match.away_team_id }}"
                                    data-match-id="{{ match.id }}"
                                    data-week="{{ week_num }}">
                                    <td class="match-time" data-time="{{ match.time.strftime('%H:%M') }}" data-label="Time">
                                        <i class="ti ti-clock me-1"></i>
                                        <span class="time-display">{{ match.time.strftime('%I:%M %p') }}</span>
                                        <input type="time" class="form-control time-edit"
                                               value="{{ match.time.strftime('%H:%M') }}" data-form-control>
                                    </td>
                                    <td class="match-field" data-field="{{ match.location }}" data-label="Field">
                                        <span class="field-display">
                                            <span class="badge bg-label-primary" data-badge>{{ match.location }}</span>
                                        </span>
                                        <select class="form-select field-edit" data-form-select>
                                            <option value="North" {% if match.location == 'North' %}selected{% endif %}>North</option>
                                            <option value="South" {% if match.location == 'South' %}selected{% endif %}>South</option>
                                            <option value="East" {% if match.location == 'East' %}selected{% endif %}>East</option>
                                            <option value="West" {% if match.location == 'West' %}selected{% endif %}>West</option>
                                        </select>
                                    </td>
                                    <td data-label="League">
                                        <small class="text-muted">{{ match.home_team.league.name }}</small>
                                    </td>
                                    <td data-label="Home Team">
                                        {% if match.week_type == 'PLAYOFF' and match.home_team_id != match.away_team_id %}
                                            {# Confirmed playoff match - show actual team #}
                                            <span class="badge bg-info" data-badge>Playoff</span>
                                            <span class="team-display">
                                                <a href="{{ url_for('teams.team_details', team_id=match.home_team_id) }}"
                                                   class="text-decoration-none">
                                                    {{ match.home_team.name }}
                                                </a>
                                            </span>
                                        {% elif match.week_type in ['FUN', 'TST', 'BYE', 'BONUS', 'PLAYOFF'] %}
                                            <span class="badge bg-info" data-badge>
                                                {% if match.week_type == 'FUN' %}
                                                    Fun Week
                                                {% elif match.week_type == 'TST' %}
                                                    TST Week
                                                {% elif match.week_type == 'BYE' %}
                                                    BYE Week
                                                {% elif match.week_type == 'BONUS' %}
                                                    Bonus Week
                                                {% elif match.week_type == 'PLAYOFF' %}
                                                    Playoff Week
                                                {% endif %}
                                            </span>
                                        {% elif match.week_type == 'PRACTICE' or (match.is_practice_game if match.is_practice_game is defined else False) %}
                                            <span class="badge bg-warning" data-badge>
                                                PRACTICE
                                            </span>
                                        {% else %}
                                            <span class="team-display">
                                                <a href="{{ url_for('teams.team_details', team_id=match.home_team_id) }}"
                                                   class="text-decoration-none">
                                                    {{ match.home_team.name }}
                                                </a>
                                            </span>
                                            <select class="form-select team-edit" data-team-type="home" data-form-select>
                                                {% for league in leagues %}
                                                    {% if league.id == match.home_team.league_id %}
                                                        {% for team in league.teams %}
                                                        <option value="{{ team.id }}"
                                                                {% if team.id == match.home_team_id %}selected{% endif %}>
                                                            {{ team.name }}
                                                        </option>
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        {% endif %}
                                    </td>
                                    <td data-label="Away Team">
                                        {% if match.week_type == 'PLAYOFF' and match.home_team_id != match.away_team_id %}
                                            {# Confirmed playoff match - show actual team #}
                                            <span class="team-display">
                                                <a href="{{ url_for('teams.team_details', team_id=match.away_team_id) }}"
                                                   class="text-decoration-none">
                                                    {{ match.away_team.name }}
                                                </a>
                                            </span>
                                        {% elif match.week_type in ['FUN', 'TST', 'BYE', 'BONUS', 'PLAYOFF'] %}
                                            <span class="text-muted">
                                                {% if match.week_type == 'FUN' %}
                                                    Special activities
                                                {% elif match.week_type == 'TST' %}
                                                    Tournament events
                                                {% elif match.week_type == 'BYE' %}
                                                    No games
                                                {% elif match.week_type == 'BONUS' %}
                                                    Additional activities
                                                {% elif match.week_type == 'PLAYOFF' %}
                                                    TBD
                                                {% endif %}
                                            </span>
                                        {% elif match.week_type == 'PRACTICE' or (match.is_practice_game if match.is_practice_game is defined else False) %}
                                            <span class="text-muted">
                                                All teams practice together
                                            </span>
                                        {% else %}
                                            <span class="team-display">
                                                <a href="{{ url_for('teams.team_details', team_id=match.away_team_id) }}"
                                                   class="text-decoration-none">
                                                    {{ match.away_team.name }}
                                                </a>
                                            </span>
                                            <select class="form-select team-edit" data-team-type="away" data-form-select>
                                                {% for league in leagues %}
                                                    {% if league.id == match.home_team.league_id %}
                                                        {% for team in league.teams %}
                                                        <option value="{{ team.id }}"
                                                                {% if team.id == match.away_team_id %}selected{% endif %}>
                                                            {{ team.name }}
                                                        </option>
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        {% endif %}
                                    </td>
                                    <td data-label="Status">
                                        {% if match.reported %}
                                        <span class="badge bg-success" data-badge>Reported</span>
                                        {% else %}
                                        <span class="badge bg-secondary" data-badge>Scheduled</span>
                                        {% endif %}
                                    </td>
                                    <td data-label="Actions">
                                        <a href="{{ url_for('match_pages.view_match', match_id=match.id) }}"
                                           class="c-btn c-btn--sm c-btn--outline-primary" aria-label="View"><i class="ti ti-eye"></i></a>
                                    </td>
                                    <td class="edit-controls" data-label="Edit">
                                        <button class="c-btn c-btn--sm c-btn--outline-secondary me-1 js-edit-match"
                                                data-action="edit-match" data-match-id="{{ match.id }}" title="Edit Match">
                                            <i class="ti ti-edit"></i>
                                        </button>
                                        <button class="c-btn c-btn--sm c-btn--outline-danger js-delete-match"
                                                data-action="delete-match" data-match-id="{{ match.id }}" title="Delete Match">
                                            <i class="ti ti-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__body text-center py-5">
                    <i class="ti ti-calendar-off ti-lg mb-3 text-muted"></i>
                    <h5>No Schedule Found</h5>
                    <p class="text-muted mb-3">No matches have been scheduled for this season yet.</p>
                    <a href="{{ url_for('auto_schedule.schedule_manager') }}" class="c-btn c-btn--primary">
                        <i class="ti ti-plus me-1"></i>Create Schedule
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Export Options -->
    {% if schedule_by_week %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__body">
                    <h5 class="c-card__title mb-3">Export Options</h5>
                    <div class="btn-group" role="group">
                        <button class="c-btn c-btn--outline-primary js-export-csv" data-action="export-csv">
                            <i class="ti ti-file-spreadsheet me-1"></i>Export to CSV
                        </button>
                        <button class="c-btn c-btn--outline-primary js-print-schedule" data-action="print-schedule">
                            <i class="ti ti-printer me-1"></i>Print Schedule
                        </button>
                        <button class="c-btn c-btn--outline-primary js-share-schedule" data-action="share-schedule">
                            <i class="ti ti-share me-1"></i>Share Link
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% block modals %}
{{ super() }}
<!-- Edit Match Modal -->
<div class="modal c-modal fade" id="editMatchModal" tabindex="-1" aria-labelledby="editMatchModalLabel" aria-hidden="true" data-modal>
    <div class="modal-dialog c-modal__dialog" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="editMatchModalLabel">Edit Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-dismiss></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body>
                <form id="editMatchForm">
                    <input type="hidden" id="editMatchId">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="editMatchTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="editMatchTime" required data-form-control>
                        </div>
                        <div class="col-md-6">
                            <label for="editMatchField" class="form-label">Field</label>
                            <select class="form-select" id="editMatchField" required data-form-select>
                                <option value="North">North</option>
                                <option value="South">South</option>
                                <option value="East">East</option>
                                <option value="West">West</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="editMatchHomeTeam" class="form-label">Home Team</label>
                            <select class="form-select" id="editMatchHomeTeam" required data-form-select>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editMatchAwayTeam" class="form-label">Away Team</label>
                            <select class="form-select" id="editMatchAwayTeam" required data-form-select>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="button" class="c-btn c-btn--primary js-save-match-modal" data-action="save-match-modal">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Match Modal -->
<div class="modal c-modal fade" id="addMatchModal" tabindex="-1" aria-labelledby="addMatchModalLabel" aria-hidden="true" data-modal>
    <div class="modal-dialog c-modal__dialog" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="addMatchModalLabel">Add New Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-dismiss></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body>
                <form id="addMatchForm">
                    <input type="hidden" id="addMatchWeek">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="addMatchDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="addMatchDate" required data-form-control>
                        </div>
                        <div class="col-md-6">
                            <label for="addMatchTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="addMatchTime" value="19:00" required data-form-control>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="addMatchField" class="form-label">Field</label>
                            <select class="form-select" id="addMatchField" required data-form-select>
                                <option value="North">North</option>
                                <option value="South">South</option>
                                <option value="East">East</option>
                                <option value="West">West</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="addMatchLeague" class="form-label">League</label>
                            <select class="form-select" id="addMatchLeague" required data-form-select>
                                {% for league in leagues %}
                                <option value="{{ league.id }}">{{ league.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="addMatchHomeTeam" class="form-label">Home Team</label>
                            <select class="form-select" id="addMatchHomeTeam" required data-form-select>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="addMatchAwayTeam" class="form-label">Away Team</label>
                            <select class="form-select" id="addMatchAwayTeam" required data-form-select>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="button" class="c-btn c-btn--primary js-save-match-add" data-action="save-match-add">Add Match</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<!-- Seasonal Schedule Module loaded via Vite in production, or directly in development -->
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script type="module" src="{{ url_for('static', filename='custom_js/seasonal-schedule.js') }}"></script>
{% endif %}

<!-- Fallback inline script for admin mode initialization -->
<script>
// Initialize admin mode if needed (admin-specific Jinja logic)
document.addEventListener('DOMContentLoaded', function() {
    {% if current_user.has_role('Pub League Admin') or current_user.has_role('Global Admin') %}
    // Trigger edit mode initialization for admin users
    const event = new CustomEvent('admin-mode-init');
    document.dispatchEvent(event);
    {% endif %}
});
</script>
{% endblock %}