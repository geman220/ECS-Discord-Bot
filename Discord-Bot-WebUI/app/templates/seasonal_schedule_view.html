{% extends "base.html" %}

{% block custom_css %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/seasonal-schedule.css') }}">
{% endif %}
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card bg-primary">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-white">
                            <h2 class="mb-1">{{ season.name }} Schedule</h2>
                            <p class="mb-0">Complete season schedule for all leagues and divisions</p>
                        </div>
                        <div>
                            <a href="{{ url_for('auto_schedule.schedule_manager') }}" class="c-btn c-btn--light">
                                <i class="ti ti-arrow-left me-1"></i>Back to Season Builder
                            </a>
                            {% if current_user.has_role('Pub League Admin') or current_user.has_role('Global Admin') %}
                            <div class="btn-group ms-2">
                                <button type="button" class="c-btn c-btn--primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-dropdown-toggle>
                                    <i class="ti ti-settings me-1"></i>Admin Tools
                                </button>
                                <ul class="dropdown-menu" data-dropdown-menu>
                                    <li><a class="dropdown-item js-toggle-edit" href="#" data-action="toggle-edit">
                                        <i class="ti ti-edit me-1"></i>Toggle Edit Mode
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    {% for league in leagues %}
                                    <li><a class="dropdown-item" href="{{ url_for('playoff.manage_playoffs', league_id=league.id) }}">
                                        <i class="ti ti-trophy me-1"></i>Manage {{ league.name }} Playoffs
                                    </a></li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__body">
                    <h5 class="c-card__title mb-3">Filter Schedule</h5>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">League/Division</label>
                            <select class="form-select" id="leagueFilter" data-form-select>
                                <option value="">All Leagues</option>
                                {% for league in leagues %}
                                <option value="{{ league.id }}">{{ league.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Team</label>
                            <select class="form-select" id="teamFilter" data-form-select>
                                <option value="">All Teams</option>
                                {% for league in leagues %}
                                    <optgroup label="{{ league.name }}">
                                        {% for team in league.teams %}
                                        <option value="{{ team.id }}" data-league="{{ league.id }}">{{ team.name }}</option>
                                        {% endfor %}
                                    </optgroup>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Week Type</label>
                            <select class="form-select" id="weekTypeFilter" data-form-select>
                                <option value="">All Weeks</option>
                                <option value="REGULAR">Regular Season</option>
                                <option value="TST">TST Week</option>
                                <option value="FUN">Fun Week</option>
                                <option value="BYE">Bye Weeks</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Actions</label>
                            <div>
                                <button class="c-btn c-btn--primary w-100 js-apply-filters" data-action="apply-filters">
                                    <i class="ti ti-filter me-1"></i>Apply Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Display -->
    <div id="scheduleContainer">
        {% for week_num, week_data in schedule_by_week.items() %}
        <div class="week-container mb-4" data-week="{{ week_num }}" data-week-type="{{ week_data.week_type }}">
            <div class="c-card">
                <div class="c-card__header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 week-header" data-week="{{ week_num }}">
                            <span class="week-title">Week {{ week_num }} - {{ week_data.date.strftime('%B %d, %Y') }}</span>
                            <span class="week-edit-form week-edit-form-hidden">
                                <input type="date" class="form-control week-edit-date-input"
                                       value="{{ week_data.date.strftime('%Y-%m-%d') }}" id="week-date-{{ week_num }}" data-form-control>
                                <input type="time" class="form-control week-edit-time-input"
                                       id="week-time-{{ week_num }}" data-form-control>
                                <button class="c-btn c-btn--sm c-btn--success me-1 js-save-week" data-action="save-week" data-week="{{ week_num }}">
                                    <i class="ti ti-check"></i>
                                </button>
                                <button class="c-btn c-btn--sm c-btn--secondary js-cancel-week-edit" data-action="cancel-week-edit" data-week="{{ week_num }}">
                                    <i class="ti ti-x"></i>
                                </button>
                            </span>
                            {% if week_data.week_type == 'TST' %}
                            <span class="badge bg-info ms-2" data-badge>TST Week</span>
                            {% elif week_data.week_type == 'FUN' %}
                            <span class="badge bg-warning ms-2" data-badge>Fun Week</span>
                            {% elif week_data.week_type == 'BYE' %}
                            <span class="badge bg-secondary ms-2" data-badge>Bye Week</span>
                            {% endif %}
                        </h5>
                        <div>
                            <span class="text-muted">{{ week_data.matches|length }} matches</span>
                            <div class="btn-group ms-2">
                                <button class="c-btn c-btn--sm c-btn--outline-primary js-toggle-week" data-action="toggle-week" data-week="{{ week_num }}">
                                    <i class="ti ti-chevron-down" id="chevron-{{ week_num }}"></i>
                                </button>
                                <button class="c-btn c-btn--sm c-btn--outline-secondary edit-controls js-edit-week" data-action="edit-week" data-week="{{ week_num }}" title="Edit Week">
                                    <i class="ti ti-edit"></i>
                                </button>
                                <button class="c-btn c-btn--sm c-btn--outline-success edit-controls js-add-match" data-action="add-match" data-week="{{ week_num }}" title="Add Match">
                                    <i class="ti ti-plus"></i>
                                </button>
                                <button class="c-btn c-btn--sm c-btn--outline-danger edit-controls js-delete-week" data-action="delete-week" data-week="{{ week_num }}" title="Delete Week">
                                    <i class="ti ti-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="c-card__body week-content" id="week-{{ week_num }}">
                    {% if week_data.week_type == 'BYE' %}
                    <div class="alert alert-secondary mb-0" data-alert>
                        <i class="ti ti-moon me-2"></i>
                        <strong>Bye Week</strong> - No matches scheduled. Teams have the week off.
                    </div>
                    {% elif week_data.week_type == 'FUN' %}
                    <div class="alert alert-warning mb-3" data-alert>
                        <i class="ti ti-confetti me-2"></i>
                        <strong>Fun Week</strong> - Special activities and fun matches for all teams.
                    </div>
                    {% elif week_data.week_type == 'TST' %}
                    <div class="alert alert-info mb-3" data-alert>
                        <i class="ti ti-trophy me-2"></i>
                        <strong>TST Week</strong> - The Soccer Tournament competition week.
                    </div>
                    {% endif %}
                    
                    {% if week_data.matches %}
                    <div class="c-table-wrapper" data-table-responsive>
                        <table class="c-table c-table--hoverable" data-table>
                            <thead scope="col">
                                <tr>
                                    <th scope="col">Time</th>
                                    <th scope="col">Field</th>
                                    <th scope="col">League</th>
                                    <th scope="col">Home Team</th>
                                    <th scope="col">Away Team</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Actions</th>
                                    <th class="edit-controls" scope="col">Edit</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for match in week_data.matches|sort(attribute='time') %}
                                <tr class="match-row" 
                                    data-league="{{ match.home_team.league_id }}" 
                                    data-home-team="{{ match.home_team_id }}"
                                    data-away-team="{{ match.away_team_id }}"
                                    data-match-id="{{ match.id }}"
                                    data-week="{{ week_num }}">
                                    <td class="match-time" data-time="{{ match.time.strftime('%H:%M') }}">
                                        <i class="ti ti-clock me-1"></i>
                                        <span class="time-display">{{ match.time.strftime('%I:%M %p') }}</span>
                                        <input type="time" class="form-control time-edit"
                                               value="{{ match.time.strftime('%H:%M') }}" data-form-control>
                                    </td>
                                    <td class="match-field" data-field="{{ match.location }}">
                                        <span class="field-display">
                                            <span class="badge bg-label-primary" data-badge>{{ match.location }}</span>
                                        </span>
                                        <select class="form-select field-edit" data-form-select>
                                            <option value="North" {% if match.location == 'North' %}selected{% endif %}>North</option>
                                            <option value="South" {% if match.location == 'South' %}selected{% endif %}>South</option>
                                            <option value="East" {% if match.location == 'East' %}selected{% endif %}>East</option>
                                            <option value="West" {% if match.location == 'West' %}selected{% endif %}>West</option>
                                        </select>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ match.home_team.league.name }}</small>
                                    </td>
                                    <td>
                                        {% if match.week_type == 'PLAYOFF' and match.home_team_id != match.away_team_id %}
                                            {# Confirmed playoff match - show actual team #}
                                            <span class="badge bg-info" data-badge>Playoff</span>
                                            <span class="team-display">
                                                <a href="{{ url_for('teams.team_details', team_id=match.home_team_id) }}"
                                                   class="text-decoration-none">
                                                    {{ match.home_team.name }}
                                                </a>
                                            </span>
                                        {% elif match.week_type in ['FUN', 'TST', 'BYE', 'BONUS', 'PLAYOFF'] %}
                                            <span class="badge bg-info" data-badge>
                                                {% if match.week_type == 'FUN' %}
                                                    Fun Week
                                                {% elif match.week_type == 'TST' %}
                                                    TST Week
                                                {% elif match.week_type == 'BYE' %}
                                                    BYE Week
                                                {% elif match.week_type == 'BONUS' %}
                                                    Bonus Week
                                                {% elif match.week_type == 'PLAYOFF' %}
                                                    Playoff Week
                                                {% endif %}
                                            </span>
                                        {% elif match.week_type == 'PRACTICE' or (match.is_practice_game if match.is_practice_game is defined else False) %}
                                            <span class="badge bg-warning" data-badge>
                                                PRACTICE
                                            </span>
                                        {% else %}
                                            <span class="team-display">
                                                <a href="{{ url_for('teams.team_details', team_id=match.home_team_id) }}"
                                                   class="text-decoration-none">
                                                    {{ match.home_team.name }}
                                                </a>
                                            </span>
                                            <select class="form-select team-edit" data-team-type="home" data-form-select>
                                                {% for league in leagues %}
                                                    {% if league.id == match.home_team.league_id %}
                                                        {% for team in league.teams %}
                                                        <option value="{{ team.id }}"
                                                                {% if team.id == match.home_team_id %}selected{% endif %}>
                                                            {{ team.name }}
                                                        </option>
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if match.week_type == 'PLAYOFF' and match.home_team_id != match.away_team_id %}
                                            {# Confirmed playoff match - show actual team #}
                                            <span class="team-display">
                                                <a href="{{ url_for('teams.team_details', team_id=match.away_team_id) }}"
                                                   class="text-decoration-none">
                                                    {{ match.away_team.name }}
                                                </a>
                                            </span>
                                        {% elif match.week_type in ['FUN', 'TST', 'BYE', 'BONUS', 'PLAYOFF'] %}
                                            <span class="text-muted">
                                                {% if match.week_type == 'FUN' %}
                                                    Special activities
                                                {% elif match.week_type == 'TST' %}
                                                    Tournament events
                                                {% elif match.week_type == 'BYE' %}
                                                    No games
                                                {% elif match.week_type == 'BONUS' %}
                                                    Additional activities
                                                {% elif match.week_type == 'PLAYOFF' %}
                                                    TBD
                                                {% endif %}
                                            </span>
                                        {% elif match.week_type == 'PRACTICE' or (match.is_practice_game if match.is_practice_game is defined else False) %}
                                            <span class="text-muted">
                                                All teams practice together
                                            </span>
                                        {% else %}
                                            <span class="team-display">
                                                <a href="{{ url_for('teams.team_details', team_id=match.away_team_id) }}"
                                                   class="text-decoration-none">
                                                    {{ match.away_team.name }}
                                                </a>
                                            </span>
                                            <select class="form-select team-edit" data-team-type="away" data-form-select>
                                                {% for league in leagues %}
                                                    {% if league.id == match.home_team.league_id %}
                                                        {% for team in league.teams %}
                                                        <option value="{{ team.id }}"
                                                                {% if team.id == match.away_team_id %}selected{% endif %}>
                                                            {{ team.name }}
                                                        </option>
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if match.reported %}
                                        <span class="badge bg-success" data-badge>Reported</span>
                                        {% else %}
                                        <span class="badge bg-secondary" data-badge>Scheduled</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('match_pages.view_match', match_id=match.id) }}"
                                           class="c-btn c-btn--sm c-btn--outline-primary">
                                            <i class="ti ti-eye"></i>
                                        </a>
                                    </td>
                                    <td class="edit-controls">
                                        <button class="c-btn c-btn--sm c-btn--outline-secondary me-1 js-edit-match"
                                                data-action="edit-match" data-match-id="{{ match.id }}" title="Edit Match">
                                            <i class="ti ti-edit"></i>
                                        </button>
                                        <button class="c-btn c-btn--sm c-btn--outline-danger js-delete-match"
                                                data-action="delete-match" data-match-id="{{ match.id }}" title="Delete Match">
                                            <i class="ti ti-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__body text-center py-5">
                    <i class="ti ti-calendar-off ti-lg mb-3 text-muted"></i>
                    <h5>No Schedule Found</h5>
                    <p class="text-muted mb-3">No matches have been scheduled for this season yet.</p>
                    <a href="{{ url_for('auto_schedule.schedule_manager') }}" class="c-btn c-btn--primary">
                        <i class="ti ti-plus me-1"></i>Create Schedule
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Export Options -->
    {% if schedule_by_week %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__body">
                    <h5 class="c-card__title mb-3">Export Options</h5>
                    <div class="btn-group" role="group">
                        <button class="c-btn c-btn--outline-primary js-export-csv" data-action="export-csv">
                            <i class="ti ti-file-spreadsheet me-1"></i>Export to CSV
                        </button>
                        <button class="c-btn c-btn--outline-primary js-print-schedule" data-action="print-schedule">
                            <i class="ti ti-printer me-1"></i>Print Schedule
                        </button>
                        <button class="c-btn c-btn--outline-primary js-share-schedule" data-action="share-schedule">
                            <i class="ti ti-share me-1"></i>Share Link
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% block modals %}
{{ super() }}
<!-- Edit Match Modal -->
<div class="modal c-modal fade" id="editMatchModal" tabindex="-1" aria-labelledby="editMatchModalLabel" aria-hidden="true" data-modal>
    <div class="modal-dialog c-modal__dialog" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="editMatchModalLabel">Edit Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-dismiss></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body>
                <form id="editMatchForm">
                    <input type="hidden" id="editMatchId">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="editMatchTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="editMatchTime" required data-form-control>
                        </div>
                        <div class="col-md-6">
                            <label for="editMatchField" class="form-label">Field</label>
                            <select class="form-select" id="editMatchField" required data-form-select>
                                <option value="North">North</option>
                                <option value="South">South</option>
                                <option value="East">East</option>
                                <option value="West">West</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="editMatchHomeTeam" class="form-label">Home Team</label>
                            <select class="form-select" id="editMatchHomeTeam" required data-form-select>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editMatchAwayTeam" class="form-label">Away Team</label>
                            <select class="form-select" id="editMatchAwayTeam" required data-form-select>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="button" class="c-btn c-btn--primary js-save-match-modal" data-action="save-match-modal">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Match Modal -->
<div class="modal c-modal fade" id="addMatchModal" tabindex="-1" aria-labelledby="addMatchModalLabel" aria-hidden="true" data-modal>
    <div class="modal-dialog c-modal__dialog" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="addMatchModalLabel">Add New Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-dismiss></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body>
                <form id="addMatchForm">
                    <input type="hidden" id="addMatchWeek">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="addMatchDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="addMatchDate" required data-form-control>
                        </div>
                        <div class="col-md-6">
                            <label for="addMatchTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="addMatchTime" value="19:00" required data-form-control>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="addMatchField" class="form-label">Field</label>
                            <select class="form-select" id="addMatchField" required data-form-select>
                                <option value="North">North</option>
                                <option value="South">South</option>
                                <option value="East">East</option>
                                <option value="West">West</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="addMatchLeague" class="form-label">League</label>
                            <select class="form-select" id="addMatchLeague" required data-form-select>
                                {% for league in leagues %}
                                <option value="{{ league.id }}">{{ league.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="addMatchHomeTeam" class="form-label">Home Team</label>
                            <select class="form-select" id="addMatchHomeTeam" required data-form-select>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="addMatchAwayTeam" class="form-label">Away Team</label>
                            <select class="form-select" id="addMatchAwayTeam" required data-form-select>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="button" class="c-btn c-btn--primary js-save-match-add" data-action="save-match-add">Add Match</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global edit mode state
let editMode = false;

// Event delegation setup
document.addEventListener('DOMContentLoaded', function() {
    // Toggle edit mode
    document.querySelectorAll('.js-toggle-edit').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            toggleEditMode();
        });
    });

    // Apply filters
    document.querySelectorAll('.js-apply-filters').forEach(btn => {
        btn.addEventListener('click', applyFilters);
    });

    // Toggle week
    document.querySelectorAll('.js-toggle-week').forEach(btn => {
        btn.addEventListener('click', function() {
            const weekNum = this.dataset.week;
            toggleWeek(weekNum);
        });
    });

    // Edit week
    document.querySelectorAll('.js-edit-week').forEach(btn => {
        btn.addEventListener('click', function() {
            const weekNum = this.dataset.week;
            editWeek(weekNum);
        });
    });

    // Add match
    document.querySelectorAll('.js-add-match').forEach(btn => {
        btn.addEventListener('click', function() {
            const weekNum = this.dataset.week;
            addMatch(weekNum);
        });
    });

    // Delete week
    document.querySelectorAll('.js-delete-week').forEach(btn => {
        btn.addEventListener('click', function() {
            const weekNum = this.dataset.week;
            deleteWeek(weekNum);
        });
    });

    // Save week
    document.querySelectorAll('.js-save-week').forEach(btn => {
        btn.addEventListener('click', function() {
            const weekNum = this.dataset.week;
            saveWeek(weekNum);
        });
    });

    // Cancel week edit
    document.querySelectorAll('.js-cancel-week-edit').forEach(btn => {
        btn.addEventListener('click', function() {
            const weekNum = this.dataset.week;
            cancelWeekEdit(weekNum);
        });
    });

    // Edit match
    document.querySelectorAll('.js-edit-match').forEach(btn => {
        btn.addEventListener('click', function() {
            const matchId = this.dataset.matchId;
            editMatch(matchId);
        });
    });

    // Delete match
    document.querySelectorAll('.js-delete-match').forEach(btn => {
        btn.addEventListener('click', function() {
            const matchId = this.dataset.matchId;
            deleteMatch(matchId);
        });
    });

    // Export/print/share buttons
    document.querySelectorAll('.js-export-csv').forEach(btn => {
        btn.addEventListener('click', exportToCSV);
    });

    document.querySelectorAll('.js-print-schedule').forEach(btn => {
        btn.addEventListener('click', printSchedule);
    });

    document.querySelectorAll('.js-share-schedule').forEach(btn => {
        btn.addEventListener('click', shareSchedule);
    });

    // Modal save buttons
    document.querySelectorAll('.js-save-match-modal').forEach(btn => {
        btn.addEventListener('click', saveMatchFromModal);
    });

    document.querySelectorAll('.js-save-match-add').forEach(btn => {
        btn.addEventListener('click', saveMatchFromAddModal);
    });
});

// Toggle edit mode
function toggleEditMode() {
    editMode = !editMode;
    const editControls = document.querySelectorAll('.edit-controls');

    editControls.forEach(control => {
        if (editMode) {
            if (control.tagName === 'TH' || control.tagName === 'TD') {
                control.classList.add('edit-controls-visible');
            } else {
                control.classList.add('edit-controls-btn-visible');
            }
        } else {
            control.classList.remove('edit-controls-visible', 'edit-controls-btn-visible');
        }
    });

    // Update button text
    const button = document.querySelector('[data-action="toggle-edit"]');
    if (button) {
        button.innerHTML = editMode ?
            '<i class="ti ti-eye me-1"></i>Exit Edit Mode' :
            '<i class="ti ti-edit me-1"></i>Toggle Edit Mode';
    }
}

// Toggle week visibility
function toggleWeek(weekNum) {
    const content = document.getElementById(`week-${weekNum}`);
    const chevron = document.getElementById(`chevron-${weekNum}`);

    if (content.classList.contains('week-content-collapsed')) {
        content.classList.remove('week-content-collapsed');
        chevron.classList.remove('ti-chevron-right');
        chevron.classList.add('ti-chevron-down');
    } else {
        content.classList.add('week-content-collapsed');
        chevron.classList.remove('ti-chevron-down');
        chevron.classList.add('ti-chevron-right');
    }
}

// Week editing functions
function editWeek(weekNum) {
    const weekHeader = document.querySelector(`[data-week="${weekNum}"]`);
    const weekTitle = weekHeader.querySelector('.week-title');
    const weekEditForm = weekHeader.querySelector('.week-edit-form');

    weekTitle.classList.add('d-none');
    weekEditForm.classList.remove('week-edit-form-hidden');

    // Get first match time as default
    const firstMatch = document.querySelector(`[data-week="${weekNum}"] .match-time`);
    if (firstMatch) {
        const timeInput = document.getElementById(`week-time-${weekNum}`);
        timeInput.value = firstMatch.dataset.time || '19:00';
    }
}

function cancelWeekEdit(weekNum) {
    const weekHeader = document.querySelector(`[data-week="${weekNum}"]`);
    const weekTitle = weekHeader.querySelector('.week-title');
    const weekEditForm = weekHeader.querySelector('.week-edit-form');

    weekTitle.classList.remove('d-none');
    weekEditForm.classList.add('week-edit-form-hidden');
}

function saveWeek(weekNum) {
    const dateInput = document.getElementById(`week-date-${weekNum}`);
    const timeInput = document.getElementById(`week-time-${weekNum}`);
    
    const data = {
        week_number: weekNum,
        league_id: getCurrentLeagueId(),
        date: dateInput.value,
        start_time: timeInput.value
    };
    
    fetch('/auto-schedule/update-week', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            location.reload();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred while updating the week');
    });
}

// Match editing functions
function editMatch(matchId) {
    // Get match data
    fetch(`/auto-schedule/get-match-data?match_id=${matchId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Match data loaded:', data.match); // Debug log
                
                // Populate modal
                document.getElementById('editMatchId').value = matchId;
                document.getElementById('editMatchTime').value = data.match.time;
                document.getElementById('editMatchField').value = data.match.field;
                
                // Populate team options
                const homeTeamSelect = document.getElementById('editMatchHomeTeam');
                const awayTeamSelect = document.getElementById('editMatchAwayTeam');
                
                // Get teams for current league
                const matchRow = document.querySelector(`[data-match-id="${matchId}"]`);
                const leagueId = matchRow.dataset.league;
                
                console.log('League ID:', leagueId); // Debug log
                console.log('Home team ID:', data.match.home_team_id); // Debug log
                console.log('Away team ID:', data.match.away_team_id); // Debug log
                
                populateTeamOptions(homeTeamSelect, leagueId, data.match.home_team_id);
                populateTeamOptions(awayTeamSelect, leagueId, data.match.away_team_id);

                ModalManager.show('editMatchModal');
            } else {
                showAlert('error', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'An error occurred while loading match data');
        });
}

function saveMatchFromModal() {
    const matchId = document.getElementById('editMatchId').value;
    const time = document.getElementById('editMatchTime').value;
    const field = document.getElementById('editMatchField').value;
    const homeTeamId = document.getElementById('editMatchHomeTeam').value;
    const awayTeamId = document.getElementById('editMatchAwayTeam').value;
    
    if (homeTeamId === awayTeamId) {
        showAlert('error', 'Home and away teams cannot be the same');
        return;
    }
    
    const data = {
        match_id: matchId,
        time: time,
        field: field,
        home_team_id: homeTeamId,
        away_team_id: awayTeamId
    };
    
    fetch('/auto-schedule/update-match', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('editMatchModal')).hide();
            location.reload();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred while updating the match');
    });
}

function cancelMatchEdit(matchId) {
    const matchRow = document.querySelector(`[data-match-id="${matchId}"]`);

    // Hide edit elements
    const timeDisplay = matchRow.querySelector('.time-display');
    const timeEdit = matchRow.querySelector('.time-edit');
    const fieldDisplay = matchRow.querySelector('.field-display');
    const fieldEdit = matchRow.querySelector('.field-edit');
    const teamDisplays = matchRow.querySelectorAll('.team-display');
    const teamEdits = matchRow.querySelectorAll('.team-edit');

    timeDisplay.classList.remove('d-none');
    timeEdit.classList.remove('time-edit-visible');
    fieldDisplay.classList.remove('d-none');
    fieldEdit.classList.remove('field-edit-visible');
    teamDisplays.forEach(display => display.classList.remove('d-none'));
    teamEdits.forEach(edit => edit.classList.remove('team-edit-visible'));

    // Remove save/cancel buttons
    const saveBtn = matchRow.querySelector('.save-match');
    const cancelBtn = matchRow.querySelector('.cancel-match');
    if (saveBtn) saveBtn.remove();
    if (cancelBtn) cancelBtn.remove();
}

function saveMatch(matchId) {
    const matchRow = document.querySelector(`[data-match-id="${matchId}"]`);
    
    const timeEdit = matchRow.querySelector('.time-edit');
    const fieldEdit = matchRow.querySelector('.field-edit');
    const homeTeamEdit = matchRow.querySelector('.team-edit[data-team-type="home"]');
    const awayTeamEdit = matchRow.querySelector('.team-edit[data-team-type="away"]');
    
    const data = {
        match_id: matchId,
        time: timeEdit.value,
        field: fieldEdit.value,
        home_team_id: homeTeamEdit ? homeTeamEdit.value : null,
        away_team_id: awayTeamEdit ? awayTeamEdit.value : null
    };
    
    fetch('/auto-schedule/update-match', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            location.reload();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred while updating the match');
    });
}

// Delete functions
function deleteMatch(matchId) {
    Swal.fire({
        title: 'Delete Match?',
        text: 'Are you sure you want to delete this match? This action cannot be undone.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('danger') : '#dc3545',
        cancelButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('secondary') : '#6c757d',
        confirmButtonText: 'Yes, delete it',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            const _csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            fetch('/auto-schedule/delete-match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': _csrfToken
                },
                body: JSON.stringify({ match_id: matchId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while deleting the match'
                });
            });
        }
    });
}

function deleteWeek(weekNum) {
    Swal.fire({
        title: 'Delete Entire Week?',
        text: 'Are you sure you want to delete this entire week and all its matches? This action cannot be undone.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('danger') : '#dc3545',
        cancelButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('secondary') : '#6c757d',
        confirmButtonText: 'Yes, delete it',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            const _csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            fetch(`/auto-schedule/league/${getCurrentLeagueId()}/delete-week`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': _csrfToken
                },
                body: JSON.stringify({ week_number: weekNum })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while deleting the week'
                });
            });
        }
    });
}

// Add match function
function addMatch(weekNum) {
    // Get week date
    const weekContainer = document.querySelector(`[data-week="${weekNum}"]`);
    const weekTitle = weekContainer.querySelector('.week-title').textContent;
    const dateMatch = weekTitle.match(/- (.+?)(?:\s|$)/);
    const weekDate = dateMatch ? dateMatch[1] : new Date().toISOString().split('T')[0];
    
    // Set up modal
    document.getElementById('addMatchWeek').value = weekNum;
    document.getElementById('addMatchDate').value = new Date(weekDate).toISOString().split('T')[0];
    
    // Set default league
    const leagueFilter = document.getElementById('leagueFilter');
    const defaultLeague = leagueFilter && leagueFilter.value ? leagueFilter.value : '{{ leagues[0].id if leagues else "" }}';
    document.getElementById('addMatchLeague').value = defaultLeague;
    
    // Populate team options
    updateAddMatchTeams();

    ModalManager.show('addMatchModal');
}

function updateAddMatchTeams() {
    const leagueSelect = document.getElementById('addMatchLeague');
    const homeTeamSelect = document.getElementById('addMatchHomeTeam');
    const awayTeamSelect = document.getElementById('addMatchAwayTeam');
    
    populateTeamOptions(homeTeamSelect, leagueSelect.value);
    populateTeamOptions(awayTeamSelect, leagueSelect.value);
}

function saveMatchFromAddModal() {
    const weekNum = document.getElementById('addMatchWeek').value;
    const date = document.getElementById('addMatchDate').value;
    const time = document.getElementById('addMatchTime').value;
    const field = document.getElementById('addMatchField').value;
    const leagueId = document.getElementById('addMatchLeague').value;
    const homeTeamId = document.getElementById('addMatchHomeTeam').value;
    const awayTeamId = document.getElementById('addMatchAwayTeam').value;
    
    if (homeTeamId === awayTeamId) {
        showAlert('error', 'Home and away teams cannot be the same');
        return;
    }
    
    const data = {
        week_number: weekNum,
        league_id: leagueId,
        date: date,
        time: time,
        field: field,
        home_team_id: homeTeamId,
        away_team_id: awayTeamId
    };
    
    fetch('/auto-schedule/add-match', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('addMatchModal')).hide();
            location.reload();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred while adding the match');
    });
}

function saveNewMatch(weekNum) {
    const weekContainer = document.querySelector(`[data-week="${weekNum}"]`);
    const weekDate = document.getElementById(`week-date-${weekNum}`);
    
    const data = {
        week_number: weekNum,
        league_id: getCurrentLeagueId(),
        date: weekDate ? weekDate.value : getCurrentWeekDate(weekNum),
        time: document.getElementById(`new-match-time-${weekNum}`).value,
        field: document.getElementById(`new-match-field-${weekNum}`).value,
        home_team_id: document.getElementById(`new-match-home-${weekNum}`).value,
        away_team_id: document.getElementById(`new-match-away-${weekNum}`).value
    };
    
    fetch('/auto-schedule/add-match', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            location.reload();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred while adding the match');
    });
}

function cancelNewMatch(weekNum) {
    const newRow = document.querySelector(`[data-week="${weekNum}"] .new-match`);
    if (newRow) {
        newRow.remove();
    }
}

// Helper functions
function getCurrentLeagueId() {
    const leagueFilter = document.getElementById('leagueFilter');
    return leagueFilter ? leagueFilter.value : '{{ leagues[0].id if leagues else "" }}';
}

function getCurrentWeekDate(weekNum) {
    const weekContainer = document.querySelector(`[data-week="${weekNum}"]`);
    const dateText = weekContainer.querySelector('.week-title').textContent;
    const match = dateText.match(/- (.+?)(?:\s|$)/);
    return match ? match[1] : new Date().toISOString().split('T')[0];
}

function populateTeamOptions(selectElement, leagueId, selectedTeamId = null) {
    selectElement.innerHTML = '<option value="">Select Team</option>';
    
    console.log('populateTeamOptions called with:', { leagueId, selectedTeamId }); // Debug log
    
    // Get teams for the specified league
    const teamFilter = document.getElementById('teamFilter');
    if (teamFilter) {
        let teamCount = 0;
        Array.from(teamFilter.options).forEach(option => {
            if (option.value && option.value !== '' && option.dataset.league === leagueId) {
                teamCount++;
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.textContent;
                // Handle both string and number comparison
                if (selectedTeamId && (option.value == selectedTeamId || option.value === String(selectedTeamId))) {
                    optionElement.selected = true;
                    console.log('Selected team:', option.textContent); // Debug log
                }
                selectElement.appendChild(optionElement);
            }
        });
        console.log('Added', teamCount, 'teams to select'); // Debug log
    }
}

function getTeamOptions() {
    const teamFilter = document.getElementById('teamFilter');
    let options = '<option value="">Select Team</option>';
    
    if (teamFilter) {
        Array.from(teamFilter.options).forEach(option => {
            if (option.value && option.value !== '') {
                options += `<option value="${option.value}">${option.textContent}</option>`;
            }
        });
    }
    
    return options;
}

function showAlert(type, message) {
    // Create alert element
    const alert = document.createElement('div');
    alert.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to page
    const container = document.querySelector('.container-xxl');
    container.insertBefore(alert, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// League filter change handler
document.getElementById('leagueFilter').addEventListener('change', function() {
    const selectedLeague = this.value;
    const teamFilter = document.getElementById('teamFilter');
    
    // Show/hide team options based on selected league
    Array.from(teamFilter.options).forEach(option => {
        if (option.value === '') return; // Skip "All Teams" option

        if (selectedLeague === '' || option.dataset.league === selectedLeague) {
            option.classList.remove('d-none');
        } else {
            option.classList.add('d-none');
        }
    });

    // Reset team filter if current selection is hidden
    if (teamFilter.value && teamFilter.options[teamFilter.selectedIndex].classList.contains('d-none')) {
        teamFilter.value = '';
    }
});

// Apply filters
function applyFilters() {
    const leagueFilter = document.getElementById('leagueFilter').value;
    const teamFilter = document.getElementById('teamFilter').value;
    const weekTypeFilter = document.getElementById('weekTypeFilter').value;
    
    // Filter weeks
    document.querySelectorAll('.week-container').forEach(weekContainer => {
        const weekType = weekContainer.dataset.weekType;
        let showWeek = true;

        if (weekTypeFilter && weekType !== weekTypeFilter) {
            showWeek = false;
        }

        weekContainer.classList.toggle('d-none', !showWeek);
    });
    
    // Filter matches
    document.querySelectorAll('.match-row').forEach(row => {
        let show = true;
        
        if (leagueFilter && row.dataset.league !== leagueFilter) {
            show = false;
        }
        
        if (teamFilter) {
            const homeTeam = row.dataset.homeTeam;
            const awayTeam = row.dataset.awayTeam;
            if (homeTeam !== teamFilter && awayTeam !== teamFilter) {
                show = false;
            }
        }
        
        row.classList.toggle('filtered-out', !show);
    });
    
    // Update match counts
    document.querySelectorAll('.week-container').forEach(weekContainer => {
        const visibleMatches = weekContainer.querySelectorAll('.match-row:not(.filtered-out)').length;
        const matchCountSpan = weekContainer.querySelector('.text-muted');
        if (matchCountSpan) {
            matchCountSpan.textContent = `${visibleMatches} matches`;
        }
    });
}

// Export to CSV
function exportToCSV() {
    let csv = 'Week,Date,Time,Field,League,Home Team,Away Team,Status\n';
    
    document.querySelectorAll('.week-container:not([style*="display: none"])').forEach(weekContainer => {
        const weekNum = weekContainer.dataset.week;
        const weekDate = weekContainer.querySelector('.card-header h5').textContent.match(/- (.+?)(?:\s|$)/)[1];
        
        weekContainer.querySelectorAll('.match-row:not(.filtered-out)').forEach(row => {
            const cells = row.querySelectorAll('td');
            const time = cells[0].textContent.trim();
            const field = cells[1].textContent.trim();
            const league = cells[2].textContent.trim();
            const homeTeam = cells[3].textContent.trim();
            const awayTeam = cells[4].textContent.trim();
            const status = cells[5].textContent.trim();
            
            csv += `${weekNum},"${weekDate}","${time}","${field}","${league}","${homeTeam}","${awayTeam}","${status}"\n`;
        });
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '{{ season.name }}_schedule.csv';
    a.click();
}

// Print schedule
function printSchedule() {
    window.print();
}

// Share schedule
function shareSchedule() {
    const url = window.location.href;
    if (navigator.share) {
        navigator.share({
            title: '{{ season.name }} Schedule',
            text: 'Check out the {{ season.name }} schedule',
            url: url
        });
    } else {
        // Copy to clipboard
        navigator.clipboard.writeText(url).then(() => {
            alert('Schedule link copied to clipboard!');
        });
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    // Check for filters in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const leagueId = urlParams.get('league');
    const teamId = urlParams.get('team');
    
    if (leagueId) {
        document.getElementById('leagueFilter').value = leagueId;
    }
    if (teamId) {
        document.getElementById('teamFilter').value = teamId;
    }
    
    if (leagueId || teamId) {
        applyFilters();
    }
    
    // Initialize edit mode controls
    {% if current_user.has_role('Pub League Admin') or current_user.has_role('Global Admin') %}
    // Show edit controls by default for admin users
    editMode = true;
    const editControls = document.querySelectorAll('.edit-controls');
    editControls.forEach(control => {
        if (control.tagName === 'TH' || control.tagName === 'TD') {
            control.classList.add('edit-controls-visible');
        } else {
            control.classList.add('edit-controls-btn-visible');
        }
    });

    // Update button text
    const button = document.querySelector('[data-action="toggle-edit"]');
    if (button) {
        button.innerHTML = '<i class="ti ti-eye me-1"></i>Exit Edit Mode';
    }
    {% endif %}
    
    // Add event listener for league change in add match modal
    const addMatchLeagueSelect = document.getElementById('addMatchLeague');
    if (addMatchLeagueSelect) {
        addMatchLeagueSelect.addEventListener('change', updateAddMatchTeams);
    }
});
</script>
{% endblock %}
{% endblock %}