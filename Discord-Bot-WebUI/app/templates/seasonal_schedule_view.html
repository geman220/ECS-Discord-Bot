{% extends "base.html" %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-white">
                            <h2 class="mb-1">{{ season.name }} Schedule</h2>
                            <p class="mb-0">Complete season schedule for all leagues and divisions</p>
                        </div>
                        <div>
                            <a href="{{ url_for('auto_schedule.schedule_manager') }}" class="btn btn-light">
                                <i class="ti ti-arrow-left me-1"></i>Back to Season Builder
                            </a>
                            {% if current_user.has_role('Pub League Admin') or current_user.has_role('Global Admin') %}
                            <div class="btn-group ms-2">
                                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="ti ti-settings me-1"></i>Admin Tools
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="toggleEditMode()">
                                        <i class="ti ti-edit me-1"></i>Toggle Edit Mode
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    {% for league in leagues %}
                                    <li><a class="dropdown-item" href="{{ url_for('playoff.manage_playoffs', league_id=league.id) }}">
                                        <i class="ti ti-trophy me-1"></i>Manage {{ league.name }} Playoffs
                                    </a></li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">Filter Schedule</h5>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">League/Division</label>
                            <select class="form-select" id="leagueFilter">
                                <option value="">All Leagues</option>
                                {% for league in leagues %}
                                <option value="{{ league.id }}">{{ league.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Team</label>
                            <select class="form-select" id="teamFilter">
                                <option value="">All Teams</option>
                                {% for league in leagues %}
                                    <optgroup label="{{ league.name }}">
                                        {% for team in league.teams %}
                                        <option value="{{ team.id }}" data-league="{{ league.id }}">{{ team.name }}</option>
                                        {% endfor %}
                                    </optgroup>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Week Type</label>
                            <select class="form-select" id="weekTypeFilter">
                                <option value="">All Weeks</option>
                                <option value="REGULAR">Regular Season</option>
                                <option value="TST">TST Week</option>
                                <option value="FUN">Fun Week</option>
                                <option value="BYE">Bye Weeks</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Actions</label>
                            <div>
                                <button class="btn btn-primary w-100" onclick="applyFilters()">
                                    <i class="ti ti-filter me-1"></i>Apply Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Display -->
    <div id="scheduleContainer">
        {% for week_num, week_data in schedule_by_week.items() %}
        <div class="week-container mb-4" data-week="{{ week_num }}" data-week-type="{{ week_data.week_type }}">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 week-header" data-week="{{ week_num }}">
                            <span class="week-title">Week {{ week_num }} - {{ week_data.date.strftime('%B %d, %Y') }}</span>
                            <span class="week-edit-form" style="display: none;">
                                <input type="date" class="form-control d-inline-block me-2" style="width: auto;" 
                                       value="{{ week_data.date.strftime('%Y-%m-%d') }}" id="week-date-{{ week_num }}">
                                <input type="time" class="form-control d-inline-block me-2" style="width: auto;" 
                                       id="week-time-{{ week_num }}">
                                <button class="btn btn-sm btn-success me-1" onclick="saveWeek({{ week_num }})">
                                    <i class="ti ti-check"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="cancelWeekEdit({{ week_num }})">
                                    <i class="ti ti-x"></i>
                                </button>
                            </span>
                            {% if week_data.week_type == 'TST' %}
                            <span class="badge bg-info ms-2">TST Week</span>
                            {% elif week_data.week_type == 'FUN' %}
                            <span class="badge bg-warning ms-2">Fun Week</span>
                            {% elif week_data.week_type == 'BYE' %}
                            <span class="badge bg-secondary ms-2">Bye Week</span>
                            {% endif %}
                        </h5>
                        <div>
                            <span class="text-muted">{{ week_data.matches|length }} matches</span>
                            <div class="btn-group ms-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="toggleWeek({{ week_num }})">
                                    <i class="ti ti-chevron-down" id="chevron-{{ week_num }}"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary edit-controls" style="display: none;" 
                                        onclick="editWeek({{ week_num }})" title="Edit Week">
                                    <i class="ti ti-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success edit-controls" style="display: none;" 
                                        onclick="addMatch({{ week_num }})" title="Add Match">
                                    <i class="ti ti-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger edit-controls" style="display: none;" 
                                        onclick="deleteWeek({{ week_num }})" title="Delete Week">
                                    <i class="ti ti-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body week-content" id="week-{{ week_num }}" style="display: block;">
                    {% if week_data.week_type == 'BYE' %}
                    <div class="alert alert-secondary mb-0">
                        <i class="ti ti-moon me-2"></i>
                        <strong>Bye Week</strong> - No matches scheduled. Teams have the week off.
                    </div>
                    {% elif week_data.week_type == 'FUN' %}
                    <div class="alert alert-warning mb-3">
                        <i class="ti ti-confetti me-2"></i>
                        <strong>Fun Week</strong> - Special activities and fun matches for all teams.
                    </div>
                    {% elif week_data.week_type == 'TST' %}
                    <div class="alert alert-info mb-3">
                        <i class="ti ti-trophy me-2"></i>
                        <strong>TST Week</strong> - The Soccer Tournament competition week.
                    </div>
                    {% endif %}
                    
                    {% if week_data.matches %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Field</th>
                                    <th>League</th>
                                    <th>Home Team</th>
                                    <th>Away Team</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                    <th class="edit-controls" style="display: none;">Edit</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for match in week_data.matches|sort(attribute='time') %}
                                <tr class="match-row" 
                                    data-league="{{ match.home_team.league_id }}" 
                                    data-home-team="{{ match.home_team_id }}"
                                    data-away-team="{{ match.away_team_id }}"
                                    data-match-id="{{ match.id }}"
                                    data-week="{{ week_num }}">
                                    <td class="match-time" data-time="{{ match.time.strftime('%H:%M') }}">
                                        <i class="ti ti-clock me-1"></i>
                                        <span class="time-display">{{ match.time.strftime('%I:%M %p') }}</span>
                                        <input type="time" class="form-control time-edit" style="display: none;" 
                                               value="{{ match.time.strftime('%H:%M') }}">
                                    </td>
                                    <td class="match-field" data-field="{{ match.location }}">
                                        <span class="field-display">
                                            <span class="badge bg-label-primary">{{ match.location }}</span>
                                        </span>
                                        <select class="form-select field-edit" style="display: none;">
                                            <option value="North" {% if match.location == 'North' %}selected{% endif %}>North</option>
                                            <option value="South" {% if match.location == 'South' %}selected{% endif %}>South</option>
                                            <option value="East" {% if match.location == 'East' %}selected{% endif %}>East</option>
                                            <option value="West" {% if match.location == 'West' %}selected{% endif %}>West</option>
                                        </select>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ match.home_team.league.name }}</small>
                                    </td>
                                    <td>
                                        {% if match.week_type in ['FUN', 'TST', 'BYE', 'BONUS', 'PLAYOFF'] %}
                                            <span class="badge bg-info">
                                                {% if match.week_type == 'FUN' %}
                                                    Fun Week
                                                {% elif match.week_type == 'TST' %}
                                                    TST Week
                                                {% elif match.week_type == 'BYE' %}
                                                    BYE Week
                                                {% elif match.week_type == 'BONUS' %}
                                                    Bonus Week
                                                {% elif match.week_type == 'PLAYOFF' %}
                                                    Playoff Week
                                                {% endif %}
                                            </span>
                                        {% elif match.week_type == 'PRACTICE' or (match.is_practice_game if match.is_practice_game is defined else False) %}
                                            <span class="badge bg-warning">
                                                PRACTICE
                                            </span>
                                        {% else %}
                                            <span class="team-display">
                                                <a href="{{ url_for('teams.team_details', team_id=match.home_team_id) }}" 
                                                   class="text-decoration-none">
                                                    {{ match.home_team.name }}
                                                </a>
                                            </span>
                                            <select class="form-select team-edit" style="display: none;" data-team-type="home">
                                                {% for league in leagues %}
                                                    {% if league.id == match.home_team.league_id %}
                                                        {% for team in league.teams %}
                                                        <option value="{{ team.id }}" 
                                                                {% if team.id == match.home_team_id %}selected{% endif %}>
                                                            {{ team.name }}
                                                        </option>
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if match.week_type in ['FUN', 'TST', 'BYE', 'BONUS', 'PLAYOFF'] %}
                                            <span class="text-muted">
                                                {% if match.week_type == 'FUN' %}
                                                    Special activities
                                                {% elif match.week_type == 'TST' %}
                                                    Tournament events
                                                {% elif match.week_type == 'BYE' %}
                                                    No games
                                                {% elif match.week_type == 'BONUS' %}
                                                    Additional activities
                                                {% elif match.week_type == 'PLAYOFF' %}
                                                    TBD
                                                {% endif %}
                                            </span>
                                        {% elif match.week_type == 'PRACTICE' or (match.is_practice_game if match.is_practice_game is defined else False) %}
                                            <span class="text-muted">
                                                All teams practice together
                                            </span>
                                        {% else %}
                                            <span class="team-display">
                                                <a href="{{ url_for('teams.team_details', team_id=match.away_team_id) }}" 
                                                   class="text-decoration-none">
                                                    {{ match.away_team.name }}
                                                </a>
                                            </span>
                                            <select class="form-select team-edit" style="display: none;" data-team-type="away">
                                                {% for league in leagues %}
                                                    {% if league.id == match.home_team.league_id %}
                                                        {% for team in league.teams %}
                                                        <option value="{{ team.id }}" 
                                                                {% if team.id == match.away_team_id %}selected{% endif %}>
                                                            {{ team.name }}
                                                        </option>
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if match.reported %}
                                        <span class="badge bg-success">Reported</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Scheduled</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('match_pages.view_match', match_id=match.id) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="ti ti-eye"></i>
                                        </a>
                                    </td>
                                    <td class="edit-controls" style="display: none;">
                                        <button class="btn btn-sm btn-outline-secondary me-1" 
                                                onclick="editMatch({{ match.id }})" title="Edit Match">
                                            <i class="ti ti-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteMatch({{ match.id }})" title="Delete Match">
                                            <i class="ti ti-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="ti ti-calendar-off ti-lg mb-3 text-muted"></i>
                    <h5>No Schedule Found</h5>
                    <p class="text-muted mb-3">No matches have been scheduled for this season yet.</p>
                    <a href="{{ url_for('auto_schedule.schedule_manager') }}" class="btn btn-primary">
                        <i class="ti ti-plus me-1"></i>Create Schedule
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Export Options -->
    {% if schedule_by_week %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">Export Options</h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary" onclick="exportToCSV()">
                            <i class="ti ti-file-spreadsheet me-1"></i>Export to CSV
                        </button>
                        <button class="btn btn-outline-primary" onclick="printSchedule()">
                            <i class="ti ti-printer me-1"></i>Print Schedule
                        </button>
                        <button class="btn btn-outline-primary" onclick="shareSchedule()">
                            <i class="ti ti-share me-1"></i>Share Link
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Edit Match Modal -->
<div class="modal fade" id="editMatchModal" tabindex="-1" aria-labelledby="editMatchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMatchModalLabel">Edit Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editMatchForm">
                    <input type="hidden" id="editMatchId">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="editMatchTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="editMatchTime" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editMatchField" class="form-label">Field</label>
                            <select class="form-select" id="editMatchField" required>
                                <option value="North">North</option>
                                <option value="South">South</option>
                                <option value="East">East</option>
                                <option value="West">West</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="editMatchHomeTeam" class="form-label">Home Team</label>
                            <select class="form-select" id="editMatchHomeTeam" required>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editMatchAwayTeam" class="form-label">Away Team</label>
                            <select class="form-select" id="editMatchAwayTeam" required>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMatchFromModal()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Match Modal -->
<div class="modal fade" id="addMatchModal" tabindex="-1" aria-labelledby="addMatchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMatchModalLabel">Add New Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addMatchForm">
                    <input type="hidden" id="addMatchWeek">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="addMatchDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="addMatchDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="addMatchTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="addMatchTime" value="19:00" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="addMatchField" class="form-label">Field</label>
                            <select class="form-select" id="addMatchField" required>
                                <option value="North">North</option>
                                <option value="South">South</option>
                                <option value="East">East</option>
                                <option value="West">West</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="addMatchLeague" class="form-label">League</label>
                            <select class="form-select" id="addMatchLeague" required>
                                {% for league in leagues %}
                                <option value="{{ league.id }}">{{ league.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="addMatchHomeTeam" class="form-label">Home Team</label>
                            <select class="form-select" id="addMatchHomeTeam" required>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="addMatchAwayTeam" class="form-label">Away Team</label>
                            <select class="form-select" id="addMatchAwayTeam" required>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMatchFromAddModal()">Add Match</button>
            </div>
        </div>
    </div>
</div>

<style>
.week-container {
    transition: all 0.3s ease;
}

.week-content {
    transition: all 0.3s ease;
}

.match-row {
    transition: all 0.2s ease;
}

.match-row:hover {
    background-color: var(--bs-gray-100);
}

.match-row.filtered-out {
    display: none;
}

@media print {
    .btn, .form-select, .card-header button {
        display: none !important;
    }
    
    .week-content {
        display: block !important;
    }
}

.badge {
    font-weight: 500;
}

/* Edit mode styles */
.edit-controls {
    transition: opacity 0.2s ease;
}

.week-header {
    position: relative;
}

.week-edit-form {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.week-edit-form input {
    width: auto;
    min-width: 120px;
}

.match-row.editing {
    background-color: var(--bs-warning-bg-subtle);
    border-left: 3px solid var(--bs-warning);
}

.match-row.new-match {
    background-color: var(--bs-success-bg-subtle);
    border-left: 3px solid var(--bs-success);
}

.time-edit,
.field-edit,
.team-edit {
    min-width: 100px;
}

.team-edit {
    font-size: 0.875rem;
}

/* Drag and drop styles */
.week-container {
    position: relative;
}

.week-container.dragging {
    opacity: 0.5;
}

.week-container.drag-over {
    border: 2px dashed var(--bs-primary);
    background-color: var(--bs-primary-bg-subtle);
}

.match-row.dragging {
    opacity: 0.5;
}

.match-row.drag-over {
    border-top: 2px solid var(--bs-primary);
}

/* Edit mode toggle button */
.edit-mode-active {
    background-color: var(--bs-warning) !important;
    border-color: var(--bs-warning) !important;
    color: var(--bs-dark) !important;
}

/* Form controls in edit mode */
.edit-controls input,
.edit-controls select {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

/* Alert positioning - only for dynamic alerts */
.alert.alert-dismissible {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    min-width: 300px;
    margin: 0;
}

/* Mobile responsive adjustments */
@media (max-width: 768px) {
    .week-edit-form {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .week-edit-form input {
        width: 100%;
        margin-bottom: 0.25rem;
    }
    
    .edit-controls {
        white-space: nowrap;
    }
    
    .edit-controls .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
}
</style>

<script>
// Global edit mode state
let editMode = false;

// Toggle edit mode
function toggleEditMode() {
    editMode = !editMode;
    const editControls = document.querySelectorAll('.edit-controls');
    
    editControls.forEach(control => {
        control.style.display = editMode ? '' : 'none';
    });
    
    // Update button text
    const button = document.querySelector('[onclick="toggleEditMode()"]');
    if (button) {
        button.innerHTML = editMode ? 
            '<i class="ti ti-eye me-1"></i>Exit Edit Mode' : 
            '<i class="ti ti-edit me-1"></i>Toggle Edit Mode';
    }
}

// Toggle week visibility
function toggleWeek(weekNum) {
    const content = document.getElementById(`week-${weekNum}`);
    const chevron = document.getElementById(`chevron-${weekNum}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.classList.remove('ti-chevron-right');
        chevron.classList.add('ti-chevron-down');
    } else {
        content.style.display = 'none';
        chevron.classList.remove('ti-chevron-down');
        chevron.classList.add('ti-chevron-right');
    }
}

// Week editing functions
function editWeek(weekNum) {
    const weekHeader = document.querySelector(`[data-week="${weekNum}"]`);
    const weekTitle = weekHeader.querySelector('.week-title');
    const weekEditForm = weekHeader.querySelector('.week-edit-form');
    
    weekTitle.style.display = 'none';
    weekEditForm.style.display = 'inline-block';
    
    // Get first match time as default
    const firstMatch = document.querySelector(`[data-week="${weekNum}"] .match-time`);
    if (firstMatch) {
        const timeInput = document.getElementById(`week-time-${weekNum}`);
        timeInput.value = firstMatch.dataset.time || '19:00';
    }
}

function cancelWeekEdit(weekNum) {
    const weekHeader = document.querySelector(`[data-week="${weekNum}"]`);
    const weekTitle = weekHeader.querySelector('.week-title');
    const weekEditForm = weekHeader.querySelector('.week-edit-form');
    
    weekTitle.style.display = 'inline-block';
    weekEditForm.style.display = 'none';
}

function saveWeek(weekNum) {
    const dateInput = document.getElementById(`week-date-${weekNum}`);
    const timeInput = document.getElementById(`week-time-${weekNum}`);
    
    const data = {
        week_number: weekNum,
        league_id: getCurrentLeagueId(),
        date: dateInput.value,
        start_time: timeInput.value
    };
    
    fetch('/auto-schedule/update-week', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            location.reload();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred while updating the week');
    });
}

// Match editing functions
function editMatch(matchId) {
    // Get match data
    fetch(`/auto-schedule/get-match-data?match_id=${matchId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Match data loaded:', data.match); // Debug log
                
                // Populate modal
                document.getElementById('editMatchId').value = matchId;
                document.getElementById('editMatchTime').value = data.match.time;
                document.getElementById('editMatchField').value = data.match.field;
                
                // Populate team options
                const homeTeamSelect = document.getElementById('editMatchHomeTeam');
                const awayTeamSelect = document.getElementById('editMatchAwayTeam');
                
                // Get teams for current league
                const matchRow = document.querySelector(`[data-match-id="${matchId}"]`);
                const leagueId = matchRow.dataset.league;
                
                console.log('League ID:', leagueId); // Debug log
                console.log('Home team ID:', data.match.home_team_id); // Debug log
                console.log('Away team ID:', data.match.away_team_id); // Debug log
                
                populateTeamOptions(homeTeamSelect, leagueId, data.match.home_team_id);
                populateTeamOptions(awayTeamSelect, leagueId, data.match.away_team_id);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editMatchModal'));
                modal.show();
            } else {
                showAlert('error', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'An error occurred while loading match data');
        });
}

function saveMatchFromModal() {
    const matchId = document.getElementById('editMatchId').value;
    const time = document.getElementById('editMatchTime').value;
    const field = document.getElementById('editMatchField').value;
    const homeTeamId = document.getElementById('editMatchHomeTeam').value;
    const awayTeamId = document.getElementById('editMatchAwayTeam').value;
    
    if (homeTeamId === awayTeamId) {
        showAlert('error', 'Home and away teams cannot be the same');
        return;
    }
    
    const data = {
        match_id: matchId,
        time: time,
        field: field,
        home_team_id: homeTeamId,
        away_team_id: awayTeamId
    };
    
    fetch('/auto-schedule/update-match', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('editMatchModal')).hide();
            location.reload();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred while updating the match');
    });
}

function cancelMatchEdit(matchId) {
    const matchRow = document.querySelector(`[data-match-id="${matchId}"]`);
    
    // Hide edit elements
    const timeDisplay = matchRow.querySelector('.time-display');
    const timeEdit = matchRow.querySelector('.time-edit');
    const fieldDisplay = matchRow.querySelector('.field-display');
    const fieldEdit = matchRow.querySelector('.field-edit');
    const teamDisplays = matchRow.querySelectorAll('.team-display');
    const teamEdits = matchRow.querySelectorAll('.team-edit');
    
    timeDisplay.style.display = 'inline-block';
    timeEdit.style.display = 'none';
    fieldDisplay.style.display = 'inline-block';
    fieldEdit.style.display = 'none';
    teamDisplays.forEach(display => display.style.display = 'inline-block');
    teamEdits.forEach(edit => edit.style.display = 'none');
    
    // Remove save/cancel buttons
    const saveBtn = matchRow.querySelector('.save-match');
    const cancelBtn = matchRow.querySelector('.cancel-match');
    if (saveBtn) saveBtn.remove();
    if (cancelBtn) cancelBtn.remove();
}

function saveMatch(matchId) {
    const matchRow = document.querySelector(`[data-match-id="${matchId}"]`);
    
    const timeEdit = matchRow.querySelector('.time-edit');
    const fieldEdit = matchRow.querySelector('.field-edit');
    const homeTeamEdit = matchRow.querySelector('.team-edit[data-team-type="home"]');
    const awayTeamEdit = matchRow.querySelector('.team-edit[data-team-type="away"]');
    
    const data = {
        match_id: matchId,
        time: timeEdit.value,
        field: fieldEdit.value,
        home_team_id: homeTeamEdit ? homeTeamEdit.value : null,
        away_team_id: awayTeamEdit ? awayTeamEdit.value : null
    };
    
    fetch('/auto-schedule/update-match', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            location.reload();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred while updating the match');
    });
}

// Delete functions
function deleteMatch(matchId) {
    if (!confirm('Are you sure you want to delete this match?')) return;
    
    fetch('/auto-schedule/delete-match', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ match_id: matchId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            location.reload();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred while deleting the match');
    });
}

function deleteWeek(weekNum) {
    if (!confirm('Are you sure you want to delete this entire week and all its matches?')) return;
    
    fetch(`/auto-schedule/league/${getCurrentLeagueId()}/delete-week`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ week_number: weekNum })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            location.reload();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred while deleting the week');
    });
}

// Add match function
function addMatch(weekNum) {
    // Get week date
    const weekContainer = document.querySelector(`[data-week="${weekNum}"]`);
    const weekTitle = weekContainer.querySelector('.week-title').textContent;
    const dateMatch = weekTitle.match(/- (.+?)(?:\s|$)/);
    const weekDate = dateMatch ? dateMatch[1] : new Date().toISOString().split('T')[0];
    
    // Set up modal
    document.getElementById('addMatchWeek').value = weekNum;
    document.getElementById('addMatchDate').value = new Date(weekDate).toISOString().split('T')[0];
    
    // Set default league
    const leagueFilter = document.getElementById('leagueFilter');
    const defaultLeague = leagueFilter && leagueFilter.value ? leagueFilter.value : '{{ leagues[0].id if leagues else "" }}';
    document.getElementById('addMatchLeague').value = defaultLeague;
    
    // Populate team options
    updateAddMatchTeams();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('addMatchModal'));
    modal.show();
}

function updateAddMatchTeams() {
    const leagueSelect = document.getElementById('addMatchLeague');
    const homeTeamSelect = document.getElementById('addMatchHomeTeam');
    const awayTeamSelect = document.getElementById('addMatchAwayTeam');
    
    populateTeamOptions(homeTeamSelect, leagueSelect.value);
    populateTeamOptions(awayTeamSelect, leagueSelect.value);
}

function saveMatchFromAddModal() {
    const weekNum = document.getElementById('addMatchWeek').value;
    const date = document.getElementById('addMatchDate').value;
    const time = document.getElementById('addMatchTime').value;
    const field = document.getElementById('addMatchField').value;
    const leagueId = document.getElementById('addMatchLeague').value;
    const homeTeamId = document.getElementById('addMatchHomeTeam').value;
    const awayTeamId = document.getElementById('addMatchAwayTeam').value;
    
    if (homeTeamId === awayTeamId) {
        showAlert('error', 'Home and away teams cannot be the same');
        return;
    }
    
    const data = {
        week_number: weekNum,
        league_id: leagueId,
        date: date,
        time: time,
        field: field,
        home_team_id: homeTeamId,
        away_team_id: awayTeamId
    };
    
    fetch('/auto-schedule/add-match', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('addMatchModal')).hide();
            location.reload();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred while adding the match');
    });
}

function saveNewMatch(weekNum) {
    const weekContainer = document.querySelector(`[data-week="${weekNum}"]`);
    const weekDate = document.getElementById(`week-date-${weekNum}`);
    
    const data = {
        week_number: weekNum,
        league_id: getCurrentLeagueId(),
        date: weekDate ? weekDate.value : getCurrentWeekDate(weekNum),
        time: document.getElementById(`new-match-time-${weekNum}`).value,
        field: document.getElementById(`new-match-field-${weekNum}`).value,
        home_team_id: document.getElementById(`new-match-home-${weekNum}`).value,
        away_team_id: document.getElementById(`new-match-away-${weekNum}`).value
    };
    
    fetch('/auto-schedule/add-match', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            location.reload();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred while adding the match');
    });
}

function cancelNewMatch(weekNum) {
    const newRow = document.querySelector(`[data-week="${weekNum}"] .new-match`);
    if (newRow) {
        newRow.remove();
    }
}

// Helper functions
function getCurrentLeagueId() {
    const leagueFilter = document.getElementById('leagueFilter');
    return leagueFilter ? leagueFilter.value : '{{ leagues[0].id if leagues else "" }}';
}

function getCurrentWeekDate(weekNum) {
    const weekContainer = document.querySelector(`[data-week="${weekNum}"]`);
    const dateText = weekContainer.querySelector('.week-title').textContent;
    const match = dateText.match(/- (.+?)(?:\s|$)/);
    return match ? match[1] : new Date().toISOString().split('T')[0];
}

function populateTeamOptions(selectElement, leagueId, selectedTeamId = null) {
    selectElement.innerHTML = '<option value="">Select Team</option>';
    
    console.log('populateTeamOptions called with:', { leagueId, selectedTeamId }); // Debug log
    
    // Get teams for the specified league
    const teamFilter = document.getElementById('teamFilter');
    if (teamFilter) {
        let teamCount = 0;
        Array.from(teamFilter.options).forEach(option => {
            if (option.value && option.value !== '' && option.dataset.league === leagueId) {
                teamCount++;
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.textContent;
                // Handle both string and number comparison
                if (selectedTeamId && (option.value == selectedTeamId || option.value === String(selectedTeamId))) {
                    optionElement.selected = true;
                    console.log('Selected team:', option.textContent); // Debug log
                }
                selectElement.appendChild(optionElement);
            }
        });
        console.log('Added', teamCount, 'teams to select'); // Debug log
    }
}

function getTeamOptions() {
    const teamFilter = document.getElementById('teamFilter');
    let options = '<option value="">Select Team</option>';
    
    if (teamFilter) {
        Array.from(teamFilter.options).forEach(option => {
            if (option.value && option.value !== '') {
                options += `<option value="${option.value}">${option.textContent}</option>`;
            }
        });
    }
    
    return options;
}

function showAlert(type, message) {
    // Create alert element
    const alert = document.createElement('div');
    alert.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to page
    const container = document.querySelector('.container-xxl');
    container.insertBefore(alert, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// League filter change handler
document.getElementById('leagueFilter').addEventListener('change', function() {
    const selectedLeague = this.value;
    const teamFilter = document.getElementById('teamFilter');
    
    // Show/hide team options based on selected league
    Array.from(teamFilter.options).forEach(option => {
        if (option.value === '') return; // Skip "All Teams" option
        
        if (selectedLeague === '' || option.dataset.league === selectedLeague) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
    
    // Reset team filter if current selection is hidden
    if (teamFilter.value && teamFilter.options[teamFilter.selectedIndex].style.display === 'none') {
        teamFilter.value = '';
    }
});

// Apply filters
function applyFilters() {
    const leagueFilter = document.getElementById('leagueFilter').value;
    const teamFilter = document.getElementById('teamFilter').value;
    const weekTypeFilter = document.getElementById('weekTypeFilter').value;
    
    // Filter weeks
    document.querySelectorAll('.week-container').forEach(weekContainer => {
        const weekType = weekContainer.dataset.weekType;
        let showWeek = true;
        
        if (weekTypeFilter && weekType !== weekTypeFilter) {
            showWeek = false;
        }
        
        weekContainer.style.display = showWeek ? 'block' : 'none';
    });
    
    // Filter matches
    document.querySelectorAll('.match-row').forEach(row => {
        let show = true;
        
        if (leagueFilter && row.dataset.league !== leagueFilter) {
            show = false;
        }
        
        if (teamFilter) {
            const homeTeam = row.dataset.homeTeam;
            const awayTeam = row.dataset.awayTeam;
            if (homeTeam !== teamFilter && awayTeam !== teamFilter) {
                show = false;
            }
        }
        
        row.classList.toggle('filtered-out', !show);
    });
    
    // Update match counts
    document.querySelectorAll('.week-container').forEach(weekContainer => {
        const visibleMatches = weekContainer.querySelectorAll('.match-row:not(.filtered-out)').length;
        const matchCountSpan = weekContainer.querySelector('.text-muted');
        if (matchCountSpan) {
            matchCountSpan.textContent = `${visibleMatches} matches`;
        }
    });
}

// Export to CSV
function exportToCSV() {
    let csv = 'Week,Date,Time,Field,League,Home Team,Away Team,Status\n';
    
    document.querySelectorAll('.week-container:not([style*="display: none"])').forEach(weekContainer => {
        const weekNum = weekContainer.dataset.week;
        const weekDate = weekContainer.querySelector('.card-header h5').textContent.match(/- (.+?)(?:\s|$)/)[1];
        
        weekContainer.querySelectorAll('.match-row:not(.filtered-out)').forEach(row => {
            const cells = row.querySelectorAll('td');
            const time = cells[0].textContent.trim();
            const field = cells[1].textContent.trim();
            const league = cells[2].textContent.trim();
            const homeTeam = cells[3].textContent.trim();
            const awayTeam = cells[4].textContent.trim();
            const status = cells[5].textContent.trim();
            
            csv += `${weekNum},"${weekDate}","${time}","${field}","${league}","${homeTeam}","${awayTeam}","${status}"\n`;
        });
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '{{ season.name }}_schedule.csv';
    a.click();
}

// Print schedule
function printSchedule() {
    window.print();
}

// Share schedule
function shareSchedule() {
    const url = window.location.href;
    if (navigator.share) {
        navigator.share({
            title: '{{ season.name }} Schedule',
            text: 'Check out the {{ season.name }} schedule',
            url: url
        });
    } else {
        // Copy to clipboard
        navigator.clipboard.writeText(url).then(() => {
            alert('Schedule link copied to clipboard!');
        });
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    // Check for filters in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const leagueId = urlParams.get('league');
    const teamId = urlParams.get('team');
    
    if (leagueId) {
        document.getElementById('leagueFilter').value = leagueId;
    }
    if (teamId) {
        document.getElementById('teamFilter').value = teamId;
    }
    
    if (leagueId || teamId) {
        applyFilters();
    }
    
    // Initialize edit mode controls
    {% if current_user.has_role('Pub League Admin') or current_user.has_role('Global Admin') %}
    // Show edit controls by default for admin users
    editMode = true;
    const editControls = document.querySelectorAll('.edit-controls');
    editControls.forEach(control => {
        control.style.display = '';
    });
    
    // Update button text
    const button = document.querySelector('[onclick="toggleEditMode()"]');
    if (button) {
        button.innerHTML = '<i class="ti ti-eye me-1"></i>Exit Edit Mode';
    }
    {% else %}
    // Hide edit controls for non-admin users
    const editControls = document.querySelectorAll('.edit-controls');
    editControls.forEach(control => {
        control.style.display = 'none';
    });
    {% endif %}
    
    // Add event listener for league change in add match modal
    const addMatchLeagueSelect = document.getElementById('addMatchLeague');
    if (addMatchLeagueSelect) {
        addMatchLeagueSelect.addEventListener('change', updateAddMatchTeams);
    }
});
</script>
{% endblock %}