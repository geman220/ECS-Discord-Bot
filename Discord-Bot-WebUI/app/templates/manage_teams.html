{% extends "base.html" %}

{% block title %}Manage Teams{% endblock %}

{% block custom_css %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/teams.css') }}">
{% endif %}
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Page Header -->
    <div class="c-admin-header" data-component="admin-header">
        <div class="c-admin-header__content">
            <h1 class="c-admin-header__title">Manage Teams for Seasons</h1>
            <p class="c-admin-header__description">Create, edit, and organize teams across all leagues and seasons</p>
        </div>
    </div>

    <!-- Season Sections -->
    <div class="c-seasons-manager" data-component="seasons-manager">
        {% if seasons %}
        {% for season in seasons %}
        <div class="c-season-section" data-season-id="{{ season.id }}">
            <h3 class="c-season-section__title">{{ season.name }}</h3>

            {% if season.leagues %}
            <!-- League Tabs -->
            <ul class="c-nav-modern c-nav-modern--tabs"
                id="leagueTabsForSeason{{ season.id }}"
                role="tablist"
                data-nav="league-tabs">
                {% for league in season.leagues %}
                <li class="c-nav-modern__item" role="presentation">
                    <button class="c-nav-modern__link {% if league.is_first %}c-nav-modern__link--active{% endif %}"
                            id="tab-{{ league.name|replace(' ', '_') }}-season-{{ season.id }}"
                            data-bs-toggle="tab"
                            data-bs-target="#pane-{{ league.name|replace(' ', '_') }}-season-{{ season.id }}"
                            type="button"
                            role="tab"
                            aria-controls="pane-{{ league.name|replace(' ', '_') }}-season-{{ season.id }}"
                            aria-selected="{{ 'true' if league.is_first else 'false' }}">
                        {{ league.name }}
                    </button>
                </li>
                {% endfor %}
            </ul>

            <!-- Tab Content -->
            <div class="c-tab-content-modern" id="leagueTabsContentForSeason{{ season.id }}">
                {% for league in season.leagues %}
                <div class="c-tab-pane-modern{% if league.is_first %} show active{% endif %}"
                     id="pane-{{ league.name|replace(' ', '_') }}-season-{{ season.id }}"
                     role="tabpanel"
                     aria-labelledby="tab-{{ league.name|replace(' ', '_') }}-season-{{ season.id }}">
                    <div class="c-card-modern">
                        <div class="c-card-modern__header">
                            <h6 class="c-card-modern__title">
                                {{ league.name }} Teams ({{ season.name }})
                            </h6>
                            <div class="c-card-modern__actions">
                                <button class="c-btn c-btn--success c-btn--sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#addTeamModal"
                                        data-action="open-add-team-modal"
                                        data-league-name="{{ league.name }}"
                                        data-season-id="{{ season.id }}"
                                        data-season-name="{{ season.name }}">
                                    <i class="ti ti-plus"></i> Add Team
                                </button>
                            </div>
                        </div>
                        <div class="c-card-modern__body">
                            {{ render_team_list(league.teams, league.name, season.id) }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="c-empty-state" data-component="empty-state">
                <div class="c-empty-state__icon">
                    <i class="ti ti-trophy-off"></i>
                </div>
                <p class="c-empty-state__text">No leagues for this season yet.</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <div class="c-empty-state" data-component="empty-state">
            <div class="c-empty-state__icon">
                <i class="ti ti-calendar-off"></i>
            </div>
            <h3 class="c-empty-state__title">No Active Leagues Found</h3>
            <p class="c-empty-state__text">Create a season and league to get started with team management.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Team Modal -->
{{ render_add_team_modal() }}

<!-- Edit Team Modal -->
{{ render_edit_team_modal() }}

{% endblock %}

{% block custom_js %}
{{ super() }}

{% if not config.get('ASSETS_PRODUCTION_MODE') %}
<script src="{{ url_for('static', filename='custom_js/manage-teams.js') }}"></script>

{% endif %}
{% endblock %}

{% macro render_team_list(teams, league_name, season_id) %}
<div class="c-team-list" data-component="team-list">
    {% if teams and teams|length > 0 %}
    {% for team in teams %}
    <div class="c-team-list__item">
        <div class="c-team-list__name">{{ team.name }}</div>
        <div class="c-team-list__actions">
            <button class="c-btn c-btn--sm c-btn--icon-only c-btn--outline-secondary"
                    type="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    data-dropdown-toggle>
                <i class="ti ti-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" data-dropdown-menu>
                <li>
                    <button class="dropdown-item"
                            data-bs-toggle="modal"
                            data-bs-target="#editTeamModal"
                            data-action="open-edit-team-modal"
                            data-team-id="{{ team.id }}"
                            data-team-name="{{ team.name }}"
                            data-league-name="{{ league_name }}"
                            data-season-id="{{ season_id }}">
                        <i class="ti ti-edit"></i> Edit
                    </button>
                </li>
                <li>
                    <button class="dropdown-item text-danger"
                            data-action="delete-team"
                            data-team-id="{{ team.id }}"
                            data-team-name="{{ team.name }}">
                        <i class="ti ti-trash"></i> Delete
                    </button>
                </li>
            </ul>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="c-team-list__empty">
        <i class="ti ti-users-off"></i>
        <p>No teams yet. Click 'Add Team' to create one.</p>
    </div>
    {% endif %}
</div>
{% endmacro %}

{% macro render_add_team_modal() %}
<div class="modal c-modal fade" id="addTeamModal" tabindex="-1" aria-labelledby="addTeamModalLabel" aria-hidden="true" data-modal>
    <div class="modal-dialog c-modal__dialog" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <form method="POST"
                  action="{{ url_for('publeague.add_team') }}"
                  id="addTeamForm"
                  class="needs-validation"
                  novalidate
                  data-form="add-team">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" id="modal_league_name" name="league_name" value="">
                <input type="hidden" id="modal_season_id" name="season_id" value="">

                <div class="modal-header c-modal__header" data-modal-header>
                    <h5 class="modal-title c-modal__title" id="addTeamModalLabel">Add Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body c-modal__body" data-modal-body>
                    <div class="mb-3">
                        <label for="team_name" class="form-label">Team Name</label>
                        <input type="text"
                               class="form-control"
                               id="team_name"
                               name="team_name"
                               required
                               data-form-control>
                        <div class="invalid-feedback">
                            Please provide a team name.
                        </div>
                    </div>
                </div>

                <div class="modal-footer c-modal__footer" data-modal-footer>
                    <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="c-btn c-btn--primary" data-submit-btn>
                        <span class="spinner-border spinner-border-sm u-visually-hidden" role="status" aria-hidden="true" data-spinner></span>
                        Add Team
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endmacro %}

{% macro render_edit_team_modal() %}
<div class="modal c-modal fade" id="editTeamModal" tabindex="-1" aria-labelledby="editTeamModalLabel" aria-hidden="true" data-modal>
    <div class="modal-dialog c-modal__dialog" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <form method="POST"
                  action="{{ url_for('publeague.edit_team') }}"
                  id="editTeamForm"
                  class="needs-validation"
                  novalidate
                  data-form="edit-team">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" id="modal_team_id" name="team_id" value="">
                <input type="hidden" id="edit_modal_league_name" name="league_name" value="">
                <input type="hidden" id="edit_modal_season_id" name="season_id" value="">

                <div class="modal-header c-modal__header" data-modal-header>
                    <h5 class="modal-title c-modal__title" id="editTeamModalLabel">Edit Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body c-modal__body" data-modal-body>
                    <div class="mb-3">
                        <label for="edit_team_name" class="form-label">Team Name</label>
                        <input type="text"
                               class="form-control"
                               id="edit_team_name"
                               name="team_name"
                               required
                               data-form-control>
                        <div class="invalid-feedback">
                            Please provide a team name.
                        </div>
                    </div>
                </div>

                <div class="modal-footer c-modal__footer" data-modal-footer>
                    <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="c-btn c-btn--primary" data-submit-btn>
                        <span class="spinner-border spinner-border-sm u-visually-hidden" role="status" aria-hidden="true" data-spinner></span>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endmacro %}
