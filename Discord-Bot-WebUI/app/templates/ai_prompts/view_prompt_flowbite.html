{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge %}

{% block admin_title %}View AI Prompt - {{ prompt.name }}{% endblock %}
{% block panel_description %}AI prompt configuration details{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Live Reporting</span>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('ai_prompts.list_prompts') }}" class="ml-1 text-sm font-medium text-gray-700 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">AI Prompts</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">{{ prompt.name }}</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content (2/3 width) -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Basic Information -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Prompt Configuration</h3>
                    <div class="flex items-center gap-2">
                        {% if prompt.is_active %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 mr-1.5"></span>
                            Active
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                            <span class="w-1.5 h-1.5 rounded-full bg-gray-500 mr-1.5"></span>
                            Inactive
                        </span>
                        {% endif %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">
                            {{ prompt.prompt_type }}
                        </span>
                        {% if prompt.rivalry_intensity and prompt.rivalry_intensity > 7 %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">
                            High Rivalry
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Name</dt>
                            <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ prompt.name }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Type</dt>
                            <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ prompt.prompt_type }}</dd>
                        </div>
                    </div>

                    {% if prompt.description %}
                    <div class="mb-4">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Description</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ prompt.description }}</dd>
                    </div>
                    {% endif %}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Competition Filter</dt>
                            <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ prompt.competition_filter or 'All' }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Temperature</dt>
                            <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ prompt.temperature }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Max Tokens</dt>
                            <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ prompt.max_tokens }}</dd>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Prompt -->
            {% call card(title="System Prompt", subtitle="Defines the AI's role and behavior") %}
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                <pre class="text-sm text-gray-900 dark:text-white whitespace-pre-wrap font-mono">{{ prompt.system_prompt }}</pre>
            </div>
            {% endcall %}

            <!-- User Prompt Template -->
            {% call card(title="User Prompt Template", subtitle="Template used for each match event") %}
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                <pre class="text-sm text-gray-900 dark:text-white whitespace-pre-wrap font-mono">{{ prompt.user_prompt_template }}</pre>
            </div>
            <div class="text-sm text-gray-500 dark:text-gray-400">
                <span class="font-medium">Available Variables:</span>
                <code class="bg-gray-100 dark:bg-gray-600 px-1.5 py-0.5 rounded text-ecs-green ml-1">{match_context}</code>,
                <code class="bg-gray-100 dark:bg-gray-600 px-1.5 py-0.5 rounded text-ecs-green">{events}</code>,
                <code class="bg-gray-100 dark:bg-gray-600 px-1.5 py-0.5 rounded text-ecs-green">{score}</code>
            </div>
            {% endcall %}

            <!-- Rivalry Configuration -->
            {% if prompt.rivalry_teams or prompt.rivalry_intensity > 1 %}
            {% call card(title="Rivalry Configuration") %}
            <div class="space-y-4">
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Rivalry Intensity</dt>
                    <dd class="flex items-center gap-3">
                        <div class="flex-1 h-2 bg-gray-200 rounded-full dark:bg-gray-700">
                            <div class="h-2 rounded-full {{ 'bg-red-500' if prompt.rivalry_intensity > 7 else 'bg-yellow-500' if prompt.rivalry_intensity > 4 else 'bg-green-500' }}"
                                 style="width: {{ prompt.rivalry_intensity * 10 }}%"></div>
                        </div>
                        <span class="text-sm text-gray-900 dark:text-white font-medium">{{ prompt.rivalry_intensity }}/10</span>
                    </dd>
                </div>

                {% if prompt.rivalry_teams %}
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Rivalry Teams</dt>
                    <dd>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <pre class="text-sm text-gray-900 dark:text-white whitespace-pre-wrap font-mono">{{ prompt.rivalry_teams | tojson(indent=2) }}</pre>
                        </div>
                    </dd>
                </div>
                {% endif %}

                {% if prompt.forbidden_topics %}
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Forbidden Topics</dt>
                    <dd>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <pre class="text-sm text-gray-900 dark:text-white whitespace-pre-wrap font-mono">{{ prompt.forbidden_topics | tojson(indent=2) }}</pre>
                        </div>
                    </dd>
                </div>
                {% endif %}
            </div>
            {% endcall %}
            {% endif %}
        </div>

        <!-- Sidebar (1/3 width) -->
        <div class="space-y-6">
            <!-- Actions -->
            {% call card(title="Actions") %}
            <div class="space-y-2">
                <a href="{{ url_for('ai_prompts.edit_prompt', prompt_id=prompt.id) }}" class="flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green-700 focus:ring-4 focus:ring-ecs-green/50">
                    <i class="ti ti-edit mr-2"></i> Edit Prompt
                </a>

                <form method="POST" action="{{ url_for('ai_prompts.duplicate_prompt', prompt_id=prompt.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-ecs-green bg-white border border-ecs-green rounded-lg hover:bg-ecs-green hover:text-white dark:bg-gray-700 dark:hover:bg-ecs-green transition-colors">
                        <i class="ti ti-copy mr-2"></i> Duplicate
                    </button>
                </form>

                {% if prompt.is_active %}
                <form method="POST" action="{{ url_for('ai_prompts.toggle_prompt', prompt_id=prompt.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-yellow-600 bg-white border border-yellow-500 rounded-lg hover:bg-yellow-50 dark:bg-gray-700 dark:text-yellow-400 dark:hover:bg-gray-600 transition-colors">
                        <i class="ti ti-power mr-2"></i> Deactivate
                    </button>
                </form>
                {% else %}
                <form method="POST" action="{{ url_for('ai_prompts.toggle_prompt', prompt_id=prompt.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-green-600 bg-white border border-green-500 rounded-lg hover:bg-green-50 dark:bg-gray-700 dark:text-green-400 dark:hover:bg-gray-600 transition-colors">
                        <i class="ti ti-power mr-2"></i> Activate
                    </button>
                </form>
                {% endif %}

                <hr class="my-4 border-gray-200 dark:border-gray-700">

                <form method="POST" action="{{ url_for('ai_prompts.delete_prompt', prompt_id=prompt.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="button" class="flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-red-600 bg-white border border-red-500 rounded-lg hover:bg-red-50 dark:bg-gray-700 dark:text-red-400 dark:hover:bg-gray-600 transition-colors"
                            data-action="confirm-delete-prompt">
                        <i class="ti ti-trash mr-2"></i> Delete
                    </button>
                </form>

                <a href="{{ url_for('ai_prompts.list_prompts') }}" class="flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 dark:bg-gray-700 dark:text-white dark:border-gray-600 dark:hover:bg-gray-600">
                    <i class="ti ti-arrow-left mr-2"></i> Back to List
                </a>
            </div>
            {% endcall %}

            <!-- Metadata -->
            {% call card(title="Metadata") %}
            <dl class="space-y-3">
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Version</dt>
                    <dd class="mt-1">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                            v{{ prompt.version }}
                        </span>
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Created</dt>
                    <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ prompt.created_at.strftime('%Y-%m-%d %H:%M:%S') if prompt.created_at else 'Unknown' }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Updated</dt>
                    <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ prompt.updated_at.strftime('%Y-%m-%d %H:%M:%S') if prompt.updated_at else 'Unknown' }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Created By</dt>
                    <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ prompt.created_by or 'Unknown' }}</dd>
                </div>
            </dl>
            {% endcall %}

            <!-- Personality Traits -->
            {% if prompt.personality_traits %}
            {% call card(title="Personality Traits") %}
            <div class="space-y-4">
                {% for trait, value in prompt.personality_traits.items() %}
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-900 dark:text-white">{{ trait.title() }}</span>
                        <span class="text-sm text-gray-500 dark:text-gray-400">{{ value }}/10</span>
                    </div>
                    <div class="w-full h-2 bg-gray-200 rounded-full dark:bg-gray-700">
                        <div class="h-2 rounded-full {{ 'bg-red-500' if value > 7 else 'bg-yellow-500' if value > 4 else 'bg-green-500' }}"
                             style="width: {{ value * 10 }}%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endcall %}
            {% endif %}

            <!-- Test Preview -->
            {% call card(title="Test Preview") %}
            <button type="button" class="flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-cyan-600 bg-white border border-cyan-500 rounded-lg hover:bg-cyan-50 dark:bg-gray-700 dark:text-cyan-400 dark:hover:bg-gray-600 transition-colors"
                    data-action="test-prompt"
                    data-prompt-id="{{ prompt.id }}">
                <i class="ti ti-flask mr-2"></i> Test Prompt
            </button>
            <div id="test-output" class="hidden mt-4">
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <pre id="test-result" class="text-sm text-gray-900 dark:text-white whitespace-pre-wrap font-mono"></pre>
                </div>
            </div>
            {% endcall %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');

    // Delete confirmation
    document.querySelectorAll('[data-action="confirm-delete-prompt"]').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const form = this.closest('form');

            Swal.fire({
                title: 'Delete Prompt?',
                text: 'This action cannot be undone. All associated data will be permanently removed.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, delete it!',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        });
    });

    // Test prompt action
    document.querySelectorAll('[data-action="test-prompt"]').forEach(button => {
        button.addEventListener('click', async function() {
            const promptId = this.dataset.promptId;
            const outputDiv = document.getElementById('test-output');
            const resultDiv = document.getElementById('test-result');

            // Show loading state
            this.disabled = true;
            this.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Testing...';

            try {
                const response = await fetch(`/ai-prompts/${promptId}/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.textContent = data.result;
                    outputDiv.classList.remove('hidden');
                } else {
                    Swal.fire({
                        title: 'Test Failed',
                        text: data.error || 'An error occurred while testing the prompt.',
                        icon: 'error',
                        confirmButtonColor: '#1a472a',
                        background: isDark ? '#1f2937' : '#ffffff',
                        color: isDark ? '#f3f4f6' : '#111827'
                    });
                }
            } catch (error) {
                console.error('Error testing prompt:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to test prompt. Please try again.',
                    icon: 'error',
                    confirmButtonColor: '#1a472a',
                    background: isDark ? '#1f2937' : '#ffffff',
                    color: isDark ? '#f3f4f6' : '#111827'
                });
            } finally {
                // Reset button
                this.disabled = false;
                this.innerHTML = '<i class="ti ti-flask mr-2"></i> Test Prompt';
            }
        });
    });
});
</script>
{% endblock %}
