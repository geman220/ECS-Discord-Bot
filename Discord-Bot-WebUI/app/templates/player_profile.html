{% extends "base.html" %}

{% block title %}{{ player.name }} - Player Profile{% endblock %}

{% block main_content %}

<div class="container-xxl flex-grow-1 container-p-y">

    <!-- Player Header Card -->
    <div class="c-player-header" data-component="player-header">
        <div class="c-player-header__background"></div>
        <div class="c-player-header__content">
            <div class="c-player-header__profile">
                <!-- Profile Picture Column -->
                <div class="c-player-header__avatar-wrapper">
                    <div class="c-player-header__avatar">
                        {% if player.profile_picture_url %}
                        <img src="{{ player.profile_picture_url }}?v={{ player.updated_at.timestamp() if player.updated_at else '0' }}"
                             class="c-player-header__avatar-image"
                             alt="Profile Picture">
                        {% else %}
                        <img src="{{ url_for('static', filename='img/default_player.png') }}"
                             class="c-player-header__avatar-image"
                             alt="Default Profile Picture">
                        {% endif %}
                        {% if player.is_coach %}
                        <span class="c-player-header__badge c-player-header__badge--coach"
                              data-badge
                              data-bs-toggle="tooltip"
                              data-bs-placement="top"
                              title="Coach">
                            <i class="ti ti-trophy"></i>
                        </span>
                        {% endif %}
                        {% if player.is_ref %}
                        <span class="c-player-header__badge c-player-header__badge--ref"
                              data-badge
                              data-bs-toggle="tooltip"
                              data-bs-placement="top"
                              title="Referee">
                            <i class="ti ti-flag"></i>
                        </span>
                        {% endif %}
                        {# Online Status Indicator #}
                        <span class="c-online-status c-online-status--lg c-online-status--avatar {{ 'is-online' if player_is_online else 'is-offline' }}"
                              data-online-status="{{ player.user_id }}"
                              data-bs-toggle="tooltip"
                              data-bs-placement="bottom"
                              title="{{ 'Online' if player_is_online else 'Offline' }}">
                        </span>
                    </div>
                </div>

                <!-- Player Info -->
                <div class="c-player-header__info">
                    <h2 class="c-player-header__name">{{ player.name }}</h2>
                    {# Show team badges if viewer can see team info #}
                    {% if can_view_detailed_profile or is_own_profile or is_admin %}
                    <div class="c-player-header__teams">
                        {% if current_season_teams and current_season_teams|length > 0 %}
                        {% for t in current_season_teams %}
                        <a href="{{ url_for('teams.team_details', team_id=t.id) }}"
                           class="c-badge c-badge--team"
                           data-badge
                           data-team-id="{{ t.id }}">
                            <i class="ti ti-users"></i>{{ t.name }}
                        </a>
                        {% endfor %}
                        {% else %}
                        <span class="c-badge c-badge--no-team" data-badge>
                            <i class="ti ti-users-off"></i>No Team
                        </span>
                        {% endif %}
                    </div>
                    {% elif profile_is_restricted %}
                    <div class="c-player-header__teams">
                        <span class="c-badge c-badge--secondary" data-badge>
                            <i class="ti ti-lock"></i>Profile is Private
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="c-player-header__actions">
                {# In-app Message Button - shown to logged in users viewing other profiles #}
                {% if safe_current_user.is_authenticated and player.user_id and player.user_id != safe_current_user.id %}
                <a href="{{ url_for('messages_pages.messages_inbox', user=player.user_id) }}"
                   class="c-btn c-btn--primary"
                   data-action="message-player"
                   title="Send a message">
                    <i class="ti ti-message-circle"></i>
                    <span class="c-player-header__action-text">Message</span>
                </a>
                {% endif %}

                {% if is_admin or is_player %}
                <button type="button"
                        class="c-btn {% if safe_current_user.is_authenticated and player.user_id and player.user_id != safe_current_user.id %}btn-outline-primary{% else %}btn-primary{% endif %}"
                        data-bs-toggle="modal"
                        data-bs-target="#profileImageModal"
                        data-action="upload-photo">
                    <i class="ti ti-camera"></i>
                    <span class="c-player-header__action-text">Upload Photo</span>
                </button>
                {% endif %}

                {# Multi-channel contact button - shown to admins and coaches #}
                {% if is_admin or 'Pub League Coach' in user_roles %}
                    {% set has_email = user.email and user.email_notifications %}
                    {% set has_sms = player.phone and user.sms_notifications %}
                    {% set has_discord = player.discord_id and user.discord_notifications %}
                    {% if has_email or has_sms or has_discord %}
                    <button type="button"
                            class="c-btn c-btn--outline-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#contactPlayerModal"
                            data-action="contact-player">
                        <i class="ti ti-send"></i>
                        <span class="c-player-header__action-text">Contact</span>
                    </button>
                    {% endif %}
                {% endif %}

                {% if not player.discord_id and safe_current_user.is_authenticated and safe_current_user.id == player.user.id %}
                <a href="{{ url_for('auth.discord_login') }}"
                   class="c-btn c-btn--outline-primary"
                   data-action="link-discord">
                    <i class="fab fa-discord"></i>
                    <span class="c-player-header__action-text">Link to Discord</span>
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">

        <!-- Left Column: Player Info -->
        <div class="col-xl-4 col-lg-5 col-md-5 col-12 mb-4">
            <!-- Contact Info Card -->
            {% if can_view_contact_info or is_own_profile %}
            <div class="c-info-card" data-component="info-card">
                <div class="c-info-card__header">
                    <h5 class="c-info-card__title">Contact Information</h5>
                </div>
                <div class="c-info-card__body">
                    {% if can_view_contact_info %}
                    <div class="c-info-item" data-info-item>
                        <div class="c-info-item__icon c-info-item__icon--primary">
                            <i class="ti ti-mail"></i>
                        </div>
                        <div class="c-info-item__content">
                            <h6 class="c-info-item__label">Email</h6>
                            <span class="c-info-item__value">{{ user.email }}</span>
                        </div>
                    </div>
                    <div class="c-info-item" data-info-item>
                        <div class="c-info-item__icon c-info-item__icon--info">
                            <i class="ti ti-phone"></i>
                        </div>
                        <div class="c-info-item__content">
                            <h6 class="c-info-item__label">Phone</h6>
                            <span class="c-info-item__value">{{ player.phone }}</span>
                        </div>
                    </div>
                    {% endif %}
                    <div class="c-info-item" data-info-item>
                        <div class="c-info-item__icon c-info-item__icon--success">
                            <i class="ti ti-shirt"></i>
                        </div>
                        <div class="c-info-item__content">
                            <h6 class="c-info-item__label">Jersey Size</h6>
                            <span class="c-info-item__value">{{ player.jersey_size }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Profile Verification Card -->
            {% if is_own_profile or 'Pub League Admin' in user_roles or 'Global Admin' in user_roles or 'Pub League Coach' in user_roles %}
            <div class="c-info-card c-info-card--verification" data-component="verification-card">
                <div class="c-info-card__header">
                    <h5 class="c-info-card__title">Profile Status</h5>
                </div>
                <div class="c-info-card__body">
                    {% if player.profile_last_updated %}
                    <div class="c-info-item" data-info-item>
                        <div class="c-info-item__icon c-info-item__icon--success">
                            <i class="ti ti-check"></i>
                        </div>
                        <div class="c-info-item__content">
                            <h6 class="c-info-item__label">Last Updated</h6>
                            <span class="c-info-item__value c-info-item__value--success">{{ format_pacific_time(player.profile_last_updated) }}</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="c-info-item" data-info-item>
                        <div class="c-info-item__icon c-info-item__icon--warning">
                            <i class="ti ti-alert-triangle"></i>
                        </div>
                        <div class="c-info-item__content">
                            <h6 class="c-info-item__label">Profile Status</h6>
                            <span class="c-info-item__value c-info-item__value--warning">
                                {% if is_own_profile %}Please verify your profile information{% else %}Player has not verified their profile{% endif %}
                            </span>
                        </div>
                    </div>
                    {% endif %}

                    {% if is_own_profile %}
                    <div class="c-info-card__actions">
                        <button type="button"
                                class="c-btn c-btn--primary c-btn--block"
                                data-action="verify-profile"
                                data-player-id="{{ player.id }}">
                            <i class="ti ti-check-circle"></i>
                            {% if player.profile_last_updated %}
                                Confirm Profile is Still Accurate
                            {% else %}
                                Verify My Profile Information
                            {% endif %}
                        </button>
                    </div>

                    <small class="c-info-card__help-text">
                        Click to confirm your profile information is current and accurate
                    </small>

                    {% if not player.profile_last_updated %}
                    <div class="c-alert c-alert--danger" data-alert>
                        <i class="ti ti-alert-circle"></i>
                        <small>Your profile needs verification</small>
                    </div>
                    {% elif profile_expired %}
                    <div class="c-alert c-alert--warning" data-alert>
                        <i class="ti ti-alert-triangle"></i>
                        <small>Your profile verification expired - please review and update your information</small>
                    </div>
                    {% endif %}
                    {% else %}
                    <!-- Admin view - read-only -->
                    {% if not player.profile_last_updated %}
                    <div class="c-alert c-alert--danger" data-alert>
                        <i class="ti ti-alert-circle"></i>
                        <small>Player needs to verify their profile information</small>
                    </div>
                    {% elif profile_expired %}
                    <div class="c-alert c-alert--warning" data-alert>
                        <i class="ti ti-alert-triangle"></i>
                        <small>Profile verification expired - last updated {{ player.profile_last_updated.strftime('%B %d, %Y') }}</small>
                    </div>
                    {% else %}
                    <div class="c-alert c-alert--success" data-alert>
                        <i class="ti ti-circle-check"></i>
                        <small>Player profile verification is current</small>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Stats Card -->
            {% if has_permission('view_player_goals_assists') or has_permission('view_player_cards') %}
            <div class="c-stats-card" data-component="stats-card">
                <div class="c-stats-card__header">
                    <h5 class="c-stats-card__title">Player Statistics</h5>
                </div>
                <div class="c-stats-card__body">
                    <div class="c-stats-card__section">
                        <h6 class="c-stats-card__section-title">Season Stats ({{ season.name }})</h6>
                        <div class="c-stats-grid" data-stats-grid>
                            <div class="c-stat" data-stat data-stat-type="goals">
                                <div class="c-stat__icon">‚öΩ</div>
                                <div class="c-stat__value">{{ player.season_goals(season.id) }}</div>
                                <div class="c-stat__label">Goals</div>
                            </div>
                            <div class="c-stat" data-stat data-stat-type="assists">
                                <div class="c-stat__icon">üÖ∞Ô∏è</div>
                                <div class="c-stat__value">{{ player.season_assists(season.id) }}</div>
                                <div class="c-stat__label">Assists</div>
                            </div>
                            <div class="c-stat" data-stat data-stat-type="yellow-cards">
                                <div class="c-stat__icon">üü®</div>
                                <div class="c-stat__value">{{ player.season_yellow_cards(season.id) }}</div>
                                <div class="c-stat__label">Yellow Cards</div>
                            </div>
                            <div class="c-stat" data-stat data-stat-type="red-cards">
                                <div class="c-stat__icon">üü•</div>
                                <div class="c-stat__value">{{ player.season_red_cards(season.id) }}</div>
                                <div class="c-stat__label">Red Cards</div>
                            </div>
                        </div>
                    </div>

                    <hr class="c-stats-card__divider">

                    <div class="c-stats-card__section">
                        <h6 class="c-stats-card__section-title">Career Stats</h6>
                        <div class="c-stats-grid" data-stats-grid>
                            <div class="c-stat" data-stat data-stat-type="goals">
                                <div class="c-stat__icon">‚öΩ</div>
                                <div class="c-stat__value">{{ player.get_career_goals() }}</div>
                                <div class="c-stat__label">Goals</div>
                            </div>
                            <div class="c-stat" data-stat data-stat-type="assists">
                                <div class="c-stat__icon">üÖ∞Ô∏è</div>
                                <div class="c-stat__value">{{ player.get_career_assists() }}</div>
                                <div class="c-stat__label">Assists</div>
                            </div>
                            <div class="c-stat" data-stat data-stat-type="yellow-cards">
                                <div class="c-stat__icon">üü®</div>
                                <div class="c-stat__value">{{ player.get_career_yellow_cards() }}</div>
                                <div class="c-stat__label">Yellow Cards</div>
                            </div>
                            <div class="c-stat" data-stat data-stat-type="red-cards">
                                <div class="c-stat__icon">üü•</div>
                                <div class="c-stat__value">{{ player.get_career_red_cards() }}</div>
                                <div class="c-stat__label">Red Cards</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Team History Card - Only visible if viewer has access -->
            {% if can_view_team_history or is_own_profile or is_admin %}
            <div class="c-info-card" data-component="team-history">
                <div class="c-info-card__header">
                    <h5 class="c-info-card__title">Team History</h5>
                </div>
                <div class="c-info-card__body c-info-card__body--no-padding">
                    <ul class="c-team-history" data-team-history>
                        {% if team_history %}
                        {% for pts in team_history %}
                        <li class="c-team-history__item" data-team-history-item>
                            <div class="c-team-history__info">
                                <div class="c-team-history__team">
                                    <i class="ti ti-users"></i>
                                    <a href="{{ url_for('teams.team_details', team_id=pts.team.id) }}" class="c-team-history__link">
                                        {{ pts.team.name }}
                                    </a>
                                    {% if can_view_draft_history %}
                                        {% set draft_key = pts.season.name + '_league_' + pts.team.league_id|string %}
                                        {% if draft_history and draft_history.get(draft_key) %}
                                            <span class="c-badge c-badge--info"
                                                  data-badge
                                                  title="Draft Pick #{{ draft_history[draft_key] }}">#{{ draft_history[draft_key] }}</span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <small class="c-team-history__season">
                                    <i class="ti ti-calendar"></i>{{ pts.season.name }}
                                </small>
                            </div>
                            <div class="c-team-history__meta">
                                {% if pts.season.is_current %}
                                <span class="c-badge c-badge--success" data-badge>Current</span>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                        {% else %}
                        <li class="c-team-history__item c-team-history__item--empty">
                            <div class="c-empty-state" data-component="empty-state">
                                <div class="c-empty-state__icon">
                                    <i class="ti ti-users-off"></i>
                                </div>
                                <p class="c-empty-state__text">No team history available</p>
                            </div>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            {% endif %}{# end can_view_team_history #}

            <!-- Restricted Profile Message - shown when profile is private and viewer can't see details -->
            {% if profile_is_restricted and not is_own_profile and not is_admin %}
            <div class="c-info-card c-info-card--muted" data-component="restricted-profile">
                <div class="c-info-card__body">
                    <div class="c-empty-state" data-component="empty-state">
                        <div class="c-empty-state__icon c-empty-state__icon--muted">
                            <i class="ti ti-lock"></i>
                        </div>
                        <h5 class="c-empty-state__title">Private Profile</h5>
                        <p class="c-empty-state__text">This player has set their profile to private. Only their name and photo are visible.</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Admin Actions Card -->
            {% if can_edit_stats %}
            <div class="c-info-card c-info-card--admin" data-component="admin-actions">
                <div class="c-info-card__header">
                    <button class="c-collapse-toggle"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#adminActionsCollapse"
                            aria-expanded="false"
                            aria-controls="adminActionsCollapse"
                            data-action="toggle-collapse">
                        <h5 class="c-info-card__title">Admin Actions</h5>
                        <i class="ti ti-chevron-down c-collapse-toggle__icon"></i>
                    </button>
                </div>
                <div class="collapse" id="adminActionsCollapse">
                    <div class="c-info-card__body">
                        <div class="c-admin-actions" data-admin-actions>
                            <div class="c-admin-actions__item">
                                <form method="POST" action="{{ url_for('players.player_profile', player_id=player.id) }}">
                                    {{ form.csrf_token }}
                                    <div class="c-toggle-field" data-toggle-field>
                                        <input class="c-toggle-field__input"
                                               type="checkbox"
                                               name="is_coach"
                                               id="isCoachToggle"
                                               {% if player.is_coach %}checked{% endif %}
                                               data-action="auto-submit">
                                        <label class="c-toggle-field__label" for="isCoachToggle">
                                            <i class="ti ti-trophy"></i> Mark as Coach
                                        </label>
                                    </div>
                                    <input type="hidden" name="update_coach_status" value="1">
                                </form>
                            </div>

                            <div class="c-admin-actions__item">
                                <form method="POST" action="{{ url_for('players.player_profile', player_id=player.id) }}">
                                    {{ form.csrf_token }}
                                    <div class="c-toggle-field" data-toggle-field>
                                        <input class="c-toggle-field__input"
                                               type="checkbox"
                                               name="is_ref"
                                               id="isRefToggle"
                                               {% if player.is_ref %}checked{% endif %}
                                               data-action="auto-submit">
                                        <label class="c-toggle-field__label" for="isRefToggle">
                                            <i class="ti ti-flag"></i> Mark as Referee
                                        </label>
                                    </div>
                                    <input type="hidden" name="update_ref_status" value="1">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column -->
        <div class="col-xl-8 col-lg-7 col-md-7 col-12">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div data-flash-messages>
                {% for category, message in messages %}
                <div class="flash-message" data-category="{{ category }}" data-message="{{ message }}"></div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <!-- Main Tabs Card - Only visible if viewer has access to detailed profile -->
            {% if can_view_detailed_profile or can_edit_profile or can_view_contact_info or is_own_profile or is_admin %}
            <div class="c-profile-tabs" data-component="profile-tabs">
                <div class="c-profile-tabs__header">
                    <ul class="c-tabs" role="tablist" data-tabs>
                        <li class="c-tabs__item" role="presentation">
                            <button type="button"
                                    class="c-tabs__link active"
                                    role="tab"
                                    data-bs-toggle="tab"
                                    data-bs-target="#account-details"
                                    aria-controls="account-details"
                                    aria-selected="true"
                                    data-action="switch-tab">
                                <i class="ti ti-user"></i> Player Details
                            </button>
                        </li>
                        {% if can_edit_stats %}
                        <li class="c-tabs__item" role="presentation">
                            <button type="button"
                                    class="c-tabs__link"
                                    role="tab"
                                    data-bs-toggle="tab"
                                    data-bs-target="#admin-settings"
                                    aria-controls="admin-settings"
                                    aria-selected="false"
                                    data-action="switch-tab">
                                <i class="ti ti-lock"></i> Admin Settings
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>

                <div class="c-profile-tabs__content">
                    <div class="tab-content">
                        <!-- Account Details Tab -->
                        <div class="tab-pane fade show active" id="account-details" role="tabpanel" data-tab-pane>
                            {% if safe_current_user.id == player.user.id or is_admin %}
                            <!-- Editable Form for Profile Owner / Admin -->
                            <div class="c-profile-section" data-profile-section="contact-info">
                                <div class="c-profile-section__header">
                                    <h5 class="c-profile-section__title">Contact Information</h5>
                                    <button type="button"
                                            class="c-btn c-btn--sm c-btn--primary"
                                            data-action="edit-toggle"
                                            data-section="contact-info">
                                        <i class="ti ti-pencil"></i> Edit
                                    </button>
                                </div>
                                <div class="c-profile-section__body">
                                    <form method="POST" enctype="multipart/form-data" class="c-profile-form" id="contact-info-form">
                                        {{ form.hidden_tag() }}
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="c-form-field" data-form-field>
                                                    <label for="profile-name" class="c-form-field__label">{{ form.name.label.text }}</label>
                                                    <div class="c-form-field__view">{{ player.name }}</div>
                                                    <div class="c-form-field__edit">
                                                        {{ form.name(class_="form-control", id="profile-name", required=True) }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="c-form-field" data-form-field>
                                                    <label for="profile-email" class="c-form-field__label">{{ form.email.label.text }}</label>
                                                    <div class="c-form-field__view">{{ user.email }}</div>
                                                    <div class="c-form-field__edit">
                                                        {{ form.email(class_="form-control", id="profile-email", required=True) }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="c-form-field" data-form-field>
                                                    <label for="profile-phone" class="c-form-field__label">{{ form.phone.label.text }}</label>
                                                    <div class="c-form-field__view">{{ player.phone }}</div>
                                                    <div class="c-form-field__edit">
                                                        {{ form.phone(class_="form-control", id="profile-phone", required=True) }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="c-form-field" data-form-field>
                                                    <label for="profile-jersey_size" class="c-form-field__label">{{ form.jersey_size.label.text }}</label>
                                                    <div class="c-form-field__view">{{ player.jersey_size }}</div>
                                                    <div class="c-form-field__edit">
                                                        {{ form.jersey_size(class_="form-select select2", id="profile-jersey_size", required=True) }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12 c-form-field__actions">
                                                <button type="button"
                                                        class="c-btn c-btn--secondary"
                                                        data-action="cancel-edit"
                                                        data-section="contact-info">Cancel</button>
                                                <button type="submit"
                                                        name="update_profile"
                                                        class="c-btn c-btn--primary">
                                                    <i class="ti ti-device-floppy"></i>Save Changes
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div class="c-profile-section" data-profile-section="player-prefs">
                                <div class="c-profile-section__header">
                                    <h5 class="c-profile-section__title">Player Preferences</h5>
                                    <button type="button"
                                            class="c-btn c-btn--sm c-btn--primary"
                                            data-action="edit-toggle"
                                            data-section="player-prefs">
                                        <i class="ti ti-pencil"></i> Edit
                                    </button>
                                </div>
                                <div class="c-profile-section__body">
                                    <form method="POST" enctype="multipart/form-data" class="c-profile-form" id="player-prefs-form">
                                        {{ form.hidden_tag() }}
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="c-form-field" data-form-field>
                                                    <label for="profile-pronouns" class="c-form-field__label">{{ form.pronouns.label.text }}</label>
                                                    <div class="c-form-field__view">{{ player.pronouns }}</div>
                                                    <div class="c-form-field__edit">
                                                        {{ form.pronouns(class_="form-select select2", id="profile-pronouns", required=True) }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="c-form-field" data-form-field>
                                                    <label for="profile-expected_weeks_available" class="c-form-field__label">{{ form.expected_weeks_available.label.text }}</label>
                                                    <div class="c-form-field__view">{{ player.expected_weeks_available }}</div>
                                                    <div class="c-form-field__edit">
                                                        {{ form.expected_weeks_available(class_="form-select select2", id="profile-expected_weeks_available", required=True) }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="c-form-field" data-form-field>
                                                    <label for="profile-favorite_position" class="c-form-field__label">{{ form.favorite_position.label.text }}</label>
                                                    <div class="c-form-field__view">{{ format_position(player.favorite_position) }}</div>
                                                    <div class="c-form-field__edit">
                                                        {{ form.favorite_position(class_="form-select select2", id="profile-favorite_position", required=True) }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="c-form-field" data-form-field>
                                                    <label for="profile-frequency_play_goal" class="c-form-field__label">{{ form.frequency_play_goal.label.text }}</label>
                                                    {% set goal_frequency_map = {
                                                    '0': 'Never',
                                                    '1': 'Only if our normal GK is unavailable and there are no other options',
                                                    '2': 'I will fill in as much as needed, but expect to play in the field',
                                                    '3': 'Half of the time',
                                                    '4': 'Every Game'
                                                    } %}
                                                    <div class="c-form-field__view">{{ goal_frequency_map[player.frequency_play_goal] }}</div>
                                                    <div class="c-form-field__edit">
                                                        {{ form.frequency_play_goal(class_="form-select select2", id="profile-frequency_play_goal", required=True) }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="c-form-field" data-form-field>
                                                    <label for="other_positions" class="c-form-field__label">{{ form.other_positions.label.text }}</label>
                                                    <div class="c-form-field__view">
                                                        {% if player.other_positions %}
                                                            {% set cleaned_positions = player.other_positions.strip('{}').split(',') if player.other_positions is string else player.other_positions %}
                                                            {% if cleaned_positions and cleaned_positions[0] %}
                                                                {% for position in cleaned_positions %}
                                                                    {{ format_position(position.strip() if position is string else position) }}{% if not loop.last %}, {% endif %}
                                                                {% endfor %}
                                                            {% else %}
                                                            <span class="c-form-field__empty">None selected</span>
                                                            {% endif %}
                                                        {% else %}
                                                        <span class="c-form-field__empty">None selected</span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="c-form-field__edit">
                                                        {{ form.other_positions(class_="form-select select2-multiple", id="other_positions", multiple=True) }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="c-form-field" data-form-field>
                                                    <label for="positions_not_to_play" class="c-form-field__label">{{ form.positions_not_to_play.label.text }}</label>
                                                    <div class="c-form-field__view">
                                                        {% if player.positions_not_to_play %}
                                                            {% set cleaned_positions = player.positions_not_to_play.strip('{}').split(',') if player.positions_not_to_play is string else player.positions_not_to_play %}
                                                            {% if cleaned_positions and cleaned_positions[0] %}
                                                                {% for position in cleaned_positions %}
                                                                    {{ format_position(position.strip() if position is string else position) }}{% if not loop.last %}, {% endif %}
                                                                {% endfor %}
                                                            {% else %}
                                                            <span class="c-form-field__empty">None selected</span>
                                                            {% endif %}
                                                        {% else %}
                                                        <span class="c-form-field__empty">None selected</span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="c-form-field__edit">
                                                        {{ form.positions_not_to_play(class_="form-select select2-multiple", id="positions_not_to_play", multiple=True) }}
                                                    </div>
                                                </div>
                                            </div>
                                            {% if is_classic_league_player %}
                                            <div class="col-md-6 c-form-field__edit">
                                                <div class="c-form-field" data-form-field>
                                                    <label for="{{ form.team_swap.id }}" class="c-form-field__label">{{ form.team_swap.label.text }}</label>
                                                    {{ form.team_swap(class_="form-select select2", id=form.team_swap.id) }}
                                                    {% if form.team_swap.errors %}
                                                    <div class="c-form-field__error">
                                                        {% for error in form.team_swap.errors %}
                                                        <span>{{ error }}</span>
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endif %}
                                            <div class="col-12 c-form-field__actions">
                                                <button type="button"
                                                        class="c-btn c-btn--secondary"
                                                        data-action="cancel-edit"
                                                        data-section="player-prefs">Cancel</button>
                                                <button type="submit"
                                                        name="update_profile"
                                                        class="c-btn c-btn--primary">
                                                    <i class="ti ti-device-floppy"></i>Save Changes
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            {% if can_view_admin_notes or is_own_profile %}
                            <div class="c-profile-section" data-profile-section="player-notes">
                                <div class="c-profile-section__header">
                                    <h5 class="c-profile-section__title">Player Notes</h5>
                                    <small class="c-profile-section__subtitle">{% if is_own_profile %}Notes to share with coaches/admins{% else %}Notes from the player{% endif %}</small>
                                    <button type="button"
                                            class="c-btn c-btn--sm c-btn--primary"
                                            data-action="edit-toggle"
                                            data-section="player-notes">
                                        <i class="ti ti-pencil"></i> Edit
                                    </button>
                                </div>
                                <div class="c-profile-section__body">
                                    <form method="POST" enctype="multipart/form-data" id="player-notes-form">
                                        {{ form.hidden_tag() }}
                                        <div class="c-form-field" data-form-field>
                                            <div class="c-form-field__view">
                                                <div class="c-notes-display">
                                                    {{ player.player_notes or 'No notes available' }}
                                                </div>
                                            </div>
                                            <div class="c-form-field__edit">
                                                {{ form.player_notes(class_="form-control", id="profile-player_notes", rows=3) }}
                                                <div class="c-form-field__actions">
                                                    <button type="button"
                                                            class="c-btn c-btn--secondary"
                                                            data-action="cancel-edit"
                                                            data-section="player-notes">Cancel</button>
                                                    <button type="submit"
                                                            name="update_profile"
                                                            class="c-btn c-btn--primary">
                                                        <i class="ti ti-device-floppy"></i>Save Notes
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            {% endif %}

                            {% if can_view_admin_notes %}
                            <div class="c-profile-section c-profile-section--admin" data-profile-section="admin-notes">
                                <div class="c-profile-section__header">
                                    <h5 class="c-profile-section__title">Admin/Coach Notes</h5>
                                    {% if can_edit_admin_notes %}
                                    <button type="button"
                                            class="c-btn c-btn--sm c-btn--primary"
                                            data-action="edit-toggle"
                                            data-section="admin-notes">
                                        <i class="ti ti-pencil"></i> Edit
                                    </button>
                                    {% endif %}
                                </div>
                                <div class="c-profile-section__body">
                                    <form method="POST" enctype="multipart/form-data" id="admin-notes-form">
                                        {{ form.hidden_tag() }}
                                        <div class="c-form-field" data-form-field>
                                            <div class="c-form-field__view">
                                                <div class="c-admin-notes-display">
                                                    <i class="ti ti-lock"></i> <strong>Admin/Coach Only:</strong><br>
                                                    {{ player.notes or 'No admin notes available' }}
                                                </div>
                                            </div>
                                            <div class="c-form-field__edit">
                                                {{ form.notes(class_="form-control", id="notes", rows=3) }}
                                                <small class="c-form-field__help">These notes are only visible to administrators and coaches.</small>
                                                <div class="c-form-field__actions">
                                                    <button type="button"
                                                            class="c-btn c-btn--secondary"
                                                            data-action="cancel-edit"
                                                            data-section="admin-notes">Cancel</button>
                                                    <button type="submit"
                                                            name="update_admin_notes"
                                                            class="c-btn c-btn--primary">
                                                        <i class="ti ti-device-floppy"></i>Save Admin Notes
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            {% endif %}

                            {% else %}
                            <!-- Read-Only View for Coaches -->
                            {% set goal_frequency_map = {
                            '0': 'Never',
                            '1': 'Only if our normal GK is unavailable and there are no other options',
                            '2': 'I will fill in as much as needed, but expect to play in the field',
                            '3': 'Half of the time',
                            '4': 'Every Game'
                            } %}

                            <div class="row">
                                <div class="col-12">
                                    <div class="c-profile-section">
                                        <div class="c-profile-section__header">
                                            <h5 class="c-profile-section__title">Contact Information</h5>
                                        </div>
                                        <div class="c-profile-section__body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="c-info-item" data-info-item>
                                                        <div class="c-info-item__icon c-info-item__icon--primary">
                                                            <i class="ti ti-user"></i>
                                                        </div>
                                                        <div class="c-info-item__content">
                                                            <h6 class="c-info-item__label">Name</h6>
                                                            <span class="c-info-item__value">{{ player.name }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% if can_view_contact_info %}
                                                <div class="col-md-6">
                                                    <div class="c-info-item" data-info-item>
                                                        <div class="c-info-item__icon c-info-item__icon--info">
                                                            <i class="ti ti-mail"></i>
                                                        </div>
                                                        <div class="c-info-item__content">
                                                            <h6 class="c-info-item__label">Email</h6>
                                                            <span class="c-info-item__value">{{ user.email }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="c-info-item" data-info-item>
                                                        <div class="c-info-item__icon c-info-item__icon--success">
                                                            <i class="ti ti-phone"></i>
                                                        </div>
                                                        <div class="c-info-item__content">
                                                            <h6 class="c-info-item__label">Phone</h6>
                                                            <span class="c-info-item__value">{{ player.phone }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                <div class="col-md-6">
                                                    <div class="c-info-item" data-info-item>
                                                        <div class="c-info-item__icon c-info-item__icon--warning">
                                                            <i class="ti ti-shirt"></i>
                                                        </div>
                                                        <div class="c-info-item__content">
                                                            <h6 class="c-info-item__label">Jersey Size</h6>
                                                            <span class="c-info-item__value">{{ player.jersey_size }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="c-profile-section">
                                        <div class="c-profile-section__header">
                                            <h5 class="c-profile-section__title">Player Preferences</h5>
                                        </div>
                                        <div class="c-profile-section__body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="c-info-item" data-info-item>
                                                        <div class="c-info-item__icon c-info-item__icon--primary">
                                                            <i class="ti ti-id"></i>
                                                        </div>
                                                        <div class="c-info-item__content">
                                                            <h6 class="c-info-item__label">Pronouns</h6>
                                                            <span class="c-info-item__value">{{ player.pronouns or 'Not specified' }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="c-info-item" data-info-item>
                                                        <div class="c-info-item__icon c-info-item__icon--info">
                                                            <i class="ti ti-calendar-stats"></i>
                                                        </div>
                                                        <div class="c-info-item__content">
                                                            <h6 class="c-info-item__label">Expected Weeks Available</h6>
                                                            <span class="c-info-item__value">{{ player.expected_weeks_available or 'Not specified' }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="c-info-item" data-info-item>
                                                        <div class="c-info-item__icon c-info-item__icon--success">
                                                            <i class="ti ti-trophy"></i>
                                                        </div>
                                                        <div class="c-info-item__content">
                                                            <h6 class="c-info-item__label">Favorite Position</h6>
                                                            <span class="c-info-item__value">{{ format_position(player.favorite_position) if player.favorite_position else 'Not specified' }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="c-info-item" data-info-item>
                                                        <div class="c-info-item__icon c-info-item__icon--warning">
                                                            <i class="ti ti-ball-football"></i>
                                                        </div>
                                                        <div class="c-info-item__content">
                                                            <h6 class="c-info-item__label">Frequency Play Goal</h6>
                                                            <span class="c-info-item__value">{{ goal_frequency_map.get(player.frequency_play_goal, 'Not specified') if player.frequency_play_goal else 'Not specified' }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="c-info-item" data-info-item>
                                                        <div class="c-info-item__icon c-info-item__icon--primary">
                                                            <i class="ti ti-list-check"></i>
                                                        </div>
                                                        <div class="c-info-item__content">
                                                            <h6 class="c-info-item__label">Other Positions</h6>
                                                            <span class="c-info-item__value">
                                                                {% if player.other_positions %}
                                                                    {% set cleaned_positions = player.other_positions.strip('{}').split(',') if player.other_positions %}
                                                                    {% if cleaned_positions and cleaned_positions[0] %}
                                                                        {% for position in cleaned_positions %}
                                                                            {{ format_position(position.strip()) }}{% if not loop.last %}, {% endif %}
                                                                        {% endfor %}
                                                                    {% else %}
                                                                        <span class="c-form-field__empty">None selected</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                <span class="c-form-field__empty">None selected</span>
                                                                {% endif %}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="c-info-item" data-info-item>
                                                        <div class="c-info-item__icon c-info-item__icon--danger">
                                                            <i class="ti ti-list-x"></i>
                                                        </div>
                                                        <div class="c-info-item__content">
                                                            <h6 class="c-info-item__label">Positions Not to Play</h6>
                                                            <span class="c-info-item__value">
                                                                {% if player.positions_not_to_play %}
                                                                    {% set cleaned_positions = player.positions_not_to_play.strip('{}').split(',') if player.positions_not_to_play %}
                                                                    {% if cleaned_positions and cleaned_positions[0] %}
                                                                        {% for position in cleaned_positions %}
                                                                            {{ format_position(position.strip()) }}{% if not loop.last %}, {% endif %}
                                                                        {% endfor %}
                                                                    {% else %}
                                                                        <span class="c-form-field__empty">None selected</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                <span class="c-form-field__empty">None selected</span>
                                                                {% endif %}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="c-profile-section">
                                        <div class="c-profile-section__header">
                                            <h5 class="c-profile-section__title">Player Notes</h5>
                                        </div>
                                        <div class="c-profile-section__body">
                                            <div class="c-notes-display">
                                                {{ player.player_notes or 'No notes available' }}
                                            </div>
                                        </div>
                                    </div>

                                    {% if can_view_admin_notes %}
                                    <div class="c-profile-section c-profile-section--admin">
                                        <div class="c-profile-section__header">
                                            <h5 class="c-profile-section__title">Admin/Coach Notes</h5>
                                            {% if can_edit_admin_notes %}
                                            <button type="button"
                                                    class="c-btn c-btn--sm c-btn--primary"
                                                    data-action="edit-toggle"
                                                    data-section="admin-notes">
                                                <i class="ti ti-pencil"></i> Edit
                                            </button>
                                            {% endif %}
                                        </div>
                                        <div class="c-profile-section__body">
                                            <form method="POST" enctype="multipart/form-data" id="admin-notes-form">
                                                {{ form.hidden_tag() }}
                                                <div class="c-form-field" data-form-field>
                                                    <div class="c-form-field__view">
                                                        <div class="c-admin-notes-display">
                                                            <i class="ti ti-lock"></i> <strong>Admin/Coach Only:</strong><br>
                                                            <p>{{ player.notes or 'No admin notes available' }}</p>
                                                        </div>
                                                    </div>
                                                    <div class="c-form-field__edit">
                                                        {{ form.notes(class_="form-control", id="notes", rows=3) }}
                                                        <small class="c-form-field__help">These notes are only visible to administrators and coaches.</small>
                                                        <div class="c-form-field__actions">
                                                            <button type="button"
                                                                    class="c-btn c-btn--secondary"
                                                                    data-action="cancel-edit"
                                                                    data-section="admin-notes">Cancel</button>
                                                            <button type="submit"
                                                                    name="update_admin_notes"
                                                                    class="c-btn c-btn--primary">
                                                                <i class="ti ti-device-floppy"></i>Save Admin Notes
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Admin Settings Tab (Admins Only) -->
                        {% if can_edit_stats %}
                        <div class="tab-pane fade" id="admin-settings" role="tabpanel" data-tab-pane>
                            <!-- Match Stats Management Section -->
                            <div class="c-profile-section c-profile-section--stats">
                                <div class="c-profile-section__header">
                                    <div class="c-profile-section__header-group">
                                        <h5 class="c-profile-section__title">Match Stats History</h5>
                                        <div class="c-profile-section__filter">
                                            <label for="matchFilter" class="c-profile-section__filter-label">Filter:</label>
                                            <select class="form-select form-select-sm"
                                                    id="matchFilter"
                                                    data-action="filter-match">
                                                <option value="">All Matches</option>
                                                {% for match in matches %}
                                                {% set player_teams = (season_team_lookup.get(match.schedule.season_id, []) if match.schedule else []) if season_team_lookup is defined else [] %}
                                                {% set is_home = match.home_team_id in player_teams %}
                                                {% set is_away = match.away_team_id in player_teams %}
                                                {% set opponent = match.away_team.name if is_home else match.home_team.name if is_away else (match.home_team.name ~ ' vs ' ~ match.away_team.name) %}
                                                <option value="{{ match.id }}">
                                                    {{ match.date.strftime('%b %d, %Y') }} - vs {{ opponent }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="c-profile-section__body">
                                    <!-- Match Stats Summary Table -->
                                    <div class="c-match-stats-table" id="matchStatsContainer" data-match-stats>
                                        {% if player.events %}
                                        <div class="c-match-stats-table__header">
                                            <div class="c-match-stats-table__col c-match-stats-table__col--date">Date</div>
                                            <div class="c-match-stats-table__col c-match-stats-table__col--team">Team</div>
                                            <div class="c-match-stats-table__col c-match-stats-table__col--event">Event</div>
                                            <div class="c-match-stats-table__col c-match-stats-table__col--actions">Actions</div>
                                        </div>
                                        {% for event in player.events %}
                                        {% set event_label = event.event_type.value.replace('_', ' ').title() if event.event_type else 'Unknown' %}
                                        {% set event_icon = {'goal': 'ball-football', 'assist': 'hand-stop', 'yellow_card': 'rectangle', 'red_card': 'rectangle-filled', 'own_goal': 'mood-sad'}.get(event.event_type.value, 'star') if event.event_type else 'star' %}
                                        {% set event_color = {'goal': 'success', 'assist': 'info', 'yellow_card': 'warning', 'red_card': 'danger', 'own_goal': 'secondary'}.get(event.event_type.value, 'primary') if event.event_type else 'primary' %}
                                        {% set player_teams = (season_team_lookup.get(event.match.schedule.season_id, []) if event.match.schedule else []) if season_team_lookup is defined else [] %}
                                        {% set is_home = event.match.home_team_id in player_teams %}
                                        {% set is_away = event.match.away_team_id in player_teams %}
                                        {% set opponent = event.match.away_team.name if is_home else event.match.home_team.name if is_away else (event.match.home_team.name ~ ' vs ' ~ event.match.away_team.name) %}
                                        <div class="c-match-stats-table__row" data-match-id="{{ event.match.id }}" data-match-stat>
                                            <div class="c-match-stats-table__col c-match-stats-table__col--date">
                                                <span class="c-match-stats-table__date">{{ event.match.date.strftime('%b %d, %Y') }}</span>
                                            </div>
                                            <div class="c-match-stats-table__col c-match-stats-table__col--team">
                                                <span class="c-match-stats-table__team">vs {{ opponent }}</span>
                                            </div>
                                            <div class="c-match-stats-table__col c-match-stats-table__col--event">
                                                <span class="c-badge c-badge--{{ event_color }}" data-badge>
                                                    <i class="ti ti-{{ event_icon }}"></i>
                                                    {{ event_label }}{% if event.minute %} ({{ event.minute }}'){% endif %}
                                                </span>
                                            </div>
                                            <div class="c-match-stats-table__col c-match-stats-table__col--actions">
                                                <button class="c-btn c-btn--icon c-btn--sm c-btn--ghost"
                                                        data-action="edit-match-stat"
                                                        data-stat-id="{{ event.id }}"
                                                        data-bs-toggle="tooltip"
                                                        title="Edit">
                                                    <i class="ti ti-edit"></i>
                                                </button>
                                                <button class="c-btn c-btn--icon c-btn--sm c-btn--ghost c-btn--danger"
                                                        data-action="remove-match-stat"
                                                        data-stat-id="{{ event.id }}"
                                                        data-bs-toggle="tooltip"
                                                        title="Remove">
                                                    <i class="ti ti-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% else %}
                                        <div class="c-empty-state" data-component="empty-state">
                                            <div class="c-empty-state__icon">
                                                <i class="ti ti-soccer-field"></i>
                                            </div>
                                            <p class="c-empty-state__text">No match stats recorded yet</p>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Add New Stat Manually -->
                                    <div class="c-add-stat" data-component="add-stat">
                                        <div class="c-add-stat__header">
                                            <h6 class="c-add-stat__title">Add Stats Manually</h6>
                                        </div>
                                        <div class="c-add-stat__body">
                                            <form method="POST" action="{{ url_for('players.add_stat_manually', player_id=player.id) }}" class="row g-3">
                                                {{ form.csrf_token }}
                                                <div class="col-md-6">
                                                    <label for="match_id" class="form-label">Match</label>
                                                    <select class="form-select select2" name="match_id" id="match_id" required>
                                                        <option value="" selected disabled>Select Match</option>
                                                        {% for match in (participated_matches if participated_matches is defined else matches) %}
                                                        {% set player_teams = (season_team_lookup.get(match.schedule.season_id, []) if match.schedule else []) if season_team_lookup is defined else [] %}
                                                        {% set is_home = match.home_team_id in player_teams %}
                                                        {% set is_away = match.away_team_id in player_teams %}
                                                        {% set opponent = match.away_team.name if is_home else match.home_team.name if is_away else (match.home_team.name ~ ' vs ' ~ match.away_team.name) %}
                                                        <option value="{{ match.id }}">
                                                            {{ match.date.strftime('%b %d, %Y') }} - vs {{ opponent }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="goals" class="form-label">Goals</label>
                                                    <input type="number" class="form-control" name="goals" id="goals"
                                                           min="0" value="0" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="assists" class="form-label">Assists</label>
                                                    <input type="number" class="form-control" name="assists" id="assists"
                                                           min="0" value="0" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="yellow_cards" class="form-label">Yellow Cards</label>
                                                    <input type="number" class="form-control" name="yellow_cards"
                                                           id="yellow_cards" min="0" value="0" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="red_cards" class="form-label">Red Cards</label>
                                                    <input type="number" class="form-control" name="red_cards"
                                                           id="red_cards" min="0" value="0" required>
                                                </div>
                                                <div class="col-12">
                                                    <button type="submit" name="add_stat_manually" class="c-btn c-btn--primary">
                                                        <i class="ti ti-plus"></i> Add Stat
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <!-- For unauthorized viewers -->
            <div class="c-profile-section">
                <div class="c-profile-section__body">
                    <div class="c-alert c-alert--warning" data-alert>
                        <i class="ti ti-lock"></i>
                        <div>You don't have permission to view detailed profile information.</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
{{ super() }}
<!-- Profile Image Modal -->
<div class="modal c-modal fade" data-modal id="profileImageModal" tabindex="-1" aria-labelledby="profileImageModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-xl c-modal__dialog--xl modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <form method="POST" action="{{ url_for('players.upload_profile_picture', player_id=player.id) }}" enctype="multipart/form-data">
                {{ form.csrf_token }}
                <div class="modal-header c-modal__header" data-modal-header>
                    <h5 class="modal-title c-modal__title" id="profileImageModalLabel">Upload and Crop Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-action="close-modal"></button>
                </div>
                <div class="modal-body c-modal__body" data-modal-body>
                    <div class="mb-3">
                        <input type="file" name="image" id="profile-image" accept="image/*" class="form-control d-none">
                        <button type="button"
                                class="c-btn c-btn--secondary"
                                data-action="trigger-file-input"
                                data-target="profile-image">
                            <i class="ti ti-upload"></i> Select Image
                        </button>
                    </div>
                    <div class="img-container d-none">
                        <img id="imagecan" alt="Image to crop" class="img-fluid">
                    </div>
                    <input type="hidden" id="profile-cropped_image_data" name="cropped_image_data">
                </div>
                <div class="modal-footer c-modal__footer" data-modal-footer>
                    <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-action="close-modal">Cancel</button>
                    <button type="button" class="c-btn c-btn--primary" data-action="upload-cropped-image">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Match Stat Modal -->
<div class="modal c-modal fade" data-modal id="editMatchStatModal" tabindex="-1" aria-labelledby="editMatchStatModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="editMatchStatModalLabel">Edit Match Stat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-action="close-modal"></button>
            </div>
            <form id="editMatchStatForm" method="POST">
                <div class="modal-body c-modal__body" data-modal-body>
                    <input type="hidden" id="editStatId" name="stat_id">
                    <div class="mb-3">
                        <label for="editGoalsInput" class="form-label">Goals</label>
                        <input type="number" class="form-control" id="editGoalsInput" name="goals" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAssistsInput" class="form-label">Assists</label>
                        <input type="number" class="form-control" id="editAssistsInput" name="assists" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="editYellowCardsInput" class="form-label">Yellow Cards</label>
                        <input type="number" class="form-control" id="editYellowCardsInput" name="yellow_cards" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRedCardsInput" class="form-label">Red Cards</label>
                        <input type="number" class="form-control" id="editRedCardsInput" name="red_cards" min="0" required>
                    </div>
                </div>
                <div class="modal-footer c-modal__footer" data-modal-footer>
                    <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-action="close-modal">Cancel</button>
                    <button type="submit" class="c-btn c-btn--primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Multi-Channel Contact Modal -->
<div class="modal c-modal fade" id="contactPlayerModal" tabindex="-1" aria-labelledby="contactPlayerModalLabel" aria-hidden="true" data-modal>
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="contactPlayerModalLabel">
                    <i class="ti ti-message"></i>Contact {{ player.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-action="close-modal"></button>
            </div>
            <form action="{{ url_for('players.contact_player', player_id=player.id) }}" method="POST" id="contactPlayerForm">
                {{ form.csrf_token }}
                <div class="modal-body c-modal__body" data-modal-body>
                    <!-- Recipient Info -->
                    <div class="c-contact-recipient" data-contact-recipient>
                        {% if player.profile_picture_url %}
                        <img src="{{ player.profile_picture_url }}?v={{ player.updated_at.timestamp() }}"
                             class="c-contact-recipient__avatar"
                             alt="{{ player.name }}">
                        {% else %}
                        <img src="{{ url_for('static', filename='img/default_player.png') }}"
                             class="c-contact-recipient__avatar"
                             alt="{{ player.name }}">
                        {% endif %}
                        <div class="c-contact-recipient__info">
                            <div class="c-contact-recipient__name">{{ player.name }}</div>
                            <small class="c-contact-recipient__help">Select how to contact this player</small>
                        </div>
                    </div>

                    <!-- Channel Selection -->
                    <div class="c-contact-channels" data-contact-channels>
                        <label class="c-contact-channels__label">Send via (select one or more):</label>

                        {# Email Channel #}
                        {% set email_available = user.email %}
                        {% set email_enabled = user.email_notifications %}
                        <div class="c-contact-channel {% if not email_available or not email_enabled %}c-contact-channel--disabled{% endif %}">
                            <div class="form-check">
                                <input type="checkbox"
                                       class="form-check-input"
                                       name="contact_channels"
                                       value="email"
                                       id="channel_email"
                                       {% if not email_available or not email_enabled %}disabled{% endif %}>
                                <label class="form-check-label c-contact-channel__label" for="channel_email">
                                    <span class="c-contact-channel__icon c-contact-channel__icon--email">
                                        <i class="ti ti-mail"></i>
                                    </span>
                                    <span class="c-contact-channel__content">
                                        <strong>Email</strong>
                                        {% if not email_available %}
                                        <small class="c-contact-channel__status c-contact-channel__status--error">No email on file</small>
                                        {% elif not email_enabled %}
                                        <small class="c-contact-channel__status c-contact-channel__status--warning">Disabled by player</small>
                                        {% else %}
                                        <small class="c-contact-channel__status">{{ user.email }}</small>
                                        {% endif %}
                                    </span>
                                </label>
                            </div>
                        </div>

                        {# SMS Channel #}
                        {% set sms_available = player.phone %}
                        {% set sms_enabled = user.sms_notifications %}
                        <div class="c-contact-channel {% if not sms_available or not sms_enabled %}c-contact-channel--disabled{% endif %}">
                            <div class="form-check">
                                <input type="checkbox"
                                       class="form-check-input"
                                       name="contact_channels"
                                       value="sms"
                                       id="channel_sms"
                                       {% if not sms_available or not sms_enabled %}disabled{% endif %}>
                                <label class="form-check-label c-contact-channel__label" for="channel_sms">
                                    <span class="c-contact-channel__icon c-contact-channel__icon--sms">
                                        <i class="ti ti-message-text"></i>
                                    </span>
                                    <span class="c-contact-channel__content">
                                        <strong>SMS</strong>
                                        {% if not sms_available %}
                                        <small class="c-contact-channel__status c-contact-channel__status--error">No phone on file</small>
                                        {% elif not sms_enabled %}
                                        <small class="c-contact-channel__status c-contact-channel__status--warning">Disabled by player</small>
                                        {% else %}
                                        <small class="c-contact-channel__status">{{ player.phone }}</small>
                                        {% endif %}
                                    </span>
                                </label>
                            </div>
                        </div>

                        {# Discord Channel #}
                        {% set discord_available = player.discord_id %}
                        {% set discord_enabled = user.discord_notifications %}
                        <div class="c-contact-channel {% if not discord_available or not discord_enabled %}c-contact-channel--disabled{% endif %}">
                            <div class="form-check">
                                <input type="checkbox"
                                       class="form-check-input"
                                       name="contact_channels"
                                       value="discord"
                                       id="channel_discord"
                                       {% if not discord_available or not discord_enabled %}disabled{% endif %}>
                                <label class="form-check-label c-contact-channel__label" for="channel_discord">
                                    <span class="c-contact-channel__icon c-contact-channel__icon--discord">
                                        <i class="ti ti-brand-discord"></i>
                                    </span>
                                    <span class="c-contact-channel__content">
                                        <strong>Discord</strong>
                                        {% if not discord_available %}
                                        <small class="c-contact-channel__status c-contact-channel__status--error">Discord not linked</small>
                                        {% elif not discord_enabled %}
                                        <small class="c-contact-channel__status c-contact-channel__status--warning">Disabled by player</small>
                                        {% else %}
                                        <small class="c-contact-channel__status">Via ECS Bot DM</small>
                                        {% endif %}
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Email Subject (shown only when email is selected) -->
                    <div class="mb-3 is-hidden" id="emailSubjectField" data-field="email-subject">
                        <label for="contactSubject" class="form-label">Email Subject</label>
                        <input type="text"
                               class="form-control"
                               name="subject"
                               id="contactSubject"
                               value="Message from ECS"
                               placeholder="Enter email subject">
                    </div>

                    <!-- Message -->
                    <div class="mb-3">
                        <label for="contactMessage" class="form-label">Message</label>
                        <textarea class="form-control"
                                  name="message"
                                  id="contactMessage"
                                  rows="4"
                                  required
                                  placeholder="Enter your message to {{ player.name }}..."></textarea>
                    </div>

                    <!-- Notice -->
                    <div class="c-alert c-alert--info" data-alert>
                        <i class="ti ti-info-circle"></i>
                        Your message will be sent to the selected channel(s). Discord messages are delivered via the ECS Bot.
                    </div>
                </div>
                <div class="modal-footer c-modal__footer" data-modal-footer>
                    <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-action="close-modal">Cancel</button>
                    <button type="submit" class="c-btn c-btn--primary" id="sendContactBtn">
                        <i class="ti ti-send"></i> Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Manual Review Modal -->
{% if player.needs_manual_review and is_admin %}
<div class="modal c-modal fade" data-modal id="manualReviewModal" tabindex="-1" aria-labelledby="manualReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="manualReviewModalLabel">Manual Review Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-action="close-modal"></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body>
                <div class="c-alert c-alert--warning" data-alert>
                    <i class="ti ti-alert-triangle"></i>
                    This profile needs manual review as it was purchased with another order.
                </div>
                <p>Please review the player's name, email, and phone number. You may need to reference the person who placed the original order.</p>
                {% if player.linked_primary_player_id %}
                <div class="text-center mt-3">
                    <a href="{{ url_for('players.player_profile', player_id=player.linked_primary_player_id) }}"
                       class="c-btn c-btn--primary">
                        <i class="ti ti-user-check"></i> View Original Order Profile
                    </a>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-action="close-modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if player.needs_manual_review and is_admin %}
<div data-modal-auto-show="manualReviewModal"></div>
{% endif %}
{% endblock modals %}

{% block custom_js %}
<!-- Include External JavaScript Files -->
<script src="{{ url_for('static', filename='custom_js/cropper.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/match_stats.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/modals.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/admin_actions.js') }}"></script>
<!-- Discord membership check script loaded in base.html -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Profile verification data -->
{% if is_own_profile %}
<div data-profile-verify
     data-verify-url="{{ url_for('players.verify_profile_redirect', player_id=player.id) }}"
     data-verified="{{ 'true' if player.profile_last_updated and not profile_expired else 'false' }}"
     data-csrf-token="{{ csrf_token() }}"></div>
{% endif %}

<!-- Discord link prompt data -->
{% if is_own_profile and not player.discord_id %}
<div data-discord-prompt
     data-discord-url="{{ url_for('auth.discord_login') }}"
     data-delay="3000"></div>
{% endif %}

{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="{{ url_for('static', filename='custom_js/player-profile.js') }}"></script>
{% endif %}
{% endblock %}

{% block custom_css %}
{{ super() }}
<!-- Cropper.css -->
<!-- Player profile styles -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/features/player-profile.css') }}" />
{% endif %}
{% endblock %}
