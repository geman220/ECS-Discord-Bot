{% extends "base.html" %}

{% block title %}{{ player.name }} - Player Profile{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Player Header Card -->
    <div class="card bg-primary mb-4">
        <div class="card-body p-0 position-relative overflow-hidden">
            <div class="player-header-wrapper">
                <div class="row align-items-center w-100">
                    <!-- Profile Picture Column -->
                    <div class="col-auto">
                        <div class="profile-image-container">
                            {% if player.profile_picture_url %}
                            <img src="{{ player.profile_picture_url }}?v={{ player.updated_at.timestamp() }}" class="rounded-circle profile-image" alt="Profile Picture">
                            {% else %}
                            <img src="{{ url_for('static', filename='img/default_player.png') }}" class="rounded-circle profile-image" alt="Default Profile Picture">
                            {% endif %}
                            {% if player.is_coach %}
                            <span class="avatar-status bg-success" data-bs-toggle="tooltip" data-bs-placement="top" title="Coach"></span>
                            {% endif %}
                            {% if player.is_ref %}
                            <span class="avatar-status bg-warning" data-bs-toggle="tooltip" data-bs-placement="top" title="Referee"></span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Player Info Column -->
                    <div class="col">
                        <div class="player-info text-white">
                            <h2 class="display-6 fw-bold mb-2">{{ player.name }}</h2>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                {% if player.teams and player.teams|length > 0 %}
                                {% for t in player.teams %}
                                <div class="badge bg-label-light fs-6">
                                    <a href="{{ url_for('teams.team_details', team_id=t.id) }}" class="text-decoration-none">
                                        <i class="ti ti-users me-1"></i>{{ t.name }}
                                    </a>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="badge bg-label-light fs-6">
                                    <i class="ti ti-users-off me-1"></i>No Team
                                </div>
                                {% endif %}
                                
                                {% if player.discord_id and (has_permission('view_discord_info') or is_own_profile) %}
                                <div class="badge bg-label-success fs-6">
                                    <i class="fab fa-discord me-1"></i>Discord Linked
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                {% if is_admin or is_player %}
                <div class="ms-auto d-flex align-items-center">
                    <div class="d-flex flex-wrap gap-2">
                        {% if is_admin or is_player %}
                        <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#profileImageModal">
                            <i class="ti ti-camera me-1"></i> Upload Photo
                        </button>
                        {% endif %}
                        
                        {% if player.discord_id and (is_admin or 'Pub League Coach' in user_roles) %}
                        <a href="#" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#discordContactModal">
                            <i class="fab fa-discord me-1"></i> Contact
                        </a>
                        {% endif %}
                        
                        {% if not player.discord_id and safe_current_user.is_authenticated and safe_current_user.id == player.user.id %}
                        <a href="{{ url_for('auth.discord_login') }}" class="btn btn-primary">
                            <i class="fab fa-discord me-1"></i> Link to Discord
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Left Column: Player Info -->
        <div class="col-xl-4 col-lg-5 col-md-5 col-12 mb-4">
            <!-- Contact Info Card -->
            {% if can_view_contact_info or is_own_profile %}
            <div class="card mb-4">
                <div class="card-header border-bottom">
                    <h5 class="card-title mb-0">Contact Information</h5>
                </div>
                <div class="card-body">
                    {% if can_view_contact_info %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="avatar avatar-sm me-3 bg-label-primary">
                            <i class="ti ti-mail"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">Email</h6>
                            <span>{{ user.email }}</span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center mb-3">
                        <div class="avatar avatar-sm me-3 bg-label-info">
                            <i class="ti ti-phone"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">Phone</h6>
                            <span>{{ player.phone }}</span>
                        </div>
                    </div>
                    {% endif %}
                    <div class="d-flex align-items-center">
                        <div class="avatar avatar-sm me-3 bg-label-success">
                            <i class="ti ti-shirt"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">Jersey Size</h6>
                            <span>{{ player.jersey_size }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Profile Verification Card -->
            {% if is_own_profile or 'Pub League Admin' in user_roles or 'Global Admin' in user_roles %}
            <div class="card mb-4">
                <div class="card-header border-bottom">
                    <h5 class="card-title mb-0">Profile Status</h5>
                </div>
                <div class="card-body">
                    {% if player.profile_last_updated %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="avatar avatar-sm me-3 bg-label-success">
                            <i class="ti ti-check"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">Last Updated</h6>
                            <span class="text-success">{{ format_pacific_time(player.profile_last_updated) }}</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="avatar avatar-sm me-3 bg-label-warning">
                            <i class="ti ti-alert-triangle"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">Profile Status</h6>
                            <span class="text-warning">{% if is_own_profile %}Please verify your profile information{% else %}Player has not verified their profile{% endif %}</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if is_own_profile %}
                    <div class="text-center">
                        <button type="button" class="btn btn-primary" id="verifyProfileBtn">
                            <i class="ti ti-check-circle me-1"></i>
                            {% if player.profile_last_updated %}
                                Confirm Profile is Still Accurate
                            {% else %}
                                Verify My Profile Information
                            {% endif %}
                        </button>
                    </div>
                    
                    <small class="text-muted d-block text-center mt-2">
                        Click to confirm your profile information is current and accurate
                    </small>
                    {% else %}
                    <!-- Admin view - read-only -->
                    <div class="text-center">
                        <div class="alert alert-info py-2 mb-0">
                            <i class="ti ti-info-circle me-1"></i>
                            <small>{% if player.profile_last_updated %}Player profile verification is current{% else %}Player needs to verify their profile information{% endif %}</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Stats Card -->
            {% if has_permission('view_player_goals_assists') or has_permission('view_player_cards') %}
            <div class="card mb-4">
                <div class="card-header border-bottom">
                    <h5 class="card-title mb-0">Player Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="text-primary fw-bold mb-3">Season Stats ({{ season.name }})</h6>
                            <div class="d-flex flex-wrap gap-3 justify-content-around">
                                <div class="stat-box">
                                    <div class="stat-icon goal">⚽</div>
                                    <div class="stat-value">{{ player.season_goals(season.id) }}</div>
                                    <div class="stat-label">Goals</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-icon assist">🅰️</div>
                                    <div class="stat-value">{{ player.season_assists(season.id) }}</div>
                                    <div class="stat-label">Assists</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-icon yellow-card">🟨</div>
                                    <div class="stat-value">{{ player.season_yellow_cards(season.id) }}</div>
                                    <div class="stat-label">Yellow Cards</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-icon red-card">🟥</div>
                                    <div class="stat-value">{{ player.season_red_cards(season.id) }}</div>
                                    <div class="stat-label">Red Cards</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-secondary fw-bold mb-3">Career Stats</h6>
                            <div class="d-flex flex-wrap gap-3 justify-content-around">
                                <div class="stat-box">
                                    <div class="stat-icon goal">⚽</div>
                                    <div class="stat-value">{{ player.get_career_goals() }}</div>
                                    <div class="stat-label">Goals</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-icon assist">🅰️</div>
                                    <div class="stat-value">{{ player.get_career_assists() }}</div>
                                    <div class="stat-label">Assists</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-icon yellow-card">🟨</div>
                                    <div class="stat-value">{{ player.get_career_yellow_cards() }}</div>
                                    <div class="stat-label">Yellow Cards</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-icon red-card">🟥</div>
                                    <div class="stat-value">{{ player.get_career_red_cards() }}</div>
                                    <div class="stat-label">Red Cards</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Team History Card -->
            <div class="card mb-4">
                <div class="card-header border-bottom">
                    <h5 class="card-title mb-0">Team History</h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% if team_history %}
                        {% for pts in team_history %}
                        <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                            <div>
                                <div class="d-flex align-items-center">
                                    <i class="ti ti-users me-2 text-primary"></i>
                                    <a href="{{ url_for('teams.team_details', team_id=pts.team.id) }}" class="text-decoration-none fw-semibold">
                                        {{ pts.team.name }}
                                    </a>
                                </div>
                                <small class="text-muted d-block"><i class="ti ti-calendar me-1"></i>{{ pts.season.name }}</small>
                            </div>
                            {% if pts.season.is_current %}
                            <span class="badge bg-success">Current</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                        {% else %}
                        <li class="list-group-item text-center py-4">
                            <div class="empty-state">
                                <div class="empty-state-icon mb-3">
                                    <i class="ti ti-users-off"></i>
                                </div>
                                <p class="empty-state-message">No team history available</p>
                            </div>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <!-- Admin Actions Card -->
            {% if can_edit_stats %}
            <div class="card mb-4">
                <div class="card-header border-bottom">
                    <button class="btn btn-link p-0 fw-semibold text-start w-100 text-decoration-none" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#adminActionsCollapse" 
                            aria-expanded="false" 
                            aria-controls="adminActionsCollapse">
                        <div class="d-flex align-items-center">
                            <h5 class="card-title mb-0">Admin Actions</h5>
                            <i class="ti ti-chevron-down ms-auto"></i>
                        </div>
                    </button>
                </div>
                <div class="collapse" id="adminActionsCollapse">
                    <div class="card-body">
                        <div class="list-group">
                            <div class="list-group-item">
                                <form method="POST" action="{{ url_for('players.player_profile', player_id=player.id) }}">
                                    {{ form.csrf_token }}
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="is_coach" id="isCoachToggle"
                                            {% if player.is_coach %}checked{% endif %}
                                            onchange="this.form.submit();">
                                        <label class="form-check-label" for="isCoachToggle">
                                            <i class="ti ti-trophy me-2"></i> Mark as Coach
                                        </label>
                                    </div>
                                    <input type="hidden" name="update_coach_status" value="1">
                                </form>
                            </div>
                            
                            <div class="list-group-item">
                                <form method="POST" action="{{ url_for('players.player_profile', player_id=player.id) }}">
                                    {{ form.csrf_token }}
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="is_ref" id="isRefToggle"
                                            {% if player.is_ref %}checked{% endif %}
                                            onchange="this.form.submit();">
                                        <label class="form-check-label" for="isRefToggle">
                                            <i class="ti ti-flag me-2"></i> Mark as Referee
                                        </label>
                                    </div>
                                    <input type="hidden" name="update_ref_status" value="1">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column -->
        <div class="col-xl-8 col-lg-7 col-md-7 col-12">
            <!-- SweetAlert2 Notifications -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    {% for category, message in messages %}
                    Swal.fire({
                        icon: '{{ category }}',
                        title: '{{ message }}',
                        toast: true,
                        position: 'top-right',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                    });
                    {% endfor %}
                });
            </script>
            {% endif %}
            {% endwith %}

            <!-- Main Tabs Card -->
            {% if can_edit_profile or can_view_contact_info %}
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs ecs-nav ecs-nav-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button type="button" class="nav-link active waves-effect ecs-nav-link ecs-active" role="tab" data-bs-toggle="tab" data-bs-target="#account-details" aria-controls="account-details" aria-selected="true">
                                <i class="ti ti-user me-1"></i> Player Details
                            </button>
                        </li>
                        {% if can_edit_stats %}
                        <li class="nav-item" role="presentation">
                            <button type="button" class="nav-link waves-effect ecs-nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#admin-settings" aria-controls="admin-settings" aria-selected="false">
                                <i class="ti ti-lock me-1"></i> Admin Settings
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Account Details Tab -->
                        <div class="tab-pane fade show active" id="account-details" role="tabpanel">
                            {% if safe_current_user.id == player.user.id or is_admin %}
                            <!-- Editable Form for Profile Owner / Admin -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header border-bottom d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Contact Information</h5>
                                    <button type="button" class="btn btn-sm btn-primary edit-toggle" data-section="contact-info">
                                        <i class="ti ti-pencil"></i> Edit
                                    </button>
                                </div>
                                <div class="card-body">
                                    <form method="POST" enctype="multipart/form-data" class="row g-3" id="contact-info-form">
                                        {{ form.hidden_tag() }}
                                        <!-- Personal Information -->
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="name" class="form-label">{{ form.name.label.text }}</label>
                                                <div class="view-mode">{{ player.name }}</div>
                                                <div class="edit-mode d-none">
                                                    {{ form.name(class_="form-control", id="name", required=True) }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="email" class="form-label">{{ form.email.label.text }}</label>
                                                <div class="view-mode">{{ user.email }}</div>
                                                <div class="edit-mode d-none">
                                                    {{ form.email(class_="form-control", id="email", required=True) }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="phone" class="form-label">{{ form.phone.label.text }}</label>
                                                <div class="view-mode">{{ player.phone }}</div>
                                                <div class="edit-mode d-none">
                                                    {{ form.phone(class_="form-control", id="phone", required=True) }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="jersey_size" class="form-label">{{ form.jersey_size.label.text }}</label>
                                                <div class="view-mode">{{ player.jersey_size }}</div>
                                                <div class="edit-mode d-none">
                                                    {{ form.jersey_size(class_="form-select select2", id="jersey_size", required=True) }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 text-end edit-mode d-none">
                                            <button type="button" class="btn btn-secondary me-2 cancel-edit" data-section="contact-info">Cancel</button>
                                            <button type="submit" name="update_profile" class="btn btn-primary">
                                                <i class="ti ti-device-floppy me-1"></i>Save Changes
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card shadow-sm mb-4">
                                <div class="card-header border-bottom d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Player Preferences</h5>
                                    <button type="button" class="btn btn-sm btn-primary edit-toggle" data-section="player-prefs">
                                        <i class="ti ti-pencil"></i> Edit
                                    </button>
                                </div>
                                <div class="card-body">
                                    <form method="POST" enctype="multipart/form-data" class="row g-3" id="player-prefs-form">
                                        {{ form.hidden_tag() }}
                                        <!-- Additional Details -->
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="pronouns" class="form-label">{{ form.pronouns.label.text }}</label>
                                                <div class="view-mode">{{ player.pronouns }}</div>
                                                <div class="edit-mode d-none">
                                                    {{ form.pronouns(class_="form-select select2", id="pronouns", required=True) }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="expected_weeks_available" class="form-label">{{ form.expected_weeks_available.label.text }}</label>
                                                <div class="view-mode">{{ player.expected_weeks_available }}</div>
                                                <div class="edit-mode d-none">
                                                    {{ form.expected_weeks_available(class_="form-select select2", id="expected_weeks_available", required=True) }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="favorite_position" class="form-label">{{ form.favorite_position.label.text }}</label>
                                                <div class="view-mode">{{ format_position(player.favorite_position) }}</div>
                                                <div class="edit-mode d-none">
                                                    {{ form.favorite_position(class_="form-select select2", id="favorite_position", required=True) }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="frequency_play_goal" class="form-label">{{ form.frequency_play_goal.label.text }}</label>
                                                {% set goal_frequency_map = {
                                                '0': 'Never',
                                                '1': 'Only if our normal GK is unavailable and there are no other options',
                                                '2': 'I will fill in as much as needed, but expect to play in the field',
                                                '3': 'Half of the time',
                                                '4': 'Every Game'
                                                } %}
                                                <div class="view-mode">{{ goal_frequency_map[player.frequency_play_goal] }}</div>
                                                <div class="edit-mode d-none">
                                                    {{ form.frequency_play_goal(class_="form-select select2", id="frequency_play_goal", required=True) }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="other_positions" class="form-label">{{ form.other_positions.label.text }}</label>
                                                <div class="view-mode">
                                                    {% if player.other_positions %}
                                                    {% if player.other_positions is string %}
                                                    {{ format_position(player.other_positions) }}
                                                    {% else %}
                                                    {% for position in player.other_positions %}
                                                        {{ format_position(position) }}{% if not loop.last %}, {% endif %}
                                                    {% endfor %}
                                                    {% endif %}
                                                    {% else %}
                                                    <span class="text-muted">None selected</span>
                                                    {% endif %}
                                                </div>
                                                <div class="edit-mode d-none">
                                                    {{ form.other_positions(class_="form-select select2-multiple", id="other_positions", multiple=True) }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="positions_not_to_play" class="form-label">{{ form.positions_not_to_play.label.text }}</label>
                                                <div class="view-mode">
                                                    {% if player.positions_not_to_play %}
                                                    {% if player.positions_not_to_play is string %}
                                                    {{ format_position(player.positions_not_to_play) }}
                                                    {% else %}
                                                    {% for position in player.positions_not_to_play %}
                                                        {{ format_position(position) }}{% if not loop.last %}, {% endif %}
                                                    {% endfor %}
                                                    {% endif %}
                                                    {% else %}
                                                    <span class="text-muted">None selected</span>
                                                    {% endif %}
                                                </div>
                                                <div class="edit-mode d-none">
                                                    {{ form.positions_not_to_play(class_="form-select select2-multiple", id="positions_not_to_play", multiple=True) }}
                                                </div>
                                            </div>
                                        </div>
                                        {% if is_classic_league_player %}
                                        <div class="col-md-6 edit-mode d-none">
                                            <div class="form-group">
                                                <label for="{{ form.team_swap.id }}" class="form-label">{{ form.team_swap.label.text }}</label>
                                                {{ form.team_swap(class_="form-select select2", id=form.team_swap.id) }}
                                                {% if form.team_swap.errors %}
                                                <div class="text-danger">
                                                    {% for error in form.team_swap.errors %}
                                                    <span>{{ error }}</span>
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        <div class="col-12 text-end edit-mode d-none">
                                            <button type="button" class="btn btn-secondary me-2 cancel-edit" data-section="player-prefs">Cancel</button>
                                            <button type="submit" name="update_profile" class="btn btn-primary">
                                                <i class="ti ti-device-floppy me-1"></i>Save Changes
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            {% if can_view_admin_notes or is_own_profile %}
                            <div class="card shadow-sm mb-4">
                                <div class="card-header border-bottom d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Player Notes</h5>
                                    <small class="text-muted">{% if is_own_profile %}Notes to share with coaches/admins{% else %}Notes from the player{% endif %}</small>
                                    <button type="button" class="btn btn-sm btn-primary edit-toggle" data-section="player-notes">
                                        <i class="ti ti-pencil"></i> Edit
                                    </button>
                                </div>
                                <div class="card-body">
                                    <form method="POST" enctype="multipart/form-data" id="player-notes-form">
                                        {{ form.hidden_tag() }}
                                        <div class="form-group">
                                            <div class="view-mode">
                                                <div class="p-3 rounded">
                                                    {{ player.player_notes or 'No notes available' }}
                                                </div>
                                            </div>
                                            <div class="edit-mode d-none">
                                                {{ form.player_notes(class_="form-control", id="player_notes", rows=3) }}
                                                <div class="text-end mt-3">
                                                    <button type="button" class="btn btn-secondary me-2 cancel-edit" data-section="player-notes">Cancel</button>
                                                    <button type="submit" name="update_profile" class="btn btn-primary">
                                                        <i class="ti ti-device-floppy me-1"></i>Save Notes
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if can_view_admin_notes %}
                            <div class="card shadow-sm">
                                <div class="card-header border-bottom d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Admin/Coach Notes</h5>
                                    {% if can_edit_admin_notes %}
                                    <button type="button" class="btn btn-sm btn-primary edit-toggle" data-section="admin-notes">
                                        <i class="ti ti-pencil"></i> Edit
                                    </button>
                                    {% endif %}
                                </div>
                                <div class="card-body">
                                    <form method="POST" enctype="multipart/form-data" id="admin-notes-form">
                                        {{ form.hidden_tag() }}
                                        <div class="form-group">
                                            <div class="view-mode">
                                                <div class="p-3 rounded bg-label-warning bg-opacity-10">
                                                    <i class="ti ti-lock me-1"></i> <strong>Admin/Coach Only:</strong><br>
                                                    {{ player.notes or 'No admin notes available' }}
                                                </div>
                                            </div>
                                            <div class="edit-mode d-none">
                                                {{ form.notes(class_="form-control", id="notes", rows=3) }}
                                                <div class="form-text">These notes are only visible to administrators and coaches.</div>
                                                <div class="text-end mt-3">
                                                    <button type="button" class="btn btn-secondary me-2 cancel-edit" data-section="admin-notes">Cancel</button>
                                                    <button type="submit" name="update_admin_notes" class="btn btn-primary">
                                                        <i class="ti ti-device-floppy me-1"></i>Save Admin Notes
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Player Notes Display Section (for editable view) -->
                            {% if player.player_notes %}
                            <div class="card shadow-sm mb-4">
                                <div class="card-header border-bottom">
                                    <h5 class="card-title mb-0">Player Notes</h5>
                                    <small class="text-muted">Notes from the player to coaches/admins</small>
                                </div>
                                <div class="card-body">
                                    <div class="bg-label-primary bg-opacity-10 p-3 rounded">
                                        <p class="mb-0">{{ player.player_notes }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% else %}
                            <!-- Read-Only View for Coaches -->
                            {% set goal_frequency_map = {
                            '0': 'Never',
                            '1': 'Only if our normal GK is unavailable and there are no other options',
                            '2': 'I will fill in as much as needed, but expect to play in the field',
                            '3': 'Half of the time',
                            '4': 'Every Game'
                            } %}

                            <div class="row">
                                <div class="col-12">
                                    <div class="card shadow-sm mb-4">
                                        <div class="card-header border-bottom">
                                            <h5 class="card-title mb-0">Contact Information</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-6 d-flex align-items-start">
                                                    <div class="avatar avatar-sm me-3 bg-label-primary">
                                                        <i class="ti ti-user"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-0">Name</h6>
                                                        <span>{{ player.name }}</span>
                                                    </div>
                                                </div>
                                                {% if can_view_contact_info %}
                                                <div class="col-md-6 d-flex align-items-start">
                                                    <div class="avatar avatar-sm me-3 bg-label-info">
                                                        <i class="ti ti-mail"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-0">Email</h6>
                                                        <span>{{ user.email }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 d-flex align-items-start">
                                                    <div class="avatar avatar-sm me-3 bg-label-success">
                                                        <i class="ti ti-phone"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-0">Phone</h6>
                                                        <span>{{ player.phone }}</span>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                <div class="col-md-6 d-flex align-items-start">
                                                    <div class="avatar avatar-sm me-3 bg-label-warning">
                                                        <i class="ti ti-shirt"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-0">Jersey Size</h6>
                                                        <span>{{ player.jersey_size }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card shadow-sm mb-4">
                                        <div class="card-header border-bottom">
                                            <h5 class="card-title mb-0">Player Preferences</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-start">
                                                        <div class="avatar avatar-sm me-3 bg-label-primary">
                                                            <i class="ti ti-id"></i>
                                                        </div>
                                                        <div>
                                                            <h6 class="mb-0">Pronouns</h6>
                                                            <span>{{ player.pronouns or 'Not specified' }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-start">
                                                        <div class="avatar avatar-sm me-3 bg-label-info">
                                                            <i class="ti ti-calendar-stats"></i>
                                                        </div>
                                                        <div>
                                                            <h6 class="mb-0">Expected Weeks Available</h6>
                                                            <span>{{ player.expected_weeks_available or 'Not specified' }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-start">
                                                        <div class="avatar avatar-sm me-3 bg-label-success">
                                                            <i class="ti ti-trophy"></i>
                                                        </div>
                                                        <div>
                                                            <h6 class="mb-0">Favorite Position</h6>
                                                            <span>{{ format_position(player.favorite_position) if player.favorite_position else 'Not specified' }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-start">
                                                        <div class="avatar avatar-sm me-3 bg-label-warning">
                                                            <i class="ti ti-ball-football"></i>
                                                        </div>
                                                        <div>
                                                            <h6 class="mb-0">Frequency Play Goal</h6>
                                                            <span>{{ goal_frequency_map.get(player.frequency_play_goal, 'Not specified') if player.frequency_play_goal else 'Not specified' }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-start">
                                                        <div class="avatar avatar-sm me-3 bg-label-primary">
                                                            <i class="ti ti-list-check"></i>
                                                        </div>
                                                        <div>
                                                            <h6 class="mb-0">Other Positions</h6>
                                                            <span>
                                                                {% if player.other_positions %}
                                                                    {% set cleaned_positions = player.other_positions.strip('{}').split(',') if player.other_positions %}
                                                                    {% if cleaned_positions and cleaned_positions[0] %}
                                                                        {% for position in cleaned_positions %}
                                                                            {{ format_position(position.strip()) }}{% if not loop.last %}, {% endif %}
                                                                        {% endfor %}
                                                                    {% else %}
                                                                        <span class="text-muted">None selected</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                <span class="text-muted">None selected</span>
                                                                {% endif %}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-start">
                                                        <div class="avatar avatar-sm me-3 bg-label-danger">
                                                            <i class="ti ti-list-x"></i>
                                                        </div>
                                                        <div>
                                                            <h6 class="mb-0">Positions Not to Play</h6>
                                                            <span>
                                                                {% if player.positions_not_to_play %}
                                                                    {% set cleaned_positions = player.positions_not_to_play.strip('{}').split(',') if player.positions_not_to_play %}
                                                                    {% if cleaned_positions and cleaned_positions[0] %}
                                                                        {% for position in cleaned_positions %}
                                                                            {{ format_position(position.strip()) }}{% if not loop.last %}, {% endif %}
                                                                        {% endfor %}
                                                                    {% else %}
                                                                        <span class="text-muted">None selected</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                <span class="text-muted">None selected</span>
                                                                {% endif %}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card shadow-sm mb-4">
                                        <div class="card-header border-bottom">
                                            <h5 class="card-title mb-0">Player Notes</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="bg-label-primary bg-opacity-10 p-3 rounded">
                                                <p class="mb-0">{{ player.player_notes or 'No notes available' }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% if can_view_admin_notes %}
                                    <div class="card shadow-sm">
                                        <div class="card-header border-bottom">
                                            <h5 class="card-title mb-0">Admin/Coach Notes</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="bg-label-warning bg-opacity-10 p-3 rounded">
                                                <i class="ti ti-lock me-1"></i> <strong>Admin/Coach Only:</strong><br>
                                                <p class="mb-0 mt-2">{{ player.notes or 'No admin notes available' }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Admin Settings Tab (Admins Only) -->
                        {% if can_edit_stats %}
                        <div class="tab-pane fade" id="admin-settings" role="tabpanel">
                            <!-- Match Stats Management Section -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header border-bottom">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="card-title mb-0">Match Stats History</h5>
                                        <div class="d-flex align-items-center">
                                            <label for="matchFilter" class="form-label me-2 mb-0">Filter:</label>
                                            <select class="form-select form-select-sm" id="matchFilter" style="width: 250px;">
                                                <option value="">All Matches</option>
                                                {% for match in matches %}
                                                <option value="{{ match.id }}">
                                                    {{ match.date.strftime('%B %d, %Y') }} - {{ match.opponent_name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- List of Match Stats -->
                                    <div id="matchStatsContainer" class="mb-4">
                                        {% for event in player.events %}
                                        <div class="card p-3 mb-3 shadow-sm" data-match-id="{{ event.match.id }}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <h6 class="mb-1">
                                                        <i class="ti ti-calendar-event me-1"></i>
                                                        {{ event.match.date.strftime('%B %d, %Y') }}
                                                    </h6>
                                                    <p class="mb-1">
                                                        <i class="ti ti-flag me-1"></i>
                                                        Opponent:
                                                        {{ event.match.away_team.name if player.team_id == event.match.home_team_id else event.match.home_team.name }}
                                                    </p>
                                                    <div class="badge bg-primary mb-1">
                                                        {{ event.event_type }} ({{ event.minute }}')
                                                    </div>
                                                </div>

                                                <!-- Admin Controls -->
                                                <div class="d-flex">
                                                    <button class="btn btn-sm btn-primary me-2 edit-match-stat-btn"
                                                            data-stat-id="{{ event.id }}">
                                                        <i class="ti ti-edit me-1"></i> Edit
                                                    </button>
                                                    <button class="btn btn-sm btn-danger remove-match-stat-btn"
                                                            data-stat-id="{{ event.id }}">
                                                        <i class="ti ti-trash me-1"></i> Remove
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="text-center py-5">
                                            <div class="empty-state">
                                                <div class="empty-state-icon mb-3">
                                                    <i class="ti ti-soccer-field"></i>
                                                </div>
                                                <p class="empty-state-message">No match stats recorded yet</p>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>

                                    <!-- Add New Stat Manually -->
                                    <div class="card shadow-sm">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">Add Stats Manually</h6>
                                        </div>
                                        <div class="card-body">
                                            <form method="POST" action="{{ url_for('players.add_stat_manually', player_id=player.id) }}" class="row g-3">
                                                {{ form.csrf_token }}
                                                <div class="col-md-6">
                                                    <label for="match_id" class="form-label">Match</label>
                                                    <select class="form-select" name="match_id" id="match_id" required>
                                                        <option value="" selected disabled>Select Match</option>
                                                        {% for match in matches %}
                                                        <option value="{{ match.id }}">
                                                            {{ match.date.strftime('%B %d, %Y') }} - {{ match.opponent_name }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="goals" class="form-label">Goals</label>
                                                    <input type="number" class="form-control" name="goals" id="goals"
                                                           min="0" value="0" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="assists" class="form-label">Assists</label>
                                                    <input type="number" class="form-control" name="assists" id="assists"
                                                           min="0" value="0" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="yellow_cards" class="form-label">Yellow Cards</label>
                                                    <input type="number" class="form-control" name="yellow_cards"
                                                           id="yellow_cards" min="0" value="0" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="red_cards" class="form-label">Red Cards</label>
                                                    <input type="number" class="form-control" name="red_cards"
                                                           id="red_cards" min="0" value="0" required>
                                                </div>
                                                <div class="col-12 text-end">
                                                    <button type="submit" name="add_stat_manually" class="btn btn-primary">
                                                        <i class="ti ti-plus me-1"></i> Add Stat
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <!-- For unauthorized viewers -->
            <div class="card">
                <div class="card-body">
                    <div class="alert alert-warning d-flex align-items-center">
                        <i class="ti ti-lock me-2"></i>
                        <div>You don't have permission to view detailed profile information.</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Profile Image Modal -->
<div class="modal fade" id="profileImageModal" tabindex="-1" aria-labelledby="profileImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('players.upload_profile_picture', player_id=player.id) }}" enctype="multipart/form-data">
                {{ form.csrf_token }}
                <div class="modal-header">
                    <h5 class="modal-title" id="profileImageModalLabel">Upload and Crop Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="file" name="image" id="image" accept="image/*" class="form-control d-none">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('image').click();">
                            <i class="ti ti-upload me-1"></i> Select Image
                        </button>
                    </div>
                    <div class="img-container d-none">
                        <img id="imagecan" style="max-width: 100%; height: auto;">
                    </div>
                    <input type="hidden" id="cropped_image_data" name="cropped_image_data">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="onClickUpload()">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Match Stat Modal -->
<div class="modal fade" id="editMatchStatModal" tabindex="-1" aria-labelledby="editMatchStatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMatchStatModalLabel">Edit Match Stat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editMatchStatForm" method="POST">
                <div class="modal-body">
                    <input type="hidden" id="editStatId" name="stat_id">
                    <div class="mb-3">
                        <label for="editGoalsInput" class="form-label">Goals</label>
                        <input type="number" class="form-control" id="editGoalsInput" name="goals" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAssistsInput" class="form-label">Assists</label>
                        <input type="number" class="form-control" id="editAssistsInput" name="assists" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="editYellowCardsInput" class="form-label">Yellow Cards</label>
                        <input type="number" class="form-control" id="editYellowCardsInput" name="yellow_cards" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRedCardsInput" class="form-label">Red Cards</label>
                        <input type="number" class="form-control" id="editRedCardsInput" name="red_cards" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Discord Contact Modal -->
<div class="modal fade" id="discordContactModal" tabindex="-1" aria-labelledby="discordContactModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow discord-modal">
            <div class="modal-header bg-discord text-white border-0">
                <div class="d-flex align-items-center">
                    <i class="fab fa-discord fs-4 me-2"></i>
                    <h5 class="modal-title mb-0" id="discordContactModalLabel">
                        Discord Message
                    </h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('players.contact_player_discord', player_id=player.id) }}" method="POST">
                {{ form.csrf_token }}
                <div class="modal-body p-0">
                    <!-- Discord Interface Header -->
                    <div class="discord-header p-3 border-bottom">
                        <div class="d-flex align-items-center">
                            {% if player.profile_picture_url %}
                            <img src="{{ player.profile_picture_url }}?v={{ player.updated_at.timestamp() }}" 
                                 class="rounded-circle me-3" width="40" height="40" alt="Profile picture">
                            {% else %}
                            <img src="{{ url_for('static', filename='img/default_player.png') }}" 
                                 class="rounded-circle me-3" width="40" height="40" alt="Default profile picture">
                            {% endif %}
                            <div>
                                <div class="fw-bold mb-0">{{ player.name }}</div>
                                <div class="text-discord-green small">
                                    <i class="fas fa-circle me-1" style="font-size: 8px;"></i>Online
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message Area -->
                    <div class="discord-messages p-3">
                        <!-- Bot Message -->
                        <div class="discord-message mb-3">
                            <div class="d-flex">
                                <img src="{{ url_for('static', filename='img/discord_logo.svg') }}" 
                                     class="rounded-circle me-2" width="30" height="30" alt="Bot">
                                <div class="discord-message-content">
                                    <div class="d-flex align-items-center">
                                        <span class="fw-bold text-discord-bot me-2">ECS Bot</span>
                                        <span class="discord-bot-badge">BOT</span>
                                        <small class="text-muted ms-2">Today</small>
                                    </div>
                                    <p class="mb-0">
                                        I'll deliver your message to {{ player.name }}.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Input -->
                        <div class="discord-input-container">
                            <div class="discord-input-wrapper">
                                <textarea class="form-control discord-textarea" 
                                         id="discord_message" 
                                         name="discord_message" 
                                         rows="3" 
                                         placeholder="Message {{ player.name }}"
                                         required></textarea>
                                
                                <div class="discord-input-actions">
                                    <button type="button" class="btn discord-emoji-btn" title="Add emoji">
                                        <i class="far fa-smile"></i>
                                    </button>
                                    <button type="button" class="btn discord-upload-btn" title="Upload file">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="discord-notice mt-2 text-muted small">
                                <i class="ti ti-info-circle me-1"></i> Messages are sent via the Discord bot. The recipient will see them as coming from "ECS Bot" with your name included.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-discord">
                        <i class="fab fa-discord me-1"></i> Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Manual Review Modal -->
{% if player.needs_manual_review and is_admin %}
<div class="modal fade" id="manualReviewModal" tabindex="-1" aria-labelledby="manualReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manualReviewModalLabel">Manual Review Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3">
                    <i class="ti ti-alert-triangle me-2"></i>
                    This profile needs manual review as it was purchased with another order.
                </div>
                <p>Please review the player's name, email, and phone number. You may need to reference the person who placed the original order.</p>
                {% if player.linked_primary_player_id %}
                <div class="text-center mt-3">
                    <a href="{{ url_for('players.player_profile', player_id=player.linked_primary_player_id) }}"
                       class="btn btn-primary">
                        <i class="ti ti-user-check me-1"></i> View Original Order Profile
                    </a>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var manualReviewModal = new bootstrap.Modal(document.getElementById('manualReviewModal'));
        manualReviewModal.show();
    });
</script>
{% endif %}
{% endblock %}

{% block custom_js %}
<!-- Include External JavaScript Files -->
<script src="{{ url_for('static', filename='custom_js/cropper.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/match_stats.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/modals.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/admin_actions.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                delay: { show: 500, hide: 100 }
            });
        });
        
        // Match filter functionality
        const matchFilter = document.getElementById('matchFilter');
        if (matchFilter) {
            matchFilter.addEventListener('change', function() {
                const matchId = this.value;
                const statCards = document.querySelectorAll('#matchStatsContainer [data-match-id]');
                
                statCards.forEach(card => {
                    if (!matchId || card.getAttribute('data-match-id') === matchId) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }
        
        // Edit mode toggle functionality
        const editButtons = document.querySelectorAll('.edit-toggle');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const section = this.getAttribute('data-section');
                const viewModes = document.querySelectorAll(`#${section}-form .view-mode`);
                const editModes = document.querySelectorAll(`#${section}-form .edit-mode`);
                
                viewModes.forEach(el => el.classList.add('d-none'));
                editModes.forEach(el => el.classList.remove('d-none'));
                this.classList.add('d-none');
            });
        });
        
        // Cancel edit functionality
        const cancelButtons = document.querySelectorAll('.cancel-edit');
        cancelButtons.forEach(button => {
            button.addEventListener('click', function() {
                const section = this.getAttribute('data-section');
                const viewModes = document.querySelectorAll(`#${section}-form .view-mode`);
                const editModes = document.querySelectorAll(`#${section}-form .edit-mode`);
                const editToggle = document.querySelector(`.edit-toggle[data-section="${section}"]`);
                
                viewModes.forEach(el => el.classList.remove('d-none'));
                editModes.forEach(el => el.classList.add('d-none'));
                editToggle.classList.remove('d-none');
            });
        });
        
        // Ensure proper accordion behavior for admin actions
        const adminActionsToggle = document.querySelector('.card-header button[data-bs-toggle="collapse"]');
        if (adminActionsToggle) {
            adminActionsToggle.addEventListener('click', function() {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                this.setAttribute('aria-expanded', !isExpanded);
                
                const iconElement = this.querySelector('i');
                if (iconElement) {
                    if (isExpanded) {
                        iconElement.classList.remove('ti-chevron-up');
                        iconElement.classList.add('ti-chevron-down');
                    } else {
                        iconElement.classList.remove('ti-chevron-down');
                        iconElement.classList.add('ti-chevron-up');
                    }
                }
            });
        }
        
        // Profile verification functionality
        const verifyProfileBtn = document.getElementById('verifyProfileBtn');
        if (verifyProfileBtn) {
            verifyProfileBtn.addEventListener('click', function() {
                Swal.fire({
                    title: 'Verify Profile Information',
                    html: `<div class="text-start">
                           <p class="mb-2">Please confirm that your profile information is current and accurate.</p>
                           <p class="mb-2">This includes:</p>
                           <ul class="mb-3">
                               <li>Contact information (email, phone)</li>
                               <li>Player details (jersey size, positions, availability)</li>
                               <li>Personal information (pronouns, notes)</li>
                           </ul>
                           <p class="fw-bold mb-0">By confirming, you verify that all information is up to date.</p>
                           </div>`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, my profile is accurate',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#28a745',
                    showLoaderOnConfirm: true,
                    preConfirm: () => {
                        return fetch("{{ url_for('players.verify_profile', player_id=player.id) }}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': "{{ csrf_token() }}"
                            }
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response;
                        })
                        .catch(error => {
                            Swal.showValidationMessage(`Request failed: ${error}`);
                        });
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Reload the page to show updated timestamp
                        window.location.reload();
                    }
                });
            });
        }
    });
</script>
{% endblock %}

{% block custom_css %}
<!-- Cropper.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />

<style>
    /* Player Header Styling */
    .player-header-wrapper {
        position: relative;
        min-height: 140px;
        padding: 1.5rem !important;
    }
    
    .profile-image-container {
        position: relative;
        width: 130px;
        height: 130px;
        margin-right: 1.5rem;
    }
    
    .profile-image {
        width: 130px;
        height: 130px;
        object-fit: cover;
        border: 3px solid rgba(255,255,255,0.3);
    }
    
    .avatar-status {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid var(--bs-body-bg);
    }
    
    /* Stats Box Styling */
    .stat-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        min-width: 80px;
        flex: 1;
        text-align: center;
        border-radius: 8px;
        transition: all 0.2s ease;
        background-color: rgba(var(--bs-primary-rgb), 0.05);
        border: 1px solid rgba(var(--bs-primary-rgb), 0.1);
        margin: 0 5px;
    }
    
    .stat-box:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .stat-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: var(--bs-gray-600);
    }
    
    /* Team History Styling */
    .team-history .list-group-item:hover {
        background-color: var(--bs-body-bg);
    }
    
    /* Empty State Styling */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: var(--bs-secondary);
    }
    
    .empty-state-icon {
        font-size: 2.5rem;
        color: var(--bs-secondary);
    }
    
    .empty-state-message {
        font-size: 0.875rem;
        color: var(--bs-secondary);
    }
    
    /* Image Container Styling */
    .img-container {
        width: 100%;
        max-height: 600px;
        overflow: hidden;
    }
    
    .img-container img {
        display: block;
        max-width: 100%;
        height: auto;
    }
    
    /* Form Editing Control */
    .form-group {
        margin-bottom: 1rem;
    }
    
    .view-mode, .edit-mode {
        padding: 0.375rem 0;
    }
    
    /* Collapsible Section Styling */
    .card-header .btn-link {
        color: inherit;
    }
    
    .card-header .btn-link i {
        transition: transform 0.2s ease;
    }
    
    .card-header .btn-link[aria-expanded="true"] i {
        transform: rotate(180deg);
    }
    
    /* Tab Navigation Styling */
    .ecs-nav-tabs {
        border-bottom: none;
        margin-bottom: -1px;
    }
    
    .ecs-nav-link {
        border: none;
        position: relative;
        padding: 0.75rem 1.25rem;
        color: var(--bs-gray-600);
    }
    
    .ecs-nav-link.active, 
    .ecs-nav-link:hover {
        background-color: transparent;
        border: none;
        color: var(--bs-primary);
    }
    
    .ecs-nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: var(--bs-primary);
    }
    
    /* Modal Body Centering for standard modals */
    .modal-body:not(.p-0) {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    /* Discord Modal Styling */
    .bg-discord {
        background-color: #5865F2 !important;
    }
    
    .text-discord-green {
        color: #3ba55c !important;
    }
    
    .text-discord-bot {
        color: #5865F2 !important;
    }
    
    .btn-discord {
        background-color: #5865F2 !important;
        color: white !important;
    }
    
    .btn-discord:hover {
        background-color: #4752c4 !important;
    }
    
    .discord-modal {
        background-color: #36393f;
        color: #dcddde;
    }
    
    .discord-header {
        background-color: #2f3136;
        color: #ffffff;
    }
    
    .discord-messages {
        background-color: #36393f;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .discord-message {
        padding: 8px;
        border-radius: 4px;
    }
    
    .discord-message:hover {
        background-color: #32353b;
    }
    
    .discord-message-content {
        flex-grow: 1;
    }
    
    .discord-bot-badge {
        background-color: #5865F2;
        color: white;
        font-size: 0.6rem;
        padding: 0.1rem 0.35rem;
        border-radius: 3px;
        font-weight: bold;
    }
    
    .discord-input-container {
        background-color: #36393f;
        padding: 10px 0;
    }
    
    .discord-input-wrapper {
        position: relative;
        border-radius: 8px;
        background-color: #40444b;
        border: 1px solid #202225;
        overflow: hidden;
    }
    
    .discord-textarea {
        background-color: transparent !important;
        border: none !important;
        color: #dcddde !important;
        resize: none !important;
        padding: 12px !important;
        box-shadow: none !important;
    }
    
    .discord-textarea::placeholder {
        color: #72767d !important;
    }
    
    .discord-input-actions {
        position: absolute;
        bottom: 8px;
        right: 8px;
        display: flex;
        gap: 5px;
    }
    
    .discord-emoji-btn,
    .discord-upload-btn {
        color: #b9bbbe;
        background: none;
        border: none;
        padding: 5px;
        font-size: 18px;
        transition: color 0.2s ease;
    }
    
    .discord-emoji-btn:hover,
    .discord-upload-btn:hover {
        color: #dcddde;
    }
    
    .discord-notice {
        color: #72767d;
    }
    
    /* Responsive Styles */
    @media (max-width: 768px) {
        .player-header-wrapper {
            padding: 1rem !important;
        }
        
        .player-info {
            margin-top: 0.5rem;
        }
        
        .profile-image-container {
            width: 100px;
            height: 100px;
            margin-right: 1rem;
        }
        
        .profile-image {
            width: 100px;
            height: 100px;
        }
        
        .stat-box {
            min-width: 60px;
            padding: 0.75rem 0.5rem;
        }
        
        .stat-icon {
            font-size: 1.25rem;
        }
        
        .stat-value {
            font-size: 1.25rem;
        }
    }
</style>
{% endblock %}