{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block custom_css %}
{{ super() }}
<!-- Draft System Styles (consolidated) -->
<!-- NOTE: draft-system.css consolidated into features/draft.css -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/features/draft.css') }}?v={{ range(1, 1000000) | random }}">
<!-- NOTE: Inline styles moved to /app/static/css/features/draft.css -->
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Connection Status -->
    <div id="connectionStatus" class="position-fixed top-0 end-0 m-3 draft-connection-status">
        <div class="alert alert-danger alert-dismissible" role="alert" data-alert>
            <i class="ti ti-wifi-off me-1"></i>
            Connecting...
        </div>
    </div>

    <!-- Draft Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="text-primary mb-1">{{ title }}</h2>
                            <p class="text-muted mb-0">Draft and manage players for your teams</p>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="text-center">
                                <div class="h4 text-primary mb-0">{{ analytics.total_teams }}</div>
                                <small class="text-muted">Teams</small>
                            </div>
                            <div class="text-center">
                                <div class="h4 text-success mb-0">{{ analytics.total_players_drafted }}</div>
                                <small class="text-muted">Drafted</small>
                            </div>
                            <div class="text-center">
                                <div class="h4 text-info mb-0" id="availableCount">{{ available_players|length }}</div>
                                <small class="text-muted">Available</small>
                            </div>
                            <div class="ms-auto">
                                <a href="{{ url_for('draft_enhanced.draft_league_pitch_view', league_name=league_name) }}"
                                   class="c-btn c-btn--outline-primary">
                                    <i class="ti ti-layout-dashboard me-1"></i>Pitch View
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__body">
                    <div class="row align-items-end g-3">
                        <div class="col-lg-4 col-md-6">
                            <label class="form-label">Search Players</label>
                            <div class="input-group" data-input-group>
                                <span class="input-group-text"><i class="ti ti-search"></i></span>
                                <input type="text" id="playerSearch" class="form-control" placeholder="Type player name..." autocomplete="off" data-form-control data-on-input="search-players">
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-3 col-sm-6">
                            <label class="form-label">Position</label>
                            <select id="positionFilter" class="form-select" data-form-select data-on-change="filter-position">
                                <option value="">All Positions</option>
                                <option value="goalkeeper">Goalkeeper</option>
                                <option value="defender">Defender</option>
                                <option value="midfielder">Midfielder</option>
                                <option value="forward">Forward</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-md-3 col-sm-6">
                            <label class="form-label">Sort By</label>
                            <select id="sortBy" class="form-select" data-form-select data-on-change="sort-players">
                                <option value="name">Name</option>
                                <option value="experience">Experience</option>
                                <option value="attendance">Attendance</option>
                                <option value="goals">Goals</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Available Players -->
        <div class="col-lg-8">
            <div class="c-card">
                <div class="c-card__header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="ti ti-users me-2"></i>
                        Available Players (<span id="available-players-count">{{ available_players|length }}</span>)
                    </h5>
                </div>
                <!-- FIFA-Style Player Cards Grid -->
                <div id="available-players" class="row g-3 draft-available-container js-draft-drop-zone"
                     data-drop-target="available">
                    {% for player in available_players %}
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
                        <div id="player-{{ player.id }}" class="c-card player-card draft-player-card border-0 shadow-sm h-100 js-draggable-player"
                             data-player-id="{{ player.id }}"
                             data-player-name="{{ player.name|lower }}"
                             data-position="{{ (player.favorite_position or '')|lower }}"
                             data-experience="{{ player.league_experience_seasons }}"
                             data-attendance="{{ player.attendance_estimate }}"
                             data-goals="{{ player.career_goals }}"
                             draggable="true">

                            <!-- Player Image Header -->
                            <div class="position-relative overflow-hidden draft-player-card-header">
                                <!-- Full Header Player Image -->
                                <img src="{{ player.profile_picture_medium or player.profile_picture_webp or player.profile_picture_url or '/static/img/default_player.png' }}"
                                     alt="{{ player.name }}"
                                     class="player-face-crop draft-player-image js-player-image"
                                     loading="eager"
                                     data-fallback="/static/img/default_player.png">

                                <!-- Dark overlay for better text readability -->
                                <div class="position-absolute w-100 h-100 draft-player-overlay"></div>

                                <!-- Experience Badge - Small Corner Tag -->
                                <div class="position-absolute top-0 end-0 draft-badge-container-end">
                                    <div class="experience-corner-tag bg-{{ 'success' if player.experience_level == 'Veteran' else 'warning' if player.experience_level == 'Experienced' else 'secondary' }}"
                                         title="{{ player.experience_level }}">
                                        <span class="experience-initial">
                                            {{ player.experience_level[0] if player.experience_level else 'N' }}
                                        </span>
                                    </div>
                                </div>

                                <!-- Referee Badge - Small Corner Tag (opposite corner) -->
                                {% if player.is_ref %}
                                <div class="position-absolute top-0 start-0 draft-badge-container-start">
                                    <div class="referee-corner-tag bg-danger text-white draft-referee-badge-text" title="Referee">
                                        REF
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Player Name Overlay -->
                                <div class="position-absolute bottom-0 start-0 p-2 draft-player-name-overlay">
                                    <h6 class="text-white fw-bold mb-0 text-shadow-sm">{{ player.name }}</h6>
                                </div>
                            </div>

                            <!-- Player Info Body -->
                            <div class="c-card__body p-3 text-center">
                                <!-- Position Badge -->
                                <div class="mb-2">
                                    {% if player.favorite_position and player.favorite_position != 'Any' %}
                                    <span class="badge bg-primary rounded-pill" data-badge>{{ format_position(player.favorite_position) }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary rounded-pill" data-badge>Any Position</span>
                                    {% endif %}
                                </div>

                                <!-- Stats Row -->
                                <div class="row text-center mb-2 small">
                                    <div class="col-6">
                                        <div class="fw-bold text-success">{{ player.career_goals }}</div>
                                        <div class="text-muted">Goals</div>
                                        <div class="small text-success draft-stat-avg-small">
                                            Avg: {{ player.avg_goals_per_season }}/season
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="fw-bold text-info">{{ player.career_assists }}</div>
                                        <div class="text-muted">Assists</div>
                                        <div class="small text-info draft-stat-avg-small">
                                            Avg: {{ player.avg_assists_per_season }}/season
                                        </div>
                                    </div>
                                </div>

                                <!-- Cards & Attendance -->
                                <div class="row text-center mb-3 small">
                                    <div class="col-6">
                                        <div class="fw-bold">
                                            <span class="text-warning">{{ player.career_yellow_cards }}</span>/<span class="text-danger">{{ player.career_red_cards }}</span>
                                        </div>
                                        <div class="text-muted">Y/R Cards</div>
                                    </div>
                                    <div class="col-6">
                                        {% if player.attendance_estimate is not none %}
                                        <div class="fw-bold text-{{ 'success' if player.attendance_estimate >= 80 else 'warning' if player.attendance_estimate >= 60 else 'danger' }}">
                                            {{ "%.0f"|format(player.attendance_estimate) }}%
                                        </div>
                                        {% else %}
                                        <div class="fw-bold text-muted">
                                            No data
                                        </div>
                                        {% endif %}
                                        <div class="text-muted">Attendance</div>
                                    </div>
                                </div>

                                <!-- Experience Info -->
                                <div class="small text-muted mb-2">
                                    {{ player.league_experience_seasons }} season{{ 's' if player.league_experience_seasons != 1 else '' }}
                                </div>

                                <!-- Availability Info -->
                                {% if player.expected_weeks_available %}
                                <div class="small text-info mb-3">
                                    <i class="ti ti-calendar-event me-1"></i><strong>Expected:</strong> {{ player.expected_weeks_available }}
                                </div>
                                {% else %}
                                <div class="small text-muted mb-3">
                                    <i class="ti ti-calendar-question me-1"></i><strong>Expected:</strong> N/A
                                </div>
                                {% endif %}
                            </div>

                            <!-- Action Buttons -->
                            <div class="c-card__footer bg-transparent border-0 p-2">
                                <div class="d-grid gap-1">
                                    <button class="c-btn c-btn--sm fw-bold btn-draft-primary js-draft-player"
                                            data-player-id="{{ player.id }}"
                                            data-player-name="{{ player.name|escape }}">
                                        <i class="ti ti-user-plus me-1"></i>Draft Player
                                    </button>
                                    <button class="c-btn c-btn--outline-info c-btn--sm js-view-player-profile"
                                            data-player-id="{{ player.id }}">
                                        <i class="ti ti-user me-1"></i>View Profile
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="draft-empty-state">
                <div class="draft-empty-state-icon">
                    <i class="ti ti-search"></i>
                </div>
                <div class="draft-empty-state-title">No players found</div>
                <div class="draft-empty-state-text">Try adjusting your search or filters</div>
            </div>
        </div>

        <!-- Teams Sidebar -->
        <div class="col-lg-4">
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="mb-0">
                        <i class="ti ti-users me-2"></i>
                        Teams
                    </h5>
                </div>
                <div class="c-card__body p-0">
                    <div class="accordion" id="teamsAccordion" data-accordion>
                        {% for team in teams %}
                        <div class="accordion-item team-drop-zone draft-team-accordion-item js-draft-drop-zone"
                             data-team-id="{{ team.id }}"
                             data-drop-target="team" data-accordion>
                            <h2 class="accordion-header" id="heading{{ team.id }}">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapse{{ team.id }}"
                                        aria-expanded="false"
                                        aria-controls="collapse{{ team.id }}" data-collapse-toggle>
                                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                        <span class="fw-bold">{{ team.name }}</span>
                                        <span class="badge bg-primary" id="teamCount{{ team.id }}" data-badge>
                                            {{ drafted_players_by_team[team.id]|length if drafted_players_by_team[team.id] else 0 }} players
                                        </span>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse{{ team.id }}"
                                 class="accordion-collapse collapse"
                                 aria-labelledby="heading{{ team.id }}"
                                 data-bs-parent="#teamsAccordion" data-accordion>
                                <div class="accordion-body p-2" data-accordion>
                                    <div class="border rounded p-3 draft-team-roster js-draft-drop-zone"
                                         id="teamSection{{ team.id }}"
                                         data-team-id="{{ team.id }}"
                                         data-drop-target="team"
                                         role="region"
                                         aria-label="{{ team.name }} team roster">

                                        <div id="teamPlayers{{ team.id }}" class="row g-2">
                                            {% for player in drafted_players_by_team[team.id] %}
                                            <div class="col-md-6 col-lg-4">
                                                <div class="c-card border-0 shadow-sm draft-team-player-card js-draggable-player"
                                                     draggable="true"
                                                     data-player-id="{{ player.id }}">
                                                    <div class="c-card__body p-2">
                                                        <div class="d-flex align-items-center mb-2">
                                                            <img src="{{ player.profile_picture_url or '/static/img/default_player.png' }}"
                                                                 alt="{{ player.name }}"
                                                                 class="rounded-circle me-2 draft-team-player-avatar js-player-image"
                                                                 loading="lazy"
                                                                 data-fallback="/static/img/default_player.png">
                                                            <div class="flex-grow-1 min-width-0">
                                                                <div class="fw-semibold text-truncate small">
                                                                    {{ player.name }}
                                                                    {% if player.is_ref %}
                                                                    <i class="ti ti-whistle text-dark ms-1 draft-icon-sm" title="Referee"></i>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="text-muted draft-team-player-position">
                                                                    {{ format_position(player.favorite_position) if player.favorite_position else 'Any' }}
                                                                </div>
                                                            </div>
                                                            <button class="c-btn c-btn--outline-danger c-btn--sm p-1 js-remove-player"
                                                                    data-player-id="{{ player.id }}"
                                                                    data-team-id="{{ team.id }}"
                                                                    data-player-name="{{ player.name|escape }}"
                                                                    data-team-name="{{ team.name|escape }}"
                                                                    title="Remove {{ player.name }}">
                                                                <i class="ti ti-x draft-icon-sm"></i>
                                                            </button>
                                                        </div>
                                                        <div class="d-flex justify-content-between text-center small">
                                                            <div>
                                                                <div class="fw-bold text-success">{{ player.career_goals }}</div>
                                                                <div class="text-muted draft-stat-label">Goals</div>
                                                                <div class="text-success draft-stat-value-tiny">{{ player.avg_goals_per_season }}/s</div>
                                                            </div>
                                                            <div>
                                                                <div class="fw-bold text-info">{{ player.career_assists }}</div>
                                                                <div class="text-muted draft-stat-label">Assists</div>
                                                                <div class="text-info draft-stat-value-tiny">{{ player.avg_assists_per_season }}/s</div>
                                                            </div>
                                                            <div>
                                                                <div class="fw-bold">
                                                                    <span class="text-warning">{{ player.career_yellow_cards }}</span>/<span class="text-danger">{{ player.career_red_cards }}</span>
                                                                </div>
                                                                <div class="text-muted draft-stat-label">Cards</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>

                                        {% if not drafted_players_by_team[team.id] %}
                                        <div class="text-center text-muted py-3">
                                            <i class="ti ti-user-plus mb-2 draft-icon-lg"></i>
                                            <div class="fw-semibold">Drag players here</div>
                                            <small>or click Draft on a player</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Enhanced Player Profile Modal for Draft -->
<div class="modal c-modal fade" data-modal id="playerProfileModal" tabindex="-1" aria-labelledby="playerProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content ecs-modal dark-mode-applied draft-modal-content" data-modal-content>
            <div class="modal-header c-modal__header ecs-modal-header draft-modal-header" data-modal-header>
                <h5 class="modal-title c-modal__title ecs-modal-title draft-modal-title" id="playerProfileModalLabel">
                    <i class="ti ti-user me-2"></i>Player Profile
                </h5>
                <button type="button" class="btn-close ecs-modal-close draft-modal-close-dark" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <div class="modal-body c-modal__body p-0 ecs-modal-body draft-modal-body" data-modal-body>
                <div id="playerProfileContent">
                    <!-- Loading State -->
                    <div id="profileLoading" class="text-center py-5 draft-modal-loading" data-modal>
                        <div class="spinner-border text-primary mb-3" role="status" data-spinner>
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted draft-modal-loading-text">Loading player details...</p>
                    </div>

                    <!-- Profile Content Container -->
                    <div id="profileData" class="draft-profile-data">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer c-modal__footer ecs-modal-footer draft-modal-footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary ecs-btn ecs-btn-secondary draft-modal-btn-secondary" data-bs-dismiss="modal" data-dismiss>Close</button>
                <button type="button" class="c-btn c-btn--success ecs-btn ecs-btn-success draft-modal-btn-hidden" id="draftFromModal">
                    <i class="ti ti-user-plus me-1"></i>Draft This Player
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Draft Confirmation Modal -->
<div class="modal c-modal fade" data-modal id="draftConfirmModal" tabindex="-1" aria-labelledby="draftConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content ecs-modal dark-mode-applied draft-modal-content" data-modal-content>
            <div class="modal-header c-modal__header ecs-modal-header draft-confirm-modal-header" data-modal-header>
                <h5 class="modal-title c-modal__title draft-confirm-modal-title" id="draftConfirmModalLabel">
                    <i class="ti ti-user-plus me-2"></i>Draft Player
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <div class="modal-body c-modal__body draft-confirm-modal-body" data-modal-body>
                <p id="draftPlayerMessage" class="mb-3"></p>
                <div class="mb-3">
                    <label for="teamSelect" class="form-label draft-confirm-label">Select Team:</label>
                    <select id="teamSelect" class="form-select ecs-form-control draft-confirm-select" data-form-select>
                        <option value="">Choose a team...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer c-modal__footer draft-confirm-modal-footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary ecs-btn draft-modal-btn-secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="button" class="c-btn c-btn--primary ecs-btn draft-confirm-btn-primary" id="confirmDraftBtn">
                    <i class="ti ti-user-plus me-1"></i>Draft Player
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="c-draft-loading-overlay is-visible" data-component="draft-loading-overlay">
    <div class="c-draft-loading-overlay__content">
        <div class="c-draft-loading-overlay__spinner"></div>
        <p class="c-draft-loading-overlay__text">Processing...</p>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}

<!-- Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<!-- Draft System JavaScript -->
{% if not config.get('ASSETS_PRODUCTION_MODE') %}
<script src="{{ url_for('static', filename='js/draft-system.js') }}?v={{ range(1, 1000000) | random }}"></script>

<!-- Mobile Draft Enhancements -->
<script src="{{ url_for('static', filename='js/mobile-draft.js') }}"></script>

<!-- Draft Enhanced Page-Specific JavaScript -->
<script src="{{ url_for('static', filename='custom_js/draft-enhanced.js') }}"></script>

<!--
{% endif %}
MIGRATION NOTE: Inline JavaScript has been extracted to /app/static/custom_js/draft-enhanced.js
All event handlers now use data-* attributes and .js-* classes for binding
Functions migrated:
- formatPosition()
- setupLiveSearch()
- filterPlayers()
- sortPlayers()
- updateAvailablePlayerCount()
- updateTeamCount()
- updateAllTeamCounts()
- confirmDraftPlayer()
- openPlayerModal()
- displayPlayerProfile()

Event delegation replaces inline handlers:
- ‚Üí .js-draft-player with data-player-id
- ‚Üí .js-view-player-profile with data-player-id
- ‚Üí .js-remove-player with data attributes
- ondragstart/ondragend ‚Üí .js-draggable-player event listeners
- ondrop/ondragover/ondragleave ‚Üí .js-draft-drop-zone event listeners
- onerror/onload on images ‚Üí .js-player-image error/load event listeners
-->

<script data-league-name="{{ league_name }}">
// Initialize draft with league name
document.addEventListener('DOMContentLoaded', function() {
    const leagueName = '{{ league_name }}';
    console.log('üéØ Initializing draft system for league:', leagueName);
    if (typeof initializeDraftSystem === 'function') {
        initializeDraftSystem(leagueName);
    } else {
        console.error('‚ùå initializeDraftSystem function not found!');
    }
});
</script>
{% endblock %}
