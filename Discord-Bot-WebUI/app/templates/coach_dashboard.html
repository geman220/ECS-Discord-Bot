{% extends "base.html" %}
{% from 'macros.html' import render_report_match_modal %}

{% block title %}{{ title }}{% endblock %}

{% block page_css %}

{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/features/coach-dashboard.css') }}">
{% endif %}
{% endblock %}

<!-- Match Card Macro -->
{% macro render_match_card(match, player_choices) %}
<div class="p-3 border-bottom">
    <div class="row">
        <div class="col-md-7 mb-3 mb-md-0">
            <div class="d-flex justify-content-between mb-2">
                <span class="fw-bold">{{ match.home_team.name if match.home_team else match.opponent_name }}</span>
                <span class="fw-bold fs-4 {% if match.home_team_score is not none %}text-primary{% else %}text-muted{% endif %}">{{ match.home_team_score if match.home_team_score is not none else '-' }}</span>
            </div>
            <div class="text-center text-muted small mb-2">vs</div>
            <div class="d-flex justify-content-between mb-2">
                <span class="fw-bold">{{ match.away_team.name if match.away_team else match.opponent_name }}</span>
                <span class="fw-bold fs-4 {% if match.away_team_score is not none %}text-primary{% else %}text-muted{% endif %}">{{ match.away_team_score if match.away_team_score is not none else '-' }}</span>
            </div>
            <div class="small text-muted">
                <div><i class="ti ti-calendar me-1"></i>{{ match.date.strftime('%a, %b %d, %Y') }}</div>
                <div><i class="ti ti-clock me-1"></i>{{ match.time.strftime('%I:%M %p') }}</div>
                <div><i class="ti ti-map-pin me-1"></i>{{ match.location }}</div>
            </div>
        </div>
        <div class="col-md-5">
            {% if match.home_team_score is not none %}
            <div class="alert alert-success py-2 mb-2" data-alert><i class="ti ti-check-circle me-1"></i><strong>Reported</strong></div>
            {% else %}
            <div class="alert alert-warning py-2 mb-2" data-alert><i class="ti ti-alert-circle me-1"></i><strong>Not Reported</strong></div>
            {% endif %}

            {# RSVP Counts - show for all matches #}
            {% if match.rsvp_counts %}
            <div class="mb-2">
                <div class="d-flex justify-content-between small text-muted mb-1">
                    <span><i class="ti ti-users me-1"></i>RSVPs:</span>
                </div>
                <div class="d-flex gap-2">
                    <span class="badge bg-success" data-badge>✓ {{ match.rsvp_counts.YES }}</span>
                    <span class="badge bg-danger" data-badge>✗ {{ match.rsvp_counts.NO }}</span>
                    <span class="badge bg-warning" data-badge>? {{ match.rsvp_counts.MAYBE }}</span>
                </div>
            </div>
            {% endif %}

            {# Sub Request Status #}
            {% if match.sub_requests %}
            <div class="alert alert-info py-2 mb-2 small" data-alert>
                <i class="ti ti-user-plus me-1"></i>
                {% for sub_req in match.sub_requests %}
                    {% if sub_req.status == 'OPEN' %}
                    <strong>{{ sub_req.substitutes_needed }} sub(s) requested</strong>
                    {% elif sub_req.status == 'FILLED' %}
                    <strong>Sub filled</strong>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}

            {# Match Reporting Button #}
            <button class="c-btn c-btn--primary c-btn--lg w-100 mb-2" data-bs-toggle="modal" data-bs-target="#reportMatchModal-{{ match.id }}">
                <i class="ti ti-pencil me-2"></i>{% if match.home_team_score is not none %}Edit{% else %}Report{% endif %}
            </button>

            {# Request Sub Button (only for future matches) #}
            {% if match.date and match.date > today and match.home_team_score is none %}
                {% set has_open_request = namespace(value=false) %}
                {% if match.sub_requests %}
                    {% for sub_req in match.sub_requests %}
                        {% if sub_req.status == 'OPEN' %}
                            {% set has_open_request.value = true %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
                {% if not has_open_request.value %}
                    {% if match.is_ecs_fc %}
                        {# ECS FC: Use team_id from match.team_id #}
                        <button class="c-btn c-btn--outline-secondary w-100 js-request-sub" data-action="request-sub" data-match-id="{{ match.id }}" data-league-type="{{ match.league_type }}" data-team-id="{{ match.team_id if hasattr(match, 'team_id') else (match.home_team_id if match.home_team_id else match.away_team_id) }}">
                            <i class="ti ti-user-plus me-2"></i>Request Sub
                        </button>
                    {% else %}
                        {# Pub League: Use home_team_id or away_team_id #}
                        <button class="c-btn c-btn--outline-secondary w-100 js-request-sub" data-action="request-sub" data-match-id="{{ match.id }}" data-league-type="{{ match.league_type if match.league_type else 'Pub League' }}" data-team-id="{{ match.home_team_id if match.home_team_id else match.away_team_id }}">
                            <i class="ti ti-user-plus me-2"></i>Request Sub
                        </button>
                    {% endif %}
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">

    <!-- Page Header -->
    <div class="c-card bg-primary mb-4">
        <div class="c-card__body">
            <h2 class="text-white mb-1">
                <i class="ti ti-dashboard me-2"></i>Coach Dashboard
            </h2>
            {% if coached_teams %}
            <p class="text-white-50 mb-0">
                Managing
                {% for team in coached_teams %}
                    <span class="badge bg-label-light" data-badge>{{ team.name }}</span>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </p>
            {% else %}
            <p class="text-white-50 mb-0">
                Team statistics, player roster, and match reporting
            </p>
            {% endif %}
        </div>
    </div>

    {% if no_coach_access %}
    <!-- Not Coaching Message -->
    <div class="row">
        <div class="col-12">
            <div class="c-card border-info">
                <div class="c-card__body text-center py-5">
                    <i class="ti ti-info-circle mb-3 icon-empty-state"></i>
                    <h5>Not Currently Coaching</h5>
                    <p class="text-muted mb-0">
                        You are not currently assigned as a coach for any teams.<br>
                        This dashboard is available for coaches to view team stats and report matches.
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% else %}

    {% for team in coached_teams %}
    {% set stats = team_stats.get(team.id) %}

    <!-- Team Header -->
    <div class="row mb-3">
        <div class="col-12">
            <h4 class="fw-bold">
                <i class="ti ti-users me-2"></i>{{ team.name }}
                {% if stats.league_type %}
                    {% if stats.league_type == 'ECS FC' %}
                        <span class="badge bg-label-info" data-badge>{{ stats.league_type }}</span>
                    {% elif stats.league_type == 'Premier' %}
                        <span class="badge bg-label-success" data-badge>Premier Division</span>
                    {% elif stats.league_type == 'Classic' %}
                        <span class="badge bg-label-warning" data-badge>Classic Division</span>
                    {% else %}
                        <span class="badge bg-label-primary" data-badge>{{ team.league.name }}</span>
                    {% endif %}
                {% elif team.league %}
                    <span class="badge bg-label-primary" data-badge>{{ team.league.name }}</span>
                {% endif %}
            </h4>
        </div>
    </div>

    {% if stats %}
    <!-- Team Stats Row -->
    <div class="row g-3 mb-4">
        <!-- Team Record -->
        <div class="col-lg-4 col-md-6">
            <div class="c-card h-100">
                <div class="c-card__header"><h6 class="mb-0"><i class="ti ti-trophy me-2"></i>Season Record</h6></div>
                <div class="c-card__body">
                    {% if stats.standings %}
                    <div class="stat-row mb-2 d-flex justify-content-between">
                        <span class="text-muted">Record:</span>
                        <span class="fw-bold">{{ stats.standings.wins }}-{{ stats.standings.losses }}-{{ stats.standings.draws }}</span>
                    </div>
                    <div class="stat-row mb-2 d-flex justify-content-between">
                        <span class="text-muted">Points:</span>
                        <span class="fw-bold text-primary">{{ stats.standings.points }}</span>
                    </div>
                    <div class="stat-row mb-2 d-flex justify-content-between">
                        <span class="text-muted">Goals For:</span>
                        <span>{{ stats.standings.goals_for }}</span>
                    </div>
                    <div class="stat-row mb-2 d-flex justify-content-between">
                        <span class="text-muted">Goals Against:</span>
                        <span>{{ stats.standings.goals_against }}</span>
                    </div>
                    <div class="stat-row d-flex justify-content-between">
                        <span class="text-muted">Goal Diff:</span>
                        <span class="{% if stats.standings.goal_difference > 0 %}text-success{% elif stats.standings.goal_difference < 0 %}text-danger{% endif %}">
                            {% if stats.standings.goal_difference > 0 %}+{% endif %}{{ stats.standings.goal_difference }}
                        </span>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0 small">No standings data</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Top Scorers -->
        <div class="col-lg-4 col-md-6">
            <div class="c-card h-100">
                <div class="c-card__header"><h6 class="mb-0"><i class="ti ti-ball-football me-2"></i>Top Scorers</h6></div>
                <div class="c-card__body">
                    {% if stats.top_scorers %}
                    {% for player, pstats in stats.top_scorers %}
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small">{{ player.name }}</span>
                        <span class="badge bg-primary" data-badge>{{ pstats.goals }}</span>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted mb-0 small">No goals scored</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Assist Leaders -->
        <div class="col-lg-4 col-md-6">
            <div class="c-card h-100">
                <div class="c-card__header"><h6 class="mb-0"><i class="ti ti-user-check me-2"></i>Assist Leaders</h6></div>
                <div class="c-card__body">
                    {% if stats.top_assists %}
                    {% for player, pstats in stats.top_assists %}
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small">{{ player.name }}</span>
                        <span class="badge bg-info" data-badge>{{ pstats.assists }}</span>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted mb-0 small">No assists recorded</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Player Roster -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__header d-flex justify-content-between u-cursor-pointer" data-bs-toggle="collapse" data-bs-target="#roster-{{ team.id }}" data-collapse-toggle>
                    <h6 class="mb-0"><i class="ti ti-users me-2"></i>Roster <span class="badge bg-label-primary" data-badge>{{ stats.roster|length }}</span></h6>
                    <i class="ti ti-chevron-down"></i>
                </div>
                <div id="roster-{{ team.id }}" class="collapse show">
                    <div class="c-table-wrapper" data-table-responsive>
                        <table class="c-c-table c-table--hoverable mb-0" data-table data-mobile-table data-table-type="roster">
                            <thead scope="col"><tr><th scope="col">Player</th><th class="text-center d-none d-md-table-cell" scope="col">G</th><th class="text-center d-none d-md-table-cell" scope="col">A</th><th class="text-center d-none d-lg-table-cell" scope="col">YC</th><th class="text-center d-none d-lg-table-cell" scope="col">RC</th><th class="text-center" scope="col">Attendance</th></tr></thead>
                            <tbody>
                                {% for player, attendance, season_stats in stats.roster %}
                                <tr>
                                    <td class="fw-semibold" data-label="Player">{{ player.name }}</td>
                                    <td class="text-center d-none d-md-table-cell" data-label="Goals">
                                        {% if season_stats and season_stats.goals > 0 %}<span class="badge bg-label-primary" data-badge>{{ season_stats.goals }}</span>{% else %}<span class="text-muted">0</span>{% endif %}
                                    </td>
                                    <td class="text-center d-none d-md-table-cell" data-label="Assists">
                                        {% if season_stats and season_stats.assists > 0 %}<span class="badge bg-label-info" data-badge>{{ season_stats.assists }}</span>{% else %}<span class="text-muted">0</span>{% endif %}
                                    </td>
                                    <td class="text-center d-none d-lg-table-cell" data-label="Yellow Cards">
                                        {% if season_stats and season_stats.yellow_cards > 0 %}<span class="badge bg-label-warning" data-badge>{{ season_stats.yellow_cards }}</span>{% else %}<span class="text-muted">0</span>{% endif %}
                                    </td>
                                    <td class="text-center d-none d-lg-table-cell" data-label="Red Cards">
                                        {% if season_stats and season_stats.red_cards > 0 %}<span class="badge bg-label-danger" data-badge>{{ season_stats.red_cards }}</span>{% else %}<span class="text-muted">0</span>{% endif %}
                                    </td>
                                    <td class="text-center" data-label="Attendance">
                                        {% if attendance %}
                                        {% set rate = (attendance.season_attendance_rate * 100)|int %}
                                        <span class="badge {% if rate >= 80 %}bg-success{% elif rate >= 60 %}bg-warning{% else %}bg-danger{% endif %}" data-badge>{{ rate }}%</span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}

    <!-- Match Reporting Section -->
    <h4 class="fw-bold mb-3"><i class="ti ti-clipboard-check me-2"></i>Match Reporting</h4>

    {% if todays_matches %}
    <div class="c-card border-warning shadow mb-4">
        <div class="c-card__header bg-warning"><h6 class="mb-0"><i class="ti ti-clock-play me-2"></i>Today's Matches <span class="badge bg-label-light" data-badge>{{ todays_matches|length }}</span></h6></div>
        <div class="list-group list-group-flush">
            {% for match in todays_matches %}{{ render_match_card(match, player_choices) }}{% endfor %}
        </div>
    </div>
    {% endif %}

    {% if needs_reporting %}
    <div class="c-card border-danger shadow mb-4">
        <div class="c-card__header bg-danger text-white" data-alert><h6 class="mb-0"><i class="ti ti-alert-triangle me-2"></i>Needs Reporting <span class="badge bg-white text-danger" data-badge>{{ needs_reporting|length }}</span></h6></div>
        <div class="list-group list-group-flush">
            {% for match in needs_reporting %}{{ render_match_card(match, player_choices) }}{% endfor %}
        </div>
    </div>
    {% endif %}

    {% if upcoming_matches %}
    <div class="c-card mb-4">
        <div class="c-card__header d-flex justify-content-between u-cursor-pointer" data-bs-toggle="collapse" data-bs-target="#upcomingMatches" data-collapse-toggle>
            <h6 class="mb-0"><i class="ti ti-calendar-event me-2"></i>Upcoming <span class="badge bg-label-primary" data-badge>{{ upcoming_matches|length }}</span></h6>
            <i class="ti ti-chevron-down"></i>
        </div>
        <div id="upcomingMatches" class="collapse show">
            <div class="list-group list-group-flush">
                {% for match in upcoming_matches %}{{ render_match_card(match, player_choices) }}{% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if past_matches %}
    <div class="c-card mb-4">
        <div class="c-card__header d-flex justify-content-between u-cursor-pointer" data-bs-toggle="collapse" data-bs-target="#pastMatches" data-collapse-toggle>
            <h6 class="mb-0"><i class="ti ti-history me-2"></i>Past <span class="badge bg-label-secondary" data-badge>{{ past_matches|length }}</span></h6>
            <i class="ti ti-chevron-down"></i>
        </div>
        <div id="pastMatches" class="collapse">
            <div class="list-group list-group-flush">
                {% for match in past_matches %}{{ render_match_card(match, player_choices) }}{% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if not current_matches and not future_matches and not past_matches %}
    <div class="c-card">
        <div class="c-card__body text-center py-5">
            <i class="ti ti-calendar-off mb-3 icon-empty-state"></i>
            <h6 class="text-muted">No Matches Scheduled</h6>
        </div>
    </div>
    {% endif %}

    {% endif %}
</div>

<!-- Match Modals -->
{% if not no_coach_access %}
{% set all_matches = (todays_matches if todays_matches else []) + (needs_reporting if needs_reporting else []) + (upcoming_matches if upcoming_matches else []) + (past_matches if past_matches else []) %}
{% for match in all_matches %}
    {% if match and (match.home_team or match.away_team) %}{{ render_report_match_modal(match, player_choices) }}{% endif %}
{% endfor %}
{% endif %}
{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="{{ url_for('static', filename='custom_js/coach-dashboard.js') }}"></script>
{% endif %}
{% endblock %}
