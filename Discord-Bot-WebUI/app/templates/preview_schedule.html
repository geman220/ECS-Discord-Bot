{% extends "base.html" %}

{% block main_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="c-card">
                <div class="c-card__header d-flex justify-content-between align-items-center">
                    <div>
                        <h4>Schedule Preview - {{ league.name }}</h4>
                        <p class="text-muted">Review and modify the generated schedule before committing</p>
                    </div>
                    <div>
                        <button class="c-btn c-btn--info js-toggle-settings" data-action="toggle-settings">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </div>
                </div>
                <div class="c-card__body">
                    <!-- Schedule Settings Panel -->
                    <div id="schedule-settings" class="alert alert-light u-hidden" data-alert>
                        <h5>Schedule Configuration</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Start Time:</strong> {{ config.start_time.strftime('%H:%M') }}
                            </div>
                            <div class="col-md-3">
                                <strong>Match Duration:</strong> {{ config.match_duration_minutes }} minutes
                            </div>
                            <div class="col-md-3">
                                <strong>Weeks:</strong> {{ config.weeks_count }}
                            </div>
                            <div class="col-md-3">
                                <strong>Fields:</strong> {{ config.fields }}
                            </div>
                        </div>
                        <div class="mt-3">
                            <form method="POST" action="{{ url_for('auto_schedule.regenerate_schedule', league_id=league.id) }}" class="d-inline">
                                <label for="regenerate_start_date">Start Date:</label>
                                <input type="date" name="start_date" id="regenerate_start_date" class="form-control d-inline u-w-auto" required data-form-control>
                                <button type="submit" class="c-btn c-btn--warning c-btn--sm">
                                    <i class="fas fa-sync"></i> Regenerate
                                </button>
                            </form>
                            <button class="c-btn c-btn--danger c-btn--sm js-delete-schedule" data-action="delete-schedule">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mb-3">
                        <button class="c-btn c-btn--success js-commit-schedule" data-action="commit-schedule">
                            <i class="fas fa-check"></i> Commit Schedule
                        </button>
                        <a href="{{ url_for('auto_schedule.auto_schedule_config', league_id=league.id) }}" class="c-btn c-btn--secondary">
                            <i class="fas fa-edit"></i> Modify Configuration
                        </a>
                        <a href="{{ url_for('auto_schedule.schedule_manager') }}" class="c-btn c-btn--outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Season Builder
                        </a>
                    </div>

                    <!-- Schedule Preview -->
                    <div class="schedule-preview">
                        {% for week, matches in schedule_preview.items() %}
                            <div class="week-section mb-4">
                                {% set week_type = matches[0].week_type if matches else 'REGULAR' %}
                                <h5 class="week-header">
                                    {{ week }}
                                    {% if week_type == 'FUN' %}
                                        <span class="badge badge-warning" data-badge>FUN WEEK</span>
                                    {% elif week_type == 'TST' %}
                                        <span class="badge badge-info" data-badge>TST WEEK</span>
                                    {% elif week_type == 'BYE' %}
                                        <span class="badge badge-secondary" data-badge>BYE WEEK</span>
                                    {% else %}
                                        <span class="badge badge-success" data-badge>REGULAR</span>
                                    {% endif %}
                                </h5>
                                
                                {% if week_type == 'BYE' %}
                                    <div class="alert alert-secondary" data-alert>
                                        <i class="fas fa-moon"></i> <strong>BYE Week</strong> - No games scheduled. Teams have the week off.
                                    </div>
                                {% elif week_type == 'FUN' %}
                                    <div class="alert alert-warning" data-alert>
                                        <i class="fas fa-futbol"></i> <strong>FUN Week</strong> - Special activities and fun games.
                                    </div>
                                {% elif week_type == 'TST' %}
                                    <div class="alert alert-info" data-alert>
                                        <i class="fas fa-trophy"></i> <strong>TST Week</strong> - The Soccer Tournament week.
                                    </div>
                                {% endif %}
                                
                                <div class="c-table-wrapper" data-table-responsive>
                                    <table class="c-table c-table--compact c-table--striped" data-table>
                                        <thead scope="col">
                                            <tr>
                                                <th scope="col">Time</th>
                                                <th scope="col">Field</th>
                                                <th scope="col">Home Team</th>
                                                <th scope="col">Away Team</th>
                                                <th scope="col">Match Order</th>
                                                <th scope="col">Week Type</th>
                                                {% if week_type == 'REGULAR' %}
                                                <th scope="col">Actions</th>
                                                {% endif %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for match in matches %}
                                                <tr data-template-id="{{ match.id }}" 
                                                    class="{{ 'special-week-row' if match.week_type != 'REGULAR' else '' }}">
                                                    <td>{{ match.time }}</td>
                                                    <td>
                                                        <span class="badge badge-light" data-badge>{{ match.field }}</span>
                                                    </td>
                                                    <td>
                                                        {% if match.week_type in ['FUN', 'TST', 'BYE', 'BONUS', 'PLAYOFF'] %}
                                                            <span class="badge badge-info" data-badge>
                                                                {% if match.week_type == 'FUN' %}
                                                                    Fun Week
                                                                {% elif match.week_type == 'TST' %}
                                                                    TST Week
                                                                {% elif match.week_type == 'BYE' %}
                                                                    BYE Week
                                                                {% elif match.week_type == 'BONUS' %}
                                                                    Bonus Week
                                                                {% elif match.week_type == 'PLAYOFF' %}
                                                                    Playoff Week
                                                                {% endif %}
                                                            </span>
                                                        {% else %}
                                                            <span class="team-name" data-team-id="{{ match.home_team_id }}">
                                                                {{ match.home_team }}
                                                            </span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if match.week_type in ['FUN', 'TST', 'BYE', 'BONUS', 'PLAYOFF'] %}
                                                            <span class="text-muted">
                                                                {% if match.week_type == 'FUN' %}
                                                                    Special activities
                                                                {% elif match.week_type == 'TST' %}
                                                                    Tournament events
                                                                {% elif match.week_type == 'BYE' %}
                                                                    No games
                                                                {% elif match.week_type == 'BONUS' %}
                                                                    Additional activities
                                                                {% elif match.week_type == 'PLAYOFF' %}
                                                                    TBD
                                                                {% endif %}
                                                            </span>
                                                        {% else %}
                                                            <span class="team-name" data-team-id="{{ match.away_team_id }}">
                                                                {{ match.away_team }}
                                                            </span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-{{ 'primary' if match.match_order == 1 else 'secondary' }}" data-badge>
                                                            {{ match.match_order }}{{ 'st' if match.match_order == 1 else 'nd' }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        {% if match.week_type == 'REGULAR' %}
                                                            <span class="badge badge-success" data-badge>Regular</span>
                                                        {% elif match.week_type == 'FUN' %}
                                                            <span class="badge badge-warning" data-badge>Fun</span>
                                                        {% elif match.week_type == 'TST' %}
                                                            <span class="badge badge-info" data-badge>TST</span>
                                                        {% elif match.week_type == 'BYE' %}
                                                            <span class="badge badge-secondary" data-badge>Bye</span>
                                                        {% endif %}
                                                    </td>
                                                    {% if week_type == 'REGULAR' %}
                                                    <td>
                                                        <button class="c-btn btn-xs c-btn--outline-primary js-select-swap"
                                                                data-action="select-for-swap" data-match-id="{{ match.id }}" data-match-desc="{{ match.home_team }} vs {{ match.away_team }}">
                                                            <i class="fas fa-exchange-alt"></i> Swap
                                                        </button>
                                                    </td>
                                                    {% endif %}
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Swap Teams Modal -->
<div class="modal c-modal fade" data-modal id="swapTeamsModal" tabindex="-1" role="dialog" aria-labelledby="swapTeamsModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog" data-modal-dialog role="document">
        <div class="modal-content c-modal__content" data-modal-content data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header data-modal-header>
                <h5 class="modal-title c-modal__title" id="swapTeamsModalLabel">Swap Teams</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                <div id="swap-selection">
                    <p>Select two matches to swap teams:</p>
                    <div id="selected-matches"></div>
                </div>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="c-btn c-btn--primary js-execute-swap" data-action="execute-swap" disabled id="execute-swap-btn">
                    <i class="fas fa-exchange-alt"></i> Swap Teams
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedMatches = [];
let isSwapMode = false;

// Event delegation
document.addEventListener('click', function(e) {
    const action = e.target.closest('[data-action]')?.dataset.action;
    if (!action) return;

    const target = e.target.closest('[data-action]');

    switch(action) {
        case 'toggle-settings':
            toggleScheduleSettings();
            break;
        case 'delete-schedule':
            deleteSchedule();
            break;
        case 'commit-schedule':
            commitSchedule();
            break;
        case 'select-for-swap':
            selectForSwap(parseInt(target.dataset.matchId), target.dataset.matchDesc);
            break;
        case 'execute-swap':
            executeSwap();
            break;
        case 'remove-from-swap':
            removeFromSwap(parseInt(target.dataset.swapIndex));
            break;
    }
});

function toggleScheduleSettings() {
    const settingsPanel = document.getElementById('schedule-settings');
    settingsPanel.classList.toggle('u-hidden');
}

function selectForSwap(templateId, matchDescription) {
    if (selectedMatches.length >= 2) {
        selectedMatches = [];
        document.querySelectorAll('.selected-for-swap').forEach(row => {
            row.classList.remove('selected-for-swap');
        });
    }
    
    selectedMatches.push({
        id: templateId,
        description: matchDescription
    });
    
    const row = document.querySelector(`tr[data-template-id="${templateId}"]`);
    row.classList.add('selected-for-swap');
    
    updateSwapModal();
    
    if (selectedMatches.length === 2) {
        $('#swapTeamsModal').modal('show');
    }
}

function updateSwapModal() {
    const selectedMatchesDiv = document.getElementById('selected-matches');
    selectedMatchesDiv.innerHTML = '';
    
    selectedMatches.forEach((match, index) => {
        const div = document.createElement('div');
        div.className = 'selected-match mb-2';
        div.innerHTML = `
            <strong>Match ${index + 1}:</strong> ${match.description}
            <button class="c-btn c-btn--sm c-btn--outline-danger ml-2 js-remove-swap" data-action="remove-from-swap" data-swap-index="${index}">
                <i class="fas fa-times"></i>
            </button>
        `;
        selectedMatchesDiv.appendChild(div);
    });
    
    const executeBtn = document.getElementById('execute-swap-btn');
    executeBtn.disabled = selectedMatches.length !== 2;
}

function removeFromSwap(index) {
    const templateId = selectedMatches[index].id;
    selectedMatches.splice(index, 1);
    
    const row = document.querySelector(`tr[data-template-id="${templateId}"]`);
    row.classList.remove('selected-for-swap');
    
    updateSwapModal();
    
    if (selectedMatches.length === 0) {
        $('#swapTeamsModal').modal('hide');
    }
}

function executeSwap() {
    if (selectedMatches.length !== 2) {
        alert('Please select exactly 2 matches to swap');
        return;
    }
    
    const formData = new FormData();
    formData.append('template_id_1', selectedMatches[0].id);
    formData.append('template_id_2', selectedMatches[1].id);
    
    fetch('{{ url_for("auto_schedule.swap_teams", league_id=league.id) }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Refresh the page to show updated schedule
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while swapping teams');
    });
}

function commitSchedule() {
    if (confirm('Are you sure you want to commit this schedule? This will create actual matches and cannot be easily undone.')) {
        fetch('{{ url_for("auto_schedule.commit_schedule", league_id=league.id) }}', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Schedule committed successfully!');
                window.location.href = '{{ url_for("publeague.season.manage_seasons") }}';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while committing the schedule');
        });
    }
}

function deleteSchedule() {
    if (confirm('Are you sure you want to delete this schedule? This will remove all generated templates.')) {
        fetch('{{ url_for("auto_schedule.delete_schedule", league_id=league.id) }}', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Schedule deleted successfully!');
                window.location.href = '{{ url_for("auto_schedule.auto_schedule_config", league_id=league.id) }}';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the schedule');
        });
    }
}

// Set default regenerate date to next Sunday
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const nextSunday = new Date(today);
    nextSunday.setDate(today.getDate() + (7 - today.getDay()) % 7);
    
    const regenerateDateInput = document.getElementById('regenerate_start_date');
    regenerateDateInput.value = nextSunday.toISOString().split('T')[0];
});
</script>

<style>
.selected-for-swap {
    background-color: var(--ecs-primary-subtle, #e7f3ff) !important;
    border: 2px solid var(--ecs-primary, #007bff);
}

.week-section {
    border: 1px solid var(--ecs-neutral-20, #dee2e6);
    border-radius: 0.5rem;
    padding: 1rem;
    background-color: var(--ecs-neutral-5, #f8f9fa);
}

.week-header {
    color: var(--ecs-neutral-60, #495057);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--ecs-neutral-20, #dee2e6);
}

.team-name {
    font-weight: 500;
}

.btn-xs {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.selected-match {
    padding: 0.5rem;
    background-color: var(--ecs-primary-subtle, #e7f3ff);
    border-radius: 0.25rem;
}
</style>
{% endblock %}