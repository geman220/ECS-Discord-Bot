{% extends "base.html" %}

{% block title %}User Waitlist{% endblock %}

{% block custom_css %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/user-waitlist.css') }}">
{% endif %}
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y dark-mode-applied waitlist-page">
    <div class="row">
        <div class="col-12">
            <div class="c-card waitlist-card shadow-sm">
                <div class="c-card__header waitlist-card-header">
                    <h5 class="waitlist-card-title">
                        <i class="ti ti-clock"></i>
                        User Waitlist Management
                    </h5>
                    <button class="c-btn c-btn--outline-primary c-btn--sm waitlist-refresh-btn"
                            data-action="refresh">
                        <i class="ti ti-refresh"></i>
                        Refresh
                    </button>
                </div>
                <div class="c-card__body">
                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="waitlist-stats-card waitlist-stats-card-waitlist">
                                <h3 class="waitlist-stats-card-title" id="waitlist-count">{{ stats.waitlist_count }}</h3>
                                <p class="waitlist-stats-card-label">Users on Waitlist</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="waitlist-stats-card waitlist-stats-card-registered">
                                <h3 class="waitlist-stats-card-title" id="total-registered">{{ stats.total_registered }}</h3>
                                <p class="waitlist-stats-card-label">Total Registered</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="waitlist-stats-card waitlist-stats-card-approved">
                                <h3 class="waitlist-stats-card-title" id="total-approved">{{ stats.total_approved }}</h3>
                                <p class="waitlist-stats-card-label">Total Approved</p>
                            </div>
                        </div>
                    </div>

                    <!-- Waitlist Users Table -->
                    <div class="c-table-wrapper waitlist-table-responsive" data-table-responsive>
                        <table class="c-table c-table--hoverable waitlist-table" data-mobile-table data-table-type="users" data-table>
                            <thead class="c-table--light" scope="col">
                                <tr>
                                    <th scope="col">User</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Preferred League</th>
                                    <th scope="col">Interested in Subbing</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Joined Waitlist</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="waitlist-users-table">
                                {% for user in waitlist_users %}
                                <tr>
                                    <td>
                                        <div class="waitlist-player-profile">
                                            {% if user.player and user.player.profile_picture_url %}
                                                <img src="{{ user.player.profile_picture_url }}" alt="{{ user.username }}" class="waitlist-player-avatar">
                                            {% else %}
                                                <div class="waitlist-avatar-fallback">
                                                    {{ user.username[0].upper() }}
                                                </div>
                                            {% endif %}
                                            <div class="waitlist-player-info">
                                                <p class="waitlist-player-name">{{ user.username }}</p>
                                                {% if user.player and user.player.name and user.player.name != user.username %}
                                                    <p class="waitlist-player-email">{{ user.player.name }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="waitlist-text-muted">{{ user.email }}</span>
                                        {% if user.player and user.player.discord_id %}
                                            <br><small class="waitlist-discord-badge">
                                                <i class="ti ti-brand-discord"></i> Discord Linked
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.preferred_league %}
                                            <span class="badge waitlist-badge waitlist-badge-primary" data-badge>{{ user.preferred_league }}</span>
                                        {% else %}
                                            <span class="waitlist-text-muted">Not specified</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.player and user.player.interested_in_sub %}
                                            <span class="badge waitlist-badge waitlist-badge-success" data-badge>
                                                <i class="ti ti-check"></i> Yes
                                            </span>
                                        {% else %}
                                            <span class="badge waitlist-badge waitlist-badge-secondary" data-badge>
                                                <i class="ti ti-minus"></i> No
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge waitlist-badge waitlist-status-{{ user.approval_status }}" data-badge>
                                            {{ user.approval_status.title() }}
                                        </span>
                                        <br>
                                        <span class="badge waitlist-badge waitlist-status-waitlist" data-badge>
                                            <i class="ti ti-clock"></i> Waitlist
                                        </span>
                                    </td>
                                    <td>
                                        <small class="waitlist-text-muted">
                                            {{ user.waitlist_joined_at.strftime('%Y-%m-%d') if user.waitlist_joined_at else 'Unknown' }}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="waitlist-btn-group" role="group">
                                            <button class="c-btn c-btn--sm c-btn--outline-primary waitlist-btn-sm"
                                                    data-action="view-player"
                                                    data-user-id="{{ user.id }}">
                                                <i class="ti ti-eye"></i> View
                                            </button>
                                            <button class="c-btn c-btn--sm waitlist-btn-contact waitlist-btn-sm"
                                                    data-action="contact-modal"
                                                    data-user-id="{{ user.id }}">
                                                <i class="ti ti-mail"></i> Contact
                                            </button>
                                            <button class="c-btn c-btn--sm waitlist-btn-remove waitlist-btn-sm"
                                                    data-action="removal-modal"
                                                    data-user-id="{{ user.id }}">
                                                <i class="ti ti-trash"></i> Remove
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        
                        {% if not waitlist_users %}
                        <div class="waitlist-empty-state">
                            <i class="ti ti-clock waitlist-empty-icon"></i>
                            <h5 class="waitlist-empty-title">No users on waitlist</h5>
                            <p class="waitlist-empty-text">When users join the waitlist, they will appear here.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
{{ super() }}
<!-- Removal Modal -->
<div class="modal c-modal fade" data-modal id="removalModal" tabindex="-1" aria-labelledby="removalModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog" data-modal-dialog>
        <div class="modal-content c-modal__content waitlist-modal-content" data-modal-content>
            <div class="modal-header c-modal__header waitlist-modal-header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="removalModalLabel">Remove User from Waitlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                <p>Are you sure you want to remove this user from the waitlist?</p>
                <div class="mb-3">
                    <label for="removal-reason" class="form-label">Reason for removal <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="removal-reason" rows="3" placeholder="Please provide a reason for removing this user from the waitlist..." required data-form-control></textarea>
                </div>
            </div>
            <div class="modal-footer c-modal__footer waitlist-modal-footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="button" class="c-btn waitlist-btn-remove" data-action="submit-removal">Remove from Waitlist</button>
            </div>
        </div>
    </div>
</div>

<!-- Contact Modal -->
<div class="modal c-modal fade" data-modal id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog" data-modal-dialog>
        <div class="modal-content c-modal__content waitlist-modal-content" data-modal-content>
            <div class="modal-header c-modal__header waitlist-modal-header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="contactModalLabel">Contact Waitlist User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                <div class="mb-3">
                    <label for="contact-method" class="form-label">Contact Method</label>
                    <select class="form-select" id="contact-method" data-form-select>
                        <option value="email">Email</option>
                        <option value="discord">Discord</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="contact-message" class="form-label">Message</label>
                    <textarea class="form-control" id="contact-message" rows="4" placeholder="Enter your message to the user..." data-form-control></textarea>
                </div>
            </div>
            <div class="modal-footer c-modal__footer waitlist-modal-footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="button" class="c-btn waitlist-btn-contact" data-action="submit-contact">Log Contact</button>
            </div>
        </div>
    </div>
</div>

<!-- Player Details Modal -->
<div class="modal c-modal fade" data-modal id="playerDetailsModal" tabindex="-1" aria-labelledby="playerDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg" data-modal-dialog>
        <div class="modal-content c-modal__content waitlist-modal-content" data-modal-content>
            <div class="modal-header c-modal__header waitlist-modal-header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="playerDetailsModalLabel">Player Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body id="playerDetailsContent" data-modal-body aria-labelledby="playerDetailsContentLabel">
                <!-- Player details will be loaded here -->
            </div>
            <div class="modal-footer c-modal__footer waitlist-modal-footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{# All inline JavaScript has been migrated to event-delegation handlers in admin-waitlist.js #}
{% endblock %}