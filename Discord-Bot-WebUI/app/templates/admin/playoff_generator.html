{% extends "base.html" %}

{% block title %}Playoff Schedule Generator - {{ league.name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/playoff-generator.css') }}">
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold py-3 mb-2">
                <i class="ti ti-tournament me-2 text-primary"></i>Playoff Schedule Generator - {{ league.name }}
            </h2>
            <div class="d-flex align-items-center text-muted mb-3">
                <i class="ti ti-calendar-event me-2"></i>
                Generate playoff brackets and schedules for the top 8 teams
            </div>
            <a href="{{ url_for('auto_schedule.schedule_manager') }}" class="c-btn c-btn--outline-secondary c-btn--sm">
                <i class="ti ti-arrow-left me-1"></i> Back to Schedule Manager
            </a>
        </div>
    </div>

    <!-- How It Works Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card shadow-sm">
                <div class="c-card__header border-bottom py-3">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-info-circle me-2"></i>How It Works
                    </h5>
                </div>
                <div class="c-card__body">
                    <ol class="mb-2">
                        <li>Review the top 8 teams from the regular season standings</li>
                        <li>Click "Generate Preview" to create a randomized playoff bracket</li>
                        <li>Review the generated groups and matchups</li>
                        <li><strong>Optional: Swap entire groups A ↔ B if needed</strong></li>
                        <li><strong>Optional: Edit teams, times, or fields directly in the match table</strong></li>
                        <li>Click "Regenerate" if you want a different random bracket</li>
                        <li>Click "Confirm & Apply" to save your schedule</li>
                    </ol>
                    <div class="alert alert-info mb-2" data-alert>
                        <i class="ti ti-info-circle me-2"></i>
                        <strong>Fully Editable:</strong> You can swap which group is labeled A vs B, and edit all match details (teams, times, locations) before confirming. The algorithm ensures teams play consecutive games with no conflicts.
                    </div>
                    <div class="alert alert-success mb-0" data-alert>
                        <i class="ti ti-calendar-check me-2"></i>
                        <strong>Best Practice - RSVP Timing:</strong> Generate the playoff schedule on Sunday night <em>before</em> the Monday 2am RSVP send. This way, RSVPs automatically send with correct team names. If you update after RSVPs were sent, you'll get an option to resend them.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Standings -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card shadow-sm">
                <div class="c-card__header bg-label-primary border-bottom py-3">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-trophy me-2"></i>Current Standings (Top 8 Qualify)
                    </h5>
                </div>
                <div class="c-card__body">
                    <div class="c-table-wrapper" data-table-responsive>
                        <table class="c-table c-table--hoverable playoff-standings-table" id="standingsTable" data-table>
                            <thead scope="col">
                                <tr>
                                    <th scope="col">Rank</th>
                                    <th scope="col">Team</th>
                                    <th scope="col">Points</th>
                                    <th scope="col">W-L-D</th>
                                    <th scope="col">GD</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for team in standings %}
                                <tr class="{% if loop.index <= 8 %}playoff-qualified{% endif %}">
                                    <td><strong>{{ loop.index }}</strong></td>
                                    <td><strong>{{ team.team_name }}</strong></td>
                                    <td>{{ team.points|default(0) }}</td>
                                    <td>{{ team.wins|default(0) }}-{{ team.losses|default(0) }}-{{ team.draws|default(0) }}</td>
                                    <td>{{ team.goal_difference|default(0) }}</td>
                                    <td>
                                        {% if loop.index <= 8 %}
                                        <span class="badge bg-success" data-badge>PLAYOFFS</span>
                                        {% else %}
                                        <span class="badge bg-secondary" data-badge>Eliminated</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate Button -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <button id="previewBtn" class="c-btn c-btn--primary c-btn--lg js-preview-schedule" data-action="preview-schedule">
                <i class="ti ti-wand me-2"></i> Generate Preview
            </button>
            <p class="text-muted mt-2 playoff-generate-help-text" id="generateHelpText">Generate a randomized playoff schedule for review</p>
            <div id="existingScheduleNote" class="alert alert-info mt-3 playoff-existing-schedule-note is-hidden" data-alert>
                <i class="ti ti-info-circle me-2"></i>
                <strong>Existing Schedule Loaded:</strong> The current playoff schedule is displayed below. You can edit it directly or click "Regenerate New Schedule" to create a new random bracket.
            </div>
        </div>
    </div>

    <!-- Preview Section (Hidden initially) -->
    <div id="previewSection" class="playoff-preview-section is-hidden">
        <hr class="my-4">
        <h4 class="mb-4"><i class="ti ti-eye me-2"></i> Schedule Preview</h4>

        <!-- Groups Display -->
        <div class="row mb-4">
            <div class="col-12 mb-3 text-center">
                <button class="c-btn c-btn--outline-secondary c-btn--sm js-swap-groups" data-action="swap-groups">
                    <i class="ti ti-switch-horizontal me-1"></i> Swap Groups A ↔ B
                </button>
                <p class="text-muted small mt-1 mb-0">Swap which group is labeled A vs B (updates all matches)</p>
            </div>
            <div class="col-md-6 mb-3">
                <div class="c-card shadow-sm border-primary playoff-group-card">
                    <div class="c-card__header bg-label-primary border-bottom py-3">
                        <h5 class="c-card__title mb-0">
                            <i class="ti ti-users me-2"></i> Group A
                        </h5>
                    </div>
                    <div class="c-card__body">
                        <ul id="groupAList" class="list-group list-group-flush playoff-group-list">
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="c-card shadow-sm border-info playoff-group-card">
                    <div class="c-card__header bg-label-info border-bottom py-3">
                        <h5 class="c-card__title mb-0">
                            <i class="ti ti-users me-2"></i> Group B
                        </h5>
                    </div>
                    <div class="c-card__body">
                        <ul id="groupBList" class="list-group list-group-flush playoff-group-list">
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Matches Display -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="c-card shadow-sm">
                    <div class="c-card__header bg-label-success border-bottom py-3">
                        <h5 class="c-card__title mb-0">
                            <i class="ti ti-calendar-event me-2"></i> Generated Playoff Matches
                        </h5>
                    </div>
                    <div class="c-card__body">
                        <div class="c-table-wrapper" data-table-responsive>
                            <table class="c-table c-table--hoverable playoff-matches-table c-playoff-matches-table" id="matchesTable" data-table>
                                <thead scope="col">
                                    <tr>
                                        <th scope="col">Week</th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Time</th>
                                        <th scope="col">Home Team</th>
                                        <th scope="col">Away Team</th>
                                        <th scope="col">Location</th>
                                        <th scope="col">Group</th>
                                    </tr>
                                </thead>
                                <tbody id="matchesTableBody" class="c-playoff-matches-table__body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Buttons -->
        <div class="row">
            <div class="col-12 text-center">
                <button class="c-btn c-btn--success c-btn--lg me-2 mb-2 js-confirm-schedule" data-action="confirm-schedule">
                    <i class="ti ti-check me-2"></i> Confirm & Apply This Schedule
                </button>
                <button class="c-btn c-btn--warning c-btn--lg me-2 mb-2 js-preview-schedule" data-action="preview-schedule">
                    <i class="ti ti-refresh me-2"></i> Regenerate (Discard Edits)
                </button>
                <button class="c-btn c-btn--outline-secondary c-btn--lg mb-2 js-cancel-preview" data-action="cancel-preview">
                    <i class="ti ti-x me-2"></i> Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock main_content %}

{% block custom_js %}
{{ super() }}
<script src="{{ url_for('static', filename='js/playoff-generator.js') }}?v={{ range(1, 1000000) | random }}"></script>

<!--
MIGRATION NOTE: Inline JavaScript has been extracted to /app/static/js/playoff-generator.js
All event handlers now use data-* attributes and .js-* classes for binding
Functions migrated:
- getCSRFToken()
- loadExistingSchedule()
- previewSchedule()
- displayPreview()
- confirmSchedule()
- cancelPreview()
- swapGroups()
- resendPlayoffRSVPs()

Event delegation replaces inline handlers:
- Button clicks now handled via .js-* classes with data-action attributes
- .js-preview-schedule → data-action="preview-schedule"
- .js-confirm-schedule → data-action="confirm-schedule"
- .js-cancel-preview → data-action="cancel-preview"
- .js-swap-groups → data-action="swap-groups"
- Match field edits → delegated change handlers on #matchesTableBody
-->

<script data-league-id="{{ league.id }}">
// Initialize playoff generator with league ID from data attribute
document.addEventListener('DOMContentLoaded', function() {
    const leagueId = document.currentScript.getAttribute('data-league-id');
    if (typeof initializePlayoffGenerator === 'function') {
        initializePlayoffGenerator(leagueId);
    }
});
</script>
{% endblock %}
