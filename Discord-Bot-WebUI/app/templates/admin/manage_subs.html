{% extends "base.html" %}

{% block title %}Manage Substitutes{% endblock %}

{% block custom_css %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
{% if not config.get('ASSETS_PRODUCTION_MODE') %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/manage-subs.css') }}">
{% endif %}
{% endblock %}

{% block main_content %}
<!-- Page Loader -->
<div id="page-loader" class="c-page-loader" data-component="page-loader">
    <span class="c-page-loader__spinner"></span>
</div>
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header with Breadcrumb -->
    <div class="c-admin-header" data-component="admin-header">
        <div class="c-admin-header__breadcrumb">
            <h4 class="fw-bold py-3 mb-3">
                <span class="text-muted fw-light">Admin / </span> Manage Substitutes
            </h4>
        </div>
    </div>

    <!-- Sub Management Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-admin-card" data-component="subs-card">
                <div class="c-admin-card__header">
                    <h5 class="c-admin-card__title">Substitute Player Pool</h5>
                    <div class="c-admin-card__actions">
                        <button type="button" class="c-btn c-btn--primary" data-bs-toggle="modal" data-bs-target="#assignSubModal" data-action="open-assign-modal">
                            <i class="ti ti-user-plus me-1"></i> Assign Substitute
                        </button>
                        <form action="{{ url_for('admin.cleanup_subs') }}" method="POST" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="c-btn c-btn--outline-secondary" data-action="cleanup-old-assignments">
                                <i class="ti ti-trash me-1"></i> Clean Up Old Assignments
                            </button>
                        </form>
                    </div>
                </div>
                <div class="c-admin-card__body">
                    <div class="c-table-wrapper" data-table-responsive>
                        <table id="subsTable" class="c-table c-table--striped c-table--hoverable border-top" data-table data-component="subs-table">
                            <thead scope="col">
                                <tr>
                                    <th scope="col">Player</th>
                                    <th scope="col">Primary Team</th>
                                    <th scope="col">Contact Info</th>
                                    <th scope="col">Current Assignments</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sub in subs %}
                                <tr data-player-id="{{ sub.id }}">
                                    <td>
                                        <div class="c-player-row" data-component="player-row">
                                            <div class="c-player-avatar c-player-avatar--sm" data-component="player-avatar">
                                                {% if sub.profile_picture_url %}
                                                    <img src="{{ sub.profile_picture_url }}" alt="{{ sub.name }}" class="c-player-avatar__image">
                                                {% else %}
                                                    <div class="c-player-avatar__initial">
                                                        {{ sub.name[:1]|upper }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="c-player-row__info">
                                                <span class="c-player-row__name">{{ sub.name }}</span>
                                                <small class="c-player-row__meta">ID: {{ sub.id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if sub.primary_team_name %}
                                            <span class="c-badge c-badge--primary" data-badge data-team-name="{{ sub.primary_team_name }}">{{ sub.primary_team_name }}</span>
                                        {% else %}
                                            <span class="c-badge c-badge--secondary" data-badge>No Primary Team</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="c-contact-info" data-component="contact-info">
                                            {% if sub.phone %}
                                                <span class="c-contact-info__item"><i class="ti ti-phone me-1"></i> {{ sub.phone }}</span>
                                            {% endif %}
                                            {% if sub.email %}
                                                <span class="c-contact-info__item"><i class="ti ti-mail me-1"></i> {{ sub.email }}</span>
                                            {% endif %}
                                            {% if sub.discord_id %}
                                                <span class="c-contact-info__item"><i class="ti ti-brand-discord me-1"></i> Connected</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="c-assignments-container" data-component="assignments-container" data-player-id="{{ sub.id }}">
                                            <div class="spinner-border spinner-border-sm text-primary u-hidden" role="status" data-spinner data-role="assignment-spinner">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <button class="c-btn c-btn--sm c-btn--outline-primary" data-action="load-assignments" data-player-id="{{ sub.id }}">
                                                <i class="ti ti-calendar-stats me-1"></i> View Assignments
                                            </button>
                                            <div class="c-assignments-list u-hidden" data-role="assignments-list"></div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <button type="button" class="c-btn c-btn--sm c-btn--icon-only c-btn--outline-secondary dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                                                <i class="ti ti-dots-vertical"></i>
                                            </button>
                                            <div class="dropdown-menu dropdown-menu-end" data-dropdown-menu>
                                                <a class="dropdown-item" href="{{ url_for('players.player_profile', player_id=sub.id) }}">
                                                    <i class="ti ti-user me-1"></i> View Profile
                                                </a>
                                                <a class="dropdown-item" href="#" data-action="assign-sub" data-player-id="{{ sub.id }}" data-player-name="{{ sub.name }}">
                                                    <i class="ti ti-user-plus me-1"></i> Assign to Match
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assign Sub Modal -->
<div class="modal c-modal fade" data-modal id="assignSubModal" tabindex="-1" aria-labelledby="assignSubModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered modal-lg c-modal__dialog--lg" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="assignSubModalLabel">
                    <i class="ti ti-user-plus me-2"></i>Assign Substitute
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="assignSubForm" action="{{ url_for('admin.assign_sub') }}" method="POST">
                <div class="modal-body c-modal__body p-4" data-modal-body>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="subPlayer" class="form-label fw-semibold">Substitute Player</label>
                            <select class="form-select" id="subPlayer" name="player_id" required data-form-select>
                                <option value="" selected disabled>Select a substitute player...</option>
                                {% for sub in subs %}
                                <option value="{{ sub.id }}">{{ sub.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="subMatch" class="form-label fw-semibold">Match</label>
                            <select class="form-select" id="subMatch" name="match_id" required data-form-select data-role="match-select">
                                <option value="" selected disabled>Select a match...</option>
                                {% for match in upcoming_matches %}
                                <option value="{{ match.id }}">{{ match.date.strftime('%a, %b %d') }} - {{ match.home_team.name }} vs {{ match.away_team.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="subTeam" class="form-label fw-semibold">Team</label>
                        <select class="form-select" id="subTeam" name="team_id" required disabled data-form-select data-role="team-select">
                            <option value="" selected disabled>Select a team for this match...</option>
                        </select>
                        <div class="form-text">
                            <i class="ti ti-info-circle me-1"></i> First select a match to see the available teams.
                        </div>
                    </div>
                </div>
                <div class="modal-footer c-modal__footer" data-modal-footer>
                    <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal">
                        <i class="ti ti-x me-1"></i>Cancel
                    </button>
                    <button type="submit" class="c-btn c-btn--primary" data-action="submit-assign-form">
                        <i class="ti ti-user-plus me-1"></i>Assign Substitute
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Assignments Modal -->
<div class="modal c-modal fade" data-modal id="viewAssignmentsModal" tabindex="-1" aria-labelledby="viewAssignmentsModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content shadow-lg border-0" data-modal-content>
            <div class="modal-header c-modal__header bg-primary text-white" data-modal-header>
                <h5 class="modal-title c-modal__title" id="viewAssignmentsModalLabel">
                    <i class="ti ti-calendar me-2"></i>Sub Assignments for <span id="assignmentsPlayerName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body c-modal__body p-4" data-modal-body>
                <div id="assignmentsList" class="c-assignment-list" data-component="assignment-list">
                    <!-- Dynamic content -->
                    <div class="text-center py-4 u-hidden" id="assignmentsLoading" data-role="assignments-loading">
                        <div class="spinner-border text-primary" role="status" data-spinner>
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading assignments...</p>
                    </div>
                    <div class="text-center py-4 u-hidden" id="assignmentsEmpty" data-role="assignments-empty">
                        <div class="avatar avatar-md mx-auto mb-3">
                            <div class="avatar-initial rounded-circle bg-label-secondary">
                                <i class="ti ti-calendar-off"></i>
                            </div>
                        </div>
                        <p>No active assignments found.</p>
                    </div>
                    <div id="assignmentsContent" data-role="assignments-content"></div>
                </div>
            </div>
            <div class="modal-footer c-modal__footer bg-light" data-modal-footer>
                <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal">
                    <i class="ti ti-x me-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}

<!-- External dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
    // Bootstrap data for JS
    window.subsPageData = {
        upcomingMatches: {{ upcoming_matches|tojson|safe }},
        csrfToken: '{{ csrf_token() }}'
    };
</script>
{% if not config.get('ASSETS_PRODUCTION_MODE') %}
<script src="{{ url_for('static', filename='custom_js/admin-manage-subs.js') }}"></script>

{% endif %}
{% endblock %}
