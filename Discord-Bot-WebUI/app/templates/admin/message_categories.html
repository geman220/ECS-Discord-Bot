{% extends "base.html" %}

{% block title %}Message Management - ECS Portal{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header -->
    <h4 class="fw-bold py-3 mb-3">
        <i class="ti ti-message-2 me-2"></i>Message Management
    </h4>

    <!-- Status Overview Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="avatar avatar-md me-2">
                            <div class="avatar-initial rounded bg-label-primary">
                                <i class="ti ti-message-2"></i>
                            </div>
                        </div>
                        <div>
                            <h5 class="mb-0">{{ categories|length }}</h5>
                            <small class="text-muted">Message Categories</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="avatar avatar-md me-2">
                            <div class="avatar-initial rounded bg-label-success">
                                <i class="ti ti-file-text"></i>
                            </div>
                        </div>
                        <div>
                            <h5 class="mb-0">{{ categories|map(attribute='templates')|map('length')|sum }}</h5>
                            <small class="text-muted">Total Templates</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="avatar avatar-md me-2">
                            <div class="avatar-initial rounded bg-label-warning">
                                <i class="ti ti-speakerphone"></i>
                            </div>
                        </div>
                        <div>
                            <h5 class="mb-0">{{ announcements|length }}</h5>
                            <small class="text-muted">Active Announcements</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="avatar avatar-md me-2">
                            <div class="avatar-initial rounded bg-label-info">
                                <i class="ti ti-brand-discord"></i>
                            </div>
                        </div>
                        <div>
                            <h5 class="mb-0">Discord Bot</h5>
                            <small class="text-muted">Test messaging</small>
                            <div class="text-xs text-primary">
                                <a href="{{ url_for('admin.discord_onboarding.admin_test_onboarding') }}" class="btn btn-xs btn-outline-info mt-1">
                                    <i class="ti ti-test-pipe me-1"></i>Test
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Card -->
    {% if not categories %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                        <div>
                            <h5 class="mb-1">Setup Discord Message System</h5>
                            <p class="text-muted mb-0">Initialize message templates for automated Discord bot communications</p>
                        </div>
                        <div>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#setupModal">
                                <i class="ti ti-settings me-1"></i>Initialize System
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Content Row -->
    <div class="row">
        <!-- Discord Bot Messages organized by League -->
        <div class="col-lg-8 mb-4">
            
            <!-- All Message Categories -->
            {% for category in categories %}
            <div class="card shadow-sm mb-4">
                <div class="card-header 
                    {% if 'ecs' in category.name.lower() or 'fc' in category.name.lower() %}bg-gradient-primary text-white
                    {% elif 'premier' in category.name.lower() or 'pub' in category.name.lower() %}bg-gradient-success text-white
                    {% elif 'classic' in category.name.lower() %}bg-gradient-warning text-white
                    {% else %}bg-gradient-info text-white{% endif %}">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            {% if 'ecs' in category.name.lower() or 'fc' in category.name.lower() %}
                                <i class="ti ti-shield me-2"></i>
                            {% elif 'premier' in category.name.lower() or 'pub' in category.name.lower() %}
                                <i class="ti ti-star me-2"></i>
                            {% elif 'classic' in category.name.lower() %}
                                <i class="ti ti-heart me-2"></i>
                            {% else %}
                                <i class="ti ti-world me-2"></i>
                            {% endif %}
                            {{ category.name }}
                        </h5>
                        <button type="button" class="btn btn-sm btn-light" 
                                onclick="createTemplate({{ category.id }}, '{{ category.name }}')"
                                data-bs-toggle="tooltip" title="Create New Template">
                            <i class="ti ti-plus me-1"></i>New Template
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% include 'admin/partials/template_section.html' %}
                    
                    <div class="alert alert-light border-start 
                        {% if 'ecs' in category.name.lower() or 'fc' in category.name.lower() %}border-primary border-4
                        {% elif 'premier' in category.name.lower() %}border-success border-4
                        {% elif 'classic' in category.name.lower() %}border-warning border-4
                        {% else %}border-info border-4{% endif %} mt-3">
                        <small><strong>Context:</strong> 
                        {% if 'ecs' in category.name.lower() or 'fc' in category.name.lower() %}
                            ECS FC division messages for competitive league players. Used for match communications and competitive announcements.
                        {% elif 'premier' in category.name.lower() %}
                            Premier division messages for competitive recreational players. Higher skill level, structured communication.
                        {% elif 'classic' in category.name.lower() %}
                            Classic division messages for casual recreational players. Welcoming tone, beginner-friendly communication.
                        {% else %}
                            System-wide messages used across all leagues. General communications that apply to all players.
                        {% endif %}
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}

            {% if not categories %}
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <div class="mb-4">
                        <i class="ti ti-message-off" style="font-size: 4rem; color: #d3d3d3;"></i>
                    </div>
                    <h5 class="text-muted">No Message Templates Found</h5>
                    <p class="text-muted mb-4">Initialize the message system to get started with Discord bot communications.</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#setupModal">
                        <i class="ti ti-settings me-1"></i>Initialize System
                    </button>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Website Announcements Sidebar -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="ti ti-speakerphone me-2"></i>Website Announcements
                    </h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="createAnnouncement()">
                        <i class="ti ti-plus"></i>
                    </button>
                </div>
                <div class="card-body">
                    {% if announcements %}
                        <div class="list-group list-group-flush">
                            {% for announcement in announcements[:3] %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ announcement.title }}</h6>
                                        <p class="text-muted small mb-0">
                                            {{ announcement.content[:60] }}{% if announcement.content|length > 60 %}...{% endif %}
                                        </p>
                                        <small class="text-muted">{{ announcement.created_at.strftime('%b %d, %Y') }}</small>
                                    </div>
                                    <div class="d-flex gap-1">
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="editAnnouncement({{ announcement.id }})" 
                                                data-bs-toggle="tooltip" title="Edit">
                                            <i class="ti ti-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteAnnouncement({{ announcement.id }})" 
                                                data-bs-toggle="tooltip" title="Delete">
                                            <i class="ti ti-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if announcements|length > 3 %}
                        <div class="text-center mt-3">
                            <small class="text-muted">Showing 3 of {{ announcements|length }} announcements</small>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="ti ti-speakerphone mb-3" style="font-size: 2rem; color: #d3d3d3;"></i>
                            <p class="text-muted mb-3">No announcements yet</p>
                            <button type="button" class="btn btn-sm btn-success" 
                                    onclick="createAnnouncement()">
                                <i class="ti ti-plus me-1"></i>Create Announcement
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="card shadow-sm mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="ti ti-bolt me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if categories %}
                        <a href="{{ url_for('admin.discord_onboarding.admin_test_onboarding') }}" class="btn btn-outline-info btn-sm">
                            <i class="ti ti-test-pipe me-1"></i>Test Welcome Message
                        </a>
                        {% endif %}
                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                onclick="createAnnouncement()">
                            <i class="ti ti-plus me-1"></i>Create Announcement
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Help Card -->
            <div class="card shadow-sm mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="ti ti-help-circle me-2"></i>Message System Guide
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <p class="small mb-2"><strong>Discord Templates</strong></p>
                        <ul class="small text-muted ps-3 mb-0">
                            <li>Automated welcome messages for new users</li>
                            <li>League-specific communication templates</li>
                            <li>System error and notification messages</li>
                        </ul>
                    </div>
                    <div>
                        <p class="small mb-2"><strong>Template Variables</strong></p>
                        <ul class="small text-muted ps-3 mb-0">
                            <li><code>{username}</code> - User's Discord name</li>
                            <li><code>{league_display_name}</code> - League name</li>
                            <li><code>{team_name}</code> - Team name</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="ti ti-eye me-2"></i>Message Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Template Modal -->
<div class="modal fade" id="editTemplateModal" tabindex="-1" aria-labelledby="editTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTemplateModalLabel">
                    <i class="ti ti-edit me-2"></i>Edit Message Template
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editTemplateForm">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" id="edit_template_id" name="template_id" value=""/>
                    
                    <!-- Template Name -->
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Template Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="2"></textarea>
                    </div>

                    <!-- Message Content -->
                    <div class="mb-3">
                        <label for="edit_message_content" class="form-label">Message Content</label>
                        <textarea class="form-control" id="edit_message_content" name="message_content" rows="8" required></textarea>
                        <div class="form-text">
                            Use variables like <code>{username}</code>, <code>{league_display_name}</code>, etc.
                        </div>
                    </div>

                    <!-- Variables Help -->
                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <h6 class="mb-2"><i class="ti ti-info-circle me-1"></i>Available Variables</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small><code>{username}</code> - User's Discord name</small><br>
                                        <small><code>{league_display_name}</code> - League name</small><br>
                                        <small><code>{team_name}</code> - Team name</small><br>
                                        <small><code>{match_date}</code> - Match date</small><br>
                                    </div>
                                    <div class="col-md-6">
                                        <small><code>{match_time}</code> - Match time</small><br>
                                        <small><code>{match_location}</code> - Match location</small><br>
                                        <small><code>{league_contact_info}</code> - Contact info</small><br>
                                        <small><code>{league_welcome_message}</code> - Welcome text</small><br>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Active Status -->
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="edit_is_active" name="is_active">
                        <label class="form-check-label" for="edit_is_active">
                            Active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-info" onclick="previewMessage()">
                        <i class="ti ti-eye me-1"></i>Preview
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="ti ti-device-floppy me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit/Create Announcement Modal -->
<div class="modal fade" id="announcementModal" tabindex="-1" aria-labelledby="announcementModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="announcementModalLabel">
                    <i class="ti ti-speakerphone me-2"></i>Create Announcement
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="announcementForm">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" id="announcement_id" name="announcement_id" value=""/>
                    
                    <!-- Title -->
                    <div class="mb-3">
                        <label for="announcement_title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="announcement_title" name="title" required>
                    </div>

                    <!-- Content -->
                    <div class="mb-3">
                        <label for="announcement_content" class="form-label">Content</label>
                        <textarea class="form-control" id="announcement_content" name="content" rows="4" required></textarea>
                    </div>

                    <!-- Type -->
                    <div class="mb-3">
                        <label for="announcement_type" class="form-label">Type</label>
                        <select class="form-select" id="announcement_type" name="type">
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="success">Success</option>
                            <option value="danger">Important</option>
                        </select>
                    </div>

                    <!-- Active Status -->
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="announcement_is_active" name="is_active" checked>
                        <label class="form-check-label" for="announcement_is_active">
                            Active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="ti ti-device-floppy me-1"></i>Save Announcement
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Template Modal -->
<div class="modal fade" id="createTemplateModal" tabindex="-1" aria-labelledby="createTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTemplateModalLabel">
                    <i class="ti ti-plus me-2"></i>Create New Template
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createTemplateForm">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" id="create_category_id" name="category_id" value=""/>
                    
                    <!-- Template Name -->
                    <div class="mb-3">
                        <label for="create_template_name" class="form-label">Template Name</label>
                        <input type="text" class="form-control" id="create_template_name" name="name" required>
                    </div>

                    <!-- Template Key -->
                    <div class="mb-3">
                        <label for="create_template_key" class="form-label">Template Key</label>
                        <input type="text" class="form-control" id="create_template_key" name="key" required>
                        <div class="form-text">Unique identifier for this template (e.g., welcome_message, league_info)</div>
                    </div>

                    <!-- Context/Usage -->
                    <div class="mb-3">
                        <label for="create_template_context" class="form-label">When is this message used?</label>
                        <select class="form-select" id="create_template_context" name="context">
                            <option value="">Select context...</option>
                            <option value="user_join">When user joins Discord server</option>
                            <option value="league_join">When user joins league channel</option>
                            <option value="match_reminder">24h before matches</option>
                            <option value="availability_request">Weekly availability collection</option>
                            <option value="sub_request">When substitutes are needed</option>
                            <option value="error_notification">When system errors occur</option>
                            <option value="maintenance">During system maintenance</option>
                            <option value="manual">Manual/API triggered</option>
                        </select>
                        <div class="form-text">This helps other admins understand when this message is sent</div>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label for="create_template_description" class="form-label">Description</label>
                        <textarea class="form-control" id="create_template_description" name="description" rows="2"></textarea>
                    </div>

                    <!-- Message Content -->
                    <div class="mb-3">
                        <label for="create_template_content" class="form-label">Message Content</label>
                        <textarea class="form-control" id="create_template_content" name="message_content" rows="8" required></textarea>
                        <div class="form-text">
                            Use variables like <code>{username}</code>, <code>{league_display_name}</code>, etc.
                        </div>
                    </div>

                    <!-- Variables Help -->
                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <h6 class="mb-2"><i class="ti ti-info-circle me-1"></i>Available Variables</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small><code>{username}</code> - User's Discord name</small><br>
                                        <small><code>{league_display_name}</code> - League name</small><br>
                                        <small><code>{team_name}</code> - Team name</small><br>
                                        <small><code>{match_date}</code> - Match date</small><br>
                                    </div>
                                    <div class="col-md-6">
                                        <small><code>{match_time}</code> - Match time</small><br>
                                        <small><code>{match_location}</code> - Match location</small><br>
                                        <small><code>{league_contact_info}</code> - Contact info</small><br>
                                        <small><code>{league_welcome_message}</code> - Welcome text</small><br>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Active Status -->
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="create_template_active" name="is_active" checked>
                        <label class="form-check-label" for="create_template_active">
                            Active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-info" onclick="previewNewTemplate()">
                        <i class="ti ti-eye me-1"></i>Preview
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="ti ti-device-floppy me-1"></i>Create Template
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCategoryModalLabel">
                    <i class="ti ti-edit me-2"></i>Edit Category
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCategoryForm">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" id="edit_category_id" name="category_id" value=""/>
                    
                    <!-- Category Name -->
                    <div class="mb-3">
                        <label for="edit_category_name" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="edit_category_name" name="name" required>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label for="edit_category_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_category_description" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="ti ti-device-floppy me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Setup Modal -->
<div class="modal fade" id="setupModal" tabindex="-1" aria-labelledby="setupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setupModalLabel">
                    <i class="ti ti-settings me-2"></i>Setup Message System
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <h6 class="alert-heading">
                        <i class="ti ti-info-circle me-2"></i>Initialize Message Templates
                    </h6>
                    <p class="mb-2">To set up the Discord bot message system, you need to run the initialization script.</p>
                </div>
                
                <div class="bg-light p-3 rounded mb-3">
                    <p class="mb-2"><strong>Run this command:</strong></p>
                    <code class="d-block">python initialize_message_config.py</code>
                </div>
                
                <p class="text-muted small mb-0">This will create:</p>
                <ul class="text-muted small">
                    <li>Default message categories (Onboarding, League, System)</li>
                    <li>Template messages for common scenarios</li>
                    <li>Database tables for message management</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_css %}
<style>
/* Discord preview styling */
.discord-preview {
    background-color: #36393f;
    color: #dcddde;
    border: 1px solid #202225;
    border-radius: 8px;
}

/* Card hover effect */
.shadow-sm {
    transition: all 0.2s ease;
}

.shadow-sm:hover {
    box-shadow: 0 0.25rem 1rem rgba(161, 172, 184, 0.45) !important;
}

/* Avatar styling */
.avatar {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 38px;
    width: 38px;
}

.avatar-md {
    height: 42px;
    width: 42px;
}

.avatar-initial {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.avatar-md .avatar-initial {
    font-size: 1.3rem;
}

.bg-label-primary {
    background-color: rgba(105, 108, 255, 0.16) !important;
    color: #696cff !important;
}

.bg-label-success {
    background-color: rgba(113, 221, 55, 0.16) !important;
    color: #71dd37 !important;
}

.bg-label-warning {
    background-color: rgba(255, 171, 0, 0.16) !important;
    color: #ffab00 !important;
}

.bg-label-info {
    background-color: rgba(3, 195, 236, 0.16) !important;
    color: #03c3ec !important;
}

/* Table hover effects */
.table-hover tbody tr:hover {
    background-color: rgba(105, 108, 255, 0.04);
}

/* Button icon sizing */
.btn-icon {
    padding: 0.4rem;
    width: calc(1.5rem + 0.8rem);
    height: calc(1.5rem + 0.8rem);
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-sm.btn-icon {
    padding: 0.25rem;
    width: calc(1.25rem + 0.5rem);
    height: calc(1.25rem + 0.5rem);
}

/* Modal z-index fix */
.modal {
    z-index: 1060 !important;
}

.modal-backdrop {
    z-index: 1055 !important;
}

/* League section gradients */
.bg-gradient-primary {
    background: linear-gradient(135deg, #696cff 0%, #4f46e5 100%) !important;
}

.bg-gradient-success {
    background: linear-gradient(135deg, #71dd37 0%, #22c55e 100%) !important;
}

.bg-gradient-info {
    background: linear-gradient(135deg, #03c3ec 0%, #0891b2 100%) !important;
}

/* Context indicators */
.context-indicator {
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

/* Mobile adaptations */
@media (max-width: 767.98px) {
    .table-responsive table {
        font-size: 0.875rem;
    }
    
    .btn-group .btn {
        padding: 0.25rem 0.5rem;
    }
}
</style>
{% endblock %}

{% block custom_js %}
<script src="{{ url_for('static', filename='js/message-management.js') }}"></script>
<script>
// Add CSRF token to meta tag for AJAX requests
if (!document.querySelector('meta[name="csrf-token"]')) {
    const meta = document.createElement('meta');
    meta.name = 'csrf-token';
    meta.content = '{{ csrf_token() }}';
    document.head.appendChild(meta);
}

// Template editing functions
window.editTemplate = function(templateId) {
    fetch(`/admin/messages/api/template/${templateId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('edit_template_id').value = templateId;
                document.getElementById('edit_name').value = data.name;
                document.getElementById('edit_description').value = data.description || '';
                document.getElementById('edit_message_content').value = data.message_content;
                document.getElementById('edit_is_active').checked = data.is_active;
                
                const modal = new bootstrap.Modal(document.getElementById('editTemplateModal'));
                modal.show();
            } else {
                showToast('Error', 'Failed to load template data', 'danger');
            }
        })
        .catch(error => {
            showToast('Error', 'Error loading template: ' + error.message, 'danger');
        });
};

// Handle template form submission
document.getElementById('editTemplateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const templateId = formData.get('template_id');
    
    fetch(`/admin/messages/api/template/${templateId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Success', 'Template updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editTemplateModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error', data.error || 'Failed to update template', 'danger');
        }
    })
    .catch(error => {
        showToast('Error', 'Error updating template: ' + error.message, 'danger');
    });
});

// Override previewMessage for modal use
window.previewMessage = function() {
    const messageContent = document.getElementById('edit_message_content').value;
    
    if (!messageContent.trim()) {
        showToast('Warning', 'Please enter message content to preview.', 'warning');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
    
    const sampleData = {
        username: 'SampleUser',
        league_display_name: 'Pub League Premier',
        league_welcome_message: 'Welcome to competitive soccer!',
        league_contact_info: 'Contact us at admin@ecsfc.com',
        team_name: 'Sample Team FC',
        match_date: 'Saturday, July 20th',
        match_time: '2:00 PM',
        match_location: 'North Field'
    };
    
    let preview = messageContent;
    for (const [key, value] of Object.entries(sampleData)) {
        const regex = new RegExp(`{${key}}`, 'g');
        preview = preview.replace(regex, value);
    }
    
    document.getElementById('previewContent').innerHTML = `
        <div class="mb-4">
            <h6 class="text-muted mb-3">Discord Message Preview:</h6>
            <div class="discord-preview p-4 rounded">
                <div style="white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">${escapeHtml(preview)}</div>
            </div>
        </div>
        <div class="mt-4">
            <h6 class="text-muted mb-2">Sample variables used:</h6>
            <div class="bg-light p-3 rounded">
                <pre class="mb-0 small">${JSON.stringify(sampleData, null, 2)}</pre>
            </div>
        </div>
    `;
};

// Announcement management functions
window.createAnnouncement = function() {
    document.getElementById('announcementModalLabel').innerHTML = '<i class="ti ti-speakerphone me-2"></i>Create Announcement';
    document.getElementById('announcementForm').reset();
    document.getElementById('announcement_id').value = '';
    document.getElementById('announcement_is_active').checked = true;
    
    const modal = new bootstrap.Modal(document.getElementById('announcementModal'));
    modal.show();
};

window.editAnnouncement = function(announcementId) {
    fetch(`/admin/announcements/api/${announcementId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('announcementModalLabel').innerHTML = '<i class="ti ti-edit me-2"></i>Edit Announcement';
                document.getElementById('announcement_id').value = announcementId;
                document.getElementById('announcement_title').value = data.title;
                document.getElementById('announcement_content').value = data.content;
                document.getElementById('announcement_type').value = data.type || 'info';
                document.getElementById('announcement_is_active').checked = data.is_active;
                
                const modal = new bootstrap.Modal(document.getElementById('announcementModal'));
                modal.show();
            } else {
                showToast('Error', 'Failed to load announcement data', 'danger');
            }
        })
        .catch(error => {
            showToast('Error', 'Error loading announcement: ' + error.message, 'danger');
        });
};

window.deleteAnnouncement = function(announcementId) {
    if (confirm('Are you sure you want to delete this announcement?')) {
        fetch(`/admin/announcements/api/${announcementId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Success', 'Announcement deleted successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error', data.error || 'Failed to delete announcement', 'danger');
            }
        })
        .catch(error => {
            showToast('Error', 'Error deleting announcement: ' + error.message, 'danger');
        });
    }
};

// Handle announcement form submission
document.getElementById('announcementForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const announcementId = formData.get('announcement_id');
    const isEdit = announcementId && announcementId !== '';
    
    const url = isEdit ? `/admin/announcements/api/${announcementId}` : '/admin/announcements/api/create';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Success', `Announcement ${isEdit ? 'updated' : 'created'} successfully!`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('announcementModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error', data.error || `Failed to ${isEdit ? 'update' : 'create'} announcement`, 'danger');
        }
    })
    .catch(error => {
        showToast('Error', `Error ${isEdit ? 'updating' : 'creating'} announcement: ` + error.message, 'danger');
    });
});

// Template creation functions
window.createTemplate = function(categoryId, categoryName) {
    document.getElementById('createTemplateModalLabel').innerHTML = `<i class="ti ti-plus me-2"></i>Create Template for ${categoryName}`;
    document.getElementById('createTemplateForm').reset();
    document.getElementById('create_category_id').value = categoryId;
    document.getElementById('create_template_active').checked = true;
    
    const modal = new bootstrap.Modal(document.getElementById('createTemplateModal'));
    modal.show();
};

// Handle create template form submission
document.getElementById('createTemplateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/admin/messages/api/template/create', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Success', 'Template created successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createTemplateModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error', data.error || 'Failed to create template', 'danger');
        }
    })
    .catch(error => {
        showToast('Error', 'Error creating template: ' + error.message, 'danger');
    });
});

// Category management functions
window.editCategory = function(categoryId, categoryName, categoryDescription) {
    document.getElementById('edit_category_id').value = categoryId;
    document.getElementById('edit_category_name').value = categoryName;
    document.getElementById('edit_category_description').value = categoryDescription;
    
    const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
    modal.show();
};

// Handle edit category form submission
document.getElementById('editCategoryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const categoryId = formData.get('category_id');
    
    fetch(`/admin/messages/api/category/${categoryId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Success', 'Category updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error', data.error || 'Failed to update category', 'danger');
        }
    })
    .catch(error => {
        showToast('Error', 'Error updating category: ' + error.message, 'danger');
    });
});

// Template status toggle
window.toggleTemplateStatus = function(templateId, isActive) {
    const formData = new FormData();
    formData.append('csrf_token', document.querySelector('meta[name="csrf-token"]').getAttribute('content'));
    formData.append('is_active', isActive);
    
    fetch(`/admin/messages/api/template/${templateId}/toggle`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const label = document.querySelector(`label[for="template_${templateId}_active"] small`);
            if (label) {
                label.textContent = isActive ? 'Active' : 'Inactive';
            }
            showToast('Success', `Template ${isActive ? 'activated' : 'deactivated'} successfully!`, 'success');
        } else {
            // Revert the toggle if it failed
            const toggle = document.getElementById(`template_${templateId}_active`);
            if (toggle) {
                toggle.checked = !isActive;
            }
            showToast('Error', data.error || 'Failed to toggle template status', 'danger');
        }
    })
    .catch(error => {
        // Revert the toggle if it failed
        const toggle = document.getElementById(`template_${templateId}_active`);
        if (toggle) {
            toggle.checked = !isActive;
        }
        showToast('Error', 'Error toggling template status: ' + error.message, 'danger');
    });
};

// Preview new template
window.previewNewTemplate = function() {
    const messageContent = document.getElementById('create_template_content').value;
    
    if (!messageContent.trim()) {
        showToast('Warning', 'Please enter message content to preview.', 'warning');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
    
    const sampleData = {
        username: 'SampleUser',
        league_display_name: 'Pub League Premier',
        league_welcome_message: 'Welcome to competitive soccer!',
        league_contact_info: 'Contact us at admin@ecsfc.com',
        team_name: 'Sample Team FC',
        match_date: 'Saturday, July 20th',
        match_time: '2:00 PM',
        match_location: 'North Field'
    };
    
    let preview = messageContent;
    for (const [key, value] of Object.entries(sampleData)) {
        const regex = new RegExp(`{${key}}`, 'g');
        preview = preview.replace(regex, value);
    }
    
    document.getElementById('previewContent').innerHTML = `
        <div class="mb-4">
            <h6 class="text-muted mb-3">Discord Message Preview:</h6>
            <div class="discord-preview p-4 rounded">
                <div style="white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">${escapeHtml(preview)}</div>
            </div>
        </div>
        <div class="mt-4">
            <h6 class="text-muted mb-2">Sample variables used:</h6>
            <div class="bg-light p-3 rounded">
                <pre class="mb-0 small">${JSON.stringify(sampleData, null, 2)}</pre>
            </div>
        </div>
    `;
};

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(title, message, type = 'info') {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}:</strong> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(container);
    }
    
    container.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = container.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}
</script>
{% endblock %}