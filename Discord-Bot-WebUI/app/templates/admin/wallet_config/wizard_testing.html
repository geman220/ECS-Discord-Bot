{# Styles moved to external CSS #}

<h5><i class="ti ti-test-pipe me-2"></i>Step 4: Testing and Verification</h5>

<div class="alert alert-info" data-alert>
    <div class="d-flex">
        <div class="me-3">
            <i class="ti ti-info-circle fs-3"></i>
        </div>
        <div>
            <h6 class="alert-heading">Validating Your Wallet Pass Configuration</h6>
            <p class="mb-0">This final step will verify your wallet pass configuration and ensure everything is working correctly. You'll be able to run tests, diagnose issues, and generate sample passes.</p>
        </div>
    </div>
</div>

<!-- Test Results -->
<div class="mb-4">
    <h6>Configuration Test Results</h6>

    {% if step_data.test_results %}
        <div class="c-card shadow-sm mb-3">
            <div class="c-card__header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Overall Status</h6>
                <div>
                    {% if step_data.test_results.configuration.configured %}
                        <span class="badge bg-label-success" data-badge><i class="ti ti-check me-1"></i>Configuration Complete</span>
                    {% else %}
                        <span class="badge bg-label-warning" data-badge><i class="ti ti-alert-triangle me-1"></i>Issues Found</span>
                    {% endif %}
                </div>
            </div>
            <div class="c-card__body">
                <div class="mb-4">
                    {% if step_data.test_results.configuration.configured %}
                        <div class="alert alert-success d-flex" data-alert>
                            <i class="ti ti-circle-check me-3 fs-4"></i>
                            <div>
                                <strong>Wallet pass system is properly configured!</strong>
                                <p class="mb-0">All required components are in place and working correctly.</p>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-warning d-flex" data-alert>
                            <i class="ti ti-alert-triangle me-3 fs-4"></i>
                            <div>
                                <strong>Configuration issues detected</strong>
                                <p class="mb-0">Please address the issues below to complete setup.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <h6 class="mb-3">Test Details</h6>

                {% for test in step_data.test_results.tests %}
                    <div class="test-result {{ test.status }}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">{{ test.name }}</h6>
                            <span class="badge bg-label-{{ test.status == 'passed' and 'success' or test.status == 'skipped' and 'warning' or test.status == 'info' and 'info' or 'danger' }}" data-badge>
                                <i class="ti ti-{{ test.status == 'passed' and 'check' or test.status == 'skipped' and 'clock' or test.status == 'info' and 'info-circle' or 'x' }} me-1"></i>
                                {{ test.status|capitalize }}
                            </span>
                        </div>
                        <p class="mb-0 small">{{ test.message }}</p>
                    </div>
                {% endfor %}
                
                {% if not step_data.test_results.configuration.configured %}
                    <div class="mt-3">
                        <h6>Issues to Resolve:</h6>
                        <ul class="text-danger">
                            {% for issue in step_data.test_results.configuration.issues %}
                                <li>{{ issue }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="c-card mb-3">
            <div class="c-card__body text-center py-5">
                <i class="ti ti-flask fs-1 mb-3 text-primary"></i>
                <h5>No Tests Run Yet</h5>
                <p class="mb-3">Run the configuration test to validate your setup</p>
                <a href="{{ url_for('wallet_config.test_config') }}" class="c-btn c-btn--primary">
                    <i class="ti ti-test-pipe me-1"></i> Run Configuration Tests
                </a>
            </div>
        </div>
    {% endif %}
</div>

<!-- Test Actions -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="c-card shadow-sm h-100">
            <div class="c-card__header">
                <h6 class="mb-0"><i class="ti ti-tools me-2"></i>Test Tools</h6>
            </div>
            <div class="c-card__body">
                <p class="mb-3">Use these tools to test your wallet pass configuration:</p>

                <a href="{{ url_for('wallet_config.test_config') }}" class="c-btn c-btn--primary d-block mb-2">
                    <i class="ti ti-test-pipe me-1"></i> Run Configuration Tests
                </a>

                <a href="{{ url_for('wallet_config.diagnostics') }}" class="c-btn c-btn--info d-block">
                    <i class="ti ti-stethoscope me-1"></i> Run Advanced Diagnostics
                </a>

                <div class="alert bg-body-tertiary border mt-3 mb-0" data-alert>
                    <h6><i class="ti ti-info-circle me-1"></i> What These Tools Do</h6>
                    <ul class="small mb-0">
                        <li><strong>Configuration Tests:</strong> Validates your basic setup</li>
                        <li><strong>Advanced Diagnostics:</strong> Provides detailed information about your configuration</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-3">
        <div class="c-card shadow-sm h-100">
            <div class="c-card__header">
                <h6 class="mb-0"><i class="ti ti-ticket me-2"></i>Sample Pass Generation</h6>
            </div>
            <div class="c-card__body">
                <p class="mb-3">Generate and test sample passes:</p>

                <a href="{{ url_for('wallet_admin.create_ecs_pass') }}" class="c-btn c-btn--success d-block mb-2">
                    <i class="ti ti-id me-1"></i> Create Sample ECS Pass
                </a>

                <a href="{{ url_for('wallet_admin.create_pub_league_pass') }}" class="c-btn c-btn--warning d-block mb-2">
                    <i class="ti ti-ball-football me-1"></i> Create Sample Pub League Pass
                </a>

                {% if step_data.test_results and step_data.test_results.configuration.configured %}
                    <div class="alert alert-success small mb-0" data-alert>
                        <i class="ti ti-circle-check me-1"></i> Your system is fully configured and ready for pass generation!
                    </div>
                {% else %}
                    <div class="alert alert-warning small mb-0" data-alert>
                        <i class="ti ti-alert-triangle me-1"></i> Complete all configuration steps before generating real passes.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Troubleshooting Guide -->
<div class="c-card shadow-sm">
    <div class="c-card__header">
        <h6 class="mb-0"><i class="ti ti-help-circle me-2"></i>Troubleshooting Guide</h6>
    </div>
    <div class="c-card__body">
        <div class="accordion" id="troubleshootingAccordion" data-accordion>
            <div class="accordion-item" data-accordion>
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#certificateIssues" data-collapse-toggle>
                        <i class="ti ti-certificate me-2"></i> Certificate Issues
                    </button>
                </h2>
                <div id="certificateIssues" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion" data-accordion>
                    <div class="accordion-body" data-accordion>
                        <h6>Common Certificate Problems</h6>
                        <ul class="small">
                            <li><strong>Wrong certificate format:</strong> Make sure you've uploaded the right format (.pem, .p12, etc.)</li>
                            <li><strong>Missing certificates:</strong> You need a certificate, private key, and WWDR certificate</li>
                            <li><strong>Expired certificates:</strong> Check if your Apple Developer certificates are still valid</li>
                            <li><strong>Wrong Team ID:</strong> Make sure your team identifier matches the one in your certificate</li>
                        </ul>
                        <h6 class="mt-3">How to Fix</h6>
                        <ol class="small">
                            <li>Re-download certificates from Apple Developer Portal</li>
                            <li>Convert certificates to the correct format using OpenSSL</li>
                            <li>Update your team identifier and pass type identifier</li>
                            <li>For detailed instructions, see the <a href="{{ url_for('wallet_config.certificates_help') }}">Certificate Help Guide</a></li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <div class="accordion-item" data-accordion>
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#assetIssues" data-collapse-toggle>
                        <i class="ti ti-photo me-2"></i> Asset Issues
                    </button>
                </h2>
                <div id="assetIssues" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion" data-accordion>
                    <div class="accordion-body" data-accordion>
                        <h6>Common Asset Problems</h6>
                        <ul class="small">
                            <li><strong>Wrong image dimensions:</strong> Images must be exactly the right size</li>
                            <li><strong>Incorrect file format:</strong> Most assets need to be PNG with transparency</li>
                            <li><strong>Missing required assets:</strong> Icon and logo are required at minimum</li>
                            <li><strong>File too large:</strong> Assets should be optimized and under size limits</li>
                        </ul>
                        <h6 class="mt-3">How to Fix</h6>
                        <ol class="small">
                            <li>Resize images to match exact dimensions required</li>
                            <li>Convert images to PNG format with transparency where needed</li>
                            <li>Optimize images to reduce file size</li>
                            <li>Upload at least the required icon and logo files</li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <div class="accordion-item" data-accordion>
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#templateIssues" data-collapse-toggle>
                        <i class="ti ti-file-text me-2"></i> Template Issues
                    </button>
                </h2>
                <div id="templateIssues" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion" data-accordion>
                    <div class="accordion-body" data-accordion>
                        <h6>Common Template Problems</h6>
                        <ul class="small">
                            <li><strong>Invalid JSON:</strong> Template content must be valid JSON</li>
                            <li><strong>Missing required fields:</strong> Some fields are required by Apple/Google</li>
                            <li><strong>No default template:</strong> At least one template must be set as default</li>
                            <li><strong>Wrong pass type identifiers:</strong> Make sure identifiers match certificates</li>
                        </ul>
                        <h6 class="mt-3">How to Fix</h6>
                        <ol class="small">
                            <li>Use the "Generate Default Template" button to create a valid template</li>
                            <li>Check for JSON syntax errors in your template</li>
                            <li>Ensure all required fields are included (pass type ID, serial number, etc.)</li>
                            <li>Set a template as default using the Visual Editor</li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <div class="accordion-item" data-accordion>
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#passIssues" data-collapse-toggle>
                        <i class="ti ti-ticket me-2"></i> Pass Generation Issues
                    </button>
                </h2>
                <div id="passIssues" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion" data-accordion>
                    <div class="accordion-body" data-accordion>
                        <h6>Common Pass Generation Problems</h6>
                        <ul class="small">
                            <li><strong>Pass won't open in Wallet app:</strong> Usually a certificate or format issue</li>
                            <li><strong>Missing information:</strong> Template fields aren't being populated</li>
                            <li><strong>Invalid barcode:</strong> Barcode data might be formatted incorrectly</li>
                            <li><strong>Pass expires immediately:</strong> Check validity date settings</li>
                        </ul>
                        <h6 class="mt-3">How to Fix</h6>
                        <ol class="small">
                            <li>Make sure your certificates match the identifiers in templates</li>
                            <li>Check for proper template variable placeholders (e.g., {{member_name}})</li>
                            <li>Verify barcode format and encoding settings</li>
                            <li>Use the diagnostic tools to check for specific errors</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="alert bg-body-tertiary border mt-4" data-alert>
    <div class="d-flex">
        <div class="me-3">
            <i class="ti ti-circle-check text-success fs-4"></i>
        </div>
        <div>
            <h6 class="mb-1">Setup Complete!</h6>
            <p class="mb-0">
                You've reached the end of the setup wizard. Once all tests pass successfully, your wallet pass system is ready to use!
                Return to the dashboard to start managing and issuing passes.
            </p>
        </div>
    </div>
</div>