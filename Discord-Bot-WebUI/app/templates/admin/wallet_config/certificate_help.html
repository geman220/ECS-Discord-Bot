{% extends 'admin/layout.html' %}
{% block title %}Wallet Certificate Setup Guide{% endblock %}

{% block custom_css %}
{{ super() }}
{# Styles moved to external CSS #}
{% endblock custom_css %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold text-primary mb-1">
                        <i class="ti ti-certificate me-2"></i>Wallet Certificate Setup Guide
                    </h2>
                    <p class="text-muted mb-0">Detailed instructions for configuring Apple and Google Wallet certificates</p>
                </div>
                <div>
                    <a href="{{ url_for('wallet_config.certificates') }}" class="c-btn c-btn--outline-secondary">
                        <i class="ti ti-arrow-left me-1"></i> Back to Certificates
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Guide Content -->
    <div class="row">
        <div class="col-12">
            <div class="c-card mb-4">
                <div class="c-card__header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Apple Wallet Certificate Setup</h5>
                </div>
                <div class="c-card__body">
                    <div class="alert alert-info" data-alert>
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="ti ti-info-circle fs-3"></i>
                            </div>
                            <div>
                                <h6 class="alert-heading">Prerequisites</h6>
                                <p class="mb-0">Before proceeding, you'll need:</p>
                                <ul class="mb-0">
                                    <li>An active Apple Developer account</li>
                                    <li>Access to the Apple Developer portal</li>
                                    <li>A Mac computer for some steps (especially for certificate creation)</li>
                                    <li>OpenSSL installed (for certificate conversion)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="step-container">
                        <h5>Step 1: Create a Pass Type ID in Apple Developer Portal</h5>
                        <ol>
                            <li>Log in to the <a href="https://developer.apple.com/account/" target="_blank">Apple Developer Portal</a> with your developer account</li>
                            <li>Click on "Certificates, IDs & Profiles" in the left sidebar</li>
                            <li>Under "Identifiers" section, click the "+" button to create a new identifier</li>
                            <li>Select "Pass Type IDs" and click "Continue"</li>
                            <li>Enter a description (e.g., "ECS Membership Passes")</li>
                            <li>Enter a Pass Type ID (e.g., "pass.com.ecsfc.membership")</li>
                            <li>The format must be "pass." followed by a reverse-domain identifier</li>
                            <li>Click "Register" to create the Pass Type ID</li>
                        </ol>
                        
                        <div class="note-box">
                            <h6><i class="ti ti-note me-1"></i> Important Note</h6>
                            <p class="mb-0">Make sure to remember your Pass Type ID as you'll need it for your pass configuration. It should match the passTypeIdentifier in your pass templates.</p>
                        </div>
                    </div>

                    <div class="step-container">
                        <h5>Step 2: Create a Pass Type Certificate</h5>
                        <ol>
                            <li>In the Certificates, IDs & Profiles section, select "Certificates" from the sidebar</li>
                            <li>Click the "+" button to add a new certificate</li>
                            <li>Under "Services," select "Pass Type ID Certificate" and click "Continue"</li>
                            <li>Select the Pass Type ID you created in Step 1 and click "Continue"</li>
                            <li>You'll be prompted to create a Certificate Signing Request (CSR):</li>
                        </ol>
                        
                        <div class="c-card mb-3">
                            <div class="c-card__header">
                                <h6 class="mb-0">Creating a Certificate Signing Request (CSR) on macOS</h6>
                            </div>
                            <div class="c-card__body">
                                <ol>
                                    <li>Open Keychain Access (in Applications > Utilities)</li>
                                    <li>From the menu bar, select Keychain Access > Certificate Assistant > Request a Certificate from a Certificate Authority</li>
                                    <li>Enter your email address and common name (usually your name)</li>
                                    <li>Select "Saved to disk" and check "Let me specify key pair information"</li>
                                    <li>Click "Continue"</li>
                                    <li>Set Key Size to 2048 bits and Algorithm to RSA</li>
                                    <li>Click "Continue" and save the CSR file to your desktop</li>
                                </ol>
                            </div>
                        </div>
                        
                        <div class="c-card mb-3">
                            <div class="c-card__header">
                                <h6 class="mb-0">Creating a CSR using OpenSSL (Linux/Windows)</h6>
                            </div>
                            <div class="c-card__body">
                                <p>Run the following commands in a terminal:</p>
                                <div class="code-block">
                                    # Generate a private key
                                    openssl genrsa -out mykey.key 2048
                                    
                                    # Create the CSR from the private key
                                    openssl req -new -key mykey.key -out mycsr.certSigningRequest
                                </div>
                                <p>When prompted, enter your details. Common Name should be your name or organization name.</p>
                            </div>
                        </div>
                        
                        <ol start="6">
                            <li>Upload the CSR file you created to the Apple Developer Portal</li>
                            <li>Click "Continue" and then "Download" to get your certificate (will be a .cer file)</li>
                        </ol>
                    </div>

                    <div class="step-container">
                        <h5>Step 3: Download Apple WWDR Certificate</h5>
                        <ol>
                            <li>Go to <a href="https://www.apple.com/certificateauthority/" target="_blank">Apple's Certificate Authority</a></li>
                            <li>In the "Apple Worldwide Developer Relations Certification Authority" section</li>
                            <li>Download the "Apple Worldwide Developer Relations Certification Authority G4" certificate</li>
                            <li>Save the file (AppleWWDRCAG4.cer) to your computer</li>
                        </ol>
                    </div>
                    
                    <div class="step-container">
                        <h5>Step 4: Convert Certificates to PEM Format</h5>
                        
                        <div class="tip-box">
                            <h6><i class="ti ti-bulb me-1"></i> Why Convert?</h6>
                            <p class="mb-0">Apple provides certificates in .cer format, but our wallet pass system needs them in .pem format for proper signing.</p>
                        </div>
                        
                        <p>Run the following OpenSSL commands in a terminal window:</p>
                        
                        <div class="code-block">
                            # Convert the pass type certificate from .cer to .pem
                            openssl x509 -in PassTypeID.cer -inform DER -out certificate.pem -outform PEM
                            
                            # Convert the WWDR certificate from .cer to .pem
                            openssl x509 -in AppleWWDRCAG4.cer -inform DER -out wwdr.pem -outform PEM
                            
                            # Export your private key from the Keychain (macOS)
                            # If you created the CSR using OpenSSL, you already have the key.key file
                            openssl pkcs12 -export -out passkey.p12 -inkey mykey.key -in certificate.pem
                            
                            # Convert the .p12 file to .pem
                            openssl pkcs12 -in passkey.p12 -nodes -out key.pem
                        </div>
                        
                        <p>After running these commands, you should have three key files:</p>
                        <ul>
                            <li><strong>certificate.pem</strong>: Your Pass Type ID certificate</li>
                            <li><strong>key.pem</strong>: Your private key</li>
                            <li><strong>wwdr.pem</strong>: The Apple WWDR certificate</li>
                        </ul>
                    </div>
                    
                    <div class="step-container">
                        <h5>Step 5: Upload Certificates to Wallet Pass System</h5>
                        <ol>
                            <li>Go to the Certificates page in the Wallet Configuration dashboard</li>
                            <li>Upload each of the three PEM files separately:
                                <ul>
                                    <li>For <strong>certificate.pem</strong>, select "Certificate" as type</li>
                                    <li>For <strong>key.pem</strong>, select "Private Key" as type</li>
                                    <li>For <strong>wwdr.pem</strong>, select "WWDR Certificate" as type</li>
                                </ul>
                            </li>
                            <li>Enter your Apple Developer Team ID and Pass Type ID in the respective fields</li>
                            <li>The Team ID can be found in your Apple Developer account under Membership</li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <div class="c-card mb-4">
                <div class="c-card__header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Google Wallet Certificate Setup</h5>
                </div>
                <div class="c-card__body">
                    <div class="alert alert-info" data-alert>
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="ti ti-info-circle fs-3"></i>
                            </div>
                            <div>
                                <h6 class="alert-heading">Prerequisites</h6>
                                <p class="mb-0">Before proceeding, you'll need:</p>
                                <ul class="mb-0">
                                    <li>A Google Cloud account</li>
                                    <li>A Google Wallet API project</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="step-container">
                        <h5>Step 1: Create a Google Cloud Project</h5>
                        <ol>
                            <li>Go to the <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></li>
                            <li>Click on the project dropdown at the top of the page</li>
                            <li>Click "New Project" and enter a name (e.g., "ECS Wallet Passes")</li>
                            <li>Click "Create" to create the new project</li>
                            <li>Make sure your new project is selected in the project dropdown</li>
                        </ol>
                    </div>
                    
                    <div class="step-container">
                        <h5>Step 2: Enable the Google Wallet API</h5>
                        <ol>
                            <li>In the Google Cloud Console, click "APIs & Services" > "Library"</li>
                            <li>Search for "Google Wallet API"</li>
                            <li>Click on the API from the search results</li>
                            <li>Click "Enable" to enable the API for your project</li>
                        </ol>
                    </div>
                    
                    <div class="step-container">
                        <h5>Step 3: Create a Service Account</h5>
                        <ol>
                            <li>In the Google Cloud Console, go to "IAM & Admin" > "Service Accounts"</li>
                            <li>Click "Create Service Account"</li>
                            <li>Enter a name (e.g., "wallet-pass-service") and description</li>
                            <li>Click "Create and Continue"</li>
                            <li>For the role, select "Google Wallet API" > "Wallet Object Issuer"</li>
                            <li>Click "Continue" and then "Done"</li>
                        </ol>
                    </div>
                    
                    <div class="step-container">
                        <h5>Step 4: Create and Download Service Account Key</h5>
                        <ol>
                            <li>In the Service Accounts list, click on the service account you just created</li>
                            <li>Go to the "Keys" tab</li>
                            <li>Click "Add Key" > "Create New Key"</li>
                            <li>Select "JSON" as the key type</li>
                            <li>Click "Create" to download the JSON key file</li>
                            <li>Save this file securely - it contains your Google Cloud credentials</li>
                        </ol>
                        
                        <div class="note-box">
                            <h6><i class="ti ti-note me-1"></i> Important Note</h6>
                            <p class="mb-0">Keep your service account key secure. Anyone with this key can access your Google Wallet resources.</p>
                        </div>
                    </div>
                    
                    <div class="step-container">
                        <h5>Step 5: Set Up Your Wallet Issuer Account</h5>
                        <ol>
                            <li>Go to the <a href="https://pay.google.com/business/console/" target="_blank">Google Pay and Wallet Console</a></li>
                            <li>Sign in with the same Google account you used for Google Cloud</li>
                            <li>Follow the prompts to set up your issuer account</li>
                            <li>Once set up, you'll receive an Issuer ID</li>
                        </ol>
                    </div>
                    
                    <div class="step-container">
                        <h5>Step 6: Upload Credentials to Wallet Pass System</h5>
                        <ol>
                            <li>Go to the Certificates page in the Wallet Configuration dashboard</li>
                            <li>In the Google Wallet section, select "Credentials" as type</li>
                            <li>Upload the JSON key file you downloaded in Step 4</li>
                            <li>Enter the Issuer ID from Step 5</li>
                            <li>Click "Upload Credentials" to complete the setup</li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <div class="c-card mb-4">
                <div class="c-card__header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Troubleshooting Certificate Issues</h5>
                </div>
                <div class="c-card__body">
                    <div class="accordion" id="certificateTroubleshooting" data-accordion>
                        <div class="accordion-item" data-accordion>
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#error1" data-collapse-toggle>
                                    "Could not read certificate" or "Invalid certificate format"
                                </button>
                            </h2>
                            <div id="error1" class="accordion-collapse collapse" data-bs-parent="#certificateTroubleshooting" data-accordion>
                                <div class="accordion-body" data-accordion>
                                    <p><strong>Problem:</strong> The certificate file is not in the expected format or is corrupted.</p>
                                    <p><strong>Solution:</strong></p>
                                    <ol>
                                        <li>Make sure you've converted the certificate to PEM format</li>
                                        <li>Check if the certificate file starts with "-----BEGIN CERTIFICATE-----"</li>
                                        <li>Verify the certificate conversion commands:</li>
                                        <div class="code-block">
                                            openssl x509 -in YourCertificate.cer -inform DER -out certificate.pem -outform PEM
                                        </div>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item" data-accordion>
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#error2" data-collapse-toggle>
                                    "Private key does not match certificate" or "Key verification failed"
                                </button>
                            </h2>
                            <div id="error2" class="accordion-collapse collapse" data-bs-parent="#certificateTroubleshooting" data-accordion>
                                <div class="accordion-body" data-accordion>
                                    <p><strong>Problem:</strong> The private key doesn't correspond to the certificate.</p>
                                    <p><strong>Solution:</strong></p>
                                    <ol>
                                        <li>Make sure you're using the private key that was used to generate the CSR</li>
                                        <li>If you created the CSR using Keychain Access, export the private key:</li>
                                        <div class="code-block">
                                            # Export the key pair from Keychain
                                            security export -k login.keychain -t certs -f pkcs12 -o passkey.p12 -n "Your Certificate Name"
                                            
                                            # Convert to PEM format
                                            openssl pkcs12 -in passkey.p12 -nodes -out key.pem
                                        </div>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item" data-accordion>
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#error3" data-collapse-toggle>
                                    "Pass generation fails" or "Unable to sign pass"
                                </button>
                            </h2>
                            <div id="error3" class="accordion-collapse collapse" data-bs-parent="#certificateTroubleshooting" data-accordion>
                                <div class="accordion-body" data-accordion>
                                    <p><strong>Problem:</strong> Pass signing fails due to certificate configuration issues.</p>
                                    <p><strong>Solution:</strong></p>
                                    <ol>
                                        <li>Verify all three certificates are properly uploaded (certificate, key, and WWDR)</li>
                                        <li>Check that the Team ID and Pass Type ID in the configuration match your Apple Developer account</li>
                                        <li>Make sure the passTypeIdentifier in your pass template matches your registered Pass Type ID</li>
                                        <li>Try regenerating and reuploading all certificates</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item" data-accordion>
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#error4" data-collapse-toggle>
                                    "Google Wallet API not authorized" or "Service account issues"
                                </button>
                            </h2>
                            <div id="error4" class="accordion-collapse collapse" data-bs-parent="#certificateTroubleshooting" data-accordion>
                                <div class="accordion-body" data-accordion>
                                    <p><strong>Problem:</strong> Google Wallet API authorization issues.</p>
                                    <p><strong>Solution:</strong></p>
                                    <ol>
                                        <li>Verify the Google Wallet API is enabled in your Google Cloud project</li>
                                        <li>Check that your service account has the "Wallet Object Issuer" role</li>
                                        <li>Make sure the Issuer ID entered matches your Google Pay and Wallet Console</li>
                                        <li>Verify the service account JSON file is valid and not corrupted</li>
                                        <li>Check if your Google Cloud project is linked to your Google Wallet issuer account</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}