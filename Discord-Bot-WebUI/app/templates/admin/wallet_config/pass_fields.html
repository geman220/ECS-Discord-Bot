{% extends 'admin/layout.html' %}
{% block title %}Wallet Pass Fields - {{ pass_type.name }}{% endblock %}

{% block custom_css %}
{{ super() }}
<style>
    .field-card {
        transition: all 0.2s;
        cursor: grab;
    }
    .field-card:hover {
        box-shadow: var(--bs-box-shadow);
    }
    .field-inactive {
        opacity: 0.5;
    }
    .field-location-badge {
        font-size: 0.7rem;
        text-transform: uppercase;
    }
    .template-variable {
        font-family: monospace;
        background: var(--bs-light);
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-1">
                <i class="ti ti-forms me-2"></i>{{ pass_type.name }} - Field Configuration
            </h2>
            <p class="text-muted mb-0">Configure which fields appear on passes and their content</p>
        </div>
        <div>
            <a href="{{ url_for('wallet_config.pass_design', pass_type=pass_type_code) }}" class="c-btn c-btn--outline-secondary me-2">
                <i class="ti ti-arrow-left me-1"></i> Back to Design
            </a>
            <a href="{{ url_for('wallet_admin.wallet_management') }}" class="c-btn c-btn--outline-secondary">
                <i class="ti ti-layout-dashboard me-1"></i> Dashboard
            </a>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info mb-4" data-alert>
        <div class="d-flex">
            <i class="ti ti-info-circle me-2 fs-4"></i>
            <div>
                <strong>Apple Wallet Field Limits</strong>
                <p class="mb-0 mt-1">
                    Apple Wallet has specific field limits: <strong>1 primary</strong>, <strong>4 secondary</strong>, <strong>4 auxiliary</strong>, and <strong>3 header</strong> fields.
                    Use template variables like <code>{% raw %}{{member_name}}{% endraw %}</code> for dynamic content.
                </p>
            </div>
        </div>
    </div>

    <form action="{{ url_for('wallet_config.save_pass_fields', pass_type=pass_type_code) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="row">
            <!-- Front Fields -->
            <div class="col-lg-6 mb-4">
                <div class="c-card">
                    <div class="c-card__header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="ti ti-credit-card me-2"></i>Front of Pass</h5>
                    </div>
                    <div class="c-card__body">
                        {% if front_fields %}
                            {% for field in front_fields %}
                            <div class="field-card c-card mb-3 {% if not field.is_visible %}field-inactive{% endif %}">
                                <div class="c-card__body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <input type="checkbox" class="form-check-input"
                                                   name="front_field_visible" value="{{ field.field_key }}"
                                                   {% if field.is_visible %}checked{% endif %}>
                                        </div>
                                        <div class="col">
                                            <input type="hidden" name="front_field_key" value="{{ field.field_key }}">
                                            <div class="row g-2">
                                                <div class="col-md-3">
                                                    <input type="text" class="form-control form-control-sm"
                                                           name="front_field_label" value="{{ field.label }}"
                                                           placeholder="Label" data-form-control>
                                                </div>
                                                <div class="col-md-3">
                                                    <select class="form-select form-select-sm" name="front_field_location" data-form-select>
                                                        <option value="primary" {% if field.field_location == 'primary' %}selected{% endif %}>Primary</option>
                                                        <option value="secondary" {% if field.field_location == 'secondary' %}selected{% endif %}>Secondary</option>
                                                        <option value="auxiliary" {% if field.field_location == 'auxiliary' %}selected{% endif %}>Auxiliary</option>
                                                        <option value="header" {% if field.field_location == 'header' %}selected{% endif %}>Header</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control form-control-sm"
                                                           name="front_field_template" value="{{ field.value_template or '' }}"
                                                           placeholder="Value template" data-form-control>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4 text-muted">
                                <i class="ti ti-forms fs-1"></i>
                                <p class="mt-2">No front fields configured. Default fields will be used.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Back Fields -->
            <div class="col-lg-6 mb-4">
                <div class="c-card">
                    <div class="c-card__header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="ti ti-flip-horizontal me-2"></i>Back of Pass</h5>
                    </div>
                    <div class="c-card__body">
                        {% if back_fields %}
                            {% for field in back_fields %}
                            <div class="field-card c-card mb-3 {% if not field.is_visible %}field-inactive{% endif %}">
                                <div class="c-card__body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <input type="checkbox" class="form-check-input"
                                                   name="back_field_visible" value="{{ field.field_key }}"
                                                   {% if field.is_visible %}checked{% endif %}>
                                        </div>
                                        <div class="col">
                                            <input type="hidden" name="back_field_key" value="{{ field.field_key }}">
                                            <div class="row g-2">
                                                <div class="col-md-4">
                                                    <input type="text" class="form-control form-control-sm"
                                                           name="back_field_label" value="{{ field.label }}"
                                                           placeholder="Label" data-form-control>
                                                </div>
                                                <div class="col-md-8">
                                                    <textarea class="form-control form-control-sm"
                                                              name="back_field_value" rows="1"
                                                              placeholder="Content" data-form-control>{{ field.value }}</textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4 text-muted">
                                <i class="ti ti-file-text fs-1"></i>
                                <p class="mt-2">No back fields configured. Default fields will be used.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Available Variables -->
        <div class="c-card mb-4">
            <div class="c-card__header">
                <h5 class="mb-0"><i class="ti ti-variable me-2"></i>Available Template Variables</h5>
            </div>
            <div class="c-card__body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <code class="template-variable">{% raw %}{{member_name}}{% endraw %}</code>
                        <small class="d-block text-muted">Member's full name</small>
                    </div>
                    <div class="col-md-3 mb-2">
                        <code class="template-variable">{% raw %}{{validity}}{% endraw %}</code>
                        <small class="d-block text-muted">Membership year/season</small>
                    </div>
                    <div class="col-md-3 mb-2">
                        <code class="template-variable">{% raw %}{{team_name}}{% endraw %}</code>
                        <small class="d-block text-muted">Player's team (Pub League)</small>
                    </div>
                    <div class="col-md-3 mb-2">
                        <code class="template-variable">{% raw %}{{member_since}}{% endraw %}</code>
                        <small class="d-block text-muted">Year joined</small>
                    </div>
                    <div class="col-md-3 mb-2">
                        <code class="template-variable">{% raw %}{{subgroup}}{% endraw %}</code>
                        <small class="d-block text-muted">Supporter subgroup (ECS)</small>
                    </div>
                    <div class="col-md-3 mb-2">
                        <code class="template-variable">{% raw %}{{barcode_data}}{% endraw %}</code>
                        <small class="d-block text-muted">Unique barcode value</small>
                    </div>
                    <div class="col-md-3 mb-2">
                        <code class="template-variable">{% raw %}{{serial_number}}{% endraw %}</code>
                        <small class="d-block text-muted">Unique pass ID</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit -->
        <div class="d-flex justify-content-between">
            <a href="{{ url_for('wallet_config.pass_design', pass_type=pass_type_code) }}" class="c-btn c-btn--outline-secondary">
                <i class="ti ti-x me-1"></i> Cancel
            </a>
            <button type="submit" class="c-btn c-btn--primary">
                <i class="ti ti-device-floppy me-1"></i> Save Field Configuration
            </button>
        </div>
    </form>
</div>
{% endblock %}
