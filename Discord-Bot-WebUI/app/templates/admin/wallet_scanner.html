{% extends 'admin/layout.html' %}
{% block title %}Pass Scanner{% endblock %}

{% block custom_css %}
<style>
    /* Scanner - Theme-aware styling */
    .scanner-container {
        max-width: 100%;
    }

    #scanner-video {
        width: 100%;
        max-height: 350px;
        border-radius: 8px;
        background: var(--bs-dark);
    }

    .scanner-overlay {
        position: relative;
    }

    .scanner-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 200px;
        border: 3px solid rgba(255,255,255,0.8);
        border-radius: 8px;
        pointer-events: none;
    }

    .scanner-frame::before,
    .scanner-frame::after {
        content: '';
        position: absolute;
        width: 25px;
        height: 25px;
        border-color: var(--bs-success);
        border-style: solid;
    }

    .scanner-frame::before {
        top: -3px;
        left: -3px;
        border-width: 4px 0 0 4px;
        border-radius: 8px 0 0 0;
    }

    .scanner-frame::after {
        bottom: -3px;
        right: -3px;
        border-width: 0 4px 4px 0;
        border-radius: 0 0 8px 0;
    }

    .result-card.valid {
        border-color: var(--bs-success) !important;
        background: var(--bs-success-bg-subtle);
    }

    .result-card.invalid {
        border-color: var(--bs-danger) !important;
        background: var(--bs-danger-bg-subtle);
    }

    .scan-history-item {
        padding: 12px;
        border-left: 4px solid;
        margin-bottom: 8px;
        border-radius: 0 8px 8px 0;
        background: var(--bs-tertiary-bg);
    }

    .scan-history-item.valid {
        border-left-color: var(--bs-success);
    }

    .scan-history-item.invalid {
        border-left-color: var(--bs-danger);
    }

    .beep-success {
        animation: pulse-green 0.5s ease;
    }

    .beep-error {
        animation: pulse-red 0.5s ease;
    }

    @keyframes pulse-green {
        0%, 100% { box-shadow: 0 0 0 0 rgba(var(--bs-success-rgb), 0); }
        50% { box-shadow: 0 0 0 15px rgba(var(--bs-success-rgb), 0.3); }
    }

    @keyframes pulse-red {
        0%, 100% { box-shadow: 0 0 0 0 rgba(var(--bs-danger-rgb), 0); }
        50% { box-shadow: 0 0 0 15px rgba(var(--bs-danger-rgb), 0.3); }
    }

    .stat-box {
        padding: 16px;
        border-radius: 8px;
        text-align: center;
    }
    .stat-box.valid { background: var(--bs-success-bg-subtle); }
    .stat-box.invalid { background: var(--bs-danger-bg-subtle); }
    .stat-box.total { background: var(--bs-tertiary-bg); }
</style>
{% endblock custom_css %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h2 class="fw-bold text-primary mb-1">
                        <i class="ti ti-qrcode me-2"></i>Pass Scanner
                    </h2>
                    <p class="text-muted mb-0">Scan digital wallet passes to validate membership and record check-ins</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('wallet_admin.checkins_list') }}" class="btn btn-outline-secondary">
                        <i class="ti ti-list-check me-1"></i>Check-in History
                    </a>
                    <a href="{{ url_for('wallet_admin.passes_list') }}" class="btn btn-outline-secondary">
                        <i class="ti ti-arrow-left me-1"></i>Back to Passes
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Scanner Column -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="ti ti-scan me-2"></i>Scan Pass
                    </h5>
                </div>
                <div class="card-body">
                    <div class="scanner-container">
                        <!-- Scanner Video -->
                        <div class="scanner-overlay mb-3">
                            <video id="scanner-video" playsinline></video>
                            <div class="scanner-frame"></div>
                        </div>

                        <!-- Scanner Controls -->
                        <div class="d-flex gap-2 mb-4">
                            <button id="start-scanner" class="btn btn-primary flex-grow-1">
                                <i class="ti ti-scan me-1"></i>Start Camera
                            </button>
                            <button id="stop-scanner" class="btn btn-outline-secondary" disabled>
                                <i class="ti ti-player-stop me-1"></i>Stop
                            </button>
                        </div>

                        <!-- Manual Entry -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="ti ti-keyboard me-1"></i>Manual Entry
                            </label>
                            <div class="input-group">
                                <input type="text" id="manual-barcode" class="form-control"
                                       placeholder="Enter pass barcode (e.g., ECS-2025-ABC123)">
                                <button class="btn btn-primary" id="manual-submit">
                                    <i class="ti ti-check me-1"></i>Validate
                                </button>
                            </div>
                            <small class="text-muted">Type or paste the barcode if camera scanning isn't available</small>
                        </div>

                        <!-- Options -->
                        <div class="card bg-body-tertiary border-0">
                            <div class="card-body py-3">
                                <div class="mb-3">
                                    <label class="form-label small text-muted mb-1">Event Name (optional)</label>
                                    <input type="text" id="event-name" class="form-control form-control-sm"
                                           placeholder="e.g., Match vs Seattle Sounders">
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="auto-checkin" checked>
                                    <label class="form-check-label" for="auto-checkin">
                                        Automatically record check-in for valid passes
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Result & History Column -->
        <div class="col-lg-6">
            <!-- Latest Scan Result -->
            <div class="card mb-4 result-card" id="result-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="ti ti-user-check me-2"></i>Scan Result
                    </h5>
                </div>
                <div class="card-body" id="result-body">
                    <div class="text-center text-muted py-5">
                        <i class="ti ti-qrcode mb-2" style="font-size: 3rem;"></i>
                        <p class="mb-0">Scan a pass to see validation results</p>
                    </div>
                </div>
            </div>

            <!-- Session Stats -->
            <div class="row mb-4">
                <div class="col-4">
                    <div class="stat-box valid">
                        <h3 class="mb-0 text-success" id="stat-valid">0</h3>
                        <small class="text-muted">Valid</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-box invalid">
                        <h3 class="mb-0 text-danger" id="stat-invalid">0</h3>
                        <small class="text-muted">Invalid</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-box total">
                        <h3 class="mb-0" id="stat-total">0</h3>
                        <small class="text-muted">Total</small>
                    </div>
                </div>
            </div>

            <!-- Scan History -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="ti ti-history me-2"></i>Recent Scans
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" id="clear-history">
                        <i class="ti ti-trash me-1"></i>Clear
                    </button>
                </div>
                <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                    <div id="scan-history">
                        <div class="text-center text-muted py-4">
                            <small>No scans in this session</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- QR Scanner Library -->
<script src="https://unpkg.com/@AziDev/qrcodescanner/dist/qrCodeScanner.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('scanner-video');
    const startBtn = document.getElementById('start-scanner');
    const stopBtn = document.getElementById('stop-scanner');
    const manualInput = document.getElementById('manual-barcode');
    const manualSubmit = document.getElementById('manual-submit');
    const resultCard = document.getElementById('result-card');
    const resultBody = document.getElementById('result-body');
    const scanHistory = document.getElementById('scan-history');
    const eventNameInput = document.getElementById('event-name');
    const autoCheckinBox = document.getElementById('auto-checkin');
    const clearHistoryBtn = document.getElementById('clear-history');

    let scanner = null;
    let scanStats = { valid: 0, invalid: 0, total: 0 };
    let recentBarcodes = new Set();

    // Audio feedback (base64 encoded short beeps)
    const successBeep = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdXqMj4ODfXp3d39/f4WHiIiJioqLioqLjIyMjI2MjIyMjIyLi4qKiYiHhYSCf3x5dXFtaWVhXltYVVJPTUpHREJAPj06ODYzMTAvLSsqKCcmJSQjIyIiISEhISEhIiIjIyQlJicpKy0vMTM1Nzk7PkBCREdJS05RVFdaXWBjZmltcHN2eXyAgoWHiYuMjo+QkZGRkZGRkZCPjo2LiYeEgn97eHRxbWlmYl9bWFVRTkpHREE+Ojc0MjAvLSsqKCcmJSQkJCQkJCUlJSYnKCkrLC4wMjQ2ODs9QEJFS01QUlVYW19iZWhrbm91eHp9gIOGiIqMjo+QkJGRkZGQkI+OjYuJh4SCfnp3c3BsaGRgXFhVUU1KRkI/Ozg1MzEvLSwqKSgnJiYmJiYmJicnKCkqKywuLzEzNTc5Oz4AQENGSUxPUlVYW11gY2Zpam1vcnR2eHp8foGDhYeJiouMjY2NjY2NjIuKiYeGhIOBfnt5dnNwbWplYl5bV1RQTUlGQz88OTY0MjAvLSwrKikoKCgoKCgoKSkqKystLi8xMzU3Ojo8P0FFSE1QU1ZZXGBjZmlsbm9wcXFxcXFxcHBvbm1ramhnZWRiYF5cWlhWVFJQT01LSUdFREJAPz08Ozo4NzY1NDMyMTEwMC8vLy4uLi4uLi4uLi8vLzAwMTEyMzQ1Njc4OTs8Pj9BQkRGSElLTE5PUVJUVVdYWlpbXF1eXl9fYGBgYGBgYF9fXl5dXFtaWVhWVVRSUU9OTEtJSEdFREJBPz48Ozo5');
    const errorBeep = new Audio('data:audio/wav;base64,UklGRl4GAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YToGAACAgICAgICAgICAgICAgICAgICAgICAgIB/f35+fX18fHt7enp5eXh4d3d2dnV1dHRzc3JycXFwcG9vbm5tbWxsa2tqamlpaGhnZ2ZmZWVkZGNjYmJhYWBgX19eXl1dXFxbW1paWVlYWFdXVlZVVVRUU1NSUlFRUFBPT05OTU1MTEtLSkpJSUhIR0dGRkVFRERDQ0JCQUFAQAAAAAAAAAAAAQECAgMDBAQFBQYGBwcICAkJCgoLCwwMDQ0ODg8PEBARERITFBQVFRYXGBYZGR');

    // Initialize scanner
    function initScanner() {
        if (typeof QrCodeScanner === 'undefined') {
            console.warn('QR Scanner library not loaded');
            startBtn.innerHTML = '<i class="ti ti-camera-off me-1"></i>Camera Unavailable';
            startBtn.classList.replace('btn-primary', 'btn-secondary');
            startBtn.disabled = true;
            return;
        }

        try {
            scanner = new QrCodeScanner(video, handleScan, {
                highlightScanRegion: true,
                highlightCodeOutline: true
            });
        } catch (err) {
            console.error('Scanner init error:', err);
        }
    }

    // Start scanning
    startBtn.addEventListener('click', async function() {
        try {
            await scanner.start({ facingMode: 'environment' });
            startBtn.disabled = true;
            stopBtn.disabled = false;
            recentBarcodes.clear();
        } catch (err) {
            console.error('Scanner error:', err);
            alert('Could not access camera. Please ensure camera permissions are granted and try again.');
        }
    });

    // Stop scanning
    stopBtn.addEventListener('click', function() {
        if (scanner) {
            scanner.stop();
        }
        startBtn.disabled = false;
        stopBtn.disabled = true;
    });

    // Handle scanned QR code
    function handleScan(result) {
        const barcode = result.data;

        // Prevent duplicate scans within 3 seconds
        if (recentBarcodes.has(barcode)) return;
        recentBarcodes.add(barcode);
        setTimeout(() => recentBarcodes.delete(barcode), 3000);

        validateBarcode(barcode);
    }

    // Manual entry
    manualSubmit.addEventListener('click', function() {
        const barcode = manualInput.value.trim();
        if (barcode) {
            validateBarcode(barcode);
            manualInput.value = '';
        }
    });

    manualInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') manualSubmit.click();
    });

    // Validate barcode via API
    async function validateBarcode(barcode) {
        const eventName = eventNameInput.value.trim();
        const autoCheckin = autoCheckinBox.checked;

        try {
            const response = await fetch('/api/v1/wallet/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    barcode: barcode,
                    event_name: eventName || null,
                    check_in: autoCheckin
                })
            });

            const data = await response.json();

            if (response.ok) {
                displayResult(data);
                addToHistory(data);
                updateStats(data.valid);

                if (data.valid) {
                    successBeep.play().catch(() => {});
                    resultCard.classList.add('beep-success');
                } else {
                    errorBeep.play().catch(() => {});
                    resultCard.classList.add('beep-error');
                }
                setTimeout(() => resultCard.classList.remove('beep-success', 'beep-error'), 500);
            } else {
                displayError(data.error || 'Validation failed');
                addToHistory({ valid: false, error: data.error, barcode: barcode });
                updateStats(false);
                errorBeep.play().catch(() => {});
            }
        } catch (err) {
            console.error('Validation error:', err);
            displayError('Network error - please check connection');
        }
    }

    // Display validation result
    function displayResult(data) {
        const pass = data.pass;
        const isValid = data.valid;

        resultCard.classList.remove('valid', 'invalid');
        resultCard.classList.add(isValid ? 'valid' : 'invalid');

        let statusBadge = isValid
            ? '<span class="badge bg-success fs-6"><i class="ti ti-check me-1"></i>VALID</span>'
            : '<span class="badge bg-danger fs-6"><i class="ti ti-x me-1"></i>INVALID</span>';

        let alertHtml = '';
        if (!isValid && data.reason) {
            alertHtml = `<div class="alert alert-danger mt-3 mb-0"><i class="ti ti-alert-circle me-1"></i>${data.reason}</div>`;
        }
        if (data.check_in_recorded) {
            alertHtml += '<div class="alert alert-success mt-3 mb-0"><i class="ti ti-check me-1"></i>Check-in recorded successfully</div>';
        }

        resultBody.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h4 class="mb-0">${pass.member_name}</h4>
                ${statusBadge}
            </div>
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <tr><td class="text-muted" style="width:35%">Email</td><td>${pass.member_email || '-'}</td></tr>
                    <tr><td class="text-muted">Pass Type</td><td><span class="badge bg-label-primary">${pass.pass_type || '-'}</span></td></tr>
                    <tr><td class="text-muted">Validity</td><td>${pass.validity || '-'}</td></tr>
                    ${pass.team_name ? `<tr><td class="text-muted">Team</td><td>${pass.team_name}</td></tr>` : ''}
                    <tr><td class="text-muted">Status</td><td>${pass.status}</td></tr>
                </table>
            </div>
            ${alertHtml}
        `;
    }

    // Display error
    function displayError(message) {
        resultCard.classList.remove('valid', 'invalid');
        resultCard.classList.add('invalid');
        resultBody.innerHTML = `
            <div class="text-center text-danger py-4">
                <i class="ti ti-alert-triangle mb-2" style="font-size: 3rem;"></i>
                <p class="mb-0 fw-semibold">${message}</p>
            </div>
        `;
    }

    // Add to scan history
    function addToHistory(data) {
        const historyEmpty = scanHistory.querySelector('.text-muted');
        if (historyEmpty) scanHistory.innerHTML = '';

        const time = new Date().toLocaleTimeString();
        const isValid = data.valid;
        const name = data.pass ? data.pass.member_name : (data.barcode || 'Unknown');

        const item = document.createElement('div');
        item.className = `scan-history-item ${isValid ? 'valid' : 'invalid'}`;
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${name}</strong>
                    ${data.pass ? `<br><small class="text-muted">${data.pass.pass_type}</small>` : ''}
                </div>
                <div class="text-end">
                    <span class="badge ${isValid ? 'bg-success' : 'bg-danger'}">${isValid ? 'Valid' : 'Invalid'}</span>
                    <br><small class="text-muted">${time}</small>
                </div>
            </div>
        `;

        scanHistory.insertBefore(item, scanHistory.firstChild);
        while (scanHistory.children.length > 20) scanHistory.removeChild(scanHistory.lastChild);
    }

    // Update stats
    function updateStats(isValid) {
        scanStats.total++;
        if (isValid) scanStats.valid++;
        else scanStats.invalid++;

        document.getElementById('stat-valid').textContent = scanStats.valid;
        document.getElementById('stat-invalid').textContent = scanStats.invalid;
        document.getElementById('stat-total').textContent = scanStats.total;
    }

    // Clear history
    clearHistoryBtn.addEventListener('click', function() {
        scanHistory.innerHTML = '<div class="text-center text-muted py-4"><small>No scans in this session</small></div>';
        scanStats = { valid: 0, invalid: 0, total: 0 };
        document.getElementById('stat-valid').textContent = '0';
        document.getElementById('stat-invalid').textContent = '0';
        document.getElementById('stat-total').textContent = '0';
        resultCard.classList.remove('valid', 'invalid');
        resultBody.innerHTML = '<div class="text-center text-muted py-5"><i class="ti ti-qrcode mb-2" style="font-size: 3rem;"></i><p class="mb-0">Scan a pass to see validation results</p></div>';
    });

    // Initialize
    initScanner();
});
</script>
{% endblock %}
