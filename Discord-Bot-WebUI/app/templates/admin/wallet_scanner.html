{% extends 'admin/layout.html' %}
{% block title %}Pass Scanner{% endblock %}

{% block custom_css %}
{{ super() }}
<style>
    /* Scanner - Theme-aware styling */
    .scanner-container {
        max-width: 100%;
    }

    #scanner-video {
        width: 100%;
        max-height: 350px;
        border-radius: 8px;
        background: var(--bs-dark);
    }

    .scanner-overlay {
        position: relative;
    }

    .scanner-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 200px;
        border: 3px solid rgba(255,255,255,0.8);
        border-radius: 8px;
        pointer-events: none;
    }

    .scanner-frame::before,
    .scanner-frame::after {
        content: '';
        position: absolute;
        width: 25px;
        height: 25px;
        border-color: var(--bs-success);
        border-style: solid;
    }

    .scanner-frame::before {
        top: -3px;
        left: -3px;
        border-width: 4px 0 0 4px;
        border-radius: 8px 0 0 0;
    }

    .scanner-frame::after {
        bottom: -3px;
        right: -3px;
        border-width: 0 4px 4px 0;
        border-radius: 0 0 8px 0;
    }

    .result-card.valid {
        border-color: var(--bs-success) !important;
        background: var(--bs-success-bg-subtle);
    }

    .result-card.invalid {
        border-color: var(--bs-danger) !important;
        background: var(--bs-danger-bg-subtle);
    }

    .scan-history-item {
        padding: 12px;
        border-left: 4px solid;
        margin-bottom: 8px;
        border-radius: 0 8px 8px 0;
        background: var(--bs-tertiary-bg);
    }

    .scan-history-item.valid {
        border-left-color: var(--bs-success);
    }

    .scan-history-item.invalid {
        border-left-color: var(--bs-danger);
    }

    .beep-success {
        animation: pulse-green 0.5s ease;
    }

    .beep-error {
        animation: pulse-red 0.5s ease;
    }

    @keyframes pulse-green {
        0%, 100% { box-shadow: 0 0 0 0 rgba(var(--bs-success-rgb), 0); }
        50% { box-shadow: 0 0 0 15px rgba(var(--bs-success-rgb), 0.3); }
    }

    @keyframes pulse-red {
        0%, 100% { box-shadow: 0 0 0 0 rgba(var(--bs-danger-rgb), 0); }
        50% { box-shadow: 0 0 0 15px rgba(var(--bs-danger-rgb), 0.3); }
    }

    .stat-box {
        padding: 16px;
        border-radius: 8px;
        text-align: center;
    }
    .stat-box.valid { background: var(--bs-success-bg-subtle); }
    .stat-box.invalid { background: var(--bs-danger-bg-subtle); }
    .stat-box.total { background: var(--bs-tertiary-bg); }
</style>
{% endblock custom_css %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h2 class="fw-bold text-primary mb-1">
                        <i class="ti ti-qrcode me-2"></i>Pass Scanner
                    </h2>
                    <p class="text-muted mb-0">Scan digital wallet passes to validate membership and record check-ins</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('wallet_admin.checkins_list') }}" class="c-btn c-btn--outline-secondary">
                        <i class="ti ti-list-check me-1"></i>Check-in History
                    </a>
                    <a href="{{ url_for('wallet_admin.passes_list') }}" class="c-btn c-btn--outline-secondary">
                        <i class="ti ti-arrow-left me-1"></i>Back to Passes
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Scanner Column -->
        <div class="col-lg-6 mb-4">
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="mb-0">
                        <i class="ti ti-scan me-2"></i>Scan Pass
                    </h5>
                </div>
                <div class="c-card__body">
                    <div class="scanner-container">
                        <!-- Scanner Video -->
                        <div class="scanner-overlay mb-3">
                            <video id="scanner-video" playsinline></video>
                            <div class="scanner-frame"></div>
                        </div>

                        <!-- Scanner Controls -->
                        <div class="d-flex gap-2 mb-4">
                            <button id="start-scanner" class="c-btn c-btn--primary flex-grow-1">
                                <i class="ti ti-scan me-1"></i>Start Camera
                            </button>
                            <button id="stop-scanner" class="c-btn c-btn--outline-secondary" disabled>
                                <i class="ti ti-player-stop me-1"></i>Stop
                            </button>
                        </div>

                        <!-- Manual Entry -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="ti ti-keyboard me-1"></i>Manual Entry
                            </label>
                            <div class="input-group" data-input-group>
                                <input type="text" id="manual-barcode" class="form-control"
                                       placeholder="Enter pass barcode (e.g., ECS-2025-ABC123)" data-form-control>
                                <button class="c-btn c-btn--primary" id="manual-submit">
                                    <i class="ti ti-check me-1"></i>Validate
                                </button>
                            </div>
                            <small class="text-muted">Type or paste the barcode if camera scanning isn't available</small>
                        </div>

                        <!-- Options -->
                        <div class="c-card bg-body-tertiary border-0">
                            <div class="c-card__body py-3">
                                <div class="mb-3">
                                    <label class="form-label small text-muted mb-1">Event Name (optional)</label>
                                    <input type="text" id="event-name" class="form-control form-control-sm"
                                           placeholder="e.g., Match vs Seattle Sounders" data-form-control>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="auto-checkin" checked>
                                    <label class="form-check-label" for="auto-checkin">
                                        Automatically record check-in for valid passes
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Result & History Column -->
        <div class="col-lg-6">
            <!-- Latest Scan Result -->
            <div class="c-card mb-4 result-card" id="result-card">
                <div class="c-card__header">
                    <h5 class="mb-0">
                        <i class="ti ti-user-check me-2"></i>Scan Result
                    </h5>
                </div>
                <div class="c-card__body" id="result-body">
                    <div class="text-center text-muted py-5">
                        <i class="ti ti-qrcode mb-2" class="u-icon-3xl"></i>
                        <p class="mb-0">Scan a pass to see validation results</p>
                    </div>
                </div>
            </div>

            <!-- Session Stats -->
            <div class="row mb-4">
                <div class="col-4">
                    <div class="stat-box valid">
                        <h3 class="mb-0 text-success" id="stat-valid">0</h3>
                        <small class="text-muted">Valid</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-box invalid">
                        <h3 class="mb-0 text-danger" id="stat-invalid">0</h3>
                        <small class="text-muted">Invalid</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-box total">
                        <h3 class="mb-0" id="stat-total">0</h3>
                        <small class="text-muted">Total</small>
                    </div>
                </div>
            </div>

            <!-- Scan History -->
            <div class="c-card">
                <div class="c-card__header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="ti ti-history me-2"></i>Recent Scans
                    </h5>
                    <button class="c-btn c-btn--sm c-btn--outline-secondary" id="clear-history">
                        <i class="ti ti-trash me-1"></i>Clear
                    </button>
                </div>
                <div class="c-card__body" class="u-max-h-350-scroll">
                    <div id="scan-history">
                        <div class="text-center text-muted py-4">
                            <small>No scans in this session</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- QR Scanner Library -->
<script src="https://unpkg.com/@AziDev/qrcodescanner/dist/qrCodeScanner.min.js"></script>
<!-- Wallet Scanner Module -->
<script src="{{ url_for('static', filename='custom_js/wallet-scanner.js') }}"></script>
{% endblock %}

