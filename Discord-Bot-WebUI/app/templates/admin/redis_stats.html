{% extends "base.html" %}

{% block title %}Redis Connection Statistics{% endblock %}

{% block custom_css %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/redis-stats.css') }}">
{% endif %}
{% endblock %}

{% block main_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Redis Connection Statistics</h2>
                <div>
                    <button id="redis-refresh-btn" class="c-btn c-btn--primary c-btn--sm me-2">Refresh</button>
                    <button id="cleanup-btn" class="c-btn c-btn--warning c-btn--sm me-2">Cleanup Connections</button>
                    <button id="test-btn" class="c-btn c-btn--info c-btn--sm me-2">Test Connection</button>
                    <a href="/admin/redis/draft-cache-stats" class="c-btn c-btn--success c-btn--sm">Draft Cache Stats</a>
                </div>
            </div>

            <div class="redis-auto-refresh">
                <label>
                    <input type="checkbox" id="redis-auto-refresh" checked> Auto-refresh every 5 seconds
                </label>
                <span id="redis-last-updated" class="ms-3 text-muted"></span>
            </div>

            <!-- Connection Health Status -->
            <div class="row">
                <div class="col-md-4">
                    <div class="redis-stat-c-card">
                        <h5>Connection Health</h5>
                        <div id="health-status">
                            {% if connection_health.overall %}
                                <span class="redis-health-indicator redis-health-healthy"></span>All connections healthy
                            {% else %}
                                <span class="redis-health-indicator redis-health-unhealthy"></span>Connection issues detected
                            {% endif %}
                        </div>
                        <div class="mt-2">
                            <small>
                                Decoded: <span id="decoded-status">{{ "✓" if connection_health.decoded_client else "✗" }}</span> |
                                Raw: <span id="raw-status">{{ "✓" if connection_health.raw_client else "✗" }}</span>
                            </small>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="redis-stat-c-card">
                        <div class="redis-stat-value" id="redis-max-connections">{{ stats.pool_stats.max_connections|default(0) }}</div>
                        <div class="redis-stat-label">Max Connections</div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="redis-stat-c-card">
                        <div class="redis-stat-value" id="utilization">{{ stats.pool_stats.utilization_percent|default(0) }}%</div>
                        <div class="redis-stat-label">Pool Utilization</div>
                    </div>
                </div>
            </div>

            <!-- Connection Pool Details -->
            <div class="row">
                <div class="col-md-6">
                    <div class="c-card">
                        <div class="c-card__header">
                            <h5>Connection Pool Statistics</h5>
                        </div>
                        <div class="c-card__body">
                            <table class="c-c-table c-table--compact" data-mobile-table data-table-type="stats" data-table>
                                <tbody>
                                    <tr>
                                        <td data-label="Metric">Pool Initialized</td>
                                        <td data-label="Value"><span id="pool-initialized">{{ "Yes" if stats.connection_pool_initialized else "No" }}</span></td>
                                    </tr>
                                    <tr>
                                        <td data-label="Metric">Created Connections</td>
                                        <td data-label="Value"><span id="created-connections">{{ stats.pool_stats.created_connections|default(0) }}</span></td>
                                    </tr>
                                    <tr>
                                        <td data-label="Metric">Available Connections</td>
                                        <td data-label="Value"><span id="available-connections">{{ stats.pool_stats.available_connections|default(0) }}</span></td>
                                    </tr>
                                    <tr>
                                        <td data-label="Metric">In-Use Connections</td>
                                        <td data-label="Value"><span id="in-use-connections">{{ stats.pool_stats.in_use_connections|default(0) }}</span></td>
                                    </tr>
                                    <tr>
                                        <td data-label="Metric">Last Health Check</td>
                                        <td data-label="Value"><span id="last-health-check">{{ stats.last_health_check|default("Never") }}</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="c-card">
                        <div class="c-card__header">
                            <h5>Redis Server Metrics</h5>
                        </div>
                        <div class="c-card__body">
                            <table class="c-c-table c-table--compact" data-mobile-table data-table-type="stats" data-table>
                                <tbody>
                                    <tr>
                                        <td data-label="Metric">Connected Clients</td>
                                        <td data-label="Value"><span id="connected-clients">{{ server_info.connected_clients|default("N/A") }}</span></td>
                                    </tr>
                                    <tr>
                                        <td data-label="Metric">Memory Usage</td>
                                        <td data-label="Value"><span id="memory-usage">{{ server_info.used_memory_human|default("N/A") }}</span></td>
                                    </tr>
                                    <tr>
                                        <td data-label="Metric">Commands Processed</td>
                                        <td data-label="Value"><span id="commands-processed">{{ server_info.total_commands_processed|default("N/A") }}</span></td>
                                    </tr>
                                    <tr>
                                        <td data-label="Metric">Ops/sec</td>
                                        <td data-label="Value"><span id="ops-per-sec">{{ server_info.instantaneous_ops_per_sec|default("N/A") }}</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Results -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="c-card">
                        <div class="c-card__header">
                            <h5>Connection Test Results</h5>
                        </div>
                        <div class="c-card__body">
                            <div id="test-results">
                                <p class="text-muted">Click "Test Connection" to run connection tests</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="{{ url_for('static', filename='custom_js/redis-stats.js') }}"></script>
{% endif %}
{% endblock %}