{% extends "base.html" %}

{% block title %}Merge Profiles - Alert #{{ alert.id }}{% endblock %}

{% block custom_css %}
<style>
    .field-comparison {
        border: 2px solid #e7eaf3;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease;
    }
    
    .field-comparison:hover {
        border-color: #696cff;
        box-shadow: 0 0.125rem 0.5rem rgba(105, 108, 255, 0.15);
    }
    
    .value-option {
        cursor: pointer;
        transition: all 0.2s ease;
        border-radius: 6px;
        padding: 0.75rem;
        border: 2px solid transparent;
    }
    
    .value-option:hover {
        background-color: #f8f9fa;
    }
    
    .value-option.selected {
        border-color: #696cff;
        background-color: rgba(105, 108, 255, 0.08);
    }
    
    .value-existing {
        background-color: rgba(40, 199, 111, 0.08);
    }
    
    .value-new {
        background-color: rgba(105, 108, 255, 0.08);
    }
    
    .value-combined {
        background-color: rgba(255, 159, 67, 0.08);
    }
    
    .preview-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .merge-summary {
        position: sticky;
        top: 90px;
        z-index: 100;
    }
</style>
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="fw-bold py-3 mb-2">
                        <span class="text-muted fw-light">Admin / Duplicate Management /</span> Merge Profiles
                    </h4>
                    <p class="text-muted mb-0">Combine information from both profiles into one unified player</p>
                </div>
                <div>
                    <a href="{{ url_for('duplicate_management.duplicate_registration_detail', alert_id=alert.id) }}" class="btn btn-outline-secondary">
                        <i class="ti ti-arrow-left me-2"></i>Back to Alert
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <form id="mergeForm" method="POST" action="{{ url_for('duplicate_management.execute_profile_merge', alert_id=alert.id) }}">
                        <!-- Field Comparisons -->
                        {% for field in fields_to_merge %}
                        {% set existing_value = existing_player[field] if existing_player[field] else '' %}
                        {% set new_value = new_user_data.get(field, '') %}
                        
                        {% if existing_value or new_value %}
                        <div class="field-comparison">
                            <h6 class="mb-3">{{ field.replace('_', ' ').title() }}</h6>
                            
                            <div class="row">
                                <!-- Keep Existing -->
                                <div class="col-md-4">
                                    <div class="value-option value-existing" data-field="{{ field }}" data-value="existing">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="field_{{ field }}" 
                                                   value="existing" id="{{ field }}_existing"
                                                   {% if existing_value and not new_value %}checked{% endif %}>
                                            <label class="form-check-label fw-bold text-success" for="{{ field }}_existing">
                                                Keep Existing
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            {% if existing_value %}
                                            <div class="text-break">{{ existing_value }}</div>
                                            {% else %}
                                            <em class="text-muted">No existing value</em>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Use New -->
                                <div class="col-md-4">
                                    <div class="value-option value-new" data-field="{{ field }}" data-value="new">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="field_{{ field }}" 
                                                   value="new" id="{{ field }}_new"
                                                   {% if new_value and not existing_value %}checked{% endif %}>
                                            <label class="form-check-label fw-bold text-primary" for="{{ field }}_new">
                                                Use New
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            {% if new_value %}
                                            <div class="text-break">{{ new_value }}</div>
                                            {% else %}
                                            <em class="text-muted">No new value</em>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Combine -->
                                {% if field in ['additional_info', 'player_notes'] and existing_value and new_value %}
                                <div class="col-md-4">
                                    <div class="value-option value-combined" data-field="{{ field }}" data-value="combine">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="field_{{ field }}" 
                                                   value="combine" id="{{ field }}_combine">
                                            <label class="form-check-label fw-bold text-warning" for="{{ field }}_combine">
                                                Combine Both
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">Merge both values together</small>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}

                        <!-- Discord Account Linking -->
                        {% if alert.new_discord_email and not existing_player.discord_id %}
                        <div class="field-comparison">
                            <h6 class="mb-3">Discord Account</h6>
                            <div class="alert alert-info">
                                <h6 class="alert-heading">Link Discord Account</h6>
                                <p class="mb-2">The new registration includes Discord information that can be linked to the existing player:</p>
                                <ul class="mb-0">
                                    <li><strong>Email:</strong> {{ alert.new_discord_email }}</li>
                                    {% if alert.new_discord_username %}
                                    <li><strong>Username:</strong> {{ alert.new_discord_username }}</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Submit Button -->
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Ready to Merge?</h6>
                                        <small class="text-muted">This action cannot be undone. Please review your selections carefully.</small>
                                    </div>
                                    <div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="ti ti-git-merge me-2"></i>Execute Merge
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Merge Summary Sidebar -->
                <div class="col-lg-4">
                    <div class="merge-summary">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Merge Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <small class="text-muted">Target Player</small>
                                    <p class="fw-bold mb-0">{{ existing_player.name }}</p>
                                    <small class="text-muted">ID: {{ existing_player.id }}</small>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted">Source Registration</small>
                                    <p class="fw-bold mb-0">{{ alert.new_name or 'N/A' }}</p>
                                    <small class="text-muted">{{ alert.new_discord_email }}</small>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted">Match Details</small>
                                    <div>
                                        <span class="badge match-type-{{ alert.match_type }}">{{ alert.match_type.replace('_', ' ').title() }}</span>
                                        <span class="badge bg-label-primary">{{ (alert.confidence_score * 100)|round|int }}% Match</span>
                                    </div>
                                </div>

                                <hr>

                                <div id="mergePreview">
                                    <small class="text-muted">Field Updates</small>
                                    <div id="updatesList">
                                        <p class="text-muted mb-0"><em>Select fields to see preview</em></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-body">
                                <h6 class="text-warning mb-2">
                                    <i class="ti ti-alert-triangle me-2"></i>Important Notes
                                </h6>
                                <ul class="small mb-0">
                                    <li>The existing player profile will be updated</li>
                                    <li>The duplicate registration alert will be marked as resolved</li>
                                    <li>All changes will be logged in the player notes</li>
                                    <li>This action cannot be undone</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle field selection visual feedback
    document.querySelectorAll('.value-option').forEach(option => {
        option.addEventListener('click', function() {
            const field = this.dataset.field;
            const value = this.dataset.value;
            
            // Remove selected class from other options for this field
            document.querySelectorAll(`[data-field="${field}"]`).forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            this.classList.add('selected');
            
            // Check the radio button
            this.querySelector('input[type="radio"]').checked = true;
            
            // Update preview
            updateMergePreview();
        });
    });
    
    // Update merge preview
    function updateMergePreview() {
        const updatesList = document.getElementById('updatesList');
        const updates = [];
        
        document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
            const field = radio.name.replace('field_', '');
            const value = radio.value;
            
            if (value === 'new') {
                updates.push(`<small class="d-block text-primary">Update ${field.replace('_', ' ')}</small>`);
            } else if (value === 'combine') {
                updates.push(`<small class="d-block text-warning">Combine ${field.replace('_', ' ')}</small>`);
            }
        });
        
        if (updates.length > 0) {
            updatesList.innerHTML = updates.join('');
        } else {
            updatesList.innerHTML = '<p class="text-muted mb-0"><em>No changes selected</em></p>';
        }
    }
    
    // Initialize with current selections
    updateMergePreview();
});
</script>
{% endblock %}