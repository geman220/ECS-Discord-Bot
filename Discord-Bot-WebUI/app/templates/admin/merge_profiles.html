{% extends "base.html" %}

{% block title %}Merge Profiles - Alert #{{ alert.id }}{% endblock %}

{% block custom_css %}
{{ super() }}
{# Styles moved to external CSS #}
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="fw-bold py-3 mb-2">
                        <span class="text-muted fw-light">Admin / Duplicate Management /</span> Merge Profiles
                    </h4>
                    <p class="text-muted mb-0">Combine information from both profiles into one unified player</p>
                </div>
                <div>
                    <a href="{{ url_for('duplicate_management.duplicate_registration_detail', alert_id=alert.id) }}" class="c-btn c-btn--outline-secondary">
                        <i class="ti ti-arrow-left me-2"></i>Back to Alert
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <form id="mergeForm" method="POST" action="{{ url_for('duplicate_management.execute_profile_merge', alert_id=alert.id) }}">
                        <!-- Field Comparisons -->
                        {% for field in fields_to_merge %}
                        {% set existing_value = existing_player[field] if existing_player[field] else '' %}
                        {% set new_value = new_user_data.get(field, '') %}
                        
                        {% if existing_value or new_value %}
                        <div class="field-comparison">
                            <h6 class="mb-3">{{ field.replace('_', ' ').title() }}</h6>
                            
                            <div class="row">
                                <!-- Keep Existing -->
                                <div class="col-md-4">
                                    <div class="value-option value-existing" data-field="{{ field }}" data-value="existing">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="field_{{ field }}" 
                                                   value="existing" id="{{ field }}_existing"
                                                   {% if existing_value and not new_value %}checked{% endif %}>
                                            <label class="form-check-label fw-bold text-success" for="{{ field }}_existing">
                                                Keep Existing
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            {% if existing_value %}
                                            <div class="text-break">{{ existing_value }}</div>
                                            {% else %}
                                            <em class="text-muted">No existing value</em>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Use New -->
                                <div class="col-md-4">
                                    <div class="value-option value-new" data-field="{{ field }}" data-value="new">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="field_{{ field }}" 
                                                   value="new" id="{{ field }}_new"
                                                   {% if new_value and not existing_value %}checked{% endif %}>
                                            <label class="form-check-label fw-bold text-primary" for="{{ field }}_new">
                                                Use New
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            {% if new_value %}
                                            <div class="text-break">{{ new_value }}</div>
                                            {% else %}
                                            <em class="text-muted">No new value</em>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Combine -->
                                {% if field in ['additional_info', 'player_notes'] and existing_value and new_value %}
                                <div class="col-md-4">
                                    <div class="value-option value-combined" data-field="{{ field }}" data-value="combine">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="field_{{ field }}" 
                                                   value="combine" id="{{ field }}_combine">
                                            <label class="form-check-label fw-bold text-warning" for="{{ field }}_combine">
                                                Combine Both
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">Merge both values together</small>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}

                        <!-- Discord Account Linking -->
                        {% if alert.new_discord_email and not existing_player.discord_id %}
                        <div class="field-comparison">
                            <h6 class="mb-3">Discord Account</h6>
                            <div class="alert alert-info" data-alert>
                                <h6 class="alert-heading">Link Discord Account</h6>
                                <p class="mb-2">The new registration includes Discord information that can be linked to the existing player:</p>
                                <ul class="mb-0">
                                    <li><strong>Email:</strong> {{ alert.new_discord_email }}</li>
                                    {% if alert.new_discord_username %}
                                    <li><strong>Username:</strong> {{ alert.new_discord_username }}</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Submit Button -->
                        <div class="c-card">
                            <div class="c-card__body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Ready to Merge?</h6>
                                        <small class="text-muted">This action cannot be undone. Please review your selections carefully.</small>
                                    </div>
                                    <div>
                                        <button type="submit" class="c-btn c-btn--primary">
                                            <i class="ti ti-git-merge me-2"></i>Execute Merge
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Merge Summary Sidebar -->
                <div class="col-lg-4">
                    <div class="merge-summary">
                        <div class="c-card">
                            <div class="c-card__header">
                                <h6 class="mb-0">Merge Summary</h6>
                            </div>
                            <div class="c-card__body">
                                <div class="mb-3">
                                    <small class="text-muted">Target Player</small>
                                    <p class="fw-bold mb-0">{{ existing_player.name }}</p>
                                    <small class="text-muted">ID: {{ existing_player.id }}</small>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted">Source Registration</small>
                                    <p class="fw-bold mb-0">{{ alert.new_name or 'N/A' }}</p>
                                    <small class="text-muted">{{ alert.new_discord_email }}</small>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted">Match Details</small>
                                    <div>
                                        <span class="badge match-type-{{ alert.match_type }}" data-badge>{{ alert.match_type.replace('_', ' ').title() }}</span>
                                        <span class="badge bg-label-primary" data-badge>{{ (alert.confidence_score * 100)|round|int }}% Match</span>
                                    </div>
                                </div>

                                <hr>

                                <div id="mergePreview">
                                    <small class="text-muted">Field Updates</small>
                                    <div id="updatesList">
                                        <p class="text-muted mb-0"><em>Select fields to see preview</em></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="c-card mt-3">
                            <div class="c-card__body">
                                <h6 class="text-warning mb-2">
                                    <i class="ti ti-alert-triangle me-2"></i>Important Notes
                                </h6>
                                <ul class="small mb-0">
                                    <li>The existing player profile will be updated</li>
                                    <li>The duplicate registration alert will be marked as resolved</li>
                                    <li>All changes will be logged in the player notes</li>
                                    <li>This action cannot be undone</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}

{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="{{ url_for('static', filename='custom_js/merge-profiles.js') }}"></script>

{% endif %}
{% endblock %}