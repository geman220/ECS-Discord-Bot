{% extends 'admin/layout.html' %}
{% block title %}Pass Studio - {{ pass_type.name }}{% endblock %}

{% block custom_css %}
<style>
    /* Pass Preview Container */
    .pass-preview-container {
        position: sticky;
        top: 80px;
    }

    /* ========== APPLE WALLET PASS PREVIEW ========== */
    /* Accurate StoreCard layout matching real Apple Wallet */
    .apple-pass-card {
        width: 320px;
        min-height: 440px;
        border-radius: 12px;
        margin: 0 auto;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* Header: Logo + Logo Text */
    .pass-header {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        min-height: 50px;
    }

    .pass-logo {
        width: 50px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-right: 10px;
        flex-shrink: 0;
    }
    .pass-logo img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    .pass-logo-placeholder {
        width: 40px;
        height: 30px;
        border: 1px dashed rgba(255,255,255,0.3);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255,255,255,0.4);
        font-size: 0.75rem;
    }

    .pass-logo-text {
        font-size: 0.95rem;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 120px;
    }

    /* Header Fields - appear on right side of header, pushed to the right */
    .pass-header-fields {
        display: flex;
        gap: 12px;
        margin-left: auto;
        text-align: right;
    }
    .pass-header-field {
        min-width: 40px;
    }
    .pass-header-field .pass-field-label {
        font-size: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 1px;
        font-weight: 500;
        opacity: 0.8;
    }
    .pass-header-field .pass-field-value {
        font-size: 0.75rem;
        font-weight: 600;
        line-height: 1.1;
    }

    /* Strip Area - contains PRIMARY FIELD overlaid on top */
    .pass-strip-area {
        height: 123px;
        position: relative;
        display: flex;
        align-items: flex-end;
        justify-content: flex-start;
        overflow: hidden;
    }

    .pass-strip-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 0;
    }

    /* Primary field overlaid ON the strip */
    .pass-primary-field-overlay {
        position: relative;
        z-index: 1;
        padding: 12px 16px;
        width: 100%;
        /* Text shadow for readability over images */
        text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .pass-field-label {
        font-size: 0.6rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
        font-weight: 500;
    }

    .pass-field-value {
        font-size: 1.2rem;
        font-weight: 600;
        line-height: 1.2;
    }

    /* Secondary/Auxiliary Fields - below strip, in a row */
    .pass-secondary-fields {
        display: flex;
        flex-wrap: wrap;
        padding: 12px 16px;
        gap: 16px;
    }

    .pass-field {
        flex: 1;
        min-width: 60px;
    }
    .pass-field .pass-field-label {
        font-size: 0.55rem;
    }
    .pass-field .pass-field-value {
        font-size: 0.85rem;
        font-weight: 500;
        text-shadow: none;
    }

    /* Barcode Area - white background at bottom */
    .pass-barcode-area {
        margin-top: auto;
        padding: 20px 16px;
        text-align: center;
        background: var(--bs-white, #ffffff);
    }
    .pass-barcode svg {
        display: block;
        margin: 0 auto;
    }

    /* Event Ticket notch at top */
    .pass-notch {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 30px;
        height: 8px;
        background: var(--bs-body-bg, #f4f5f7);
        border-radius: 0 0 8px 8px;
        z-index: 10;
        display: none;
    }

    /* Generic pass style - fields below header, no strip overlay */
    .pass-style-generic .pass-strip-area {
        display: none !important;
    }
    .pass-style-generic .pass-secondary-fields {
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    /* Thumbnail area for generic passes */
    .pass-thumbnail-preview {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
        margin-left: auto;
    }
    .pass-thumbnail-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Thumbnail in header - for generic passes */
    .pass-thumbnail {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
        margin-left: auto;
    }
    .pass-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .pass-thumbnail-placeholder {
        width: 60px;
        height: 60px;
        border: 1px dashed rgba(255,255,255,0.3);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255,255,255,0.4);
        font-size: 1rem;
    }

    /* Primary fields section - only for generic passes */
    .pass-primary-fields-section {
        padding: 16px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .pass-primary-fields-section .pass-field-label {
        font-size: 0.6rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
        font-weight: 500;
    }
    .pass-primary-fields-section .pass-field-value {
        font-size: 1.4rem;
        font-weight: 600;
        line-height: 1.2;
    }

    /* Event Ticket style - show notch */
    .pass-style-eventTicket .pass-notch {
        display: block !important;
    }

    /* ========== GOOGLE WALLET PASS PREVIEW ========== */
    .google-pass-card {
        width: 320px;
        border-radius: 12px;
        margin: 0 auto;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        overflow: hidden;
        background: var(--bs-white, #fff);
    }

    .google-hero-image {
        height: 100px;
        background-color: var(--ecs-neutral-10, #f0f0f0);
        background-size: cover;
        background-position: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .google-hero-placeholder {
        text-align: center;
        color: var(--ecs-neutral-50, #999);
    }
    .google-hero-placeholder i {
        font-size: 2rem;
    }
    .google-hero-placeholder span {
        display: block;
        font-size: 0.75rem;
        margin-top: 4px;
    }

    .google-pass-content {
        padding: 16px;
    }

    .google-header {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
    }

    .google-logo {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        overflow: hidden;
        margin-right: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.05);
    }
    .google-logo img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    .google-logo-placeholder {
        color: rgba(255,255,255,0.4);
    }

    .google-header-text {
        flex: 1;
    }

    .google-card-title {
        font-size: 1rem;
        font-weight: 600;
    }

    .google-card-subtitle {
        font-size: 0.75rem;
        opacity: 0.7;
    }

    .google-primary-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 16px;
    }

    .google-info-rows {
        border-top: 1px solid rgba(0,0,0,0.1);
        padding-top: 12px;
    }

    .google-info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
    }

    .google-info-label {
        font-size: 0.75rem;
        opacity: 0.7;
    }

    .google-info-value {
        font-size: 0.85rem;
        font-weight: 500;
    }

    .google-barcode-area {
        margin-top: 16px;
        text-align: center;
        padding: 16px;
        background: var(--ecs-neutral-0, #fff);
        border-radius: 8px;
    }

    /* ========== ASSET UPLOAD CARDS ========== */
    .asset-upload-card {
        border: 2px dashed var(--bs-border-color);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bs-card-bg);
    }
    .asset-upload-card:hover {
        border-color: var(--bs-primary);
        background: rgba(var(--bs-primary-rgb), 0.05);
    }

    .asset-preview {
        width: 100%;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        position: relative;
        overflow: hidden;
        border-radius: 8px;
        background: var(--bs-tertiary-bg, var(--ecs-neutral-5, #f8f9fa));
    }
    .asset-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    .asset-placeholder {
        color: var(--bs-secondary-color, var(--bs-secondary));
    }

    .asset-info strong {
        display: block;
        font-size: 0.875rem;
    }
    .asset-info small {
        color: var(--bs-secondary-color, var(--bs-secondary));
    }

    /* Dark mode for asset cards */
    [data-bs-theme="dark"] .asset-upload-card,
    .dark-style .asset-upload-card {
        background: var(--bs-card-bg, #2b2c40);
        border-color: var(--bs-border-color, #444564);
    }

    [data-bs-theme="dark"] .asset-upload-card:hover,
    .dark-style .asset-upload-card:hover {
        border-color: var(--bs-primary);
        background: rgba(var(--bs-primary-rgb), 0.1);
    }

    [data-bs-theme="dark"] .asset-preview,
    .dark-style .asset-preview {
        background: rgba(255, 255, 255, 0.05);
    }

    [data-bs-theme="dark"] .asset-placeholder,
    .dark-style .asset-placeholder {
        color: var(--bs-secondary-color, #a3a4cc);
    }

    [data-bs-theme="dark"] .asset-info strong,
    .dark-style .asset-info strong {
        color: var(--bs-body-color, #a3a4cc);
    }

    /* ========== COLOR PICKER ========== */
    .color-picker-wrapper {
        position: relative;
    }
    .color-swatch {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid rgba(0,0,0,0.1);
    }

    /* ========== PASS LAYOUT DIAGRAM ========== */
    .pass-layout-diagram .layout-card {
        background: var(--ecs-neutral-5, #f8f9fa);
        border: 2px solid var(--ecs-neutral-20, #dee2e6);
        border-radius: 12px;
        overflow: hidden;
        font-size: 0.65rem;
        min-height: 280px;
        position: relative;
    }
    [data-bs-theme="dark"] .pass-layout-diagram .layout-card {
        background: var(--ecs-dark-bg-card, #2b2c40);
        border-color: var(--ecs-dark-border, #444564);
    }
    .layout-card .layout-notch {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 24px;
        height: 6px;
        background: var(--ecs-neutral-5, #f8f9fa);
        border-radius: 0 0 6px 6px;
        z-index: 5;
    }
    [data-bs-theme="dark"] .layout-card .layout-notch {
        background: var(--ecs-dark-bg-body, #1e1e2d);
    }
    .layout-card .layout-header {
        display: flex;
        align-items: center;
        padding: 8px;
        background: rgba(0,0,0,0.05);
        gap: 4px;
        min-height: 36px;
    }
    .layout-card .layout-logo {
        background: var(--ecs-secondary, #6c757d);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.6rem;
    }
    .layout-card .layout-logo-text {
        flex: 1;
        color: var(--ecs-secondary, #6c757d);
        font-size: 0.6rem;
    }
    .layout-card .layout-header-fields {
        background: var(--ecs-info, #0d6efd);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.6rem;
    }
    .layout-card .layout-thumbnail {
        background: var(--ecs-primary, #6f42c1);
        color: white;
        padding: 4px 6px;
        border-radius: 4px;
        font-size: 0.55rem;
    }
    .layout-card .layout-strip {
        background: linear-gradient(135deg, var(--ecs-neutral-60, #495057) 0%, var(--ecs-neutral-70, #343a40) 100%);
        color: white;
        padding: 16px 8px;
        text-align: center;
        position: relative;
        min-height: 60px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .layout-card .layout-strip-label {
        font-size: 0.55rem;
        opacity: 0.7;
    }
    .layout-card .layout-strip.layout-strip-clean {
        min-height: 50px;
    }
    .layout-card .layout-primary-overlay {
        background: rgba(220, 53, 69, 0.9);
        padding: 4px 8px;
        border-radius: 4px;
        margin-top: 4px;
        font-size: 0.6rem;
    }
    .layout-card .layout-primary {
        background: var(--ecs-danger, #dc3545);
        color: white;
        padding: 10px 8px;
        text-align: center;
        font-weight: 500;
    }
    .layout-card .layout-secondary {
        background: var(--ecs-success, #198754);
        color: white;
        padding: 8px;
        text-align: center;
    }
    .layout-card .layout-auxiliary {
        background: var(--ecs-warning, #fd7e14);
        color: white;
        padding: 8px;
        text-align: center;
    }
    .layout-card .layout-barcode {
        background: var(--bs-white, white);
        color: var(--ecs-neutral-80, #333);
        padding: 12px 8px;
        text-align: center;
        border-top: 1px dashed var(--ecs-neutral-20, #dee2e6);
    }
    [data-bs-theme="dark"] .layout-card .layout-barcode {
        background: var(--ecs-dark-bg-body, #1e1e2d);
        color: var(--ecs-neutral-50, #a0a0a0);
        border-color: var(--ecs-dark-border, #444564);
    }

    /* ========== FIELD CARDS ========== */
    .field-card {
        background: var(--bs-card-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        transition: all 0.2s;
    }
    .field-card:hover {
        box-shadow: var(--bs-box-shadow-sm);
    }
    .field-card.inactive {
        opacity: 0.5;
    }
    .field-location-badge {
        font-size: 0.65rem;
        text-transform: uppercase;
        padding: 2px 6px;
    }

    /* Tab content */
    .tab-pane {
        padding-top: 1rem;
    }

    /* Variable chips */
    .variable-chip {
        display: inline-flex;
        align-items: center;
        font-family: monospace;
        font-size: 0.75rem;
        padding: 4px 8px;
        background: var(--bs-light);
        border-radius: 4px;
        margin: 2px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .variable-chip:hover {
        background: var(--bs-primary);
        color: white;
    }

    /* Location/Sponsor list */
    .entity-list-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border-bottom: 1px solid var(--bs-border-color);
    }
    .entity-list-item:last-child {
        border-bottom: none;
    }

    /* Unsaved indicator */
    .unsaved-indicator {
        display: none;
    }
    .has-unsaved-changes .unsaved-indicator {
        display: inline-flex;
    }

    /* Platform toggle button group */
    .pass-preview-platform {
        /* Container for platform-specific preview */
    }

    /* ========== FIELDS TAB REDESIGN ========== */

    /* Field limits summary bar */
    .field-limits-bar {
        background: var(--bs-card-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        padding: 12px 16px;
    }

    .field-limit-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: var(--bs-light);
        border-radius: 20px;
        font-size: 0.875rem;
    }

    .field-limit-item .limit-label {
        font-weight: 500;
        color: var(--bs-secondary);
    }

    .field-limit-item .limit-count {
        font-weight: 600;
        color: var(--bs-body-color);
    }

    .field-limit-item.at-limit {
        background: rgba(var(--bs-warning-rgb), 0.15);
    }

    .field-limit-item.at-limit .limit-count {
        color: var(--bs-warning);
    }

    .field-limit-item.over-limit {
        background: rgba(var(--bs-danger-rgb), 0.15);
    }

    .field-limit-item.over-limit .limit-count {
        color: var(--bs-danger);
    }

    /* Collapsible variables reference */
    .collapse-icon {
        transition: transform 0.2s;
    }

    [aria-expanded="true"] .collapse-icon {
        transform: rotate(180deg);
    }

    /* Field location sections */
    .field-location-section {
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        padding: 12px;
        background: var(--bs-light);
    }

    .field-location-header {
        padding-bottom: 8px;
        border-bottom: 1px dashed var(--bs-border-color);
    }

    /* Sortable containers */
    .fields-sortable-container {
        min-height: 60px;
        border-radius: 6px;
        padding: 8px;
        background: var(--bs-card-bg);
        margin-top: 8px;
    }

    .fields-sortable-container:empty::after {
        content: 'Drag fields here or click Add Field';
        display: block;
        text-align: center;
        color: var(--bs-secondary);
        font-size: 0.875rem;
        padding: 16px;
    }

    .fields-sortable-container .empty-state {
        pointer-events: none;
    }

    /* Field cards - enhanced */
    .field-card {
        background: var(--bs-card-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        margin-bottom: 8px;
        transition: all 0.2s;
    }

    .field-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-color: var(--bs-primary);
    }

    .field-card.inactive {
        opacity: 0.5;
        background: var(--bs-light);
    }

    .field-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        border-bottom: 1px solid var(--bs-border-color);
        background: var(--bs-light);
        border-radius: 7px 7px 0 0;
    }

    .field-card-body {
        padding: 12px;
    }

    /* Drag handle */
    .drag-handle {
        cursor: grab;
        color: var(--bs-secondary);
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .drag-handle:hover {
        background: var(--bs-primary);
        color: white;
    }

    .drag-handle:active {
        cursor: grabbing;
    }

    /* Sortable states */
    .sortable-ghost {
        opacity: 0.4;
        background: var(--bs-primary);
    }

    .sortable-drag {
        opacity: 1;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    /* Value section tabs */
    .value-section .nav-tabs {
        border-bottom: none;
    }

    .value-section .nav-tabs .nav-link {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 4px 4px 0 0;
        border: 1px solid transparent;
        margin-right: 2px;
    }

    .value-section .nav-tabs .nav-link.active {
        background: var(--bs-light);
        border-color: var(--bs-border-color);
        border-bottom-color: var(--bs-light);
    }

    /* Field preview */
    .field-preview {
        background: var(--bs-light);
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 0.875rem;
    }

    .field-preview .preview-value {
        color: var(--bs-primary);
    }

    /* Small nav tabs variant */
    .nav-tabs-sm .nav-link {
        font-size: 0.8125rem;
        padding: 6px 12px;
    }

    /* Button icon variant - more specific to override other styles */
    .field-card .btn-icon {
        padding: 4px 8px !important;
        line-height: 1 !important;
        min-width: auto !important;
        height: auto !important;
    }

    .field-card .btn-icon i {
        font-size: 1rem !important;
    }

    /* Fix visibility toggle in field cards */
    .field-card .form-switch {
        padding-left: 2.5em;
        min-height: auto;
    }

    .field-card .form-switch .form-check-input {
        width: 2em;
        height: 1em;
        margin-left: -2.5em;
    }

    /* Field card form controls */
    .field-card .form-control-sm,
    .field-card .form-select-sm {
        font-size: 0.8125rem;
        padding: 0.25rem 0.5rem;
    }

    /* Empty state for no fields */
    .pass-field-empty {
        opacity: 0.6;
    }

    /* Cursor for collapsible header */
    .cursor-pointer {
        cursor: pointer;
    }

    /* Text alignment button group in field cards */
    .field-card .alignment-section {
        border-top: 1px solid var(--bs-border-color);
        padding-top: 8px;
    }

    .field-card .alignment-btns .btn {
        padding: 2px 6px !important;
        font-size: 0.875rem !important;
    }

    .field-card .alignment-btns .btn-check:checked + .btn {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
        color: white;
    }

    /* Format options section in field cards */
    .field-card .format-section {
        border-top: 1px solid var(--bs-border-color);
        padding-top: 8px;
    }

    .field-card .format-section .form-label {
        font-size: 0.7rem;
        margin-bottom: 0.25rem;
    }

    /* ========================================
       DARK MODE SUPPORT FOR FIELD CARDS
       ======================================== */
    [data-bs-theme="dark"] .field-card,
    .dark-style .field-card {
        background: var(--bs-card-bg, #2b2c40);
        border-color: var(--bs-border-color, #444564);
    }

    [data-bs-theme="dark"] .field-card:hover,
    .dark-style .field-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    [data-bs-theme="dark"] .field-card.inactive,
    .dark-style .field-card.inactive {
        background: rgba(255,255,255,0.05);
    }

    [data-bs-theme="dark"] .field-card-header,
    .dark-style .field-card-header {
        background: rgba(255,255,255,0.05);
        border-bottom-color: var(--bs-border-color, #444564);
    }

    [data-bs-theme="dark"] .value-section .tab-content,
    .dark-style .value-section .tab-content {
        background: rgba(255,255,255,0.03) !important;
        border-color: var(--bs-border-color, #444564) !important;
    }

    [data-bs-theme="dark"] .value-section .nav-tabs .nav-link.active,
    .dark-style .value-section .nav-tabs .nav-link.active {
        background: rgba(255,255,255,0.03);
        border-color: var(--bs-border-color, #444564);
        border-bottom-color: rgba(255,255,255,0.03);
        color: var(--bs-body-color);
    }

    [data-bs-theme="dark"] .value-section .nav-tabs .nav-link,
    .dark-style .value-section .nav-tabs .nav-link {
        color: var(--bs-secondary-color, #a3a4cc);
    }

    [data-bs-theme="dark"] .field-preview,
    .dark-style .field-preview {
        background: rgba(255,255,255,0.05);
    }

    [data-bs-theme="dark"] .field-card .form-control,
    [data-bs-theme="dark"] .field-card .form-select,
    .dark-style .field-card .form-control,
    .dark-style .field-card .form-select {
        background-color: var(--bs-body-bg, #232333);
        border-color: var(--bs-border-color, #444564);
        color: var(--bs-body-color, #a3a4cc);
    }

    [data-bs-theme="dark"] .field-card .form-control:focus,
    [data-bs-theme="dark"] .field-card .form-select:focus,
    .dark-style .field-card .form-control:focus,
    .dark-style .field-card .form-select:focus {
        background-color: var(--bs-body-bg, #232333);
        border-color: var(--bs-primary);
        color: var(--bs-body-color);
    }

    [data-bs-theme="dark"] .field-card .alignment-btns .btn-outline-secondary,
    .dark-style .field-card .alignment-btns .btn-outline-secondary {
        border-color: var(--bs-border-color, #444564);
        color: var(--bs-secondary-color, #a3a4cc);
    }

    [data-bs-theme="dark"] .field-card .alignment-btns .btn-outline-secondary:hover,
    .dark-style .field-card .alignment-btns .btn-outline-secondary:hover {
        background-color: rgba(255,255,255,0.1);
        color: var(--bs-body-color);
    }

    [data-bs-theme="dark"] .fields-sortable-container .empty-state,
    .dark-style .fields-sortable-container .empty-state {
        color: var(--bs-secondary-color, #a3a4cc);
    }

    [data-bs-theme="dark"] .field-limit-item,
    .dark-style .field-limit-item {
        background: rgba(255,255,255,0.05);
        border-color: var(--bs-border-color, #444564);
    }

    [data-bs-theme="dark"] .field-location-badge,
    .dark-style .field-location-badge {
        opacity: 0.9;
    }

    /* Dark mode dropdown menus */
    [data-bs-theme="dark"] .field-card .dropdown-menu,
    .dark-style .field-card .dropdown-menu {
        background-color: var(--bs-body-bg, #232333);
        border-color: var(--bs-border-color, #444564);
    }

    [data-bs-theme="dark"] .field-card .dropdown-item,
    .dark-style .field-card .dropdown-item {
        color: var(--bs-body-color, #a3a4cc);
    }

    [data-bs-theme="dark"] .field-card .dropdown-item:hover,
    .dark-style .field-card .dropdown-item:hover {
        background-color: rgba(255,255,255,0.1);
        color: var(--bs-body-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-1">
                <i class="ti ti-brush me-2"></i>{{ pass_type.name }}
                <span class="unsaved-indicator badge bg-warning ms-2">Unsaved</span>
            </h2>
            <p class="text-muted mb-0">Configure your {{ pass_type.name }} wallet pass</p>
        </div>
        <div class="d-flex gap-2">
            <!-- Pass Type Switcher -->
            {% if other_type %}
            <a href="{{ url_for('pass_studio.studio', pass_type_code=other_type.code) }}" class="btn btn-outline-secondary">
                <i class="ti ti-switch-horizontal me-1"></i> Switch to {{ other_type.name }}
            </a>
            {% endif %}
            <a href="{{ url_for('pass_studio.index') }}" class="btn btn-outline-secondary">
                <i class="ti ti-arrow-left me-1"></i> Back
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Live Preview -->
        <div class="col-lg-4 mb-4">
            <div class="pass-preview-container">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="ti ti-device-mobile me-2"></i>Live Preview</h6>
                    </div>
                    <div class="card-body">
                        {% include 'admin/pass_studio/components/preview_card.html' %}
                    </div>
                    <div class="card-footer text-center">
                        <small class="text-muted">Preview updates as you make changes</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Editor Tabs -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <!-- Tabs -->
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if active_tab == 'appearance' }}" data-bs-toggle="tab" href="#tab-appearance" role="tab">
                                <i class="ti ti-palette me-1"></i> Appearance
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if active_tab == 'fields' }}" data-bs-toggle="tab" href="#tab-fields" role="tab">
                                <i class="ti ti-forms me-1"></i> Fields
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if active_tab == 'locations' }}" data-bs-toggle="tab" href="#tab-locations" role="tab">
                                <i class="ti ti-map-pin me-1"></i> Locations
                                <span class="badge bg-{{ 'success' if location_count < max_locations else 'warning' }} ms-1">{{ location_count }}/{{ max_locations }}</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if active_tab == 'sponsors' }}" data-bs-toggle="tab" href="#tab-sponsors" role="tab">
                                <i class="ti ti-building-store me-1"></i> Sponsors
                            </a>
                        </li>
                        {% if pass_type_code == 'ecs_membership' %}
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if active_tab == 'subgroups' }}" data-bs-toggle="tab" href="#tab-subgroups" role="tab">
                                <i class="ti ti-users-group me-1"></i> Subgroups
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Appearance Tab -->
                        <div class="tab-pane fade {{ 'show active' if active_tab == 'appearance' }}" id="tab-appearance" role="tabpanel">
                            {% include 'admin/pass_studio/components/appearance_tab.html' %}
                        </div>

                        <!-- Fields Tab -->
                        <div class="tab-pane fade {{ 'show active' if active_tab == 'fields' }}" id="tab-fields" role="tabpanel">
                            {% include 'admin/pass_studio/components/fields_tab.html' %}
                        </div>

                        <!-- Locations Tab -->
                        <div class="tab-pane fade {{ 'show active' if active_tab == 'locations' }}" id="tab-locations" role="tabpanel">
                            {% include 'admin/pass_studio/components/locations_tab.html' %}
                        </div>

                        <!-- Sponsors Tab -->
                        <div class="tab-pane fade {{ 'show active' if active_tab == 'sponsors' }}" id="tab-sponsors" role="tabpanel">
                            {% include 'admin/pass_studio/components/sponsors_tab.html' %}
                        </div>

                        {% if pass_type_code == 'ecs_membership' %}
                        <!-- Subgroups Tab -->
                        <div class="tab-pane fade {{ 'show active' if active_tab == 'subgroups' }}" id="tab-subgroups" role="tabpanel">
                            {% include 'admin/pass_studio/components/subgroups_tab.html' %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Asset Cropper Modal #}
{% include 'admin/pass_studio/components/asset_cropper_modal.html' %}
{% endblock %}

{% block scripts %}
{# Asset Cropper Library #}
<script src="{{ url_for('static', filename='js/pass-studio-cropper.js') }}"></script>

<script>
// Pass Studio JavaScript
const PassStudio = {
    passTypeCode: '{{ pass_type_code }}',
    hasUnsavedChanges: false,
    previewData: null,
    currentPlatform: 'apple',
    assets: {},

    init() {
        this.loadPreviewData();
        this.loadAssets();
        this.bindEvents();
        this.initColorPickers();
    },

    bindEvents() {
        // Track changes
        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener('change', () => this.markUnsaved());
        });

        // Warn on page leave
        window.addEventListener('beforeunload', (e) => {
            if (this.hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    },

    markUnsaved() {
        this.hasUnsavedChanges = true;
        document.body.classList.add('has-unsaved-changes');
    },

    markSaved() {
        this.hasUnsavedChanges = false;
        document.body.classList.remove('has-unsaved-changes');
    },

    async loadPreviewData() {
        try {
            const response = await fetch(`/admin/wallet/studio/${this.passTypeCode}/preview`);
            const data = await response.json();
            if (data.success) {
                this.previewData = data;
                this.updatePreview();
            }
        } catch (error) {
            console.error('Error loading preview data:', error);
        }
    },

    async loadAssets() {
        try {
            const response = await fetch(`/admin/wallet/studio/${this.passTypeCode}/assets`);
            const data = await response.json();
            if (data.success) {
                this.assets = data.assets || {};
                this.updateAssetPreviews();
            }
        } catch (error) {
            console.error('Error loading assets:', error);
        }
    },

    updateAssetPreviews() {
        // Update asset preview cards in Appearance tab
        Object.entries(this.assets).forEach(([assetType, asset]) => {
            const card = document.querySelector(`.asset-upload-card[data-asset-type="${assetType}"]`);
            if (card && asset && asset.url) {
                const preview = card.querySelector('.asset-preview');
                if (preview) {
                    // Replace placeholder with actual image
                    preview.innerHTML = `
                        <img src="${asset.url}" alt="${assetType}" id="asset-preview-${assetType}">
                        <span class="badge bg-success position-absolute top-0 end-0 m-1"><i class="ti ti-check"></i></span>
                    `;
                }
            }
        });

        // Update live preview card assets
        this.updateLivePreviewAssets();
    },

    updateLivePreviewAssets() {
        // Update Apple preview assets
        // Logo is optional - hide if not uploaded, show if uploaded
        const previewLogo = document.getElementById('preview-logo');
        const previewStrip = document.getElementById('preview-strip');

        if (previewLogo) {
            if (this.assets.logo && this.assets.logo.url) {
                previewLogo.style.display = 'flex';
                previewLogo.innerHTML = `<img src="${this.assets.logo.url}" alt="Logo">`;
            } else {
                // No logo - hide the logo area entirely for cleaner look
                previewLogo.style.display = 'none';
                previewLogo.innerHTML = '';
            }
        }

        // Strip image is now positioned absolutely behind the primary field overlay
        if (previewStrip) {
            // Find or create the strip image element
            let stripImg = previewStrip.querySelector('.pass-strip-image');
            const primaryOverlay = previewStrip.querySelector('.pass-primary-field-overlay');

            if (this.assets.strip && this.assets.strip.url) {
                if (!stripImg) {
                    stripImg = document.createElement('img');
                    stripImg.className = 'pass-strip-image';
                    stripImg.alt = 'Strip';
                    // Insert before the overlay
                    if (primaryOverlay) {
                        previewStrip.insertBefore(stripImg, primaryOverlay);
                    } else {
                        previewStrip.appendChild(stripImg);
                    }
                }
                stripImg.src = this.assets.strip.url;
            } else if (stripImg) {
                stripImg.remove();
            }
        }

        // Update Google preview logo
        const googleLogo = document.getElementById('preview-google-logo');
        if (googleLogo) {
            const googleLogoUrl = document.getElementById('google_logo_url')?.value;
            if (googleLogoUrl) {
                googleLogo.innerHTML = `<img src="${googleLogoUrl}" alt="Logo">`;
            } else if (this.assets.logo && this.assets.logo.url) {
                // Fall back to Apple logo
                googleLogo.innerHTML = `<img src="${this.assets.logo.url}" alt="Logo">`;
            }
        }
    },

    setPreviewPlatform(platform) {
        this.currentPlatform = platform;

        // Update button states
        document.querySelectorAll('[data-platform]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.platform === platform);
        });

        // Show/hide preview containers
        const applePreview = document.getElementById('apple-preview');
        const googlePreview = document.getElementById('google-preview');

        if (applePreview && googlePreview) {
            if (platform === 'apple') {
                applePreview.classList.remove('d-none');
                googlePreview.classList.add('d-none');
            } else {
                applePreview.classList.add('d-none');
                googlePreview.classList.remove('d-none');
            }
        }
    },

    /**
     * Update UI when pass style is changed
     * Shows/hides appropriate assets and updates preview layout
     */
    updatePassStylePreview() {
        const passStyle = document.querySelector('input[name="apple_pass_style"]:checked')?.value || 'generic';

        // Update style descriptions
        document.querySelectorAll('[id^="style-desc-"]').forEach(el => el.style.display = 'none');
        const descEl = document.getElementById(`style-desc-${passStyle}`);
        if (descEl) descEl.style.display = 'block';

        // Show/hide appropriate asset containers
        const stripWrapper = document.getElementById('asset-strip-wrapper');
        const thumbnailWrapper = document.getElementById('asset-thumbnail-wrapper');

        if (passStyle === 'generic') {
            // Generic uses thumbnail, not strip
            if (stripWrapper) stripWrapper.style.display = 'none';
            if (thumbnailWrapper) thumbnailWrapper.style.display = 'block';
        } else {
            // storeCard and eventTicket use strip, not thumbnail
            if (stripWrapper) stripWrapper.style.display = 'block';
            if (thumbnailWrapper) thumbnailWrapper.style.display = 'none';
        }

        // Update the preview card layout
        this.updatePreviewForPassStyle(passStyle);
    },

    /**
     * Update the preview card to reflect the selected pass style
     *
     * Layout differences:
     * - generic: Thumbnail in header, primary fields in separate section, no strip
     * - storeCard: Strip with primary field OVERLAID on it
     * - eventTicket: Strip displayed CLEAN (no overlay), fields below, notch at top
     */
    updatePreviewForPassStyle(passStyle) {
        const appleCard = document.getElementById('pass-preview');
        if (!appleCard) return;

        // Remove old style classes and add new one
        appleCard.classList.remove('pass-style-generic', 'pass-style-storeCard', 'pass-style-eventTicket');
        appleCard.classList.add(`pass-style-${passStyle}`);
        appleCard.setAttribute('data-pass-style', passStyle);

        // Get all the dynamic elements
        const stripArea = appleCard.querySelector('.pass-strip-area');
        const thumbnail = appleCard.querySelector('.pass-thumbnail');
        const primarySection = appleCard.querySelector('.pass-primary-fields-section');
        const primaryOverlay = appleCard.querySelector('.pass-primary-field-overlay');
        const notch = appleCard.querySelector('.pass-notch');

        if (passStyle === 'generic') {
            // Generic: hide strip, show thumbnail in header, show primary section below
            if (stripArea) stripArea.style.display = 'none';
            if (thumbnail) thumbnail.style.display = 'block';
            if (primarySection) primarySection.style.display = 'block';
            if (primaryOverlay) primaryOverlay.style.display = 'none';
            if (notch) notch.style.display = 'none';
        } else if (passStyle === 'eventTicket') {
            // EventTicket: show strip CLEAN (no overlay), hide thumbnail, show notch
            // Fields go in secondary/auxiliary below the strip
            if (stripArea) stripArea.style.display = 'flex';
            if (thumbnail) thumbnail.style.display = 'none';
            if (primarySection) primarySection.style.display = 'none';
            if (primaryOverlay) primaryOverlay.style.display = 'none'; // No overlay on eventTicket!
            if (notch) notch.style.display = 'block';
        } else {
            // storeCard: show strip WITH primary overlay, hide thumbnail, hide notch
            if (stripArea) stripArea.style.display = 'flex';
            if (thumbnail) thumbnail.style.display = 'none';
            if (primarySection) primarySection.style.display = 'none';
            if (primaryOverlay) primaryOverlay.style.display = 'block'; // Overlay visible for storeCard
            if (notch) notch.style.display = 'none';
        }
    },

    openAssetCropper(assetType) {
        if (typeof AssetCropper !== 'undefined') {
            // Pass existing asset URL so cropper knows to show delete button
            const existingUrl = this.assets[assetType]?.url || null;
            AssetCropper.open(assetType, this.passTypeCode, existingUrl);
        } else {
            console.error('AssetCropper not loaded');
            this.showToast('Asset cropper not available', 'error');
        }
    },

    onAssetUploaded(assetType, assetData) {
        // Update local assets cache
        this.assets[assetType] = assetData;

        // Update the preview cards
        this.updateAssetPreviews();

        // Refresh live preview
        this.updateLivePreviewAssets();
    },

    onAssetDeleted(assetType) {
        // Remove from local assets cache
        delete this.assets[assetType];

        // Update the preview cards to show placeholder
        const previewCard = document.querySelector(`[data-asset-type="${assetType}"]`);
        if (previewCard) {
            const previewArea = previewCard.querySelector('.asset-preview');
            if (previewArea) {
                previewArea.innerHTML = `
                    <div class="asset-placeholder">
                        <i class="ti ti-photo fs-1"></i>
                    </div>
                `;
            }
            // Remove the uploaded badge
            const badge = previewCard.querySelector('.badge.bg-success');
            if (badge) badge.remove();
        }

        // Refresh live preview
        this.updateLivePreviewAssets();
    },

    updateGooglePreview() {
        const heroUrl = document.getElementById('google_hero_image_url')?.value;
        const logoUrl = document.getElementById('google_logo_url')?.value;

        const heroPreview = document.getElementById('preview-google-hero');
        const logoPreview = document.getElementById('preview-google-logo');

        if (heroPreview) {
            if (heroUrl) {
                heroPreview.style.backgroundImage = `url('${heroUrl}')`;
                heroPreview.innerHTML = '';
            } else {
                heroPreview.style.backgroundImage = '';
                heroPreview.innerHTML = `
                    <div class="google-hero-placeholder">
                        <i class="ti ti-photo-plus"></i>
                        <span>Hero Image</span>
                    </div>
                `;
            }
        }

        if (logoPreview) {
            if (logoUrl) {
                logoPreview.innerHTML = `<img src="${logoUrl}" alt="Logo">`;
            } else if (this.assets.logo && this.assets.logo.url) {
                logoPreview.innerHTML = `<img src="${this.assets.logo.url}" alt="Logo">`;
            } else {
                logoPreview.innerHTML = `
                    <div class="google-logo-placeholder">
                        <i class="ti ti-building"></i>
                    </div>
                `;
            }
        }
    },

    updatePreview() {
        // Update Apple preview card
        const appleCard = document.getElementById('pass-preview');
        if (appleCard && this.previewData) {
            const pt = this.previewData.pass_type;

            // Update colors
            appleCard.style.backgroundColor = pt.background_color;
            appleCard.style.color = pt.foreground_color;

            // Update label colors
            appleCard.querySelectorAll('.pass-field-label').forEach(el => {
                el.style.color = pt.label_color;
            });

            // Update logo text
            const logoText = document.getElementById('preview-logo-text');
            if (logoText) logoText.textContent = pt.logo_text;
        }

        // Update Google preview card
        const googleContent = document.querySelector('.google-pass-content');
        if (googleContent && this.previewData) {
            const pt = this.previewData.pass_type;
            googleContent.style.backgroundColor = pt.background_color;
            googleContent.style.color = pt.foreground_color;

            googleContent.querySelectorAll('.google-info-label, .google-card-subtitle').forEach(el => {
                el.style.color = pt.label_color;
            });
        }

        // Update assets in live preview
        this.updateLivePreviewAssets();
    },

    /**
     * Update preview fields from FieldsManager data
     * Called when fields are added, removed, or modified
     */
    updatePreviewFields(frontFields, sampleData) {
        if (!frontFields || !sampleData) return;

        // Group fields by location
        const fieldsByLocation = {
            header: frontFields.filter(f => f.field_location === 'header' && f.is_visible !== false),
            primary: frontFields.filter(f => f.field_location === 'primary' && f.is_visible !== false),
            secondary: frontFields.filter(f => f.field_location === 'secondary' && f.is_visible !== false),
            auxiliary: frontFields.filter(f => f.field_location === 'auxiliary' && f.is_visible !== false)
        };

        // Get current label color
        const labelColor = document.getElementById('label_color')?.value ||
                          this.previewData?.pass_type?.label_color ||
                          (typeof ECSTheme !== 'undefined' ? ECSTheme.getColor('neutral-50') : '#999999');

        // Helper to resolve template value
        const resolveValue = (field) => {
            if (!field.value_template) return field.default_value || '';
            let value = field.value_template;
            for (const [key, val] of Object.entries(sampleData)) {
                value = value.replace(new RegExp('\\{\\{' + key + '\\}\\}', 'g'), val || '');
            }
            return value;
        };

        // Update Apple Preview
        this.updateApplePreviewFields(fieldsByLocation, labelColor, resolveValue);

        // Update Google Preview
        this.updateGooglePreviewFields(fieldsByLocation, labelColor, resolveValue);
    },

    updateApplePreviewFields(fieldsByLocation, labelColor, resolveValue) {
        const appleCard = document.getElementById('pass-preview');
        if (!appleCard) return;

        // Update Header Fields (right side of header row)
        const headerRow = appleCard.querySelector('.pass-header');
        let headerFieldsContainer = appleCard.querySelector('.pass-header-fields');

        if (fieldsByLocation.header.length > 0) {
            if (!headerFieldsContainer) {
                // Create header fields container if it doesn't exist
                headerFieldsContainer = document.createElement('div');
                headerFieldsContainer.className = 'pass-header-fields';
                headerFieldsContainer.id = 'preview-header-fields';
                // Insert before thumbnail (if exists) or at end of header
                const thumbnail = headerRow.querySelector('.pass-thumbnail');
                if (thumbnail) {
                    headerRow.insertBefore(headerFieldsContainer, thumbnail);
                } else {
                    headerRow.appendChild(headerFieldsContainer);
                }
            }
            headerFieldsContainer.style.display = 'flex';
            headerFieldsContainer.innerHTML = fieldsByLocation.header.map(field => `
                <div class="pass-header-field">
                    <div class="pass-field-label" style="color: ${labelColor};">${field.label || ''}</div>
                    <div class="pass-field-value">${resolveValue(field)}</div>
                </div>
            `).join('');
        } else if (headerFieldsContainer) {
            headerFieldsContainer.style.display = 'none';
            headerFieldsContainer.innerHTML = '';
        }

        // Update Primary Field (overlaid on strip area for storeCard, or in primary section for generic)
        const passStyle = appleCard.getAttribute('data-pass-style') || 'generic';
        let primaryOverlay = appleCard.querySelector('.pass-primary-field-overlay');
        let primarySection = appleCard.querySelector('.pass-primary-fields-section');

        if (primaryOverlay) {
            // For storeCard, show primary in overlay (eventTicket doesn't use primary overlay)
            if (passStyle === 'storeCard' && fieldsByLocation.primary.length > 0) {
                const field = fieldsByLocation.primary[0];
                primaryOverlay.innerHTML = `
                    <div class="pass-field-label" style="color: ${labelColor};">${field.label || ''}</div>
                    <div class="pass-field-value">${resolveValue(field)}</div>
                `;
            } else if (passStyle === 'storeCard') {
                primaryOverlay.innerHTML = `
                    <div class="pass-field-label" style="color: ${labelColor}; opacity: 0.5;">MEMBER</div>
                    <div class="pass-field-value" style="opacity: 0.5;">No primary field</div>
                `;
            }
        }

        if (primarySection) {
            // For generic, show primary in separate section
            if (passStyle === 'generic' && fieldsByLocation.primary.length > 0) {
                primarySection.innerHTML = fieldsByLocation.primary.map(field => `
                    <div class="pass-field primary-field">
                        <div class="pass-field-label" style="color: ${labelColor};">${field.label || ''}</div>
                        <div class="pass-field-value">${resolveValue(field)}</div>
                    </div>
                `).join('');
            } else if (passStyle === 'generic') {
                primarySection.innerHTML = `
                    <div class="pass-field primary-field">
                        <div class="pass-field-label" style="color: ${labelColor}; opacity: 0.5;">MEMBER</div>
                        <div class="pass-field-value" style="opacity: 0.5;">No primary field</div>
                    </div>
                `;
            }
        }

        // Update Secondary/Auxiliary Fields (below strip)
        // For eventTicket, also include primary fields here since they don't go on strip
        let secondaryContainer = appleCard.querySelector('.pass-secondary-fields');
        let allSecondary = [...fieldsByLocation.secondary, ...fieldsByLocation.auxiliary];

        // For eventTicket, primary fields move to secondary
        if (passStyle === 'eventTicket') {
            allSecondary = [...fieldsByLocation.primary, ...allSecondary];
        }

        if (allSecondary.length > 0) {
            if (!secondaryContainer) {
                secondaryContainer = document.createElement('div');
                secondaryContainer.className = 'pass-secondary-fields';
                const stripArea = appleCard.querySelector('.pass-strip-area');
                const primarySec = appleCard.querySelector('.pass-primary-fields-section');
                if (stripArea && stripArea.style.display !== 'none') {
                    stripArea.after(secondaryContainer);
                } else if (primarySec) {
                    primarySec.after(secondaryContainer);
                }
            }
            secondaryContainer.innerHTML = allSecondary.map(field => `
                <div class="pass-field">
                    <div class="pass-field-label" style="color: ${labelColor};">${field.label || ''}</div>
                    <div class="pass-field-value">${resolveValue(field)}</div>
                </div>
            `).join('');
        } else if (secondaryContainer) {
            secondaryContainer.remove();
        }
    },

    updateGooglePreviewFields(fieldsByLocation, labelColor, resolveValue) {
        const googleContent = document.querySelector('.google-pass-content');
        if (!googleContent) return;

        // Update Primary Value
        let primaryValue = googleContent.querySelector('.google-primary-value');
        if (fieldsByLocation.primary.length > 0) {
            const field = fieldsByLocation.primary[0];
            if (!primaryValue) {
                primaryValue = document.createElement('div');
                primaryValue.className = 'google-primary-value';
                const header = googleContent.querySelector('.google-header');
                if (header) header.after(primaryValue);
            }
            primaryValue.classList.remove('text-muted');
            primaryValue.textContent = resolveValue(field);
        } else if (primaryValue) {
            primaryValue.classList.add('text-muted');
            primaryValue.textContent = 'No primary field configured';
        }

        // Update Info Rows
        let infoRows = googleContent.querySelector('.google-info-rows');
        const allSecondary = [...fieldsByLocation.secondary, ...fieldsByLocation.auxiliary];

        if (allSecondary.length > 0) {
            if (!infoRows) {
                infoRows = document.createElement('div');
                infoRows.className = 'google-info-rows';
                const primaryEl = googleContent.querySelector('.google-primary-value');
                if (primaryEl) primaryEl.after(infoRows);
            }
            infoRows.innerHTML = allSecondary.map(field => `
                <div class="google-info-row">
                    <span class="google-info-label" style="color: ${labelColor};">${field.label || ''}</span>
                    <span class="google-info-value">${resolveValue(field)}</span>
                </div>
            `).join('');
        } else if (infoRows) {
            infoRows.remove();
        }
    },

    updatePreviewFromForm() {
        // Get form values
        const bgColor = document.getElementById('background_color')?.value;
        const fgColor = document.getElementById('foreground_color')?.value;
        const lblColor = document.getElementById('label_color')?.value;
        const logoText = document.getElementById('logo_text')?.value;

        // Update Apple preview
        const appleCard = document.getElementById('pass-preview');
        if (appleCard) {
            if (bgColor) appleCard.style.backgroundColor = bgColor;
            if (fgColor) appleCard.style.color = fgColor;
            if (lblColor) {
                appleCard.querySelectorAll('.pass-field-label').forEach(el => {
                    el.style.color = lblColor;
                });
            }
            if (logoText !== undefined) {
                const logoEl = document.getElementById('preview-logo-text');
                if (logoEl) logoEl.textContent = logoText;
            }
        }

        // Update Google preview
        const googleContent = document.querySelector('.google-pass-content');
        if (googleContent) {
            if (bgColor) googleContent.style.backgroundColor = bgColor;
            if (fgColor) googleContent.style.color = fgColor;
            if (lblColor) {
                googleContent.querySelectorAll('.google-info-label, .google-card-subtitle').forEach(el => {
                    el.style.color = lblColor;
                });
            }
        }
    },

    updateBarcodePreview() {
        const suppressBarcode = document.getElementById('suppress_barcode')?.checked;

        // Update Apple preview
        const appleBarcodeArea = document.querySelector('#apple-preview .pass-barcode-area');
        if (appleBarcodeArea) {
            appleBarcodeArea.style.display = suppressBarcode ? 'none' : 'block';
        }

        // Update Google preview
        const googleBarcodeArea = document.querySelector('#google-preview .google-barcode-area');
        if (googleBarcodeArea) {
            googleBarcodeArea.style.display = suppressBarcode ? 'none' : 'block';
        }
    },

    initColorPickers() {
        // Initialize color picker inputs
        document.querySelectorAll('.color-input').forEach(input => {
            input.addEventListener('input', () => {
                this.updatePreviewFromForm();
                this.markUnsaved();
            });
        });
    },

    /**
     * Toggle logo visibility in the preview
     */
    toggleLogoVisibility() {
        const showLogo = document.getElementById('show_logo')?.checked ?? true;
        const previewLogo = document.getElementById('preview-logo');

        if (previewLogo) {
            if (showLogo && this.assets.logo && this.assets.logo.url) {
                previewLogo.style.display = 'flex';
            } else {
                previewLogo.style.display = 'none';
            }
        }
    },

    async saveAppearance() {
        const form = document.getElementById('appearance-form');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        // Include Google Wallet URLs
        data.google_hero_image_url = document.getElementById('google_hero_image_url')?.value || '';
        data.google_logo_url = document.getElementById('google_logo_url')?.value || '';

        // Explicitly include checkbox values (checkboxes don't send value when unchecked)
        data.suppress_barcode = document.getElementById('suppress_barcode')?.checked || false;
        data.show_logo = document.getElementById('show_logo')?.checked ?? true;

        // Include pass style
        const passStyleRadio = document.querySelector('input[name="apple_pass_style"]:checked');
        data.apple_pass_style = passStyleRadio?.value || 'generic';

        try {
            const response = await fetch(`/admin/wallet/studio/${this.passTypeCode}/appearance`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrf_token]').value
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                this.showToast('Appearance saved successfully', 'success');
                this.markSaved();
            } else {
                this.showToast(result.error || 'Error saving appearance', 'error');
            }
        } catch (error) {
            console.error('Error saving appearance:', error);
            this.showToast('Error saving appearance', 'error');
        }
    },

    showToast(message, type = 'info') {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: type,
                title: message,
                showConfirmButton: false,
                timer: 3000
            });
        } else {
            alert(message);
        }
    },

    insertVariable(fieldId, variable) {
        const input = document.getElementById(fieldId);
        if (input) {
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            const variableText = '{{ "{{" }}' + variable + '{{ "}}" }}';
            input.value = text.substring(0, start) + variableText + text.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + variableText.length;
            this.markUnsaved();
        }
    }
};

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', () => {
    PassStudio.init();
});
</script>
{% endblock %}
