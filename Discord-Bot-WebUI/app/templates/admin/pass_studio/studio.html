{% extends 'admin/layout.html' %}
{% block title %}Pass Studio - {{ pass_type.name }}{% endblock %}

{% block custom_css %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/pass-studio.css') }}">
{% endif %}
{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-1">
                <i class="ti ti-brush me-2"></i>{{ pass_type.name }}
                <span class="unsaved-indicator badge bg-warning ms-2" data-badge>Unsaved</span>
            </h2>
            <p class="text-muted mb-0">Configure your {{ pass_type.name }} wallet pass</p>
        </div>
        <div class="d-flex gap-2">
            <!-- Pass Type Switcher -->
            {% if other_type %}
            <a href="{{ url_for('pass_studio.studio', pass_type_code=other_type.code) }}" class="c-btn c-btn--outline-secondary">
                <i class="ti ti-switch-horizontal me-1"></i> Switch to {{ other_type.name }}
            </a>
            {% endif %}
            <a href="{{ url_for('pass_studio.index') }}" class="c-btn c-btn--outline-secondary">
                <i class="ti ti-arrow-left me-1"></i> Back
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Live Preview -->
        <div class="col-lg-4 mb-4">
            <div class="pass-preview-container">
                <div class="c-card">
                    <div class="c-card__header">
                        <h6 class="c-card__title"><i class="ti ti-device-mobile me-2"></i>Live Preview</h6>
                    </div>
                    <div class="c-card__body">
                        {% include 'admin/pass_studio/components/preview_card.html' %}
                    </div>
                    <div class="c-card__footer c-card__footer--center">
                        <small class="c-text-muted">Preview updates as you make changes</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Editor Tabs -->
        <div class="col-lg-8">
            <div class="c-card">
                <div class="c-card__header">
                    <!-- Tabs -->
                    <ul class="c-tabs" role="tablist" data-tabs>
                        <li class="c-tabs__item">
                            <button class="c-tabs__link {{ 'is-active' if active_tab == 'appearance' }}" data-bs-toggle="tab" data-bs-target="#tab-appearance" type="button" role="tab">
                                <i class="ti ti-palette me-1"></i> Appearance
                            </button>
                        </li>
                        <li class="c-tabs__item">
                            <button class="c-tabs__link {{ 'is-active' if active_tab == 'fields' }}" data-bs-toggle="tab" data-bs-target="#tab-fields" type="button" role="tab">
                                <i class="ti ti-forms me-1"></i> Fields
                            </button>
                        </li>
                        <li class="c-tabs__item">
                            <button class="c-tabs__link {{ 'is-active' if active_tab == 'locations' }}" data-bs-toggle="tab" data-bs-target="#tab-locations" type="button" role="tab">
                                <i class="ti ti-map-pin me-1"></i> Locations
                                <span class="c-badge c-badge--{{ 'success' if location_count < max_locations else 'warning' }} ms-1">{{ location_count }}/{{ max_locations }}</span>
                            </button>
                        </li>
                        <li class="c-tabs__item">
                            <button class="c-tabs__link {{ 'is-active' if active_tab == 'sponsors' }}" data-bs-toggle="tab" data-bs-target="#tab-sponsors" type="button" role="tab">
                                <i class="ti ti-building-store me-1"></i> Sponsors
                            </button>
                        </li>
                        {% if pass_type_code == 'ecs_membership' %}
                        <li class="c-tabs__item">
                            <button class="c-tabs__link {{ 'is-active' if active_tab == 'subgroups' }}" data-bs-toggle="tab" data-bs-target="#tab-subgroups" type="button" role="tab">
                                <i class="ti ti-users-group me-1"></i> Subgroups
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="c-card__body">
                    <div class="c-tabs__content">
                        <!-- Appearance Tab -->
                        <div class="c-tabs__pane {{ 'is-active' if active_tab == 'appearance' }}" data-tab-id="tab-appearance" role="tabpanel">
                            {% include 'admin/pass_studio/components/appearance_tab.html' %}
                        </div>

                        <!-- Fields Tab -->
                        <div class="c-tabs__pane {{ 'is-active' if active_tab == 'fields' }}" data-tab-id="tab-fields" role="tabpanel">
                            {% include 'admin/pass_studio/components/fields_tab.html' %}
                        </div>

                        <!-- Locations Tab -->
                        <div class="c-tabs__pane {{ 'is-active' if active_tab == 'locations' }}" data-tab-id="tab-locations" role="tabpanel">
                            {% include 'admin/pass_studio/components/locations_tab.html' %}
                        </div>

                        <!-- Sponsors Tab -->
                        <div class="c-tabs__pane {{ 'is-active' if active_tab == 'sponsors' }}" data-tab-id="tab-sponsors" role="tabpanel">
                            {% include 'admin/pass_studio/components/sponsors_tab.html' %}
                        </div>

                        {% if pass_type_code == 'ecs_membership' %}
                        <!-- Subgroups Tab -->
                        <div class="c-tabs__pane {{ 'is-active' if active_tab == 'subgroups' }}" data-tab-id="tab-subgroups" role="tabpanel">
                            {% include 'admin/pass_studio/components/subgroups_tab.html' %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
{{ super() }}
{# Add Field Modal #}
<div class="modal c-modal fade" id="addFieldModal" tabindex="-1" aria-labelledby="addFieldModalLabel" aria-hidden="true" data-modal>
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="addFieldModalLabel">
                    <i class="ti ti-plus-circle me-2"></i>Add New Field
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-dismiss></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body>
                <input type="hidden" id="add-field-type" value="front">

                <!-- Label -->
                <div class="mb-3">
                    <label class="form-label fw-medium">Field Label <span class="text-danger">*</span></label>
                    <input type="text" id="add-field-label" class="form-control" placeholder="e.g., MEMBER, YEAR, TEAM" data-form-control>
                    <div class="form-text">This appears above the field value on the pass</div>
                </div>

                <!-- Location (Front only) -->
                <div class="mb-3" id="add-field-location-group">
                    <label class="form-label fw-medium">Location <span class="text-danger">*</span></label>
                    <div class="d-flex flex-wrap gap-2">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="add-field-location" id="loc-primary" value="primary">
                            <label class="form-check-label" for="loc-primary">
                                <span class="badge bg-primary me-1" data-badge>Primary</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="add-field-location" id="loc-secondary" value="secondary" checked>
                            <label class="form-check-label" for="loc-secondary">
                                <span class="badge bg-info me-1" data-badge>Secondary</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="add-field-location" id="loc-auxiliary" value="auxiliary">
                            <label class="form-check-label" for="loc-auxiliary">
                                <span class="badge bg-warning me-1" data-badge>Auxiliary</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="add-field-location" id="loc-header" value="header">
                            <label class="form-check-label" for="loc-header">
                                <span class="badge bg-secondary me-1" data-badge>Header</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Field Type (Back only) -->
                <div class="mb-3 d-none" id="add-field-type-group">
                    <label class="form-label fw-medium">Field Type</label>
                    <select id="add-field-field-type" class="form-select" data-form-select>
                        <option value="text">Text</option>
                        <option value="url">URL (tappable link)</option>
                        <option value="phone">Phone Number</option>
                        <option value="email">Email Address</option>
                    </select>
                </div>

                <!-- Value Mode Tabs -->
                <div class="mb-3">
                    <label class="form-label fw-medium">Field Value</label>
                    <ul class="nav nav-tabs nav-tabs-sm" role="tablist" data-tabs>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="add-simple-tab" data-bs-toggle="tab" data-bs-target="#add-simple-mode" type="button" role="tab">
                                <i class="ti ti-list me-1"></i>Simple
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="add-advanced-tab" data-bs-toggle="tab" data-bs-target="#add-advanced-mode" type="button" role="tab">
                                <i class="ti ti-code me-1"></i>Advanced
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content border border-top-0 rounded-bottom p-3">
                        <!-- Simple Mode -->
                        <div class="tab-pane fade show active" id="add-simple-mode" role="tabpanel" data-tab-pane>
                            <select id="add-field-variable" class="form-select" data-form-select>
                                <option value="">-- Select a variable --</option>
                                {% for variable in template_variables %}
                                <option value="{% raw %}{{{% endraw %}{{ variable.name }}{% raw %}}}{% endraw %}" data-description="{{ variable.description }}">
                                    {{ variable.name }} - {{ variable.description }}
                                </option>
                                {% endfor %}
                                <option value="__static__">Static text (enter below)</option>
                            </select>
                            <input type="text" id="add-field-static" class="form-control mt-2 d-none" placeholder="Enter static text" data-form-control>
                        </div>
                        <!-- Advanced Mode -->
                        <div class="tab-pane fade" id="add-advanced-mode" role="tabpanel" data-tab-pane>
                            <div class="input-group" data-input-group>
                                <input type="text" id="add-field-template" class="form-control" placeholder="e.g., Welcome, {% raw %}{{member_name}}{% endraw %}!" data-form-control>
                                <div class="dropdown">
                                    <button class="c-btn c-btn--outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-dropdown-toggle>
                                        Insert
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" data-dropdown-menu>
                                        {% for variable in template_variables %}
                                        <li>
                                            <a class="dropdown-item js-insert-variable-add" href="#" data-action="insert-variable" data-variable-name="{{ variable.name }}">
                                                {{ variable.name }}
                                            </a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div class="form-text">Combine variables and text. Example: "Since {% raw %}{{member_since}}{% endraw %}"</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="button" class="c-btn c-btn--primary js-create-field" data-action="create-field">
                    <i class="ti ti-plus me-1"></i>Add Field
                </button>
            </div>
        </div>
    </div>
</div>

{# Asset Cropper Modal #}
{% include 'admin/pass_studio/components/asset_cropper_modal.html' %}
{% endblock %}

{% block scripts %}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
{# Asset Cropper Library #}
<script src="{{ url_for('static', filename='js/pass-studio-cropper.js') }}"></script>

{# Pass Studio Main JavaScript - Extracted from inline script #}
<script src="{{ url_for('static', filename='js/pass-studio.js') }}"></script>
{% endif %}


<script data-pass-type-code="{{ pass_type_code }}">
// Initialize with pass type code from data attribute
</script>
{% endblock %}
