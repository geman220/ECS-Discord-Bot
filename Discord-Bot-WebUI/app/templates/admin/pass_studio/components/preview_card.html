{# Pass Preview Card Component - Realistic Apple/Google Wallet Preview #}
{# Displays a visual mockup of the wallet pass that updates in real-time #}
{# Shows actual database field configuration - if no fields, shows empty state #}
{#
   PASS STYLES:
   - generic: Thumbnail on right side of header, all fields cleanly separated
   - storeCard: Strip image with primary field OVERLAID on top
   - eventTicket: Same as storeCard but with notch at top
#}

{# Platform Toggle #}
<div class="btn-group w-100 mb-3" role="group" aria-label="Platform preview toggle">
    <button type="button" class="c-btn c-btn--outline-primary active" data-platform="apple" data-action="toggle-platform">
        <i class="ti ti-brand-apple me-1"></i>Apple
    </button>
    <button type="button" class="c-btn c-btn--outline-primary" data-platform="google" data-action="toggle-platform">
        <i class="ti ti-brand-google me-1"></i>Google
    </button>
</div>

{# ========== APPLE WALLET PREVIEW ========== #}
{# Supports generic, storeCard, and eventTicket styles #}
<div id="apple-preview" class="pass-preview-platform">
    {% set current_style = pass_type.apple_pass_style or 'generic' %}
    <div class="apple-pass-card pass-style-{{ current_style }}" id="pass-preview"
         style="background-color: {{ pass_type.background_color }}; color: {{ pass_type.foreground_color }};"
         data-pass-style="{{ current_style }}">

        {# Event Ticket notch at top #}
        <div class="pass-notch {% if current_style != 'eventTicket' %}u-hidden{% endif %}" id="preview-notch"></div>

        {# Dynamic Fields from Database #}
        {# Note: is_visible defaults to True, so we check for not being explicitly False #}
        {% set header_fields = front_fields|selectattr('field_location', 'equalto', 'header')|rejectattr('is_visible', 'equalto', false)|list %}
        {% set primary_fields = front_fields|selectattr('field_location', 'equalto', 'primary')|rejectattr('is_visible', 'equalto', false)|list %}
        {% set secondary_fields = front_fields|selectattr('field_location', 'equalto', 'secondary')|rejectattr('is_visible', 'equalto', false)|list %}
        {% set auxiliary_fields = front_fields|selectattr('field_location', 'equalto', 'auxiliary')|rejectattr('is_visible', 'equalto', false)|list %}

        {# ===== HEADER ROW - Logo (optional) + Logo Text + Header Fields (+ Thumbnail for generic) ===== #}
        <div class="pass-header">
            {# Logo - optional, only show if uploaded AND show_logo is True #}
            {% set show_logo = pass_type.show_logo if pass_type.show_logo is not none else true %}
            <div class="pass-logo{% if not assets.get('logo') or not show_logo %} d-none{% endif %}" id="preview-logo">
                {% if assets.get('logo') %}
                <img src="{{ url_for('wallet_config.get_asset', asset_id=assets['logo'].id) }}" alt="Logo">
                {% endif %}
            </div>
            <div class="pass-logo-text" id="preview-logo-text">{{ pass_type.logo_text }}</div>

            {# Header Fields - appear on right side of header row #}
            <div class="pass-header-fields{% if not header_fields %} d-none{% endif %}" id="preview-header-fields">
                {% for field in header_fields %}
                <div class="pass-header-field">
                    <div class="pass-field-label" style="color: {{ pass_type.label_color }};">{{ field.label }}</div>
                    <div class="pass-field-value">
                        {%- set var_name = field.value_template|replace('{{', '')|replace('}}', '')|trim if field.value_template else '' -%}
                        {{ sample_data.get(var_name, field.value_template or field.default_value or '') }}
                    </div>
                </div>
                {% endfor %}
            </div>

            {# Thumbnail - Only for generic passes, appears on right side of header #}
            <div class="pass-thumbnail {% if current_style != 'generic' %}u-hidden{% endif %}" id="preview-thumbnail">
                {% if assets.get('thumbnail') %}
                <img src="{{ url_for('wallet_config.get_asset', asset_id=assets['thumbnail'].id) }}" alt="Thumbnail">
                {% else %}
                <div class="pass-thumbnail-placeholder">
                    <i class="ti ti-photo"></i>
                </div>
                {% endif %}
            </div>
        </div>

        {# ===== STRIP AREA - For storeCard (with overlay) and eventTicket (clean, no overlay) ===== #}
        <div class="pass-strip-area {% if current_style == 'generic' %}u-hidden{% endif %}" id="preview-strip">
            {# Strip image as background #}
            {% if assets.get('strip') %}
            <img src="{{ url_for('wallet_config.get_asset', asset_id=assets['strip'].id) }}" alt="Strip" class="pass-strip-image">
            {% endif %}

            {# Primary Field Overlay - ONLY for storeCard (eventTicket keeps strip clean) #}
            <div class="pass-primary-field-overlay {% if current_style == 'eventTicket' %}u-hidden{% endif %}" id="preview-primary-overlay">
                {% if primary_fields %}
                    {% for field in primary_fields %}
                    <div class="pass-field-label" style="color: {{ pass_type.label_color }};">{{ field.label }}</div>
                    <div class="pass-field-value">{{ sample_data.get(field.value_template|replace('{{', '')|replace('}}', ''), field.value_template) if field.value_template else field.default_value or '' }}</div>
                    {% endfor %}
                {% else %}
                <div class="pass-field-label u-opacity-50" style="color: {{ pass_type.label_color }};">MEMBER</div>
                <div class="pass-field-value u-opacity-50">No primary field</div>
                {% endif %}
            </div>
        </div>

        {# ===== PRIMARY FIELDS SECTION - Only for generic passes (below header, separated) ===== #}
        <div class="pass-primary-fields-section {% if current_style != 'generic' %}u-hidden{% endif %}" id="preview-primary-section">
            {% if primary_fields %}
                {% for field in primary_fields %}
                <div class="pass-field primary-field">
                    <div class="pass-field-label" style="color: {{ pass_type.label_color }};">{{ field.label }}</div>
                    <div class="pass-field-value">{{ sample_data.get(field.value_template|replace('{{', '')|replace('}}', ''), field.value_template) if field.value_template else field.default_value or '' }}</div>
                </div>
                {% endfor %}
            {% else %}
            <div class="pass-field primary-field">
                <div class="pass-field-label u-opacity-50" style="color: {{ pass_type.label_color }};">MEMBER</div>
                <div class="pass-field-value u-opacity-50">No primary field</div>
            </div>
            {% endif %}
        </div>

        {# ===== SECONDARY/AUXILIARY FIELDS - Below strip (or below primary for generic) ===== #}
        {% if secondary_fields or auxiliary_fields %}
        <div class="pass-secondary-fields">
            {% for field in secondary_fields %}
            <div class="pass-field">
                <div class="pass-field-label" style="color: {{ pass_type.label_color }};">{{ field.label }}</div>
                <div class="pass-field-value">{{ sample_data.get(field.value_template|replace('{{', '')|replace('}}', ''), field.value_template) if field.value_template else field.default_value or '' }}</div>
            </div>
            {% endfor %}
            {% for field in auxiliary_fields %}
            <div class="pass-field">
                <div class="pass-field-label" style="color: {{ pass_type.label_color }};">{{ field.label }}</div>
                <div class="pass-field-value">{{ sample_data.get(field.value_template|replace('{{', '')|replace('}}', ''), field.value_template) if field.value_template else field.default_value or '' }}</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {# ===== BARCODE AREA - Always at bottom ===== #}
        <div class="pass-barcode-area" id="preview-barcode-area">
            <div class="pass-barcode">
                <svg width="140" height="140" viewBox="0 0 100 100">
                    {# Simplified QR code pattern #}
                    <rect fill="#000" x="10" y="10" width="25" height="25"/>
                    <rect fill="#fff" x="15" y="15" width="15" height="15"/>
                    <rect fill="#000" x="18" y="18" width="9" height="9"/>
                    <rect fill="#000" x="65" y="10" width="25" height="25"/>
                    <rect fill="#fff" x="70" y="15" width="15" height="15"/>
                    <rect fill="#000" x="73" y="18" width="9" height="9"/>
                    <rect fill="#000" x="10" y="65" width="25" height="25"/>
                    <rect fill="#fff" x="15" y="70" width="15" height="15"/>
                    <rect fill="#000" x="18" y="73" width="9" height="9"/>
                    <rect fill="#000" x="40" y="40" width="20" height="20"/>
                    <rect fill="#000" x="40" y="10" width="5" height="5"/>
                    <rect fill="#000" x="50" y="15" width="5" height="5"/>
                    <rect fill="#000" x="45" y="25" width="5" height="5"/>
                    <rect fill="#000" x="65" y="45" width="5" height="5"/>
                    <rect fill="#000" x="75" y="50" width="5" height="5"/>
                    <rect fill="#000" x="85" y="45" width="5" height="5"/>
                    <rect fill="#000" x="70" y="70" width="5" height="5"/>
                    <rect fill="#000" x="80" y="75" width="5" height="5"/>
                    <rect fill="#000" x="85" y="85" width="5" height="5"/>
                </svg>
            </div>
        </div>
    </div>
</div>

{# ========== GOOGLE WALLET PREVIEW ========== #}
<div id="google-preview" class="pass-preview-platform d-none">
    <div class="google-pass-card">
        {# Hero Image #}
        <div class="google-hero-image" id="preview-google-hero"
             {% if pass_type.google_hero_image_url %}
             {% endif %}>
            {% if not pass_type.google_hero_image_url %}
            <div class="google-hero-placeholder">
                <i class="ti ti-photo-plus"></i>
                <span>Hero Image</span>
            </div>
            {% endif %}
        </div>

        {# Pass Content #}
        <div class="google-pass-content" style="background-color: {{ pass_type.background_color }}; color: {{ pass_type.foreground_color }};">
            {# Header with logo #}
            <div class="google-header">
                <div class="google-logo" id="preview-google-logo">
                    {% if pass_type.google_logo_url %}
                    <img src="{{ pass_type.google_logo_url }}" alt="Logo">
                    {% elif assets.get('logo') %}
                    <img src="{{ url_for('wallet_config.get_asset', asset_id=assets['logo'].id) }}" alt="Logo">
                    {% else %}
                    <div class="google-logo-placeholder">
                        <i class="ti ti-building"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="google-header-text">
                    <div class="google-card-title">{{ pass_type.name }}</div>
                    <div class="google-card-subtitle" style="color: {{ pass_type.label_color }};">
                        {% if pass_type_code == 'ecs_membership' %}Member{% else %}Player{% endif %}
                    </div>
                </div>
            </div>

            {# Primary Value from database #}
            {% if primary_fields %}
            <div class="google-primary-value">
                {% for field in primary_fields %}
                {{ sample_data.get(field.value_template|replace('{{', '')|replace('}}', ''), field.value_template) if field.value_template else field.default_value or '' }}
                {% endfor %}
            </div>
            {% else %}
            <div class="google-primary-value text-muted">No primary field configured</div>
            {% endif %}

            {# Info Rows from database #}
            {% if secondary_fields or auxiliary_fields %}
            <div class="google-info-rows">
                {% for field in secondary_fields %}
                <div class="google-info-row">
                    <span class="google-info-label" style="color: {{ pass_type.label_color }};">{{ field.label }}</span>
                    <span class="google-info-value">{{ sample_data.get(field.value_template|replace('{{', '')|replace('}}', ''), field.value_template) if field.value_template else field.default_value or '' }}</span>
                </div>
                {% endfor %}
                {% for field in auxiliary_fields %}
                <div class="google-info-row">
                    <span class="google-info-label" style="color: {{ pass_type.label_color }};">{{ field.label }}</span>
                    <span class="google-info-value">{{ sample_data.get(field.value_template|replace('{{', '')|replace('}}', ''), field.value_template) if field.value_template else field.default_value or '' }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {# Barcode #}
            <div class="google-barcode-area">
                <svg width="120" height="120" viewBox="0 0 100 100">
                    <rect fill="#000" x="10" y="10" width="25" height="25"/>
                    <rect fill="#fff" x="15" y="15" width="15" height="15"/>
                    <rect fill="#000" x="18" y="18" width="9" height="9"/>
                    <rect fill="#000" x="65" y="10" width="25" height="25"/>
                    <rect fill="#fff" x="70" y="15" width="15" height="15"/>
                    <rect fill="#000" x="73" y="18" width="9" height="9"/>
                    <rect fill="#000" x="10" y="65" width="25" height="25"/>
                    <rect fill="#fff" x="15" y="70" width="15" height="15"/>
                    <rect fill="#000" x="18" y="73" width="9" height="9"/>
                    <rect fill="#000" x="40" y="40" width="20" height="20"/>
                </svg>
            </div>
        </div>
    </div>
</div>

{# Preview Info #}
<div class="mt-3 text-center">
    <small class="text-muted d-block">
        <i class="ti ti-info-circle me-1"></i>
        Preview reflects your current field configuration.
        {% if not front_fields %}
        <br><strong class="text-warning">No fields configured - add fields in the Fields tab.</strong>
        {% endif %}
    </small>
</div>
