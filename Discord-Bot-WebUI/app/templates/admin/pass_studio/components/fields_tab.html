{# Fields Tab Component #}
{# Configure pass field layout and content - User-friendly redesign #}

<!-- Initialization Alert - Shows when no fields are configured -->
{% if not front_fields and not back_fields %}
<div class="alert alert-warning d-flex align-items-center mb-4" id="init-alert" data-alert>
    <i class="ti ti-alert-triangle me-3 card-icon-stat"></i>
    <div class="flex-grow-1">
        <h6 class="alert-heading mb-1">No Fields Configured</h6>
        <p class="mb-2">Your passes won't display any information until you configure fields. Would you like to load the default field configuration?</p>
        <button type="button" class="c-btn c-btn--warning c-btn--sm js-initialize-defaults" data-action="initialize-defaults">
            <i class="ti ti-settings me-1"></i>Load Default Fields
        </button>
        <span class="text-muted ms-2 small">This will create standard fields for Member Name, Year, etc.</span>
    </div>
</div>
{% endif %}

<!-- Field Limits Summary Bar -->
<!-- StoreCard limits: 1 primary, 3 header, 4 secondary+auxiliary COMBINED -->
<div class="field-limits-bar mb-4">
    <div class="d-flex flex-wrap gap-3 align-items-center">
        <div class="field-limit-item" id="limit-primary">
            <span class="limit-label">Primary</span>
            <span class="limit-count"><span class="current">0</span>/<span class="max">1</span></span>
        </div>
        <div class="field-limit-item" id="limit-secondary-auxiliary">
            <span class="limit-label">Secondary + Auxiliary</span>
            <span class="limit-count"><span class="current">0</span>/<span class="max">4</span></span>
        </div>
        <div class="field-limit-item" id="limit-header">
            <span class="limit-label">Header</span>
            <span class="limit-count"><span class="current">0</span>/<span class="max">3</span></span>
        </div>
        <div class="field-limit-item" id="limit-back">
            <span class="limit-label">Back</span>
            <span class="limit-count"><span class="current">0</span>/<span class="max">∞</span></span>
        </div>
    </div>
    <small class="text-muted d-block mt-2">
        <i class="ti ti-info-circle me-1"></i>Apple Wallet StoreCard: Secondary and Auxiliary fields share a combined limit of 4.
    </small>
</div>

<!-- Pass Layout Guide (Collapsible - expanded by default) -->
<div class="c-card mb-4">
    <div class="c-card__header py-2 cursor-pointer" data-bs-toggle="collapse" data-bs-target="#layout-guide-collapse" aria-expanded="true" data-collapse-toggle>
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="ti ti-layout me-2"></i>Pass Layout Guide</h6>
            <i class="ti ti-chevron-down collapse-icon"></i>
        </div>
    </div>
    <div class="collapse show" id="layout-guide-collapse">
        <div class="c-card__body">
            <p class="text-muted small mb-3">
                <i class="ti ti-info-circle me-1"></i>
                These diagrams show where each field type appears on the pass. Select your pass style in the Appearance tab.
            </p>

            <div class="row">
                {# Generic Pass Layout #}
                <div class="col-md-4 mb-3">
                    <div class="pass-layout-diagram" id="layout-generic">
                        <h6 class="text-center mb-2">Generic Pass</h6>
                        <div class="layout-card">
                            <div class="layout-header">
                                <div class="layout-logo">Logo</div>
                                <div class="layout-logo-text">Logo Text</div>
                                <div class="layout-header-fields">Header</div>
                                <div class="layout-thumbnail">Thumb</div>
                            </div>
                            <div class="layout-primary">Primary Field</div>
                            <div class="layout-secondary">Secondary Fields</div>
                            <div class="layout-auxiliary">Auxiliary Fields</div>
                            <div class="layout-barcode">Barcode</div>
                        </div>
                        <small class="text-muted d-block mt-2 text-center">Clean layout with thumbnail. Best for membership cards.</small>
                    </div>
                </div>

                {# Store Card Layout #}
                <div class="col-md-4 mb-3">
                    <div class="pass-layout-diagram" id="layout-storeCard">
                        <h6 class="text-center mb-2">Store Card</h6>
                        <div class="layout-card">
                            <div class="layout-header">
                                <div class="layout-logo">Logo</div>
                                <div class="layout-logo-text">Logo Text</div>
                                <div class="layout-header-fields">Header</div>
                            </div>
                            <div class="layout-strip">
                                <span class="layout-strip-label">Strip Image</span>
                                <div class="layout-primary-overlay">Primary (overlaid)</div>
                            </div>
                            <div class="layout-secondary">Secondary Fields</div>
                            <div class="layout-auxiliary">Auxiliary Fields</div>
                            <div class="layout-barcode">Barcode</div>
                        </div>
                        <small class="text-muted d-block mt-2 text-center">Primary field overlays on strip image.</small>
                    </div>
                </div>

                {# Event Ticket Layout #}
                <div class="col-md-4 mb-3">
                    <div class="pass-layout-diagram" id="layout-eventTicket">
                        <h6 class="text-center mb-2">Event Ticket</h6>
                        <div class="layout-card">
                            <div class="layout-notch"></div>
                            <div class="layout-header">
                                <div class="layout-logo">Logo</div>
                                <div class="layout-logo-text">Logo Text</div>
                                <div class="layout-header-fields">Header</div>
                            </div>
                            <div class="layout-strip layout-strip-clean">
                                <span class="layout-strip-label">Strip Image (clean)</span>
                            </div>
                            <div class="layout-secondary">Secondary Fields</div>
                            <div class="layout-auxiliary">Auxiliary Fields</div>
                            <div class="layout-barcode">Barcode</div>
                        </div>
                        <small class="text-muted d-block mt-2 text-center">Strip stays clean - fields below. Has notch.</small>
                    </div>
                </div>
            </div>

            {# Field Descriptions #}
            <div class="mt-3 pt-3 border-top">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="mb-2">Front Fields</h6>
                        <ul class="small mb-0">
                            <li><strong>Header</strong> (max 3): Top-right of pass, next to logo</li>
                            <li><strong>Primary</strong> (max 1): Main focus - member name, etc.</li>
                            <li><strong>Secondary</strong> (max 4*): Important supporting info</li>
                            <li><strong>Auxiliary</strong> (max 4*): Additional details</li>
                        </ul>
                        <small class="text-muted">*Secondary + Auxiliary share a combined limit of 4</small>
                    </div>
                    <div class="col-md-6">
                        <h6 class="mb-2">Back Fields</h6>
                        <ul class="small mb-0">
                            <li><strong>Back</strong> (unlimited): Terms, links, contact info</li>
                            <li>Supports longer text content</li>
                            <li>URLs and phone numbers become tappable links</li>
                            <li>Use <code>\n</code> for line breaks</li>
                        </ul>
                    </div>
                </div>
            </div>

            {# Apple Documentation Link #}
            <div class="mt-3 pt-3 border-top text-center">
                <a href="https://developer.apple.com/library/archive/documentation/UserExperience/Conceptual/PassKit_PG/Creating.html"
                   target="_blank" class="c-btn c-btn--outline-secondary c-btn--sm">
                    <i class="ti ti-external-link me-1"></i>Apple PassKit Documentation
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Available Variables (Collapsible) -->
<div class="c-card mb-4">
    <div class="c-card__header py-2 cursor-pointer" data-bs-toggle="collapse" data-bs-target="#variables-collapse" aria-expanded="false" data-collapse-toggle>
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="ti ti-variable me-2"></i>Available Variables</h6>
            <i class="ti ti-chevron-down collapse-icon"></i>
        </div>
    </div>
    <div class="collapse" id="variables-collapse">
        <div class="c-card__body py-3">
            <p class="text-muted small mb-3">These variables are automatically replaced with actual data when passes are generated:</p>
            <div class="c-table-wrapper" data-table-responsive>
                <table class="c-table c-table--compact c-table--borderless mb-0" data-mobile-table data-table-type="config" data-table>
                    <tbody>
                        {% for variable in template_variables %}
                        <tr>
                            <td class="u-w-160"><code class="bg-light px-2 py-1 rounded">{{ variable.name }}</code></td>
                            <td class="text-muted">{{ variable.description }}</td>
                            <td class="u-w-120" class="text-muted small">
                                {% if sample_data and sample_data.get(variable.name) %}
                                    <em>"{{ sample_data.get(variable.name) }}"</em>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Front of Pass Fields -->
    <div class="col-lg-6 mb-4">
        <div class="c-card h-100">
            <div class="c-card__header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="ti ti-credit-card me-2"></i>Front of Pass</h6>
                <button type="button" class="c-btn c-btn--sm c-btn--primary js-add-front-field" data-action="add-pass-field" data-field-type="front">
                    <i class="ti ti-plus me-1"></i>Add Field
                </button>
            </div>
            <div class="c-card__body">
                <!-- Primary Fields Section -->
                <div class="field-location-section mb-3">
                    <div class="field-location-header d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-primary" data-badge>Primary</span>
                        <small class="text-muted">Main focus - member name</small>
                    </div>
                    <div class="fields-sortable-container" id="primary-fields-container" data-location="primary">
                        <!-- Primary fields rendered here -->
                    </div>
                </div>

                <!-- Secondary Fields Section -->
                <div class="field-location-section mb-3">
                    <div class="field-location-header d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-info" data-badge>Secondary</span>
                        <small class="text-muted">Important details</small>
                    </div>
                    <div class="fields-sortable-container" id="secondary-fields-container" data-location="secondary">
                        <!-- Secondary fields rendered here -->
                    </div>
                </div>

                <!-- Auxiliary Fields Section -->
                <div class="field-location-section mb-3">
                    <div class="field-location-header d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-warning" data-badge>Auxiliary</span>
                        <small class="text-muted">Supporting info</small>
                    </div>
                    <div class="fields-sortable-container" id="auxiliary-fields-container" data-location="auxiliary">
                        <!-- Auxiliary fields rendered here -->
                    </div>
                </div>

                <!-- Header Fields Section -->
                <div class="field-location-section">
                    <div class="field-location-header d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-secondary" data-badge>Header</span>
                        <small class="text-muted">Top of pass (rarely used)</small>
                    </div>
                    <div class="fields-sortable-container" id="header-fields-container" data-location="header">
                        <!-- Header fields rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back of Pass Fields -->
    <div class="col-lg-6 mb-4">
        <div class="c-card h-100">
            <div class="c-card__header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="ti ti-flip-horizontal me-2"></i>Back of Pass</h6>
                <button type="button" class="c-btn c-btn--sm c-btn--primary js-add-back-field" data-action="add-pass-field" data-field-type="back">
                    <i class="ti ti-plus me-1"></i>Add Field
                </button>
            </div>
            <div class="c-card__body">
                <p class="text-muted small mb-3">
                    <i class="ti ti-info-circle me-1"></i>
                    Back fields show when users tap the info button. Great for terms, contact info, and links.
                </p>
                <div class="fields-sortable-container" id="back-fields-container" data-location="back">
                    <!-- Back fields rendered here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Button -->
<div class="d-flex justify-content-end gap-2">
    <button type="button" class="c-btn c-btn--outline-secondary js-reset-fields" data-action="reset-fields">
        <i class="ti ti-refresh me-1"></i>Reset Changes
    </button>
    <button type="button" class="c-btn c-btn--primary js-save-fields" data-action="save-fields">
        <i class="ti ti-device-floppy me-1"></i>Save Fields
    </button>
</div>

<!-- Field Card Template (hidden, used by JavaScript) -->
<template id="field-card-template">
    <div class="field-card" data-field-key="">
        <div class="field-card-header">
            <div class="d-flex align-items-center gap-2">
                <span class="drag-handle" title="Drag to reorder">
                    <i class="ti ti-grip-vertical"></i>
                </span>
                <span class="field-location-badge badge" data-badge></span>
                <span class="field-key text-muted small"></span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input visibility-toggle" type="checkbox" checked>
                </div>
                <button type="button" class="c-btn c-btn--sm c-btn--icon-only c-btn--outline-danger delete-btn" title="Delete field">
                    <i class="ti ti-trash"></i>
                </button>
            </div>
        </div>
        <div class="field-card-body">
            <div class="row g-2 mb-2">
                <div class="col-4">
                    <input type="text" class="form-control form-control-sm label-input" placeholder="Label" data-form-control aria-label="Label">
                </div>
                <div class="col-4 location-select-col">
                    <select class="form-select form-select-sm location-select" data-form-select>
                        <option value="primary">Primary</option>
                        <option value="secondary">Secondary</option>
                        <option value="auxiliary">Auxiliary</option>
                        <option value="header">Header</option>
                    </select>
                </div>
                <div class="col-4 data-type-col">
                    <select class="form-select form-select-sm data-type-select" title="Data type determines formatting options" data-form-select>
                        <option value="text">Text</option>
                        <option value="date">Date/Time</option>
                        <option value="number">Number</option>
                        <option value="currency">Currency</option>
                    </select>
                </div>
                <div class="col-8 field-type-col d-none">
                    <select class="form-select form-select-sm field-type-select" data-form-select>
                        <option value="text">Text</option>
                        <option value="url">URL</option>
                        <option value="phone">Phone</option>
                        <option value="email">Email</option>
                    </select>
                </div>
            </div>
            <!-- Value section with tabs -->
            <div class="value-section">
                <ul class="nav nav-tabs nav-tabs-sm" role="tablist" data-tabs>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active simple-mode-tab" type="button" data-mode="simple">
                            Simple
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link advanced-mode-tab" type="button" data-mode="advanced">
                            Advanced
                        </button>
                    </li>
                </ul>
                <div class="tab-content p-2 border border-top-0 rounded-bottom bg-light">
                    <div class="simple-mode-content">
                        <select class="form-select form-select-sm variable-select" data-form-select>
                            <option value="">-- Select variable --</option>
                        </select>
                    </div>
                    <div class="advanced-mode-content d-none">
                        <div class="input-group input-group-sm" data-input-group>
                            <input type="text" class="form-control template-input" placeholder="Template" data-form-control aria-label="Template">
                            <button type="button" class="c-btn c-btn--outline-secondary dropdown-toggle insert-var-btn" data-bs-toggle="dropdown" data-dropdown-toggle>
                                Insert
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end insert-var-menu" data-dropdown-menu>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Text Alignment (Front fields only) -->
            <div class="alignment-section mt-2 front-only">
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">Align:</small>
                    <div class="btn-group btn-group-sm alignment-btns" role="group" aria-label="Text alignment">
                        <input type="radio" class="btn-check" name="align" id="align-natural" value="natural" autocomplete="off" checked>
                        <label class="c-btn c-btn--outline-secondary" for="align-natural" title="Natural (default)">
                            <i class="ti ti-layout-align-left"></i>
                        </label>
                        <input type="radio" class="btn-check" name="align" id="align-left" value="left" autocomplete="off">
                        <label class="c-btn c-btn--outline-secondary" for="align-left" title="Left">
                            <i class="ti ti-align-left"></i>
                        </label>
                        <input type="radio" class="btn-check" name="align" id="align-center" value="center" autocomplete="off">
                        <label class="c-btn c-btn--outline-secondary" for="align-center" title="Center">
                            <i class="ti ti-align-center"></i>
                        </label>
                        <input type="radio" class="btn-check" name="align" id="align-right" value="right" autocomplete="off">
                        <label class="c-btn c-btn--outline-secondary" for="align-right" title="Right">
                            <i class="ti ti-align-right"></i>
                        </label>
                    </div>
                </div>
            </div>
            <!-- Format Options (conditional based on field_type) -->
            <div class="format-section mt-2 front-only d-none">
                <div class="row g-2">
                    <!-- Date Style (for date fields) -->
                    <div class="col-6 date-style-group d-none">
                        <label class="form-label small text-muted mb-1">Date Format</label>
                        <select class="form-select form-select-sm date-style-select" data-form-select>
                            <option value="">None</option>
                            <option value="short">Short (1/1/25)</option>
                            <option value="medium">Medium (Jan 1, 2025)</option>
                            <option value="long">Long (January 1, 2025)</option>
                            <option value="full">Full (Wednesday, January 1, 2025)</option>
                        </select>
                    </div>
                    <!-- Time Style (for date fields) -->
                    <div class="col-6 time-style-group d-none">
                        <label class="form-label small text-muted mb-1">Time Format</label>
                        <select class="form-select form-select-sm time-style-select" data-form-select>
                            <option value="">None</option>
                            <option value="short">Short (3:30 PM)</option>
                            <option value="medium">Medium (3:30:00 PM)</option>
                            <option value="long">Long (3:30:00 PM EST)</option>
                            <option value="full">Full (3:30:00 PM Eastern Standard Time)</option>
                        </select>
                    </div>
                    <!-- Number Style (for number fields) -->
                    <div class="col-6 number-style-group d-none">
                        <label class="form-label small text-muted mb-1">Number Format</label>
                        <select class="form-select form-select-sm number-style-select" data-form-select>
                            <option value="">Default</option>
                            <option value="decimal">Decimal (1,234.56)</option>
                            <option value="percent">Percent (12%)</option>
                            <option value="scientific">Scientific (1.23E4)</option>
                            <option value="spellOut">Spell Out (one thousand)</option>
                        </select>
                    </div>
                    <!-- Currency Code (for currency fields - mutually exclusive with numberStyle) -->
                    <div class="col-6 currency-code-group d-none">
                        <label class="form-label small text-muted mb-1">Currency</label>
                        <select class="form-select form-select-sm currency-code-select" data-form-select>
                            <option value="">None</option>
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="GBP">GBP (£)</option>
                            <option value="CAD">CAD (C$)</option>
                            <option value="AUD">AUD (A$)</option>
                            <option value="JPY">JPY (¥)</option>
                            <option value="MXN">MXN (MX$)</option>
                            <option value="BRL">BRL (R$)</option>
                        </select>
                    </div>
                </div>
            </div>
            <!-- Preview -->
            <div class="field-preview mt-2">
                <small class="text-muted">Preview:</small>
                <span class="preview-value fw-medium"></span>
            </div>
        </div>
    </div>
</template>

<script src="{{ url_for('static', filename='vendor/libs/sortablejs/sortable.js') }}"></script>
<script>
/**
 * Fields Manager - Handles all field operations in Pass Studio
 */
const FieldsManager = {
    // State
    frontFields: [],
    backFields: [],
    templateVariables: [],
    sampleData: {},
    sortableInstances: [],
    addFieldModal: null,

    // Field limits per location - StoreCard specific
    // Note: Secondary + Auxiliary share a COMBINED limit of 4 for StoreCard
    limits: {
        primary: 1,
        secondaryAuxiliary: 4,  // Combined limit for StoreCard
        header: 3,
        back: Infinity  // No hard limit on back fields
    },

    /**
     * Initialize the fields manager
     */
    init(frontFields, backFields, templateVariables, sampleData) {
        this.frontFields = frontFields || [];
        this.backFields = backFields || [];
        this.templateVariables = templateVariables || [];
        this.sampleData = sampleData || {};

        // Initialize modal
        const modalEl = document.getElementById('addFieldModal');
        if (modalEl) {
            this.addFieldModal = ModalManager.getInstance('addFieldModal');
        }

        // Render all fields
        this.renderAllFields();

        // Initialize sortable containers
        this.initSortable();

        // Update limit counters
        this.updateLimitCounters();

        // Update preview with initial field data
        this.notifyPreviewUpdate();

        // Setup variable select change handler for static text option
        document.getElementById('add-field-variable')?.addEventListener('change', (e) => {
            const staticInput = document.getElementById('add-field-static');
            if (e.target.value === '__static__') {
                staticInput.classList.remove('d-none');
            } else {
                staticInput.classList.add('d-none');
            }
        });

        console.log('FieldsManager initialized', { front: this.frontFields.length, back: this.backFields.length });
    },

    /**
     * Render all fields to their containers
     */
    renderAllFields() {
        // Clear all containers
        ['primary', 'secondary', 'auxiliary', 'header'].forEach(loc => {
            const container = document.getElementById(`${loc}-fields-container`);
            if (container) container.innerHTML = '';
        });
        const backContainer = document.getElementById('back-fields-container');
        if (backContainer) backContainer.innerHTML = '';

        // Render front fields by location
        this.frontFields.forEach(field => {
            const container = document.getElementById(`${field.field_location}-fields-container`);
            if (container) {
                container.appendChild(this.createFieldCard(field, false));
            }
        });

        // Render back fields
        this.backFields.forEach(field => {
            if (backContainer) {
                backContainer.appendChild(this.createFieldCard(field, true));
            }
        });

        // Add empty state messages
        this.updateEmptyStates();
    },

    /**
     * Create a field card element
     */
    createFieldCard(field, isBackField) {
        const template = document.getElementById('field-card-template');
        const clone = template.content.cloneNode(true);
        const card = clone.querySelector('.field-card');

        const fieldKey = isBackField ? field.field_key : field.field_key;
        card.dataset.fieldKey = fieldKey;
        card.dataset.isBack = isBackField ? 'true' : 'false';

        // Set visibility state
        if (!field.is_visible) {
            card.classList.add('inactive');
        }

        // Set field key display
        card.querySelector('.field-key').textContent = fieldKey;

        // Set location badge
        const badge = card.querySelector('.field-location-badge');
        const location = isBackField ? 'back' : field.field_location;
        badge.textContent = location;
        badge.classList.add(this.getLocationBadgeClass(location));

        // Set label
        card.querySelector('.label-input').value = field.label || '';

        // Show/hide location dropdown vs field type based on front/back
        if (isBackField) {
            card.querySelector('.location-select-col').classList.add('d-none');
            card.querySelector('.data-type-col').classList.add('d-none');
            card.querySelector('.field-type-col').classList.remove('d-none');
            card.querySelector('.field-type-select').value = field.field_type || 'text';
        } else {
            card.querySelector('.location-select').value = field.field_location;
            // Set data type for front fields (determines formatting options)
            const dataType = field.field_type || 'text';
            card.querySelector('.data-type-select').value = dataType;
            // Show appropriate format options based on data type
            this.updateFormatOptions(card, dataType, field);
        }

        // Populate variable select
        const variableSelect = card.querySelector('.variable-select');
        this.populateVariableSelect(variableSelect);

        // Populate insert variable menu
        const insertMenu = card.querySelector('.insert-var-menu');
        this.populateInsertMenu(insertMenu, fieldKey);

        // Set current value
        const value = isBackField ? field.value : (field.value_template || '');
        const templateInput = card.querySelector('.template-input');
        templateInput.value = value;

        // Determine if simple or advanced mode
        const isSimpleVariable = this.isSimpleVariable(value);
        if (isSimpleVariable) {
            variableSelect.value = value;
        } else if (value && !isSimpleVariable) {
            // Switch to advanced mode
            card.querySelector('.simple-mode-tab').classList.remove('active');
            card.querySelector('.advanced-mode-tab').classList.add('active');
            card.querySelector('.simple-mode-content').classList.add('d-none');
            card.querySelector('.advanced-mode-content').classList.remove('d-none');
        }

        // Set preview
        this.updateCardPreview(card, value);

        // Set visibility toggle
        const visToggle = card.querySelector('.visibility-toggle');
        visToggle.checked = field.is_visible !== false;

        // Handle alignment section (front fields only)
        const alignmentSection = card.querySelector('.alignment-section');
        if (isBackField) {
            // Hide alignment for back fields
            alignmentSection.classList.add('d-none');
        } else {
            // Set unique IDs for alignment radio buttons (required since template is cloned)
            const alignBtns = card.querySelectorAll('.alignment-btns input[type="radio"]');
            const alignLabels = card.querySelectorAll('.alignment-btns label');
            alignBtns.forEach((input, idx) => {
                const newId = `align-${fieldKey}-${input.value}`;
                input.id = newId;
                input.name = `align-${fieldKey}`;
                alignLabels[idx].setAttribute('for', newId);
            });

            // Set current alignment value
            const currentAlign = field.text_alignment || 'natural';
            const alignInput = card.querySelector(`input[name="align-${fieldKey}"][value="${currentAlign}"]`);
            if (alignInput) {
                alignInput.checked = true;
            }
        }

        // Event listeners
        this.attachCardEventListeners(card, fieldKey, isBackField);

        return card;
    },

    /**
     * Attach event listeners to a field card
     */
    attachCardEventListeners(card, fieldKey, isBackField) {
        // Label change
        card.querySelector('.label-input').addEventListener('change', (e) => {
            this.updateField(fieldKey, 'label', e.target.value, isBackField);
        });

        // Location change (front only)
        const locSelect = card.querySelector('.location-select');
        if (locSelect) {
            locSelect.addEventListener('change', (e) => {
                this.changeLocation(fieldKey, e.target.value);
            });
        }

        // Field type change (back only)
        const typeSelect = card.querySelector('.field-type-select');
        if (typeSelect) {
            typeSelect.addEventListener('change', (e) => {
                this.updateField(fieldKey, 'field_type', e.target.value, true);
            });
        }

        // Visibility toggle
        card.querySelector('.visibility-toggle').addEventListener('change', (e) => {
            this.toggleVisibility(fieldKey, e.target.checked, isBackField);
            card.classList.toggle('inactive', !e.target.checked);
        });

        // Delete button
        card.querySelector('.delete-btn').addEventListener('click', () => {
            this.deleteField(fieldKey, isBackField);
        });

        // Mode tabs
        card.querySelector('.simple-mode-tab').addEventListener('click', () => {
            card.querySelector('.simple-mode-tab').classList.add('active');
            card.querySelector('.advanced-mode-tab').classList.remove('active');
            card.querySelector('.simple-mode-content').classList.remove('d-none');
            card.querySelector('.advanced-mode-content').classList.add('d-none');
        });

        card.querySelector('.advanced-mode-tab').addEventListener('click', () => {
            card.querySelector('.advanced-mode-tab').classList.add('active');
            card.querySelector('.simple-mode-tab').classList.remove('active');
            card.querySelector('.advanced-mode-content').classList.remove('d-none');
            card.querySelector('.simple-mode-content').classList.add('d-none');
        });

        // Variable select change
        card.querySelector('.variable-select').addEventListener('change', (e) => {
            const newValue = e.target.value;
            this.updateFieldValue(fieldKey, newValue, isBackField);
            this.updateCardPreview(card, newValue);
            card.querySelector('.template-input').value = newValue;
        });

        // Template input change
        card.querySelector('.template-input').addEventListener('change', (e) => {
            const newValue = e.target.value;
            this.updateFieldValue(fieldKey, newValue, isBackField);
            this.updateCardPreview(card, newValue);
        });

        // Text alignment change (front fields only)
        if (!isBackField) {
            const alignInputs = card.querySelectorAll(`input[name="align-${fieldKey}"]`);
            alignInputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    this.updateField(fieldKey, 'text_alignment', e.target.value, false);
                });
            });

            // Data type change (front fields only)
            const dataTypeSelect = card.querySelector('.data-type-select');
            if (dataTypeSelect) {
                dataTypeSelect.addEventListener('change', (e) => {
                    const dataType = e.target.value;
                    this.updateField(fieldKey, 'field_type', dataType, false);
                    this.updateFormatOptions(card, dataType, this.frontFields.find(f => f.field_key === fieldKey));
                });
            }

            // Format option changes
            const dateStyleSelect = card.querySelector('.date-style-select');
            if (dateStyleSelect) {
                dateStyleSelect.addEventListener('change', (e) => {
                    this.updateField(fieldKey, 'date_style', e.target.value || null, false);
                });
            }

            const timeStyleSelect = card.querySelector('.time-style-select');
            if (timeStyleSelect) {
                timeStyleSelect.addEventListener('change', (e) => {
                    this.updateField(fieldKey, 'time_style', e.target.value || null, false);
                });
            }

            const numberStyleSelect = card.querySelector('.number-style-select');
            if (numberStyleSelect) {
                numberStyleSelect.addEventListener('change', (e) => {
                    this.updateField(fieldKey, 'number_style', e.target.value || null, false);
                });
            }

            const currencyCodeSelect = card.querySelector('.currency-code-select');
            if (currencyCodeSelect) {
                currencyCodeSelect.addEventListener('change', (e) => {
                    this.updateField(fieldKey, 'currency_code', e.target.value || null, false);
                });
            }
        }
    },

    /**
     * Populate variable select dropdown
     */
    populateVariableSelect(select) {
        select.innerHTML = '<option value="">-- Select variable --</option>';
        this.templateVariables.forEach(v => {
            const option = document.createElement('option');
            option.value = '{% raw %}{{{% endraw %}' + v.name + '{% raw %}}}{% endraw %}';
            option.textContent = v.name + ' - ' + v.description;
            select.appendChild(option);
        });
    },

    /**
     * Populate insert variable menu
     */
    populateInsertMenu(menu, fieldKey) {
        menu.innerHTML = '';
        this.templateVariables.forEach(v => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.className = 'dropdown-item';
            a.href = '#';
            a.textContent = v.name;
            a.addEventListener('click', (e) => {
                e.preventDefault();
                this.insertVariableInCard(fieldKey, v.name);
            });
            li.appendChild(a);
            menu.appendChild(li);
        });
    },

    /**
     * Check if a value is a simple variable reference
     */
    isSimpleVariable(value) {
        if (!value) return false;
        const match = value.match(/^\{\{(\w+)\}\}$/);
        return match !== null;
    },

    /**
     * Update preview in a card
     */
    updateCardPreview(card, value) {
        const previewEl = card.querySelector('.preview-value');
        const resolved = this.resolvePreview(value);
        previewEl.textContent = resolved || '(empty)';
        previewEl.classList.toggle('text-muted', !resolved);
    },

    /**
     * Resolve preview value
     */
    resolvePreview(template) {
        if (!template) return '';
        let result = template;
        for (const [key, val] of Object.entries(this.sampleData)) {
            result = result.replace(new RegExp('\\{\\{' + key + '\\}\\}', 'g'), val || '');
        }
        return result;
    },

    /**
     * Get badge class for location
     */
    getLocationBadgeClass(location) {
        const classes = {
            primary: 'bg-primary',
            secondary: 'bg-info',
            auxiliary: 'bg-warning',
            header: 'bg-secondary',
            back: 'bg-dark'
        };
        return classes[location] || 'bg-secondary';
    },

    /**
     * Update format options visibility based on data type
     */
    updateFormatOptions(card, dataType, field) {
        const formatSection = card.querySelector('.format-section');
        const dateStyleGroup = card.querySelector('.date-style-group');
        const timeStyleGroup = card.querySelector('.time-style-group');
        const numberStyleGroup = card.querySelector('.number-style-group');
        const currencyCodeGroup = card.querySelector('.currency-code-group');

        // Hide all format groups first
        dateStyleGroup.classList.add('d-none');
        timeStyleGroup.classList.add('d-none');
        numberStyleGroup.classList.add('d-none');
        currencyCodeGroup.classList.add('d-none');

        // Show format section only if not text type
        if (dataType === 'text') {
            formatSection.classList.add('d-none');
        } else {
            formatSection.classList.remove('d-none');

            if (dataType === 'date') {
                dateStyleGroup.classList.remove('d-none');
                timeStyleGroup.classList.remove('d-none');
                // Set current values
                if (field) {
                    card.querySelector('.date-style-select').value = field.date_style || '';
                    card.querySelector('.time-style-select').value = field.time_style || '';
                }
            } else if (dataType === 'number') {
                numberStyleGroup.classList.remove('d-none');
                if (field) {
                    card.querySelector('.number-style-select').value = field.number_style || '';
                }
            } else if (dataType === 'currency') {
                currencyCodeGroup.classList.remove('d-none');
                if (field) {
                    card.querySelector('.currency-code-select').value = field.currency_code || '';
                }
            }
        }
    },

    /**
     * Initialize sortable containers
     */
    initSortable() {
        // Destroy existing instances
        this.sortableInstances.forEach(s => s.destroy());
        this.sortableInstances = [];

        // Initialize for each container
        ['primary', 'secondary', 'auxiliary', 'header', 'back'].forEach(loc => {
            const containerId = loc === 'back' ? 'back-fields-container' : `${loc}-fields-container`;
            const container = document.getElementById(containerId);
            if (container) {
                const sortable = new Sortable(container, {
                    group: loc === 'back' ? 'back-fields' : 'front-fields',
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: (evt) => this.handleReorder(evt)
                });
                this.sortableInstances.push(sortable);
            }
        });
    },

    /**
     * Handle field reorder after drag
     */
    handleReorder(evt) {
        const fieldKey = evt.item.dataset.fieldKey;
        const isBack = evt.item.dataset.isBack === 'true';
        const newLocation = evt.to.dataset.location;

        if (isBack) {
            // Reorder back fields
            const newOrder = Array.from(evt.to.children).map(el => el.dataset.fieldKey);
            this.backFields.sort((a, b) => newOrder.indexOf(a.field_key) - newOrder.indexOf(b.field_key));
            this.backFields.forEach((f, i) => f.display_order = i);
        } else {
            // Update location if moved between containers
            const field = this.frontFields.find(f => f.field_key === fieldKey);
            if (field && field.field_location !== newLocation) {
                field.field_location = newLocation;
                // Update badge
                const badge = evt.item.querySelector('.field-location-badge');
                badge.textContent = newLocation;
                badge.className = `field-location-badge badge ${this.getLocationBadgeClass(newLocation)}`;
                // Update location dropdown
                const locSelect = evt.item.querySelector('.location-select');
                if (locSelect) locSelect.value = newLocation;
            }

            // Reorder within container
            ['primary', 'secondary', 'auxiliary', 'header'].forEach(loc => {
                const container = document.getElementById(`${loc}-fields-container`);
                if (container) {
                    const keysInOrder = Array.from(container.children).map(el => el.dataset.fieldKey);
                    this.frontFields
                        .filter(f => f.field_location === loc)
                        .forEach(f => {
                            f.display_order = keysInOrder.indexOf(f.field_key);
                        });
                }
            });
        }

        this.updateLimitCounters();
        PassStudio.markUnsaved();
        if (!isBack) this.notifyPreviewUpdate();
    },

    /**
     * Update empty state messages
     */
    updateEmptyStates() {
        ['primary', 'secondary', 'auxiliary', 'header'].forEach(loc => {
            const container = document.getElementById(`${loc}-fields-container`);
            if (container && container.children.length === 0) {
                container.innerHTML = `<div class="empty-state text-center py-3 text-muted small">
                    <i class="ti ti-drag-drop me-1"></i>Drag fields here or click Add Field
                </div>`;
            }
        });

        const backContainer = document.getElementById('back-fields-container');
        if (backContainer && backContainer.children.length === 0) {
            backContainer.innerHTML = `<div class="empty-state text-center py-3 text-muted small">
                <i class="ti ti-plus me-1"></i>Add fields for the back of the pass
            </div>`;
        }
    },

    /**
     * Update limit counters - StoreCard uses combined secondary+auxiliary limit
     */
    updateLimitCounters() {
        const primaryCount = this.frontFields.filter(f => f.field_location === 'primary' && f.is_visible !== false).length;
        const secondaryCount = this.frontFields.filter(f => f.field_location === 'secondary' && f.is_visible !== false).length;
        const auxiliaryCount = this.frontFields.filter(f => f.field_location === 'auxiliary' && f.is_visible !== false).length;
        const headerCount = this.frontFields.filter(f => f.field_location === 'header' && f.is_visible !== false).length;
        const backCount = this.backFields.filter(f => f.is_visible !== false).length;

        // Primary field counter
        const primaryEl = document.getElementById('limit-primary');
        if (primaryEl) {
            primaryEl.querySelector('.current').textContent = primaryCount;
            primaryEl.classList.toggle('at-limit', primaryCount >= this.limits.primary);
            primaryEl.classList.toggle('over-limit', primaryCount > this.limits.primary);
        }

        // Combined secondary + auxiliary counter (StoreCard specific)
        const secAuxEl = document.getElementById('limit-secondary-auxiliary');
        if (secAuxEl) {
            const combinedCount = secondaryCount + auxiliaryCount;
            secAuxEl.querySelector('.current').textContent = combinedCount;
            secAuxEl.classList.toggle('at-limit', combinedCount >= this.limits.secondaryAuxiliary);
            secAuxEl.classList.toggle('over-limit', combinedCount > this.limits.secondaryAuxiliary);
        }

        // Header counter
        const headerEl = document.getElementById('limit-header');
        if (headerEl) {
            headerEl.querySelector('.current').textContent = headerCount;
            headerEl.classList.toggle('at-limit', headerCount >= this.limits.header);
            headerEl.classList.toggle('over-limit', headerCount > this.limits.header);
        }

        // Back fields counter (no hard limit)
        const backEl = document.getElementById('limit-back');
        if (backEl) {
            backEl.querySelector('.current').textContent = backCount;
            // Back fields have no limit for StoreCard
        }
    },

    /**
     * Open the add field modal
     */
    openAddFieldModal(type) {
        document.getElementById('add-field-type').value = type;
        document.getElementById('add-field-label').value = '';
        document.getElementById('add-field-variable').value = '';
        document.getElementById('add-field-template').value = '';
        document.getElementById('add-field-static').value = '';
        document.getElementById('add-field-static').classList.add('d-none');

        // Show/hide location vs field type
        const locGroup = document.getElementById('add-field-location-group');
        const typeGroup = document.getElementById('add-field-type-group');

        if (type === 'back') {
            locGroup.classList.add('d-none');
            typeGroup.classList.remove('d-none');
        } else {
            locGroup.classList.remove('d-none');
            typeGroup.classList.add('d-none');
        }

        // Reset to simple mode
        document.getElementById('add-simple-tab').click();

        this.addFieldModal.show();
    },

    /**
     * Insert variable at cursor in add modal
     */
    insertVariableInAdd(varName) {
        const input = document.getElementById('add-field-template');
        const cursorPos = input.selectionStart;
        const textBefore = input.value.substring(0, cursorPos);
        const textAfter = input.value.substring(input.selectionEnd);
        input.value = textBefore + '{% raw %}{{{% endraw %}' + varName + '{% raw %}}}{% endraw %}' + textAfter;
        input.focus();
        const newPos = cursorPos + varName.length + 4;
        input.setSelectionRange(newPos, newPos);
    },

    /**
     * Insert variable at cursor in card
     */
    insertVariableInCard(fieldKey, varName) {
        const card = document.querySelector('[data-field-key="' + fieldKey + '"]');
        if (!card) return;

        const input = card.querySelector('.template-input');
        const cursorPos = input.selectionStart;
        const textBefore = input.value.substring(0, cursorPos);
        const textAfter = input.value.substring(input.selectionEnd);
        input.value = textBefore + '{% raw %}{{{% endraw %}' + varName + '{% raw %}}}{% endraw %}' + textAfter;

        // Trigger change
        input.dispatchEvent(new Event('change'));
        input.focus();
    },

    /**
     * Create a new field
     */
    createField() {
        const type = document.getElementById('add-field-type').value;
        const label = document.getElementById('add-field-label').value.trim();

        if (!label) {
            PassStudio.showToast('Please enter a field label', 'error');
            return;
        }

        // Generate field key from label
        const fieldKey = label.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

        // Check for duplicate key
        const existingField = type === 'back'
            ? this.backFields.find(f => f.field_key === fieldKey)
            : this.frontFields.find(f => f.field_key === fieldKey);

        if (existingField) {
            PassStudio.showToast('A field with this key already exists', 'error');
            return;
        }

        // Get value from either simple or advanced mode
        let value = '';
        const simpleTab = document.getElementById('add-simple-tab');
        if (simpleTab.classList.contains('active')) {
            const varSelect = document.getElementById('add-field-variable').value;
            if (varSelect === '__static__') {
                value = document.getElementById('add-field-static').value;
            } else {
                value = varSelect;
            }
        } else {
            value = document.getElementById('add-field-template').value;
        }

        if (type === 'back') {
            const fieldType = document.getElementById('add-field-field-type').value;
            this.backFields.push({
                field_key: fieldKey,
                label: label.toUpperCase(),
                value: value,
                field_type: fieldType,
                is_visible: true,
                display_order: this.backFields.length
            });
        } else {
            const location = document.querySelector('input[name="add-field-location"]:checked').value;

            // Check limit
            const currentCount = this.frontFields.filter(f => f.field_location === location && f.is_visible !== false).length;
            if (currentCount >= this.limits[location]) {
                PassStudio.showToast(`Maximum ${this.limits[location]} ${location} field(s) allowed`, 'warning');
                return;
            }

            this.frontFields.push({
                field_key: fieldKey,
                label: label.toUpperCase(),
                field_location: location,
                value_template: value,
                is_visible: true,
                display_order: this.frontFields.filter(f => f.field_location === location).length
            });
        }

        this.addFieldModal.hide();
        this.renderAllFields();
        this.initSortable();
        this.updateLimitCounters();
        PassStudio.markUnsaved();
        if (!isBack) this.notifyPreviewUpdate();
        PassStudio.showToast('Field added', 'success');
    },

    /**
     * Notify the preview to update with current field data
     */
    notifyPreviewUpdate() {
        if (typeof PassStudio !== 'undefined' && PassStudio.updatePreviewFields) {
            PassStudio.updatePreviewFields(this.frontFields, this.sampleData);
        }
    },

    /**
     * Update a field property
     */
    updateField(fieldKey, prop, value, isBack) {
        const fields = isBack ? this.backFields : this.frontFields;
        const field = fields.find(f => f.field_key === fieldKey);
        if (field) {
            field[prop] = value;
            PassStudio.markUnsaved();
            if (!isBack) this.notifyPreviewUpdate();
        }
    },

    /**
     * Update field value (value_template or value)
     */
    updateFieldValue(fieldKey, value, isBack) {
        const fields = isBack ? this.backFields : this.frontFields;
        const field = fields.find(f => f.field_key === fieldKey);
        if (field) {
            if (isBack) {
                field.value = value;
            } else {
                field.value_template = value;
            }
            PassStudio.markUnsaved();
            if (!isBack) this.notifyPreviewUpdate();
        }
    },

    /**
     * Change field location
     */
    changeLocation(fieldKey, newLocation) {
        const field = this.frontFields.find(f => f.field_key === fieldKey);
        if (!field) return;

        // Check limit
        const currentCount = this.frontFields.filter(f => f.field_location === newLocation && f.is_visible !== false).length;
        if (currentCount >= this.limits[newLocation]) {
            PassStudio.showToast(`Maximum ${this.limits[newLocation]} ${newLocation} field(s) allowed`, 'warning');
            // Revert select
            const card = document.querySelector(`[data-field-key="${fieldKey}"]`);
            if (card) {
                card.querySelector('.location-select').value = field.field_location;
            }
            return;
        }

        field.field_location = newLocation;

        // Move card to new container
        this.renderAllFields();
        this.initSortable();
        this.updateLimitCounters();
        PassStudio.markUnsaved();
        this.notifyPreviewUpdate();
    },

    /**
     * Toggle field visibility
     */
    toggleVisibility(fieldKey, visible, isBack) {
        const fields = isBack ? this.backFields : this.frontFields;
        const field = fields.find(f => f.field_key === fieldKey);
        if (field) {
            field.is_visible = visible;
            this.updateLimitCounters();
            PassStudio.markUnsaved();
            if (!isBack) this.notifyPreviewUpdate();
        }
    },

    /**
     * Delete a field
     */
    async deleteField(fieldKey, isBack) {
        const result = await Swal.fire({
            title: 'Delete Field?',
            text: `Are you sure you want to delete "${fieldKey}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('danger') : '#d33',
            confirmButtonText: 'Yes, delete'
        });

        if (result.isConfirmed) {
            if (isBack) {
                this.backFields = this.backFields.filter(f => f.field_key !== fieldKey);
            } else {
                this.frontFields = this.frontFields.filter(f => f.field_key !== fieldKey);
            }

            this.renderAllFields();
            this.initSortable();
            this.updateLimitCounters();
            PassStudio.markUnsaved();
            if (!isBack) this.notifyPreviewUpdate();
            PassStudio.showToast('Field deleted', 'success');
        }
    },

    /**
     * Reset fields to last saved state
     */
    resetFields() {
        Swal.fire({
            title: 'Reset Changes?',
            text: 'This will discard all unsaved changes.',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, reset'
        }).then((result) => {
            if (result.isConfirmed) {
                location.reload();
            }
        });
    },

    /**
     * Save all fields to server
     */
    async saveFields() {
        try {
            // Update display orders
            this.frontFields.forEach((f, i) => f.display_order = i);
            this.backFields.forEach((f, i) => f.display_order = i);

            const response = await fetch(`/admin/wallet/studio/{{ pass_type_code }}/fields`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrf_token]').value
                },
                body: JSON.stringify({
                    front_fields: this.frontFields,
                    back_fields: this.backFields
                })
            });

            const data = await response.json();
            if (data.success) {
                PassStudio.showToast('Fields saved successfully', 'success');
                PassStudio.markSaved();
            } else {
                PassStudio.showToast(data.error || 'Error saving fields', 'error');
            }
        } catch (error) {
            console.error('Save error:', error);
            PassStudio.showToast('Error saving fields', 'error');
        }
    },

    /**
     * Initialize default field configurations from server
     */
    async initializeDefaults() {
        try {
            const result = await Swal.fire({
                title: 'Load Default Fields?',
                text: 'This will create standard fields (Member Name, Year, etc.) for your pass. You can customize them afterward.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, load defaults',
                cancelButtonText: 'Cancel'
            });

            if (!result.isConfirmed) return;

            const response = await fetch('/admin/wallet/studio/init-defaults', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrf_token]').value
                }
            });

            const data = await response.json();
            if (data.success) {
                PassStudio.showToast('Default fields loaded! Refreshing page...', 'success');
                // Reload to show the new fields
                setTimeout(() => location.reload(), 1000);
            } else {
                PassStudio.showToast(data.error || 'Error loading defaults', 'error');
            }
        } catch (error) {
            console.error('Init error:', error);
            PassStudio.showToast('Error loading default fields', 'error');
        }
    }
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Event delegation for buttons
    document.querySelector('.js-initialize-defaults')?.addEventListener('click', function() {
        FieldsManager.initializeDefaults();
    });

    document.querySelector('.js-add-front-field')?.addEventListener('click', function() {
        FieldsManager.openAddFieldModal('front');
    });

    document.querySelector('.js-add-back-field')?.addEventListener('click', function() {
        FieldsManager.openAddFieldModal('back');
    });

    document.querySelector('.js-reset-fields')?.addEventListener('click', function() {
        FieldsManager.resetFields();
    });

    document.querySelector('.js-save-fields')?.addEventListener('click', function() {
        FieldsManager.saveFields();
    });

    document.querySelector('.js-create-field')?.addEventListener('click', function() {
        FieldsManager.createField();
    });

    // Insert variable buttons in add modal
    document.querySelectorAll('.js-insert-variable-add').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const varName = this.dataset.variableName;
            FieldsManager.insertVariableInAdd(varName);
        });
    });

    // Data from server
    const frontFields = [
        {% for field in front_fields %}
        {
            field_key: '{{ field.field_key }}',
            label: '{{ field.label }}',
            field_location: '{{ field.field_location }}',
            value_template: '{{ field.value_template or "" }}',
            is_visible: {{ 'true' if field.is_visible else 'false' }},
            display_order: {{ field.display_order }}
        }{{ ',' if not loop.last }}
        {% endfor %}
    ];

    const backFields = [
        {% for field in back_fields %}
        {
            field_key: '{{ field.field_key }}',
            label: '{{ field.label }}',
            value: `{{ field.value|replace('`', '\\`')|replace('\n', '\\n') }}`,
            field_type: '{{ field.field_type or "text" }}',
            is_visible: {{ 'true' if field.is_visible else 'false' }},
            display_order: {{ field.display_order }}
        }{{ ',' if not loop.last }}
        {% endfor %}
    ];

    const templateVariables = [
        {% for variable in template_variables %}
        { name: '{{ variable.name }}', description: '{{ variable.description }}' }{{ ',' if not loop.last }}
        {% endfor %}
    ];

    const sampleData = {
        {% if sample_data %}
        {% for key, value in sample_data.items() %}
        '{{ key }}': '{{ value }}'{{ ',' if not loop.last }}
        {% endfor %}
        {% else %}
        'member_name': 'Jane Smith',
        'validity': '2025',
        'member_since': '2023',
        'team_name': 'The Wildcats',
        'serial_number': 'ECS-001234',
        'barcode_data': 'ECS-001234'
        {% endif %}
    };

    FieldsManager.init(frontFields, backFields, templateVariables, sampleData);
});
</script>
