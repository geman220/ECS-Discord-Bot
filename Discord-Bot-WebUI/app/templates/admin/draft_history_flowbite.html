{% extends "base_flowbite.html" %}
{% from "macros/flowbite.html" import modal_form %}

{% block title %}Draft History - Admin{% endblock %}

{% block main_content %}
<div class="p-4 space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 mb-1">
                <a href="{{ url_for('admin.admin_dashboard') }}" class="hover:text-blue-600 dark:hover:text-blue-400">Admin</a>
                <span>/</span>
                <span>Draft History</span>
            </div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                <i class="ti ti-history text-blue-600"></i>Draft History
            </h1>
            <p class="text-gray-500 dark:text-gray-400">View and manage historical draft picks across all seasons and leagues</p>
        </div>
        <div class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-700 dark:text-blue-300 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
            {{ total_picks }} Total Picks
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-4">
        <form method="GET" id="draft-history-filterForm" class="flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-48">
                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Season</label>
                <select name="season" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="">All Seasons</option>
                    {% for season in seasons %}
                    <option value="{{ season.id }}" {% if current_season_filter == season.id %}selected{% endif %}>
                        {{ season.name }} ({{ season.league_type }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex-1 min-w-48">
                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">League</label>
                <select name="league" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="">All Leagues</option>
                    {% for league in leagues %}
                    <option value="{{ league.id }}" {% if current_league_filter == league.id %}selected{% endif %}>
                        {{ league.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex gap-2">
                <button type="submit" class="inline-flex items-center px-4 py-2.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                    <i class="ti ti-filter mr-2"></i>Apply
                </button>
                <a href="{{ url_for('admin.draft_history') }}" class="inline-flex items-center px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg transition-colors">
                    <i class="ti ti-filter-off mr-2"></i>Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Draft History Content -->
    {% if draft_history %}
        {% for season_name, leagues in draft_history.items() %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h5 class="font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <i class="ti ti-calendar text-blue-600"></i>{{ season_name }}
                </h5>
            </div>
            <div class="p-4 space-y-6">
                {% for league_name, picks in leagues.items() %}
                <div class="space-y-4">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <h6 class="text-gray-700 dark:text-gray-300 flex items-center gap-2">
                            <i class="ti ti-trophy text-yellow-500"></i>{{ league_name }}
                            <span class="px-2 py-0.5 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full">{{ picks|length }} picks</span>
                        </h6>
                        <div class="flex gap-2">
                            <button type="button" class="js-normalize-positions inline-flex items-center px-3 py-1.5 text-sm font-medium text-blue-700 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/40 border border-blue-200 dark:border-blue-800 rounded-lg transition-colors"
                                    data-season-id="{{ picks[0].season_id }}"
                                    data-league-id="{{ picks[0].league_id }}"
                                    data-season-name="{{ season_name }}"
                                    data-league-name="{{ league_name }}">
                                <i class="ti ti-arrows-sort mr-1"></i>Fix Order
                            </button>
                            <button type="button" class="js-clear-season-league inline-flex items-center px-3 py-1.5 text-sm font-medium text-red-700 dark:text-red-400 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/40 border border-red-200 dark:border-red-800 rounded-lg transition-colors"
                                    data-season-id="{{ picks[0].season_id }}"
                                    data-league-id="{{ picks[0].league_id }}"
                                    data-season-name="{{ season_name }}"
                                    data-league-name="{{ league_name }}">
                                <i class="ti ti-trash mr-1"></i>Clear All
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 sortable-draft-picks" data-season-id="{{ picks[0].season_id }}" data-league-id="{{ picks[0].league_id }}">
                        {% for pick in picks %}
                        <div class="sortable-item" data-pick-id="{{ pick.id }}" data-position="{{ pick.draft_position }}">
                            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600 cursor-grab hover:shadow-md transition-shadow">
                                <div class="flex items-start gap-3">
                                    <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-blue-600 text-white rounded-lg font-bold">
                                        {{ pick.draft_position }}
                                    </div>
                                    <div class="flex-grow min-w-0">
                                        <h6 class="font-semibold text-gray-900 dark:text-white truncate">{{ pick.player.name }}</h6>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1">
                                            <i class="ti ti-arrow-right"></i>{{ pick.team.name }}
                                        </p>
                                        <div class="mt-2 text-xs text-gray-500 dark:text-gray-400 space-y-0.5">
                                            <div class="flex items-center gap-1">
                                                <i class="ti ti-user"></i>Drafted by: {{ pick.drafter.username }}
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <i class="ti ti-calendar"></i>{{ pick.drafted_at.strftime('%Y-%m-%d %H:%M') }}
                                            </div>
                                            {% if pick.notes %}
                                            <div class="flex items-center gap-1 mt-1">
                                                <i class="ti ti-note"></i>{{ pick.notes }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <button type="button" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" data-dropdown-toggle="pickMenu{{ pick.id }}">
                                            <i class="ti ti-dots-vertical"></i>
                                        </button>
                                        <div id="pickMenu{{ pick.id }}" class="hidden z-10 w-44 bg-white rounded-lg shadow dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                                            <ul class="py-1 text-sm text-gray-700 dark:text-gray-200">
                                                <li>
                                                    <a href="#" class="js-edit-pick block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600"
                                                       data-pick-id="{{ pick.id }}"
                                                       data-draft-position="{{ pick.draft_position }}"
                                                       data-notes="{{ pick.notes|default('') }}"
                                                       data-player-name="{{ pick.player.name }}"
                                                       data-modal-toggle="editDraftPickModal">
                                                        <i class="ti ti-edit mr-2"></i>Edit
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="#" class="js-delete-pick block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 text-red-600 dark:text-red-400"
                                                       data-pick-id="{{ pick.id }}"
                                                       data-draft-position="{{ pick.draft_position }}"
                                                       data-player-name="{{ pick.player.name }}"
                                                       data-team-name="{{ pick.team.name }}">
                                                        <i class="ti ti-trash mr-2"></i>Delete
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
            <div class="p-12 text-center">
                <i class="ti ti-history text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No Draft History Found</h4>
                <p class="text-gray-500 dark:text-gray-400 mb-4">No draft picks have been recorded yet or your filters returned no results.</p>
                {% if current_season_filter or current_league_filter %}
                <a href="{{ url_for('admin.draft_history') }}" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                    <i class="ti ti-filter-off mr-2"></i>Clear Filters
                </a>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<!-- Edit Draft Pick Modal -->
{% call modal_form('editDraftPickModal', 'Edit Draft Pick', form_id='editDraftPickForm', submit_text='Save Changes', loading_text='Saving...') %}
    <input type="hidden" id="editPickId">

    <div>
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Player</label>
        <input type="text" id="editPlayerName" readonly class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block w-full p-2.5">
    </div>

    <div>
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Draft Position</label>
        <input type="number" id="editDraftPosition" min="1" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
    </div>

    <div>
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Position Change Mode</label>
        <div class="space-y-3">
            <label class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700">
                <input type="radio" name="positionMode" value="smart" checked class="mt-1 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                <div>
                    <span class="font-medium text-gray-900 dark:text-white">Smart Reorder (Recommended)</span>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Handles gaps intelligently - everyone gets renumbered cleanly</p>
                </div>
            </label>
            <label class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700">
                <input type="radio" name="positionMode" value="insert" class="mt-1 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                <div>
                    <span class="font-medium text-gray-900 dark:text-white">Directional Insert</span>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Natural directional shifting based on move direction</p>
                </div>
            </label>
            <label class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700">
                <input type="radio" name="positionMode" value="cascading" class="mt-1 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                <div>
                    <span class="font-medium text-gray-900 dark:text-white">Legacy Cascading</span>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Always shifts in one direction</p>
                </div>
            </label>
            <label class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700">
                <input type="radio" name="positionMode" value="absolute" class="mt-1 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                <div>
                    <span class="font-medium text-gray-900 dark:text-white">Simple Swap</span>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Just swap positions with whoever is at target</p>
                </div>
            </label>
        </div>
    </div>

    <div>
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Notes</label>
        <textarea id="editNotes" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
    </div>
{% endcall %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

    // Edit pick button handlers
    document.querySelectorAll('.js-edit-pick').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('editPickId').value = this.dataset.pickId;
            document.getElementById('editPlayerName').value = this.dataset.playerName;
            document.getElementById('editDraftPosition').value = this.dataset.draftPosition;
            document.getElementById('editNotes').value = this.dataset.notes || '';
        });
    });

    // Edit form submission
    document.getElementById('editDraftPickForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const pickId = document.getElementById('editPickId').value;
        const newPosition = document.getElementById('editDraftPosition').value;
        const notes = document.getElementById('editNotes').value;
        const mode = document.querySelector('input[name="positionMode"]:checked').value;

        fetch(`/admin/draft-history/edit/${pickId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ draft_position: newPosition, notes: notes, mode: mode })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Updated',
                    text: 'Draft pick updated successfully.',
                    background: isDark ? '#1f2937' : '#ffffff',
                    color: isDark ? '#f3f4f6' : '#111827'
                }).then(() => location.reload());
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.error || 'Failed to update draft pick.',
                    background: isDark ? '#1f2937' : '#ffffff',
                    color: isDark ? '#f3f4f6' : '#111827'
                });
            }
        });
    });

    // Delete pick handlers
    document.querySelectorAll('.js-delete-pick').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const pickId = this.dataset.pickId;
            const playerName = this.dataset.playerName;
            const teamName = this.dataset.teamName;

            Swal.fire({
                title: 'Delete Draft Pick?',
                text: `Are you sure you want to delete ${playerName}'s pick to ${teamName}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete',
                confirmButtonColor: '#dc2626',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/admin/draft-history/delete/${pickId}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken }
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.error || 'Failed to delete draft pick.',
                                background: isDark ? '#1f2937' : '#ffffff',
                                color: isDark ? '#f3f4f6' : '#111827'
                            });
                        }
                    });
                }
            });
        });
    });

    // Normalize positions handler
    document.querySelectorAll('.js-normalize-positions').forEach(btn => {
        btn.addEventListener('click', function() {
            const seasonId = this.dataset.seasonId;
            const leagueId = this.dataset.leagueId;
            const seasonName = this.dataset.seasonName;
            const leagueName = this.dataset.leagueName;

            Swal.fire({
                title: 'Fix Draft Order?',
                text: `This will renumber all draft positions for ${leagueName} in ${seasonName} sequentially.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, fix order',
                confirmButtonColor: '#2563eb',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/admin/draft-history/normalize', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ season_id: seasonId, league_id: leagueId })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Fixed',
                                text: 'Draft positions have been normalized.',
                                background: isDark ? '#1f2937' : '#ffffff',
                                color: isDark ? '#f3f4f6' : '#111827'
                            }).then(() => location.reload());
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.error || 'Failed to normalize positions.',
                                background: isDark ? '#1f2937' : '#ffffff',
                                color: isDark ? '#f3f4f6' : '#111827'
                            });
                        }
                    });
                }
            });
        });
    });

    // Clear season/league handler
    document.querySelectorAll('.js-clear-season-league').forEach(btn => {
        btn.addEventListener('click', function() {
            const seasonId = this.dataset.seasonId;
            const leagueId = this.dataset.leagueId;
            const seasonName = this.dataset.seasonName;
            const leagueName = this.dataset.leagueName;

            Swal.fire({
                title: 'Clear All Draft Picks?',
                text: `This will permanently delete all draft picks for ${leagueName} in ${seasonName}. This cannot be undone!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, clear all',
                confirmButtonColor: '#dc2626',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/admin/draft-history/clear', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ season_id: seasonId, league_id: leagueId })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Cleared',
                                text: 'All draft picks have been cleared.',
                                background: isDark ? '#1f2937' : '#ffffff',
                                color: isDark ? '#f3f4f6' : '#111827'
                            }).then(() => location.reload());
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.error || 'Failed to clear draft picks.',
                                background: isDark ? '#1f2937' : '#ffffff',
                                color: isDark ? '#f3f4f6' : '#111827'
                            });
                        }
                    });
                }
            });
        });
    });
});
</script>
{% endblock %}
