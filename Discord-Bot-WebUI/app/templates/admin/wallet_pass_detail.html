{% extends 'admin/layout.html' %}
{% block title %}Pass Details - {{ wallet_pass.member_name }}{% endblock %}

{% block custom_css %}
{{ super() }}
{# Styles moved to external CSS #}
{% endblock custom_css %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h2 class="fw-bold text-primary mb-1">
                        <i class="ti ti-id me-2"></i>Pass Details
                    </h2>
                    <p class="text-muted mb-0">Detailed information for {{ wallet_pass.member_name }}'s pass</p>
                </div>
                <div>
                    {% if wallet_pass.pass_type and wallet_pass.pass_type.code == 'ecs_membership' %}
                    <a href="{{ url_for('wallet_admin.passes_list', tab='ecs') }}" class="c-btn c-btn--outline-secondary">
                        <i class="ti ti-arrow-left me-1"></i>Back to ECS Passes
                    </a>
                    {% else %}
                    <a href="{{ url_for('wallet_admin.passes_list', tab='pub_league') }}" class="c-btn c-btn--outline-secondary">
                        <i class="ti ti-arrow-left me-1"></i>Back to Pub League Passes
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Status Banner -->
    <div class="row mb-4">
        <div class="col-12">
            {% if wallet_pass.status == 'active' and wallet_pass.is_valid %}
            <div class="status-banner active d-flex align-items-center">
                <i class="ti ti-circle-check text-success me-2 fs-4"></i>
                <div>
                    <strong class="text-success">Active Pass</strong>
                    <span class="text-muted ms-2">This pass is valid and can be used for check-ins.</span>
                </div>
            </div>
            {% elif wallet_pass.status == 'voided' %}
            <div class="status-banner voided d-flex align-items-center">
                <i class="ti ti-ban text-danger me-2 fs-4"></i>
                <div>
                    <strong class="text-danger">Voided Pass</strong>
                    <span class="text-muted ms-2">
                        {% if wallet_pass.void_reason %}{{ wallet_pass.void_reason }}{% else %}This pass has been voided and is no longer valid.{% endif %}
                    </span>
                </div>
            </div>
            {% elif wallet_pass.is_expired %}
            <div class="status-banner expired d-flex align-items-center">
                <i class="ti ti-clock text-secondary me-2 fs-4"></i>
                <div>
                    <strong class="text-secondary">Expired Pass</strong>
                    <span class="text-muted ms-2">This pass has expired and is no longer valid.</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Pass Details -->
        <div class="col-lg-8">
            <div class="c-card mb-4">
                <div class="c-card__header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="ti ti-user me-2"></i>{{ wallet_pass.member_name }}
                    </h5>
                    <span class="badge bg-label-{{ 'primary' if wallet_pass.pass_type and wallet_pass.pass_type.code == 'ecs_membership' else 'warning' }}" data-badge>
                        {{ wallet_pass.pass_type.name if wallet_pass.pass_type else 'Unknown Type' }}
                    </span>
                </div>
                <div class="c-card__body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">
                                <i class="ti ti-user me-1"></i>Member Information
                            </h6>
                            <div class="c-table-wrapper">
                                <table class="c-table detail-c-table c-table--compact" data-mobile-table data-table-type="wallet" data-table>
                                    <tr>
                                        <td data-label="Field">Name</td>
                                        <td data-label="Value" class="fw-semibold">{{ wallet_pass.member_name }}</td>
                                    </tr>
                                    <tr>
                                        <td data-label="Field">Email</td>
                                        <td data-label="Value">{{ wallet_pass.member_email or '-' }}</td>
                                    </tr>
                                    {% if wallet_pass.team_name %}
                                    <tr>
                                        <td data-label="Field">Team</td>
                                        <td data-label="Value"><span class="badge bg-label-info" data-badge>{{ wallet_pass.team_name }}</span></td>
                                    </tr>
                                    {% endif %}
                                    {% if wallet_pass.player_id %}
                                    <tr>
                                        <td data-label="Field">Player ID</td>
                                        <td data-label="Value">{{ wallet_pass.player_id }}</td>
                                    </tr>
                                    {% endif %}
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">
                                <i class="ti ti-calendar me-1"></i>Pass Validity
                            </h6>
                            <div class="c-table-wrapper">
                                <table class="c-table detail-c-table c-table--compact" data-mobile-table data-table-type="wallet" data-table>
                                    <tr>
                                        <td data-label="Field">Validity Period</td>
                                        <td data-label="Value" class="fw-semibold">{{ wallet_pass.display_validity }}</td>
                                    </tr>
                                    <tr>
                                        <td data-label="Field">Valid From</td>
                                        <td data-label="Value">{{ wallet_pass.valid_from.strftime('%b %d, %Y') if wallet_pass.valid_from else '-' }}</td>
                                    </tr>
                                    <tr>
                                        <td data-label="Field">Valid Until</td>
                                        <td data-label="Value">{{ wallet_pass.valid_until.strftime('%b %d, %Y') if wallet_pass.valid_until else '-' }}</td>
                                    </tr>
                                    <tr>
                                        <td data-label="Field">Downloads</td>
                                        <td data-label="Value"><span class="badge bg-label-info" data-badge>{{ wallet_pass.download_count }}</span></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">
                                <i class="ti ti-database me-1"></i>System Information
                            </h6>
                            <div class="c-table-wrapper">
                                <table class="c-table detail-c-table c-table--compact" data-mobile-table data-table-type="wallet" data-table>
                                    <tr>
                                        <td data-label="Field">Pass ID</td>
                                        <td data-label="Value"><code class="small">{{ wallet_pass.id }}</code></td>
                                    </tr>
                                    <tr>
                                        <td data-label="Field">Barcode</td>
                                        <td data-label="Value"><code class="small">{{ wallet_pass.barcode_data }}</code></td>
                                    </tr>
                                    <tr>
                                        <td data-label="Field">Serial Number</td>
                                        <td data-label="Value"><code class="small">{{ wallet_pass.serial_number }}</code></td>
                                    </tr>
                                    <tr>
                                        <td data-label="Field">Created</td>
                                        <td data-label="Value">{{ wallet_pass.created_at.strftime('%b %d, %Y %H:%M') }}</td>
                                    </tr>
                                    <tr>
                                        <td data-label="Field">Last Updated</td>
                                        <td data-label="Value">{{ wallet_pass.updated_at.strftime('%b %d, %Y %H:%M') if wallet_pass.updated_at else '-' }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">
                                <i class="ti ti-shopping-cart me-1"></i>WooCommerce
                            </h6>
                            <div class="c-table-wrapper">
                                <table class="c-table detail-c-table c-table--compact" data-mobile-table data-table-type="wallet" data-table>
                                    <tr>
                                        <td data-label="Field">Order ID</td>
                                        <td data-label="Value">{{ wallet_pass.woo_order_id or '-' }}</td>
                                    </tr>
                                    <tr>
                                        <td data-label="Field">Download Token</td>
                                        <td data-label="Value">
                                            {% if wallet_pass.download_token %}
                                            <code class="small">{{ wallet_pass.download_token[:16] }}...</code>
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            {% if wallet_pass.status == 'voided' and wallet_pass.voided_at %}
                            <h6 class="text-muted mb-3 mt-4">
                                <i class="ti ti-ban me-1"></i>Void Information
                            </h6>
                            <div class="c-table-wrapper">
                                <table class="c-table detail-c-table c-table--compact" data-mobile-table data-table-type="wallet" data-table>
                                    <tr>
                                        <td data-label="Field">Voided At</td>
                                        <td data-label="Value">{{ wallet_pass.voided_at.strftime('%b %d, %Y %H:%M') }}</td>
                                    </tr>
                                    <tr>
                                        <td data-label="Field">Reason</td>
                                        <td data-label="Value">{{ wallet_pass.void_reason or '-' }}</td>
                                    </tr>
                                </table>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Check-in History -->
            <div class="c-card">
                <div class="c-card__header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="ti ti-history me-2"></i>Check-in History
                    </h5>
                    {% if checkins %}
                    <span class="badge bg-label-primary" data-badge>{{ checkins|length }} check-ins</span>
                    {% endif %}
                </div>
                <div class="c-card__body">
                    {% if checkins %}
                    <div class="c-table-wrapper" data-table-responsive>
                        <table class="c-c-table c-table--compact c-table--hoverable" data-mobile-table data-table-type="wallet" data-table>
                            <thead class="c-table--light" scope="col">
                                <tr>
                                    <th scope="col">Date/Time</th>
                                    <th scope="col">Event</th>
                                    <th scope="col">Location</th>
                                    <th scope="col">Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for checkin in checkins %}
                                <tr>
                                    <td>
                                        <small>{{ checkin.checked_in_at.strftime('%b %d, %Y %H:%M') }}</small>
                                    </td>
                                    <td>{{ checkin.event_name or '-' }}</td>
                                    <td>{{ checkin.location or '-' }}</td>
                                    <td>
                                        <span class="badge bg-label-info" data-badge>
                                            {{ checkin.check_in_type.value.replace('_', ' ').title() if checkin.check_in_type else 'Unknown' }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="ti ti-calendar-off mb-2" class="u-icon-xl"></i>
                        <p class="mb-0">No check-ins recorded for this pass</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Actions Card -->
            <div class="c-card mb-4">
                <div class="c-card__header">
                    <h6 class="mb-0">
                        <i class="ti ti-settings me-1"></i>Actions
                    </h6>
                </div>
                <div class="c-card__body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('wallet_admin.download_pass', pass_id=wallet_pass.id, platform='apple') }}"
                           class="c-btn c-btn--dark">
                            <i class="ti ti-brand-apple me-1"></i>Download Apple Pass
                        </a>

                        {% if wallet_pass.status == 'active' %}
                        <button type="button" class="c-btn c-btn--outline-danger" data-action="void-pass" data-pass-id="{{ wallet_pass.id }}">
                            <i class="ti ti-ban me-1"></i>Void Pass
                        </button>
                        {% else %}
                        <button type="button" class="c-btn c-btn--outline-success" data-action="reactivate-pass" data-pass-id="{{ wallet_pass.id }}">
                            <i class="ti ti-refresh me-1"></i>Reactivate Pass
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- QR Code Preview -->
            <div class="c-card mb-4">
                <div class="c-card__header">
                    <h6 class="mb-0">
                        <i class="ti ti-qrcode me-1"></i>Pass QR Code
                    </h6>
                </div>
                <div class="c-card__body">
                    <div class="qr-container text-center">
                        <div id="qrcode" class="mb-3"></div>
                        <code class="small text-break">{{ wallet_pass.barcode_data }}</code>
                    </div>
                </div>
            </div>

            <!-- Download Link -->
            {% if wallet_pass.download_token %}
            <div class="c-card">
                <div class="c-card__header">
                    <h6 class="mb-0">
                        <i class="ti ti-link me-1"></i>Public Download Link
                    </h6>
                </div>
                <div class="c-card__body">
                    <p class="small text-muted mb-2">Share this link with the member to download their pass:</p>
                    <div class="input-group" data-input-group>
                        <input type="text" class="form-control form-control-sm" id="download-link"
                               value="{{ url_for('public_wallet.pass_info', token=wallet_pass.download_token, _external=True) }}"
                               readonly data-form-control>
                        <button class="c-btn c-btn--outline-primary c-btn--sm js-copy-link" data-action="copy-link" aria-label="Copy"><i class="ti ti-copy"></i></button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

<script>
// QR code generation - must remain inline due to template variable
document.addEventListener('DOMContentLoaded', function() {
    if (typeof qrcode !== 'undefined') {
        var qr = qrcode(0, 'M');
        qr.addData('{{ wallet_pass.barcode_data }}');
        qr.make();
        document.getElementById('qrcode').innerHTML = qr.createSvgTag(4, 0);
    }
});
// All other handlers migrated to event-delegation admin-wallet.js
</script>
{% endblock %}
