{% extends "admin_panel/base.html" %}

{% block title %}Match Detail{% endblock %}

{% block panel_description %}Detailed view of match and live reporting status{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_live.dashboard') }}">Live Reporting</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('admin_live.matches') }}">Matches</a></li>
<li class="breadcrumb-item active">Match {{ match.id }}</li>
{% endblock %}

{% block custom_css %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/match-detail.css') }}">
{% endif %}
{% endblock %}

{% block panel_content %}
    <div class="c-match-header" data-component="match-header">
        <h1 class="c-match-header__title">
            <i class="fas fa-futbol"></i> Match {{ match.id }} Detail
        </h1>
        <div class="c-match-header__actions">
            <a href="{{ url_for('admin_live.matches') }}" class="c-btn c-btn--outline-secondary" data-action="back-to-matches">
                <i class="fas fa-arrow-left"></i> Back to Matches
            </a>
            {% if not live_session %}
                <button class="c-btn c-btn--success" data-action="schedule-match" data-id="{{ match.id }}">
                    <i class="fas fa-broadcast-tower"></i> Schedule Live Reporting
                </button>
            {% elif live_session.is_active %}
                <button class="c-btn c-btn--danger" data-action="stop-session" data-id="{{ live_session.id }}">
                    <i class="fas fa-stop"></i> Stop Live Reporting
                </button>
            {% endif %}
        </div>
    </div>

    <!-- Teams Display -->
    <div class="c-teams-display" data-component="teams-display">
        <div class="row align-items-center">
            <div class="col-md-5 c-team-section">
                <h3 class="c-team-section__title">
                    {% if match.is_home_game %}
                        Seattle Sounders FC
                    {% else %}
                        {{ match.opponent }}
                    {% endif %}
                </h3>
                <div class="text-muted">Home Team</div>
            </div>
            <div class="col-md-2 c-vs-separator">
                <div class="c-vs-separator__text">VS</div>
                {% if match.date_time %}
                    <div class="c-vs-separator__date">{{ match.date_time.strftime('%b %d, %Y') }}</div>
                {% endif %}
            </div>
            <div class="col-md-5 c-team-section">
                <h3 class="c-team-section__title">
                    {% if match.is_home_game %}
                        {{ match.opponent }}
                    {% else %}
                        Seattle Sounders FC
                    {% endif %}
                </h3>
                <div class="text-muted">Away Team</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Match Information -->
        <div class="col-md-6">
            <div class="c-detail-section" data-component="detail-section">
                <h4 class="c-detail-section__header">
                    <i class="fas fa-info-circle"></i> Match Information
                </h4>

                <div class="row c-info-row">
                    <div class="col-sm-4 c-info-row__label">Match ID:</div>
                    <div class="col-sm-8 c-info-row__value">{{ match.id }}</div>
                </div>

                {% if match.date_time %}
                <div class="row c-info-row">
                    <div class="col-sm-4 c-info-row__label">Date:</div>
                    <div class="col-sm-8 c-info-row__value">{{ match.date_time.strftime('%A, %B %d, %Y at %I:%M %p') }}</div>
                </div>
                {% endif %}

                {% if match.competition %}
                <div class="row c-info-row">
                    <div class="col-sm-4 c-info-row__label">Competition:</div>
                    <div class="col-sm-8 c-info-row__value">{{ match.competition }}</div>
                </div>
                {% endif %}

                {% if match.venue %}
                <div class="row c-info-row">
                    <div class="col-sm-4 c-info-row__label">Venue:</div>
                    <div class="col-sm-8 c-info-row__value">{{ match.venue }}</div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Live Reporting Session -->
        <div class="col-md-6">
            <div class="c-detail-section" data-component="detail-section">
                <h4 class="c-detail-section__header">
                    <i class="fas fa-broadcast-tower"></i> Live Reporting Status
                </h4>

                {% if live_session %}
                    <div class="row c-info-row">
                        <div class="col-sm-4 c-info-row__label">Session ID:</div>
                        <div class="col-sm-8 c-info-row__value">{{ live_session.id }}</div>
                    </div>

                    <div class="row c-info-row">
                        <div class="col-sm-4 c-info-row__label">Status:</div>
                        <div class="col-sm-8 c-info-row__value">
                            <span class="c-status-indicator c-status-indicator--{{ 'active' if live_session.is_active else 'inactive' }}" data-status="{{ 'active' if live_session.is_active else 'inactive' }}"></span>
                            {{ 'Active' if live_session.is_active else 'Inactive' }}
                        </div>
                    </div>

                    {% if live_session.thread_id %}
                    <div class="row c-info-row">
                        <div class="col-sm-4 c-info-row__label">Discord Thread:</div>
                        <div class="col-sm-8 c-info-row__value">
                            <code class="c-code-display">{{ live_session.thread_id }}</code>
                        </div>
                    </div>
                    {% endif %}

                    {% if live_session.competition %}
                    <div class="row c-info-row">
                        <div class="col-sm-4 c-info-row__label">Competition:</div>
                        <div class="col-sm-8 c-info-row__value">{{ live_session.competition }}</div>
                    </div>
                    {% endif %}

                    {% if live_session.started_at %}
                    <div class="row c-info-row">
                        <div class="col-sm-4 c-info-row__label">Started:</div>
                        <div class="col-sm-8 c-info-row__value">{{ live_session.started_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</div>
                    </div>
                    {% endif %}

                    {% if live_session.ended_at %}
                    <div class="row c-info-row">
                        <div class="col-sm-4 c-info-row__label">Ended:</div>
                        <div class="col-sm-8 c-info-row__value">{{ live_session.ended_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</div>
                    </div>
                    {% endif %}

                    {% if live_session.last_status %}
                    <div class="row c-info-row">
                        <div class="col-sm-4 c-info-row__label">Last Status:</div>
                        <div class="col-sm-8 c-info-row__value">{{ live_session.last_status }}</div>
                    </div>
                    {% endif %}

                    {% if live_session.update_count %}
                    <div class="row c-info-row">
                        <div class="col-sm-4 c-info-row__label">Updates:</div>
                        <div class="col-sm-8 c-info-row__value">{{ live_session.update_count }}</div>
                    </div>
                    {% endif %}

                    {% if live_session.error_count and live_session.error_count > 0 %}
                    <div class="row c-info-row">
                        <div class="col-sm-4 c-info-row__label">Errors:</div>
                        <div class="col-sm-8 c-info-row__value">
                            <span class="text-warning">{{ live_session.error_count }}</span>
                        </div>
                    </div>
                    {% endif %}

                    {% if live_session.last_update_at %}
                    <div class="row c-info-row">
                        <div class="col-sm-4 c-info-row__label">Last Update:</div>
                        <div class="col-sm-8 c-info-row__value">{{ live_session.last_update_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</div>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="c-no-session-state" data-component="no-session-state">
                        <i class="fas fa-broadcast-tower c-no-session-state__icon"></i>
                        <h5 class="c-no-session-state__title">No Live Reporting Session</h5>
                        <p class="c-no-session-state__text">This match does not have an active live reporting session.</p>
                        <button class="c-btn c-btn--primary" data-action="schedule-match" data-id="{{ match.id }}">
                            <i class="fas fa-plus"></i> Schedule Live Reporting
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Scheduling Information -->
    {% if match_scheduling %}
    <div class="c-detail-section" data-component="detail-section">
        <h4 class="c-detail-section__header">
            <i class="fas fa-calendar-check"></i> Scheduling Information
        </h4>

        <div class="row">
            <div class="col-md-6">
                <div class="row c-info-row">
                    <div class="col-sm-4 c-info-row__label">Category:</div>
                    <div class="col-sm-8 c-info-row__value">
                        <span class="badge bg-{{ 'success' if match_scheduling.category == 'active_live' else 'primary' if match_scheduling.category == 'upcoming_live' else 'info' if match_scheduling.category == 'upcoming_threads' else 'secondary' }}" data-badge>
                            {{ match_scheduling.category.replace('_', ' ').title() }}
                        </span>
                    </div>
                </div>

                {% if match_scheduling.get('scheduled_time') %}
                <div class="row c-info-row">
                    <div class="col-sm-4 c-info-row__label">Scheduled Time:</div>
                    <div class="col-sm-8 c-info-row__value">{{ match_scheduling.scheduled_time }}</div>
                </div>
                {% endif %}
            </div>

            <div class="col-md-6">
                {% if match_scheduling.get('thread_id') %}
                <div class="row c-info-row">
                    <div class="col-sm-4 c-info-row__label">Thread ID:</div>
                    <div class="col-sm-8 c-info-row__value"><code class="c-code-display">{{ match_scheduling.thread_id }}</code></div>
                </div>
                {% endif %}

                {% if match_scheduling.get('task_id') %}
                <div class="row c-info-row">
                    <div class="col-sm-4 c-info-row__label">Task ID:</div>
                    <div class="col-sm-8 c-info-row__value"><code class="c-code-display">{{ match_scheduling.task_id }}</code></div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="c-detail-section" data-component="detail-section">
        <h4 class="c-detail-section__header">
            <i class="fas fa-cogs"></i> Actions
        </h4>

        <div class="c-match-actions" data-component="match-actions">
            {% if live_session and live_session.is_active %}
                <button class="c-btn c-btn--danger" data-action="stop-session" data-id="{{ live_session.id }}">
                    <i class="fas fa-stop"></i> Stop Live Reporting
                </button>
                <button class="c-btn c-btn--warning" data-action="refresh-session" data-session-id="{{ live_session.id }}">
                    <i class="fas fa-sync"></i> Refresh Session
                </button>
            {% elif not live_session %}
                <button class="c-btn c-btn--success" data-action="schedule-match" data-id="{{ match.id }}">
                    <i class="fas fa-broadcast-tower"></i> Schedule Live Reporting
                </button>
            {% endif %}

            <button class="c-btn c-btn--info" data-action="force-sync">
                <i class="fas fa-sync-alt"></i> Force Sync
            </button>

            <button class="c-btn c-btn--secondary" data-action="reload-page">
                <i class="fas fa-refresh"></i> Refresh Page
            </button>
        </div>
    </div>
{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') %}
<script>
    // Bootstrap data for JavaScript
    window.matchDetailData = {
        matchId: {{ match.id }},
        sessionId: {{ live_session.id if live_session else 'null' }},
        hasSession: {{ 'true' if live_session else 'false' }}
    };
</script>
<script src="{{ url_for('static', filename='custom_js/admin-match-detail.js') }}"></script>
{% endif %}
{% endblock %}
