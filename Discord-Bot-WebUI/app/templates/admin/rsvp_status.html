{% extends "base.html" %}

{% block title %}Match RSVP Status{% endblock %}

{% block custom_css %}
{{ super() }}
<!-- RSVP Status Page Styles -->
<!-- Toastr CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/rsvp-status.css') }}" />
{% endif %}
{% endblock %}

{% block main_content %}
<!-- Page Loader -->
<div id="page-loader" class="c-page-loader">
    <span class="loader-spinner"></span>
</div>
<!-- Store user role data for JavaScript -->
<script type="text/javascript">
    document.body.dataset.userRoles = "{{ user_roles|join(',') }}";
</script>
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header with Breadcrumb -->
    <h4 class="fw-bold py-3 mb-3">
        <span class="text-muted fw-light">Admin / Match / </span> RSVP Status
    </h4>

    <!-- Match Info Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card shadow-sm">
                <div class="c-card__body">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                        <div class="mb-3 mb-md-0">
                            {% if is_ecs_fc_match %}
                            <h4 class="mb-1">{{ ecs_match.team.name }} vs {{ ecs_match.opponent_name }}</h4>
                            <div class="d-flex align-items-center gap-3 text-muted">
                                <div>
                                    <i class="ti ti-calendar me-1"></i> 
                                    <span>{{ ecs_match.match_date.strftime('%a, %b %d, %Y') }}</span>
                                </div>
                                <div>
                                    <i class="ti ti-clock me-1"></i>
                                    <span>{{ ecs_match.match_time.strftime('%I:%M %p') }}</span>
                                </div>
                                <div>
                                    <i class="ti ti-map-pin me-1"></i>
                                    <span>{{ ecs_match.location }}</span>
                                </div>
                                {% if ecs_match.field_name %}
                                <div>
                                    <i class="ti ti-world me-1"></i>
                                    <span>{{ ecs_match.field_name }}</span>
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <h4 class="mb-1">{{ match.home_team.name }} vs {{ match.away_team.name }}</h4>
                            <div class="d-flex align-items-center gap-3 text-muted">
                                <div>
                                    <i class="ti ti-calendar me-1"></i> 
                                    <span>{{ match.date.strftime('%a, %b %d, %Y') }}</span>
                                </div>
                                <div>
                                    <i class="ti ti-clock me-1"></i>
                                    <span>{{ match.time.strftime('%I:%M %p') }}</span>
                                </div>
                                <div>
                                    <i class="ti ti-map-pin me-1"></i>
                                    <span>{{ match.location }}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="d-flex gap-2">
                            {% if is_ecs_fc_match %}
                            <a href="{{ url_for('match_pages.view_match', match_id='ecs_' + ecs_match.id|string) }}" class="c-btn c-btn--primary ecs-btn ecs-btn-icon">
                            {% else %}
                            <a href="{{ url_for('match_pages.view_match', match_id=match.id) }}" class="c-btn c-btn--primary ecs-btn ecs-btn-icon">
                            {% endif %}
                                <i class="ti ti-eye me-1"></i> View Match Page
                            </a>
                            {% if has_role('Global Admin') or has_role('Pub League Admin') %}
                            <button type="button" class="c-btn c-btn--success ecs-btn ecs-btn-icon" data-bs-toggle="modal" data-bs-target="#assignSubModalRSVP">
                                <i class="ti ti-user-plus me-1"></i> Assign Substitute
                            </button>
                            {% endif %}
                            {% if has_role('Pub League Coach') or has_role('Global Admin') or has_role('Pub League Admin') or has_role('ECS FC Coach') %}
                            <button type="button" class="c-btn c-btn--warning ecs-btn ecs-btn-icon" data-bs-toggle="modal" data-bs-target="#requestSubModal">
                                <i class="ti ti-hand-stop me-1"></i> Request Substitute
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RSVP Summary Cards -->
    <div class="row mb-4">
        {% set yes_count = rsvps|selectattr('response', 'equalto', 'yes')|list|count %}
        {% set no_count = rsvps|selectattr('response', 'equalto', 'no')|list|count %}
        {% set maybe_count = rsvps|selectattr('response', 'equalto', 'maybe')|list|count %}
        {% set total_count = rsvps|count %}

        <div class="col-md-3 col-sm-6 mb-3">
            <div class="c-card h-100 shadow-sm">
                <div class="c-card__body">
                    <div class="d-flex align-items-center">
                        <div class="avatar avatar-md me-2">
                            <div class="avatar-initial rounded bg-label-primary">
                                <i class="ti ti-users"></i>
                            </div>
                        </div>
                        <div>
                            <h5 class="mb-0">{{ total_count }}</h5>
                            <small class="text-muted">Total Responses</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="c-card h-100 shadow-sm">
                <div class="c-card__body">
                    <div class="d-flex align-items-center">
                        <div class="avatar avatar-md me-2">
                            <div class="avatar-initial rounded bg-label-success">
                                <i class="ti ti-check"></i>
                            </div>
                        </div>
                        <div>
                            <h5 class="mb-0">{{ yes_count }}</h5>
                            <small class="text-muted">Confirmed Attending</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="c-card h-100 shadow-sm">
                <div class="c-card__body">
                    <div class="d-flex align-items-center">
                        <div class="avatar avatar-md me-2">
                            <div class="avatar-initial rounded bg-label-warning">
                                <i class="ti ti-help"></i>
                            </div>
                        </div>
                        <div>
                            <h5 class="mb-0">{{ maybe_count }}</h5>
                            <small class="text-muted">Maybe Attending</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="c-card h-100 shadow-sm">
                <div class="c-card__body">
                    <div class="d-flex align-items-center">
                        <div class="avatar avatar-md me-2">
                            <div class="avatar-initial rounded bg-label-danger">
                                <i class="ti ti-x"></i>
                            </div>
                        </div>
                        <div>
                            <h5 class="mb-0">{{ no_count }}</h5>
                            <small class="text-muted">Not Attending</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card shadow-sm">
                <div class="c-card__header border-bottom">
                    <ul class="nav nav-tabs c-card__header c-card__header--tabs" role="tablist" data-tabs>
                        <li class="nav-item">
                            <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-responses" type="button" role="tab" aria-controls="all-responses" aria-selected="true">
                                All Responses
                            </button>
                        </li>
                        {% if is_ecs_fc_match %}
                        <li class="nav-item">
                            <button class="nav-link" id="team-tab" data-bs-toggle="tab" data-bs-target="#team-responses" type="button" role="tab" aria-controls="team-responses" aria-selected="false">
                                {{ ecs_match.team.name }} ({{ rsvps|count }})
                            </button>
                        </li>
                        {% else %}
                        {% set home_team_responses = rsvps|selectattr('team.id', 'equalto', match.home_team.id)|list %}
                        {% set away_team_responses = rsvps|selectattr('team.id', 'equalto', match.away_team.id)|list %}
                        
                        <li class="nav-item">
                            <button class="nav-link" id="home-tab" data-bs-toggle="tab" data-bs-target="#home-team" type="button" role="tab" aria-controls="home-team" aria-selected="false">
                                {{ match.home_team.name }} ({{ home_team_responses|count }})
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="away-tab" data-bs-toggle="tab" data-bs-target="#away-team" type="button" role="tab" aria-controls="away-team" aria-selected="false">
                                {{ match.away_team.name }} ({{ away_team_responses|count }})
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="c-card__body">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="all-responses" role="tabpanel" aria-labelledby="all-tab" data-tab-pane>
                            <!-- Mobile Card Layout -->
                            <div class="rsvp-mobile-list">
                                {% for rsvp in rsvps %}
                                <div class="rsvp-mobile-card" data-player-id="{{ rsvp['player'].id }}">
                                    <div class="rsvp-card-main">
                                        <div class="player-info-mobile">
                                            <div class="avatar avatar-sm me-3 rsvp-avatar">
                                                {% if rsvp['player'].profile_picture_url %}
                                                    <img src="{{ rsvp['player'].profile_picture_url }}" alt="Avatar" class="rounded-circle rsvp-avatar-image">
                                                {% else %}
                                                    <div class="avatar-initial rounded-circle bg-label-secondary">
                                                        {{ rsvp['player'].name[:1]|upper }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="rsvp-player-container">
                                                <div class="player-name-mobile">{{ rsvp['player'].name }}</div>
                                                <div class="player-meta-mobile">
                                                    {% if is_ecs_fc_match %}
                                                    <span class="badge bg-primary" data-badge>{{ rsvp['team'].name }}</span>
                                                    {% else %}
                                                    <span class="badge bg-{{ 'primary' if rsvp['team'].id == match.home_team.id else 'info' }}" data-badge>{{ rsvp['team'].name }}</span>
                                                    {% endif %}
                                                    {% if rsvp['is_temp_sub'] %}
                                                    <span class="badge bg-label-info" data-badge>
                                                        <i class="ti ti-replace"></i> SUB
                                                    </span>
                                                    {% endif %}
                                                    {% if rsvp['discord_synced'] %}
                                                    <span class="badge bg-label-info" data-badge>
                                                        <i class="ti ti-brand-discord"></i>
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="rsvp-actions-wrapper">
                                            <span class="response-badge-mobile {{ 'bg-success text-white' if rsvp['response'] == 'yes' else 'bg-danger text-white' if rsvp['response'] == 'no' else 'bg-warning text-white' if rsvp['response'] == 'maybe' else 'bg-secondary text-white' }}" data-badge>
                                                <i class="ti ti-{{ 'check' if rsvp['response'] == 'yes' else 'x' if rsvp['response'] == 'no' else 'help' if rsvp['response'] == 'maybe' else 'minus' }}"></i>
                                                {{ rsvp['response']|capitalize }}
                                            </span>
                                            <button class="expand-button js-toggle-card-expansion" data-action="toggle-card-expansion" aria-label="Expand"><i class="ti ti-chevron-down"></i></button>
                                        </div>
                                    </div>
                                    
                                    <div class="rsvp-card-body">
                                        <!-- Response Time -->
                                        <div class="rsvp-response-time-box">
                                            <small class="text-muted d-block rsvp-response-time-label">Response Time</small>
                                            {% if rsvp['responded_at'] %}
                                                <div class="rsvp-response-time-value">{{ rsvp['responded_at'].strftime('%b %d, %Y at %I:%M %p') }}</div>
                                            {% else %}
                                                <div class="rsvp-no-response-text">No response yet</div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Contact Actions -->
                                        {% set has_sms = rsvp['player'].phone and rsvp['player'].user and rsvp['player'].user.sms_notifications %}
                                        {% set has_discord = rsvp['player'].discord_id and rsvp['player'].user and rsvp['player'].user.discord_notifications %}
                                        {% set has_email = rsvp['player'].email %}
                                        
                                        {% if has_sms or has_discord or has_email %}
                                        <div class="contact-actions-mobile">
                                            {% if has_sms %}
                                            <button class="contact-action-btn bg-primary text-white" data-action="rsvp-request-sms" data-player-id="{{ rsvp['player'].id }}" data-player-name="{{ rsvp['player'].name }}" data-phone="{{ rsvp['player'].phone }}">
                                                <i class="ti ti-message"></i> SMS
                                            </button>
                                            {% endif %}
                                            
                                            {% if has_discord %}
                                            <button class="contact-action-btn bg-indigo text-white" data-action="rsvp-request-discord-dm" data-player-id="{{ rsvp['player'].id }}" data-player-name="{{ rsvp['player'].name }}" data-discord-id="{{ rsvp['player'].discord_id }}">
                                                <i class="ti ti-brand-discord"></i> Discord
                                            </button>
                                            {% endif %}
                                            
                                            {% if has_email %}
                                            <a href="mailto:{{ rsvp['player'].email }}" class="contact-action-btn bg-info text-white">
                                                <i class="ti ti-mail"></i> Email
                                            </a>
                                            {% endif %}
                                            
                                            <a href="{{ url_for('players.player_profile', player_id=rsvp['player'].id) }}" class="contact-action-btn bg-secondary text-white">
                                                <i class="ti ti-user"></i> Profile
                                            </a>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- RSVP Actions -->
                                        <div class="rsvp-actions-mobile">
                                            <button class="rsvp-action-btn bg-success text-white" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="yes">
                                                <i class="ti ti-check"></i> Set Yes
                                            </button>
                                            <button class="rsvp-action-btn bg-danger text-white" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="no">
                                                <i class="ti ti-x"></i> Set No
                                            </button>
                                            <button class="rsvp-action-btn bg-warning text-white" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="maybe">
                                                <i class="ti ti-help"></i> Maybe
                                            </button>
                                            <button class="rsvp-action-btn bg-secondary text-white" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="no_response">
                                                <i class="ti ti-trash"></i> Clear
                                            </button>
                                        </div>
                                        
                                        <!-- Sub Management (if applicable) -->
                                        {% if rsvp['is_temp_sub'] %}
                                        <div class="rsvp-sub-form">
                                            <form action="{{ url_for('admin.remove_sub', assignment_id=rsvp.get('assignment_id', 0)) }}" method="POST" class="rsvp-sub-form-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <input type="hidden" name="redirect_to" value="rsvp_status">
                                                <button type="submit" class="contact-action-btn bg-danger text-white w-100">
                                                    <i class="ti ti-user-minus"></i> Remove Sub Assignment
                                                </button>
                                            </form>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Desktop Table Layout -->
                            <div class="c-table-wrapper" data-table-responsive>
                                <table id="rsvpStatusTable" class="c-table c-table--striped c-table--hoverable border-top" data-mobile-table data-table-type="rsvp" data-table>
                                    <thead scope="col">
                                        <tr>
                                            <th scope="col">Player</th>
                                            <th scope="col">Team</th>
                                            <th scope="col">Response</th>
                                            <th scope="col">Responded At</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rsvp in rsvps %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar avatar-sm me-2 rsvp-avatar">
                                                        {% if rsvp['player'].profile_picture_url %}
                                                            <img src="{{ rsvp['player'].profile_picture_url }}" alt="Avatar" class="rounded-circle rsvp-avatar-image">
                                                        {% else %}
                                                            <div class="avatar-initial rounded-circle bg-label-secondary">
                                                                {{ rsvp['player'].name[:1]|upper }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="d-flex flex-column">
                                                        <div class="d-flex align-items-center">
                                                            <span class="fw-semibold">{{ rsvp['player'].name }}</span>
                                                            {% if rsvp['is_temp_sub'] %}
                                                            <span class="badge bg-label-info ms-2" data-bs-toggle="tooltip" title="Temporary substitute assigned by {{ rsvp['assigned_by'] }}" data-badge>
                                                                <i class="ti ti-replace me-1"></i>SUB
                                                            </span>
                                                            {% endif %}
                                                        </div>
                                                        <small class="text-muted">
                                                            {% if rsvp['player'].phone %}
                                                                <i class="ti ti-phone-call me-1"></i>{{ rsvp['player'].phone }}
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if is_ecs_fc_match %}
                                                <span class="badge bg-primary" data-badge>
                                                    {{ rsvp['team'].name }}
                                                </span>
                                                {% else %}
                                                <span class="badge bg-{{ 'primary' if rsvp['team'].id == match.home_team.id else 'info' }}" data-badge>
                                                    {{ rsvp['team'].name }}
                                                </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge {{ 'bg-success' if rsvp['response'] == 'yes' else 'bg-danger' if rsvp['response'] == 'no' else 'bg-warning' if rsvp['response'] == 'maybe' else 'bg-secondary' }} me-2" data-badge>
                                                        {{ rsvp['response']|capitalize }}
                                                    </span>
                                                    {% if rsvp['discord_synced'] %}
                                                        <span class="badge bg-label-info" data-bs-toggle="tooltip" data-bs-placement="top" title="Synced with Discord" data-badge>
                                                            <i class="ti ti-brand-discord"></i>
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                {% if rsvp['responded_at'] %}
                                                    <div class="d-flex flex-column">
                                                        <span>{{ rsvp['responded_at'].strftime('%Y-%m-%d') }}</span>
                                                        <small class="text-muted">{{ rsvp['responded_at'].strftime('%I:%M %p') }}</small>
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">No response</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="dropdown">
                                                    <button type="button" class="c-btn c-btn--sm c-btn--icon-only c-btn--outline-secondary dropdown-toggle hide-arrow" data-bs-toggle="dropdown" data-dropdown-toggle aria-label="More options"><i class="ti ti-dots-vertical"></i></button>
                                                    <div class="dropdown-menu dropdown-menu-end" data-dropdown-menu>
                                                        <a class="dropdown-item" href="{{ url_for('players.player_profile', player_id=rsvp['player'].id) }}">
                                                            <i class="ti ti-user me-1"></i> View Profile
                                                        </a>
                                                        
                                                        <!-- Contact Options -->
                                                        {% set has_sms = rsvp['player'].phone and rsvp['player'].user and rsvp['player'].user.sms_notifications %}
                                                        {% set has_discord = rsvp['player'].discord_id and rsvp['player'].user and rsvp['player'].user.discord_notifications %}
                                                        {% set has_email = rsvp['player'].email %}
                                                        
                                                        {% if has_sms or has_discord or has_email %}
                                                        <div class="dropdown-divider"></div>
                                                        <h6 class="dropdown-header">Contact Options</h6>
                                                        
                                                        {% if has_sms %}
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-request-sms" data-player-id="{{ rsvp['player'].id }}" data-player-name="{{ rsvp['player'].name }}" data-phone="{{ rsvp['player'].phone }}">
                                                            <i class="ti ti-message me-1"></i> Send SMS
                                                        </a>
                                                        {% endif %}

                                                        {% if has_discord %}
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-request-discord-dm" data-player-id="{{ rsvp['player'].id }}" data-player-name="{{ rsvp['player'].name }}" data-discord-id="{{ rsvp['player'].discord_id }}">
                                                            <i class="ti ti-brand-discord me-1"></i> Send Discord DM
                                                        </a>
                                                        {% endif %}
                                                        
                                                        {% if has_email %}
                                                        <a class="dropdown-item" href="mailto:{{ rsvp['player'].email }}">
                                                            <i class="ti ti-mail me-1"></i> Send Email
                                                        </a>
                                                        {% endif %}
                                                        {% endif %}
                                                        
                                                        <!-- RSVP Options -->
                                                        <div class="dropdown-divider"></div>
                                                        <h6 class="dropdown-header">Update RSVP</h6>
                                                        
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="yes">
                                                            <i class="ti ti-check text-success me-1"></i> Set as Yes
                                                        </a>
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="maybe">
                                                            <i class="ti ti-help text-warning me-1"></i> Set as Maybe
                                                        </a>
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="no">
                                                            <i class="ti ti-x text-danger me-1"></i> Set as No
                                                        </a>
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="no_response">
                                                            <i class="ti ti-trash me-1"></i> Clear Response
                                                        </a>
                                                        
                                                        {% if rsvp['is_temp_sub'] %}
                                                        <!-- Sub Management Options -->
                                                        <div class="dropdown-divider"></div>
                                                        <h6 class="dropdown-header">Sub Management</h6>
                                                        <form action="{{ url_for('admin.remove_sub', assignment_id=rsvp.get('assignment_id', 0)) }}" method="POST" class="d-inline">
                                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                            <input type="hidden" name="redirect_to" value="rsvp_status">
                                                            <button type="submit" class="dropdown-item text-danger">
                                                                <i class="ti ti-user-minus me-1"></i> Remove Sub Assignment
                                                            </button>
                                                        </form>
                                                        {% else %}
                                                        <!-- Add as Sub Option -->
                                                        {% if has_role('Global Admin') or has_role('Pub League Admin') %}
                                                        <div class="dropdown-divider"></div>
                                                        <h6 class="dropdown-header">Sub Management</h6>
                                                        <a class="dropdown-item" href="{{ url_for('admin.manage_subs') }}" target="_blank">
                                                            <i class="ti ti-user-plus me-1"></i> Manage Substitutes
                                                        </a>
                                                        {% endif %}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="home-team" role="tabpanel" aria-labelledby="home-tab" data-tab-pane>
                            <!-- Mobile Card Layout for Home Team -->
                            <div class="rsvp-mobile-list">
                                {% for rsvp in home_team_responses %}
                                <div class="rsvp-mobile-card" data-player-id="{{ rsvp['player'].id }}">
                                    <div class="rsvp-card-main">
                                        <div class="player-info-mobile">
                                            <div class="avatar avatar-sm me-3 rsvp-avatar">
                                                {% if rsvp['player'].profile_picture_url %}
                                                    <img src="{{ rsvp['player'].profile_picture_url }}" alt="Avatar" class="rounded-circle rsvp-avatar-image">
                                                {% else %}
                                                    <div class="avatar-initial rounded-circle bg-label-secondary">
                                                        {{ rsvp['player'].name[:1]|upper }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="rsvp-player-container">
                                                <div class="player-name-mobile">{{ rsvp['player'].name }}</div>
                                                <div class="player-meta-mobile">
                                                    <span class="badge bg-primary" data-badge>{{ rsvp['team'].name }}</span>
                                                    {% if rsvp['is_temp_sub'] %}
                                                    <span class="badge bg-label-info" data-badge>
                                                        <i class="ti ti-replace"></i> SUB
                                                    </span>
                                                    {% endif %}
                                                    {% if rsvp['discord_synced'] %}
                                                    <span class="badge bg-label-info" data-badge>
                                                        <i class="ti ti-brand-discord"></i>
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="rsvp-actions-wrapper">
                                            <span class="response-badge-mobile {{ 'bg-success text-white' if rsvp['response'] == 'yes' else 'bg-danger text-white' if rsvp['response'] == 'no' else 'bg-warning text-white' if rsvp['response'] == 'maybe' else 'bg-secondary text-white' }}" data-badge>
                                                <i class="ti ti-{{ 'check' if rsvp['response'] == 'yes' else 'x' if rsvp['response'] == 'no' else 'help' if rsvp['response'] == 'maybe' else 'minus' }}"></i>
                                                {{ rsvp['response']|capitalize }}
                                            </span>
                                            <button class="expand-button js-toggle-card-expansion" data-action="toggle-card-expansion" aria-label="Expand"><i class="ti ti-chevron-down"></i></button>
                                        </div>
                                    </div>
                                    
                                    <div class="rsvp-card-body">
                                        <!-- Response Time -->
                                        <div class="rsvp-response-time-box">
                                            <small class="text-muted d-block rsvp-response-time-label">Response Time</small>
                                            {% if rsvp['responded_at'] %}
                                                <div class="rsvp-response-time-value">{{ rsvp['responded_at'].strftime('%b %d, %Y at %I:%M %p') }}</div>
                                            {% else %}
                                                <div class="rsvp-no-response-text">No response yet</div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Contact Actions -->
                                        {% set has_sms = rsvp['player'].phone and rsvp['player'].user and rsvp['player'].user.sms_notifications %}
                                        {% set has_discord = rsvp['player'].discord_id and rsvp['player'].user and rsvp['player'].user.discord_notifications %}
                                        {% set has_email = rsvp['player'].email %}
                                        
                                        {% if has_sms or has_discord or has_email %}
                                        <div class="contact-actions-mobile">
                                            {% if has_sms %}
                                            <button class="contact-action-btn bg-primary text-white" data-action="rsvp-request-sms" data-player-id="{{ rsvp['player'].id }}" data-player-name="{{ rsvp['player'].name }}" data-phone="{{ rsvp['player'].phone }}">
                                                <i class="ti ti-message"></i> SMS
                                            </button>
                                            {% endif %}
                                            
                                            {% if has_discord %}
                                            <button class="contact-action-btn bg-indigo text-white" data-action="rsvp-request-discord-dm" data-player-id="{{ rsvp['player'].id }}" data-player-name="{{ rsvp['player'].name }}" data-discord-id="{{ rsvp['player'].discord_id }}">
                                                <i class="ti ti-brand-discord"></i> Discord
                                            </button>
                                            {% endif %}
                                            
                                            {% if has_email %}
                                            <a href="mailto:{{ rsvp['player'].email }}" class="contact-action-btn bg-info text-white">
                                                <i class="ti ti-mail"></i> Email
                                            </a>
                                            {% endif %}
                                            
                                            <a href="{{ url_for('players.player_profile', player_id=rsvp['player'].id) }}" class="contact-action-btn bg-secondary text-white">
                                                <i class="ti ti-user"></i> Profile
                                            </a>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- RSVP Actions -->
                                        <div class="rsvp-actions-mobile">
                                            <button class="rsvp-action-btn bg-success text-white" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="yes">
                                                <i class="ti ti-check"></i> Set Yes
                                            </button>
                                            <button class="rsvp-action-btn bg-danger text-white" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="no">
                                                <i class="ti ti-x"></i> Set No
                                            </button>
                                            <button class="rsvp-action-btn bg-warning text-white" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="maybe">
                                                <i class="ti ti-help"></i> Maybe
                                            </button>
                                            <button class="rsvp-action-btn bg-secondary text-white" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="no_response">
                                                <i class="ti ti-trash"></i> Clear
                                            </button>
                                        </div>
                                        
                                        <!-- Sub Management (if applicable) -->
                                        {% if rsvp['is_temp_sub'] %}
                                        <div class="rsvp-sub-form">
                                            <form action="{{ url_for('admin.remove_sub', assignment_id=rsvp.get('assignment_id', 0)) }}" method="POST" class="rsvp-sub-form-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <input type="hidden" name="redirect_to" value="rsvp_status">
                                                <button type="submit" class="contact-action-btn bg-danger text-white w-100">
                                                    <i class="ti ti-user-minus"></i> Remove Sub Assignment
                                                </button>
                                            </form>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Desktop Table Layout for Home Team -->
                            <div class="c-table-wrapper" data-table-responsive>
                                <table id="homeTeamTable" class="c-table c-table--striped c-table--hoverable border-top" data-mobile-table data-table-type="rsvp" data-table>
                                    <thead scope="col">
                                        <tr>
                                            <th scope="col">Player</th>
                                            <th scope="col">Response</th>
                                            <th scope="col">Responded At</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rsvp in home_team_responses %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar avatar-sm me-2 rsvp-avatar">
                                                        {% if rsvp['player'].profile_picture_url %}
                                                            <img src="{{ rsvp['player'].profile_picture_url }}" alt="Avatar" class="rounded-circle rsvp-avatar-image">
                                                        {% else %}
                                                            <div class="avatar-initial rounded-circle bg-label-secondary">
                                                                {{ rsvp['player'].name[:1]|upper }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="d-flex flex-column">
                                                        <div class="d-flex align-items-center">
                                                            <span class="fw-semibold">{{ rsvp['player'].name }}</span>
                                                            {% if rsvp['is_temp_sub'] %}
                                                            <span class="badge bg-label-info ms-2" data-bs-toggle="tooltip" title="Temporary substitute assigned by {{ rsvp['assigned_by'] }}" data-badge>
                                                                <i class="ti ti-replace me-1"></i>SUB
                                                            </span>
                                                            {% endif %}
                                                        </div>
                                                        <small class="text-muted">
                                                            {% if rsvp['player'].phone %}
                                                                <i class="ti ti-phone-call me-1"></i>{{ rsvp['player'].phone }}
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge {{ 'bg-success' if rsvp['response'] == 'yes' else 'bg-danger' if rsvp['response'] == 'no' else 'bg-warning' if rsvp['response'] == 'maybe' else 'bg-secondary' }}" data-badge>
                                                    {{ rsvp['response']|capitalize }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if rsvp['responded_at'] %}
                                                    <div class="d-flex flex-column">
                                                        <span>{{ rsvp['responded_at'].strftime('%Y-%m-%d') }}</span>
                                                        <small class="text-muted">{{ rsvp['responded_at'].strftime('%I:%M %p') }}</small>
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">No response</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="dropdown">
                                                    <button type="button" class="c-btn c-btn--sm c-btn--icon-only c-btn--outline-secondary dropdown-toggle hide-arrow" data-bs-toggle="dropdown" data-dropdown-toggle aria-label="More options"><i class="ti ti-dots-vertical"></i></button>
                                                    <div class="dropdown-menu dropdown-menu-end" data-dropdown-menu>
                                                        <a class="dropdown-item" href="{{ url_for('players.player_profile', player_id=rsvp['player'].id) }}">
                                                            <i class="ti ti-user me-1"></i> View Profile
                                                        </a>
                                                        
                                                        <!-- Contact Options -->
                                                        {% set has_sms = rsvp['player'].phone and rsvp['player'].user and rsvp['player'].user.sms_notifications %}
                                                        {% set has_discord = rsvp['player'].discord_id and rsvp['player'].user and rsvp['player'].user.discord_notifications %}
                                                        {% set has_email = rsvp['player'].email %}
                                                        
                                                        {% if has_sms or has_discord or has_email %}
                                                        <div class="dropdown-divider"></div>
                                                        <h6 class="dropdown-header">Contact Options</h6>
                                                        
                                                        {% if has_sms %}
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-request-sms" data-player-id="{{ rsvp['player'].id }}" data-player-name="{{ rsvp['player'].name }}" data-phone="{{ rsvp['player'].phone }}">
                                                            <i class="ti ti-message me-1"></i> Send SMS
                                                        </a>
                                                        {% endif %}

                                                        {% if has_discord %}
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-request-discord-dm" data-player-id="{{ rsvp['player'].id }}" data-player-name="{{ rsvp['player'].name }}" data-discord-id="{{ rsvp['player'].discord_id }}">
                                                            <i class="ti ti-brand-discord me-1"></i> Send Discord DM
                                                        </a>
                                                        {% endif %}
                                                        
                                                        {% if has_email %}
                                                        <a class="dropdown-item" href="mailto:{{ rsvp['player'].email }}">
                                                            <i class="ti ti-mail me-1"></i> Send Email
                                                        </a>
                                                        {% endif %}
                                                        {% endif %}
                                                        
                                                        <!-- RSVP Options -->
                                                        <div class="dropdown-divider"></div>
                                                        <h6 class="dropdown-header">Update RSVP</h6>
                                                        
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="yes">
                                                            <i class="ti ti-check text-success me-1"></i> Set as Yes
                                                        </a>
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="maybe">
                                                            <i class="ti ti-help text-warning me-1"></i> Set as Maybe
                                                        </a>
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="no">
                                                            <i class="ti ti-x text-danger me-1"></i> Set as No
                                                        </a>
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="no_response">
                                                            <i class="ti ti-trash me-1"></i> Clear Response
                                                        </a>
                                                        
                                                        {% if rsvp['is_temp_sub'] %}
                                                        <!-- Sub Management Options -->
                                                        <div class="dropdown-divider"></div>
                                                        <h6 class="dropdown-header">Sub Management</h6>
                                                        <form action="{{ url_for('admin.remove_sub', assignment_id=rsvp.get('assignment_id', 0)) }}" method="POST" class="d-inline">
                                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                            <input type="hidden" name="redirect_to" value="rsvp_status">
                                                            <button type="submit" class="dropdown-item text-danger">
                                                                <i class="ti ti-user-minus me-1"></i> Remove Sub Assignment
                                                            </button>
                                                        </form>
                                                        {% else %}
                                                        <!-- Add as Sub Option -->
                                                        {% if has_role('Global Admin') or has_role('Pub League Admin') %}
                                                        <div class="dropdown-divider"></div>
                                                        <h6 class="dropdown-header">Sub Management</h6>
                                                        <a class="dropdown-item" href="{{ url_for('admin.manage_subs') }}" target="_blank">
                                                            <i class="ti ti-user-plus me-1"></i> Manage Substitutes
                                                        </a>
                                                        {% endif %}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="away-team" role="tabpanel" aria-labelledby="away-tab" data-tab-pane>
                            <!-- Mobile Card Layout for Away Team -->
                            <div class="rsvp-mobile-list">
                                {% for rsvp in away_team_responses %}
                                <div class="rsvp-mobile-card" data-player-id="{{ rsvp['player'].id }}">
                                    <div class="rsvp-card-main">
                                        <div class="player-info-mobile">
                                            <div class="avatar avatar-sm me-3 rsvp-avatar">
                                                {% if rsvp['player'].profile_picture_url %}
                                                    <img src="{{ rsvp['player'].profile_picture_url }}" alt="Avatar" class="rounded-circle rsvp-avatar-image">
                                                {% else %}
                                                    <div class="avatar-initial rounded-circle bg-label-secondary">
                                                        {{ rsvp['player'].name[:1]|upper }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="rsvp-player-container">
                                                <div class="player-name-mobile">{{ rsvp['player'].name }}</div>
                                                <div class="player-meta-mobile">
                                                    <span class="badge bg-info" data-badge>{{ rsvp['team'].name }}</span>
                                                    {% if rsvp['is_temp_sub'] %}
                                                    <span class="badge bg-label-info" data-badge>
                                                        <i class="ti ti-replace"></i> SUB
                                                    </span>
                                                    {% endif %}
                                                    {% if rsvp['discord_synced'] %}
                                                    <span class="badge bg-label-info" data-badge>
                                                        <i class="ti ti-brand-discord"></i>
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="rsvp-actions-wrapper">
                                            <span class="response-badge-mobile {{ 'bg-success text-white' if rsvp['response'] == 'yes' else 'bg-danger text-white' if rsvp['response'] == 'no' else 'bg-warning text-white' if rsvp['response'] == 'maybe' else 'bg-secondary text-white' }}" data-badge>
                                                <i class="ti ti-{{ 'check' if rsvp['response'] == 'yes' else 'x' if rsvp['response'] == 'no' else 'help' if rsvp['response'] == 'maybe' else 'minus' }}"></i>
                                                {{ rsvp['response']|capitalize }}
                                            </span>
                                            <button class="expand-button js-toggle-card-expansion" data-action="toggle-card-expansion" aria-label="Expand"><i class="ti ti-chevron-down"></i></button>
                                        </div>
                                    </div>
                                    
                                    <div class="rsvp-card-body">
                                        <!-- Response Time -->
                                        <div class="rsvp-response-time-box">
                                            <small class="text-muted d-block rsvp-response-time-label">Response Time</small>
                                            {% if rsvp['responded_at'] %}
                                                <div class="rsvp-response-time-value">{{ rsvp['responded_at'].strftime('%b %d, %Y at %I:%M %p') }}</div>
                                            {% else %}
                                                <div class="rsvp-no-response-text">No response yet</div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Contact Actions -->
                                        {% set has_sms = rsvp['player'].phone and rsvp['player'].user and rsvp['player'].user.sms_notifications %}
                                        {% set has_discord = rsvp['player'].discord_id and rsvp['player'].user and rsvp['player'].user.discord_notifications %}
                                        {% set has_email = rsvp['player'].email %}
                                        
                                        {% if has_sms or has_discord or has_email %}
                                        <div class="contact-actions-mobile">
                                            {% if has_sms %}
                                            <button class="contact-action-btn bg-primary text-white" data-action="rsvp-request-sms" data-player-id="{{ rsvp['player'].id }}" data-player-name="{{ rsvp['player'].name }}" data-phone="{{ rsvp['player'].phone }}">
                                                <i class="ti ti-message"></i> SMS
                                            </button>
                                            {% endif %}
                                            
                                            {% if has_discord %}
                                            <button class="contact-action-btn bg-indigo text-white" data-action="rsvp-request-discord-dm" data-player-id="{{ rsvp['player'].id }}" data-player-name="{{ rsvp['player'].name }}" data-discord-id="{{ rsvp['player'].discord_id }}">
                                                <i class="ti ti-brand-discord"></i> Discord
                                            </button>
                                            {% endif %}
                                            
                                            {% if has_email %}
                                            <a href="mailto:{{ rsvp['player'].email }}" class="contact-action-btn bg-info text-white">
                                                <i class="ti ti-mail"></i> Email
                                            </a>
                                            {% endif %}
                                            
                                            <a href="{{ url_for('players.player_profile', player_id=rsvp['player'].id) }}" class="contact-action-btn bg-secondary text-white">
                                                <i class="ti ti-user"></i> Profile
                                            </a>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- RSVP Actions -->
                                        <div class="rsvp-actions-mobile">
                                            <button class="rsvp-action-btn bg-success text-white" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="yes">
                                                <i class="ti ti-check"></i> Set Yes
                                            </button>
                                            <button class="rsvp-action-btn bg-danger text-white" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="no">
                                                <i class="ti ti-x"></i> Set No
                                            </button>
                                            <button class="rsvp-action-btn bg-warning text-white" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="maybe">
                                                <i class="ti ti-help"></i> Maybe
                                            </button>
                                            <button class="rsvp-action-btn bg-secondary text-white" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="no_response">
                                                <i class="ti ti-trash"></i> Clear
                                            </button>
                                        </div>
                                        
                                        <!-- Sub Management (if applicable) -->
                                        {% if rsvp['is_temp_sub'] %}
                                        <div class="rsvp-sub-form">
                                            <form action="{{ url_for('admin.remove_sub', assignment_id=rsvp.get('assignment_id', 0)) }}" method="POST" class="rsvp-sub-form-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <input type="hidden" name="redirect_to" value="rsvp_status">
                                                <button type="submit" class="contact-action-btn bg-danger text-white w-100">
                                                    <i class="ti ti-user-minus"></i> Remove Sub Assignment
                                                </button>
                                            </form>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Desktop Table Layout for Away Team -->
                            <div class="c-table-wrapper" data-table-responsive>
                                <table id="awayTeamTable" class="c-table c-table--striped c-table--hoverable border-top" data-mobile-table data-table-type="rsvp" data-table>
                                    <thead scope="col">
                                        <tr>
                                            <th scope="col">Player</th>
                                            <th scope="col">Response</th>
                                            <th scope="col">Responded At</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rsvp in away_team_responses %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar avatar-sm me-2 rsvp-avatar">
                                                        {% if rsvp['player'].profile_picture_url %}
                                                            <img src="{{ rsvp['player'].profile_picture_url }}" alt="Avatar" class="rounded-circle rsvp-avatar-image">
                                                        {% else %}
                                                            <div class="avatar-initial rounded-circle bg-label-secondary">
                                                                {{ rsvp['player'].name[:1]|upper }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="d-flex flex-column">
                                                        <div class="d-flex align-items-center">
                                                            <span class="fw-semibold">{{ rsvp['player'].name }}</span>
                                                            {% if rsvp['is_temp_sub'] %}
                                                            <span class="badge bg-label-info ms-2" data-bs-toggle="tooltip" title="Temporary substitute assigned by {{ rsvp['assigned_by'] }}" data-badge>
                                                                <i class="ti ti-replace me-1"></i>SUB
                                                            </span>
                                                            {% endif %}
                                                        </div>
                                                        <small class="text-muted">
                                                            {% if rsvp['player'].phone %}
                                                                <i class="ti ti-phone-call me-1"></i>{{ rsvp['player'].phone }}
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge {{ 'bg-success' if rsvp['response'] == 'yes' else 'bg-danger' if rsvp['response'] == 'no' else 'bg-warning' if rsvp['response'] == 'maybe' else 'bg-secondary' }}" data-badge>
                                                    {{ rsvp['response']|capitalize }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if rsvp['responded_at'] %}
                                                    <div class="d-flex flex-column">
                                                        <span>{{ rsvp['responded_at'].strftime('%Y-%m-%d') }}</span>
                                                        <small class="text-muted">{{ rsvp['responded_at'].strftime('%I:%M %p') }}</small>
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">No response</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="dropdown">
                                                    <button type="button" class="c-btn c-btn--sm c-btn--icon-only c-btn--outline-secondary dropdown-toggle hide-arrow" data-bs-toggle="dropdown" data-dropdown-toggle aria-label="More options"><i class="ti ti-dots-vertical"></i></button>
                                                    <div class="dropdown-menu dropdown-menu-end" data-dropdown-menu>
                                                        <a class="dropdown-item" href="{{ url_for('players.player_profile', player_id=rsvp['player'].id) }}">
                                                            <i class="ti ti-user me-1"></i> View Profile
                                                        </a>
                                                        
                                                        <!-- Contact Options -->
                                                        {% set has_sms = rsvp['player'].phone and rsvp['player'].user and rsvp['player'].user.sms_notifications %}
                                                        {% set has_discord = rsvp['player'].discord_id and rsvp['player'].user and rsvp['player'].user.discord_notifications %}
                                                        {% set has_email = rsvp['player'].email %}
                                                        
                                                        {% if has_sms or has_discord or has_email %}
                                                        <div class="dropdown-divider"></div>
                                                        <h6 class="dropdown-header">Contact Options</h6>
                                                        
                                                        {% if has_sms %}
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-request-sms" data-player-id="{{ rsvp['player'].id }}" data-player-name="{{ rsvp['player'].name }}" data-phone="{{ rsvp['player'].phone }}">
                                                            <i class="ti ti-message me-1"></i> Send SMS
                                                        </a>
                                                        {% endif %}

                                                        {% if has_discord %}
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-request-discord-dm" data-player-id="{{ rsvp['player'].id }}" data-player-name="{{ rsvp['player'].name }}" data-discord-id="{{ rsvp['player'].discord_id }}">
                                                            <i class="ti ti-brand-discord me-1"></i> Send Discord DM
                                                        </a>
                                                        {% endif %}
                                                        
                                                        {% if has_email %}
                                                        <a class="dropdown-item" href="mailto:{{ rsvp['player'].email }}">
                                                            <i class="ti ti-mail me-1"></i> Send Email
                                                        </a>
                                                        {% endif %}
                                                        {% endif %}
                                                        
                                                        <!-- RSVP Options -->
                                                        <div class="dropdown-divider"></div>
                                                        <h6 class="dropdown-header">Update RSVP</h6>
                                                        
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="yes">
                                                            <i class="ti ti-check text-success me-1"></i> Set as Yes
                                                        </a>
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="maybe">
                                                            <i class="ti ti-help text-warning me-1"></i> Set as Maybe
                                                        </a>
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="no">
                                                            <i class="ti ti-x text-danger me-1"></i> Set as No
                                                        </a>
                                                        <a class="dropdown-item" href="javascript:void(0);" data-action="rsvp-update-status" data-player-id="{{ rsvp['player'].id }}" data-match-id="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}" data-response="no_response">
                                                            <i class="ti ti-trash me-1"></i> Clear Response
                                                        </a>
                                                        
                                                        {% if rsvp['is_temp_sub'] %}
                                                        <!-- Sub Management Options -->
                                                        <div class="dropdown-divider"></div>
                                                        <h6 class="dropdown-header">Sub Management</h6>
                                                        <form action="{{ url_for('admin.remove_sub', assignment_id=rsvp.get('assignment_id', 0)) }}" method="POST" class="d-inline">
                                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                            <input type="hidden" name="redirect_to" value="rsvp_status">
                                                            <button type="submit" class="dropdown-item text-danger">
                                                                <i class="ti ti-user-minus me-1"></i> Remove Sub Assignment
                                                            </button>
                                                        </form>
                                                        {% else %}
                                                        <!-- Add as Sub Option -->
                                                        {% if has_role('Global Admin') or has_role('Pub League Admin') %}
                                                        <div class="dropdown-divider"></div>
                                                        <h6 class="dropdown-header">Sub Management</h6>
                                                        <a class="dropdown-item" href="{{ url_for('admin.manage_subs') }}" target="_blank">
                                                            <i class="ti ti-user-plus me-1"></i> Manage Substitutes
                                                        </a>
                                                        {% endif %}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
{{ super() }}
<!-- SMS Modal -->
<div class="modal c-modal fade" data-modal id="sendSmsModal" tabindex="-1" aria-labelledby="sendSmsModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content shadow-lg border-0" data-modal-content>
            <div class="modal-header c-modal__header bg-primary text-white" data-modal-header>
                <h5 class="modal-title c-modal__title" id="sendSmsModalLabel">
                    <i class="ti ti-message-circle me-2"></i>Text Message
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <form id="sendSmsForm" action="{{ url_for('admin.send_custom_sms') }}" method="POST">
                <div class="modal-body c-modal__body p-4" data-modal-body>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="player_id" id="smsPlayerId">
                    <input type="hidden" name="match_id" value="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}">
                    <input type="hidden" name="phone" id="smsPlayerPhone">
                    
                    <!-- Player Info -->
                    <div class="d-flex align-items-center mb-4 pb-2 border-bottom">
                        <div class="avatar avatar-md me-3">
                            <div class="avatar-initial rounded-circle bg-label-primary">
                                <i class="ti ti-user"></i>
                            </div>
                        </div>
                        <div>
                            <h6 class="mb-0">To: <span id="smsPlayerName" class="fw-bold"></span></h6>
                            <small class="text-muted" id="smsPlayerPhoneDisplay"></small>
                        </div>
                    </div>
                    
                    <!-- Match Info -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center p-2 bg-light rounded mb-3">
                            <i class="ti ti-calendar-event me-2 text-primary"></i>
                            <span>{% if is_ecs_fc_match %}{{ ecs_match.team.name }} vs {{ ecs_match.opponent_name }} ({{ ecs_match.match_date.strftime('%a, %b %d') }} at {{ ecs_match.match_time.strftime('%I:%M %p') }}){% else %}{{ match.home_team.name }} vs {{ match.away_team.name }} ({{ match.date.strftime('%a, %b %d') }} at {{ match.time.strftime('%I:%M %p') }}){% endif %}</span>
                        </div>
                    </div>
                    
                    <!-- Message Box -->
                    <div class="mb-3">
                        <label for="smsMessage" class="form-label fw-semibold">Message</label>
                        <textarea class="form-control border-primary" id="smsMessage" name="message" rows="5" placeholder="Type your message here..." required data-form-control></textarea>
                        <div class="form-text mt-2">
                            <i class="ti ti-info-circle me-1"></i> This message will be sent as an SMS directly to the player's phone.
                        </div>
                    </div>
                    
                    <!-- Character Counter -->
                    <div class="text-end">
                        <small class="text-muted"><span id="smsCharCount">0</span>/160 characters</small>
                    </div>
                </div>
                <div class="modal-footer c-modal__footer bg-light" data-modal-footer>
                    <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>
                        <i class="ti ti-x me-1"></i>Cancel
                    </button>
                    <button type="submit" class="c-btn c-btn--primary">
                        <i class="ti ti-send me-1"></i>Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Discord DM Modal -->
<div class="modal c-modal fade" data-modal id="sendDiscordDmModal" tabindex="-1" aria-labelledby="sendDiscordDmModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content shadow-lg border-0" data-modal-content>
            <div class="modal-header c-modal__header bg-indigo text-white" data-modal-header>
                <h5 class="modal-title c-modal__title" id="sendDiscordDmModalLabel">
                    <i class="ti ti-brand-discord me-2"></i>Discord Message
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <form id="sendDiscordDmForm" action="{{ url_for('admin.send_discord_dm') }}" method="POST">
                <div class="modal-body c-modal__body p-4" data-modal-body>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="player_id" id="discordPlayerId">
                    <input type="hidden" name="match_id" value="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}">
                    <input type="hidden" name="discord_id" id="discordId">
                    
                    <!-- Player Info -->
                    <div class="d-flex align-items-center mb-4 pb-2 border-bottom">
                        <div class="avatar avatar-md me-3">
                            <div class="avatar-initial rounded-circle bg-label-indigo">
                                <i class="ti ti-user"></i>
                            </div>
                        </div>
                        <div>
                            <h6 class="mb-0">To: <span id="discordPlayerName" class="fw-bold"></span></h6>
                            <small class="text-muted">Discord Direct Message</small>
                        </div>
                    </div>
                    
                    <!-- Match Info -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center p-2 bg-light rounded mb-3">
                            <i class="ti ti-calendar-event me-2 text-indigo"></i>
                            <span>{% if is_ecs_fc_match %}{{ ecs_match.team.name }} vs {{ ecs_match.opponent_name }} ({{ ecs_match.match_date.strftime('%a, %b %d') }} at {{ ecs_match.match_time.strftime('%I:%M %p') }}){% else %}{{ match.home_team.name }} vs {{ match.away_team.name }} ({{ match.date.strftime('%a, %b %d') }} at {{ match.time.strftime('%I:%M %p') }}){% endif %}</span>
                        </div>
                    </div>
                    
                    <!-- Message Box -->
                    <div class="mb-3">
                        <label for="discordMessage" class="form-label fw-semibold">Message</label>
                        <textarea class="form-control border-indigo" id="discordMessage" name="message" rows="5" placeholder="Type your message here..." required data-form-control></textarea>
                        <div class="form-text mt-2">
                            <i class="ti ti-info-circle me-1"></i> This message will be sent as a Discord Direct Message through the bot.
                        </div>
                    </div>
                    
                    <!-- Character Counter -->
                    <div class="text-end">
                        <small class="text-muted"><span id="discordCharCount">0</span>/2000 characters</small>
                    </div>
                </div>
                <div class="modal-footer c-modal__footer bg-light" data-modal-footer>
                    <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>
                        <i class="ti ti-x me-1"></i>Cancel
                    </button>
                    <button type="submit" class="c-btn btn-indigo">
                        <i class="ti ti-send me-1"></i>Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assign Sub Modal -->
<div class="modal c-modal fade" data-modal id="assignSubModalRSVP" tabindex="-1" aria-labelledby="assignSubModalRSVPLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered modal-lg c-modal__dialog--lg" data-modal-dialog>
        <div class="modal-content c-modal__content shadow-lg border-0" data-modal-content>
            <div class="modal-header c-modal__header bg-success text-white" data-modal-header>
                <h5 class="modal-title c-modal__title" id="assignSubModalRSVPLabel">
                    <i class="ti ti-user-plus me-2"></i>Assign Substitute
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <form id="assignSubFormRSVP" action="{% if is_ecs_fc_match and ecs_sub_request %}{{ url_for('admin.ecs_fc_subs.assign_substitute', request_id=ecs_sub_request.id) }}{% else %}{{ url_for('admin.assign_sub') }}{% endif %}" method="POST">
                <div class="modal-body c-modal__body p-4" data-modal-body>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="match_id" value="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}">
                    <input type="hidden" name="redirect_to" value="rsvp_status">
                    
                    <div class="row mb-4">
                        <!-- Match Info -->
                        <div class="col-12 mb-4">
                            <div class="alert alert-info" data-alert>
                                <div class="d-flex align-items-center">
                                    <i class="ti ti-info-circle me-2 fs-3"></i>
                                    <div>
                                        <h5 class="alert-heading mb-1">Match Information</h5>
                                        <p class="mb-0">{% if is_ecs_fc_match %}{{ ecs_match.team.name }} vs {{ ecs_match.opponent_name }} - {{ ecs_match.match_date.strftime('%a, %b %d') }} at {{ ecs_match.match_time.strftime('%I:%M %p') }}{% else %}{{ match.home_team.name }} vs {{ match.away_team.name }} - {{ match.date.strftime('%a, %b %d') }} at {{ match.time.strftime('%I:%M %p') }}{% endif %}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="subPlayerRSVP" class="form-label fw-semibold">Substitute Player</label>
                            <select class="form-select" id="subPlayerRSVP" name="player_id" required data-form-select>
                                <option value="" selected disabled>Select a substitute player...</option>
                                <!-- AJAX will populate this -->
                                <option value="loading" disabled>Loading available substitutes...</option>
                            </select>
                            <div class="form-text mt-2">
                                <i class="ti ti-info-circle me-1"></i> Only players marked as substitutes will appear here.
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="subTeamRSVP" class="form-label fw-semibold">Team</label>
                            <select class="form-select" id="subTeamRSVP" name="team_id" required data-form-select>
                                <option value="" selected disabled>Select a team for this match...</option>
                                {% if is_ecs_fc_match %}
                                <option value="{{ ecs_match.team_id }}">{{ ecs_match.team.name }}</option>
                                {% else %}
                                <option value="{{ match.home_team_id }}">{{ match.home_team.name }}</option>
                                <option value="{{ match.away_team_id }}">{{ match.away_team.name }}</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer c-modal__footer bg-light" data-modal-footer>
                    <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>
                        <i class="ti ti-x me-1"></i>Cancel
                    </button>
                    <button type="submit" class="c-btn c-btn--success">
                        <i class="ti ti-user-plus me-1"></i>Assign Substitute
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sub List Modal -->
<div class="modal c-modal fade" data-modal id="viewSubsModal" tabindex="-1" aria-labelledby="viewSubsModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered modal-lg c-modal__dialog--lg" data-modal-dialog>
        <div class="modal-content c-modal__content shadow-lg border-0" data-modal-content>
            <div class="modal-header c-modal__header bg-primary text-white" data-modal-header>
                <h5 class="modal-title c-modal__title" id="viewSubsModalLabel">
                    <i class="ti ti-users me-2"></i>Available Substitutes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <div class="modal-body c-modal__body p-4" data-modal-body>
                <div id="subListContainer" class="c-table-wrapper" data-table-responsive>
                    <table class="c-table c-table--striped" data-mobile-table data-table-type="rsvp" data-table>
                        <thead scope="col">
                            <tr>
                                <th scope="col">Player</th>
                                <th scope="col">Primary Team</th>
                                <th scope="col">Contact</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subListTableBody">
                            <!-- AJAX will populate this -->
                            <tr>
                                <td colspan="4" class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status" data-spinner>
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading available substitutes...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer c-modal__footer bg-light" data-modal-footer>
                <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>
                    <i class="ti ti-x me-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Request Sub Modal -->
{% if has_role('Pub League Coach') or has_role('Global Admin') or has_role('Pub League Admin') or has_role('ECS FC Coach') %}
<div class="modal c-modal fade" data-modal id="requestSubModal" tabindex="-1" aria-labelledby="requestSubModalLabel" aria-hidden="true" 
    {% if is_ecs_fc_match %}
    data-team-id="{{ ecs_match.team_id }}" data-team-name="{{ ecs_match.team.name }}" data-league-type="ECS FC"
    {% else %}
    data-home-team-id="{{ match.home_team_id }}" data-away-team-id="{{ match.away_team_id }}"
    data-home-team-name="{{ match.home_team.name }}" data-away-team-name="{{ match.away_team.name }}" data-league-type="Classic"
    {% endif %} aria-labelledby="requestSubModalLabel">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered modal-lg c-modal__dialog--lg" data-modal-dialog>
        <div class="modal-content c-modal__content shadow-lg border-0" data-modal-content>
            <div class="modal-header c-modal__header bg-warning text-white" data-modal-header>
                <h5 class="modal-title c-modal__title" id="requestSubModalLabel">
                    <i class="ti ti-hand-stop me-2"></i>Substitute Request Management
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <div class="modal-body c-modal__body p-0" data-modal-body>
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs" id="subRequestTabs" role="tablist" data-tabs>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="existing-requests-tab" data-bs-toggle="tab" data-bs-target="#existing-requests" type="button" role="tab">
                            <i class="ti ti-list me-1"></i>Current Requests
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="new-request-tab" data-bs-toggle="tab" data-bs-target="#new-request" type="button" role="tab">
                            <i class="ti ti-plus me-1"></i>Create New Request
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="subRequestTabContent">
                    <!-- Existing Requests Tab -->
                    <div class="tab-pane fade show active" id="existing-requests" role="tabpanel" data-tab-pane>
                        <div class="p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">
                                    <i class="ti ti-messages me-2"></i>Recent Substitute Requests for this Match
                                </h6>
                                <button class="c-btn c-btn--sm c-btn--outline-primary" id="refreshMatchRequestsBtn" aria-label="Refresh"><i class="ti ti-refresh"></i></button>
                            </div>
                            
                            <div class="c-table-wrapper" data-table-responsive>
                                <table class="c-table c-table--compact" data-mobile-table data-table-type="rsvp" data-table>
                                    <thead scope="col">
                                        <tr>
                                            <th scope="col">Created</th>
                                            <th scope="col">Team</th>
                                            <th scope="col">Status</th>
                                            <th scope="col">Responses</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="matchSubstituteRequestsTable">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-3">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Request Tab -->
                    <div class="tab-pane fade" id="new-request" role="tabpanel" data-tab-pane>
                        <form id="requestSubForm" action="{{ url_for('admin.request_sub') }}" method="POST">
                            <div class="p-4">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="match_id" value="{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}">
                                
                                <div class="mb-4">
                                    <div class="alert alert-info" data-alert>
                                        <div class="d-flex align-items-center">
                                            <i class="ti ti-info-circle me-2 fs-3"></i>
                                            <div>
                                                <h5 class="alert-heading mb-1">Match Information</h5>
                                                <p class="mb-0">{% if is_ecs_fc_match %}{{ ecs_match.team.name }} vs {{ ecs_match.opponent_name }} - {{ ecs_match.match_date.strftime('%a, %b %d') }} at {{ ecs_match.match_time.strftime('%I:%M %p') }}{% else %}{{ match.home_team.name }} vs {{ match.away_team.name }} - {{ match.date.strftime('%a, %b %d') }} at {{ match.time.strftime('%I:%M %p') }}{% endif %}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="team_id" class="form-label fw-semibold">Team Needing Substitute</label>
                                    <select class="form-select" id="team_id" name="team_id" required data-form-select>
                                        <option value="" selected disabled>Select team...</option>
                                        {% if is_ecs_fc_match %}
                                            <option value="{{ ecs_match.team_id }}">{{ ecs_match.team.name }}</option>
                                        {% else %}
                                            {% if has_role('Global Admin') or has_role('Pub League Admin') %}
                                                <option value="{{ match.home_team_id }}">{{ match.home_team.name }}</option>
                                                <option value="{{ match.away_team_id }}">{{ match.away_team.name }}</option>
                                            {% elif has_role('Pub League Coach') and safe_current_user.player %}
                                                <!-- Simpler coach check: Just show teams in this match for coaches -->
                                                {% for team in safe_current_user.player.teams %}
                                                    {% if team.id == match.home_team_id %}
                                                        <option value="{{ match.home_team_id }}">{{ match.home_team.name }}</option>
                                                    {% endif %}
                                                    {% if team.id == match.away_team_id %}
                                                        <option value="{{ match.away_team_id }}">{{ match.away_team.name }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        {% endif %}
                                    </select>
                                </div>
                                
                                {% if is_ecs_fc_match %}
                                <!-- ECS FC Advanced System -->
                                <div class="mb-3">
                                    <label for="substitutes_needed" class="form-label fw-semibold">Number of Substitutes Needed</label>
                                    <select class="form-select js-substitute-slots" id="substitutes_needed" name="substitutes_needed" data-action="update-substitute-slots" data-form-select>
                                        <option value="1" selected>1 substitute</option>
                                        <option value="2">2 substitutes</option>
                                        <option value="3">3 substitutes</option>
                                        <option value="4">4 substitutes</option>
                                        <option value="5">5 substitutes</option>
                                    </select>
                                    <div class="form-text">How many substitutes do you need for this match?</div>
                                </div>
                                
                                <!-- Substitute Slots Section -->
                                <div id="substitute-slots-section" class="mb-3">
                                    <label class="form-label fw-semibold">Substitute Requirements</label>
                                    <div class="form-text mb-2">Specify position and gender for each substitute needed</div>
                                    
                                    <!-- Header row -->
                                    <div class="row mb-1 text-muted small">
                                        <div class="col-1">#</div>
                                        <div class="col-6">Position Needed</div>
                                        <div class="col-5">Gender Needed</div>
                                    </div>
                                    
                                    <div id="substitute-slots-container">
                                        <!-- Slots will be dynamically generated here -->
                                    </div>
                                </div>
                                {% else %}
                                <!-- Pub League Simple System -->
                                <div class="alert alert-info" data-alert>
                                    <div class="d-flex align-items-center">
                                        <i class="ti ti-info-circle me-2 fs-4"></i>
                                        <div>
                                            <h6 class="mb-1">Pub League Substitute Request</h6>
                                            <p class="mb-0">Your request will be sent to pub league administrators who will assign an approved substitute from the {{ match.home_team.league.name if match.home_team.league else 'league' }} substitute pool.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="substitutes_needed" class="form-label fw-semibold">Number of Substitutes Needed</label>
                                    <select class="form-select" id="substitutes_needed" name="substitutes_needed" data-form-select>
                                        <option value="1" selected>1 substitute</option>
                                        <option value="2">2 substitutes</option>
                                        <option value="3">3 substitutes</option>
                                        <option value="4">4 substitutes</option>
                                        <option value="5">5 substitutes</option>
                                    </select>
                                    <div class="form-text">How many substitutes do you need for this match?</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="positions_needed" class="form-label fw-semibold">Position Preferences (Optional)</label>
                                    <input type="text" class="form-control" id="positions_needed" name="positions_needed" placeholder="e.g., Goalkeeper, Defender, Midfielder" data-form-control>
                                    <div class="form-text">Let admins know if you need specific positions covered</div>
                                </div>
                                {% endif %}
                                
                                <div class="mb-3">
                                    <label for="notes" class="form-label fw-semibold">Additional Notes</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                                              placeholder="{% if is_ecs_fc_match %}e.g., Bring black shirt, meet at north parking lot, game starts at 7pm sharp...{% else %}e.g., Need sub for injured player, specific position preferences, etc.{% endif %}" data-form-control></textarea>
                                    <div class="form-text">{% if is_ecs_fc_match %}Optional: Include any special instructions for all substitutes{% else %}Optional: Include details about why you need a substitute or position preferences{% endif %}</div>
                                </div>
                            </div>
                            <div class="modal-footer c-modal__footer bg-light" data-modal-footer>
                                <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>
                                    <i class="ti ti-x me-1"></i>Cancel
                                </button>
                                <button type="submit" class="c-btn c-btn--warning">
                                    <i class="ti ti-hand-stop me-1"></i>{% if is_ecs_fc_match %}Request Substitute{% else %}Send Request to Admin{% endif %}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block custom_js %}
{{ super() }}

<!-- External dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- Custom scripts (development mode only - bundled in production) -->
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="{{ url_for('static', filename='custom_js/design-system-override.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/rsvp-unified.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/substitute-request-management.js') }}"></script>
{% endif %}

<!-- Match-specific initialization -->
<script>
// Global variables for match info
const matchId = "{% if is_ecs_fc_match %}ecs_{{ ecs_match.id }}{% else %}{{ match.id }}{% endif %}";
const isEcsFcMatch = {{ 'true' if is_ecs_fc_match else 'false' }};
const leagueType = "{% if is_ecs_fc_match %}ECS FC{% else %}Classic{% endif %}";

// Substitute Slots Management
function updateSubstituteSlots() {
    const count = parseInt(document.getElementById('substitutes_needed').value);
    const container = document.getElementById('substitute-slots-container');
    
    // Clear existing slots
    container.innerHTML = '';
    
    // Create slots for each substitute needed
    for (let i = 1; i <= count; i++) {
        const slotHtml = `
            <div class="row mb-2 substitute-slot" data-slot="${i}">
                <div class="col-1">
                    <span class="badge bg-primary" data-badge>${i}</span>
                </div>
                <div class="col-6">
                    <select class="form-select form-select-sm" name="slot_${i}_position" data-form-select>
                        <option value="">Any Position</option>
                        <option value="Goalkeeper">Goalkeeper</option>
                        <option value="Center Back">Center Back</option>
                        <option value="Left Back">Left Back</option>
                        <option value="Right Back">Right Back</option>
                        <option value="Defensive Midfielder">Defensive Midfielder</option>
                        <option value="Central Midfielder">Central Midfielder</option>
                        <option value="Attacking Midfielder">Attacking Midfielder</option>
                        <option value="Left Midfielder">Left Midfielder</option>
                        <option value="Right Midfielder">Right Midfielder</option>
                        <option value="Left Winger">Left Winger</option>
                        <option value="Right Winger">Right Winger</option>
                        <option value="Forward">Forward</option>
                        <option value="Striker">Striker</option>
                    </select>
                </div>
                <div class="col-5">
                    <select class="form-select form-select-sm" name="slot_${i}_gender" data-form-select>
                        <option value="">Any Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', slotHtml);
    }
}

// Initialize match substitute request management when page loads
$(document).ready(function() {
    // Only initialize substitute slots for ECS FC matches
    if (isEcsFcMatch) {
        updateSubstituteSlots();
    }
    
    // Load substitute requests when the modal is shown (only if modal exists)
    if ($('#requestSubModal').length > 0) {
        $('#requestSubModal').on('shown.bs.modal', function() {
            // Load existing requests when modal opens
            loadMatchSubstituteRequests(matchId);
            // Reset and initialize slots for ECS FC matches only
            if (isEcsFcMatch) {
                updateSubstituteSlots();
            }
        });
    }

    // Handle form submission (only if form exists)
    if ($('#requestSubForm').length > 0) {
        $('#requestSubForm').on('submit', function(e) {
            const form = this;
            
            // Add a small delay to let the form submit, then refresh the requests
            setTimeout(function() {
                if (!form.checkValidity || form.checkValidity()) {
                    loadMatchSubstituteRequests(matchId);
                }
            }, 2000);
        });
    }
});

// Legacy function for compatibility - removed to prevent recursion
// The loadMatchSubstituteRequests function is now handled directly by the external module

// Mobile card expansion functionality
function toggleCardExpansion(button) {
    const card = button.closest('.rsvp-mobile-card');
    const cardBody = card.querySelector('.rsvp-card-body');
    const isExpanded = cardBody.classList.contains('show');
    
    if (isExpanded) {
        cardBody.classList.remove('show');
        button.classList.remove('expanded');
    } else {
        cardBody.classList.add('show');
        button.classList.add('expanded');
    }
}

// Enhanced mobile contact handling
$(document).ready(function() {
    // Handle mobile SMS buttons
    $('.contact-action-btn.send-sms-btn').on('click', function() {
        const playerId = $(this).data('player-id');
        const playerName = $(this).data('player-name');
        const phone = $(this).data('phone');
        
        // Trigger existing SMS modal
        $('#smsPlayerId').val(playerId);
        $('#smsPlayerName').text(playerName);
        $('#smsPlayerPhone').val(phone);
        $('#smsPlayerPhoneDisplay').text(phone);
        $('#sendSmsModal').modal('show');
    });
    
    // Handle mobile Discord DM buttons
    $('.contact-action-btn[data-discord-id]').on('click', function() {
        const playerId = $(this).data('player-id');
        const playerName = $(this).data('player-name');
        const discordId = $(this).data('discord-id');
        
        // Trigger existing Discord DM modal
        $('#discordPlayerId').val(playerId);
        $('#discordPlayerName').text(playerName);
        $('#discordId').val(discordId);
        $('#sendDiscordDmModal').modal('show');
    });
});
</script>
{% endblock %}