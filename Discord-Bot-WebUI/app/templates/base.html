<!DOCTYPE html>
<html lang="en" class="light-style layout-menu-fixed layout-navbar-fixed layout-content-wide" dir="ltr" data-assets-path="{{ url_for('static', filename='assets/') }}" data-template="vertical-menu-template" data-style="{{ session.get('theme', 'light') }}" data-theme-variant="{{ session.get('theme_variant', 'modern') }}" data-content="wide">

<head>
    <meta charset="utf-8" />
    
    <!-- CRITICAL: Theme detection MUST happen before any CSS loads to prevent FOUC -->
    <script>
        (function() {
            // Get theme from localStorage or use server-provided theme as fallback
            const storedTheme = localStorage.getItem('template-style');
            const serverTheme = '{{ session.get('theme', 'light') }}';
            const finalTheme = storedTheme || serverTheme;

            // Get theme variant (modern only) from localStorage or server
            const storedVariant = localStorage.getItem('theme-variant');
            const serverVariant = '{{ session.get('theme_variant', 'modern') }}';
            const finalVariant = storedVariant || serverVariant;

            // Apply theme immediately to prevent flash
            document.documentElement.setAttribute('data-style', finalTheme);
            document.documentElement.setAttribute('data-theme-variant', finalVariant);

            // Also update the class (light-style or dark-style) for CSS selectors that use class
            document.documentElement.classList.remove('light-style', 'dark-style');
            document.documentElement.classList.add(finalTheme + '-style');

            // Add variant class for CSS selectors (modern only)
            document.documentElement.classList.remove('theme-modern');
            document.documentElement.classList.add('theme-modern');

            // Sync server session if needed
            if (storedTheme && storedTheme !== serverTheme) {
                // Theme differs from server, we'll sync it after page loads
                window._themeNeedsSync = { theme: storedTheme };
            }
            if (storedVariant && storedVariant !== serverVariant) {
                window._variantNeedsSync = { variant: storedVariant };
            }
        })();
    </script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="description" content="ECS Soccer League Management Portal" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#5E72E4" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#0D1117" media="(prefers-color-scheme: dark)" />
    <title>{% block title %}{{ title or 'ECS Soccer League' }}{% endblock %}</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='assets/img/favicon/favicon.png') }}" />
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='assets/img/favicon/apple-touch-icon.png') }}" />
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}" />

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Modern theme fonts (Archivo Black for display, Barlow for body) -->
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Barlow:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CDN removed - using local core.css (Bootstrap 5.3.3) instead -->

    <!-- Tabler Icons loaded separately due to font path issues -->
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fonts/tabler-icons.css') }}" />

    <!-- ============================================
         CSS ARCHITECTURE - Optimized Load Order (Phase 8 - Wave 2)
         ============================================

         CRITICAL: Order matters for the CSS cascade!
         Each layer builds on the previous one:
         1. Core Tokens - Design system variables (colors, spacing, typography)
         2. Admin Custom Colors - Dynamic color injection (BEFORE foundation)
         3. Foundation - Bootstrap 5 + vendor base styles
         4. Components - Reusable UI components
         5. Utilities - Helper classes and utility CSS
         6. Layout - Responsive layout and mobile styles
         7. Features - Feature-specific styles
         8. Vendor CSS - Third-party library styles (bundled + CDN)
         9. Theme Variant - Modern theme overrides (modern-v2 support coming soon)
         10. Page CSS - Page-specific styles (via blocks)
         ============================================ -->

    <!-- ============================================
         PRODUCTION vs DEVELOPMENT ASSET LOADING
         ============================================

         PRODUCTION MODE (FLASK_ENV=production):
         - Single minified CSS bundle (production.min.css)
         - Single minified JS bundle (production.min.js)
         - Optimal performance, minimal HTTP requests

         DEVELOPMENT MODE (default):
         - Individual modular bundles for easier debugging
         - 8 separate CSS bundles + vendor CSS
         - Multiple JS files with source maps
         ============================================ -->

    {% if vite_production_mode is defined and vite_production_mode() %}
    <!-- VITE PRODUCTION MODE: Modern bundled assets -->
    {{ vite_asset('css/main-entry.css') }}

    <!-- Critical navbar layout fix (prevents Bootstrap flex-wrap override) -->
    <style id="navbar-layout-fix">
    .c-navbar-modern__container {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
    }
    .c-navbar-modern__actions {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
    }
    .c-navbar-modern__actions > li {
        display: flex !important;
        flex-shrink: 0 !important;
    }
    </style>
    {% elif config.get('ASSETS_PRODUCTION_MODE') %}
    <!-- FLASK-ASSETS PRODUCTION MODE: Single Bundle -->
    {% assets "production_css" %}
        <link rel="stylesheet" href="{{ ASSET_URL }}" />
    {% endassets %}

    <!-- Critical navbar layout fix (prevents Bootstrap flex-wrap override) -->
    <style id="navbar-layout-fix">
    .c-navbar-modern__container {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
    }
    .c-navbar-modern__actions {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
    }
    .c-navbar-modern__actions > li {
        display: flex !important;
        flex-shrink: 0 !important;
    }
    </style>
    {% else %}
    <!-- DEVELOPMENT MODE: Modular Bundles -->

    <!-- 1. CORE TOKENS (CRITICAL - Load first)
         Design system foundation: CSS variables for colors, spacing, typography
         These variables are used by ALL subsequent CSS layers -->
    {% assets "core_tokens" %}
        <link rel="stylesheet" href="{{ ASSET_URL }}" />
    {% endassets %}
    {% endif %}

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- 3. FOUNDATION (Bootstrap + ECS Core)
         Base framework styles: Bootstrap 5.3.3 + vendor overrides
         Establishes grid, typography, form controls, and base components -->
    {% assets "foundation_css" %}
        <link rel="stylesheet" href="{{ ASSET_URL }}" />
    {% endassets %}

    <!-- 4. COMPONENTS (UI Building Blocks)
         Reusable interface components: cards, buttons, modals, etc.
         Built using core tokens for consistent theming -->
    {% assets "components_css" %}
        <link rel="stylesheet" href="{{ ASSET_URL }}" />
    {% endassets %}

    <!-- 5. UTILITIES (Helper Classes)
         Utility classes: spacing helpers, text utilities, display utilities
         Provides quick styling options without custom CSS -->
    {% assets "utilities_css" %}
        <link rel="stylesheet" href="{{ ASSET_URL }}" />
    {% endassets %}
    {% endif %}

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- 6. LAYOUT & MOBILE (Responsive Structure) -->
    {% assets "layout_css" %}
        <link rel="stylesheet" href="{{ ASSET_URL }}" />
    {% endassets %}
    {% assets "mobile_css" %}
        <link rel="stylesheet" href="{{ ASSET_URL }}" />
    {% endassets %}
    {% endif %}

    <!-- 8. VENDOR CDN CSS (Third-party Libraries)
         External library styles loaded via CDN
         Placed here so our theme CSS can override their defaults -->

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- DEV ONLY: These CSS files are bundled in Vite production -->
    <!-- Select2 - Enhanced select dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

    <!-- SweetAlert2 - Beautiful alert dialogs -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.14.0/sweetalert2.min.css" rel="stylesheet">

    <!-- Flatpickr - Date picker -->
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">

    <!-- DataTables - Advanced table functionality -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
    {% endif %}

    <!-- EasyMDE - Markdown editor -->
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">

    <!-- Fancybox - Image lightbox -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

    <!-- jQuery UI - Legacy UI components -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- Shepherd.js - Guided tours (bundled in production) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendor/libs/shepherd/shepherd.css') }}">

    <!-- 7. FEATURES (Feature-Specific Styles)
         Feature-specific CSS: draft, pitch view, profiles, playoffs, etc.
         Commonly used features across the application -->
    {% assets "features_css" %}
        <link rel="stylesheet" href="{{ ASSET_URL }}" />
    {% endassets %}

    <!-- 8. PAGES (Page-Specific Styles)
         Page-specific CSS including admin panel (26 admin/*.css files)
         Loaded for all pages to ensure admin panel styling works -->
    {% assets "pages_css" %}
        <link rel="stylesheet" href="{{ ASSET_URL }}" />
    {% endassets %}

    <!-- 9. THEME VARIANT (Modern Theme Only)
         Theme-specific styling with bold, contemporary design
         Uses Archivo Black for display and Barlow for body text -->
    {% assets "theme_modern" %}
        <link rel="stylesheet" href="{{ ASSET_URL }}" />
    {% endassets %}
    {% endif %}

    <!-- 8. ADMIN CUSTOM COLORS (Dynamic Overrides)
         Administrator-configured color overrides from Appearance Manager
         Loaded AFTER all themes to ensure highest cascade priority
         Uses inline <style> for dynamic values that can't be in static CSS -->
    {% if site_settings and site_settings.custom_colors %}
    {% set light = site_settings.custom_colors.get('light', {}) %}
    {% set dark = site_settings.custom_colors.get('dark', {}) %}
    <style id="admin-custom-colors">
    /* ===========================================
       ADMIN CUSTOMIZED COLORS (HIGHEST PRIORITY)
       These override ALL other CSS due to cascade position
       Generated dynamically from Appearance Manager settings
       =========================================== */

    /* Light Mode - Root Variables */
    :root {
        {% for key, value in light.items() %}
        --ecs-{{ key|replace('_', '-') }}: {{ value }};
        {% endfor %}

        /* Map to Bootstrap variables */
        {% if light.primary %}--bs-primary: {{ light.primary }};{% endif %}
        {% if light.secondary %}--bs-secondary: {{ light.secondary }};{% endif %}
        {% if light.success %}--bs-success: {{ light.success }};{% endif %}
        {% if light.warning %}--bs-warning: {{ light.warning }};{% endif %}
        {% if light.danger %}--bs-danger: {{ light.danger }};{% endif %}
        {% if light.info %}--bs-info: {{ light.info }};{% endif %}
        {% if light.text_heading %}--bs-heading-color: {{ light.text_heading }};{% endif %}
        {% if light.text_body %}--bs-body-color: {{ light.text_body }};{% endif %}
        {% if light.bg_body %}--bs-body-bg: {{ light.bg_body }};{% endif %}
    }

    /* Light Mode - Card-level variables override */
    :root .card,
    html:not([data-style="dark"]) .card {
        {% if light.text_heading %}--bs-card-title-color: {{ light.text_heading }};{% endif %}
        {% if light.text_heading %}--bs-card-cap-color: {{ light.text_heading }};{% endif %}
        {% if light.text_body %}--bs-card-color: {{ light.text_body }};{% endif %}
    }

    /* Light Mode - Direct element overrides with !important */
    html:not([data-style="dark"]) h1,
    html:not([data-style="dark"]) h2,
    html:not([data-style="dark"]) h3,
    html:not([data-style="dark"]) h4,
    html:not([data-style="dark"]) h5,
    html:not([data-style="dark"]) h6,
    html:not([data-style="dark"]) .h1,
    html:not([data-style="dark"]) .h2,
    html:not([data-style="dark"]) .h3,
    html:not([data-style="dark"]) .h4,
    html:not([data-style="dark"]) .h5,
    html:not([data-style="dark"]) .h6,
    html:not([data-style="dark"]) .card-title,
    html:not([data-style="dark"]) .ecs-card-title {
        {% if light.text_heading %}color: {{ light.text_heading }} !important;{% endif %}
    }

    html:not([data-style="dark"]) .text-primary,
    html:not([data-style="dark"]) .text-primary i,
    html:not([data-style="dark"]) i.text-primary {
        {% if light.primary %}color: {{ light.primary }} !important;{% endif %}
    }

    html:not([data-style="dark"]) .card-body,
    html:not([data-style="dark"]) .card-body p,
    html:not([data-style="dark"]) .table tbody td {
        {% if light.text_body %}color: {{ light.text_body }} !important;{% endif %}
    }

    html:not([data-style="dark"]) .text-muted {
        {% if light.text_muted %}color: {{ light.text_muted }} !important;{% endif %}
    }

    html:not([data-style="dark"]) .table thead th,
    html:not([data-style="dark"]) .table-light th {
        {% if light.text_heading %}color: {{ light.text_heading }} !important;{% endif %}
    }

    /* Dark Mode Variables */
    [data-style="dark"] {
        {% for key, value in dark.items() %}
        --ecs-{{ key|replace('_', '-') }}: {{ value }};
        {% endfor %}

        /* Map to Bootstrap variables */
        {% if dark.primary %}--bs-primary: {{ dark.primary }};{% endif %}
        {% if dark.secondary %}--bs-secondary: {{ dark.secondary }};{% endif %}
        {% if dark.success %}--bs-success: {{ dark.success }};{% endif %}
        {% if dark.warning %}--bs-warning: {{ dark.warning }};{% endif %}
        {% if dark.danger %}--bs-danger: {{ dark.danger }};{% endif %}
        {% if dark.info %}--bs-info: {{ dark.info }};{% endif %}
        {% if dark.text_heading %}--bs-heading-color: {{ dark.text_heading }};{% endif %}
        {% if dark.text_body %}--bs-body-color: {{ dark.text_body }};{% endif %}
        {% if dark.bg_body %}--bs-body-bg: {{ dark.bg_body }};{% endif %}
    }

    /* Dark Mode - Card-level variables override */
    [data-style="dark"] .card,
    html[data-style="dark"] .card {
        {% if dark.text_heading %}--bs-card-title-color: {{ dark.text_heading }};{% endif %}
        {% if dark.text_heading %}--bs-card-cap-color: {{ dark.text_heading }};{% endif %}
        {% if dark.text_body %}--bs-card-color: {{ dark.text_body }};{% endif %}
    }

    /* Dark Mode - Direct element overrides */
    html[data-style="dark"] h1,
    html[data-style="dark"] h2,
    html[data-style="dark"] h3,
    html[data-style="dark"] h4,
    html[data-style="dark"] h5,
    html[data-style="dark"] h6,
    html[data-style="dark"] .card-title,
    html[data-style="dark"] .ecs-card-title {
        {% if dark.text_heading %}color: {{ dark.text_heading }} !important;{% endif %}
    }

    html[data-style="dark"] .text-primary,
    html[data-style="dark"] .text-primary i,
    html[data-style="dark"] i.text-primary {
        {% if dark.primary %}color: {{ dark.primary }} !important;{% endif %}
    }

    html[data-style="dark"] .card-body,
    html[data-style="dark"] .table tbody td {
        {% if dark.text_body %}color: {{ dark.text_body }} !important;{% endif %}
    }

    html[data-style="dark"] .text-muted {
        {% if dark.text_muted %}color: {{ dark.text_muted }} !important;{% endif %}
    }
    </style>
    {% endif %}

    {# 9. PAGE-SPECIFIC CSS (Template Block)
         Child templates can inject page-specific styles here
         Example: {% block page_css %}<link rel="stylesheet" href="...">{% endblock %}
         Use for CSS that's only needed on specific pages #}
    {% block page_css %}
    {% endblock %}

    <!-- 10. CUSTOM CSS (Template Override Block)
         Final cascade layer for template-specific custom styles
         Child templates can add inline styles or additional links here
         This has the highest specificity in the cascade -->
    {% block custom_css %}
    {% endblock %}

    <!-- ============================================
         SCRIPTS
         ============================================ -->

    <!-- Error prevention for browser extensions -->
    <script>
        // Prevent browser extension errors from breaking the app
        window.addEventListener('error', function(e) {
            // Ignore errors from browser extensions
            if (e.filename && (e.filename.includes('moz-extension://') || e.filename.includes('chrome-extension://'))) {
                e.preventDefault();
                return true;
            }
        });
    </script>

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- Minimal Helpers (replaces Sneat helpers.js - NO layout manipulation) -->
    <script src="{{ url_for('static', filename='js/helpers-minimal.js') }}"></script>
    <!-- Simple theme switcher (replaces TemplateCustomizer) -->
    <script src="{{ asset_version('js/simple-theme-switcher.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
    <!-- Theme Colors Utility - provides ECSTheme.getColor() for JS -->
    <script src="{{ url_for('static', filename='js/theme-colors.js') }}"></script>
    {% endif %}

    <!-- CSRF Token for Forms -->
    <meta name="csrf-token" content="{{ csrf_token() }}">

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- Flatpickr JavaScript (DEV only - bundled in Vite production) -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    {% endif %}
</head>

<body class="c-base-layout" data-component="base-layout">
    <!-- Skip to main content link -->
    <a href="#main-content" class="c-base-layout__skip-link">Skip to main content</a>

    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar c-base-layout__wrapper" data-component="layout-wrapper">
        <div class="layout-container c-base-layout__container">
            <!-- Sidebar Menu -->
            {% if safe_current_user.is_authenticated %}
            {% include 'sidebar.html' %}
            {% endif %}
            <!-- / Sidebar Menu -->
            <!-- Layout page -->
            <div class="layout-page c-base-layout__page">
                <!-- Navbar - Modern Design -->
                {% if safe_current_user.is_authenticated %}
                {% include '_navbar_modern.html' %}
                {% endif %}
                <!-- / Navbar -->
                <!-- Content wrapper -->
                <div class="content-wrapper c-base-layout__content">
                    <!-- Role Impersonation Banner -->
                    {% if is_role_impersonation_active() %}
                    <div class="c-role-banner alert alert-dismissible" role="alert" data-component="role-banner" data-alert>
                        <div class="c-role-banner__content">
                            <i class="ti ti-eye c-role-banner__icon" aria-hidden="true"></i>
                            <div class="c-role-banner__text">
                                <div class="c-role-banner__title">Role Impersonation Active</div>
                                <div class="c-role-banner__description">
                                    You are viewing the application as:
                                    <span class="c-role-banner__roles">{{ ', '.join(user_roles) }}</span>
                                </div>
                            </div>
                            <form action="{{ url_for('role_impersonation.stop_impersonation_form') }}" method="post" class="c-role-banner__form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="c-btn c-btn--sm c-btn--outline-warning" data-action="stop-impersonation">
                                    <i class="ti ti-x me-1" aria-hidden="true"></i> Stop Viewing As
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                    <!-- Content -->
                    <main id="main-content" class="c-base-layout__main" tabindex="-1">
                        <div class="container-fluid flex-grow-1 container-p-y">
                            {% block main_content %}
                            <!-- Page-specific content will be injected here -->
                            {% endblock %}
                        </div>
                    </main>
                    <!-- / Content -->
                    <!-- Footer -->
                    <footer class="content-footer footer bg-footer-theme c-base-layout__footer" data-component="footer">
                        <div class="container-fluid c-base-layout__footer-container">
                            <div class="c-base-layout__footer-content">
                                <div class="c-base-layout__footer-copyright">
                                    ©
                                    <script>document.write(new Date().getFullYear());</script>, made with ❤️ by
                                    <a href="https://gronix.dev/" target="_blank" rel="noopener noreferrer" class="c-base-layout__footer-link">George</a>
                                </div>
                                <div class="c-base-layout__footer-links">
                                    <a href="https://github.com/geman220/ECS-Discord-Bot" target="_blank" rel="noopener noreferrer" class="c-base-layout__footer-link">Github</a>
                                </div>
                            </div>
                        </div>
                    </footer>
                    <!-- / Footer -->

                    <div class="content-backdrop fade c-base-layout__backdrop"></div>
                </div>
                <!-- / Content wrapper -->
            </div>
            <!-- / Layout page -->
        </div>

        <!-- Overlay -->
        <div class="layout-overlay layout-menu-toggle c-base-layout__overlay" data-action="close-menu"></div>
    </div>
    <!-- / Layout wrapper -->

    <!-- ============================================
         JAVASCRIPT LOADING: Vite vs Flask-Assets vs Development
         ============================================ -->

    {% if vite_production_mode is defined and vite_production_mode() %}
    <!-- VITE PRODUCTION MODE: Load jQuery/UI/Select2 first for inline scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    {{ vite_asset('js/main-entry.js') }}
    {% elif config.get('ASSETS_PRODUCTION_MODE') %}
    <!-- FLASK-ASSETS PRODUCTION MODE: Single minified bundle -->
    {% assets "production_js" %}
        <script src="{{ ASSET_URL }}"></script>
    {% endassets %}
    {% else %}
    <!-- DEVELOPMENT MODE: Individual files -->
    <!-- CSRF Token Auto-Injection for Fetch Requests -->
    <script src="{{ url_for('static', filename='js/csrf-fetch.js') }}"></script>
    <!-- Core JS -->
    <script src="{{ url_for('static', filename='vendor/libs/jquery/jquery.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/libs/popper/popper.js') }}"></script>
    <!-- Bootstrap UMD version (fixes "_element is not defined" error) -->
    <script src="{{ url_for('static', filename='vendor/js/bootstrap.bundle.js') }}"></script>

    <!-- ModalManager - Centralized modal management (Best Practice 2025) -->
    <!-- MUST load after Bootstrap, before any code that uses modals -->
    <script src="{{ url_for('static', filename='js/modal-manager.js') }}"></script>

    <!-- Waves library for ripple effects (logic only, styling via CSS) -->
    <script src="{{ url_for('static', filename='vendor/libs/node-waves/node-waves.js') }}"></script>

    <!-- Perfect Scrollbar - Required by menu.js for sidebar scrolling -->
    <script src="{{ url_for('static', filename='vendor/libs/perfect-scrollbar/perfect-scrollbar.js') }}"></script>

    <!-- Hammer.js - Touch gestures for mobile menu interactions -->
    <script src="{{ url_for('static', filename='vendor/libs/hammer/hammer.js') }}"></script>

    <!-- Menu.js - Defines window.Menu class (required by main.js) -->
    <script src="{{ url_for('static', filename='vendor/js/menu-refactored.js') }}"></script>

    <!-- Helpers - Defines window.Helpers class (required by main.js) -->
    <script src="{{ url_for('static', filename='js/helpers-minimal.js') }}"></script>

    <!-- Config - Defines templateName global (required by main.js) -->
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
    {% endif %}
    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- DISABLED: waves-css-override.js - Waves.Effect is not exposed in node-waves API -->
    {# <script src="{{ url_for('static', filename='custom_js/waves-css-override.js') }}"></script> #}

    <!-- Discord Membership Check - Global -->
    <script src="{{ url_for('static', filename='custom_js/discord-membership-check.js') }}"></script>

    <!-- Sidebar Interactions (replaces Sneat menu.js - no layout manipulation) -->
    <script src="{{ url_for('static', filename='js/sidebar-interactions.js') }}"></script>

    <!-- Mobile Enhancement System (Phase 2) -->
    <script src="{{ url_for('static', filename='js/mobile-haptics.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mobile-gestures.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mobile-keyboard.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mobile-forms.js') }}"></script>
    <script src="{{ url_for('static', filename='js/profile-verification.js') }}"></script>
    {% endif %}

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- SweetAlert2 for nice notifications (DEV only - bundled in Vite production) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    {% endif %}

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- SweetAlert Contextual Helper - Smart button text based on action type -->
    <script src="{{ url_for('static', filename='js/swal-contextual.js') }}"></script>
    {% endif %}

    <!-- SweetAlert Notification Handler -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check for SweetAlert message in session
            {% if session.get('sweet_alert') %}
                Swal.fire({
                    title: {{ session.get('sweet_alert').get('title', '') | tojson }},
                    text: {{ session.get('sweet_alert').get('text', '') | tojson }},
                    icon: {{ session.get('sweet_alert').get('icon', 'success') | tojson }},
                    confirmButtonText: "OK"
                }).then(function() {
                    // Clear the sweet alert from session after user acknowledges it
                    fetch("{{ url_for('main.clear_sweet_alert') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    }).then(function(response) {
                        if (!response.ok) {
                            throw new Error('Failed to clear alert');
                        }
                        return response.json();
                    }).then(function(data) {
                        if (data.success) {
                            console.log('Sweet alert cleared successfully');
                        } else {
                            console.error('Failed to clear sweet alert:', data.message);
                        }
                    }).catch(function(error) {
                        console.error('Error clearing sweet alert:', error);
                        // Force clear by reloading if clearing fails
                        window.location.href = window.location.href.split('?')[0];
                    });
                });
            {% endif %}
        });
    </script>

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- Unified Responsive System JS - replacing all previous mobile helpers -->
    <script src="{{ url_for('static', filename='js/responsive-system.js') }}"></script>

    <!-- Responsive Tables JS - for mobile card views -->
    <script src="{{ url_for('static', filename='js/responsive-tables.js') }}"></script>

    <!-- ECS Design System JS -->
    <script src="{{ url_for('static', filename='js/design-system.js') }}"></script>

    <!-- BEM Tabs Controller - Pure JS tab system without Bootstrap dependency -->
    <script src="{{ url_for('static', filename='js/components/tabs-controller.js') }}"></script>

    <!-- Socket Manager - Unified WebSocket connection management (MUST load before other socket-dependent scripts) -->
    <script src="{{ url_for('static', filename='js/socket-manager.js') }}"></script>

    <!-- Modern Navbar Controller - Event delegation and smooth interactions -->
    <script src="{{ url_for('static', filename='js/navbar-modern.js') }}"></script>

    <!-- Online Status Manager - Real-time user presence indicators -->
    <script src="{{ url_for('static', filename='js/online-status.js') }}"></script>

    <!-- Chat Widget - Floating direct messaging interface -->
    <script src="{{ url_for('static', filename='js/chat-widget.js') }}"></script>

    <!-- Messenger Widget - Sidebar integrated messaging (replaces floating chat) -->
    <script src="{{ url_for('static', filename='js/messenger-widget.js') }}"></script>

    <!-- Modern Components Controller - Unified controller for all modern UI components
         Handles modals, toasts, tooltips, dropdowns, tables, forms with event delegation
         Phase 2-4 complete implementation -->
    <script src="{{ url_for('static', filename='js/components-modern.js') }}"></script>

    <!-- Report Match JS - Consolidated functionality -->
    <script src="{{ url_for('static', filename='custom_js/report_match.js') }}"></script>

    <!-- Event Delegation System - Centralized event handling for data-action attributes -->
    <!-- CRITICAL: Must load after report_match.js which defines handleEditButtonClick -->
    <script src="{{ url_for('static', filename='js/event-delegation.js') }}"></script>

    <!-- Modal Helpers - Consolidated modal utilities (replaces simple-modal-fix.js + simple-report-fix.js) -->
    <script src="{{ url_for('static', filename='custom_js/modal-helpers.js') }}"></script>

    <!-- UI Enhancements - Feather icons, collapsible sections, dropdown fixes -->
    <script src="{{ url_for('static', filename='js/ui-enhancements.js') }}"></script>

    <!-- DISABLED: These scripts inject inline styles that conflict with CSS refactoring -->
    {# <script src="{{ url_for('static', filename='custom_js/modal-repair.js') }}"></script> #}
    {# <script src="{{ url_for('static', filename='custom_js/button-diagnostic.js') }}"></script> #}
    {# <script src="{{ url_for('static', filename='custom_js/button-mouseup-fix.js') }}"></script> #}

    <!-- SMS Verification functionality -->
    <script src="{{ url_for('static', filename='custom_js/sms-verification.js') }}"></script>
    {% endif %}
    
    <!-- Load modals via AJAX (after jQuery is loaded) -->
    <script>
        // Wait for jQuery to be available (handles both bundled and separate loading)
        (function waitForjQuery() {
            if (typeof $ === 'undefined' || typeof jQuery === 'undefined') {
                setTimeout(waitForjQuery, 50);
                return;
            }
            $(document).ready(function() {
                // Only load modals if edit buttons exist on the page
                if ($('.edit-match-btn').length > 0) {
                // First, collect all match IDs from all edit buttons
                const matchIds = [];
                $('.edit-match-btn').each(function() {
                    const matchId = $(this).data('match-id');
                    if (matchId && !matchIds.includes(matchId)) {
                        matchIds.push(matchId);
                    }
                });
                
                console.log('Found match IDs for modals:', matchIds);
                
                // Load all modals, sending the list of match IDs we need
                $.ajax({
                    url: '/modals/render_modals',
                    method: 'GET',
                    data: { match_ids: matchIds.join(',') },
                    success: function(response) {
                        // Create or find a modal container
                        let container = document.getElementById('reportMatchModal-container');
                        if (!container) {
                            container = document.createElement('div');
                            container.id = 'reportMatchModal-container';
                            container.className = 'modal-container';
                            document.body.appendChild(container);
                        }
                        
                        // Append modals to the container
                        $(container).append(response);
                        
                        // After loading, verify that all needed modals exist
                        setTimeout(function() {
                            matchIds.forEach(function(id) {
                                if (!document.getElementById(`reportMatchModal-${id}`)) {
                                    console.warn(`Modal for match ID ${id} not found, will be created on demand`);
                                }
                            });
                        }, 500);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading modals:', error);
                    }
                });
            }
            });
        })();
    </script>

    <!-- No JavaScript needed for z-index - CSS handles it! -->

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- Other JS files (only in development - bundled in production) -->
    <script src="{{ url_for('static', filename='assets/js/main.js') }}"></script>
    {% endif %}

    <!-- Select2 JS (development only - Vite bundle includes it in production) -->
    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    {% endif %}

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- DEV ONLY: These are bundled in Vite production -->
    <!-- Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

    <!-- Include Socket.IO for real-time updates -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>

    <!-- Feather Icons -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    {% endif %}

    <!-- FullCalendar JS (NOT bundled - large calendar library) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.15/index.global.min.js"></script>

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- Shepherd.js for guided tours (bundled in production) -->
    <script src="{{ url_for('static', filename='assets/vendor/libs/shepherd/shepherd.js') }}"></script>
    {% endif %}

    <!-- Include Fancybox JS (NOT bundled - jQuery plugin) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- DataTables JS (DEV only - bundled in Vite production) -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>
    {% endif %}

    <!-- NOTE: jQuery UI 1.12.1 REMOVED - Using 1.13.2 loaded in Vite production mode section -->

    <!-- Global Scripts -->
    <!-- Theme initialization moved to top of head to prevent FOUC -->
    <script>
        // Wait for jQuery to be available
        (function waitForjQuery2() {
            if (typeof $ === 'undefined' || typeof jQuery === 'undefined') {
                setTimeout(waitForjQuery2, 50);
                return;
            }
            $(document).ready(function () {
                function initializeSelect2() {
                $('.select2-single').select2({
                    placeholder: 'Select an option',
                    allowClear: true,
                    width: '100%',
                    theme: 'bootstrap-5'
                });

                $('.select2-multiple').select2({
                    placeholder: 'Select multiple options',
                    allowClear: true,
                    width: '100%',
                    theme: 'bootstrap-5'
                });
            }

            initializeSelect2();

            // Re-initialize Select2 on modal open to ensure elements are initialized correctly
            $('#onboardingSlideModal').on('shown.bs.modal', function () {
                initializeSelect2();
            });

            // Ensure Select2 fields are properly captured on form submission
            $('form').on('submit', function () {
                $('.select2-multiple').each(function () {
                    var selectedValues = $(this).val();
                    $(this).val(selectedValues).trigger('change');
                });
            });

            // Sidebar and menu logic
            // Note: Menu initialization is handled by main.js - do NOT duplicate here
            // PerfectScrollbar is configured with suppressScrollX: true in menu.js

            // Feather Icons Initialization - restored for data-feather attributes
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
            });
        })();
    </script>
    <!-- Initialize and Auto-Dismiss Toasts -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Select all toasts within the flash-toast-container
            const toastElList = [].slice.call(document.querySelectorAll('#flash-toast-container .toast'));
            const maxVisibleToasts = 3; // Maximum number of toasts visible at once
            let currentToasts = 0;
            const toastQueue = [...toastElList];

            function showNextToast() {
                if (toastQueue.length === 0 || currentToasts >= maxVisibleToasts) return;

                const toastEl = toastQueue.shift();
                currentToasts++;

                const toast = new bootstrap.Toast(toastEl, {
                    delay: 5000, // 5 seconds
                    autohide: true
                });
                toast.show();

                // Decrement count when toast hides
                toastEl.addEventListener('hidden.bs.toast', () => {
                    currentToasts--;
                    showNextToast();
                });
            }

            // Initialize the queue
            for (let i = 0; i < maxVisibleToasts && toastQueue.length > 0; i++) {
                showNextToast();
            }
        });
    </script>
    <script>
    $(document).ready(function() {
        // Build the base URL for player profiles.
        var playerProfileBaseUrl = "{{ url_for('players.player_profile', player_id=9999) }}";
        playerProfileBaseUrl = playerProfileBaseUrl.replace('9999', '');

        $("#player-search").autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: "{{ url_for('search.search_players') }}",
                    dataType: "json",
                    data: { term: request.term },
                    success: function(data) {
                        response($.map(data, function(item) {
                            return {
                                label: item.name,
                                value: item.name,
                                id: item.id,
                                profile_picture_url: item.profile_picture_url
                            };
                        }));
                    }
                });
            },
            minLength: 1,
            select: function(event, ui) {
                window.location.href = playerProfileBaseUrl + ui.item.id;
            }
        }).autocomplete("instance")._renderItem = function(ul, item) {
            // Create a container for the image and name
            var $li = $("<li>");
            var $div = $("<div>").addClass("ui-menu-item-wrapper");
            if(item.profile_picture_url) {
                $div.append("<img src='" + item.profile_picture_url + "' alt='" + item.label + "' class='autocomplete-profile-img' />");
            }
            $div.append("<span>" + item.label + "</span>");
            return $li.append($div).appendTo(ul);
        };

        // Optionally, handle ENTER key when a suggestion exists:
        $("#player-search").on("keypress", function(e) {
            if (e.which == 13) {
                var firstItem = $("#player-search").autocomplete("instance").menu.element.find("li:first-child a");
                if (firstItem.length) {
                    var playerId = firstItem.data("ui-autocomplete-item").id;
                    window.location.href = playerProfileBaseUrl + playerId;
                }
            }
        });

        // Prevent form submission for autocomplete search (moved from inline onsubmit)
        $('[data-action="prevent-submit"]').on('submit', function(e) {
            e.preventDefault();
            return false;
        });
    });
    </script>
    <script>
        // The ancient code sequence... use it wisely
        !function () {
            const a = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65]; // Sacred sequence
            let b = 0; // Current position in the incantation

            // Listen for the mystical key presses
            document.addEventListener("keydown", function (c) {
                // If the key matches, progress the sequence
                a[b] === c.keyCode ? (b++, a.length === b && (d(), b = 0)) : b = 0;
            });

            // Open the gates to doom
            function d() {
                var encodedUrl = "aHR0cHM6Ly9kb29tb25saW5lMS52ZXJjZWwuYXBwL2Rvcy5odG1s";
                var url = atob(encodedUrl);
                window.open(url, "Unleashed", "width=800,height=600");
            }
        }();
    </script>
    <!-- Custom JS for specific pages -->
    {% block custom_js %}
    {% endblock %}

    {% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <!-- Mobile menu fix for iOS and other mobile devices (bundled in production) -->
    <script src="{{ url_for('static', filename='custom_js/mobile-menu-fix.js') }}"></script>

    <!-- Enhanced Mobile Functionality v3.0 (bundled in production) -->
    <script src="{{ url_for('static', filename='custom_js/mobile-tables.js') }}" defer></script>
    {% endif %}
    
    <!-- Toggle switch fix removed -->
    
    <!-- Initialize modal backdrop cleanup -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Clean up any stray modal backdrops
            const cleanupBackdrops = function() {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                if (backdrops.length > 0) {
                    backdrops.forEach(backdrop => {
                        if (backdrop.parentNode) {
                            backdrop.parentNode.removeChild(backdrop);
                        }
                    });
                    document.body.classList.remove('modal-open');
                    // Reset body styles (overflow and padding handled by CSS)
                }
            };

            // Run initial cleanup
            cleanupBackdrops();
        });
    </script>

    {# Floating Chat Widget - Facebook Messenger style #}
    {% if safe_current_user.is_authenticated %}
    {% include 'components/_chat_widget.html' %}
    {% endif %}

    <!-- Mobile Bottom Navigation (Phase 3) -->
    {% include 'mobile_bottom_nav.html' %}
</body>
</html>