{% extends "base_flowbite.html" %}
{% from "macros/flowbite.html" import modal_form %}

{% block title %}{{ title }}{% endblock %}

{% block main_content %}
<div class="container mx-auto px-4 py-8">
    <!-- Connection Status -->
    <div id="connectionStatus" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-red-100 dark:bg-red-900/50 border border-red-200 dark:border-red-700 rounded-lg px-4 py-2 flex items-center gap-2 text-red-700 dark:text-red-300">
            <i class="ti ti-wifi-off"></i>
            <span>Connecting...</span>
        </div>
    </div>

    <!-- Draft Header -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-ecs-green">{{ title }}</h1>
                <p class="text-gray-500 dark:text-gray-400">Draft and manage players for your teams</p>
            </div>
            <div class="flex flex-wrap items-center gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-ecs-green">{{ analytics.total_teams }}</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Teams</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-500">{{ analytics.total_players_drafted }}</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Drafted</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-500" id="availableCount">{{ available_players|length }}</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Available</div>
                </div>
                <a href="{{ url_for('draft_enhanced.draft_league_pitch_view', league_name=league_name) }}"
                   class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <i class="ti ti-layout-dashboard"></i>
                    Pitch View
                </a>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 mb-6">
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
            <div class="col-span-2 md:col-span-1">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Search Players</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                        <i class="ti ti-search"></i>
                    </span>
                    <input type="text" id="playerSearch" placeholder="Type player name..."
                           data-on-input="draft-filter-players"
                           class="w-full pl-10 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm focus:border-ecs-green focus:ring-ecs-green">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Position</label>
                <select id="positionFilter" data-on-change="draft-filter-players" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm focus:border-ecs-green focus:ring-ecs-green">
                    <option value="">All Positions</option>
                    <option value="goalkeeper">Goalkeeper</option>
                    <option value="defender">Defender</option>
                    <option value="midfielder">Midfielder</option>
                    <option value="forward">Forward</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Attendance</label>
                <select id="attendanceFilter" data-on-change="draft-filter-players" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm focus:border-ecs-green focus:ring-ecs-green">
                    <option value="">All</option>
                    <option value="80-100">80%+ (High)</option>
                    <option value="60-79">60-79% (Medium)</option>
                    <option value="0-59">Below 60% (Low)</option>
                    <option value="unknown">No Data</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Career Goals</label>
                <select id="goalsFilter" data-on-change="draft-filter-players" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm focus:border-ecs-green focus:ring-ecs-green">
                    <option value="">All</option>
                    <option value="10+">10+ Goals</option>
                    <option value="5-9">5-9 Goals</option>
                    <option value="1-4">1-4 Goals</option>
                    <option value="0">No Goals</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Previous Draft</label>
                <select id="prevDraftFilter" data-on-change="draft-filter-players" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm focus:border-ecs-green focus:ring-ecs-green">
                    <option value="">All</option>
                    <option value="1-20">Top 20 Pick</option>
                    <option value="21-50">Pick 21-50</option>
                    <option value="51+">Pick 51+</option>
                    <option value="new">New Player</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sort By</label>
                <select id="sortBy" data-on-change="draft-filter-players" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm focus:border-ecs-green focus:ring-ecs-green">
                    <option value="name">Name</option>
                    <option value="experience">Experience</option>
                    <option value="attendance">Attendance</option>
                    <option value="goals">Goals</option>
                    <option value="prev_draft">Prev Draft #</option>
                </select>
            </div>
        </div>
        <!-- Clear Filters Button -->
        <div class="mt-3 flex justify-end">
            <button data-action="draft-clear-filters" class="text-sm text-gray-500 dark:text-gray-400 hover:text-ecs-green dark:hover:text-ecs-green transition-colors">
                <i class="ti ti-x mr-1"></i>Clear Filters
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Available Players -->
        <div class="lg:col-span-8">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                        <i class="ti ti-users text-ecs-green"></i>
                        Available Players (<span id="available-players-count">{{ available_players|length }}</span>)
                    </h2>
                </div>
                <div class="p-4">
                    <div id="available-players" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 js-draft-drop-zone" data-drop-target="available">
                        {% for player in available_players %}
                        <div id="player-{{ player.id }}" class="bg-white dark:bg-gray-700 rounded-xl shadow-sm border border-gray-200 dark:border-gray-600 overflow-hidden js-draggable-player"
                             data-player-id="{{ player.id }}"
                             data-player-name="{{ player.name|lower }}"
                             data-position="{{ (player.favorite_position or '')|lower }}"
                             data-experience="{{ player.league_experience_seasons }}"
                             data-attendance="{{ player.attendance_estimate if player.attendance_estimate is not none else '' }}"
                             data-goals="{{ player.career_goals }}"
                             data-prev-draft="{{ player.prev_draft_position or 999 }}"
                             draggable="true">
                            <!-- Player Image -->
                            <div class="relative h-32 bg-gradient-to-b from-gray-100 to-gray-200 dark:from-gray-600 dark:to-gray-700">
                                <img src="{{ player.profile_picture_medium or player.profile_picture_webp or player.profile_picture_url or '/static/img/default_player.png' }}"
                                     alt="{{ player.name }}"
                                     class="w-full h-full object-cover object-top"
                                     loading="lazy">
                                <!-- Experience Badge -->
                                <div class="absolute top-2 right-2">
                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold text-white
                                                {{ 'bg-green-500' if player.experience_level == 'Veteran' else 'bg-yellow-500' if player.experience_level == 'Experienced' else 'bg-gray-400' }}">
                                        {{ player.experience_level[0] if player.experience_level else 'N' }}
                                    </span>
                                </div>
                                <!-- Previous Draft Position Badge -->
                                <div class="absolute top-2 left-2 flex flex-col gap-1">
                                    {% if player.prev_draft_position %}
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-bold bg-blue-600 text-white" title="Last season draft pick #{{ player.prev_draft_position }}">
                                        #{{ player.prev_draft_position }}
                                    </span>
                                    {% endif %}
                                    {% if player.is_ref %}
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-bold bg-red-500 text-white">REF</span>
                                    {% endif %}
                                </div>
                                <!-- Name Overlay -->
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-2">
                                    <h3 class="text-white font-bold text-sm truncate">{{ player.name }}</h3>
                                </div>
                            </div>

                            <!-- Player Info -->
                            <div class="p-3">
                                <!-- Position with color coding -->
                                <div class="text-center mb-2 flex flex-wrap justify-center gap-1">
                                    <!-- Primary Position (GREEN) -->
                                    {% if player.favorite_position and player.favorite_position != 'Any' %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 border border-green-300 dark:border-green-700">
                                        <i class="ti ti-star-filled mr-1 text-green-500 text-[10px]"></i>
                                        {{ format_position(player.favorite_position) }}
                                    </span>
                                    {% else %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-600 text-gray-600 dark:text-gray-300">
                                        Any Position
                                    </span>
                                    {% endif %}
                                    <!-- Secondary Positions (ORANGE) - clean up {} braces from legacy data -->
                                    {% if player.other_positions %}
                                    {% set clean_positions = player.other_positions|replace('{', '')|replace('}', '') %}
                                    {% for pos in clean_positions.split(',') %}
                                    {% set clean_pos = pos.strip() %}
                                    {% if clean_pos and clean_pos != player.favorite_position %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400">
                                        {{ format_position(clean_pos) }}
                                    </span>
                                    {% endif %}
                                    {% endfor %}
                                    {% endif %}
                                    <!-- Positions NOT to play (RED) -->
                                    {% if player.positions_not_to_play %}
                                    {% set clean_not_positions = player.positions_not_to_play|replace('{', '')|replace('}', '') %}
                                    {% for pos in clean_not_positions.split(',') %}
                                    {% set clean_pos = pos.strip() %}
                                    {% if clean_pos %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 border border-red-300 dark:border-red-700">
                                        <i class="ti ti-x mr-1 text-red-500 text-[10px]"></i>
                                        {{ format_position(clean_pos) }}
                                    </span>
                                    {% endif %}
                                    {% endfor %}
                                    {% endif %}
                                </div>

                                <!-- Stats -->
                                <div class="grid grid-cols-2 gap-2 text-center text-xs mb-2">
                                    <div>
                                        <div class="font-bold text-green-500">{{ player.career_goals }}</div>
                                        <div class="text-gray-500 dark:text-gray-400">Goals</div>
                                    </div>
                                    <div>
                                        <div class="font-bold text-blue-500">{{ player.career_assists }}</div>
                                        <div class="text-gray-500 dark:text-gray-400">Assists</div>
                                    </div>
                                </div>

                                <!-- Cards & Attendance -->
                                <div class="grid grid-cols-2 gap-2 text-center text-xs mb-3">
                                    <div>
                                        <div class="font-bold">
                                            <span class="text-yellow-500">{{ player.career_yellow_cards }}</span>/<span class="text-red-500">{{ player.career_red_cards }}</span>
                                        </div>
                                        <div class="text-gray-500 dark:text-gray-400">Cards</div>
                                    </div>
                                    <div>
                                        {% if player.attendance_estimate is not none %}
                                        <div class="font-bold {{ 'text-green-500' if player.attendance_estimate >= 80 else 'text-yellow-500' if player.attendance_estimate >= 60 else 'text-red-500' }}">
                                            {{ "%.0f"|format(player.attendance_estimate) }}%
                                        </div>
                                        {% else %}
                                        <div class="font-bold text-gray-400">N/A</div>
                                        {% endif %}
                                        <div class="text-gray-500 dark:text-gray-400">Attend</div>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="space-y-1">
                                    <button class="w-full px-3 py-1.5 rounded-lg bg-ecs-green text-white text-sm font-medium hover:bg-ecs-green/90 transition-colors"
                                            data-action="draft-player"
                                            data-target-player-id="{{ player.id }}"
                                            data-player-name="{{ player.name|escape }}">
                                        <i class="ti ti-user-plus mr-1"></i>Draft
                                    </button>
                                    <button class="w-full px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 text-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors"
                                            data-action="view-player-profile"
                                            data-target-player-id="{{ player.id }}">
                                        <i class="ti ti-info-circle mr-1"></i>More Info
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Pagination Controls -->
                    <div id="paginationControls" class="flex items-center justify-between p-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Show:</span>
                            <select id="pageSizeSelect" data-on-change="draft-change-page-size" class="rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm py-1 focus:border-ecs-green focus:ring-ecs-green">
                                <option value="12">12</option>
                                <option value="24" selected>24</option>
                                <option value="48">48</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <button data-action="draft-prev-page" class="px-3 py-1 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="ti ti-chevron-left"></i>
                            </button>
                            <span id="pageInfo" class="text-sm text-gray-600 dark:text-gray-400 min-w-[100px] text-center">Page 1 of 1</span>
                            <button data-action="draft-next-page" class="px-3 py-1 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="ti ti-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-12">
                <div class="w-16 h-16 mx-auto rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mb-4">
                    <i class="ti ti-search text-2xl text-gray-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No players found</h3>
                <p class="text-gray-500 dark:text-gray-400">Try adjusting your search or filters</p>
            </div>
        </div>

        <!-- Teams Sidebar -->
        <div class="lg:col-span-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden sticky top-4">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                        <i class="ti ti-users text-ecs-green"></i>
                        Teams
                    </h2>
                </div>
                <div class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for team in teams %}
                    <details class="group js-draft-drop-zone" data-team-id="{{ team.id }}" data-drop-target="team">
                        <summary class="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50">
                            <span class="font-semibold text-gray-900 dark:text-white">{{ team.name }}</span>
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-ecs-green/10 text-ecs-green" id="teamCount{{ team.id }}">
                                    {{ drafted_players_by_team[team.id]|length if drafted_players_by_team[team.id] else 0 }}
                                </span>
                                <i class="ti ti-chevron-down transform group-open:rotate-180 transition-transform text-gray-400"></i>
                            </div>
                        </summary>
                        <div class="p-4 pt-0">
                            <div id="teamPlayers{{ team.id }}" class="space-y-2 js-draft-drop-zone" data-team-id="{{ team.id }}" data-drop-target="team">
                                {% for player in drafted_players_by_team[team.id] %}
                                <div class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700 rounded-lg js-draggable-player" draggable="true" data-player-id="{{ player.id }}">
                                    <img src="{{ player.profile_picture_url or '/static/img/default_player.png' }}"
                                         alt="{{ player.name }}"
                                         class="w-8 h-8 rounded-full object-cover">
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white truncate">{{ player.name }}</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">{{ format_position(player.favorite_position) if player.favorite_position else 'Any' }}</div>
                                    </div>
                                    <button class="p-1 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded"
                                            data-action="remove-player"
                                            data-target-player-id="{{ player.id }}"
                                            data-team-id="{{ team.id }}"
                                            data-player-name="{{ player.name|escape }}"
                                            data-team-name="{{ team.name|escape }}">
                                        <i class="ti ti-x"></i>
                                    </button>
                                </div>
                                {% endfor %}
                                {% if not drafted_players_by_team[team.id] %}
                                <div class="text-center py-4 text-gray-500 dark:text-gray-400">
                                    <i class="ti ti-user-plus text-xl mb-1 block"></i>
                                    <div class="text-sm">Drag players here</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </details>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Draft Confirmation Modal -->
{% call modal_form('draftConfirmModal', 'Draft Player', form_id='draftConfirmForm', submit_text='Draft Player', loading_text='Drafting...') %}
<p id="draftPlayerMessage" class="text-gray-600 dark:text-gray-300 mb-4"></p>
<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Team:</label>
<select id="teamSelect" name="team_id" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:border-ecs-green focus:ring-ecs-green">
    <option value="">Choose a team...</option>
</select>
{% endcall %}

<!-- Player Profile Modal -->
<div id="playerProfileModal" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative w-full max-w-lg max-h-full">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-800">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b dark:border-gray-700">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                    <i class="ti ti-user mr-2"></i>Player Information
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="playerProfileModal">
                    <i class="ti ti-x text-lg"></i>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <!-- Modal Body -->
            <div class="p-4">
                <!-- Loading State -->
                <div id="profileLoading" class="block text-center py-8">
                    <div class="animate-spin w-8 h-8 border-4 border-ecs-green border-t-transparent rounded-full mx-auto mb-3"></div>
                    <p class="text-gray-500 dark:text-gray-400">Loading player info...</p>
                </div>
                <!-- Profile Data (populated by JS) -->
                <div id="profileData" class="hidden"></div>
            </div>
            <!-- Modal Footer -->
            <div class="flex items-center gap-2 p-4 border-t dark:border-gray-700">
                <button id="draftFromModal" type="button" class="hidden flex-1 px-4 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green/90 focus:ring-4 focus:outline-none focus:ring-green-300">
                    <i class="ti ti-user-plus mr-1"></i>Draft Player
                </button>
                <button type="button" data-modal-hide="playerProfileModal" class="flex-1 px-4 py-2 text-sm font-medium text-gray-500 bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-gray-900 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 text-center">
        <div class="animate-spin w-8 h-8 border-4 border-ecs-green border-t-transparent rounded-full mx-auto mb-3"></div>
        <p class="text-gray-600 dark:text-gray-300">Processing...</p>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
  window.DraftConfig = {
    leagueName: {{ league_name | tojson | safe }}
  };
</script>
{# draft-enhanced.js is already bundled via Vite main-entry.js - do NOT load separately #}
{% endblock %}
