{% extends "base_flowbite.html" %}
{% from "macros/flowbite.html" import modal_info %}

{% block title %}WooCommerce Sync Review{% endblock %}

{% block main_content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    <i class="ti ti-refresh text-ecs-green"></i>
                    WooCommerce Sync Review
                </h1>
                <p class="text-gray-500 dark:text-gray-400">Review and resolve sync issues before applying changes</p>
            </div>
            <div class="flex gap-2">
                <a href="{{ url_for('user_management.manage_users') }}"
                   class="inline-flex items-center gap-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                    <i class="ti ti-arrow-left"></i> Back to User Management
                </a>
                <button type="button" class="js-refresh-sync inline-flex items-center gap-1 px-4 py-2 border border-ecs-green text-ecs-green rounded-lg hover:bg-ecs-green hover:text-white"
                        data-action="refresh-sync">
                    <i class="ti ti-refresh"></i> Refresh Data
                </button>
            </div>
        </div>
    </div>

    <!-- Progress Card -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 mb-6">
        <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Resolution Progress</h3>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-6 overflow-hidden">
            <div class="bg-ecs-green h-6 rounded-full flex items-center justify-center text-white text-sm font-medium transition-all duration-300"
                 id="resolutionProgress" style="width: 0%;">
                <span id="progressText">0% Complete</span>
            </div>
        </div>
    </div>

    <!-- Stats Overview Cards -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 text-center">
            <h3 class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="newPlayersCount">{{ sync_data.new_players|length }}</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">New Players</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 text-center">
            <h3 class="text-2xl font-bold text-green-600 dark:text-green-400" id="existingPlayersCount">{{ sync_data.player_league_updates|length }}</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">Existing Players</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 text-center">
            <h3 class="text-2xl font-bold text-yellow-600 dark:text-yellow-400" id="flaggedOrdersCount">{{ sync_data.flagged_multi_orders|length }}</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">Multi-Orders</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 text-center">
            <h3 class="text-2xl font-bold text-red-600 dark:text-red-400" id="emailMismatchCount">{{ sync_data.email_mismatch_players|length }}</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">Email Mismatches</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 text-center">
            <h3 class="text-2xl font-bold text-cyan-600 dark:text-cyan-400" id="potentialInactiveCount">{{ sync_data.potential_inactive|length }}</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">Potential Inactive</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 text-center">
            <h3 class="text-2xl font-bold text-gray-600 dark:text-gray-400" id="issuesResolvedCount">0</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">Issues Resolved</p>
        </div>
    </div>

    <!-- Main Issues Card with Tabs -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        <!-- Tab Navigation -->
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="flex overflow-x-auto" id="issuesTab">
                <button type="button" class="sync-tab flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-ecs-green text-ecs-green"
                        data-tab="multi-orders">
                    <i class="ti ti-users mr-1"></i>Multi-Person Orders
                    <span class="ml-1 px-2 py-0.5 text-xs bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300 rounded-full" id="multiOrdersBadge">{{ sync_data.flagged_multi_orders|length }}</span>
                </button>
                <button type="button" class="sync-tab flex-shrink-0 px-4 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 border-b-2 border-transparent"
                        data-tab="new-players">
                    <i class="ti ti-user-plus mr-1"></i>New Players
                    <span class="ml-1 px-2 py-0.5 text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 rounded-full" id="newPlayersBadge">{{ sync_data.new_players|length }}</span>
                </button>
                <button type="button" class="sync-tab flex-shrink-0 px-4 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 border-b-2 border-transparent"
                        data-tab="email-mismatches">
                    <i class="ti ti-mail mr-1"></i>Email Mismatches
                    <span class="ml-1 px-2 py-0.5 text-xs bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 rounded-full" id="emailMismatchBadge">{{ sync_data.email_mismatch_players|length }}</span>
                </button>
                <button type="button" class="sync-tab flex-shrink-0 px-4 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 border-b-2 border-transparent"
                        data-tab="existing-players">
                    <i class="ti ti-user-check mr-1"></i>Existing Players
                    <span class="ml-1 px-2 py-0.5 text-xs bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 rounded-full" id="existingPlayersBadge">{{ sync_data.player_league_updates|length }}</span>
                </button>
                <button type="button" class="sync-tab flex-shrink-0 px-4 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 border-b-2 border-transparent"
                        data-tab="inactive-players">
                    <i class="ti ti-user-off mr-1"></i>Mark Inactive
                    <span class="ml-1 px-2 py-0.5 text-xs bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300 rounded-full" id="inactivePlayersBadge">{{ sync_data.players_to_inactivate|length }}</span>
                </button>
                <button type="button" class="sync-tab flex-shrink-0 px-4 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 border-b-2 border-transparent"
                        data-tab="summary">
                    <i class="ti ti-check-circle mr-1"></i>Final Review
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Multi-Person Orders Tab -->
            <div class="sync-tab-pane p-6" id="multi-orders" data-tab-pane>
                {% if sync_data.flagged_multi_orders|length > 0 %}
                <div class="bg-yellow-50 dark:bg-yellow-900/30 border-l-4 border-yellow-400 p-4 rounded-r-lg mb-6">
                    <div class="flex items-start gap-3">
                        <i class="ti ti-alert-triangle text-yellow-500 text-xl mt-0.5"></i>
                        <div>
                            <h4 class="font-semibold text-yellow-800 dark:text-yellow-200">Multi-Person Orders Detected</h4>
                            <p class="text-yellow-700 dark:text-yellow-300 text-sm">These buyers purchased multiple memberships. Please assign each order to the correct player profile.</p>
                        </div>
                    </div>
                </div>

                {% for order in sync_data.flagged_multi_orders %}
                {% set outer_loop = loop %}
                <div class="issue-card border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-6" data-issue-type="multi-order" data-issue-id="{{ loop.index0 }}">
                    <div class="flex flex-col md:flex-row justify-between gap-4 mb-4">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <i class="ti ti-user text-ecs-green"></i>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ order.buyer_info.name }}</h3>
                                <span class="status-badge px-2 py-1 text-xs bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300 rounded-full">Pending Assignment</span>
                            </div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">
                                <i class="ti ti-mail mr-1"></i>{{ order.buyer_info.email }}<br>
                                <span class="text-xs">{{ order.reason }}</span>
                            </p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium text-blue-600 dark:text-blue-400 mb-3 flex items-center gap-2">
                                <i class="ti ti-shopping-cart"></i> Orders to Assign
                            </h4>
                            {% for ord in order.orders %}
                            <div class="order-details bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3 mb-3" data-order-index="{{ loop.index0 }}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <span class="font-medium text-gray-900 dark:text-white">Order #{{ ord.order.order_id }}</span>
                                        <span class="ml-2 px-2 py-0.5 text-xs bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded">Qty: {{ ord.order.quantity }}</span>
                                    </div>
                                </div>
                                <div class="mt-2 text-sm space-y-1">
                                    <p><strong>Product:</strong> {{ ord.order.product_name }}</p>
                                    <p><strong>Name:</strong> {{ ord.player_info.name }}</p>
                                    <p><strong>Email:</strong> {{ ord.player_info.email or 'Not provided' }}</p>
                                    <p><strong>Phone:</strong> {{ ord.player_info.phone or 'Not provided' }}</p>
                                    <p><strong>Jersey Size:</strong> {{ ord.jersey_size or 'Not provided' }}</p>
                                    <p><strong>League:</strong> {{ ord.league_name }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div>
                            <h4 class="font-medium text-yellow-600 dark:text-yellow-400 mb-3 flex items-center gap-2">
                                <i class="ti ti-user-check"></i> Player Assignments
                            </h4>
                            <div id="assignments-{{ outer_loop.index0 }}" class="space-y-4">
                                {% for ord in order.orders %}
                                <div class="player-assignment">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Order #{{ ord.order.order_id }}:</label>

                                    <!-- Current Assignment Display -->
                                    <div class="current-assignment hidden mb-2" id="current-assignment-{{ outer_loop.index0 }}-{{ loop.index0 }}">
                                        <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg p-3">
                                            <div class="flex justify-between items-center">
                                                <div class="flex items-center gap-2 text-green-700 dark:text-green-300">
                                                    <i class="ti ti-check-circle"></i>
                                                    <span class="assignment-text"></span>
                                                </div>
                                                <button type="button" class="js-remove-assignment px-3 py-1 text-sm border border-red-300 text-red-600 rounded hover:bg-red-50 dark:hover:bg-red-900/30"
                                                        data-action="remove-assignment" data-issue-id="{{ outer_loop.index0 }}" data-order-index="{{ loop.index0 }}">
                                                    <i class="ti ti-x mr-1"></i>Remove
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Assignment Selection -->
                                    <div class="assignment-selection" id="assignment-selection-{{ outer_loop.index0 }}-{{ loop.index0 }}">
                                        <select class="assignment-select w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm focus:border-ecs-green focus:ring-ecs-green"
                                                data-issue-id="{{ outer_loop.index0 }}" data-order-index="{{ loop.index0 }}">
                                            <option value="">Select Assignment...</option>
                                            <option value="new">Create New Player Profile</option>
                                            <option value="search">Assign to Existing Player</option>
                                        </select>
                                    </div>

                                    <!-- New Player Creation Form -->
                                    <div class="hidden mt-2" id="create-new-{{ outer_loop.index0 }}-{{ loop.index0 }}">
                                        <div class="border-2 border-green-500 rounded-lg overflow-hidden">
                                            <div class="bg-green-500 text-white px-4 py-2">
                                                <h6 class="font-medium flex items-center gap-2">
                                                    <i class="ti ti-user-plus"></i>
                                                    Create New Player from WooCommerce Order
                                                </h6>
                                            </div>
                                            <div class="p-4">
                                                <div class="mb-3">
                                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Player Name *</label>
                                                    <input type="text" class="new-player-name w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm focus:border-ecs-green focus:ring-ecs-green"
                                                           value="{{ ord.player_info.name }}" required>
                                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Pre-filled from WooCommerce order - edit if needed</p>
                                                </div>
                                                <div class="flex justify-end gap-2">
                                                    <button class="js-create-player-form px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm"
                                                            data-action="create-player-form" data-issue-id="{{ outer_loop.index0 }}" data-order-index="{{ loop.index0 }}">
                                                        <i class="ti ti-plus mr-1"></i>Create Player
                                                    </button>
                                                    <button class="js-cancel-creation px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 text-sm"
                                                            data-action="cancel-creation" data-issue-id="{{ outer_loop.index0 }}" data-order-index="{{ loop.index0 }}">Cancel</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Player Search Form -->
                                    <div class="hidden mt-2" id="search-{{ outer_loop.index0 }}-{{ loop.index0 }}">
                                        <div class="border-2 border-blue-500 rounded-lg overflow-hidden">
                                            <div class="bg-blue-500 text-white px-4 py-2">
                                                <h6 class="font-medium flex items-center gap-2">
                                                    <i class="ti ti-search"></i>
                                                    Search Existing Players
                                                </h6>
                                            </div>
                                            <div class="p-4">
                                                <div class="mb-3">
                                                    <input type="text" class="player-search js-player-search w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm focus:border-ecs-green focus:ring-ecs-green"
                                                           data-issue-id="{{ outer_loop.index0 }}" data-order-index="{{ loop.index0 }}"
                                                           placeholder="Search by name, email, or phone...">
                                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Type at least 2 characters to search</p>
                                                </div>
                                                <div class="search-results" id="search-results-{{ outer_loop.index0 }}-{{ loop.index0 }}"></div>
                                                <div class="flex justify-end mt-2">
                                                    <button class="js-cancel-search px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 text-sm"
                                                            data-action="cancel-search" data-issue-id="{{ outer_loop.index0 }}" data-order-index="{{ loop.index0 }}">Cancel</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="js-resolve-multi-order mt-4 px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                                    data-action="resolve-multi-order" data-issue-id="{{ outer_loop.index0 }}">
                                <i class="ti ti-check mr-1"></i> Save Assignments
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-12">
                    <i class="ti ti-circle-check text-green-500 text-5xl"></i>
                    <h4 class="text-xl font-semibold text-green-600 dark:text-green-400 mt-4">No Multi-Person Orders!</h4>
                    <p class="text-gray-500 dark:text-gray-400">All orders have single assignments.</p>
                </div>
                {% endif %}
            </div>

            <!-- New Players Tab -->
            <div class="sync-tab-pane hidden p-6" id="new-players" data-tab-pane>
                {% if sync_data.new_players|length > 0 %}
                <div class="bg-blue-50 dark:bg-blue-900/30 border-l-4 border-blue-400 p-4 rounded-r-lg mb-6">
                    <div class="flex items-start gap-3">
                        <i class="ti ti-info-circle text-blue-500 text-xl mt-0.5"></i>
                        <div>
                            <h4 class="font-semibold text-blue-800 dark:text-blue-200">New Players Found</h4>
                            <p class="text-blue-700 dark:text-blue-300 text-sm">These players were not found in the database. Verify they are legitimate new registrations.</p>
                        </div>
                    </div>
                </div>

                {% for player in sync_data.new_players %}
                <div class="issue-card border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-4" data-issue-type="new-player" data-issue-id="{{ loop.index0 }}">
                    <div class="flex items-center gap-2 mb-4">
                        <i class="ti ti-user-plus text-blue-500"></i>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ player.info.name }}</h3>
                        <span class="px-2 py-1 text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 rounded-full">New Player</span>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium text-blue-600 dark:text-blue-400 mb-3 flex items-center gap-2">
                                <i class="ti ti-info-circle"></i> Player Information
                            </h4>
                            <dl class="space-y-2 text-sm">
                                <div class="flex"><dt class="w-24 font-medium text-gray-600 dark:text-gray-400">Email:</dt><dd class="text-gray-900 dark:text-white">{{ player.info.email }}</dd></div>
                                <div class="flex"><dt class="w-24 font-medium text-gray-600 dark:text-gray-400">Phone:</dt><dd class="text-gray-900 dark:text-white">{{ player.info.phone or 'Not provided' }}</dd></div>
                                <div class="flex"><dt class="w-24 font-medium text-gray-600 dark:text-gray-400">League:</dt><dd class="text-gray-900 dark:text-white">{{ player.league_name or 'Unknown' }}</dd></div>
                                <div class="flex"><dt class="w-24 font-medium text-gray-600 dark:text-gray-400">Jersey Size:</dt><dd class="text-gray-900 dark:text-white">{{ player.jersey_size or 'Not provided' }}</dd></div>
                                <div class="flex"><dt class="w-24 font-medium text-gray-600 dark:text-gray-400">Order:</dt><dd class="text-gray-900 dark:text-white">#{{ player.order_id }}</dd></div>
                            </dl>
                            {% if player.reason %}
                            <div class="mt-3 p-2 bg-yellow-50 dark:bg-yellow-900/30 rounded text-yellow-700 dark:text-yellow-300 text-sm">
                                <i class="ti ti-alert-triangle mr-1"></i>{{ player.reason }}
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            <h4 class="font-medium text-yellow-600 dark:text-yellow-400 mb-3 flex items-center gap-2">
                                <i class="ti ti-tools"></i> Resolution Options
                            </h4>
                            <div class="space-y-2">
                                <button class="js-create-new-player w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-left"
                                        data-action="create-new-player" data-issue-id="{{ loop.index0 }}">
                                    <i class="ti ti-user-plus mr-2"></i> Create New Player Profile
                                </button>
                                <button class="js-search-existing w-full px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 text-left"
                                        data-action="search-existing" data-issue-id="{{ loop.index0 }}">
                                    <i class="ti ti-search mr-2"></i> Search for Existing Player
                                </button>
                                <button class="js-flag-invalid w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-left"
                                        data-action="flag-invalid" data-issue-id="{{ loop.index0 }}">
                                    <i class="ti ti-x mr-2"></i> Mark as Invalid Order
                                </button>
                            </div>
                            <div class="hidden mt-3" id="player-search-{{ loop.index0 }}">
                                <input type="text" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm focus:border-ecs-green focus:ring-ecs-green"
                                       placeholder="Search existing players...">
                                <div class="search-results mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-12">
                    <i class="ti ti-circle-check text-green-500 text-5xl"></i>
                    <h4 class="text-xl font-semibold text-green-600 dark:text-green-400 mt-4">No New Players!</h4>
                    <p class="text-gray-500 dark:text-gray-400">All players were found in the existing database.</p>
                </div>
                {% endif %}
            </div>

            <!-- Email Mismatches Tab -->
            <div class="sync-tab-pane hidden p-6" id="email-mismatches" data-tab-pane>
                {% if sync_data.email_mismatch_players|length > 0 %}
                <div class="bg-red-50 dark:bg-red-900/30 border-l-4 border-red-400 p-4 rounded-r-lg mb-6">
                    <div class="flex items-start gap-3">
                        <i class="ti ti-mail-x text-red-500 text-xl mt-0.5"></i>
                        <div>
                            <h4 class="font-semibold text-red-800 dark:text-red-200">Email Address Conflicts</h4>
                            <p class="text-red-700 dark:text-red-300 text-sm">These players were matched but have different email addresses between the database and WooCommerce.</p>
                        </div>
                    </div>
                </div>

                {% for player in sync_data.email_mismatch_players %}
                <div class="issue-card border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-4" data-issue-type="email-mismatch" data-issue-id="{{ loop.index0 }}">
                    <div class="flex flex-col md:flex-row justify-between gap-4 mb-4">
                        <div class="flex items-center gap-2">
                            <i class="ti ti-mail-x text-red-500"></i>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ player.existing_player.name }}</h3>
                            <span class="px-2 py-1 text-xs bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 rounded-full">Email Mismatch</span>
                        </div>
                        <a href="/players/profile/{{ player.existing_player.id }}" target="_blank"
                           class="inline-flex items-center gap-1 px-3 py-1 text-sm border border-ecs-green text-ecs-green rounded-lg hover:bg-ecs-green hover:text-white">
                            <i class="ti ti-external-link"></i> View Profile
                        </a>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="font-medium text-blue-600 dark:text-blue-400 flex items-center gap-2">
                                <i class="ti ti-search"></i> Match Analysis
                            </h4>

                            <!-- Database Player Info -->
                            <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4">
                                <h5 class="font-medium text-blue-700 dark:text-blue-300 mb-2 flex items-center gap-2">
                                    <i class="ti ti-database"></i> Database Player:
                                </h5>
                                <div class="text-sm space-y-1">
                                    <p><strong>Name:</strong> {{ player.existing_player.name }}</p>
                                    <p><strong>Email:</strong> <code class="text-green-600 dark:text-green-400">{{ player.existing_player.discord_email }}</code></p>
                                    <p><strong>Phone:</strong> {{ player.existing_player.phone or 'Not provided' }}</p>
                                </div>
                            </div>

                            <!-- WooCommerce Order Info -->
                            <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-lg p-4">
                                <h5 class="font-medium text-yellow-700 dark:text-yellow-300 mb-2 flex items-center gap-2">
                                    <i class="ti ti-shopping-cart"></i> WooCommerce Order:
                                </h5>
                                <div class="text-sm space-y-1">
                                    <p><strong>Name:</strong> {{ player.order_info.woo_name }}</p>
                                    <p><strong>Email:</strong> <code class="text-yellow-600 dark:text-yellow-400">{{ player.order_info.woo_email }}</code></p>
                                    <p><strong>Phone:</strong> {{ player.order_info.woo_phone or 'Not provided' }}</p>
                                    <p><strong>Jersey Size:</strong> {{ player.order_info.jersey_size or 'Not provided' }}</p>
                                    <p><strong>Order ID:</strong> #{{ player.order_info.order_id }}</p>
                                </div>
                            </div>

                            <!-- Match Badges -->
                            <div class="flex flex-wrap gap-2">
                                {% if player.existing_player.name|lower == player.order_info.woo_name|lower %}
                                <span class="px-2 py-1 text-xs bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 rounded-full"><i class="ti ti-check mr-1"></i>Name Match</span>
                                {% else %}
                                <span class="px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-full"><i class="ti ti-x mr-1"></i>Name Similar</span>
                                {% endif %}
                                <span class="px-2 py-1 text-xs bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 rounded-full"><i class="ti ti-mail-x mr-1"></i>Email Mismatch</span>
                                <span class="px-2 py-1 text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 rounded-full">Confidence: {{ (player.match_details.confidence * 100)|round|int }}%</span>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium text-yellow-600 dark:text-yellow-400 mb-3 flex items-center gap-2">
                                <i class="ti ti-tools"></i> Resolution Options
                            </h4>
                            <div class="space-y-2">
                                <button class="js-confirm-match w-full px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 text-left"
                                        data-action="confirm-match" data-issue-id="{{ loop.index0 }}">
                                    <i class="ti ti-check-circle mr-2"></i> Confirm This Match
                                    <span class="block text-xs opacity-80 mt-1">Keep database email as authoritative</span>
                                </button>
                                <button class="js-create-separate w-full px-4 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 text-left"
                                        data-action="create-separate" data-issue-id="{{ loop.index0 }}">
                                    <i class="ti ti-user-plus mr-2"></i> Create Separate Player
                                    <span class="block text-xs opacity-80 mt-1">These are different people</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-12">
                    <i class="ti ti-circle-check text-green-500 text-5xl"></i>
                    <h4 class="text-xl font-semibold text-green-600 dark:text-green-400 mt-4">No Email Mismatches!</h4>
                    <p class="text-gray-500 dark:text-gray-400">All player emails match between database and WooCommerce.</p>
                </div>
                {% endif %}
            </div>

            <!-- Existing Players Tab -->
            <div class="sync-tab-pane hidden p-6" id="existing-players" data-tab-pane>
                {% if sync_data.player_league_updates|length > 0 %}
                <div class="bg-blue-50 dark:bg-blue-900/30 border-l-4 border-blue-400 p-4 rounded-r-lg mb-6">
                    <div class="flex items-start gap-3">
                        <i class="ti ti-user-check text-blue-500 text-xl mt-0.5"></i>
                        <div>
                            <h4 class="font-semibold text-blue-800 dark:text-blue-200">Existing Players Found</h4>
                            <p class="text-blue-700 dark:text-blue-300 text-sm">These players already exist in the database and will have their status updated (active/inactive only).</p>
                        </div>
                    </div>
                </div>

                {% for update in sync_data.player_league_updates %}
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-3">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <div>
                            <h5 class="font-medium text-gray-900 dark:text-white flex items-center gap-2">
                                <i class="ti ti-user-check text-green-500"></i>
                                {{ update.buyer_info.name }}
                            </h5>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                <i class="ti ti-mail mr-1"></i>{{ update.buyer_info.email }}<br>
                                <i class="ti ti-phone mr-1"></i>{{ update.buyer_info.phone }}
                            </p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-900 dark:text-white">Order #{{ update.order_id }}</span><br>
                            <span class="text-sm text-gray-500 dark:text-gray-400">Qty: {{ update.quantity }}</span>
                        </div>
                        <div class="text-right">
                            <span class="px-2 py-1 text-xs bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 rounded-full">{{ update.match_type }}</span>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Confidence: {{ "%.0f"|format(update.confidence * 100) }}%</p>
                            {% if update.name_updated %}
                            <span class="px-2 py-1 text-xs bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300 rounded-full mt-1 inline-block">Name Updated</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-12">
                    <i class="ti ti-users text-gray-400 text-5xl"></i>
                    <h4 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mt-4">No Existing Players Found</h4>
                    <p class="text-gray-500 dark:text-gray-400">All orders are for new players or flagged for review.</p>
                </div>
                {% endif %}
            </div>

            <!-- Inactive Players Tab -->
            <div class="sync-tab-pane hidden p-6" id="inactive-players" data-tab-pane>
                {% if sync_data.players_to_inactivate|length > 0 %}
                <div class="bg-yellow-50 dark:bg-yellow-900/30 border-l-4 border-yellow-400 p-4 rounded-r-lg mb-6">
                    <div class="flex items-start gap-3">
                        <i class="ti ti-user-off text-yellow-500 text-xl mt-0.5"></i>
                        <div>
                            <h4 class="font-semibold text-yellow-800 dark:text-yellow-200">Players to Mark Inactive</h4>
                            <p class="text-yellow-700 dark:text-yellow-300 text-sm">These players are currently active but have no current WooCommerce membership orders. They will be marked as inactive.</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-600 dark:text-gray-400">
                        <strong>{{ sync_data.players_to_inactivate|length }}</strong> players will be marked inactive
                    </span>
                    <label class="inline-flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="confirmInactiveProcess" checked
                               class="rounded border-gray-300 dark:border-gray-600 text-ecs-green focus:ring-ecs-green">
                        <span class="font-medium text-gray-700 dark:text-gray-300">Proceed with marking these players inactive</span>
                    </label>
                </div>

                {% for player in sync_data.players_to_inactivate %}
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-3">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <div>
                            <h5 class="font-medium text-gray-900 dark:text-white flex items-center gap-2">
                                <i class="ti ti-user-off text-yellow-500"></i>
                                {{ player.player_name }}
                            </h5>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                <i class="ti ti-user mr-1"></i>Username: {{ player.username }}<br>
                                <i class="ti ti-shield mr-1"></i>League: {{ player.league_name }}
                            </p>
                        </div>
                        <div class="text-center">
                            <span class="px-2 py-1 text-xs bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 rounded-full">Currently Active</span>
                            <div class="my-2"><i class="ti ti-arrow-down text-yellow-500"></i></div>
                            <span class="px-2 py-1 text-xs bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300 rounded-full">Will be Inactive</span>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                <i class="ti ti-info-circle mr-1"></i>{{ player.reason }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-12">
                    <i class="ti ti-circle-check text-green-500 text-5xl"></i>
                    <h4 class="text-xl font-semibold text-green-600 dark:text-green-400 mt-4">No Players to Mark Inactive!</h4>
                    <p class="text-gray-500 dark:text-gray-400">All currently active players have current WooCommerce memberships.</p>
                </div>
                {% endif %}
            </div>

            <!-- Final Review Tab -->
            <div class="sync-tab-pane hidden p-6" id="summary" data-tab-pane>
                <div id="commitValidation">
                    <div class="bg-yellow-50 dark:bg-yellow-900/30 border-l-4 border-yellow-400 p-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="ti ti-alert-circle text-yellow-500 text-xl mt-0.5"></i>
                            <div>
                                <h4 class="font-semibold text-yellow-800 dark:text-yellow-200">Issues Require Resolution</h4>
                                <p class="text-yellow-700 dark:text-yellow-300 text-sm">Please resolve all outstanding issues in the previous tabs before committing changes.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hidden" id="readyToCommit">
                    <div class="text-center mb-6">
                        <i class="ti ti-circle-check text-green-500 text-5xl"></i>
                        <h3 class="text-2xl font-semibold text-green-600 dark:text-green-400 mt-4">Ready to Commit Changes!</h3>
                        <p class="text-gray-600 dark:text-gray-400 mt-2">All issues have been resolved. The following changes will be applied to your database:</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="border-l-4 border-green-500 bg-white dark:bg-gray-800 rounded-r-lg p-4">
                            <h4 class="font-semibold text-green-600 dark:text-green-400 mb-2 flex items-center gap-2">
                                <i class="ti ti-users"></i> Player Updates
                            </h4>
                            <ul id="playerUpdatesSummary" class="text-sm space-y-1 text-gray-600 dark:text-gray-400"></ul>
                        </div>
                        <div class="border-l-4 border-blue-500 bg-white dark:bg-gray-800 rounded-r-lg p-4">
                            <h4 class="font-semibold text-blue-600 dark:text-blue-400 mb-2 flex items-center gap-2">
                                <i class="ti ti-toggle-left"></i> Status Changes
                            </h4>
                            <ul id="statusChangesSummary" class="text-sm space-y-1 text-gray-600 dark:text-gray-400"></ul>
                        </div>
                    </div>

                    <label class="flex items-center gap-3 mb-6 cursor-pointer">
                        <input type="checkbox" id="processInactiveCheck" checked
                               class="rounded border-gray-300 dark:border-gray-600 text-ecs-green focus:ring-ecs-green">
                        <div>
                            <span class="font-medium text-gray-700 dark:text-gray-300">Update Player Status Automatically</span>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Mark players WITHOUT current memberships as inactive, and activate those WITH memberships</p>
                        </div>
                    </label>

                    <button class="js-commit-changes px-8 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium"
                            id="finalCommitBtn" data-action="commit-changes">
                        <i class="ti ti-database-import mr-2"></i> Commit All Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Player Search Modal -->
{% call modal_info('playerSearchModal', 'Search for Existing Player', size='lg', footer=false) %}
<input type="text" id="playerSearchInput"
       class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:border-ecs-green focus:ring-ecs-green mb-4"
       placeholder="Type to search players by name or email...">
<div id="playerSearchResults"></div>
{% endcall %}
{% endblock %}

{% block custom_js %}
{{ super() }}
<script src="{{ url_for('static', filename='custom_js/sync-review.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching functionality
    document.querySelectorAll('.sync-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const targetId = this.dataset.tab;

            // Update tab styles
            document.querySelectorAll('.sync-tab').forEach(t => {
                t.classList.remove('border-ecs-green', 'text-ecs-green');
                t.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
            });
            this.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');
            this.classList.add('border-ecs-green', 'text-ecs-green');

            // Show/hide tab panes
            document.querySelectorAll('.sync-tab-pane').forEach(pane => {
                pane.classList.add('hidden');
            });
            document.getElementById(targetId).classList.remove('hidden');
        });
    });

    // Initialize sync review module with server data
    if (typeof initSyncReview === 'function') {
        initSyncReview(
            {{ sync_data|tojson }},
            "{{ task_id }}",
            "{{ csrf_token() }}"
        );
    }
});
</script>
{% endblock %}
