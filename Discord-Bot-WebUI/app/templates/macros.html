{% macro render_report_match_modal(match, player_choices) %}
<div class="modal fade ecs-modal"
     id="reportMatchModal-{{ match.id }}"
     tabindex="-1"
     role="dialog"
     aria-labelledby="reportMatchModalLabel-{{ match.id }}"
     aria-hidden="true"
     data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered ecs-modal-dialog ecs-modal-lg ecs-modal-dialog-centered" role="document">
        <div class="modal-content ecs-modal-content">
            <!-- Modal Header -->
            <div class="modal-header bg-primary text-white ecs-modal-header">
                <h5 class="modal-title ecs-modal-title" id="reportMatchModalLabel-{{ match.id }}">
                    <i data-feather="edit" class="me-2"></i>
                    {{ 'Edit' if match.reported else 'Report' }} Match: 
                    <span class="home-team-name">{{ match.home_team.name if match.home_team else match.home_team_name }}</span> 
                    vs 
                    <span class="away-team-name">{{ match.away_team.name if match.away_team else match.away_team_name }}</span>
                </h5>
                <button type="button"
                        class="btn-close btn-close-white ecs-modal-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <form id="reportMatchForm-{{ match.id }}" class="report-match-form" data-match-id="{{ match.id }}" action="{{ url_for('teams.report_match', match_id=match.id) }}" method="POST" novalidate>
                <div class="modal-body ecs-modal-body">
                    <!-- CSRF Token -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <!-- Home and Away Team Scores -->
                    <div class="row mb-4">
                        <!-- Home Team Score -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="home_team_score-{{ match.id }}" class="form-label">{{ match.home_team_name }} Score</label>
                                <input type="number"
                                       min="0"
                                       class="form-control"
                                       id="home_team_score-{{ match.id }}"
                                       name="home_team_score"
                                       value="{{ match.home_team_score }}" {# Pre-fill if editing #}
                                       required />
                            </div>
                        </div>
                        <!-- Away Team Score -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="away_team_score-{{ match.id }}" class="form-label">{{ match.away_team_name }} Score</label>
                                <input type="number"
                                       min="0"
                                       class="form-control"
                                       id="away_team_score-{{ match.id }}"
                                       name="away_team_score"
                                       value="{{ match.away_team_score if match.away_team_score is not none else 0 }}"
                                       required />
                            </div>
                        </div>
                    </div>

                    <!-- Goal Scorers -->
                    <div class="mb-4">
                        <label class="form-label">Goal Scorers</label>
                        <div class="card p-3 border-1 shadow-sm">
                            <div id="goalScorersContainer-{{ match.id }}" class="mb-2">
                                {% for scorer in match.goal_scorers %}
                                <div class="input-group mb-2 player-event-entry" data-unique-id="{{ scorer.id }}">
                                    <input type="hidden" name="goal_scorers-stat_id[]" value="{{ scorer.id }}">
                                    <select class="form-select" name="goal_scorers-player_id[]">
                                        {% for team_name, players in player_choices[match.id].items() %}
                                        <optgroup label="{{ team_name }}">
                                            {% for player_id, player_name in players.items() %}
                                            <option value="{{ player_id }}" {% if scorer.player_id == player_id %}selected{% endif %}>{{ player_name }}</option>
                                            {% endfor %}
                                        </optgroup>
                                        {% endfor %}
                                    </select>
                                    <input type="text" class="form-control" name="goal_scorers-minute[]" placeholder="Minute (e.g., '45' or '45+2')" value="{{ scorer.minute }}" pattern="^\d{1,3}(\+\d{1,2})?$" title="Enter a valid minute (e.g., '45' or '45+2')">
                                    <button class="btn btn-danger" type="button" onclick="removeEvent(this)">Remove</button>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="btn btn-primary btn-sm" type="button" onclick="addEvent('{{ match.id }}', 'goalScorersContainer-{{ match.id }}')">
                                <i data-feather="plus" class="me-1"></i> Add Goal Scorer
                            </button>
                        </div>
                    </div>

                    <!-- Assist Providers -->
                    <div class="mb-4">
                        <label class="form-label">Assist Providers</label>
                        <div class="card p-3 border-1 shadow-sm">
                            <div id="assistProvidersContainer-{{ match.id }}" class="mb-2">
                                {% for assist in match.assist_providers %}
                                <div class="input-group mb-2 player-event-entry" data-unique-id="{{ assist.id }}">
                                    <input type="hidden" name="assist_providers-stat_id[]" value="{{ assist.id }}">
                                    <select class="form-select" name="assist_providers-player_id[]">
                                        {% for team_name, players in player_choices[match.id].items() %}
                                        <optgroup label="{{ team_name }}">
                                            {% for player_id, player_name in players.items() %}
                                            <option value="{{ player_id }}" {% if assist.player_id == player_id %}selected{% endif %}>{{ player_name }}</option>
                                            {% endfor %}
                                        </optgroup>
                                        {% endfor %}
                                    </select>
                                    <input type="text" class="form-control" name="assist_providers-minute[]" placeholder="Minute (e.g., '45' or '45+2')" value="{{ assist.minute }}" pattern="^\d{1,3}(\+\d{1,2})?$" title="Enter a valid minute (e.g., '45' or '45+2')">
                                    <button class="btn btn-danger" type="button" onclick="removeEvent(this)">Remove</button>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="btn btn-primary btn-sm" type="button" onclick="addEvent('{{ match.id }}', 'assistProvidersContainer-{{ match.id }}')">
                                <i data-feather="plus" class="me-1"></i> Add Assist Provider
                            </button>
                        </div>
                    </div>

                    <!-- Yellow Cards -->
                    <div class="mb-4">
                        <label class="form-label">Yellow Cards</label>
                        <div class="card p-3 border-1 shadow-sm">
                            <div id="yellowCardsContainer-{{ match.id }}" class="mb-2">
                                {% for card in match.yellow_cards %}
                                <div class="input-group mb-2 player-event-entry" data-unique-id="{{ card.id }}">
                                    <input type="hidden" name="yellow_cards-stat_id[]" value="{{ card.id }}">
                                    <select class="form-select" name="yellow_cards-player_id[]">
                                        {% for team_name, players in player_choices[match.id].items() %}
                                        <optgroup label="{{ team_name }}">
                                            {% for player_id, player_name in players.items() %}
                                            <option value="{{ player_id }}" {% if card.player_id == player_id %}selected{% endif %}>{{ player_name }}</option>
                                            {% endfor %}
                                        </optgroup>
                                        {% endfor %}
                                    </select>
                                    <input type="text" class="form-control" name="yellow_cards-minute[]" placeholder="Minute (e.g., '45' or '45+2')" value="{{ card.minute }}" pattern="^\d{1,3}(\+\d{1,2})?$" title="Enter a valid minute (e.g., '45' or '45+2')">
                                    <button class="btn btn-danger" type="button" onclick="removeEvent(this)">Remove</button>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="btn btn-primary btn-sm" type="button" onclick="addEvent('{{ match.id }}', 'yellowCardsContainer-{{ match.id }}')">
                                <i data-feather="plus" class="me-1"></i> Add Yellow Card
                            </button>
                        </div>
                    </div>

                    <!-- Red Cards -->
                    <div class="mb-4">
                        <label class="form-label">Red Cards</label>
                        <div class="card p-3 border-1 shadow-sm">
                            <div id="redCardsContainer-{{ match.id }}" class="mb-2">
                                {% for card in match.red_cards %}
                                <div class="input-group mb-2 player-event-entry" data-unique-id="{{ card.id }}">
                                    <input type="hidden" name="red_cards-stat_id[]" value="{{ card.id }}">
                                    <select class="form-select" name="red_cards-player_id[]">
                                        {% for team_name, players in player_choices[match.id].items() %}
                                        <optgroup label="{{ team_name }}">
                                            {% for player_id, player_name in players.items() %}
                                            <option value="{{ player_id }}" {% if card.player_id == player_id %}selected{% endif %}>{{ player_name }}</option>
                                            {% endfor %}
                                        </optgroup>
                                        {% endfor %}
                                    </select>
                                    <input type="text" class="form-control" name="red_cards-minute[]" placeholder="Minute (e.g., '45' or '45+2')" value="{{ card.minute }}" pattern="^\d{1,3}(\+\d{1,2})?$" title="Enter a valid minute (e.g., '45' or '45+2')">
                                    <button class="btn btn-danger" type="button" onclick="removeEvent(this)">Remove</button>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="btn btn-primary btn-sm" type="button" onclick="addEvent('{{ match.id }}', 'redCardsContainer-{{ match.id }}')">
                                <i data-feather="plus" class="me-1"></i> Add Red Card
                            </button>
                        </div>
                    </div>

                    <!-- Match Notes -->
                    <div class="mb-4">
                        <label class="form-label" for="match_notes-{{ match.id }}">Match Notes</label>
                        <textarea class="form-control" id="match_notes-{{ match.id }}" name="match_notes" rows="3">{{ match.notes }}</textarea>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer ecs-modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn-{{ match.id }}">
                        {{ 'Save Changes' if match.reported else 'Submit Report' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endmacro %}

{% macro render_player_item(player, safe_current_user, season) %}
<li class="list-group-item d-flex justify-content-between align-items-center">
    <a href="{{ url_for('players.player_profile', player_id=player.id) }}" class="d-flex align-items-center text-decoration-none">
        <img src="{{ player.profile_picture_url or url_for('static', filename='img/default_player.png') }}" alt="{{ player.name }}" class="rounded-circle border" style="width: 50px; height: 50px; margin-right: 15px;">
        <span>{{ player.name }}</span>
        {% if player.is_coach %}
        <span class="badge bg-secondary ms-2">C</span>
        {% endif %}
        {% if player.is_ref %}
        <!-- Use a valid Boxicons class for Referee -->
        <i class="bx bx-user-check" title="Referee"></i>
        {% endif %}
    </a>
    <div>
        {% if safe_current_user.has_permission('view_player_goals_assists') %}
        <span class="badge bg-light text-dark"><i class="bx bx-football"></i> {{ player.season_goals(season.id) }}</span>
        <span class="badge bg-light text-dark"><i class="bx bx-football"></i> <i class="bx bx-right-arrow-alt"></i> {{ player.season_assists(season.id) }}</span>
        {% endif %}
        {% if safe_current_user.has_permission('view_player_cards') %}
        <span class="badge bg-light text-dark"><i class="bx bxs-square text-warning"></i> {{ player.season_yellow_cards(season.id) }}</span>
        <span class="badge bg-light text-dark"><i class="bx bxs-square text-danger"></i> {{ player.season_red_cards(season.id) }}</span>
        {% endif %}
    </div>
</li>
{% endmacro %}

{% macro render_enhanced_onboarding_modal(onboarding_form, player) %}
<form method="POST"
      class="needs-validation"
      enctype="multipart/form-data"
      novalidate>
    {{ onboarding_form.hidden_tag() }} <!-- CSRF Token -->
    <!-- Hidden input to identify form action -->
    <input type="hidden" id="form_action" name="form_action" value="">

    <!-- Hidden Player ID for AJAX cropping -->
    {% if player %}
    <input type="hidden" id="playerId" value="{{ player.id }}">
    {% else %}
    <input type="hidden" id="playerId" value="">
    {% endif %}

    <!-- Progress Bar -->
    <div class="progress mb-3">
        <div id="onboardingProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div class="text-center mb-4">
        <small class="text-muted" id="currentStep">Step 1 of 5</small>
    </div>

    <!-- Carousel for Onboarding Steps -->
    <div id="modalCarouselControls" class="carousel slide" data-bs-interval="false">
        <!-- Carousel Inner -->
        <div class="carousel-inner">
            {% if not player %}
            <!-- Step 0: For Users without a Profile -->
            <div class="carousel-item active" data-step="0">
                <div class="onboarding-content text-center">
                    <div class="mb-4 d-flex justify-content-center">
                        <img src="{{ url_for('static', filename='img/undraw_questions_re_1fy7.svg') }}" alt="Welcome Image" class="img-fluid" style="max-width: 300px; height: auto;">
                    </div>
                    <div class="card bg-light p-4 mb-4">
                        <h4 class="fw-bold text-primary mb-3">Welcome to the ECS!</h4>
                        <p class="text-muted">It looks like you don't have a player profile yet. Would you like to create one?</p>
                        <div class="alert alert-warning">
                            <i class="ti ti-alert-circle me-2"></i>
                            <strong>A player profile is required for ECS FC or ECS FC Pub League!</strong>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center gap-3 mt-4">
                        <button type="button" id="createProfileCarouselButton" class="btn btn-lg btn-primary">
                            <i class="ti ti-user-plus me-2"></i>Create Profile
                        </button>
                        <button type="button" id="skipProfileButton" class="btn btn-lg btn-outline-secondary">
                            <i class="ti ti-arrow-right me-2"></i>Skip for now
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Step 1: Contact Info -->
            <div class="carousel-item {% if player %}active{% endif %}" data-step="1">
                <div class="onboarding-content">
                    <div class="section-header d-flex align-items-center mb-4">
                        <div class="me-3 text-primary">
                            <i class="ti ti-user-circle" style="font-size: 2.5rem;"></i>
                        </div>
                        <div>
                            <h4 class="fw-bold text-primary mb-1">Contact Information</h4>
                            <p class="text-muted mb-0">Tell us how to reach you</p>
                        </div>
                    </div>

                    <div class="card shadow-sm p-4 mb-4">
                        <!-- Contact Info Fields -->
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ onboarding_form.name.id }}" class="form-label">
                                    <i class="ti ti-id-badge me-1"></i>{{ onboarding_form.name.label.text }} <span class="text-danger">*</span>
                                </label>
                                {{ onboarding_form.name(class="form-control form-control-lg", required=True, placeholder="Your full name") }}
                                <div class="form-text">This will be displayed on your public profile</div>
                                {% if onboarding_form.name.errors %}
                                <div class="invalid-feedback">
                                    {{ onboarding_form.name.errors[0] }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ onboarding_form.email.id }}" class="form-label">
                                    <i class="ti ti-mail me-1"></i>{{ onboarding_form.email.label.text }} <span class="text-danger">*</span>
                                </label>
                                {{ onboarding_form.email(class="form-control form-control-lg", required=True, placeholder="email@example.com") }}
                                <div class="form-text">Used for match notifications and team communications</div>
                                {% if onboarding_form.email.errors %}
                                <div class="invalid-feedback">
                                    {{ onboarding_form.email.errors[0] }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ onboarding_form.phone.id }}" class="form-label">
                                    <i class="ti ti-phone me-1"></i>{{ onboarding_form.phone.label.text }} <span class="text-danger">*</span>
                                </label>
                                {{ onboarding_form.phone(class="form-control form-control-lg", required=True, placeholder="(555) 555-5555") }}
                                <div class="form-text">Used for emergency contacts and optional SMS notifications</div>
                                {% if onboarding_form.phone.errors %}
                                <div class="invalid-feedback">
                                    {{ onboarding_form.phone.errors[0] }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Profile Picture -->
            <div class="carousel-item" data-step="2">
                <div class="onboarding-content">
                    <div class="section-header d-flex align-items-center mb-4">
                        <div class="me-3 text-primary">
                            <i class="ti ti-camera" style="font-size: 2.5rem;"></i>
                        </div>
                        <div>
                            <h4 class="fw-bold text-primary mb-1">Profile Picture</h4>
                            <p class="text-muted mb-0">Add a photo to personalize your profile</p>
                        </div>
                    </div>

                    <div class="card shadow-sm p-4 mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-6 text-center mb-4 mb-md-0">
                                <div id="currentProfilePicture" class="mb-3">
                                    <div class="avatar-preview mx-auto" style="width: 200px; height: 200px; overflow: hidden; border-radius: 50%; border: 3px solid var(--bs-primary); box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                        <img src="{{ player.profile_picture_url or url_for('static', filename='img/default_player.png') }}"
                                            alt="Profile Picture"
                                            style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center text-md-start">
                                    <p class="mb-4">Upload a clear photo of yourself for your player profile. A good profile picture helps teammates and admins recognize you.</p>
                                    
                                    <!-- Hidden file input -->
                                    <input type="file" name="image" id="image" accept="image/*" class="form-control d-none">
                                    
                                    <!-- Button that triggers the file input -->
                                    <button type="button" class="btn btn-lg btn-primary w-100 mb-2" onclick="document.getElementById('image').click();">
                                        <i class="ti ti-upload me-1"></i> Select Image
                                    </button>
                                    
                                    <!-- The Crop & Save button -->
                                    <button type="button" class="btn btn-lg btn-success w-100" id="cropAndSaveButton" disabled>
                                        <i class="ti ti-check me-1"></i> Crop & Save
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Container for the Cropper preview -->
                        <div class="img-container d-none mt-4">
                            <div class="card p-3">
                                <h5 class="text-primary mb-3">Adjust Your Photo</h5>
                                <img id="imagecan" style="max-width: 100%; height: auto; max-height: 400px;">
                            </div>
                        </div>
                        
                        <!-- Hidden input that can store the final base64 for form submission -->
                        <input type="hidden" id="cropped_image_data" name="cropped_image_data">
                    </div>
                </div>
            </div>

            <!-- Step 3: Player Profile -->
            <div class="carousel-item" data-step="3">
                <div class="onboarding-content">
                    <div class="section-header d-flex align-items-center mb-4">
                        <div class="me-3 text-primary">
                            <i class="ti ti-soccer-field" style="font-size: 2.5rem;"></i>
                        </div>
                        <div>
                            <h4 class="fw-bold text-primary mb-1">Player Preferences</h4>
                            <p class="text-muted mb-0">Tell us about your playing preferences</p>
                        </div>
                    </div>

                    <div class="card shadow-sm p-4 mb-4">
                        <!-- Player Profile Fields -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ onboarding_form.jersey_size.id }}" class="form-label">
                                    <i class="ti ti-shirt me-1"></i>{{ onboarding_form.jersey_size.label.text }} <span class="text-danger">*</span>
                                </label>
                                {{ onboarding_form.jersey_size(class="form-select form-select-lg select2-single", required=True) }}
                                {% if onboarding_form.jersey_size.errors %}
                                <div class="invalid-feedback">
                                    {{ onboarding_form.jersey_size.errors[0] }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ onboarding_form.pronouns.id }}" class="form-label">
                                    <i class="ti ti-user me-1"></i>{{ onboarding_form.pronouns.label.text }} <span class="text-danger">*</span>
                                </label>
                                {{ onboarding_form.pronouns(class="form-select form-select-lg select2-single", required=True) }}
                                {% if onboarding_form.pronouns.errors %}
                                <div class="invalid-feedback">
                                    {{ onboarding_form.pronouns.errors[0] }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="{{ onboarding_form.favorite_position.id }}" class="form-label">
                                    <i class="ti ti-star me-1"></i>{{ onboarding_form.favorite_position.label.text }} <span class="text-danger">*</span>
                                </label>
                                {{ onboarding_form.favorite_position(class="form-select form-select-lg select2-single", required=True) }}
                                <div class="form-text">This is the position you'd most like to play</div>
                                {% if onboarding_form.favorite_position.errors %}
                                <div class="invalid-feedback">
                                    {{ onboarding_form.favorite_position.errors[0] }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ onboarding_form.other_positions.id }}" class="form-label">
                                    <i class="ti ti-list-check me-1"></i>{{ onboarding_form.other_positions.label.text }}
                                </label>
                                {{ onboarding_form.other_positions(class="form-select form-select-lg select2-multiple", multiple=True) }}
                                <div class="form-text">Other positions you're comfortable playing</div>
                                {% if onboarding_form.other_positions.errors %}
                                <div class="invalid-feedback">
                                    {{ onboarding_form.other_positions.errors[0] }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ onboarding_form.positions_not_to_play.id }}" class="form-label">
                                    <i class="ti ti-list-x me-1"></i>{{ onboarding_form.positions_not_to_play.label.text }}
                                </label>
                                {{ onboarding_form.positions_not_to_play(class="form-select form-select-lg select2-multiple", multiple=True) }}
                                <div class="form-text">Positions you prefer not to play</div>
                                {% if onboarding_form.positions_not_to_play.errors %}
                                <div class="invalid-feedback">
                                    {{ onboarding_form.positions_not_to_play.errors[0] }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ onboarding_form.expected_weeks_available.id }}" class="form-label">
                                    <i class="ti ti-calendar me-1"></i>{{ onboarding_form.expected_weeks_available.label.text }}
                                </label>
                                {{ onboarding_form.expected_weeks_available(class="form-select form-select-lg select2-single") }}
                                {% if onboarding_form.expected_weeks_available.errors %}
                                <div class="invalid-feedback">
                                    {{ onboarding_form.expected_weeks_available.errors[0] }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ onboarding_form.unavailable_dates.id }}" class="form-label">
                                    <i class="ti ti-calendar-off me-1"></i>{{ onboarding_form.unavailable_dates.label.text }}
                                </label>
                                {{ onboarding_form.unavailable_dates(class="form-control form-control-lg") }}
                                <div class="form-text">Specific dates when you know you'll be unavailable</div>
                                {% if onboarding_form.unavailable_dates.errors %}
                                <div class="invalid-feedback">
                                    {{ onboarding_form.unavailable_dates.errors[0] }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="{{ onboarding_form.player_notes.id }}" class="form-label">
                                    <i class="ti ti-notes me-1"></i>{{ onboarding_form.player_notes.label.text }}
                                </label>
                                {{ onboarding_form.player_notes(class="form-control form-control-lg", placeholder="Share any additional information that would help coaches or team managers...", rows="3") }}
                                <div class="form-text">Include any relevant information about your playing experience or special accommodations</div>
                                {% if onboarding_form.player_notes.errors %}
                                <div class="invalid-feedback">
                                    {{ onboarding_form.player_notes.errors[0] }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Discord Linking -->
            <div class="carousel-item" data-step="4">
                <div class="onboarding-content">
                    <div class="section-header d-flex align-items-center mb-4">
                        <div class="me-3 text-primary">
                            <i class="fab fa-discord" style="font-size: 2.5rem;"></i>
                        </div>
                        <div>
                            <h4 class="fw-bold text-primary mb-1">Discord Integration</h4>
                            <p class="text-muted mb-0">Connect with your team on Discord</p>
                        </div>
                    </div>

                    <div class="card shadow-sm p-4 mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-6 text-center mb-4 mb-md-0">
                                <img src="{{ url_for('static', filename='img/discord-mark-black.svg') }}" alt="Discord" class="img-fluid mb-3" style="max-width: 150px;">
                            </div>
                            <div class="col-md-6">
                                {% if player.discord_id %}
                                <div class="alert alert-success mb-4">
                                    <div class="d-flex align-items-center">
                                        <i class="ti ti-check-circle me-2 fs-3"></i>
                                        <div>
                                            <h5 class="alert-heading mb-1">Discord Connected!</h5>
                                            <p class="mb-0">Your account is already linked to Discord.</p>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <h5 class="fw-bold mb-3">Why Connect Discord?</h5>
                                <ul class="mb-4">
                                    <li>Get match notifications directly in Discord</li>
                                    <li>Communicate easily with teammates and coaches</li>
                                    <li>Access team-specific channels and information</li>
                                    <li>Verify your identity for team servers</li>
                                </ul>
                                <a href="{{ url_for('auth.discord_login') }}" class="btn btn-lg btn-primary w-100">
                                    <i class="fab fa-discord me-2"></i> Connect Discord Account
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Notification Settings -->
            <div class="carousel-item" data-step="5">
                <div class="onboarding-content">
                    <div class="section-header d-flex align-items-center mb-4">
                        <div class="me-3 text-primary">
                            <i class="ti ti-bell" style="font-size: 2.5rem;"></i>
                        </div>
                        <div>
                            <h4 class="fw-bold text-primary mb-1">Communication Preferences</h4>
                            <p class="text-muted mb-0">How would you like to be notified?</p>
                        </div>
                    </div>

                    <div class="card shadow-sm p-4 mb-4">
                        <div class="notification-group mb-4">
                            <h5 class="fw-bold mb-3">Notification Channels</h5>
                            
                            <!-- Email Notifications -->
                            <div class="card mb-3 border">
                                <div class="card-body">
                                    <div class="form-check form-switch d-flex justify-content-between align-items-center">
                                        <div>
                                            <label class="form-check-label fw-semibold" for="emailNotifications">
                                                <i class="ti ti-mail me-2 text-primary"></i>Email Notifications
                                            </label>
                                            <p class="text-muted mb-0 small">Match schedules, team updates, and important announcements</p>
                                        </div>
                                        {{ onboarding_form.email_notifications(class="form-check-input", id="emailNotifications", style="width: 3em; height: 1.5em;") }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SMS Notifications -->
                            <div class="card mb-3 border">
                                <div class="card-body">
                                    <div class="form-check form-switch d-flex justify-content-between align-items-center">
                                        <div>
                                            <label class="form-check-label fw-semibold" for="smsNotifications">
                                                <i class="ti ti-message me-2 text-primary"></i>SMS Notifications
                                            </label>
                                            <p class="text-muted mb-0 small">Game day reminders, last-minute changes, and quick RSVPs</p>
                                        </div>
                                        <input class="form-check-input" type="checkbox" id="smsNotifications" name="sms_notifications" style="width: 3em; height: 1.5em;">
                                    </div>
                                    
                                    <!-- SMS Opt-in Section (Initially hidden) -->
                                    <div id="smsOptInSection" class="mt-3" style="display: none;">
                                        <hr>
                                        <div class="alert alert-light border p-3">
                                            <h6 class="fw-bold">Verify Your Phone Number</h6>
                                            <p class="small mb-3">We'll send a verification code to confirm your phone number.</p>
                                            
                                            <div class="row">
                                                <div class="col-md-8 mb-2">
                                                    <label for="phoneNumber" class="form-label small">Phone Number</label>
                                                    <input type="tel" class="form-control" id="phoneNumber" name="phone_number" placeholder="(555) 555-5555">
                                                </div>
                                                <div class="col-md-4 mb-2 d-flex align-items-end">
                                                    <button type="button" id="sendVerificationCode" class="btn btn-primary w-100">Send Code</button>
                                                </div>
                                            </div>
                                            
                                            <div class="form-check mb-3">
                                                <input type="checkbox" class="form-check-input" id="smsConsent" name="sms_consent">
                                                <label class="form-check-label small" for="smsConsent">
                                                    I consent to receive SMS messages. Standard rates may apply.
                                                </label>
                                            </div>
                                            
                                            <!-- Verification Code Input (Initially hidden) -->
                                            <div id="verificationCodeSection" class="mt-3" style="display: none;">
                                                <div class="row">
                                                    <div class="col-md-8 mb-2">
                                                        <label for="verificationCode" class="form-label small">Verification Code</label>
                                                        <input type="text" class="form-control" id="verificationCode" name="verification_code" placeholder="Enter verification code">
                                                    </div>
                                                    <div class="col-md-4 mb-2 d-flex align-items-end">
                                                        <button type="button" id="verifyCode" class="btn btn-success w-100">Verify</button>
                                                    </div>
                                                </div>
                                                <button type="button" id="resendCode" class="btn btn-link btn-sm p-0">Resend Code</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Discord Notifications -->
                            <div class="card mb-3 border">
                                <div class="card-body">
                                    <div class="form-check form-switch d-flex justify-content-between align-items-center">
                                        <div>
                                            <label class="form-check-label fw-semibold" for="discordNotifications">
                                                <i class="fab fa-discord me-2 text-primary"></i>Discord Notifications
                                            </label>
                                            <p class="text-muted mb-0 small">Get notified in Discord channels for team communications</p>
                                        </div>
                                        {{ onboarding_form.discord_notifications(class="form-check-input", id="discordNotifications", style="width: 3em; height: 1.5em;") }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="notification-group">
                            <h5 class="fw-bold mb-3">Privacy Settings</h5>
                            
                            <!-- Profile Visibility -->
                            <div class="card border">
                                <div class="card-body">
                                    <label for="{{ onboarding_form.profile_visibility.id }}" class="form-label fw-semibold">
                                        <i class="ti ti-eye me-2 text-primary"></i>Profile Visibility
                                    </label>
                                    <p class="text-muted small mb-2">Control who can see your profile information</p>
                                    {{ onboarding_form.profile_visibility(class="form-select select2-single") }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-between mt-3" id="carouselControls">
                <button class="btn btn-lg btn-outline-secondary" type="button" data-bs-target="#modalCarouselControls" data-bs-slide="prev" id="previousButton">
                    <i class="ti ti-chevron-left me-2"></i> Previous
                </button>
                <button class="btn btn-lg btn-primary" type="button" id="nextOrSaveButton" data-bs-target="#modalCarouselControls" data-bs-slide="next">
                    Next <i class="ti ti-chevron-right ms-2"></i>
                </button>
            </div>
        </div>
    </div>
</form>

<style>
    /* Fix z-index for onboarding modal to be above everything */
    #onboardingSlideModal {
        z-index: 1080 !important;
    }
    
    /* Ensure modal backdrop is also higher z-index */
    .modal-backdrop {
        z-index: 1070 !important;
    }
    
    /* Fix content scrolling and layout */
    .onboarding-content {
        max-height: 60vh;
        overflow-y: auto;
        padding: 20px 25px;
        margin-bottom: 80px; /* Make room for buttons */
        scrollbar-width: thin;
    }
    
    .onboarding-content::-webkit-scrollbar {
        width: 6px;
    }
    
    .onboarding-content::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .onboarding-content::-webkit-scrollbar-thumb {
        background: var(--bs-primary);
        border-radius: 4px;
    }
    
    /* Fix button layout to prevent overlapping */
    #carouselControls {
        position: absolute;
        bottom: 20px;
        left: 20px;
        right: 20px;
        margin: 0;
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.95);
        z-index: 10;
        border-radius: 8px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .form-label {
        font-weight: 500;
    }
    
    .carousel-item {
        transition: transform 0.5s ease, opacity 0.5s ease;
        position: relative;
        padding-bottom: 70px;
    }
    
    /* Highlight required fields */
    .form-control:required, 
    .form-select:required {
        border-left: 3px solid var(--bs-primary);
    }
    
    /* Improve section headers */
    .section-header {
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
    }
    
    /* Modal dialog improvements */
    .modal-lg {
        max-width: 800px;
    }
    
    .modal-dialog-centered {
        display: flex;
        align-items: center;
        min-height: calc(100% - 1rem);
    }
    
    /* Mobile improvements */
    @media (max-width: 768px) {
        .onboarding-content {
            max-height: 55vh;
            padding: 15px;
            margin-bottom: 70px;
        }
        
        #carouselControls {
            padding: 10px;
            bottom: 15px;
            left: 15px;
            right: 15px;
        }
        
        #carouselControls .btn {
            width: 100%;
            padding: 8px 16px;
            font-size: 1rem;
        }
        
        .carousel-item {
            padding-bottom: 60px;
        }
    }
</style>
{% endmacro %}

{% macro render_onboarding_modal(onboarding_form, player) %}
    <!-- This macro is maintained for backward compatibility -->
    {{ render_enhanced_onboarding_modal(onboarding_form, player) }}
{% endmacro %}

{% macro render_sms_optin_modal() %}
<div class="modal fade" id="smsOptInModal" tabindex="-1" aria-labelledby="smsOptInModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="smsOptInModalLabel">Enable SMS Notifications</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Consent and Phone Number -->
                <div id="smsConsentStep">
                    <p>By providing your phone number, you consent to receive SMS notifications from ECS FC, including match reminders, RSVP confirmations, and important club announcements. Message and data rates may apply. You can opt-out at any time by replying END to any message.</p>
                    <form id="smsOptInForm">
                        <div class="mb-3">
                            <label for="phoneNumber" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phoneNumber" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="smsConsent" required>
                            <label class="form-check-label" for="smsConsent">I agree to receive SMS notifications</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Send Verification Code</button>
                    </form>
                </div>
                <!-- Step 2: Verification Code -->
                <div id="smsVerificationStep" style="display: none;">
                    <p>We sent a verification code to <span id="sentPhoneNumber"></span>. Please enter it below to confirm your opt-in.</p>
                    <form id="smsVerificationForm">
                        <div class="mb-3">
                            <label for="verificationCode" class="form-label">Verification Code</label>
                            <input type="text" class="form-control" id="verificationCode" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Verify & Enable SMS</button>
                    </form>
                    <button id="resendCodeBtn" class="btn btn-link" style="display: none;">Resend Verification Code</button>
                </div>
                <!-- Step 3: Confirmation -->
                <div id="smsConfirmationStep" style="display: none;">
                    <p>Congratulations! You've successfully opted in for SMS notifications from ECS FC.</p>
                    <p>You'll now receive important updates like match reminders, RSVP confirmations, and club announcements via text message.</p>
                    <p>Remember, you can opt-out at any time by replying END to any of our messages.</p>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}