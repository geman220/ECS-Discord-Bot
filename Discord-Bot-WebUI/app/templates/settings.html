{% extends "base.html" %}
{% import 'macros.html' as macros %}

{% block page_css %}

{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/settings.css') }}" />
{% endif %}
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Page Title -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="fw-bold py-3 mb-2">
                <i class="ti ti-settings-cog me-2 text-primary"></i>
                <span class="text-muted fw-light">Account /</span> Settings
            </h4>
            <p class="mb-0">Manage your account settings and preferences</p>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="row mb-4">
        <div class="col-12">
            <nav class="c-settings-tabs" role="navigation" aria-label="Settings navigation" data-tabs>
                <div class="c-settings-tabs__container">
                    <div class="c-settings-tabs__scroll">
                        <ul class="c-settings-tabs__list" role="tablist">
                            <li class="c-settings-tabs__item" role="presentation">
                                <button class="c-settings-tabs__trigger is-active"
                                        data-tab-trigger="account"
                                        role="tab"
                                        aria-selected="true"
                                        aria-controls="tab-account"
                                        tabindex="0">
                                    <i class="ti ti-user-circle"></i>
                                    <span>Account</span>
                                </button>
                            </li>
                            <li class="c-settings-tabs__item" role="presentation">
                                <button class="c-settings-tabs__trigger"
                                        data-tab-trigger="appearance"
                                        role="tab"
                                        aria-selected="false"
                                        aria-controls="tab-appearance"
                                        tabindex="-1">
                                    <i class="ti ti-palette"></i>
                                    <span>Appearance</span>
                                </button>
                            </li>
                            <li class="c-settings-tabs__item" role="presentation">
                                <button class="c-settings-tabs__trigger"
                                        data-tab-trigger="security"
                                        role="tab"
                                        aria-selected="false"
                                        aria-controls="tab-security"
                                        tabindex="-1">
                                    <i class="ti ti-lock"></i>
                                    <span>Security</span>
                                </button>
                            </li>
                            <li class="c-settings-tabs__item" role="presentation">
                                <button class="c-settings-tabs__trigger"
                                        data-tab-trigger="notifications"
                                        role="tab"
                                        aria-selected="false"
                                        aria-controls="tab-notifications"
                                        tabindex="-1">
                                    <i class="ti ti-bell"></i>
                                    <span>Notifications</span>
                                </button>
                            </li>
                            <li class="c-settings-tabs__item" role="presentation">
                                <button class="c-settings-tabs__trigger"
                                        data-tab-trigger="integrations"
                                        role="tab"
                                        aria-selected="false"
                                        aria-controls="tab-integrations"
                                        tabindex="-1">
                                    <i class="ti ti-plug"></i>
                                    <span>Integrations</span>
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        {% include 'settings/_account_tab.html' %}
        {% include 'settings/_appearance_tab.html' %}
        {% include 'settings/_security_tab.html' %}
        {% include 'settings/_notifications_tab.html' %}
        {% include 'settings/_integrations_tab.html' %}
    </div>
</div>

<!-- Enable 2FA Modal -->
<div class="c-modal modal fade" id="enable2FAModal" tabindex="-1" role="dialog" aria-labelledby="enable2FALabel" aria-hidden="true" data-modal>
    <div class="c-modal__dialog c-modal__dialog--lg modal-dialog modal-lg" role="document">
        <div class="c-modal__content modal-content">
            <div class="c-modal__header">
                <h5 class="c-modal__title" id="enable2FALabel">
                    <i class="ti ti-shield"></i>
                    <span>Enable Two-Factor Authentication</span>
                </h5>
                <button type="button"
                        class="c-modal__close"
                        data-bs-dismiss="modal"
                        data-action="close-modal"
                        aria-label="Close">
                    <i class="ti ti-x"></i>
                </button>
            </div>
            <div class="c-modal__body">
                <div class="c-2fa-setup">
                    <div class="c-2fa-setup__qr" id="qrCodeContainer"></div>

                    <div class="c-alert c-alert--info" role="alert" data-alert>
                        <div class="c-alert__icon">
                            <i class="ti ti-info-circle"></i>
                        </div>
                        <div class="c-alert__content">
                            <h6 class="c-alert__title">How to set up:</h6>
                            <ol class="c-alert__list">
                                <li>Download an authenticator app like Google Authenticator or Authy</li>
                                <li>Scan the QR code with your app</li>
                                <li>Enter the 6-digit code from your app below</li>
                            </ol>
                        </div>
                    </div>

                    <form id="verify2FAForm" class="c-form-modern" data-form="verify-2fa">
                        <div class="c-form-modern__group">
                            <label for="twoFactorCode" class="c-form-modern__label">
                                Verification Code
                            </label>
                            <input type="text"
                                   class="c-form-modern__input c-form-modern__input--2fa"
                                   id="twoFactorCode"
                                   required
                                   placeholder="Enter 6-digit code"
                                   maxlength="6"
                                   pattern="[0-9]{6}"
                                   inputmode="numeric"
                                   autocomplete="off"
                                   aria-label="Enter 6-digit verification code">
                            <div class="c-form-modern__feedback c-form-modern__feedback--invalid" role="alert">
                                Please enter a valid 6-digit code
                            </div>
                        </div>
                        <button type="submit" class="c-btn-modern c-btn-modern--primary">
                            <i class="ti ti-shield-check"></i>
                            <span>Verify and Enable 2FA</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SMS Opt-in Modal -->
<div class="c-modal modal fade" id="smsOptInModal" tabindex="-1" role="dialog" aria-labelledby="smsOptInModalLabel" aria-hidden="true" data-modal>
    <div class="c-modal__dialog modal-dialog modal-dialog-centered c-modal__dialog--centered" role="document">
        <div class="c-modal__content modal-content">
            <div class="c-modal__header">
                <h5 class="c-modal__title" id="smsOptInModalLabel">
                    <i class="ti ti-message-text"></i>
                    <span>Enable SMS Notifications</span>
                </h5>
                <button type="button"
                        class="c-modal__close"
                        data-bs-dismiss="modal"
                        data-action="close-modal"
                        aria-label="Close">
                    <i class="ti ti-x"></i>
                </button>
            </div>
            <div class="c-modal__body">
                <!-- SMS Consent Step -->
                <div id="smsConsentStep" class="c-sms-setup">
                    <form id="smsOptInForm" class="c-form-modern" data-form="sms-opt-in">
                        <div class="c-form-modern__group">
                            <label for="phoneNumber" class="c-form-modern__label">
                                Phone Number
                            </label>
                            <input type="tel"
                                   class="c-form-modern__input"
                                   id="phoneNumber"
                                   required
                                   value="{{ safe_current_user.player.phone if safe_current_user.player else '' }}"
                                   placeholder="Enter your phone number"
                                   autocomplete="tel">
                            <div class="c-form-modern__help">Format: +1XXXXXXXXXX or just 10 digits for US</div>
                            <div class="c-form-modern__feedback c-form-modern__feedback--invalid" role="alert">
                                Please enter a valid phone number
                            </div>
                        </div>

                        <div class="c-form-modern__group">
                            <div class="c-form-modern__checkbox">
                                <input type="checkbox"
                                       class="c-form-modern__checkbox-input"
                                       id="smsConsent"
                                       required>
                                <label class="c-form-modern__checkbox-label" for="smsConsent">
                                    I consent to receive text messages from ECS FC about team updates, schedule changes, and important announcements.
                                    Standard message and data rates may apply. You can opt out at any time by texting STOP or updating your preferences.
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="c-btn-modern c-btn-modern--primary">
                            <i class="ti ti-send"></i>
                            <span>Send Verification Code</span>
                        </button>
                    </form>
                </div>

                <!-- SMS Verification Step -->
                <div id="smsVerificationStep" class="c-sms-setup is-hidden">
                    <div class="c-alert c-alert--info" role="alert" data-alert>
                        <div class="c-alert__icon">
                            <i class="ti ti-info-circle"></i>
                        </div>
                        <div class="c-alert__content">
                            <p class="c-alert__message">
                                Verification code sent to <strong id="sentPhoneNumber"></strong>
                            </p>
                        </div>
                    </div>

                    <form id="smsVerificationForm" class="c-form-modern" data-form="sms-verify">
                        <div class="c-form-modern__group">
                            <label for="verificationCode" class="c-form-modern__label">
                                Verification Code
                            </label>
                            <input type="text"
                                   class="c-form-modern__input c-form-modern__input--2fa"
                                   id="verificationCode"
                                   required
                                   placeholder="Enter 6-digit code"
                                   maxlength="6"
                                   pattern="[0-9]{6}"
                                   inputmode="numeric"
                                   autocomplete="off">
                            <div class="c-form-modern__feedback c-form-modern__feedback--invalid" role="alert">
                                Please enter a valid 6-digit code
                            </div>
                        </div>

                        <div class="c-form-modern__actions">
                            <button type="submit" class="c-btn-modern c-btn-modern--primary">
                                <i class="ti ti-check"></i>
                                <span>Verify Code</span>
                            </button>
                            <button type="button"
                                    id="resendCodeBtn"
                                    class="c-btn-modern c-btn-modern--secondary is-hidden js-resend-code"
                                    data-action="resend-code">
                                <i class="ti ti-refresh"></i>
                                <span>Resend Code</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- SMS Confirmation Step -->
                <div id="smsConfirmationStep" class="c-sms-setup is-hidden">
                    <div class="c-alert c-alert--success" role="alert" data-alert>
                        <div class="c-alert__icon">
                            <i class="ti ti-check-circle"></i>
                        </div>
                        <div class="c-alert__content">
                            <h6 class="c-alert__title">Success!</h6>
                            <p class="c-alert__message">
                                SMS notifications have been successfully enabled. You'll now receive text messages for important updates.
                            </p>
                        </div>
                    </div>
                    <button type="button"
                            class="c-btn-modern c-btn-modern--primary"
                            data-action="reload-page">
                        <i class="ti ti-refresh"></i>
                        <span>Refresh Page</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="{{ url_for('static', filename='custom_js/settings-tabs.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/settings.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/handle_2fa.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/sms-verification.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/calendar-subscription.js') }}"></script>
{% endif %}
{% endblock %}
