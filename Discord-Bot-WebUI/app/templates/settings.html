{% extends "base.html" %}
{% import 'macros.html' as macros %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/features/settings.css') }}" />
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Page Title -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="fw-bold py-3 mb-2">
                <i class="ti ti-settings-cog me-2 text-primary"></i>
                <span class="text-muted fw-light">Account /</span> Settings
            </h4>
            <p class="mb-0">Manage your account settings and preferences</p>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="row mb-4">
        <div class="col-12">
            <nav class="navbar navbar-expand navbar-light bg-body-tertiary rounded-3 shadow-sm p-2 p-lg-3">
                <div class="container-fluid px-0">
                    <div class="settings-nav-scroll w-100">
                        <ul class="navbar-nav flex-row flex-nowrap" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" href="#account" data-bs-toggle="tab" data-bs-target="#tab-account" role="tab" aria-selected="true">
                                    <i class="ti ti-user-circle me-1"></i><span class="nav-link-text">Account</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#appearance" data-bs-toggle="tab" data-bs-target="#tab-appearance" role="tab" aria-selected="false">
                                    <i class="ti ti-palette me-1"></i><span class="nav-link-text">Appearance</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#security" data-bs-toggle="tab" data-bs-target="#tab-security" role="tab" aria-selected="false">
                                    <i class="ti ti-lock me-1"></i><span class="nav-link-text">Security</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#notifications" data-bs-toggle="tab" data-bs-target="#tab-notifications" role="tab" aria-selected="false">
                                    <i class="ti ti-bell me-1"></i><span class="nav-link-text">Notifications</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#integrations" data-bs-toggle="tab" data-bs-target="#tab-integrations" role="tab" aria-selected="false">
                                    <i class="ti ti-plug me-1"></i><span class="nav-link-text">Integrations</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        {% include 'settings/_account_tab.html' %}
        {% include 'settings/_appearance_tab.html' %}
        {% include 'settings/_security_tab.html' %}
        {% include 'settings/_notifications_tab.html' %}
        {% include 'settings/_integrations_tab.html' %}
    </div>
</div>

<!-- Enable 2FA Modal -->
<div class="modal fade" id="enable2FAModal" tabindex="-1" aria-labelledby="enable2FALabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="enable2FALabel">
                    <i class="ti ti-shield me-2"></i>Enable Two-Factor Authentication
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3" id="qrCodeContainer"></div>
                <div class="alert alert-info d-flex mb-3">
                    <i class="ti ti-info-circle me-2 fs-5"></i>
                    <div>
                        <strong>How to set up:</strong>
                        <ol class="mb-0 ps-3 mt-1">
                            <li>Download an authenticator app like Google Authenticator or Authy</li>
                            <li>Scan the QR code with your app</li>
                            <li>Enter the 6-digit code from your app below</li>
                        </ol>
                    </div>
                </div>
                <form id="verify2FAForm" class="mt-3">
                    <div class="mb-3">
                        <label for="twoFactorCode" class="form-label">Verification Code</label>
                        <input type="text" class="form-control verification-code-input" id="twoFactorCode" required placeholder="Enter 6-digit code">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="ti ti-shield-check me-2"></i>Verify and Enable 2FA
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- SMS Opt-in Modal -->
<div class="modal fade" id="smsOptInModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="ti ti-message-text me-2"></i>Enable SMS Notifications
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- SMS Consent Step -->
                <div id="smsConsentStep">
                    <form id="smsOptInForm">
                        <div class="mb-3">
                            <label for="phoneNumber" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phoneNumber" required
                                   value="{{ safe_current_user.player.phone if safe_current_user.player else '' }}"
                                   placeholder="Enter your phone number">
                            <div class="form-text">Format: +1XXXXXXXXXX or just 10 digits for US</div>
                        </div>
                        <div class="mb-3 form-check ms-0 ps-0">
                            <input type="checkbox" class="form-check-input ms-0" id="smsConsent" required>
                            <label class="form-check-label ms-4" for="smsConsent">
                                I consent to receive text messages from ECS FC about team updates, schedule changes, and important announcements.
                                Standard message and data rates may apply. You can opt out at any time by texting STOP or updating your preferences.
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="ti ti-send me-2"></i>Send Verification Code
                        </button>
                    </form>
                </div>

                <!-- SMS Verification Step -->
                <div id="smsVerificationStep" style="display: none;">
                    <div class="alert alert-info mb-3">
                        <i class="ti ti-info-circle me-2"></i>
                        Verification code sent to <strong id="sentPhoneNumber"></strong>
                    </div>
                    <form id="smsVerificationForm">
                        <div class="mb-3">
                            <label for="verificationCode" class="form-label">Verification Code</label>
                            <input type="text" class="form-control verification-code-input" id="verificationCode" required placeholder="Enter 6-digit code">
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="ti ti-check me-2"></i>Verify Code
                            </button>
                            <button type="button" id="resendCodeBtn" class="btn btn-outline-secondary" style="display: none;">
                                <i class="ti ti-refresh me-2"></i>Resend Code
                            </button>
                        </div>
                    </form>
                </div>

                <!-- SMS Confirmation Step -->
                <div id="smsConfirmationStep" style="display: none;">
                    <div class="alert alert-success">
                        <i class="ti ti-check-circle me-2 fs-3"></i>
                        <div>
                            <strong>Success!</strong>
                            <p class="mb-0">SMS notifications have been successfully enabled. You'll now receive text messages for important updates.</p>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="location.reload();">
                        <i class="ti ti-refresh me-2"></i>Refresh Page
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block custom_js %}
{{ super() }}
<script src="{{ url_for('static', filename='custom_js/settings-tabs.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/settings.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/handle_2fa.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/sms-verification.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/calendar-subscription.js') }}"></script>
{% endblock %}
