{% extends "base_unauthenticated_flowbite.html" %}

{% block title %}Join the Waitlist - ECS FC Pub League{% endblock %}

{% block extra_css %}
<style>
    .step-hidden { display: none; }
    .progress-step { transition: all 0.3s ease; }
    .progress-step.active { color: #1a472a; }
    .progress-step.completed { color: #1a472a; }
</style>
{% endblock %}

{% block content %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 max-w-xl mx-auto">
    <!-- Logo Section -->
    <div class="flex items-center justify-center gap-4 mb-6">
        <img src="{{ url_for('static', filename='img/ecs_logo.png') }}" alt="ECS Logo" class="h-14">
        <div class="w-px h-10 bg-gray-300 dark:bg-gray-600"></div>
        <img src="{{ url_for('static', filename='img/ecs_pl_logo.png') }}" alt="ECS FC Pub League Logo" class="h-14">
    </div>

    <!-- Header -->
    <div class="text-center mb-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Join the Waitlist</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Step <span id="currentStepNum">1</span> of 4</p>
    </div>

    <!-- Progress Bar -->
    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-6">
        <div id="progressBar" class="bg-ecs-green h-2 rounded-full transition-all duration-300" style="width: 25%"></div>
    </div>

    <!-- Progress Steps -->
    <div class="flex justify-between mb-8 text-xs">
        <div class="progress-step active flex flex-col items-center" id="step-indicator-1">
            <div class="w-8 h-8 rounded-full bg-ecs-green text-white flex items-center justify-center mb-1">
                <i class="ti ti-user"></i>
            </div>
            <span class="text-gray-600 dark:text-gray-400">Contact</span>
        </div>
        <div class="progress-step flex flex-col items-center" id="step-indicator-2">
            <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-400 flex items-center justify-center mb-1">
                <i class="ti ti-trophy"></i>
            </div>
            <span class="text-gray-400 dark:text-gray-500">League</span>
        </div>
        <div class="progress-step flex flex-col items-center" id="step-indicator-3">
            <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-400 flex items-center justify-center mb-1">
                <i class="ti ti-shirt-sport"></i>
            </div>
            <span class="text-gray-400 dark:text-gray-500">Info</span>
        </div>
        <div class="progress-step flex flex-col items-center" id="step-indicator-4">
            <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-400 flex items-center justify-center mb-1">
                <i class="ti ti-file-check"></i>
            </div>
            <span class="text-gray-400 dark:text-gray-500">Terms</span>
        </div>
    </div>

    <form method="POST" action="{{ url_for('auth.waitlist_register_with_discord') }}" id="waitlistForm" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" id="cropped_image_data" name="cropped_image_data">

        <!-- Step 1: Contact Information -->
        <div class="step" id="step1" data-step="1">
            <!-- Waitlist Notice -->
            <div class="flex items-start gap-3 p-4 mb-4 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800">
                <i class="ti ti-clock text-yellow-500 flex-shrink-0 mt-0.5"></i>
                <div>
                    <h4 class="font-medium text-yellow-800 dark:text-yellow-300">You're Joining the Waitlist</h4>
                    <p class="text-sm text-yellow-700 dark:text-yellow-400">All spots for the current season are filled, but you'll be first in line for future openings!</p>
                </div>
            </div>

            <!-- Discord Account Info -->
            <div class="flex items-start gap-3 p-4 mb-6 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800">
                <i class="ti ti-brand-discord text-indigo-500 flex-shrink-0 mt-0.5"></i>
                <div>
                    <h4 class="font-medium text-indigo-800 dark:text-indigo-300">Discord Connected</h4>
                    <p class="text-sm text-indigo-700 dark:text-indigo-400 font-medium">{{ discord_username }}</p>
                </div>
            </div>

            <!-- Full Name -->
            <div class="mb-4">
                <label for="waitlist-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Full Name <span class="text-red-500">*</span>
                </label>
                <input type="text" id="waitlist-name" name="name" placeholder="First and Last name" required
                       class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2.5 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
            </div>

            <!-- Email (readonly) -->
            <div class="mb-4">
                <label for="waitlist-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Email Address
                </label>
                <input type="email" id="waitlist-email" name="email" value="{{ discord_email }}" readonly
                       class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-600 px-3 py-2.5 text-gray-500 dark:text-gray-400 cursor-not-allowed">
            </div>

            <!-- Phone -->
            <div class="mb-4">
                <label for="waitlist-phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Phone Number <span class="text-red-500">*</span>
                </label>
                <input type="tel" id="waitlist-phone" name="phone" placeholder="(555) 555-5555" inputmode="tel" required
                       class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2.5 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
            </div>
        </div>

        <!-- Step 2: League Preference -->
        <div class="step step-hidden" id="step2" data-step="2">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <i class="ti ti-trophy text-ecs-gold"></i>
                Which league interests you?
            </h3>

            <div class="space-y-3">
                <label class="flex items-start p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-ecs-green dark:hover:border-ecs-green cursor-pointer transition-colors has-[:checked]:border-ecs-green has-[:checked]:bg-ecs-green/5">
                    <input type="radio" name="preferred_league" value="pub_league_classic" required
                           class="w-4 h-4 text-ecs-green bg-gray-100 border-gray-300 focus:ring-ecs-green dark:bg-gray-700 dark:border-gray-600 mt-0.5">
                    <div class="ml-3">
                        <span class="block font-medium text-gray-900 dark:text-white">Pub League Classic</span>
                        <span class="text-sm text-gray-500 dark:text-gray-400">Beginner-friendly - all about having fun!</span>
                    </div>
                </label>

                <label class="flex items-start p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-ecs-green dark:hover:border-ecs-green cursor-pointer transition-colors has-[:checked]:border-ecs-green has-[:checked]:bg-ecs-green/5">
                    <input type="radio" name="preferred_league" value="pub_league_premier"
                           class="w-4 h-4 text-ecs-green bg-gray-100 border-gray-300 focus:ring-ecs-green dark:bg-gray-700 dark:border-gray-600 mt-0.5">
                    <div class="ml-3">
                        <span class="block font-medium text-gray-900 dark:text-white">Pub League Premier</span>
                        <span class="text-sm text-gray-500 dark:text-gray-400">Low-intermediate recreational players</span>
                    </div>
                </label>

                <label class="flex items-start p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-ecs-green dark:hover:border-ecs-green cursor-pointer transition-colors has-[:checked]:border-ecs-green has-[:checked]:bg-ecs-green/5">
                    <input type="radio" name="preferred_league" value="not_sure"
                           class="w-4 h-4 text-ecs-green bg-gray-100 border-gray-300 focus:ring-ecs-green dark:bg-gray-700 dark:border-gray-600 mt-0.5">
                    <div class="ml-3">
                        <span class="block font-medium text-gray-900 dark:text-white">Not Sure</span>
                        <span class="text-sm text-gray-500 dark:text-gray-400">We'll help you find the right fit</span>
                    </div>
                </label>
            </div>
        </div>

        <!-- Step 3: Player Information -->
        <div class="step step-hidden" id="step3" data-step="3">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <i class="ti ti-user text-ecs-green"></i>
                Tell us about yourself
            </h3>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <!-- Jersey Size -->
                <div>
                    <label for="waitlist-jersey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jersey Size</label>
                    <select id="waitlist-jersey" name="jersey_size"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2.5 text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                        <option value="">Select size</option>
                        <option value="WS">WS</option>
                        <option value="WM">WM</option>
                        <option value="WL">WL</option>
                        <option value="WXL">WXL</option>
                        <option value="AS">AS</option>
                        <option value="AM">AM</option>
                        <option value="AL">AL</option>
                        <option value="AXL">AXL</option>
                        <option value="AXXL">AXXL</option>
                        <option value="A3XL">A3XL</option>
                    </select>
                </div>

                <!-- Pronouns -->
                <div>
                    <label for="waitlist-pronouns" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pronouns</label>
                    <select id="waitlist-pronouns" name="pronouns"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2.5 text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                        <option value="">Select pronouns</option>
                        <option value="he/him">He/Him</option>
                        <option value="she/her">She/Her</option>
                        <option value="they/them">They/Them</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <!-- Favorite Position -->
                <div>
                    <label for="waitlist-position" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Favorite Position</label>
                    <select id="waitlist-position" name="favorite_position"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2.5 text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                        <option value="">Select position</option>
                        <option value="goalkeeper">Goalkeeper</option>
                        <option value="defender">Defender</option>
                        <option value="midfielder">Midfielder</option>
                        <option value="forward">Forward</option>
                        <option value="no_preference">No Preference</option>
                    </select>
                </div>

                <!-- Willingness to Play Goal -->
                <div>
                    <label for="waitlist-goal" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Play Goal?</label>
                    <select id="waitlist-goal" name="frequency_play_goal"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2.5 text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                        <option value="">Select</option>
                        <option value="0">Never</option>
                        <option value="1">Only if needed</option>
                        <option value="2">I'll fill in</option>
                        <option value="4">Every game</option>
                    </select>
                </div>
            </div>

            <!-- Expected Availability -->
            <div class="mb-4">
                <label for="waitlist-weeks" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Expected Availability</label>
                <select id="waitlist-weeks" name="expected_weeks_available"
                        class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2.5 text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                    <option value="">Select availability</option>
                    <option value="1-2">1-2 weeks per season</option>
                    <option value="3-4">3-4 weeks per season</option>
                    <option value="5-6">5-6 weeks per season</option>
                    <option value="7-8">7-8 weeks per season</option>
                    <option value="9-10">9-10 weeks per season</option>
                </select>
            </div>

            <!-- Subbing Checkbox -->
            <div class="flex items-center mb-4">
                <input type="checkbox" id="waitlist-subbing" name="available_for_subbing" value="true" checked
                       class="w-4 h-4 text-ecs-green bg-gray-100 border-gray-300 rounded focus:ring-ecs-green dark:bg-gray-700 dark:border-gray-600">
                <label for="waitlist-subbing" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                    I'm interested in substitute opportunities while on the waitlist
                </label>
            </div>
        </div>

        <!-- Step 4: Terms & Submit -->
        <div class="step step-hidden" id="step4" data-step="4">
            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 mb-4">
                <div class="p-4 border-b border-gray-200 dark:border-gray-600">
                    <h4 class="font-semibold text-gray-900 dark:text-white">Terms & Conditions</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Please read and accept our liability waiver and code of conduct.</p>
                </div>
                <div class="p-4 max-h-48 overflow-y-auto text-sm text-gray-600 dark:text-gray-400 space-y-4">
                    <div>
                        <h5 class="font-semibold text-gray-900 dark:text-white mb-2">Waiver of Liability</h5>
                        <p>"Participant" hereby releases, waives, discharges and covenants not to sue ECS Pub League from any and all liability, claims, demands, actions and causes of action whatsoever arising out of or related to any loss, damage, or injury, including death, that may be sustained by Participant while participating in athletic activities.</p>
                        <p class="mt-2">Participant is fully aware of risks and hazards connected with the proposed soccer activity and VOLUNTARILY ASSUMES FULL RESPONSIBILITY FOR ANY RISKS OF LOSS, PROPERTY DAMAGE OR PERSONAL INJURY.</p>
                    </div>
                    <div>
                        <h5 class="font-semibold text-gray-900 dark:text-white mb-2">Code of Conduct</h5>
                        <p>ECS Pub League is a 21+ adult recreational league for casual, low-contact soccer. We reserve the right to deny play for anyone deemed a poor fit for the league's mission.</p>
                        <p class="mt-2"><strong>Infractions may result in yellow cards, red cards, suspensions, or expulsion:</strong></p>
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            <li>Excessive physical play and tackling</li>
                            <li>Repeated dissent or unsporting behavior</li>
                            <li>Playing in a dangerous manner</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Terms Agreement Checkbox -->
            <div class="flex items-start mb-6">
                <input type="checkbox" id="terms-agreement" name="terms_agreement" required
                       class="w-4 h-4 text-ecs-green bg-gray-100 border-gray-300 rounded focus:ring-ecs-green dark:bg-gray-700 dark:border-gray-600 mt-0.5">
                <label for="terms-agreement" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                    I agree to the ECS FC terms, liability waiver, and code of conduct <span class="text-red-500">*</span>
                </label>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex items-center justify-between gap-4 mt-6">
            <button type="button" id="prevBtn" class="hidden items-center gap-2 px-4 py-2.5 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                <i class="ti ti-chevron-left"></i> Back
            </button>
            <button type="button" id="nextBtn" class="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 text-white bg-ecs-green hover:bg-ecs-green/90 rounded-lg font-medium transition-colors">
                Next <i class="ti ti-chevron-right"></i>
            </button>
            <button type="submit" id="submitBtn" class="hidden flex-1 items-center justify-center gap-2 px-4 py-2.5 text-white bg-ecs-green hover:bg-ecs-green/90 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="ti ti-send"></i> Join Waitlist
            </button>
        </div>
    </form>

    <!-- Footer Links -->
    <div class="text-center mt-6">
        <p class="text-sm text-gray-500 dark:text-gray-400">
            Already have an account?
            <a href="{{ url_for('auth.login') }}" class="text-ecs-green hover:underline font-medium">Sign in</a>
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const form = document.getElementById('waitlistForm');
    const steps = document.querySelectorAll('.step');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const progressBar = document.getElementById('progressBar');
    const stepNum = document.getElementById('currentStepNum');
    const totalSteps = steps.length;
    let currentStep = 1;

    function updateStepIndicators(step) {
        for (let i = 1; i <= totalSteps; i++) {
            const indicator = document.getElementById(`step-indicator-${i}`);
            const circle = indicator.querySelector('div');
            const text = indicator.querySelector('span');

            if (i < step) {
                // Completed
                circle.className = 'w-8 h-8 rounded-full bg-ecs-green text-white flex items-center justify-center mb-1';
                circle.innerHTML = '<i class="ti ti-check"></i>';
                text.className = 'text-ecs-green';
            } else if (i === step) {
                // Active
                const icons = ['ti-user', 'ti-trophy', 'ti-shirt-sport', 'ti-file-check'];
                circle.className = 'w-8 h-8 rounded-full bg-ecs-green text-white flex items-center justify-center mb-1';
                circle.innerHTML = `<i class="ti ${icons[i-1]}"></i>`;
                text.className = 'text-gray-600 dark:text-gray-400';
            } else {
                // Pending
                const icons = ['ti-user', 'ti-trophy', 'ti-shirt-sport', 'ti-file-check'];
                circle.className = 'w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-400 flex items-center justify-center mb-1';
                circle.innerHTML = `<i class="ti ${icons[i-1]}"></i>`;
                text.className = 'text-gray-400 dark:text-gray-500';
            }
        }
    }

    function showStep(step) {
        steps.forEach((s, i) => {
            s.classList.toggle('step-hidden', i + 1 !== step);
        });

        // Update progress bar
        const progress = (step / totalSteps) * 100;
        progressBar.style.width = progress + '%';
        stepNum.textContent = step;

        // Update step indicators
        updateStepIndicators(step);

        // Update button visibility
        prevBtn.classList.toggle('hidden', step === 1);
        prevBtn.classList.toggle('flex', step !== 1);

        if (step === totalSteps) {
            nextBtn.classList.add('hidden');
            nextBtn.classList.remove('flex');
            submitBtn.classList.remove('hidden');
            submitBtn.classList.add('flex');
            updateSubmitState();
        } else {
            nextBtn.classList.remove('hidden');
            nextBtn.classList.add('flex');
            submitBtn.classList.add('hidden');
            submitBtn.classList.remove('flex');
        }
    }

    function validateStep(step) {
        const stepEl = document.getElementById('step' + step);
        const requiredInputs = stepEl.querySelectorAll('[required]');
        let valid = true;

        requiredInputs.forEach(input => {
            if (input.type === 'radio') {
                const name = input.name;
                const checked = stepEl.querySelector(`input[name="${name}"]:checked`);
                if (!checked) valid = false;
            } else if (!input.value.trim()) {
                valid = false;
                input.classList.add('border-red-500');
            } else {
                input.classList.remove('border-red-500');
            }
        });

        return valid;
    }

    function updateSubmitState() {
        const termsCheckbox = document.getElementById('terms-agreement');
        submitBtn.disabled = !termsCheckbox.checked;
    }

    // Event Listeners
    nextBtn.addEventListener('click', function() {
        if (validateStep(currentStep)) {
            currentStep++;
            showStep(currentStep);
        }
    });

    prevBtn.addEventListener('click', function() {
        currentStep--;
        showStep(currentStep);
    });

    // Terms checkbox
    document.getElementById('terms-agreement').addEventListener('change', updateSubmitState);

    // Phone formatting
    const phoneInput = document.getElementById('waitlist-phone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 6) {
                value = '(' + value.substring(0,3) + ') ' + value.substring(3,6) + '-' + value.substring(6,10);
            } else if (value.length >= 3) {
                value = '(' + value.substring(0,3) + ') ' + value.substring(3);
            }
            e.target.value = value;
        });
    }

    // Initialize
    showStep(1);
})();
</script>
{% endblock %}
