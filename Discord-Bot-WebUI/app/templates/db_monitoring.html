{% extends "base.html" %}
{% block title %}Database Monitor{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                    <h2 class="text-primary mb-1">Database Monitoring</h2>
                    <p class="text-muted">Track database connections and pool health</p>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <button id="refreshBtn" type="button" class="c-btn c-btn--icon-only c-btn--outline-primary c-btn--sm" aria-label="Refresh"><i class="ti ti-refresh"></i></button>
                    <a href="{{ url_for('monitoring.monitor_dashboard') }}" class="c-btn c-btn--outline-primary c-btn--sm">
                        <i class="ti ti-arrow-left me-1"></i>Back to Task Monitor
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="alertContainer"></div>

    <!-- Connection Pool Statistics Dashboard -->
    <div class="row">
        <!-- Pool Size -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="c-card h-100">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div class="card-info">
                            <h5 class="mb-0">Pool Size</h5>
                            <small class="text-muted">Connection capacity</small>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-database fs-3 text-primary"></i>
                        </div>
                    </div>
                    <h2 class="mt-2 mb-0" id="poolSize">-</h2>
                    <div class="mt-1">
                        <span class="badge bg-label-primary" data-badge>
                            <i class="ti ti-maximize me-1"></i>Max: <span id="maxPoolSize">-</span>
                        </span>
                    </div>
                    <div class="progress mt-2 u-h-8">
                        <div id="poolSizeProgress" class="progress-bar bg-primary" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Connections -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="c-card h-100">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div class="card-info">
                            <h5 class="mb-0">Active Connections</h5>
                            <small class="text-muted">Working connections</small>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-activity fs-3 text-info"></i>
                        </div>
                    </div>
                    <h2 class="mt-2 mb-0" id="activeConnections">-</h2>
                    <div class="mt-1">
                        <span class="badge bg-label-info" data-badge>
                            <i class="ti ti-exchange me-1"></i>Checkouts: <span id="totalCheckouts">-</span>
                        </span>
                    </div>
                    <div class="progress mt-2 u-h-8">
                        <div id="activeConnectionsProgress" class="progress-bar bg-info" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaked Connections -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="c-card h-100">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div class="card-info">
                            <h5 class="mb-0">Leaked Connections</h5>
                            <small class="text-muted">Orphaned resources</small>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-droplet fs-3 text-warning"></i>
                        </div>
                    </div>
                    <h2 class="mt-2 mb-0" id="leakedConnections">-</h2>
                    <div class="mt-1">
                        <span class="badge bg-label-warning" data-badge>
                            <i class="ti ti-coffee me-1"></i>Idle: <span id="idleConnections">-</span>
                        </span>
                    </div>
                    <div class="progress mt-2 u-h-8">
                        <div id="leakedConnectionsProgress" class="progress-bar bg-warning" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Idle Transactions -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="c-card h-100">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div class="card-info">
                            <h5 class="mb-0">Idle Transactions</h5>
                            <small class="text-muted">Stalled operations</small>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-alert-triangle fs-3 text-danger"></i>
                        </div>
                    </div>
                    <h2 class="mt-2 mb-0" id="idleTransactions">-</h2>
                    <div class="mt-1">
                        <span class="badge bg-label-danger" data-badge>
                            <i class="ti ti-clock me-1"></i>Oldest: <span id="oldestConnectionAge">-</span>
                        </span>
                    </div>
                    <div class="progress mt-2 u-h-8">
                        <div id="idleTransactionsProgress" class="progress-bar bg-danger" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Admin Actions</h5>
                    </div>
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <button id="forceCleanup" class="c-btn c-btn--primary c-btn--sm w-100 js-force-cleanup" data-action="force-cleanup">
                                <i class="ti ti-clear-all me-1"></i>Force Connection Cleanup
                            </button>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <button id="refreshDashboardBtn" class="c-btn c-btn--outline-primary c-btn--sm w-100 js-refresh-dashboard" data-action="refresh-dashboard">
                                <i class="ti ti-refresh me-1"></i>Refresh Statistics
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Connections -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__header border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="ti ti-plug-connected me-2"></i>Active Connections</h5>
                    </div>
                </div>
                <div class="c-table-wrapper" data-table-responsive>
                    <table class="c-c-table c-table--hoverable" data-table data-mobile-table data-table-type="logs">
                        <thead class="c-table--light" scope="col">
                            <tr>
                                <th scope="col">PID</th>
                                <th scope="col">Age</th>
                                <th scope="col">State</th>
                                <th scope="col">Source</th>
                                <th scope="col">Tx Age</th>
                                <th scope="col">Query Start</th>
                                <th scope="col">Tx Start</th>
                                <th scope="col">Query</th>
                                <th scope="col">Stack</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="activeConnectionsTable">
                            <tr>
                                <td colspan="10" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status" data-spinner>
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaked Connections -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__header border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="ti ti-plug-connected-x me-2"></i>Leaked Connections</h5>
                    </div>
                </div>
                <div class="c-table-wrapper" data-table-responsive>
                    <table class="c-c-table c-table--hoverable" data-table data-mobile-table data-table-type="logs">
                        <thead class="c-table--light" scope="col">
                            <tr>
                                <th scope="col">PID</th>
                                <th scope="col">Transaction Name</th>
                                <th scope="col">Leaked Duration</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leakedConnectionsTable">
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status" data-spinner>
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% block modals %}
{{ super() }}
<!-- Stack Trace Modal -->
<div class="modal c-modal fade" data-modal id="stackTraceModal" tabindex="-1" aria-labelledby="stackTraceModalLabel">
    <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header data-modal-header>
                <h5 class="modal-title c-modal__title" id="stackTraceModalLabel">
                    <i class="ti ti-stack me-2"></i>Stack Trace
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                <pre class="stack-trace-content p-3 bg-body-tertiary rounded"></pre>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer data-modal-footer>
                <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Query Modal -->
<div class="modal c-modal fade" data-modal id="queryModal" tabindex="-1" aria-labelledby="queryModalLabel">
    <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header data-modal-header>
                <h5 class="modal-title c-modal__title" id="queryModalLabel">
                    <i class="ti ti-sql me-2"></i>SQL Query
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                <pre class="query-content p-3 bg-body-tertiary rounded"></pre>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer data-modal-footer>
                <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_css %}
{{ super() }}
<!-- Styles moved to:
     - /app/static/css/features/admin-monitoring.css
     - /app/static/css/components/empty-states.css -->
{% endblock %}

{% block custom_js %}
{{ super() }}
<!-- DB Monitoring Module (extracted from inline JS) -->
<script src="{{ url_for('static', filename='custom_js/db-monitoring.js') }}"></script>
<script>
// Initialize DB Monitoring with template data
DBMonitoring.init({
    connectionStatsUrl: '{{ url_for("monitoring.connection_stats") }}',
    checkConnectionsUrl: '{{ url_for("monitoring.check_connections") }}',
    cleanupUrl: '{{ url_for("monitoring.cleanup_connections") }}',
    stackTraceUrl: '{{ url_for("monitoring.get_stack_trace", pid=0) }}',
    terminateUrl: '{{ url_for("monitoring.terminate_connection") }}',
    csrfToken: '{{ csrf_token() }}'
});
</script>
{% endblock %}