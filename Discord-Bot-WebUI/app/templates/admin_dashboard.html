{% extends "base.html" %}

{% block main_content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <h1 class="h3">Admin Dashboard</h1>
    </div>

    <div class="row">
        <!-- Manage Users Section -->
        <div class="col-lg-12 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">Manage Users</h6>
                </div>
                <div class="card-body">
                    <!-- Search and Filter Form -->
                    <form id="user-search-form" method="GET" action="{{ url_for('admin.admin_dashboard') }}">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="user-search-input" class="form-label">Search</label>
                                    <input type="text" id="user-search-input" name="search" class="form-control" placeholder="Username or Email" value="{{ request.args.get('search', '') }}">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="role" class="form-label">Role</label>
                                    <select name="role" id="role" class="form-select">
                                        <option value="">All Roles</option>
                                        {% for role in roles %}
                                        <option value="{{ role.name }}" {% if request.args.get('role') == role.name %}selected{% endif %}>{{ role.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="league" class="form-label">League</label>
                                    <select name="league" id="league" class="form-select">
                                        <option value="">All Leagues</option>
                                        <option value="none" {% if request.args.get('league') == 'none' %}selected{% endif %}>None</option>
                                        {% for league in leagues %}
                                        <option value="{{ league.id }}" {% if request.args.get('league') == league.id|string %}selected{% endif %}>{{ league.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="active" class="form-label">Active Status</label>
                                    <select name="active" id="active" class="form-select">
                                        <option value="">All</option>
                                        <option value="true" {% if request.args.get('active') == 'true' %}selected{% endif %}>Active</option>
                                        <option value="false" {% if request.args.get('active') == 'false' %}selected{% endif %}>Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="approved" class="form-label">Approval Status</label>
                                        <select name="approved" id="approved" class="form-select">
                                            <option value="">All</option>
                                            <option value="true" {% if request.args.get('approved') == 'true' %}selected{% endif %}>Approved</option>
                                            <option value="false" {% if request.args.get('approved') == 'false' %}selected{% endif %}>Not Approved</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12 d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-search me-1"></i> Search
                                </button>
                                <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary">
                                    <i class="fas fa-times me-1"></i> Clear
                                </a>
                            </div>
                        </div>
                    </form>

                    <!-- Users Table -->
                    <div class="table-responsive mt-4">
                        <table class="table table-bordered table-hover">
                            <thead class="table-primary">
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>League</th>
                                    <th>Active</th>
                                    <th>Approved</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body">
                                {% for user in users %}
                                <tr>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>{{ user.roles | join(', ') }}</td>
                                    <td>{{ user.league.name if user.league else 'None' }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if user.is_active else 'secondary' }}">
                                            {{ 'Yes' if user.is_active else 'No' }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if user.is_approved else 'secondary' }}">
                                            {{ 'Yes' if user.is_approved else 'No' }}
                                        </span>
                                    </td>
                                    <td>
                                        <form method="post" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="user_id" value="{{ user.id }}">
                                            {% if not user.is_approved %}
                                            <button name="action" value="approve" class="btn btn-success btn-sm me-1">
                                                <i class="fas fa-check"></i> Approve
                                            </button>
                                            {% endif %}
                                            <button type="button" class="btn btn-primary btn-sm me-1 edit-user-btn" data-user-id="{{ user.id }}" data-bs-toggle="modal" data-bs-target="#editUserModal">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button type="button" class="btn btn-warning btn-sm me-1" data-bs-toggle="modal" data-bs-target="#resetPasswordModal" onclick="setUserForResetPassword('{{ user.id }}', '{{ user.username }}')">
                                                <i class="fas fa-key"></i> Reset Password
                                            </button>
                                            <button name="action" value="remove" class="btn btn-danger btn-sm">
                                                <i class="fas fa-trash"></i> Remove
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <!-- Pagination Controls -->
                        {% if pagination %}
                        <nav aria-label="User pagination">
                            {{ pagination.links }}
                        </nav>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Manage Roles and Permissions Section -->
        <div class="col-lg-12 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">Manage Roles and Permissions</h6>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.admin_dashboard') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="action" value="update_permissions">

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="role_id" class="form-label">Select Role:</label>
                                <select name="role_id" id="role_id" class="form-select" required>
                                    <option value="" disabled selected>Select a role...</option>
                                    {% for role in roles %}
                                    <option value="{{ role.id }}">{{ role.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-8 mb-3">
                                <label for="permissions" class="form-label">Select Permissions:</label>
                                <select name="permissions" id="permissions" class="form-select select2-multiple" multiple>
                                    {% for permission in permissions %}
                                    <option value="{{ permission.id }}">{{ permission.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Update Permissions</button>
                    </form>
                    <hr>
                    <h5 class="mb-3">Current Permissions for Selected Role</h5>
                    <ul id="current-permissions-list" class="list-group">
                        <li class="list-group-item text-muted">Select a role to view permissions.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="m-0 font-weight-bold">Update System</h6>
                    </div>
                    <div class="card-body">
                        <div id="update-status" class="mb-3">
                            <strong>Current Version:</strong> <span id="current-version">Loading...</span><br>
                            <strong>Latest Version:</strong> <span id="latest-version">Loading...</span><br>
                            <span id="update-message"></span>
                        </div>
                        <div class="d-flex">
                            <button id="check-update-btn" class="btn btn-info me-2">Check for Update</button>
                            <button id="update-now-btn" class="btn btn-danger" style="display: none;" onclick="updateApplication()">Update Now</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manage Announcements Section -->
        <div class="col-lg-12 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">Manage Announcements</h6>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.manage_announcements') }}">
                        {{ announcement_form.hidden_tag() }}
                        <div class="row g-3 align-items-end">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="title" class="form-label">Title</label>
                                    {{ announcement_form.title(class_="form-control", placeholder="Enter announcement title") }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="content" class="form-label">Content</label>
                                    {{ announcement_form.content(class_="form-control", placeholder="Enter announcement content") }}
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i> Create Announcement
                            </button>
                        </div>
                    </form>

                    <hr>

                    <h5 class="mb-3">Current Announcements</h5>
                    <ul class="list-group" id="announcements-list">
                        {% for announcement in announcements %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ announcement.title }}</strong><br>
                                <small>{{ announcement.content }}</small>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-warning btn-sm edit-announcement-btn me-1" data-announcement-id="{{ announcement.id }}">
                                    <i class="fas fa-edit me-1"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm delete-announcement-btn" data-announcement-id="{{ announcement.id }}">
                                    <i class="fas fa-trash me-1"></i> Delete
                                </button>
                            </div>
                        </li>
                        {% else %}
                        <li class="list-group-item text-center text-muted">No announcements available.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>



        <!-- Send Test SMS Section -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">Send Test SMS</h6>
                </div>
                <div class="card-body">
                    <form id="smsForm" method="POST" action="{{ url_for('admin.send_sms') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label for="to_phone_number" class="form-label">Phone Number</label>
                            <input type="text" id="to_phone_number" name="to_phone_number" class="form-control" placeholder="+11234567890" required>
                        </div>
                        <div class="mb-3">
                            <label for="message_body" class="form-label">Message</label>
                            <textarea id="message_body" name="message_body" class="form-control" rows="3" placeholder="Enter your message here..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-paper-plane me-1"></i> Send SMS
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Docker Containers Status Section -->
        <div class="col-lg-12 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">Docker Containers Status</h6>
                </div>
                <div class="card-body">
                    <div id="dockerStatusContainer" class="row">
                        <!-- Docker container cards will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editUserForm" method="POST" action="{{ url_for('user_management.edit_user', user_id=0) }}">
                {{ edit_form.hidden_tag() }}
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Form fields to be populated via JavaScript -->
                    <div class="mb-3">
                        <label for="edit_username" class="form-label">Username</label>
                        <input type="text" id="edit_username" name="username" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_email" class="form-label">Email</label>
                        <input type="email" id="edit_email" name="email" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_roles" class="form-label">Roles</label>
                        <select name="roles" id="edit_roles" class="form-select" multiple>
                            {% for role in roles %}
                            <option value="{{ role.id }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_league_id" class="form-label">League</label>
                        <select name="league_id" id="edit_league_id" class="form-select">
                            <option value="">None</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}">{{ league.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" id="edit_is_current_player" name="is_current_player" class="form-check-input">
                        <label for="edit_is_current_player" class="form-check-label">Is Current Player</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Announcement Modal -->
<div class="modal fade" id="editAnnouncementModal" tabindex="-1" aria-labelledby="editAnnouncementModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editAnnouncementForm" method="POST" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="editAnnouncementModalLabel">Edit Announcement</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_title" class="form-label">Title</label>
                        <input type="text" id="edit_title" name="title" class="form-control" placeholder="Enter announcement title" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_content" class="form-label">Content</label>
                        <textarea id="edit_content" name="content" class="form-control" placeholder="Enter announcement content" rows="3" required></textarea>
                    </div>
                    <input type="hidden" name="announcement_id" id="edit_announcement_id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Announcement</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Docker Logs Modal -->
<div class="modal fade" id="dockerLogsModal" tabindex="-1" aria-labelledby="dockerLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Docker Container Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="dockerLogsContent" style="max-height: 400px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin.admin_dashboard') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="user_id" id="user_id_for_reset">
                <input type="hidden" name="action" value="reset_password">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetPasswordModalLabel">Reset Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        {{ reset_password_form.password.label(class="form-label") }}
                        {{ reset_password_form.password(class="form-control", placeholder="Enter new password") }}
                    </div>
                    <div class="mb-3">
                        {{ reset_password_form.confirm_password.label(class="form-label") }}
                        {{ reset_password_form.confirm_password(class="form-control", placeholder="Confirm new password") }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Reset Password</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script>
    // Function to check for updates
    function checkForUpdate() {
        fetch('/check-update')
            .then(response => response.json())
            .then(data => {
                document.getElementById('current-version').innerText = data.current_version;
                document.getElementById('latest-version').innerText = data.latest_version || 'Unknown';

                if (data.update_available) {
                    document.getElementById('update-message').innerHTML = '<strong style="color: red;">Update Available!</strong>';
                    document.getElementById('update-now-btn').style.display = 'inline-block';
                } else {
                    document.getElementById('update-message').innerHTML = '<strong style="color: green;">No update available. You are using the latest version.</strong>';
                    document.getElementById('update-now-btn').style.display = 'none';
                }
            });
    }

    // Call the checkForUpdate function on button click
    document.getElementById('check-update-btn').addEventListener('click', checkForUpdate);

    // Function to trigger the update
    function updateApplication() {
        fetch('/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ confirm: 'yes' })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();  // Proceed if the response is JSON
            })
            .then(data => {
                if (data.success) {
                    alert("Update process started successfully!");
                } else {
                    alert("Update failed: " + data.message);
                }
            })
            .catch(error => {
                alert("Error: " + error.message);
                console.error("Error during update:", error);
            });
    }

    // Automatically check for updates when the page loads
    checkForUpdate();
</script>
<script>
    // Define the edit user URL template with a unique placeholder
    const editUserUrlTemplate = "{{ url_for('user_management.edit_user', user_id=0) }}";
    const editUserUrlBase = editUserUrlTemplate.slice(0, -1); // Removes the trailing '0'

    // Function to set user data for the Reset Password modal
    function setUserForResetPassword(userId, username) {
        document.getElementById('user_id_for_reset').value = userId;
        document.getElementById('resetPasswordModalLabel').textContent = 'Reset Password for ' + username;
    }

    // Debounce function to limit the rate of function execution
    function debounce(func, delay) {
        let debounceTimer;
        return function () {
            const context = this;
            const args = arguments;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // Live Search and Filtering via AJAX with Debouncing
    document.getElementById('user-search-input').addEventListener('keyup', debounce(function () {
        const search = this.value.toLowerCase();
        const role = document.querySelector('select[name="role"]').value;
        const league = document.querySelector('select[name="league"]').value;
        const active = document.querySelector('select[name="active"]').value;
        const approved = document.querySelector('select[name="approved"]').value;

        const params = new URLSearchParams({
            search: search,
            role: role,
            league: league,
            active: active,
            approved: approved,
            page: 1  // Reset to first page on new search
        });

        fetch(`{{ url_for('admin.admin_dashboard') }}?${params.toString()}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTableBody = doc.getElementById('user-table-body').innerHTML;
                const newPagination = doc.querySelector('nav[aria-label="User pagination"]').innerHTML;

                document.getElementById('user-table-body').innerHTML = newTableBody;
                const paginationNav = document.querySelector('nav[aria-label="User pagination"]');
                if (paginationNav) {
                    paginationNav.innerHTML = newPagination;
                }
            })
            .catch(error => {
                console.error('Error fetching filtered users:', error);
            });
    }, 300)); // 300ms debounce delay

    // Event Delegation for Edit User Button
    document.getElementById('user-table-body').addEventListener('click', function (event) {
        const editButton = event.target.closest('.edit-user-btn');
        if (editButton) {
            const userId = editButton.getAttribute('data-user-id');

            // Set the form action to the correct edit URL using the template
            const editUrl = `${editUserUrlBase}${userId}`;
            const editForm = document.getElementById('editUserForm');
            editForm.action = editUrl;

            // Fetch user data via AJAX
            fetch(`/admin/get_user_data/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    // Populate the form fields in the modal
                    editForm.querySelector('input[name="username"]').value = data.username;
                    editForm.querySelector('input[name="email"]').value = data.email;

                    // Set the roles
                    const roleSelect = editForm.querySelector('select[name="roles"]');
                    const selectedRoles = data.roles || [];
                    for (let option of roleSelect.options) {
                        option.selected = selectedRoles.includes(parseInt(option.value));
                    }

                    // Set the league and current player status
                    editForm.querySelector('select[name="league_id"]').value = data.league_id || '';
                    editForm.querySelector('input[name="is_current_player"]').checked = data.is_current_player;

                    // Show the modal
                    const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
                    editModal.show();
                })
                .catch(error => {
                    console.error('Error fetching user data:', error);
                    alert('Failed to load user data.');
                });
        }
    });

    // Event Delegation for Edit and Delete Announcement Buttons
    document.getElementById('announcements-list').addEventListener('click', function (event) {
        const deleteButton = event.target.closest('.delete-announcement-btn');
        if (deleteButton) {
            const announcementId = deleteButton.getAttribute('data-announcement-id');

            if (!announcementId) {
                alert('Announcement ID is missing. Cannot delete.');
                return;
            }

            if (confirm('Are you sure you want to delete this announcement?')) {
                // Dynamically construct the URL with the announcement ID
                const deleteUrl = `/admin/announcements/${announcementId}/delete`;

                // Send a DELETE request via AJAX
                fetch(deleteUrl, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Remove the announcement from the list
                            const announcementItem = deleteButton.closest('li');
                            announcementItem.remove();
                            // Show a success notification
                            showToast('Success', 'Announcement deleted successfully.', 'success');
                        } else {
                            alert('Failed to delete announcement: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting announcement:', error);
                        alert('Failed to delete announcement.');
                    });
            }
        }

        const editButton = event.target.closest('.edit-announcement-btn');
        if (editButton) {
            const announcementId = editButton.getAttribute('data-announcement-id');

            if (!announcementId) {
                alert('Announcement ID is missing. Cannot edit.');
                return;
            }

            // Set the form action by replacing the placeholder with the actual announcementId
            const editAnnouncementForm = document.getElementById('editAnnouncementForm');
            const editAnnouncementUrlTemplate = "{{ url_for('admin.edit_announcement', announcement_id=0) }}";
            const editAnnouncementUrlBase = editAnnouncementUrlTemplate.slice(0, -1); // Remove trailing '0'
            editAnnouncementForm.action = editAnnouncementUrlBase + announcementId;

            // Show the Edit Announcement modal
            const editAnnouncementModal = new bootstrap.Modal(document.getElementById('editAnnouncementModal'));
            editAnnouncementModal.show();
        }
    });

    // Manage Roles and Permissions
    $('#role_id').change(function () {
        let roleId = $(this).val();
        if (roleId) {
            $.ajax({
                url: '{{ url_for("admin.get_role_permissions") }}',
                type: 'GET',
                data: { role_id: roleId },
                success: function (data) {
                    console.log('Permissions data:', data.permissions);
                    $('#permissions').val(data.permissions).trigger('change');
                    let currentPermissionsList = $('#current-permissions-list');
                    currentPermissionsList.empty();
                    if (data.permissions.length > 0) {
                        data.permissions.forEach(function (permissionId) {
                            let permissionName = $('#permissions option[value="' + permissionId + '"]').text().trim();
                            console.log('Permission ID:', permissionId, 'Permission Name:', permissionName);
                            if (permissionName) {
                                currentPermissionsList.append('<li class="list-group-item">' + permissionName + '</li>');
                            } else {
                                currentPermissionsList.append('<li class="list-group-item text-warning">Permission ID ' + permissionId + ' has no name assigned.</li>');
                                console.log('No matching option found for Permission ID:', permissionId);
                            }
                        });
                    } else {
                        currentPermissionsList.append('<li class="list-group-item text-muted">No permissions assigned.</li>');
                    }
                },
                error: function () {
                    alert('Failed to load permissions for the selected role.');
                }
            });
        } else {
            $('#permissions').val([]).trigger('change');
            $('#current-permissions-list').empty().append('<li class="list-group-item text-muted">No permissions assigned.</li>');
        }
    });

    // Automatically load permissions on page load if a role is selected
    if ($('#role_id').val()) {
        $('#role_id').trigger('change');
    }

    // Docker Containers Status
    async function fetchDockerStatus() {
        try {
            const response = await fetch(`{{ url_for("admin.docker_status") }}?timestamp=${new Date().getTime()}`);
            const data = await response.json();

            let containerStatusHTML = '';
            data.forEach(container => {
                const name = container.name.trim() || 'Unknown Name';
                const statusClass = container.status === 'running' ? 'success' : 'danger';

                containerStatusHTML += `
                    <div class="col-lg-6 col-md-12 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center bg-${statusClass} text-white">
                                <h5 class="card-title mb-0">${name}</h5>
                                <span class="badge bg-light text-${statusClass}">${container.status.charAt(0).toUpperCase() + container.status.slice(1)}</span>
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong>Image:</strong> ${container.image}</p>
                                <p class="mb-4"><strong>Container ID:</strong> ${container.id}</p>
                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-info btn-sm me-2 view-logs-btn" data-container-id="${container.id}">
                                        <i class="fas fa-file-alt me-1"></i> Logs
                                    </button>
                                    ${container.status === 'running' ? `
                                        <button class="btn btn-danger btn-sm me-2 manage-container-btn" data-container-id="${container.id}" data-action="stop">
                                            <i class="fas fa-stop me-1"></i> Stop
                                        </button>
                                        <button class="btn btn-warning btn-sm manage-container-btn" data-container-id="${container.id}" data-action="restart">
                                            <i class="fas fa-sync-alt me-1"></i> Restart
                                        </button>
                                    ` : `
                                        <button class="btn btn-success btn-sm manage-container-btn" data-container-id="${container.id}" data-action="start">
                                            <i class="fas fa-play me-1"></i> Start
                                        </button>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('dockerStatusContainer').innerHTML = containerStatusHTML;
        } catch (error) {
            console.error('Error fetching Docker status:', error);
            document.getElementById('dockerStatusContainer').innerHTML = '<p class="text-danger">Failed to load Docker containers.</p>';
        }
    }

    // Fetch Docker logs and display them in a modal
    async function fetchDockerLogs(containerId) {
        try {
            const response = await fetch(`/admin/view_logs/${containerId}`);
            const data = await response.json();

            if (data.error) {
                document.getElementById('dockerLogsContent').textContent = data.error;
            } else {
                document.getElementById('dockerLogsContent').textContent = data.logs;
            }

            const dockerLogsModal = new bootstrap.Modal(document.getElementById('dockerLogsModal'));
            dockerLogsModal.show();
        } catch (error) {
            console.error('Error fetching Docker logs:', error);
            document.getElementById('dockerLogsContent').textContent = 'Error loading logs.';
            const dockerLogsModal = new bootstrap.Modal(document.getElementById('dockerLogsModal'));
            dockerLogsModal.show();
        }
    }

    // Manage Docker container (start, stop, restart)
    async function manageContainer(containerId, action) {
        try {
            const btn = document.querySelector(`button.manage-container-btn[data-container-id="${containerId}"][data-action="${action}"]`);
            if (btn) {
                btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...`;
                btn.disabled = true;
            }

            const response = await fetch(`/admin/container/${containerId}/${action}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });

            if (response.ok) {
                fetchDockerStatus();  // Refresh the Docker status after action
                showToast('Success', `Container ${action}ed successfully.`, 'success');
            } else {
                const errorData = await response.json();
                alert('Failed to perform action: ' + action + '\nError: ' + (errorData.error || 'Unknown error'));
                if (btn) {
                    btn.innerHTML = `${action.charAt(0).toUpperCase() + action.slice(1)}`;
                    btn.disabled = false;
                }
            }
        } catch (error) {
            console.error(`Error trying to ${action} container:`, error);
            if (btn) {
                btn.innerHTML = `${action.charAt(0).toUpperCase() + action.slice(1)}`;
                btn.disabled = false;
            }
            alert(`Failed to perform action: ${action}`);
        }
    }

    // Event delegation for Docker logs and container management
    document.getElementById('dockerStatusContainer').addEventListener('click', function(event) {
        const viewLogsBtn = event.target.closest('.view-logs-btn');
        if (viewLogsBtn) {
            const containerId = viewLogsBtn.getAttribute('data-container-id');
            fetchDockerLogs(containerId);
        }

        const manageContainerBtn = event.target.closest('.manage-container-btn');
        if (manageContainerBtn) {
            const containerId = manageContainerBtn.getAttribute('data-container-id');
            const action = manageContainerBtn.getAttribute('data-action');
            manageContainer(containerId, action);
        }
    });

    // Fetch Docker status on page load
    window.onload = function () {
        fetchDockerStatus();
    };

    // Utility function to show toast notifications (ensure Bootstrap Toasts are initialized)
    function showToast(title, message, type) {
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }

        const toastHTML = `
            <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}:</strong> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        const toastElement = toastContainer.querySelector('.toast:last-child');
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    }
</script>
{% endblock %}