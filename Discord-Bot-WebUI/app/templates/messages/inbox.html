{% extends "base.html" %}

{% block title %}Messages{% endblock %}

{% block page_css %}

{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/c-modal.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/messages-inbox.css') }}">
{% endif %}
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y c-messages-inbox-page">

  {# Page Header #}
  <div class="c-messages-header">
    <div class="c-messages-header__title">
      <i class="ti ti-messages c-messages-header__icon" aria-hidden="true"></i>
      <h1 class="c-messages-header__text">Messages</h1>
    </div>
    <div class="c-messages-header__actions">
      <button class="c-btn c-btn--primary c-btn--sm" data-action="new-conversation">
        <i class="ti ti-plus" aria-hidden="true"></i>
        New Message
      </button>
    </div>
  </div>

  {# Main Messages Container #}
  <div class="c-messages-inbox" data-component="messages-inbox">

    {# Sidebar - Conversation List #}
    <aside class="c-messages-sidebar">

      {# Search Bar #}
      <div class="c-messages-search">
        <div class="c-messages-search__input-wrapper">
          <i class="ti ti-search c-messages-search__icon" aria-hidden="true"></i>
          <input type="text"
                 class="c-messages-search__input"
                 data-input="search-conversations"
                 placeholder="Search conversations..."
                 autocomplete="off" aria-label="Search conversations...">
        </div>
      </div>

      {# Conversation List #}
      <div class="c-messages-list" data-list="conversations">

        {# Loading State #}
        <div class="c-messages-list__loading" data-state="loading">
          <div class="c-messages-list__spinner"></div>
          <span>Loading conversations...</span>
        </div>

        {# Empty State #}
        <div class="c-messages-list__empty u-hidden" data-state="empty">
          <i class="ti ti-message-off c-messages-list__empty-icon" aria-hidden="true"></i>
          <p class="c-messages-list__empty-title">No conversations yet</p>
          <p class="c-messages-list__empty-text">Start a new conversation to connect with other players and coaches</p>
          <button class="c-btn c-btn--primary c-btn--sm" data-action="new-conversation">
            <i class="ti ti-plus" aria-hidden="true"></i>
            Start Conversation
          </button>
        </div>

        {# Conversations will be populated here #}

      </div>

      {# Mark All Read Button #}
      <div class="c-messages-sidebar__footer u-hidden" data-footer="sidebar">
        <button class="c-btn c-btn--outline-secondary c-btn--sm c-btn--block" data-action="mark-all-read">
          <i class="ti ti-checks" aria-hidden="true"></i>
          Mark All as Read
        </button>
      </div>

    </aside>

    {# Main Chat Area #}
    <main class="c-messages-main">

      {# Empty/Welcome State #}
      <div class="c-messages-welcome" data-state="welcome">
        <div class="c-messages-welcome__content">
          <div class="c-messages-welcome__icon-wrapper">
            <i class="ti ti-message-circle c-messages-welcome__icon" aria-hidden="true"></i>
          </div>
          <h2 class="c-messages-welcome__title">Welcome to Messages</h2>
          <p class="c-messages-welcome__text">
            Select a conversation from the sidebar or start a new one to begin messaging.
          </p>
          <button class="c-btn c-btn--primary" data-action="new-conversation">
            <i class="ti ti-plus" aria-hidden="true"></i>
            Start New Conversation
          </button>
        </div>
      </div>

      {# Active Conversation View #}
      <div class="c-messages-chat u-hidden" data-view="chat">

        {# Chat Header #}
        <div class="c-messages-chat__header">
          <button class="c-messages-chat__back c-btn c-btn--ghost c-btn--icon-only d-md-none"
                  data-action="back-to-list"
                  aria-label="Back to conversations">
            <i class="ti ti-arrow-left" aria-hidden="true"></i>
          </button>
          <div class="c-messages-chat__user">
            <div class="c-messages-chat__avatar-wrapper">
              <img src="" alt="" class="c-messages-chat__avatar" data-chat-avatar>
              <span class="c-online-status c-online-status--sm" data-chat-status></span>
            </div>
            <div class="c-messages-chat__user-info">
              <a href="#" class="c-messages-chat__user-name" data-chat-name></a>
              <span class="c-messages-chat__user-status" data-chat-online-text></span>
            </div>
          </div>
          <div class="c-messages-chat__actions">
            <a href="#"
               class="c-btn c-btn--outline-secondary c-btn--sm c-btn--icon-only"
               data-chat-profile-link
               title="View Profile">
              <i class="ti ti-user" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        {# Messages Container #}
        <div class="c-messages-chat__messages" data-messages>

          {# Messages Loading #}
          <div class="c-messages-chat__messages-loading" data-state="messages-loading">
            <div class="c-messages-list__spinner"></div>
          </div>

          {# Messages will be populated here #}

        </div>

        {# Typing Indicator #}
        <div class="c-messages-chat__typing u-hidden" data-typing-indicator>
          <span class="c-messages-chat__typing-text" data-typing-name></span>
          <span class="c-messages-chat__typing-dots">
            <span></span><span></span><span></span>
          </span>
        </div>

        {# Message Input #}
        <div class="c-messages-chat__input-area">
          <div class="c-messages-chat__input-wrapper">
            <textarea class="c-messages-chat__input"
                      data-input="message"
                      placeholder="Type a message..."
                      rows="1"
                      maxlength="{{ settings.max_message_length }}"></textarea>
            <div class="c-messages-chat__input-actions">
              <span class="c-messages-chat__char-count" data-char-count>
                0/{{ settings.max_message_length }}
              </span>
              <button class="c-messages-chat__send c-btn c-btn--primary"
                      data-action="send-message"
                      disabled
                      aria-label="Send message">
                <i class="ti ti-send" aria-hidden="true"></i>
                <span class="c-messages-chat__send-text">Send</span>
              </button>
            </div>
          </div>
        </div>

      </div>

    </main>

  </div>

</div>

{# New Conversation Modal #}
<div class="c-modal modal fade" id="newConversationModal" tabindex="-1" role="dialog" aria-labelledby="newConversationModalLabel" aria-hidden="true" data-modal>
  <div class="c-modal__dialog c-modal__dialog--centered modal-dialog modal-dialog-centered" role="document">
    <div class="c-modal__content modal-content">
      <div class="c-modal__header">
        <h5 class="c-modal__title" id="newConversationModalLabel">
          <i class="ti ti-message-plus" aria-hidden="true"></i>
          <span>New Conversation</span>
        </h5>
        <button type="button"
                class="c-modal__close"
                data-bs-dismiss="modal"
                data-action="close-modal"
                aria-label="Close">
          <i class="ti ti-x"></i>
        </button>
      </div>
      <div class="c-modal__body">
        <div class="c-form-modern__group">
          <label for="userSearchInput" class="c-form-modern__label">Search for a user</label>
          <input type="text"
                 class="c-form-modern__input"
                 id="userSearchInput"
                 data-input="user-search"
                 placeholder="Type a name to search..."
                 autocomplete="off">
        </div>
        <div class="c-user-search-results" data-list="user-results">
          <div class="c-user-search-results__hint">
            <i class="ti ti-info-circle" aria-hidden="true"></i>
            Type at least 2 characters to search
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script>
  // Pass initial data to JavaScript
  window.MessagesInboxConfig = {
    initialUser: {{ initial_user | tojson | safe if initial_user else 'null' }},
    settings: {{ settings | tojson | safe }},
    currentUserId: {{ current_user.id }},
    apiBase: '/api/messages'
  };
</script>
<script type="module" src="{{ url_for('static', filename='js/messages-inbox.js') }}?v=2"></script>
{% endif %}
{% endblock %}
