{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert, empty_state %}

{% block admin_title %}Live Matches{% endblock %}
{% block panel_description %}Monitor today's matches in real-time{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.match_operations') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">Match Operations</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Live Matches</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Statistics Cards -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="rounded-lg p-5 bg-ecs-green text-white">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-3xl font-bold">{{ stats.total_today or 0 }}</p>
                <p class="text-sm text-white/80 mt-1">Total Today</p>
            </div>
            <i class="ti ti-calendar text-4xl text-white/50"></i>
        </div>
    </div>

    <div class="rounded-lg p-5 bg-green-500 text-white">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-3xl font-bold">{{ stats.in_progress or 0 }}</p>
                <p class="text-sm text-white/80 mt-1">In Progress</p>
            </div>
            <i class="ti ti-broadcast text-4xl text-white/50"></i>
        </div>
    </div>

    <div class="rounded-lg p-5 bg-yellow-500 text-white">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-3xl font-bold">{{ stats.upcoming_today or 0 }}</p>
                <p class="text-sm text-white/80 mt-1">Upcoming Today</p>
            </div>
            <i class="ti ti-clock text-4xl text-white/50"></i>
        </div>
    </div>

    <div class="rounded-lg p-5 bg-blue-500 text-white">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-3xl font-bold">{{ stats.completed_today or 0 }}</p>
                <p class="text-sm text-white/80 mt-1">Completed Today</p>
            </div>
            <i class="ti ti-check text-4xl text-white/50"></i>
        </div>
    </div>
</div>

<!-- Match Columns -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Matches In Progress -->
    {% call card(title="In Progress", subtitle="Matches currently being played") %}
    <div class="space-y-3">
        {% if in_progress %}
            {% for match in in_progress %}
            <div class="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <h6 class="font-semibold text-gray-900 dark:text-white">
                        {{ match.home_team.name if match.home_team else 'TBD' }} vs {{ match.away_team.name if match.away_team else 'TBD' }}
                    </h6>
                    {% if match.home_team_score is not none and match.away_team_score is not none %}
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-sm font-bold bg-green-500 text-white">
                            {{ match.home_team_score }} - {{ match.away_team_score }}
                        </span>
                    {% else %}
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-500 text-white animate-pulse">
                            <i class="ti ti-broadcast mr-1"></i>Live
                        </span>
                    {% endif %}
                </div>
                <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                    <i class="ti ti-clock mr-1"></i>
                    {% if match.time %}{{ match.time.strftime('%H:%M') }}{% else %}TBD{% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="text-center py-8">
            <div class="mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 mb-3">
                <i class="ti ti-broadcast text-xl text-gray-400"></i>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400">No matches in progress</p>
        </div>
        {% endif %}
    </div>
    {% endcall %}

    <!-- Upcoming Today -->
    {% call card(title="Upcoming Today", subtitle="Matches scheduled for later") %}
    <div class="space-y-3">
        {% if upcoming_today %}
            {% for match in upcoming_today %}
            <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <h6 class="font-semibold text-gray-900 dark:text-white">
                        {{ match.home_team.name if match.home_team else 'TBD' }} vs {{ match.away_team.name if match.away_team else 'TBD' }}
                    </h6>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">
                        Scheduled
                    </span>
                </div>
                <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                    <i class="ti ti-clock mr-1"></i>
                    {% if match.time %}{{ match.time.strftime('%H:%M') }}{% else %}TBD{% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="text-center py-8">
            <div class="mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 mb-3">
                <i class="ti ti-clock text-xl text-gray-400"></i>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400">No upcoming matches today</p>
        </div>
        {% endif %}
    </div>
    {% endcall %}

    <!-- Completed Today -->
    {% call card(title="Completed Today", subtitle="Finished matches") %}
    <div class="space-y-3">
        {% if completed_today %}
            {% for match in completed_today %}
            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <h6 class="font-semibold text-gray-900 dark:text-white">
                        {{ match.home_team.name if match.home_team else 'TBD' }} vs {{ match.away_team.name if match.away_team else 'TBD' }}
                    </h6>
                    {% if match.home_team_score is not none and match.away_team_score is not none %}
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-sm font-bold bg-ecs-green text-white">
                            {{ match.home_team_score }} - {{ match.away_team_score }}
                        </span>
                    {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-300">
                            Finished
                        </span>
                    {% endif %}
                </div>
                <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                    <i class="ti ti-clock mr-1"></i>
                    {% if match.time %}{{ match.time.strftime('%H:%M') }}{% else %}TBD{% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="text-center py-8">
            <div class="mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 mb-3">
                <i class="ti ti-check text-xl text-gray-400"></i>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400">No completed matches today</p>
        </div>
        {% endif %}
    </div>
    {% endcall %}
</div>

<!-- Info Alert -->
{{ alert("This page shows all matches scheduled for today. Matches are automatically categorized based on their scheduled time and current status. The page updates when refreshed.", variant="info", title="Live Match Monitoring", dismissible=false) }}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh every 60 seconds for live updates
    let refreshInterval;

    function startAutoRefresh() {
        refreshInterval = setInterval(function() {
            location.reload();
        }, 60000); // 60 seconds
    }

    // Only auto-refresh if there are matches in progress
    {% if in_progress %}
    startAutoRefresh();
    {% endif %}

    // Stop refresh when page is hidden
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            clearInterval(refreshInterval);
        } else {
            {% if in_progress %}
            startAutoRefresh();
            {% endif %}
        }
    });
});
</script>
{% endblock %}
