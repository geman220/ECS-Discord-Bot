{% extends "admin_panel/base.html" %}

{% block title %}Team Management - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin_panel.match_operations') }}">Match Operations</a>
</li>
<li class="breadcrumb-item active">Team Management</li>
{% endblock %}

{% block custom_css %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/c-tabs.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/match-operations/seasons.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/match-operations/manage-teams.css') }}">
{% endif %}
{% endblock %}

{% block panel_content %}

<!-- Statistics Cards -->
<div class="c-stats-grid" data-component="stats-grid">
    <div class="c-stat-card c-stat-card--primary">
        <div class="c-stat-card__content">
            <div class="c-stat-card__body">
                <h5 class="c-stat-card__value">{{ stats.total_teams or 0 }}</h5>
                <p class="c-stat-card__label">Total Teams</p>
            </div>
            <i class="ti ti-shield c-stat-card__icon"></i>
        </div>
    </div>
    <div class="c-stat-card c-stat-card--success">
        <div class="c-stat-card__content">
            <div class="c-stat-card__body">
                <h5 class="c-stat-card__value">{{ stats.active_teams or 0 }}</h5>
                <p class="c-stat-card__label">Active Teams</p>
            </div>
            <i class="ti ti-shield-check c-stat-card__icon"></i>
        </div>
    </div>
    <div class="c-stat-card c-stat-card--warning">
        <div class="c-stat-card__content">
            <div class="c-stat-card__body">
                <h5 class="c-stat-card__value">{{ stats.teams_with_players or 0 }}</h5>
                <p class="c-stat-card__label">With Players</p>
            </div>
            <i class="ti ti-users c-stat-card__icon"></i>
        </div>
    </div>
    <div class="c-stat-card c-stat-card--info">
        <div class="c-stat-card__content">
            <div class="c-stat-card__body">
                <h5 class="c-stat-card__value">{{ stats.teams_by_league|length or 0 }}</h5>
                <p class="c-stat-card__label">Leagues</p>
            </div>
            <i class="ti ti-flag c-stat-card__icon"></i>
        </div>
    </div>
</div>

<!-- League Type Tabs -->
<div class="c-panel-section">
    <div class="c-card">
        <div class="c-card__header c-card__header--action">
            <h5 class="c-card__title">
                <i class="ti ti-filter"></i>
                Filter Teams
            </h5>
            <span class="c-badge c-badge--info">
                <i class="ti ti-calendar"></i>{{ stats.current_season }}
            </span>
        </div>
        <div class="c-card__body">
            <!-- League Type Tabs -->
            <div class="c-tabs mb-4" data-component="league-type-tabs">
                <a href="{{ url_for('admin_panel.manage_teams') }}"
                   class="c-tabs__link {% if not current_league_type %}c-tabs__link--active{% endif %}">
                    <i class="ti ti-list"></i>
                    All Teams
                    <span class="c-badge c-badge--secondary ms-2">{{ stats.total_teams }}</span>
                </a>
                <a href="{{ url_for('admin_panel.manage_teams', league_type='Pub League') }}"
                   class="c-tabs__link {% if current_league_type == 'Pub League' %}c-tabs__link--active{% endif %}">
                    <i class="ti ti-trophy"></i>
                    Pub League
                    <span class="c-badge c-badge--primary ms-2">{{ stats.teams_by_league_type.get('Pub League', 0) }}</span>
                </a>
                <a href="{{ url_for('admin_panel.manage_teams', league_type='ECS FC') }}"
                   class="c-tabs__link {% if current_league_type == 'ECS FC' %}c-tabs__link--active{% endif %}">
                    <i class="ti ti-shirt-sport"></i>
                    ECS FC
                    <span class="c-badge c-badge--success ms-2">{{ stats.teams_by_league_type.get('ECS FC', 0) }}</span>
                </a>
            </div>

            <!-- Additional Filters -->
            <div class="c-filter-form" data-component="filter-form">
                <form method="GET" class="c-filter-form__form">
                    {% if current_league_type %}
                    <input type="hidden" name="league_type" value="{{ current_league_type }}">
                    {% endif %}
                    <div class="c-filter-form__group">
                        <label class="c-filter-form__label">Division / League</label>
                        <select name="league_id" class="c-filter-form__select" data-filter="league">
                            <option value="">All Divisions</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}" {% if current_league_id == league.id %}selected{% endif %}>
                                {{ league.name }}
                                {% if league.season %}({{ league.season.league_type }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="c-filter-form__actions">
                        <button type="submit" class="c-btn c-btn--primary" data-action="apply-filter">
                            <i class="ti ti-search"></i>Filter
                        </button>
                        <a href="{{ url_for('admin_panel.manage_teams') }}" class="c-btn c-btn--outline-secondary" data-action="clear-filter">
                            <i class="ti ti-x"></i>Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Teams by League -->
{% if stats.teams_by_league %}
<div class="c-panel-section">
    <div class="c-card">
        <div class="c-card__header">
            <h5 class="c-card__title">
                <i class="ti ti-flag"></i>
                Teams by League
            </h5>
        </div>
        <div class="c-card__body">
            <div class="c-league-breakdown" data-component="league-breakdown">
                {% for league_name, team_count in stats.teams_by_league.items() %}
                <div class="c-league-breakdown__item" data-league="{{ league_name }}">
                    <span class="c-league-breakdown__name">{{ league_name }}</span>
                    <span class="c-badge c-badge--primary">{{ team_count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Teams Table -->
<div class="c-panel-section">
    <div class="c-card">
        <div class="c-card__header c-card__header--action">
            <h5 class="c-card__title">
                <i class="ti ti-shield"></i>
                All Teams
            </h5>
            <button class="c-btn c-btn--primary c-btn--sm" data-action="create-team">
                <i class="ti ti-plus"></i>Create Team
            </button>
        </div>
        <div class="c-card__body">
            {% if teams %}
            <div class="c-table-responsive">
                <table class="c-table" data-mobile-table data-table-type="teams">
                    <thead class="c-table__head">
                        <tr>
                            <th class="c-table__header">Team Name</th>
                            <th class="c-table__header">Type</th>
                            <th class="c-table__header">League / Division</th>
                            <th class="c-table__header">Players</th>
                            <th class="c-table__header">Status</th>
                            <th class="c-table__header">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="c-table__body">
                        {% for team in teams %}
                        <tr class="c-table__row">
                            <td class="c-table__cell">
                                <div class="c-team-name" data-component="team-name">
                                    <div class="c-team-avatar">
                                        <span class="c-team-avatar__initial">{{ team.name[0] if team.name else 'T' }}</span>
                                    </div>
                                    <strong>{{ team.name }}</strong>
                                </div>
                            </td>
                            <td class="c-table__cell">
                                {% if team.league and team.league.season %}
                                    {% if team.league.season.league_type == 'ECS FC' %}
                                        <span class="c-badge c-badge--success">
                                            <i class="ti ti-shirt-sport me-1"></i>ECS FC
                                        </span>
                                    {% else %}
                                        <span class="c-badge c-badge--primary">
                                            <i class="ti ti-trophy me-1"></i>Pub League
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="c-badge c-badge--secondary">Unknown</span>
                                {% endif %}
                            </td>
                            <td class="c-table__cell">
                                {% if team.league %}
                                    <span class="c-badge c-badge--info">{{ team.league.name }}</span>
                                {% else %}
                                    <span class="c-text-muted">No League</span>
                                {% endif %}
                            </td>
                            <td class="c-table__cell">
                                {% if team.players %}
                                    <span class="c-badge c-badge--success">{{ team.players|length }}</span>
                                {% else %}
                                    <span class="c-badge c-badge--secondary">0</span>
                                {% endif %}
                            </td>
                            <td class="c-table__cell">
                                {% if team.is_active %}
                                    <span class="c-badge c-badge--success">Active</span>
                                {% else %}
                                    <span class="c-badge c-badge--secondary">Inactive</span>
                                {% endif %}
                            </td>
                            <td class="c-table__cell">
                                <div class="c-btn-group">
                                    <button class="c-btn c-btn--icon c-btn--outline-info" data-action="view-team" data-team-id="{{ team.id }}" aria-label="View team">
                                        <i class="ti ti-eye"></i>
                                    </button>
                                    <button class="c-btn c-btn--icon c-btn--outline-warning" data-action="edit-team" data-team-id="{{ team.id }}" aria-label="Edit team">
                                        <i class="ti ti-edit"></i>
                                    </button>
                                    <button class="c-btn c-btn--icon c-btn--outline-info" data-action="manage-roster" data-team-id="{{ team.id }}" aria-label="Manage roster">
                                        <i class="ti ti-users"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="c-empty-state" data-component="empty-state">
                <i class="ti ti-shield-off c-empty-state__icon"></i>
                <h5 class="c-empty-state__title">No Teams Found</h5>
                <p class="c-empty-state__text">Create your first team to get started.</p>
                <button class="c-btn c-btn--primary" data-action="create-team">
                    <i class="ti ti-plus"></i>Create Team
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Help Alert -->
<div class="c-panel-section">
    <div class="c-alert c-alert--info">
        <i class="ti ti-info-circle c-alert__icon"></i>
        <div class="c-alert__content">
            <strong>Team Management:</strong>
            Manage all teams in your system. Create teams, assign them to leagues, and manage player rosters.
        </div>
    </div>
</div>

{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
// Helper function to get CSRF token
function getCSRFToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.getAttribute('content') : '';
}

// Event delegation for team management actions
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        const teamId = target.dataset.teamId;

        switch(action) {
            case 'create-team':
                createTeam();
                break;
            case 'view-team':
                viewTeam(teamId);
                break;
            case 'edit-team':
                editTeam(teamId);
                break;
            case 'manage-roster':
                manageRoster(teamId);
                break;
        }
    });
});

function createTeam() {
    Swal.fire({
        title: 'Create New Team',
        html: `
            <div class="text-start">
                <div class="mb-3">
                    <label class="form-label">Team Name <span class="text-danger">*</span></label>
                    <input type="text" id="teamName" class="form-control" placeholder="e.g., FC United">
                </div>
                <div class="mb-3">
                    <label class="form-label">League / Division</label>
                    <select id="teamLeagueId" class="form-select">
                        <option value="">-- Select League --</option>
                        {% for league in leagues %}
                        <option value="{{ league.id }}">
                            {{ league.name }}{% if league.season %} ({{ league.season.league_type }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">Select an ECS FC or Pub League division</small>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Create Team',
        cancelButtonText: 'Cancel',
        preConfirm: () => {
            const name = document.getElementById('teamName').value;
            if (!name) {
                Swal.showValidationMessage('Team name is required');
                return false;
            }
            return {
                name: name,
                league_id: document.getElementById('teamLeagueId').value
            };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const formData = new FormData();
            formData.append('name', result.value.name);
            if (result.value.league_id) {
                formData.append('league_id', result.value.league_id);
            }

            fetch('{{ url_for("admin_panel.create_team") }}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Success', data.message, 'success').then(() => location.reload());
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            })
            .catch(() => Swal.fire('Error', 'Failed to create team', 'error'));
        }
    });
}

function viewTeam(teamId) {
    fetch(`/admin-panel/match-operations/teams/${teamId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const team = data.team;
                Swal.fire({
                    title: team.name,
                    html: `
                        <div class="text-start">
                            <p><strong>Team ID:</strong> ${team.id}</p>
                            <p><strong>League:</strong> ${team.league_name || 'No League'}</p>
                            <p><strong>Players:</strong> ${team.player_count}</p>
                        </div>
                    `,
                    icon: 'info'
                });
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        })
        .catch(() => Swal.fire('Error', 'Failed to load team details', 'error'));
}

function editTeam(teamId) {
    // First fetch the team details
    fetch(`/admin-panel/match-operations/teams/${teamId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const team = data.team;
                Swal.fire({
                    title: 'Edit Team',
                    html: `
                        <div class="text-start">
                            <div class="mb-3">
                                <label class="form-label">Team Name <span class="text-danger">*</span></label>
                                <input type="text" id="editTeamName" class="form-control" value="${team.name}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">League</label>
                                <select id="editTeamLeagueId" class="form-select">
                                    <option value="">No League</option>
                                    {% for league in leagues %}
                                    <option value="{{ league.id }}">${team.league_id == {{ league.id }} ? 'selected' : ''}>{{ league.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <p class="text-muted small mb-0">Players: ${team.player_count}</p>
                        </div>
                    `,
                    showCancelButton: true,
                    showDenyButton: true,
                    confirmButtonText: 'Save Changes',
                    denyButtonText: 'Delete Team',
                    denyButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('danger') : 'var(--ecs-danger)',
                    cancelButtonText: 'Cancel',
                    didOpen: () => {
                        document.getElementById('editTeamLeagueId').value = team.league_id || '';
                    },
                    preConfirm: () => {
                        const name = document.getElementById('editTeamName').value;
                        if (!name) {
                            Swal.showValidationMessage('Team name is required');
                            return false;
                        }
                        return {
                            name: name,
                            league_id: document.getElementById('editTeamLeagueId').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const formData = new FormData();
                        formData.append('name', result.value.name);
                        if (result.value.league_id) {
                            formData.append('league_id', result.value.league_id);
                        }

                        fetch(`/admin-panel/match-operations/teams/${teamId}/update`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('Success', data.message, 'success').then(() => location.reload());
                            } else {
                                Swal.fire('Error', data.message, 'error');
                            }
                        })
                        .catch(() => Swal.fire('Error', 'Failed to update team', 'error'));
                    } else if (result.isDenied) {
                        deleteTeam(teamId, team.name);
                    }
                });
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        })
        .catch(() => Swal.fire('Error', 'Failed to load team details', 'error'));
}

function deleteTeam(teamId, teamName) {
    Swal.fire({
        title: 'Delete Team?',
        text: `Are you sure you want to delete "${teamName}"? This cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete',
        confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('danger') : 'var(--ecs-danger)',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/admin-panel/match-operations/teams/${teamId}/delete`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Deleted', data.message, 'success').then(() => location.reload());
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            })
            .catch(() => Swal.fire('Error', 'Failed to delete team', 'error'));
        }
    });
}

function manageRoster(teamId) {
    // Redirect to team roster management
    window.location.href = `{{ url_for('admin_panel.team_rosters') }}?team_id=${teamId}`;
}
</script>
{% endblock %}
