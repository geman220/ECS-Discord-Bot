{% extends "admin_panel/base.html" %}

{% block title %}Team Management - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin_panel.match_operations') }}">Match Operations</a>
</li>
<li class="breadcrumb-item active">Team Management</li>
{% endblock %}

{% block custom_css %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/c-tabs.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/match-operations/seasons.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/match-operations/manage-teams.css') }}">
{% endif %}
{% endblock %}

{% block panel_content %}

<!-- Statistics Cards -->
<div class="c-stats-grid" data-component="stats-grid">
    <div class="c-stat-card c-stat-card--primary">
        <div class="c-stat-card__content">
            <div class="c-stat-card__body">
                <h5 class="c-stat-card__value">{{ stats.total_teams or 0 }}</h5>
                <p class="c-stat-card__label">Total Teams</p>
            </div>
            <i class="ti ti-shield c-stat-card__icon"></i>
        </div>
    </div>
    <div class="c-stat-card c-stat-card--success">
        <div class="c-stat-card__content">
            <div class="c-stat-card__body">
                <h5 class="c-stat-card__value">{{ stats.active_teams or 0 }}</h5>
                <p class="c-stat-card__label">Active Teams</p>
            </div>
            <i class="ti ti-shield-check c-stat-card__icon"></i>
        </div>
    </div>
    <div class="c-stat-card c-stat-card--warning">
        <div class="c-stat-card__content">
            <div class="c-stat-card__body">
                <h5 class="c-stat-card__value">{{ stats.teams_with_players or 0 }}</h5>
                <p class="c-stat-card__label">With Players</p>
            </div>
            <i class="ti ti-users c-stat-card__icon"></i>
        </div>
    </div>
    <div class="c-stat-card c-stat-card--info">
        <div class="c-stat-card__content">
            <div class="c-stat-card__body">
                <h5 class="c-stat-card__value">{{ stats.teams_by_league|length or 0 }}</h5>
                <p class="c-stat-card__label">Leagues</p>
            </div>
            <i class="ti ti-flag c-stat-card__icon"></i>
        </div>
    </div>
</div>

<!-- League Type Tabs -->
<div class="c-panel-section">
    <div class="c-card">
        <div class="c-card__header c-card__header--action">
            <h5 class="c-card__title">
                <i class="ti ti-filter"></i>
                Filter Teams
            </h5>
            <span class="c-badge c-badge--info">
                <i class="ti ti-calendar"></i>{{ stats.current_season }}
            </span>
        </div>
        <div class="c-card__body">
            <!-- League Type Tabs -->
            <div class="c-tabs mb-4" data-component="league-type-tabs">
                <a href="{{ url_for('admin_panel.manage_teams') }}"
                   class="c-tabs__link {% if not current_league_type %}c-tabs__link--active{% endif %}">
                    <i class="ti ti-list"></i>
                    All Teams
                    <span class="c-badge c-badge--secondary ms-2">{{ stats.total_teams }}</span>
                </a>
                <a href="{{ url_for('admin_panel.manage_teams', league_type='Pub League') }}"
                   class="c-tabs__link {% if current_league_type == 'Pub League' %}c-tabs__link--active{% endif %}">
                    <i class="ti ti-trophy"></i>
                    Pub League
                    <span class="c-badge c-badge--primary ms-2">{{ stats.teams_by_league_type.get('Pub League', 0) }}</span>
                </a>
                <a href="{{ url_for('admin_panel.manage_teams', league_type='ECS FC') }}"
                   class="c-tabs__link {% if current_league_type == 'ECS FC' %}c-tabs__link--active{% endif %}">
                    <i class="ti ti-shirt-sport"></i>
                    ECS FC
                    <span class="c-badge c-badge--success ms-2">{{ stats.teams_by_league_type.get('ECS FC', 0) }}</span>
                </a>
            </div>

            <!-- Additional Filters -->
            <div class="c-filter-form" data-component="filter-form">
                <form method="GET" class="c-filter-form__form">
                    {% if current_league_type %}
                    <input type="hidden" name="league_type" value="{{ current_league_type }}">
                    {% endif %}
                    <div class="c-filter-form__group">
                        <label class="c-filter-form__label">Division / League</label>
                        <select name="league_id" class="c-filter-form__select" data-filter="league">
                            <option value="">All Divisions</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}" {% if current_league_id == league.id %}selected{% endif %}>
                                {{ league.name }}
                                {% if league.season %}({{ league.season.league_type }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="c-filter-form__actions">
                        <button type="submit" class="c-btn c-btn--primary" data-action="apply-filter">
                            <i class="ti ti-search"></i>Filter
                        </button>
                        <a href="{{ url_for('admin_panel.manage_teams') }}" class="c-btn c-btn--outline-secondary" data-action="clear-filter">
                            <i class="ti ti-x"></i>Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Teams by League -->
{% if stats.teams_by_league %}
<div class="c-panel-section">
    <div class="c-card">
        <div class="c-card__header">
            <h5 class="c-card__title">
                <i class="ti ti-flag"></i>
                Teams by League
            </h5>
        </div>
        <div class="c-card__body">
            <div class="c-league-breakdown" data-component="league-breakdown">
                {% for league_name, team_count in stats.teams_by_league.items() %}
                <div class="c-league-breakdown__item" data-league="{{ league_name }}">
                    <span class="c-league-breakdown__name">{{ league_name }}</span>
                    <span class="c-badge c-badge--primary">{{ team_count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Teams Table -->
<div class="c-panel-section">
    <div class="c-card">
        <div class="c-card__header c-card__header--action">
            <h5 class="c-card__title">
                <i class="ti ti-shield"></i>
                All Teams
            </h5>
            <button class="c-btn c-btn--primary c-btn--sm" data-action="create-team">
                <i class="ti ti-plus"></i>Create Team
            </button>
        </div>
        <div class="c-card__body">
            {% if teams %}
            <div class="c-table-responsive">
                <table class="c-table" data-mobile-table data-table-type="teams">
                    <thead class="c-table__head">
                        <tr>
                            <th class="c-table__header">Team Name</th>
                            <th class="c-table__header">Type</th>
                            <th class="c-table__header">League / Division</th>
                            <th class="c-table__header">Players</th>
                            <th class="c-table__header">Status</th>
                            <th class="c-table__header">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="c-table__body">
                        {% for team in teams %}
                        <tr class="c-table__row">
                            <td class="c-table__cell">
                                <div class="c-team-name" data-component="team-name">
                                    <div class="c-team-avatar">
                                        <span class="c-team-avatar__initial">{{ team.name[0] if team.name else 'T' }}</span>
                                    </div>
                                    <strong>{{ team.name }}</strong>
                                </div>
                            </td>
                            <td class="c-table__cell">
                                {% if team.league and team.league.season %}
                                    {% if team.league.season.league_type == 'ECS FC' %}
                                        <span class="c-badge c-badge--success">
                                            <i class="ti ti-shirt-sport me-1"></i>ECS FC
                                        </span>
                                    {% else %}
                                        <span class="c-badge c-badge--primary">
                                            <i class="ti ti-trophy me-1"></i>Pub League
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="c-badge c-badge--secondary">Unknown</span>
                                {% endif %}
                            </td>
                            <td class="c-table__cell">
                                {% if team.league %}
                                    <span class="c-badge c-badge--info">{{ team.league.name }}</span>
                                {% else %}
                                    <span class="c-text-muted">No League</span>
                                {% endif %}
                            </td>
                            <td class="c-table__cell">
                                {% if team.players %}
                                    <span class="c-badge c-badge--success">{{ team.players|length }}</span>
                                {% else %}
                                    <span class="c-badge c-badge--secondary">0</span>
                                {% endif %}
                            </td>
                            <td class="c-table__cell">
                                {% if team.is_active %}
                                    <span class="c-badge c-badge--success">Active</span>
                                {% else %}
                                    <span class="c-badge c-badge--secondary">Inactive</span>
                                {% endif %}
                            </td>
                            <td class="c-table__cell">
                                <div class="c-btn-group">
                                    <button class="c-btn c-btn--icon c-btn--outline-info" data-action="view-team" data-team-id="{{ team.id }}" aria-label="View team">
                                        <i class="ti ti-eye"></i>
                                    </button>
                                    <button class="c-btn c-btn--icon c-btn--outline-warning" data-action="edit-team" data-team-id="{{ team.id }}" aria-label="Edit team">
                                        <i class="ti ti-edit"></i>
                                    </button>
                                    <button class="c-btn c-btn--icon c-btn--outline-info" data-action="manage-roster" data-team-id="{{ team.id }}" aria-label="Manage roster">
                                        <i class="ti ti-users"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="c-empty-state" data-component="empty-state">
                <i class="ti ti-shield-off c-empty-state__icon"></i>
                <h5 class="c-empty-state__title">No Teams Found</h5>
                <p class="c-empty-state__text">Create your first team to get started.</p>
                <button class="c-btn c-btn--primary" data-action="create-team">
                    <i class="ti ti-plus"></i>Create Team
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Help Alert -->
<div class="c-panel-section">
    <div class="c-alert c-alert--info">
        <i class="ti ti-info-circle c-alert__icon"></i>
        <div class="c-alert__content">
            <strong>Team Management:</strong>
            Manage all teams in your system. Create teams, assign them to leagues, and manage player rosters.
        </div>
    </div>
</div>

{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
// Match Operations configuration
window.MATCH_OPS_CONFIG = {
    createTeamUrl: '{{ url_for("admin_panel.create_team") }}',
    teamRostersUrl: '{{ url_for("admin_panel.team_rosters") }}',
    leaguesData: [
        {% for league in leagues %}
        { id: {{ league.id }}, name: "{{ league.name }}", leagueType: "{{ league.season.league_type if league.season else '' }}" }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
};
</script>
{% endblock %}
