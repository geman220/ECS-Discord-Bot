{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert, modal_info %}

{% block admin_title %}{{ league_config.name }} Substitute Pool{% endblock %}
{% block panel_description %}Manage substitute players for {{ league_config.name }}{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.match_operations') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">Match Operations</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.substitute_pools') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">Substitute Pools</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">{{ league_config.name }}</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- League Header -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6" style="border-left: 4px solid {{ league_config.color }}">
    <div class="p-5">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div class="flex items-center">
                <i class="{{ league_config.icon }} text-3xl mr-4" style="color: {{ league_config.color }}"></i>
                <div>
                    <h4 class="text-xl font-bold text-gray-900 dark:text-white">{{ league_config.name }} Substitute Pool</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Manage substitute players for {{ league_config.name }}</p>
                </div>
            </div>
            <button type="button" class="px-4 py-2 text-sm font-medium text-white rounded-lg js-add-player" style="background-color: {{ league_config.color }}" data-action="add-player">
                <i class="ti ti-user-plus mr-1"></i>Add Player
            </button>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
    <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ stats.total_active }}</div>
        <div class="text-sm text-blue-700 dark:text-blue-300">Active Subs</div>
    </div>
    <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{ stats.total_eligible }}</div>
        <div class="text-sm text-green-700 dark:text-green-300">Eligible</div>
    </div>
    <div class="bg-cyan-50 dark:bg-cyan-900/30 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-cyan-600 dark:text-cyan-400">{{ stats.total_requests_sent }}</div>
        <div class="text-sm text-cyan-700 dark:text-cyan-300">Requests</div>
    </div>
    <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{{ stats.total_matches_played }}</div>
        <div class="text-sm text-yellow-700 dark:text-yellow-300">Matches</div>
    </div>
    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-gray-600 dark:text-gray-400">{{ stats.pending_approval }}</div>
        <div class="text-sm text-gray-700 dark:text-gray-300">Available</div>
    </div>
    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 flex items-center justify-center">
        <button type="button" class="px-3 py-1.5 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800 js-load-stats" data-action="load-stats">
            <i class="ti ti-refresh mr-1"></i>Stats
        </button>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Active Substitutes -->
    <div class="lg:col-span-2">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="ti ti-users mr-2"></i>Active Substitutes
                </h5>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white" style="background-color: {{ league_config.color }}">{{ active_pools|length }} Players</span>
            </div>
            {% if active_pools %}
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" class="px-4 py-3">Player</th>
                            <th scope="col" class="px-4 py-3 text-center">Matches</th>
                            <th scope="col" class="px-4 py-3 text-center">Requests</th>
                            <th scope="col" class="px-4 py-3 text-center">Acceptance</th>
                            <th scope="col" class="px-4 py-3 text-center">Notifications</th>
                            <th scope="col" class="px-4 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pool in active_pools %}
                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="px-4 py-3">
                                <div class="flex items-center">
                                    <div class="flex items-center justify-center w-8 h-8 rounded-full text-white font-bold text-sm mr-3" style="background-color: {{ league_config.color }}">
                                        {{ pool.player.name[0] if pool.player else '?' }}
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900 dark:text-white">{{ pool.player.name if pool.player else 'Unknown' }}</div>
                                        <div class="flex gap-1 mt-1">
                                            {% if pool.player.phone %}
                                            <i class="ti ti-phone text-green-500 text-xs"></i>
                                            {% endif %}
                                            {% if pool.player.discord_id %}
                                            <i class="ti ti-brand-discord text-blue-500 text-xs"></i>
                                            {% endif %}
                                            {% if pool.player.user and pool.player.user.email %}
                                            <i class="ti ti-mail text-gray-500 text-xs"></i>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-300">{{ pool.matches_played }}</span>
                            </td>
                            <td class="px-4 py-3 text-center">{{ pool.requests_received }}</td>
                            <td class="px-4 py-3 text-center">
                                <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700 mb-1">
                                    <div class="h-2 rounded-full" style="width: {{ pool.acceptance_rate }}%; background-color: {{ league_config.color }}"></div>
                                </div>
                                <small class="text-gray-500 dark:text-gray-400">{{ pool.acceptance_rate|round(1) }}%</small>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex justify-center gap-1">
                                    <span class="inline-flex items-center justify-center w-5 h-5 rounded text-xs font-medium {{ 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' if pool.sms_for_sub_requests else 'bg-gray-100 text-gray-400 dark:bg-gray-700 dark:text-gray-500' }}" title="SMS">S</span>
                                    <span class="inline-flex items-center justify-center w-5 h-5 rounded text-xs font-medium {{ 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300' if pool.discord_for_sub_requests else 'bg-gray-100 text-gray-400 dark:bg-gray-700 dark:text-gray-500' }}" title="Discord">D</span>
                                    <span class="inline-flex items-center justify-center w-5 h-5 rounded text-xs font-medium {{ 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300' if pool.email_for_sub_requests else 'bg-gray-100 text-gray-400 dark:bg-gray-700 dark:text-gray-500' }}" title="Email">E</span>
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <button type="button" class="px-2 py-1 text-sm font-medium text-red-600 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 dark:bg-red-900/30 dark:text-red-400 dark:border-red-800 js-remove-player" data-action="remove-pool-player" data-player-id="{{ pool.player_id }}" data-player-name="{{ pool.player.name if pool.player else 'Unknown' }}">
                                    <i class="ti ti-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="flex items-center justify-center w-16 h-16 mx-auto rounded-full bg-gray-100 dark:bg-gray-700 mb-4">
                    <i class="ti ti-users-group text-3xl text-gray-400 dark:text-gray-500"></i>
                </div>
                <h5 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No Active Substitutes</h5>
                <p class="text-gray-500 dark:text-gray-400 mb-4">Add players to this substitute pool to get started.</p>
                <button type="button" class="px-4 py-2 text-sm font-medium text-white rounded-lg js-add-player" style="background-color: {{ league_config.color }}" data-action="add-player">
                    <i class="ti ti-user-plus mr-1"></i>Add First Player
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Available Players -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700">
                <h6 class="text-sm font-semibold text-gray-900 dark:text-white">
                    <i class="ti ti-user-check mr-2"></i>Available to Add
                </h6>
            </div>
            {% if available_players %}
            <div class="divide-y divide-gray-200 dark:divide-gray-700 max-h-64 overflow-y-auto">
                {% for player in available_players[:10] %}
                <div class="p-3 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700" id="available-player-{{ player.id }}">
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white text-sm">{{ player.name }}</div>
                        <div class="flex gap-1 mt-1">
                            {% if player.phone %}<i class="ti ti-phone text-green-500 text-xs"></i>{% endif %}
                            {% if player.discord_id %}<i class="ti ti-brand-discord text-blue-500 text-xs"></i>{% endif %}
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button type="button" class="p-1.5 text-green-600 bg-green-50 border border-green-200 rounded hover:bg-green-100 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800 js-add-to-pool" data-action="add-to-pool" data-player-id="{{ player.id }}" title="Add to pool">
                            <i class="ti ti-check text-sm"></i>
                        </button>
                        <button type="button" class="p-1.5 text-red-600 bg-red-50 border border-red-200 rounded hover:bg-red-100 dark:bg-red-900/30 dark:text-red-400 dark:border-red-800 js-reject-player" data-action="reject-player" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}" title="Reject">
                            <i class="ti ti-x text-sm"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if available_players|length > 10 %}
            <div class="p-3 text-center border-t border-gray-200 dark:border-gray-700">
                <small class="text-gray-500 dark:text-gray-400">+{{ available_players|length - 10 }} more eligible players</small>
            </div>
            {% endif %}
            {% else %}
            <div class="p-6 text-center">
                <p class="text-sm text-gray-500 dark:text-gray-400">No eligible players available</p>
            </div>
            {% endif %}
        </div>

        <!-- Recent Activity -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700">
                <h6 class="text-sm font-semibold text-gray-900 dark:text-white">
                    <i class="ti ti-history mr-2"></i>Recent Activity
                </h6>
            </div>
            {% if recent_activity %}
            <div class="divide-y divide-gray-200 dark:divide-gray-700 max-h-64 overflow-y-auto">
                {% for activity in recent_activity %}
                <div class="p-3">
                    <div class="flex justify-between items-center mb-1">
                        <small class="text-gray-500 dark:text-gray-400">
                            {{ activity.performed_at.strftime('%m/%d %H:%M') if activity.performed_at else '' }}
                        </small>
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium {% if activity.action == 'ADDED' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300{% elif activity.action == 'REMOVED' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300{% else %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300{% endif %}">
                            {{ activity.action }}
                        </span>
                    </div>
                    <div class="font-medium text-gray-900 dark:text-white text-sm">{{ activity.player.name if activity.player else 'Unknown' }}</div>
                    {% if activity.performer %}
                    <small class="text-gray-500 dark:text-gray-400">by {{ activity.performer.username }}</small>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="p-6 text-center">
                <p class="text-sm text-gray-500 dark:text-gray-400">No recent activity</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Player Modal -->
{% call modal_info('addPlayerModal', 'Add Player to ' ~ league_config.name ~ ' Pool', size='lg', footer=false) %}
    <div class="mb-4">
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Search Player</label>
        <input type="text" id="playerSearchInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" placeholder="Type player name or email...">
    </div>
    <div id="playerSearchResults" class="max-h-64 overflow-y-auto">
        <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Type at least 2 characters to search</p>
    </div>
{% endcall %}

<!-- Statistics Modal -->
{% call modal_info('statisticsModal', league_config.name ~ ' Pool Statistics', size='lg', footer=false) %}
    <div id="statisticsContent">
        <div class="flex justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        </div>
    </div>
{% endcall %}
{% endblock %}

{% block extra_js %}
<script>
const leagueType = '{{ league_type }}';
const leagueColor = '{{ league_config.color }}';
const _csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');

    // Add player button
    document.querySelectorAll('.js-add-player').forEach(btn => {
        btn.addEventListener('click', showAddPlayerModal);
    });

    // Load stats button
    document.querySelectorAll('.js-load-stats').forEach(btn => {
        btn.addEventListener('click', loadStatistics);
    });

    // Remove player buttons
    document.querySelectorAll('.js-remove-player').forEach(btn => {
        btn.addEventListener('click', function() {
            removeFromPool(this.dataset.playerId, this.dataset.playerName);
        });
    });

    // Add to pool buttons
    document.querySelectorAll('.js-add-to-pool').forEach(btn => {
        btn.addEventListener('click', function() {
            addToPool(this.dataset.playerId);
        });
    });

    // Reject player buttons
    document.querySelectorAll('.js-reject-player').forEach(btn => {
        btn.addEventListener('click', function() {
            rejectPlayer(this.dataset.playerId, this.dataset.playerName);
        });
    });
});

function showAddPlayerModal() {
    const modal = FlowbiteInstances.getInstance('Modal', 'addPlayerModal');
    if (modal) modal.show();
    document.getElementById('playerSearchInput').value = '';
    document.getElementById('playerSearchResults').innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Type at least 2 characters to search</p>';
    setTimeout(() => document.getElementById('playerSearchInput').focus(), 100);
}

function hideAddPlayerModal() {
    const modal = FlowbiteInstances.getInstance('Modal', 'addPlayerModal');
    if (modal) modal.hide();
}

function showStatisticsModal() {
    const modal = FlowbiteInstances.getInstance('Modal', 'statisticsModal');
    if (modal) modal.show();
}

function hideStatisticsModal() {
    const modal = FlowbiteInstances.getInstance('Modal', 'statisticsModal');
    if (modal) modal.hide();
}

// Player search
let searchTimeout;
document.getElementById('playerSearchInput').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();

    if (query.length < 2) {
        document.getElementById('playerSearchResults').innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Type at least 2 characters to search</p>';
        return;
    }

    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`{{ url_for('admin_panel.substitute_pool_player_search') }}?q=${encodeURIComponent(query)}&league_type=${encodeURIComponent(leagueType)}`);
            const data = await response.json();

            if (data.success && data.players.length > 0) {
                let html = '<div class="space-y-2">';
                data.players.forEach(player => {
                    const inPool = player.current_pools.includes(leagueType);
                    html += `
                        <div class="p-3 bg-gray-50 dark:bg-gray-600 rounded-lg flex justify-between items-center">
                            <div>
                                <div class="font-medium text-gray-900 dark:text-white">${player.name}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">${player.email || 'No email'}</div>
                            </div>
                            ${inPool ?
                                '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">Already in pool</span>' :
                                `<button type="button" class="px-3 py-1.5 text-sm font-medium text-white rounded-lg js-search-add" style="background-color: ${leagueColor}" data-player-id="${player.id}">
                                    <i class="ti ti-plus mr-1"></i>Add
                                </button>`
                            }
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('playerSearchResults').innerHTML = html;

                // Bind click handlers for search results
                document.querySelectorAll('.js-search-add').forEach(btn => {
                    btn.addEventListener('click', function() {
                        addToPool(this.dataset.playerId);
                    });
                });
            } else {
                document.getElementById('playerSearchResults').innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No players found</p>';
            }
        } catch (error) {
            console.error('Search error:', error);
        }
    }, 300);
});

async function addToPool(playerId) {
    const isDark = document.documentElement.classList.contains('dark');
    try {
        const response = await fetch(`/admin-panel/substitute-pools/${encodeURIComponent(leagueType)}/add-player`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': _csrfToken
            },
            body: JSON.stringify({ player_id: playerId })
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Player Added',
                text: data.message,
                timer: 2000,
                showConfirmButton: false,
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then(() => location.reload());
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message,
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            });
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to add player to pool',
            background: isDark ? '#1f2937' : '#ffffff',
            color: isDark ? '#f3f4f6' : '#111827'
        });
    }
}

async function removeFromPool(playerId, playerName) {
    const isDark = document.documentElement.classList.contains('dark');
    const result = await Swal.fire({
        title: 'Remove from Pool?',
        text: `Are you sure you want to remove ${playerName} from the ${leagueType} substitute pool?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        confirmButtonText: 'Yes, remove',
        background: isDark ? '#1f2937' : '#ffffff',
        color: isDark ? '#f3f4f6' : '#111827'
    });

    if (!result.isConfirmed) return;

    try {
        const response = await fetch(`/admin-panel/substitute-pools/${encodeURIComponent(leagueType)}/remove-player`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': _csrfToken
            },
            body: JSON.stringify({ player_id: playerId })
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Removed',
                text: data.message,
                timer: 2000,
                showConfirmButton: false,
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then(() => location.reload());
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message,
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            });
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to remove player',
            background: isDark ? '#1f2937' : '#ffffff',
            color: isDark ? '#f3f4f6' : '#111827'
        });
    }
}

async function rejectPlayer(playerId, playerName) {
    const isDark = document.documentElement.classList.contains('dark');
    const result = await Swal.fire({
        title: 'Reject Player?',
        text: `Are you sure you want to reject ${playerName}? They will no longer appear in the available players list.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        confirmButtonText: 'Yes, reject',
        input: 'text',
        inputLabel: 'Reason (optional)',
        inputPlaceholder: 'Enter reason for rejection...',
        background: isDark ? '#1f2937' : '#ffffff',
        color: isDark ? '#f3f4f6' : '#111827'
    });

    if (!result.isConfirmed) return;

    try {
        const response = await fetch(`/admin-panel/substitute-pools/${encodeURIComponent(leagueType)}/reject-player`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': _csrfToken
            },
            body: JSON.stringify({
                player_id: playerId,
                reason: result.value || 'Admin rejected'
            })
        });

        const data = await response.json();

        if (data.success) {
            const playerRow = document.getElementById(`available-player-${playerId}`);
            if (playerRow) playerRow.remove();

            Swal.fire({
                icon: 'success',
                title: 'Player Rejected',
                text: data.message,
                timer: 2000,
                showConfirmButton: false,
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message,
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            });
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to reject player',
            background: isDark ? '#1f2937' : '#ffffff',
            color: isDark ? '#f3f4f6' : '#111827'
        });
    }
}

async function loadStatistics() {
    showStatisticsModal();
    const isDark = document.documentElement.classList.contains('dark');

    try {
        const response = await fetch(`/admin-panel/substitute-pools/${encodeURIComponent(leagueType)}/statistics`);
        const data = await response.json();

        if (data.success) {
            const stats = data.statistics;
            let html = `
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-900 dark:text-white">${stats.total_active}</div>
                        <small class="text-gray-500 dark:text-gray-400">Active</small>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-900 dark:text-white">${stats.total_requests_sent}</div>
                        <small class="text-gray-500 dark:text-gray-400">Requests</small>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-900 dark:text-white">${stats.total_matches_played}</div>
                        <small class="text-gray-500 dark:text-gray-400">Matches</small>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-900 dark:text-white">${stats.average_acceptance_rate.toFixed(1)}%</div>
                        <small class="text-gray-500 dark:text-gray-400">Avg Acceptance</small>
                    </div>
                </div>

                <h6 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Notification Preferences</h6>
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-700 dark:text-gray-300">SMS</span>
                            <span class="text-gray-500 dark:text-gray-400">${stats.notification_preferences.sms_enabled}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                            <div class="bg-green-500 h-2 rounded-full" style="width: ${(stats.notification_preferences.sms_enabled / stats.total_active * 100).toFixed(0)}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-700 dark:text-gray-300">Discord</span>
                            <span class="text-gray-500 dark:text-gray-400">${stats.notification_preferences.discord_enabled}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: ${(stats.notification_preferences.discord_enabled / stats.total_active * 100).toFixed(0)}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-700 dark:text-gray-300">Email</span>
                            <span class="text-gray-500 dark:text-gray-400">${stats.notification_preferences.email_enabled}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                            <div class="bg-purple-500 h-2 rounded-full" style="width: ${(stats.notification_preferences.email_enabled / stats.total_active * 100).toFixed(0)}%"></div>
                        </div>
                    </div>
                </div>

                ${stats.top_performers.length > 0 ? `
                <h6 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Top Performers</h6>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th class="px-3 py-2">Player</th>
                                <th class="px-3 py-2 text-center">Matches</th>
                                <th class="px-3 py-2 text-center">Acceptance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stats.top_performers.map(p => `
                                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                    <td class="px-3 py-2 font-medium text-gray-900 dark:text-white">${p.player_name}</td>
                                    <td class="px-3 py-2 text-center">${p.matches_played}</td>
                                    <td class="px-3 py-2 text-center">${p.acceptance_rate.toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : '<p class="text-gray-500 dark:text-gray-400 text-center">No performance data yet</p>'}
            `;
            document.getElementById('statisticsContent').innerHTML = html;
        } else {
            document.getElementById('statisticsContent').innerHTML = '<div class="p-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-red-900/50 dark:text-red-300">Failed to load statistics</div>';
        }
    } catch (error) {
        document.getElementById('statisticsContent').innerHTML = '<div class="p-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-red-900/50 dark:text-red-300">Error loading statistics</div>';
    }
}
</script>
{% endblock %}
