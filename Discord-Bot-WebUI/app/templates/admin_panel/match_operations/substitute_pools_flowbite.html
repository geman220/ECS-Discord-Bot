{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert %}

{% block admin_title %}Substitute Pools{% endblock %}
{% block panel_description %}Manage substitute player pools{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.match_operations') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">Match Operations</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Substitute Pools</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Info Alert -->
<div class="p-4 mb-6 text-sm text-blue-800 rounded-lg bg-blue-50 dark:bg-blue-900/50 dark:text-blue-300">
    <div class="flex items-start">
        <i class="ti ti-users-group text-lg mr-3 mt-0.5"></i>
        <div>
            <strong>Substitute Pool Management</strong><br>
            Manage substitute pools for ECS FC, Classic, and Premier divisions. Add players to pools, track availability, and manage substitute requests.
        </div>
    </div>
</div>

<!-- League Pool Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    {% for league_type, data in pools_data.items() %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700" style="border-left: 4px solid {{ data.config.color }}">
            <div class="flex items-center justify-between">
                <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="{{ data.config.icon }} mr-2" style="color: {{ data.config.color }}"></i>{{ data.config.name }}
                </h5>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white" style="background-color: {{ data.config.color }}">
                    {{ data.total_active }} Active
                </span>
            </div>
        </div>
        <div class="p-5">
            <!-- Statistics -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="text-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                    <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ data.total_active }}</div>
                    <small class="text-gray-500 dark:text-gray-400">Active Subs</small>
                </div>
                <div class="text-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                    <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ data.active_pools|sum(attribute='matches_played') if data.active_pools else 0 }}</div>
                    <small class="text-gray-500 dark:text-gray-400">Matches Played</small>
                </div>
            </div>

            <!-- Top Substitutes Preview -->
            {% if data.active_pools %}
            <h6 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Top Substitutes</h6>
            <div class="space-y-2 max-h-48 overflow-y-auto mb-4">
                {% for pool in data.active_pools[:5] %}
                <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                    <div>
                        <span class="font-medium text-gray-900 dark:text-white text-sm">{{ pool.player.name if pool.player else 'Unknown' }}</span>
                        <div class="text-xs text-gray-500 dark:text-gray-400">{{ pool.matches_played }} matches</div>
                    </div>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">{{ pool.acceptance_rate|round(1) }}%</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-6">
                <i class="ti ti-users-group text-4xl text-gray-400 dark:text-gray-500"></i>
                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">No active substitutes</p>
            </div>
            {% endif %}
        </div>
        <div class="p-5 border-t border-gray-200 dark:border-gray-700">
            <a href="{{ url_for('admin_panel.substitute_pool_detail', league_type=league_type) }}" class="block w-full px-4 py-2 text-sm font-medium text-center text-white rounded-lg" style="background-color: {{ data.config.color }}">
                <i class="ti ti-settings mr-1"></i>Manage Pool
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Overall Statistics -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
    <div class="p-5 border-b border-gray-200 dark:border-gray-700">
        <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
            <i class="ti ti-chart-bar mr-2"></i>Overall Statistics
        </h5>
    </div>
    <div class="p-5">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                <div class="text-3xl font-bold text-blue-600 dark:text-blue-400">
                    {% set total = namespace(count=0) %}
                    {% for lt, data in pools_data.items() %}
                        {% set total.count = total.count + data.total_active %}
                    {% endfor %}
                    {{ total.count }}
                </div>
                <small class="text-gray-500 dark:text-gray-400">Total Substitutes</small>
            </div>
            <div class="text-center p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                <div class="text-3xl font-bold text-green-600 dark:text-green-400">
                    {% set matches = namespace(count=0) %}
                    {% for lt, data in pools_data.items() %}
                        {% for pool in data.active_pools %}
                            {% set matches.count = matches.count + pool.matches_played %}
                        {% endfor %}
                    {% endfor %}
                    {{ matches.count }}
                </div>
                <small class="text-gray-500 dark:text-gray-400">Total Matches Played</small>
            </div>
            <div class="text-center p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                <div class="text-3xl font-bold text-cyan-600 dark:text-cyan-400">
                    {% set requests = namespace(count=0) %}
                    {% for lt, data in pools_data.items() %}
                        {% for pool in data.active_pools %}
                            {% set requests.count = requests.count + pool.requests_received %}
                        {% endfor %}
                    {% endfor %}
                    {{ requests.count }}
                </div>
                <small class="text-gray-500 dark:text-gray-400">Requests Received</small>
            </div>
            <div class="text-center p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                <div class="text-3xl font-bold text-yellow-600 dark:text-yellow-400">{{ pools_data|length }}</div>
                <small class="text-gray-500 dark:text-gray-400">Active Leagues</small>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow">
    <div class="p-5 border-b border-gray-200 dark:border-gray-700">
        <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
            <i class="ti ti-bolt mr-2"></i>Quick Actions
        </h5>
    </div>
    <div class="p-5">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <a href="{{ url_for('admin_panel.substitute_management') }}" class="px-4 py-2 text-sm font-medium text-center text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800">
                <i class="ti ti-clipboard-list mr-1"></i>View Sub Requests
            </a>
            <button type="button" class="px-4 py-2 text-sm font-medium text-green-600 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800 js-search-player" data-action="search-player">
                <i class="ti ti-user-plus mr-1"></i>Add Player to Pool
            </button>
            <a href="{{ url_for('admin_panel.match_operations') }}" class="px-4 py-2 text-sm font-medium text-center text-cyan-600 bg-cyan-50 border border-cyan-200 rounded-lg hover:bg-cyan-100 dark:bg-cyan-900/30 dark:text-cyan-400 dark:border-cyan-800">
                <i class="ti ti-soccer-field mr-1"></i>Match Operations
            </a>
        </div>
    </div>
</div>

<!-- Player Search Modal -->
<div id="playerSearchModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-2xl max-h-full">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="ti ti-user-search mr-2"></i>Search Player to Add
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" onclick="hideSearchModal()">
                    <i class="ti ti-x text-lg"></i>
                </button>
            </div>
            <div class="p-4 md:p-5">
                <div class="mb-4">
                    <input type="text" id="playerSearchInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" placeholder="Type player name or email...">
                </div>
                <div id="playerSearchResults" class="max-h-64 overflow-y-auto">
                    <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Type at least 2 characters to search</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');

    const searchPlayerBtn = document.querySelector('.js-search-player');
    if (searchPlayerBtn) {
        searchPlayerBtn.addEventListener('click', function() {
            showSearchModal();
            document.getElementById('playerSearchInput').focus();
        });
    }

    let searchTimeout;
    const searchInput = document.getElementById('playerSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            if (query.length < 2) {
                document.getElementById('playerSearchResults').innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Type at least 2 characters to search</p>';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`{{ url_for('admin_panel.substitute_pool_player_search') }}?q=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    if (data.success && data.players.length > 0) {
                        let html = '<div class="space-y-2">';
                        data.players.forEach(player => {
                            html += `
                                <div class="p-3 bg-gray-50 dark:bg-gray-600 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="font-medium text-gray-900 dark:text-white">${player.name}</div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400">${player.email || 'No email'}</div>
                                        </div>
                                        <div class="flex gap-1">
                                            ${player.can_add_to.map(lt => `
                                                <button class="px-2 py-1 text-xs font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800 js-add-to-pool" data-player-id="${player.id}" data-league-type="${lt}">
                                                    Add to ${lt}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                                        Current pools: ${player.current_pools.length > 0 ? player.current_pools.join(', ') : 'None'}
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        document.getElementById('playerSearchResults').innerHTML = html;
                    } else {
                        document.getElementById('playerSearchResults').innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No players found</p>';
                    }
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        });
    }

    document.addEventListener('click', function(e) {
        if (e.target.closest('.js-add-to-pool')) {
            const btn = e.target.closest('.js-add-to-pool');
            const playerId = btn.dataset.playerId;
            const leagueType = btn.dataset.leagueType;
            addToPool(playerId, leagueType);
        }
    });
});

function showSearchModal() {
    document.getElementById('playerSearchModal').classList.remove('hidden');
    document.getElementById('playerSearchModal').classList.add('flex');
}

function hideSearchModal() {
    document.getElementById('playerSearchModal').classList.add('hidden');
    document.getElementById('playerSearchModal').classList.remove('flex');
}

async function addToPool(playerId, leagueType) {
    const isDark = document.documentElement.classList.contains('dark');
    try {
        const response = await fetch(`/admin-panel/substitute-pools/${encodeURIComponent(leagueType)}/add-player`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({ player_id: playerId })
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Player Added',
                text: data.message,
                timer: 2000,
                showConfirmButton: false,
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then(() => location.reload());
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message,
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            });
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to add player to pool',
            background: isDark ? '#1f2937' : '#ffffff',
            color: isDark ? '#f3f4f6' : '#111827'
        });
    }
}
</script>
{% endblock %}
