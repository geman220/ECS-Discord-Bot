{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert %}

{% block admin_title %}Live Reporting Dashboard{% endblock %}
{% block panel_description %}Real-time ESPN data integration and live reporting control center{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.mls_overview') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">MLS Management</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Live Reporting</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Page Header -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <h4 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-2">
        <i class="ti ti-broadcast text-ecs-green"></i>Live Reporting Dashboard
    </h4>
    <div class="flex items-center gap-3">
        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300">
            <i class="ti ti-refresh mr-1" id="refreshIcon"></i>
            Auto-refresh: <span id="countdown" class="ml-1">30</span>s
        </span>
        <button type="button" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600 js-refresh-page" data-action="refresh-page">
            <i class="ti ti-refresh mr-2"></i>Refresh Now
        </button>
    </div>
</div>

{% if error %}
<div class="flex items-center p-4 mb-6 text-red-800 rounded-lg bg-red-50 dark:bg-red-900/30 dark:text-red-400" role="alert">
    <i class="ti ti-alert-circle mr-3 text-xl"></i>
    <span class="font-medium">Error loading dashboard: {{ error }}</span>
</div>
{% endif %}

<!-- Status Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
    <!-- Real-time Service Status -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border-l-4 {{ 'border-green-500' if realtime_health.health == 'healthy' else 'border-yellow-500' if realtime_health.health == 'degraded' else 'border-red-500' }}">
        <div class="p-5">
            <div class="flex items-center mb-3">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/50 mr-3">
                    <i class="ti ti-server text-xl text-blue-600 dark:text-blue-400"></i>
                </div>
                <h6 class="text-sm font-semibold text-gray-900 dark:text-white">Real-time Service</h6>
            </div>
            <div class="flex justify-between items-center mb-2">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' if realtime_health.health == 'healthy' else 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' if realtime_health.health == 'degraded' else 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' }}">
                    {{ realtime_health.health|default('unknown')|title }}
                </span>
                <span class="text-xs text-gray-500 dark:text-gray-400">
                    {% if realtime_health.heartbeat_age_seconds %}
                        {{ realtime_health.heartbeat_age_seconds }}s ago
                    {% else %}
                        No heartbeat
                    {% endif %}
                </span>
            </div>
            {% if realtime_health.is_running %}
            <p class="text-sm text-green-600 dark:text-green-400 flex items-center">
                <i class="ti ti-check mr-1"></i> Service running
            </p>
            {% else %}
            <p class="text-sm text-red-600 dark:text-red-400 flex items-center">
                <i class="ti ti-x mr-1"></i> Service offline
            </p>
            {% endif %}
        </div>
    </div>

    <!-- Active Sessions -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border-l-4 border-blue-500">
        <div class="p-5">
            <div class="flex items-center mb-3">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-cyan-100 dark:bg-cyan-900/50 mr-3">
                    <i class="ti ti-player-play text-xl text-cyan-600 dark:text-cyan-400"></i>
                </div>
                <h6 class="text-sm font-semibold text-gray-900 dark:text-white">Active Sessions</h6>
            </div>
            <h3 class="text-3xl font-bold text-gray-900 dark:text-white mb-1">{{ stats.active_sessions }}</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">Live reporting sessions</p>
            {% if coordination_status.database_sessions %}
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">Database: {{ coordination_status.database_sessions }} sessions</p>
            {% endif %}
        </div>
    </div>

    <!-- Coordination Status -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border-l-4 {{ 'border-green-500' if coordination_status.coordination_status == 'healthy' else 'border-yellow-500' }}">
        <div class="p-5">
            <div class="flex items-center mb-3">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-900/50 mr-3">
                    <i class="ti ti-link text-xl text-yellow-600 dark:text-yellow-400"></i>
                </div>
                <h6 class="text-sm font-semibold text-gray-900 dark:text-white">Coordination</h6>
            </div>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' if coordination_status.coordination_status == 'healthy' else 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' }}">
                {{ coordination_status.coordination_status|default('unknown')|title }}
            </span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Celery - Real-time Bridge</p>
        </div>
    </div>

    <!-- Upcoming Matches -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border-l-4 border-gray-400">
        <div class="p-5">
            <div class="flex items-center mb-3">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 mr-3">
                    <i class="ti ti-calendar text-xl text-gray-600 dark:text-gray-400"></i>
                </div>
                <h6 class="text-sm font-semibold text-gray-900 dark:text-white">Upcoming Matches</h6>
            </div>
            <h3 class="text-3xl font-bold text-gray-900 dark:text-white mb-1">{{ stats.upcoming_matches }}</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">Next 14 days</p>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Active Sessions List -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="flex items-center justify-between p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-broadcast mr-2"></i>Active Sessions
            </h5>
            <a href="{{ url_for('admin_panel.mls_task_monitoring') }}" class="px-3 py-1.5 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800">
                Task Monitor
            </a>
        </div>
        <div class="max-h-96 overflow-y-auto">
            {% if active_sessions %}
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0">
                    <tr>
                        <th scope="col" class="px-4 py-3">Match</th>
                        <th scope="col" class="px-4 py-3">Status</th>
                        <th scope="col" class="px-4 py-3">Updates</th>
                        <th scope="col" class="px-4 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in active_sessions %}
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                        <td class="px-4 py-3">
                            <p class="font-medium text-gray-900 dark:text-white">Match {{ session.match_id }}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ session.competition or 'MLS' }}</p>
                        </td>
                        <td class="px-4 py-3">
                            {% if session.last_status %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-300">{{ session.last_status }}</span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">Active</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-gray-900 dark:text-white">{{ session.update_count or 0 }}</span>
                            {% if session.error_count and session.error_count > 0 %}
                            <br><span class="text-xs text-yellow-600 dark:text-yellow-400">{{ session.error_count }} errors</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <button type="button" class="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg js-stop-session" data-action="stop-session" data-session-id="{{ session.id }}" title="Stop Session">
                                <i class="ti ti-player-stop"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-12">
                <div class="flex items-center justify-center w-16 h-16 mx-auto rounded-full bg-gray-100 dark:bg-gray-700 mb-4">
                    <i class="ti ti-moon text-3xl text-gray-400 dark:text-gray-500"></i>
                </div>
                <p class="text-gray-500 dark:text-gray-400">No active live reporting sessions</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Upcoming Matches List -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="flex items-center justify-between p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-calendar mr-2"></i>Upcoming Matches
            </h5>
            <a href="{{ url_for('admin_panel.mls_matches') }}" class="px-3 py-1.5 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800">
                All Matches
            </a>
        </div>
        <div class="max-h-96 overflow-y-auto">
            {% if upcoming_matches %}
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0">
                    <tr>
                        <th scope="col" class="px-4 py-3">Match</th>
                        <th scope="col" class="px-4 py-3">Date/Time</th>
                        <th scope="col" class="px-4 py-3">Status</th>
                        <th scope="col" class="px-4 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for match in upcoming_matches %}
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                        <td class="px-4 py-3">
                            <p class="font-medium text-gray-900 dark:text-white">
                                {% if match.is_home_game %}
                                Sounders vs {{ match.opponent }}
                                {% else %}
                                {{ match.opponent }} vs Sounders
                                {% endif %}
                            </p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ match.competition or 'MLS' }}</p>
                        </td>
                        <td class="px-4 py-3">
                            <p class="text-gray-900 dark:text-white">{{ match.date_time.strftime('%b %d, %I:%M %p') if match.date_time else 'TBD' }}</p>
                            {% if match.venue %}
                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ match.venue }}</p>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="background-color: {{ match.status_color }}20; color: {{ match.status_color }};">
                                <i class="ti ti-{{ match.status_icon }} mr-1"></i>
                                {{ match.status_display }}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            {% if match.live_reporting_status != 'running' %}
                            <button type="button" class="p-2 text-green-600 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg js-start-reporting" data-action="start-reporting" data-match-id="{{ match.id }}" title="Start Live Reporting">
                                <i class="ti ti-player-play"></i>
                            </button>
                            {% else %}
                            <button type="button" class="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg js-stop-reporting" data-action="stop-reporting" data-match-id="{{ match.id }}" title="Stop Live Reporting">
                                <i class="ti ti-player-stop"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-12">
                <div class="flex items-center justify-center w-16 h-16 mx-auto rounded-full bg-gray-100 dark:bg-gray-700 mb-4">
                    <i class="ti ti-calendar-off text-3xl text-gray-400 dark:text-gray-500"></i>
                </div>
                <p class="text-gray-500 dark:text-gray-400">No upcoming matches in next 14 days</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Recent Sessions -->
{% if recent_sessions %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow">
    <div class="p-5 border-b border-gray-200 dark:border-gray-700">
        <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="ti ti-history mr-2"></i>Recent Sessions (Last 24 Hours)
        </h5>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-4 py-3">Session ID</th>
                    <th scope="col" class="px-4 py-3">Match</th>
                    <th scope="col" class="px-4 py-3">Started</th>
                    <th scope="col" class="px-4 py-3">Ended</th>
                    <th scope="col" class="px-4 py-3">Updates</th>
                    <th scope="col" class="px-4 py-3">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for session in recent_sessions %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                    <td class="px-4 py-3">
                        <code class="px-2 py-1 text-xs font-mono bg-gray-100 dark:bg-gray-700 rounded">{{ session.id }}</code>
                    </td>
                    <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">{{ session.match_id }}</td>
                    <td class="px-4 py-3 text-gray-600 dark:text-gray-400">{{ session.started_at.strftime('%m/%d %H:%M') if session.started_at else 'N/A' }}</td>
                    <td class="px-4 py-3 text-gray-600 dark:text-gray-400">{{ session.ended_at.strftime('%m/%d %H:%M') if session.ended_at else '-' }}</td>
                    <td class="px-4 py-3">{{ session.update_count or 0 }}</td>
                    <td class="px-4 py-3">
                        {% if session.is_active %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Active</span>
                        {% elif session.ended_at %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">Completed</span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Unknown</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
const _csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

// Event delegation for live reporting buttons
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.js-refresh-page').forEach(btn => {
        btn.addEventListener('click', function() {
            location.reload();
        });
    });

    document.querySelectorAll('.js-stop-session').forEach(btn => {
        btn.addEventListener('click', function() {
            const sessionId = this.dataset.sessionId;
            stopSession(sessionId);
        });
    });

    document.querySelectorAll('.js-start-reporting').forEach(btn => {
        btn.addEventListener('click', function() {
            const matchId = this.dataset.matchId;
            startReporting(matchId);
        });
    });

    document.querySelectorAll('.js-stop-reporting').forEach(btn => {
        btn.addEventListener('click', function() {
            const matchId = this.dataset.matchId;
            stopReporting(matchId);
        });
    });
});

// Auto-refresh countdown
let countdown = 30;
const countdownEl = document.getElementById('countdown');
const refreshIcon = document.getElementById('refreshIcon');

setInterval(() => {
    countdown--;
    if (countdownEl) countdownEl.textContent = countdown;

    if (countdown <= 0) {
        countdown = 30;
        if (refreshIcon) refreshIcon.classList.add('animate-spin');
        location.reload();
    }
}, 1000);

async function startReporting(matchId) {
    if (!confirm('Start live reporting for this match?')) return;

    try {
        const response = await fetch(`{{ url_for('admin_panel.mls_start_reporting', match_id=0) }}`.replace('/0/', `/${matchId}/`), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': _csrfToken
            }
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire('Success', data.message || 'Live reporting started', 'success').then(() => location.reload());
        } else {
            Swal.fire('Error', data.error || 'Failed to start reporting', 'error');
        }
    } catch (error) {
        Swal.fire('Error', 'Failed to start live reporting', 'error');
    }
}

async function stopReporting(matchId) {
    if (!confirm('Stop live reporting for this match?')) return;

    try {
        const response = await fetch(`{{ url_for('admin_panel.mls_stop_reporting', match_id=0) }}`.replace('/0/', `/${matchId}/`), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': _csrfToken
            }
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire('Success', data.message || 'Live reporting stopped', 'success').then(() => location.reload());
        } else {
            Swal.fire('Error', data.error || 'Failed to stop reporting', 'error');
        }
    } catch (error) {
        Swal.fire('Error', 'Failed to stop live reporting', 'error');
    }
}

async function stopSession(sessionId) {
    if (!confirm('Stop this reporting session?')) return;

    try {
        const response = await fetch(`/admin/live-reporting/api/session/${sessionId}/stop`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': _csrfToken
            }
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire('Success', 'Session stopped', 'success').then(() => location.reload());
        } else {
            Swal.fire('Error', data.error || 'Failed to stop session', 'error');
        }
    } catch (error) {
        Swal.fire('Error', 'Failed to stop session', 'error');
    }
}
</script>
{% endblock %}
