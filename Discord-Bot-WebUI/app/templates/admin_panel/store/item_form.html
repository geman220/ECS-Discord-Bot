{% extends "admin_panel/base.html" %}

{% block title %}{{ 'Edit Item' if action == 'edit' else 'Add New Item' }} - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin_panel.store_management') }}">Store Management</a>
</li>
<li class="breadcrumb-item">
    <a href="{{ url_for('admin_panel.store_items') }}">Items</a>
</li>
<li class="breadcrumb-item active">{{ 'Edit Item' if action == 'edit' else 'Add New Item' }}</li>
{% endblock %}

{% block panel_content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-{{ 'edit' if action == 'edit' else 'plus' }} me-2"></i>
                    {{ 'Edit Item' if action == 'edit' else 'Add New Item' }}
                </h5>
            </div>
            <div class="c-card__body">
                <form method="POST" id="itemForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <!-- Basic Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">Basic Information</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="store-item-name" class="form-label">Item Name *</label>
                                <input type="text" class="form-control" id="store-item-name" name="name" 
                                       value="{{ item.name if item else '' }}" required data-form-control>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">Category</label>
                                <input type="text" class="form-control" id="category" name="category" 
                                       value="{{ item.category if item else '' }}" 
                                       placeholder="e.g., Jerseys, Merchandise" data-form-control>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="store-item-description" class="form-label">Description</label>
                                <textarea class="form-control" id="store-item-description" name="description" rows="3"
                                          placeholder="Describe the item..." data-form-control>{{ item.description if item else '' }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing and Media -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">Pricing & Media</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="price" class="form-label">Price ($)</label>
                                <input type="number" class="form-control" id="price" name="price" 
                                       value="{{ item.price if item and item.price else '' }}" 
                                       step="0.01" min="0" placeholder="0.00" data-form-control>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="image_url" class="form-label">Image URL</label>
                                <input type="url" class="form-control" id="image_url" name="image_url" 
                                       value="{{ item.image_url if item else '' }}" 
                                       placeholder="https://example.com/image.jpg" data-form-control>
                            </div>
                        </div>
                    </div>

                    <!-- Colors -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">Available Colors</h6>
                            <div id="colorsContainer">
                                {% if item and item.available_colors %}
                                    {% set colors = item.available_colors | fromjson %}
                                    {% for color in colors %}
                                    <div class="input-group mb-2 color-input" data-input-group>
                                        <input type="text" class="form-control" name="color_{{ loop.index0 }}"
                                               value="{{ color }}" placeholder="Color name" data-form-control aria-label="Color name">
                                        <button type="button" class="c-btn c-btn--outline-danger js-remove-color" data-action="remove-color" aria-label="Button"><i class="ti ti-x"></i></button>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="input-group mb-2 color-input" data-input-group>
                                        <input type="text" class="form-control" name="color_0" placeholder="Color name" data-form-control aria-label="Color name">
                                        <button type="button" class="c-btn c-btn--outline-danger js-remove-color" data-action="remove-color" aria-label="Button"><i class="ti ti-x"></i></button>
                                    </div>
                                {% endif %}
                            </div>
                            <button type="button" class="c-btn c-btn--outline-primary c-btn--sm js-add-color" data-action="add-color">
                                <i class="ti ti-plus me-1"></i>Add Color
                            </button>
                        </div>
                    </div>

                    <!-- Sizes -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">Available Sizes</h6>
                            <div id="sizesContainer">
                                {% if item and item.available_sizes %}
                                    {% set sizes = item.available_sizes | fromjson %}
                                    {% for size in sizes %}
                                    <div class="input-group mb-2 size-input" data-input-group>
                                        <input type="text" class="form-control" name="size_{{ loop.index0 }}"
                                               value="{{ size }}" placeholder="Size (e.g., S, M, L, XL)" data-form-control aria-label="Size (e.g., S, M, L, XL)">
                                        <button type="button" class="c-btn c-btn--outline-danger js-remove-size" data-action="remove-size" aria-label="Button"><i class="ti ti-x"></i></button>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="input-group mb-2 size-input" data-input-group>
                                        <input type="text" class="form-control" name="size_0" placeholder="Size (e.g., S, M, L, XL)" data-form-control aria-label="Size (e.g., S, M, L, XL)">
                                        <button type="button" class="c-btn c-btn--outline-danger js-remove-size" data-action="remove-size" aria-label="Button"><i class="ti ti-x"></i></button>
                                    </div>
                                {% endif %}
                            </div>
                            <button type="button" class="c-btn c-btn--outline-primary c-btn--sm js-add-size" data-action="add-size">
                                <i class="ti ti-plus me-1"></i>Add Size
                            </button>
                        </div>
                    </div>

                    <!-- Status -->
                    {% if action == 'edit' %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">Status</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="store-item-is_active" name="is_active" 
                                       {% if item and item.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="store-item-is_active">
                                    Item is active and available for purchase
                                </label>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Form Actions -->
                    <div class="row">
                        <div class="col-12">
                            <hr>
                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('admin_panel.store_items') }}" class="c-btn c-btn--outline-secondary">
                                    <i class="ti ti-arrow-left me-1"></i>Cancel
                                </a>
                                <button type="submit" class="c-btn c-btn--primary">
                                    <i class="ti ti-device-floppy me-1"></i>
                                    {{ 'Update Item' if action == 'edit' else 'Create Item' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
let colorIndex = {{ (item.available_colors | fromjson | length) if item and item.available_colors else 1 }};
let sizeIndex = {{ (item.available_sizes | fromjson | length) if item and item.available_sizes else 1 }};

// Event delegation for dynamic buttons
document.addEventListener('DOMContentLoaded', function() {
    // Add color button
    document.querySelectorAll('.js-add-color').forEach(btn => {
        btn.addEventListener('click', addColorInput);
    });

    // Add size button
    document.querySelectorAll('.js-add-size').forEach(btn => {
        btn.addEventListener('click', addSizeInput);
    });

    // Remove color/size buttons (use event delegation on container)
    document.getElementById('colorsContainer').addEventListener('click', function(e) {
        const removeBtn = e.target.closest('.js-remove-color');
        if (removeBtn) {
            removeColorInput(removeBtn);
        }
    });

    document.getElementById('sizesContainer').addEventListener('click', function(e) {
        const removeBtn = e.target.closest('.js-remove-size');
        if (removeBtn) {
            removeSizeInput(removeBtn);
        }
    });
});

function addColorInput() {
    const container = document.getElementById('colorsContainer');
    const div = document.createElement('div');
    div.className = 'input-group mb-2 color-input';
    div.innerHTML = `
        <input type="text" class="form-control" name="color_${colorIndex}" placeholder="Color name" data-form-control aria-label="Color name">
        <button type="button" class="c-btn c-btn--outline-danger js-remove-color" data-action="remove-color" aria-label="Button"><i class="ti ti-x"></i></button>
    `;
    container.appendChild(div);
    colorIndex++;
}

function removeColorInput(button) {
    const container = document.getElementById('colorsContainer');
    if (container.children.length > 1) {
        button.parentElement.remove();
    }
}

function addSizeInput() {
    const container = document.getElementById('sizesContainer');
    const div = document.createElement('div');
    div.className = 'input-group mb-2 size-input';
    div.innerHTML = `
        <input type="text" class="form-control" name="size_${sizeIndex}" placeholder="Size (e.g., S, M, L, XL)" data-form-control aria-label="Size (e.g., S, M, L, XL)">
        <button type="button" class="c-btn c-btn--outline-danger js-remove-size" data-action="remove-size" aria-label="Button"><i class="ti ti-x"></i></button>
    `;
    container.appendChild(div);
    sizeIndex++;
}

function removeSizeInput(button) {
    const container = document.getElementById('sizesContainer');
    if (container.children.length > 1) {
        button.parentElement.remove();
    }
}

// Form validation
document.getElementById('itemForm').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value.trim();
    if (!name) {
        e.preventDefault();
        Swal.fire('Error', 'Item name is required.', 'error');
        return false;
    }
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="ti ti-loader me-1"></i>Saving...';
    submitBtn.disabled = true;
    
    // Re-enable button after 5 seconds in case of network issues
    setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 5000);
});
</script>
{% endblock %}