{% extends "admin_panel/base.html" %}
{% import 'macros.html' as macros %}

{% block title %}Admin Panel - Dashboard{% endblock %}

{% block panel_content %}
    <!-- Quick Stats -->
    <div class="c-admin-stats" data-component="admin-stats">
        <div class="c-admin-stats__grid">
            <button class="c-stat-card c-stat-card--clickable c-stat-card--primary"
                    data-action="navigate"
                    data-url="{{ url_for('admin_panel.feature_toggles') }}"
                    type="button"
                    aria-label="View system settings">
                <div class="c-stat-card__content">
                    <div class="c-stat-card__value">{{ stats.total_settings }}</div>
                    <div class="c-stat-card__label">System Settings</div>
                </div>
                <div class="c-stat-card__icon">
                    <i class="ti ti-adjustments-horizontal"></i>
                </div>
            </button>

            <button class="c-stat-card c-stat-card--clickable c-stat-card--success"
                    data-action="navigate"
                    data-url="{{ url_for('admin_panel.feature_toggles') }}"
                    type="button"
                    aria-label="View active features">
                <div class="c-stat-card__content">
                    <div class="c-stat-card__value">{{ stats.active_features }}</div>
                    <div class="c-stat-card__label">Active Features</div>
                </div>
                <div class="c-stat-card__icon">
                    <i class="ti ti-toggle-right"></i>
                </div>
            </button>

            <button class="c-stat-card c-stat-card--clickable c-stat-card--info"
                    data-action="navigate"
                    data-url="{{ url_for('admin_panel.user_management') }}"
                    type="button"
                    aria-label="View total users">
                <div class="c-stat-card__content">
                    <div class="c-stat-card__value">{{ stats.total_users }}</div>
                    <div class="c-stat-card__label">Total Users</div>
                </div>
                <div class="c-stat-card__icon">
                    <i class="ti ti-users"></i>
                </div>
            </button>

            <button class="c-stat-card c-stat-card--clickable c-stat-card--warning"
                    data-action="navigate"
                    data-url="{{ url_for('admin_panel.audit_logs') }}"
                    type="button"
                    aria-label="View recent changes">
                <div class="c-stat-card__content">
                    <div class="c-stat-card__value">{{ stats.recent_changes }}</div>
                    <div class="c-stat-card__label">Changes (7 days)</div>
                </div>
                <div class="c-stat-card__icon">
                    <i class="ti ti-history"></i>
                </div>
            </button>
        </div>
    </div>

    <!-- Admin Sections Grid -->
    <div class="c-admin-sections" data-component="admin-sections">
        <div class="c-admin-sections__grid">
            <!-- Feature Management -->
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="c-card__title">
                        <i class="ti ti-toggle-left c-card__title-icon c-card__title-icon--primary"></i>
                        <span>Feature Management</span>
                    </h5>
                </div>
                <div class="c-card__body">
                    <p class="c-card__description">Control system features and functionality</p>
                    <nav class="c-link-list" aria-label="Feature management options">
                        <a href="{{ url_for('admin_panel.feature_toggles') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-toggle-right c-link-list__icon"></i>
                                <span class="c-link-list__text">Feature Toggles</span>
                            </div>
                            <div class="c-link-list__meta">
                                <span class="c-badge c-badge--primary">{{ stats.active_features }}</span>
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>

                        <button class="c-link-list__item"
                                data-action="open-navigation-settings"
                                type="button">
                            <div class="c-link-list__content">
                                <i class="ti ti-navigation c-link-list__icon"></i>
                                <span class="c-link-list__text">Navigation Settings</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </button>

                        <button class="c-link-list__item"
                                data-action="open-registration-settings"
                                type="button">
                            <div class="c-link-list__content">
                                <i class="ti ti-user-plus c-link-list__icon"></i>
                                <span class="c-link-list__text">Registration Settings</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Communication Hub -->
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="c-card__title">
                        <i class="ti ti-message-circle c-card__title-icon c-card__title-icon--info"></i>
                        <span>Communication Hub</span>
                    </h5>
                </div>
                <div class="c-card__body">
                    <p class="c-card__description">Manage all communication channels</p>
                    <nav class="c-link-list" aria-label="Communication hub options">
                        <a href="{{ url_for('admin_panel.communication_hub') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-template c-link-list__icon"></i>
                                <span class="c-link-list__text">Message Templates</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>

                        <a href="{{ url_for('admin_panel.communication_hub') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-clock c-link-list__icon"></i>
                                <span class="c-link-list__text">Scheduled Messages</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>

                        <a href="{{ url_for('admin_panel.communication_hub') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-bell c-link-list__icon"></i>
                                <span class="c-link-list__text">Push Notifications</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>
                    </nav>
                </div>
            </div>

            <!-- User Management -->
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="c-card__title">
                        <i class="ti ti-users c-card__title-icon c-card__title-icon--success"></i>
                        <span>User Management</span>
                    </h5>
                </div>
                <div class="c-card__body">
                    <p class="c-card__description">Manage users, roles, and permissions</p>
                    <nav class="c-link-list" aria-label="User management options">
                        <a href="{{ url_for('admin_panel.users_comprehensive') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-users c-link-list__icon"></i>
                                <span class="c-link-list__text">User Management</span>
                            </div>
                            <div class="c-link-list__meta">
                                {% if pending_approvals > 0 %}
                                <span class="c-badge c-badge--danger">{{ pending_approvals }}</span>
                                {% endif %}
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>

                        <a href="{{ url_for('admin_panel.roles_comprehensive') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-shield-check c-link-list__icon"></i>
                                <span class="c-link-list__text">Role Management</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>

                        <a href="{{ url_for('admin_panel.user_management') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-settings c-link-list__icon"></i>
                                <span class="c-link-list__text">User Hub & Settings</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>
                    </nav>
                </div>
            </div>

            <!-- System Monitoring -->
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="c-card__title">
                        <i class="ti ti-activity c-card__title-icon c-card__title-icon--warning"></i>
                        <span>System Monitoring</span>
                    </h5>
                </div>
                <div class="c-card__body">
                    <p class="c-card__description">Monitor system health and performance</p>
                    <nav class="c-link-list" aria-label="System monitoring options">
                        <button class="c-link-list__item"
                                data-action="open-task-monitor"
                                type="button">
                            <div class="c-link-list__content">
                                <i class="ti ti-chart-dots c-link-list__icon"></i>
                                <span class="c-link-list__text">Task Monitor</span>
                            </div>
                            <div class="c-link-list__meta">
                                <span class="c-status-indicator c-status-indicator--active"></span>
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </button>

                        <button class="c-link-list__item"
                                data-action="open-database-monitor"
                                type="button">
                            <div class="c-link-list__content">
                                <i class="ti ti-database c-link-list__icon"></i>
                                <span class="c-link-list__text">Database Monitor</span>
                            </div>
                            <div class="c-link-list__meta">
                                <span class="c-status-indicator c-status-indicator--active"></span>
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </button>

                        <a href="{{ url_for('admin_panel.system_monitoring') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-info-circle c-link-list__icon"></i>
                                <span class="c-link-list__text">System Information</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Match & League Operations -->
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="c-card__title">
                        <i class="ti ti-trophy c-card__title-icon c-card__title-icon--danger"></i>
                        <span>Match & League Ops</span>
                    </h5>
                </div>
                <div class="c-card__body">
                    <p class="c-card__description">Manage matches and league operations</p>
                    <nav class="c-link-list" aria-label="Match and league operations">
                        <a href="{{ url_for('admin_panel.match_verification') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-clipboard-check c-link-list__icon"></i>
                                <span class="c-link-list__text">Match Verification</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>

                        <a href="{{ url_for('admin_panel.match_operations') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-trophy c-link-list__icon"></i>
                                <span class="c-link-list__text">Match Operations</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>

                        <a href="{{ url_for('admin_panel.live_reporting_dashboard') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-broadcast c-link-list__icon"></i>
                                <span class="c-link-list__text">Live Reporting</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>

                        <button class="c-link-list__item"
                                data-action="open-match-reports"
                                type="button">
                            <div class="c-link-list__content">
                                <i class="ti ti-chart-bar c-link-list__icon"></i>
                                <span class="c-link-list__text">Match Reports</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Mobile Features -->
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="c-card__title">
                        <i class="ti ti-device-mobile c-card__title-icon c-card__title-icon--purple"></i>
                        <span>Mobile Features</span>
                    </h5>
                </div>
                <div class="c-card__body">
                    <p class="c-card__description">Mobile app and wallet management</p>
                    <nav class="c-link-list" aria-label="Mobile features">
                        <a href="{{ url_for('wallet_admin.wallet_management') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-wallet c-link-list__icon"></i>
                                <span class="c-link-list__text">Apple Wallet Passes</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>

                        <a href="{{ url_for('wallet_admin.wallet_players') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-user-cog c-link-list__icon"></i>
                                <span class="c-link-list__text">Player Eligibility</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>

                        {% if 'Global Admin' in user_roles %}
                        <a href="{{ url_for('wallet_admin.wallet_config') }}"
                           class="c-link-list__item"
                           data-action="navigate-link">
                            <div class="c-link-list__content">
                                <i class="ti ti-settings-2 c-link-list__icon"></i>
                                <span class="c-link-list__text">Wallet Configuration</span>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="c-admin-activity" data-component="admin-activity">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title">
                    <i class="ti ti-activity c-card__title-icon"></i>
                    <span>Recent Admin Activity</span>
                </h5>
                <div class="c-card__actions">
                    <a href="{{ url_for('admin_panel.audit_logs') }}"
                       class="c-btn c-btn--sm c-btn--outline-primary"
                       data-action="view-all-logs">
                        <span>View All</span>
                        <i class="ti ti-arrow-right"></i>
                    </a>
                </div>
            </div>
            <div class="c-card__body">
                {% if recent_actions %}
                <div class="c-table-wrapper" data-component="activity-table">
                    <table class="c-table c-table--hoverable c-table--compact">
                        <thead class="c-table__head">
                            <tr class="c-table__row">
                                <th class="c-table__header">Time</th>
                                <th class="c-table__header">User</th>
                                <th class="c-table__header">Action</th>
                                <th class="c-table__header">Resource</th>
                                <th class="c-table__header">Details</th>
                            </tr>
                        </thead>
                        <tbody class="c-table__body">
                            {% for action in recent_actions[:5] %}
                            <tr class="c-table__row">
                                <td class="c-table__cell" data-label="Time">
                                    <small>{{ action.timestamp.strftime('%m/%d %H:%M') }}</small>
                                </td>
                                <td class="c-table__cell" data-label="User">
                                    {% if action.user %}
                                        {{ action.user.name or action.user.username }}
                                    {% else %}
                                        User {{ action.user_id }}
                                    {% endif %}
                                </td>
                                <td class="c-table__cell" data-label="Action">
                                    <span class="c-badge c-badge--{% if action.action == 'toggle' %}info{% elif action.action == 'update' %}warning{% elif action.action == 'create' %}success{% elif action.action == 'delete' %}danger{% else %}secondary{% endif %}">
                                        {{ action.action.title() }}
                                    </span>
                                </td>
                                <td class="c-table__cell" data-label="Resource">{{ action.resource_type }}</td>
                                <td class="c-table__cell" data-label="Details">
                                    <small>
                                        {% if action.resource_id %}{{ action.resource_id }}{% endif %}
                                        {% if action.old_value and action.new_value %}
                                            <br>{{ action.old_value }} â†’ {{ action.new_value }}
                                        {% elif action.new_value %}
                                            <br>Set to: {{ action.new_value }}
                                        {% endif %}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="c-empty-state" data-component="empty-state">
                    <div class="c-empty-state__icon c-empty-state__icon--primary">
                        <i class="ti ti-activity"></i>
                    </div>
                    <div class="c-empty-state__content">
                        <h6 class="c-empty-state__title">No recent activity</h6>
                        <p class="c-empty-state__description">Admin actions will appear here</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Initialize Settings Button if needed -->
    {% if stats.total_settings == 0 %}
    <div class="c-admin-warning" data-component="setup-warning">
        <div class="c-card c-card--warning">
            <div class="c-card__body">
                <div class="c-alert-inline c-alert-inline--warning">
                    <div class="c-alert-inline__content">
                        <i class="ti ti-alert-triangle c-alert-inline__icon"></i>
                        <strong>Setup Required:</strong> Admin settings have not been initialized yet.
                    </div>
                    <form method="POST"
                          action="{{ url_for('admin_panel.initialize_settings') }}"
                          class="c-alert-inline__action">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit"
                                class="c-btn c-btn--warning c-btn--sm"
                                data-action="initialize-settings">
                            <i class="ti ti-settings"></i>
                            <span>Initialize Settings</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endblock %}

{% block custom_css %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin-panel/dashboard.css') }}">
{% endif %}
{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="{{ url_for('static', filename='js/admin-panel-dashboard.js') }}"></script>
{% endif %}
{% endblock %}
