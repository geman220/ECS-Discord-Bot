{% extends "admin_panel/base.html" %}
{% import 'macros.html' as macros %}

{% block title %}Database Monitor - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin_panel.system_monitoring') }}">System Monitoring</a>
</li>
<li class="breadcrumb-item active">Database Monitor</li>
{% endblock %}

{% block panel_content %}

    <!-- Database Status Overview -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card bg-{% if db_stats.status == 'connected' %}success{% else %}danger{% endif %} text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ db_stats.status|title or 'Unknown' }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Connection Status</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-{% if db_stats.status == 'connected' %}database-check{% else %}database-x{% endif %} u-card-icon-stat"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card bg-primary text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ db_stats.active_connections or 0 }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Active Connections</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-plug-connected u-card-icon-stat"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card bg-info text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ db_stats.queries_per_sec or 0 }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Queries/Sec</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-activity u-card-icon-stat"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card bg-warning text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ db_stats.avg_query_time or '0ms' }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Avg Query Time</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-clock u-card-icon-stat"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Pool Status -->
    <div class="row mb-4">
        <div class="col-md-8 mb-3">
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-pool me-2"></i>Connection Pool Status
                    </h5>
                </div>
                <div class="c-card__body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label small text-muted">Pool Size</label>
                                <div class="progress mb-2 u-h-25">
                                    {% set pool_percentage = ((db_stats.active_connections or 0) / (db_stats.max_connections or 20) * 100) %}
                                    <div class="progress-bar bg-{% if pool_percentage > 80 %}danger{% elif pool_percentage > 60 %}warning{% else %}success{% endif %}"
                                         role="progressbar" data-width="{{ pool_percentage }}">
                                        {{ db_stats.active_connections or 0 }}/{{ db_stats.max_connections or 20 }}
                                    </div>
                                </div>
                                <small class="text-muted">{{ pool_percentage|round(1) }}% utilized</small>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="d-flex align-items-center">
                                        <div class="status-indicator active me-2"></div>
                                        <span class="small">Active: {{ db_stats.active_connections or 0 }}</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-flex align-items-center">
                                        <div class="status-indicator status-secondary"></div>
                                        <span class="small ms-2">Idle: {{ (db_stats.max_connections or 20) - (db_stats.active_connections or 0) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span class="small">Max Connections</span>
                                    <span class="badge bg-primary" data-badge>{{ db_stats.max_connections or 20 }}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span class="small">Connection Timeout</span>
                                    <span class="badge bg-secondary" data-badge>{{ db_stats.timeout or '30s' }}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span class="small">Pool Overflow</span>
                                    <span class="badge bg-info" data-badge>{{ db_stats.overflow or 5 }}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span class="small">Failed Connections</span>
                                    <span class="badge bg-{% if (db_stats.failed_connections or 0) > 0 %}danger{% else %}success{% endif %}" data-badge>
                                        {{ db_stats.failed_connections or 0 }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-server me-2"></i>Database Info
                    </h5>
                </div>
                <div class="c-card__body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="small">Database Type</span>
                            <span class="badge bg-primary" data-badge>{{ db_info.type or 'PostgreSQL' }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="small">Version</span>
                            <span class="badge bg-secondary" data-badge>{{ db_info.version or '13.x' }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="small">Database Size</span>
                            <span class="badge bg-info" data-badge>{{ db_info.size or '45MB' }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="small">Tables</span>
                            <span class="badge bg-success" data-badge>{{ db_info.table_count or 12 }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="small">Uptime</span>
                            <span class="badge bg-warning" data-badge>{{ db_info.uptime or '7d 3h' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Query Performance -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__header d-flex justify-content-between align-items-center">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-chart-line me-2"></i>Query Performance
                    </h5>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="perf_period" id="perf_1h" autocomplete="off" checked>
                        <label class="c-btn c-btn--outline-primary c-btn--sm" for="perf_1h">1H</label>
                        
                        <input type="radio" class="btn-check" name="perf_period" id="perf_24h" autocomplete="off">
                        <label class="c-btn c-btn--outline-primary c-btn--sm" for="perf_24h">24H</label>
                        
                        <input type="radio" class="btn-check" name="perf_period" id="perf_7d" autocomplete="off">
                        <label class="c-btn c-btn--outline-primary c-btn--sm" for="perf_7d">7D</label>
                    </div>
                </div>
                <div class="c-card__body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center p-3 border-end">
                                <div class="h4 mb-1 text-success">{{ query_stats.total_queries or 1250 }}</div>
                                <div class="text-muted small">Total Queries</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border-end">
                                <div class="h4 mb-1 text-info">{{ query_stats.avg_time or '45ms' }}</div>
                                <div class="text-muted small">Avg Response Time</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border-end">
                                <div class="h4 mb-1 text-warning">{{ query_stats.slow_queries or 3 }}</div>
                                <div class="text-muted small">Slow Queries (>1s)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <div class="h4 mb-1 text-danger">{{ query_stats.failed_queries or 0 }}</div>
                                <div class="text-muted small">Failed Queries</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Slow Queries & Recent Activity -->
    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-clock-exclamation me-2"></i>Slow Queries
                    </h5>
                </div>
                <div class="c-card__body p-0">
                    {% if slow_queries %}
                    <div class="c-table-wrapper" data-table-responsive>
                        <table class="c-c-table c-table--hoverable mb-0" data-table data-mobile-table data-table-type="logs">
                            <thead class="c-table--light" scope="col">
                                <tr>
                                    <th scope="col">Query</th>
                                    <th scope="col">Duration</th>
                                    <th scope="col">Table</th>
                                    <th scope="col">Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for query in slow_queries %}
                                <tr>
                                    <td data-label="Query">
                                        <code class="small">{{ query.sql[:40] }}...</code>
                                    </td>
                                    <td data-label="Duration">
                                        <span class="badge bg-{% if query.duration > 5000 %}danger{% elif query.duration > 1000 %}warning{% else %}secondary{% endif %}" data-badge>
                                            {{ query.duration }}ms
                                        </span>
                                    </td>
                                    <td data-label="Table">
                                        <small>{{ query.table or 'unknown' }}</small>
                                    </td>
                                    <td data-label="Time">
                                        <small>{{ query.timestamp.strftime('%H:%M:%S') if query.timestamp else 'Unknown' }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="ti ti-clock-check text-success u-icon-xl"></i>
                        <p class="text-muted mt-2">No slow queries detected</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-3">
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-activity me-2"></i>Recent Activity
                    </h5>
                </div>
                <div class="c-card__body">
                    {% if recent_activity %}
                    <div class="list-group list-group-flush">
                        {% for activity in recent_activity %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="d-flex align-items-center">
                                        <i class="ti ti-{% if activity.type == 'SELECT' %}eye{% elif activity.type == 'INSERT' %}plus{% elif activity.type == 'UPDATE' %}edit{% elif activity.type == 'DELETE' %}trash{% else %}database{% endif %} me-2 text-{% if activity.type == 'SELECT' %}info{% elif activity.type == 'INSERT' %}success{% elif activity.type == 'UPDATE' %}warning{% elif activity.type == 'DELETE' %}danger{% else %}secondary{% endif %}"></i>
                                        <strong>{{ activity.type }}</strong>
                                    </div>
                                    <small class="text-muted">{{ activity.table or 'unknown' }} table</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">{{ activity.timestamp.strftime('%H:%M:%S') if activity.timestamp else 'Unknown' }}</small>
                                    <br><span class="badge bg-secondary" data-badge>{{ activity.duration or '0' }}ms</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="ti ti-database-off text-muted u-icon-xl"></i>
                        <p class="text-muted mt-2">No recent activity</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Database Health Check -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__header d-flex justify-content-between align-items-center">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-health-recognition me-2"></i>Database Health Check
                    </h5>
                    <button class="c-btn c-btn--outline-primary c-btn--sm" data-action="run-health-check" data-health-check-url="{{ url_for('admin_panel.run_db_health_check') }}">
                        <i class="ti ti-refresh me-1"></i>Run Check
                    </button>
                </div>
                <div class="c-card__body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center p-3">
                                <div class="status-indicator {% if health_check.connection %}active{% else %}inactive{% endif %} me-3"></div>
                                <div>
                                    <div class="fw-medium">Connection Test</div>
                                    <small class="text-muted">
                                        {% if health_check.connection %}Healthy{% else %}Failed{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center p-3">
                                <div class="status-indicator {% if health_check.query_test %}active{% else %}inactive{% endif %} me-3"></div>
                                <div>
                                    <div class="fw-medium">Query Test</div>
                                    <small class="text-muted">{{ health_check.query_time or '25ms' }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center p-3">
                                <div class="status-indicator {% if health_check.table_check %}active{% else %}inactive{% endif %} me-3"></div>
                                <div>
                                    <div class="fw-medium">Table Integrity</div>
                                    <small class="text-muted">
                                        {% if health_check.table_check %}OK{% else %}Issues Found{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center p-3">
                                <div class="status-indicator {% if health_check.performance %}active{% else %}inactive{% endif %} me-3"></div>
                                <div>
                                    <div class="fw-medium">Performance</div>
                                    <small class="text-muted">
                                        {% if health_check.performance %}Good{% else %}Degraded{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            Last health check: {{ health_check.last_run.strftime('%Y-%m-%d %H:%M:%S') if health_check.last_run else 'Never' }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-tools me-2"></i>Database Actions
                    </h5>
                </div>
                <div class="c-card__body">
                    <div class="btn-group me-2" role="group">
                        <button class="c-btn c-btn--outline-info" data-action="refresh-connections">
                            <i class="ti ti-refresh me-1"></i>Refresh Connections
                        </button>
                        <button class="c-btn c-btn--outline-warning" data-action="flush-query-cache">
                            <i class="ti ti-trash me-1"></i>Flush Query Cache
                        </button>
                        <button class="c-btn c-btn--outline-primary" data-action="analyze-performance">
                            <i class="ti ti-chart-line me-1"></i>Analyze Performance
                        </button>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="c-btn c-btn--outline-success" data-action="optimize-database">
                            <i class="ti ti-tool me-1"></i>Optimize Database
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block custom_css %}
{{ super() }}
{# Styles moved to external CSS #}
{% endblock %}

{% block custom_js %}
{{ super() }}
{# Event handlers managed by monitoring-handlers.js via EventDelegation #}
<script>
(function() {
    'use strict';

    // Register initialization with InitSystem
    if (typeof InitSystem !== 'undefined') {
        InitSystem.register('database-monitor', initDatabaseMonitor);
    } else {
        document.addEventListener('DOMContentLoaded', initDatabaseMonitor);
    }

    function initDatabaseMonitor() {
        // Handle performance period filter
        document.querySelectorAll('input[name="perf_period"]').forEach(radio => {
            radio.addEventListener('change', function() {
                console.log('Performance period changed to:', this.id.replace('perf_', ''));
            });
        });
    }
})();
</script>
{% endblock %}