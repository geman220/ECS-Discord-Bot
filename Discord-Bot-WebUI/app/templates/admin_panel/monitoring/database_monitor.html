{% extends "admin_panel/base.html" %}
{% import 'macros.html' as macros %}

{% block title %}Database Monitor - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin_panel.system_monitoring') }}">System Monitoring</a>
</li>
<li class="breadcrumb-item active">Database Monitor</li>
{% endblock %}

{% block panel_content %}

    <!-- Database Status Overview -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-{% if db_stats.status == 'connected' %}success{% else %}danger{% endif %} text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-white mb-1">{{ db_stats.status|title or 'Unknown' }}</h5>
                            <p class="card-text small opacity-75 mb-0">Connection Status</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-{% if db_stats.status == 'connected' %}database-check{% else %}database-x{% endif %}" style="font-size: 2rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-white mb-1">{{ db_stats.active_connections or 0 }}</h5>
                            <p class="card-text small opacity-75 mb-0">Active Connections</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-plug-connected" style="font-size: 2rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-white mb-1">{{ db_stats.queries_per_sec or 0 }}</h5>
                            <p class="card-text small opacity-75 mb-0">Queries/Sec</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-activity" style="font-size: 2rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-white mb-1">{{ db_stats.avg_query_time or '0ms' }}</h5>
                            <p class="card-text small opacity-75 mb-0">Avg Query Time</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-clock" style="font-size: 2rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Pool Status -->
    <div class="row mb-4">
        <div class="col-md-8 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="ti ti-pool me-2"></i>Connection Pool Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label small text-muted">Pool Size</label>
                                <div class="progress mb-2" style="height: 25px;">
                                    {% set pool_percentage = ((db_stats.active_connections or 0) / (db_stats.max_connections or 20) * 100) %}
                                    <div class="progress-bar bg-{% if pool_percentage > 80 %}danger{% elif pool_percentage > 60 %}warning{% else %}success{% endif %}" 
                                         role="progressbar" style="width: {{ pool_percentage }}%">
                                        {{ db_stats.active_connections or 0 }}/{{ db_stats.max_connections or 20 }}
                                    </div>
                                </div>
                                <small class="text-muted">{{ pool_percentage|round(1) }}% utilized</small>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="d-flex align-items-center">
                                        <div class="status-indicator active me-2"></div>
                                        <span class="small">Active: {{ db_stats.active_connections or 0 }}</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-flex align-items-center">
                                        <div class="status-indicator" style="background-color: #6c757d;" ></div>
                                        <span class="small ms-2">Idle: {{ (db_stats.max_connections or 20) - (db_stats.active_connections or 0) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span class="small">Max Connections</span>
                                    <span class="badge bg-primary">{{ db_stats.max_connections or 20 }}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span class="small">Connection Timeout</span>
                                    <span class="badge bg-secondary">{{ db_stats.timeout or '30s' }}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span class="small">Pool Overflow</span>
                                    <span class="badge bg-info">{{ db_stats.overflow or 5 }}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span class="small">Failed Connections</span>
                                    <span class="badge bg-{% if (db_stats.failed_connections or 0) > 0 %}danger{% else %}success{% endif %}">
                                        {{ db_stats.failed_connections or 0 }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="ti ti-server me-2"></i>Database Info
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="small">Database Type</span>
                            <span class="badge bg-primary">{{ db_info.type or 'PostgreSQL' }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="small">Version</span>
                            <span class="badge bg-secondary">{{ db_info.version or '13.x' }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="small">Database Size</span>
                            <span class="badge bg-info">{{ db_info.size or '45MB' }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="small">Tables</span>
                            <span class="badge bg-success">{{ db_info.table_count or 12 }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="small">Uptime</span>
                            <span class="badge bg-warning">{{ db_info.uptime or '7d 3h' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Query Performance -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="ti ti-chart-line me-2"></i>Query Performance
                    </h5>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="perf_period" id="perf_1h" autocomplete="off" checked>
                        <label class="btn btn-outline-primary btn-sm" for="perf_1h">1H</label>
                        
                        <input type="radio" class="btn-check" name="perf_period" id="perf_24h" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="perf_24h">24H</label>
                        
                        <input type="radio" class="btn-check" name="perf_period" id="perf_7d" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="perf_7d">7D</label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center p-3 border-end">
                                <div class="h4 mb-1 text-success">{{ query_stats.total_queries or 1250 }}</div>
                                <div class="text-muted small">Total Queries</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border-end">
                                <div class="h4 mb-1 text-info">{{ query_stats.avg_time or '45ms' }}</div>
                                <div class="text-muted small">Avg Response Time</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border-end">
                                <div class="h4 mb-1 text-warning">{{ query_stats.slow_queries or 3 }}</div>
                                <div class="text-muted small">Slow Queries (>1s)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <div class="h4 mb-1 text-danger">{{ query_stats.failed_queries or 0 }}</div>
                                <div class="text-muted small">Failed Queries</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Slow Queries & Recent Activity -->
    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="ti ti-clock-exclamation me-2"></i>Slow Queries
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if slow_queries %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Query</th>
                                    <th>Duration</th>
                                    <th>Table</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for query in slow_queries %}
                                <tr>
                                    <td>
                                        <code class="small">{{ query.sql[:40] }}...</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if query.duration > 5000 %}danger{% elif query.duration > 1000 %}warning{% else %}secondary{% endif %}">
                                            {{ query.duration }}ms
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{ query.table or 'unknown' }}</small>
                                    </td>
                                    <td>
                                        <small>{{ query.timestamp.strftime('%H:%M:%S') if query.timestamp else 'Unknown' }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="ti ti-clock-check text-success" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">No slow queries detected</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="ti ti-activity me-2"></i>Recent Activity
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_activity %}
                    <div class="list-group list-group-flush">
                        {% for activity in recent_activity %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="d-flex align-items-center">
                                        <i class="ti ti-{% if activity.type == 'SELECT' %}eye{% elif activity.type == 'INSERT' %}plus{% elif activity.type == 'UPDATE' %}edit{% elif activity.type == 'DELETE' %}trash{% else %}database{% endif %} me-2 text-{% if activity.type == 'SELECT' %}info{% elif activity.type == 'INSERT' %}success{% elif activity.type == 'UPDATE' %}warning{% elif activity.type == 'DELETE' %}danger{% else %}secondary{% endif %}"></i>
                                        <strong>{{ activity.type }}</strong>
                                    </div>
                                    <small class="text-muted">{{ activity.table or 'unknown' }} table</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">{{ activity.timestamp.strftime('%H:%M:%S') if activity.timestamp else 'Unknown' }}</small>
                                    <br><span class="badge bg-secondary">{{ activity.duration or '0' }}ms</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="ti ti-database-off text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">No recent activity</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Database Health Check -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="ti ti-health-recognition me-2"></i>Database Health Check
                    </h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="runHealthCheck()">
                        <i class="ti ti-refresh me-1"></i>Run Check
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center p-3">
                                <div class="status-indicator {% if health_check.connection %}active{% else %}inactive{% endif %} me-3"></div>
                                <div>
                                    <div class="fw-medium">Connection Test</div>
                                    <small class="text-muted">
                                        {% if health_check.connection %}Healthy{% else %}Failed{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center p-3">
                                <div class="status-indicator {% if health_check.query_test %}active{% else %}inactive{% endif %} me-3"></div>
                                <div>
                                    <div class="fw-medium">Query Test</div>
                                    <small class="text-muted">{{ health_check.query_time or '25ms' }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center p-3">
                                <div class="status-indicator {% if health_check.table_check %}active{% else %}inactive{% endif %} me-3"></div>
                                <div>
                                    <div class="fw-medium">Table Integrity</div>
                                    <small class="text-muted">
                                        {% if health_check.table_check %}OK{% else %}Issues Found{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center p-3">
                                <div class="status-indicator {% if health_check.performance %}active{% else %}inactive{% endif %} me-3"></div>
                                <div>
                                    <div class="fw-medium">Performance</div>
                                    <small class="text-muted">
                                        {% if health_check.performance %}Good{% else %}Degraded{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            Last health check: {{ health_check.last_run.strftime('%Y-%m-%d %H:%M:%S') if health_check.last_run else 'Never' }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="ti ti-tools me-2"></i>Database Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="btn-group me-2" role="group">
                        <button class="btn btn-outline-info" onclick="refreshConnections()">
                            <i class="ti ti-refresh me-1"></i>Refresh Connections
                        </button>
                        <button class="btn btn-outline-warning" onclick="flushQueryCache()">
                            <i class="ti ti-trash me-1"></i>Flush Query Cache
                        </button>
                        <button class="btn btn-outline-primary" onclick="analyzePerformance()">
                            <i class="ti ti-chart-line me-1"></i>Analyze Performance
                        </button>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-success" onclick="optimizeDatabase()">
                            <i class="ti ti-tool me-1"></i>Optimize Database
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block custom_css %}
<style>
.card-icon {
    display: flex;
    align-items: center;
    justify-content: center;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.status-indicator.active {
    background-color: #28a745;
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
}

.status-indicator.inactive {
    background-color: #dc3545;
    box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
}

.progress {
    background-color: #e9ecef;
}

@media (max-width: 768px) {
    .border-end {
        border-right: none !important;
        border-bottom: 1px solid var(--bs-border-color) !important;
    }
    
    .btn-group {
        flex-wrap: wrap;
    }
    
    .btn-group .btn {
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}

{% block custom_js %}
<script>
function runHealthCheck() {
    const button = document.querySelector('button[onclick="runHealthCheck()"]');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="ti ti-loader me-1"></i>Running...';
    button.disabled = true;
    
    fetch('{{ url_for("admin_panel.run_db_health_check") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Success', 'Database health check completed successfully!', 'success');
            setTimeout(() => window.location.reload(), 2000);
        } else {
            Swal.fire('Error', 'Health check failed: ' + data.message, 'error');
        }
    })
    .catch(error => {
        Swal.fire('Error', 'Failed to run health check', 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function refreshConnections() {
    Swal.fire({
        title: 'Refresh Connections?',
        text: 'This will reset all idle database connections.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#17a2b8',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, refresh!'
    }).then((result) => {
        if (result.isConfirmed) {
            // Implement connection refresh
            Swal.fire('Success', 'Database connections refreshed!', 'success');
        }
    });
}

function flushQueryCache() {
    Swal.fire({
        title: 'Flush Query Cache?',
        text: 'This will clear all cached query results.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ffc107',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, flush cache!'
    }).then((result) => {
        if (result.isConfirmed) {
            // Implement cache flush
            Swal.fire('Success', 'Query cache flushed!', 'success');
        }
    });
}

function analyzePerformance() {
    Swal.fire({
        title: 'Analyze Performance?',
        text: 'This will run a comprehensive performance analysis.',
        icon: 'info',
        showCancelButton: true,
        confirmButtonColor: '#007bff',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, analyze!'
    }).then((result) => {
        if (result.isConfirmed) {
            // Implement performance analysis
            Swal.fire('Info', 'Performance analysis started. Results will be available shortly.', 'info');
        }
    });
}

function optimizeDatabase() {
    Swal.fire({
        title: 'Optimize Database?',
        text: 'This will run database optimization routines. This may take a few minutes.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, optimize!'
    }).then((result) => {
        if (result.isConfirmed) {
            // Implement database optimization
            Swal.fire('Success', 'Database optimization completed!', 'success');
        }
    });
}

// Auto-refresh database stats every 30 seconds
setInterval(() => {
    // Add subtle visual indicator for auto-refresh
    const statsCards = document.querySelectorAll('.card.bg-success, .card.bg-danger, .card.bg-primary, .card.bg-info, .card.bg-warning');
    statsCards.forEach(card => {
        card.style.opacity = '0.8';
        setTimeout(() => {
            card.style.opacity = '1';
        }, 200);
    });
}, 30000);

// Handle performance period filter
document.querySelectorAll('input[name="perf_period"]').forEach(radio => {
    radio.addEventListener('change', function() {
        // In a real implementation, this would trigger an AJAX request to load data for the selected period
        console.log('Performance period changed to:', this.id.replace('perf_', ''));
    });
});
</script>
{% endblock %}