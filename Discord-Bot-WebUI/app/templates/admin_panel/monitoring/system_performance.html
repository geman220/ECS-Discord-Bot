{% extends "admin_panel/base.html" %}

{% block title %}System Performance - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin_panel.system_monitoring') }}">System Monitoring</a>
</li>
<li class="breadcrumb-item active">System Performance</li>
{% endblock %}

{% block panel_content %}

<!-- Performance Overview -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card bg-primary text-white">
            <div class="c-card__body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="c-card__title text-white mb-1">{{ performance_metrics.response_time_avg }}ms</h5>
                        <p class="c-card__description small opacity-75 mb-0">Avg Response Time</p>
                    </div>
                    <div class="card-icon icon-overlay">
                        <i class="ti ti-clock"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card bg-success text-white">
            <div class="c-card__body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="c-card__title text-white mb-1">{{ performance_metrics.requests_per_minute }}</h5>
                        <p class="c-card__description small opacity-75 mb-0">Requests/Min</p>
                    </div>
                    <div class="card-icon icon-overlay">
                        <i class="ti ti-activity"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card bg-info text-white">
            <div class="c-card__body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="c-card__title text-white mb-1">{{ performance_metrics.error_rate_percent }}%</h5>
                        <p class="c-card__description small opacity-75 mb-0">Error Rate</p>
                    </div>
                    <div class="card-icon icon-overlay">
                        <i class="ti ti-alert-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card bg-warning text-white">
            <div class="c-card__body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="c-card__title text-white mb-1">{{ performance_metrics.active_sessions }}</h5>
                        <p class="c-card__description small opacity-75 mb-0">Active Sessions</p>
                    </div>
                    <div class="card-icon icon-overlay">
                        <i class="ti ti-users"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Charts -->
<div class="row mb-4">
    <div class="col-md-8 mb-3">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-chart-line me-2"></i>Response Time Trends
                </h5>
            </div>
            <div class="c-card__body">
                <div id="responseTimeChart" class="u-h-300"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-pie-chart me-2"></i>Request Distribution
                </h5>
            </div>
            <div class="c-card__body">
                <div id="requestDistributionChart" class="u-h-300"></div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Metrics -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-server me-2"></i>Resource Utilization
                </h5>
            </div>
            <div class="c-card__body">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center mb-3">
                            <h6>CPU Usage</h6>
                            <div class="progress mx-auto u-progress-circle"
                                 data-progress="{{ performance_metrics.cpu_usage }}">
                                <div class="progress-bar"></div>
                            </div>
                            <small class="text-muted">{{ performance_metrics.cpu_usage }}%</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center mb-3">
                            <h6>Memory Usage</h6>
                            <div class="progress mx-auto u-progress-circle u-progress-circle--info"
                                 data-progress="{{ performance_metrics.memory_usage }}">
                                <div class="progress-bar bg-info"></div>
                            </div>
                            <small class="text-muted">{{ performance_metrics.memory_usage }}%</small>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Database Connections</span>
                        <span class="badge bg-primary" data-badge>{{ performance_metrics.db_connections_active }}/{{ performance_metrics.db_connections_max }}</span>
                    </div>
                    <div class="progress u-progress-sm">
                        <div class="progress-bar" data-width="{{ (performance_metrics.db_connections_active / performance_metrics.db_connections_max * 100) if performance_metrics.db_connections_max else 0 }}"></div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Cache Hit Rate</span>
                        <span class="badge bg-success" data-badge>{{ performance_metrics.cache_hit_rate }}%</span>
                    </div>
                    <div class="progress u-progress-sm">
                        <div class="progress-bar bg-success" data-width="{{ performance_metrics.cache_hit_rate }}"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-3">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-list me-2"></i>Top Endpoints
                </h5>
            </div>
            <div class="c-card__body">
                <div class="c-table-wrapper" data-table-responsive>
                    <table class="c-c-table c-table--compact" data-table data-mobile-table data-table-type="stats">
                        <thead scope="col">
                            <tr>
                                <th scope="col">Endpoint</th>
                                <th scope="col">Requests</th>
                                <th scope="col">Avg Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for endpoint in performance_metrics.top_endpoints %}
                            <tr>
                                <td data-label="Endpoint">
                                    <code>{{ endpoint.path }}</code>
                                </td>
                                <td data-label="Requests">
                                    <span class="badge bg-info" data-badge>{{ endpoint.requests }}</span>
                                </td>
                                <td data-label="Avg Time">
                                    <small class="text-muted">{{ endpoint.avg_time }}ms</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Historical Data -->
<div class="row">
    <div class="col-12">
        <div class="c-card">
            <div class="c-card__header d-flex justify-content-between align-items-center">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-chart-area me-2"></i>Historical Performance Data
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="c-btn c-btn--outline-primary active" data-action="load-historical" data-period="1h">1 Hour</button>
                    <button class="c-btn c-btn--outline-primary" data-action="load-historical" data-period="6h">6 Hours</button>
                    <button class="c-btn c-btn--outline-primary" data-action="load-historical" data-period="24h">24 Hours</button>
                    <button class="c-btn c-btn--outline-primary" data-action="load-historical" data-period="7d">7 Days</button>
                </div>
            </div>
            <div class="c-card__body">
                <div id="historicalChart" class="u-h-400"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block custom_css %}
{{ super() }}
{# Styles moved to external CSS #}
{% endblock %}

{% block custom_js %}
{{ super() }}
{# Chart initialization requires page-specific data, handled via InitSystem #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
    'use strict';

    // Page-specific chart data from server
    const chartData = {
        responseTime: {
            labels: {{ historical_data.response_time.labels | tojson | safe }},
            data: {{ historical_data.response_time.data | tojson | safe }}
        },
        requestDistribution: {
            labels: {{ historical_data.request_distribution.labels | tojson | safe }},
            data: {{ historical_data.request_distribution.data | tojson | safe }}
        },
        timeline: {
            labels: {{ historical_data.timeline.labels | tojson | safe }},
            responseTime: {{ historical_data.timeline.response_time | tojson | safe }},
            requests: {{ historical_data.timeline.requests | tojson | safe }}
        }
    };

    // Register initialization with InitSystem
    if (typeof InitSystem !== 'undefined') {
        InitSystem.register('performance-charts', function() {
            initPerformanceCharts(chartData);
        });
    } else {
        document.addEventListener('DOMContentLoaded', function() {
            initPerformanceCharts(chartData);
        });
    }

    function initPerformanceCharts(data) {
        // Apply dynamic widths to progress bars
        document.querySelectorAll('[data-width]').forEach(function(el) {
            const width = el.dataset.width;
            el.style.width = width + '%';
        });

        // Apply circular progress indicators
        document.querySelectorAll('.u-progress-circle[data-progress]').forEach(function(circle) {
            const progress = parseFloat(circle.dataset.progress);
            const progressBar = circle.querySelector('.progress-bar');
            if (progressBar) {
                const deg = progress * 3.6;
                const colorVar = progressBar.classList.contains('bg-info') ?
                    'var(--ecs-info, #0dcaf0)' : 'var(--ecs-primary, #0d6efd)';
                progressBar.style.background = `conic-gradient(${colorVar} ${deg}deg, transparent 0deg)`;
            }
        });

        // Initialize charts
        const responseTimeEl = document.getElementById('responseTimeChart');
        const requestDistEl = document.getElementById('requestDistributionChart');
        const historicalEl = document.getElementById('historicalChart');

        if (responseTimeEl) {
            new Chart(responseTimeEl.getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.responseTime.labels,
                    datasets: [{
                        label: 'Response Time (ms)',
                        data: data.responseTime.data,
                        borderColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('primary') : '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        if (requestDistEl) {
            new Chart(requestDistEl.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: data.requestDistribution.labels,
                    datasets: [{
                        data: data.requestDistribution.data,
                        backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6c757d']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        if (historicalEl) {
            new Chart(historicalEl.getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.timeline.labels,
                    datasets: [
                        {
                            label: 'Response Time (ms)',
                            data: data.timeline.responseTime,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Requests/min',
                            data: data.timeline.requests,
                            borderColor: '#198754',
                            backgroundColor: 'rgba(25, 135, 84, 0.1)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { type: 'linear', display: true, position: 'left' },
                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } }
                    }
                }
            });
        }
    }
})();
</script>
{# Event handlers for load-historical managed by monitoring-handlers.js via EventDelegation #}
{% endblock %}