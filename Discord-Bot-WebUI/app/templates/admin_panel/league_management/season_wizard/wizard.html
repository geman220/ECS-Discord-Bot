{% extends "admin_panel/base.html" %}

{% block panel_description %}Create a new season with teams, schedules, and Discord integration{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_panel.league_management_dashboard') }}">League Management</a></li>
<li class="breadcrumb-item active">Season Wizard</li>
{% endblock %}

{% block custom_css %}
{{ super() }}
<style>
    /* Season Wizard - Theme-aware styling using Bootstrap CSS variables */
    .wizard-container {
        position: relative;
    }
    .wizard-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0;
        position: relative;
        padding: 1.5rem;
    }
    .wizard-steps::after {
        content: '';
        position: absolute;
        top: calc(1.5rem + 20px);
        left: 10%;
        width: 80%;
        height: 2px;
        background-color: var(--bs-border-color);
        z-index: 1;
    }
    .wizard-step {
        z-index: 2;
        position: relative;
        background-color: transparent;
        flex: 1;
        text-align: center;
    }
    .wizard-step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        color: #fff;
        position: relative;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    .step-active .wizard-step-circle {
        background-color: var(--bs-primary);
        box-shadow: 0 0 0 4px rgba(var(--bs-primary-rgb), 0.25);
    }
    .step-done .wizard-step-circle {
        background-color: var(--bs-success);
    }
    .step-pending .wizard-step-circle {
        background-color: var(--bs-secondary);
        opacity: 0.6;
    }
    .wizard-step-text {
        text-align: center;
        font-size: 0.85rem;
        color: var(--bs-body-color);
    }
    .step-active .wizard-step-text {
        color: var(--bs-primary);
        font-weight: 600;
    }
    .step-done .wizard-step-text {
        color: var(--bs-success);
    }
    .step-pending .wizard-step-text {
        opacity: 0.6;
    }
    .wizard-content {
        padding: 1.5rem;
        min-height: 400px;
        border-top: 1px solid var(--bs-border-color);
    }
    .wizard-navigation {
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        border-top: 1px solid var(--bs-border-color);
        background-color: var(--bs-tertiary-bg);
    }
    .tooltip-container {
        position: relative;
        cursor: pointer;
    }
    .tooltip-container:hover .custom-tooltip {
        display: block;
    }
    .custom-tooltip {
        display: none;
        position: absolute;
        top: -45px;
        left: 50%;
        transform: translateX(-50%);
        padding: 5px 10px;
        background-color: var(--bs-emphasis-color);
        color: var(--bs-body-bg);
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 10;
    }
    .custom-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: var(--bs-emphasis-color) transparent transparent transparent;
    }
    /* Step content transitions */
    .wizard-step-content {
        display: none;
    }
    .wizard-step-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    /* Mobile responsive */
    @media (max-width: 768px) {
        .wizard-steps {
            flex-wrap: wrap;
            gap: 1rem;
        }
        .wizard-steps::after {
            display: none;
        }
        .wizard-step {
            flex: 0 0 calc(33.333% - 1rem);
        }
        .wizard-step-text {
            font-size: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block panel_content %}
<div class="row">
    <div class="col-12">
        <!-- Current Step Info Card -->
        <div class="alert bg-body-tertiary border-start border-primary border-4 mb-4">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="ti ti-wand text-primary" style="font-size: 2rem;" id="stepIcon"></i>
                </div>
                <div class="flex-grow-1">
                    <h6 class="mb-1" id="stepTitle">Step 1 of 5: Basic Information</h6>
                    <p class="mb-0 small text-muted" id="stepDescription">Select the league type and name your season</p>
                </div>
            </div>
        </div>

        <div class="card wizard-container">
            <!-- Progress Steps -->
            <div class="wizard-steps">
                <div class="wizard-step step-active" data-step="0" id="wizardStep0">
                    <div class="tooltip-container" onclick="goToStep(0)">
                        <div class="wizard-step-circle">
                            <i class="ti ti-file-description"></i>
                        </div>
                        <div class="wizard-step-text">Basic Info</div>
                        <div class="custom-tooltip">Step 1: Season type & name</div>
                    </div>
                </div>

                <div class="wizard-step step-pending" data-step="1" id="wizardStep1">
                    <div class="tooltip-container" onclick="goToStep(1)">
                        <div class="wizard-step-circle">
                            <i class="ti ti-users-group"></i>
                        </div>
                        <div class="wizard-step-text">Teams</div>
                        <div class="custom-tooltip">Step 2: Configure teams</div>
                    </div>
                </div>

                <div class="wizard-step step-pending" data-step="2" id="wizardStep2">
                    <div class="tooltip-container" onclick="goToStep(2)">
                        <div class="wizard-step-circle">
                            <i class="ti ti-calendar-event"></i>
                        </div>
                        <div class="wizard-step-text">Schedule</div>
                        <div class="custom-tooltip">Step 3: Weeks & dates</div>
                    </div>
                </div>

                <div class="wizard-step step-pending" data-step="3" id="wizardStep3">
                    <div class="tooltip-container" onclick="goToStep(3)">
                        <div class="wizard-step-circle">
                            <i class="ti ti-brand-discord"></i>
                        </div>
                        <div class="wizard-step-text">Discord</div>
                        <div class="custom-tooltip">Step 4: Preview resources</div>
                    </div>
                </div>

                <div class="wizard-step step-pending" data-step="4" id="wizardStep4">
                    <div class="tooltip-container" onclick="goToStep(4)">
                        <div class="wizard-step-circle">
                            <i class="ti ti-check"></i>
                        </div>
                        <div class="wizard-step-text">Review</div>
                        <div class="custom-tooltip">Step 5: Confirm & create</div>
                    </div>
                </div>
            </div>

            <!-- Step Content -->
            <div class="wizard-content">
                <form id="seasonWizardForm" onsubmit="return false;">
                    <!-- Step 1: Basic Info -->
                    <div class="wizard-step-content active" id="step-0">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">League Type <span class="text-danger">*</span></label>
                                <div class="d-flex gap-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="league_type" id="typePubLeague" value="Pub League" checked>
                                        <label class="form-check-label" for="typePubLeague">
                                            <i class="ti ti-trophy text-warning me-1"></i>Pub League
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="league_type" id="typeEcsFc" value="ECS FC">
                                        <label class="form-check-label" for="typeEcsFc">
                                            <i class="ti ti-ball-football text-primary me-1"></i>ECS FC
                                        </label>
                                    </div>
                                </div>
                                <small class="text-muted">Pub League includes Premier & Classic divisions</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="seasonName">Season Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="seasonName" name="season_name"
                                       placeholder="e.g., Spring 2025" required>
                                <small class="text-muted">A unique name for this season</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="startDate">Season Start Date</label>
                                <input type="date" class="form-control" id="startDate" name="start_date">
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="setAsCurrent" name="set_as_current">
                                    <label class="form-check-label" for="setAsCurrent">
                                        Set as current season
                                    </label>
                                    <small class="text-muted d-block">This will trigger a rollover from the existing current season</small>
                                </div>
                            </div>
                        </div>

                        <!-- Rollover Warning -->
                        <div id="rolloverWarning" class="alert alert-warning mt-3" style="display: none;">
                            <i class="ti ti-alert-triangle me-2"></i>
                            <strong>Rollover Warning:</strong> Setting this as current will:
                            <ul class="mb-0 mt-2">
                                <li>Mark the existing current season as inactive</li>
                                <li>Record player team history from the old season</li>
                                <li>Clear team assignments for players</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Step 2: Teams -->
                    <div class="wizard-step-content" id="step-1">
                        <!-- Pub League Teams -->
                        <div id="pubLeagueTeams">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card border h-100">
                                        <div class="card-header bg-warning bg-opacity-10">
                                            <h6 class="mb-0"><i class="ti ti-crown me-1"></i>Premier Division</h6>
                                        </div>
                                        <div class="card-body">
                                            <label class="form-label">Number of Teams</label>
                                            <input type="number" class="form-control" id="premierTeamCount"
                                                   name="premier_team_count" value="8" min="2" max="16">
                                            <small class="text-muted">Typically 8 teams for round-robin</small>

                                            <div class="mt-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="premierCustomNames">
                                                    <label class="form-check-label" for="premierCustomNames">
                                                        Use custom team names
                                                    </label>
                                                </div>
                                            </div>
                                            <div id="premierCustomNamesDiv" class="mt-2" style="display: none;">
                                                <textarea class="form-control" id="premierTeamNames" rows="4"
                                                          placeholder="Enter one team name per line"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border h-100">
                                        <div class="card-header bg-info bg-opacity-10">
                                            <h6 class="mb-0"><i class="ti ti-users me-1"></i>Classic Division</h6>
                                        </div>
                                        <div class="card-body">
                                            <label class="form-label">Number of Teams</label>
                                            <input type="number" class="form-control" id="classicTeamCount"
                                                   name="classic_team_count" value="4" min="2" max="16">
                                            <small class="text-muted">Typically 4 teams</small>

                                            <div class="mt-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="classicCustomNames">
                                                    <label class="form-check-label" for="classicCustomNames">
                                                        Use custom team names
                                                    </label>
                                                </div>
                                            </div>
                                            <div id="classicCustomNamesDiv" class="mt-2" style="display: none;">
                                                <textarea class="form-control" id="classicTeamNames" rows="4"
                                                          placeholder="Enter one team name per line"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ECS FC Teams -->
                        <div id="ecsFcTeams" style="display: none;">
                            <div class="card border">
                                <div class="card-header bg-primary bg-opacity-10">
                                    <h6 class="mb-0"><i class="ti ti-ball-football me-1"></i>ECS FC Teams</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Number of Teams</label>
                                            <input type="number" class="form-control" id="ecsFcTeamCount"
                                                   name="team_count" value="8" min="2" max="16">
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="ecsFcCustomNames">
                                            <label class="form-check-label" for="ecsFcCustomNames">
                                                Use custom team names
                                            </label>
                                        </div>
                                    </div>
                                    <div id="ecsFcCustomNamesDiv" class="mt-2" style="display: none;">
                                        <textarea class="form-control" id="ecsFcTeamNames" rows="4"
                                                  placeholder="Enter one team name per line"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Skip Team Creation Option -->
                        <div class="mt-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="skipTeamCreation" name="skip_team_creation">
                                <label class="form-check-label" for="skipTeamCreation">
                                    Skip team creation (create teams manually later)
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Schedule -->
                    <div class="wizard-step-content" id="step-2">
                        <div class="alert alert-info">
                            <i class="ti ti-info-circle me-2"></i>
                            Detailed schedule configuration can be done via the
                            <a href="{{ url_for('auto_schedule.schedule_manager') }}">Auto Schedule</a>
                            system after season creation.
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Regular Season Weeks</label>
                                <input type="number" class="form-control" id="regularWeeks"
                                       name="regular_weeks" value="7" min="1" max="20">
                                <small class="text-muted">Number of regular season weeks</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Playoff Weeks</label>
                                <input type="number" class="form-control" id="playoffWeeks"
                                       name="playoff_weeks" value="2" min="0" max="6">
                                <small class="text-muted">Number of playoff weeks</small>
                            </div>
                        </div>

                        <!-- Special Weeks (Pub League Only) -->
                        <div id="specialWeeksSection" class="mt-4">
                            <h6>Special Weeks (Pub League)</h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="hasFunWeek" name="has_fun_week">
                                        <label class="form-check-label" for="hasFunWeek">
                                            Include Fun Week
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="hasTstWeek" name="has_tst_week">
                                        <label class="form-check-label" for="hasTstWeek">
                                            Include TST Week
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="hasBonusWeek" name="has_bonus_week">
                                        <label class="form-check-label" for="hasBonusWeek">
                                            Include Bonus Week
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Discord Preview -->
                    <div class="wizard-step-content" id="step-3">
                        <div id="discordPreviewLoading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Generating preview...</p>
                        </div>

                        <div id="discordPreviewContent" style="display: none;">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="card border h-100">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="ti ti-folder me-1"></i>Categories</h6>
                                        </div>
                                        <div class="card-body">
                                            <ul id="previewCategories" class="list-unstyled mb-0"></ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border h-100">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="ti ti-message me-1"></i>Channels</h6>
                                        </div>
                                        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                            <ul id="previewChannels" class="list-unstyled mb-0"></ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border h-100">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="ti ti-shield me-1"></i>Roles</h6>
                                        </div>
                                        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                            <ul id="previewRoles" class="list-unstyled mb-0"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mt-3">
                                <i class="ti ti-info-circle me-2"></i>
                                Estimated Discord API calls: <strong id="estimatedApiCalls">0</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: Review -->
                    <div class="wizard-step-content" id="step-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card border">
                                    <div class="card-body">
                                        <h6><i class="ti ti-file-description me-1"></i>Basic Info</h6>
                                        <table class="table table-sm mb-0">
                                            <tr>
                                                <td class="text-muted">League Type:</td>
                                                <td id="reviewLeagueType"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Season Name:</td>
                                                <td id="reviewSeasonName"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Start Date:</td>
                                                <td id="reviewStartDate"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Set as Current:</td>
                                                <td id="reviewSetAsCurrent"></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border">
                                    <div class="card-body">
                                        <h6><i class="ti ti-users-group me-1"></i>Teams</h6>
                                        <div id="reviewTeams"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card border">
                                    <div class="card-body">
                                        <h6><i class="ti ti-calendar me-1"></i>Schedule</h6>
                                        <table class="table table-sm mb-0">
                                            <tr>
                                                <td class="text-muted">Regular Weeks:</td>
                                                <td id="reviewRegularWeeks"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Playoff Weeks:</td>
                                                <td id="reviewPlayoffWeeks"></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Navigation -->
            <div class="wizard-navigation">
                <div>
                    <button class="btn btn-secondary" id="prevBtn" onclick="wizardPrev()" style="display: none;">
                        <i class="ti ti-arrow-left me-1"></i> Previous
                    </button>
                </div>
                <div>
                    <button class="btn btn-primary" id="nextBtn" onclick="wizardNext()">
                        Next <i class="ti ti-arrow-right ms-1"></i>
                    </button>
                    <button class="btn btn-success" id="createBtn" onclick="createSeason()" style="display: none;">
                        <i class="ti ti-check me-1"></i> Create Season
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
let currentStep = 0;
const totalSteps = 5;
const stepIcons = ['ti-file-description', 'ti-users-group', 'ti-calendar-event', 'ti-brand-discord', 'ti-check'];
const stepTitles = [
    'Step 1 of 5: Basic Information',
    'Step 2 of 5: Team Configuration',
    'Step 3 of 5: Schedule Configuration',
    'Step 4 of 5: Discord Preview',
    'Step 5 of 5: Review & Create'
];
const stepDescriptions = [
    'Select the league type and name your season',
    'Configure the teams for this season',
    'Set up the schedule structure',
    'Preview Discord channels and roles to be created',
    'Review your configuration before creating'
];

document.addEventListener('DOMContentLoaded', function() {
    // League type change handler
    document.querySelectorAll('input[name="league_type"]').forEach(radio => {
        radio.addEventListener('change', handleLeagueTypeChange);
    });

    // Set as current checkbox handler
    document.getElementById('setAsCurrent').addEventListener('change', function() {
        document.getElementById('rolloverWarning').style.display = this.checked ? 'block' : 'none';
    });

    // Custom names toggle handlers
    document.getElementById('premierCustomNames').addEventListener('change', function() {
        document.getElementById('premierCustomNamesDiv').style.display = this.checked ? 'block' : 'none';
    });
    document.getElementById('classicCustomNames').addEventListener('change', function() {
        document.getElementById('classicCustomNamesDiv').style.display = this.checked ? 'block' : 'none';
    });
    document.getElementById('ecsFcCustomNames').addEventListener('change', function() {
        document.getElementById('ecsFcCustomNamesDiv').style.display = this.checked ? 'block' : 'none';
    });

    // Initialize from URL params
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('type') === 'ecs_fc') {
        document.getElementById('typeEcsFc').checked = true;
        handleLeagueTypeChange();
    }

    updateUI();
});

function handleLeagueTypeChange() {
    const isPubLeague = document.getElementById('typePubLeague').checked;
    document.getElementById('pubLeagueTeams').style.display = isPubLeague ? 'block' : 'none';
    document.getElementById('ecsFcTeams').style.display = isPubLeague ? 'none' : 'block';
    document.getElementById('specialWeeksSection').style.display = isPubLeague ? 'block' : 'none';
}

function updateUI() {
    // Update step indicators
    for (let i = 0; i < totalSteps; i++) {
        const stepEl = document.getElementById(`wizardStep${i}`);
        const circle = stepEl.querySelector('.wizard-step-circle');

        stepEl.classList.remove('step-active', 'step-done', 'step-pending');

        if (i < currentStep) {
            stepEl.classList.add('step-done');
            circle.innerHTML = '<i class="ti ti-check"></i>';
        } else if (i === currentStep) {
            stepEl.classList.add('step-active');
            circle.innerHTML = `<i class="ti ${stepIcons[i]}"></i>`;
        } else {
            stepEl.classList.add('step-pending');
            circle.innerHTML = `<i class="ti ${stepIcons[i]}"></i>`;
        }
    }

    // Update step content visibility
    for (let i = 0; i < totalSteps; i++) {
        const content = document.getElementById(`step-${i}`);
        content.classList.toggle('active', i === currentStep);
    }

    // Update header info
    document.getElementById('stepIcon').className = `ti ${stepIcons[currentStep]} text-primary`;
    document.getElementById('stepTitle').textContent = stepTitles[currentStep];
    document.getElementById('stepDescription').textContent = stepDescriptions[currentStep];

    // Update navigation buttons
    document.getElementById('prevBtn').style.display = currentStep > 0 ? 'inline-block' : 'none';
    document.getElementById('nextBtn').style.display = currentStep < totalSteps - 1 ? 'inline-block' : 'none';
    document.getElementById('createBtn').style.display = currentStep === totalSteps - 1 ? 'inline-block' : 'none';
}

function goToStep(step) {
    if (step < currentStep) {
        currentStep = step;
        updateUI();
    }
}

function wizardNext() {
    if (!validateStep(currentStep)) return;

    if (currentStep < totalSteps - 1) {
        currentStep++;
        updateUI();

        // Special handling for Discord preview step
        if (currentStep === 3) {
            loadDiscordPreview();
        }

        // Special handling for review step
        if (currentStep === 4) {
            populateReview();
        }
    }
}

function wizardPrev() {
    if (currentStep > 0) {
        currentStep--;
        updateUI();
    }
}

function validateStep(step) {
    if (step === 0) {
        const seasonName = document.getElementById('seasonName').value.trim();
        if (!seasonName) {
            AdminPanel.showMobileToast('Please enter a season name', 'warning');
            return false;
        }
        if (seasonName.length < 3) {
            AdminPanel.showMobileToast('Season name must be at least 3 characters', 'warning');
            return false;
        }
    }
    return true;
}

function getWizardData() {
    const isPubLeague = document.getElementById('typePubLeague').checked;
    const data = {
        league_type: isPubLeague ? 'Pub League' : 'ECS FC',
        season_name: document.getElementById('seasonName').value.trim(),
        start_date: document.getElementById('startDate').value,
        set_as_current: document.getElementById('setAsCurrent').checked,
        skip_team_creation: document.getElementById('skipTeamCreation').checked,
        regular_weeks: parseInt(document.getElementById('regularWeeks').value) || 7,
        playoff_weeks: parseInt(document.getElementById('playoffWeeks').value) || 2
    };

    if (isPubLeague) {
        data.premier_team_count = parseInt(document.getElementById('premierTeamCount').value) || 8;
        data.classic_team_count = parseInt(document.getElementById('classicTeamCount').value) || 4;

        if (document.getElementById('premierCustomNames').checked) {
            data.premier_teams = document.getElementById('premierTeamNames').value
                .split('\n')
                .map(n => n.trim())
                .filter(n => n.length > 0);
        }
        if (document.getElementById('classicCustomNames').checked) {
            data.classic_teams = document.getElementById('classicTeamNames').value
                .split('\n')
                .map(n => n.trim())
                .filter(n => n.length > 0);
        }

        data.has_fun_week = document.getElementById('hasFunWeek').checked;
        data.has_tst_week = document.getElementById('hasTstWeek').checked;
        data.has_bonus_week = document.getElementById('hasBonusWeek').checked;
    } else {
        data.team_count = parseInt(document.getElementById('ecsFcTeamCount').value) || 8;
        if (document.getElementById('ecsFcCustomNames').checked) {
            data.teams = document.getElementById('ecsFcTeamNames').value
                .split('\n')
                .map(n => n.trim())
                .filter(n => n.length > 0);
        }
    }

    return data;
}

function loadDiscordPreview() {
    document.getElementById('discordPreviewLoading').style.display = 'block';
    document.getElementById('discordPreviewContent').style.display = 'none';

    const data = getWizardData();

    fetch('{{ url_for("admin_panel.wizard_preview_discord") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        document.getElementById('discordPreviewLoading').style.display = 'none';
        document.getElementById('discordPreviewContent').style.display = 'block';

        if (result.success) {
            const preview = result.preview;

            // Populate categories
            const categoriesList = document.getElementById('previewCategories');
            categoriesList.innerHTML = preview.categories.map(c =>
                `<li><i class="ti ti-folder text-warning me-1"></i>${c}</li>`
            ).join('');

            // Populate channels
            const channelsList = document.getElementById('previewChannels');
            channelsList.innerHTML = preview.channels.map(c =>
                `<li><i class="ti ti-hash text-primary me-1"></i>${c.name}</li>`
            ).join('');

            // Populate roles
            const rolesList = document.getElementById('previewRoles');
            rolesList.innerHTML = preview.roles.map(r =>
                `<li><i class="ti ti-shield text-success me-1"></i>${r}</li>`
            ).join('');

            document.getElementById('estimatedApiCalls').textContent = preview.estimated_api_calls;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('discordPreviewLoading').style.display = 'none';
        AdminPanel.showMobileToast('Failed to load Discord preview', 'danger');
    });
}

function populateReview() {
    const data = getWizardData();

    document.getElementById('reviewLeagueType').textContent = data.league_type;
    document.getElementById('reviewSeasonName').textContent = data.season_name;
    document.getElementById('reviewStartDate').textContent = data.start_date || 'Not set';
    document.getElementById('reviewSetAsCurrent').textContent = data.set_as_current ? 'Yes' : 'No';
    document.getElementById('reviewRegularWeeks').textContent = data.regular_weeks;
    document.getElementById('reviewPlayoffWeeks').textContent = data.playoff_weeks;

    // Teams summary
    let teamsHtml = '';
    if (data.skip_team_creation) {
        teamsHtml = '<p class="text-muted mb-0">Teams will be created manually later</p>';
    } else if (data.league_type === 'Pub League') {
        teamsHtml = `
            <p class="mb-1">Premier: <strong>${data.premier_teams ? data.premier_teams.length : data.premier_team_count}</strong> teams</p>
            <p class="mb-0">Classic: <strong>${data.classic_teams ? data.classic_teams.length : data.classic_team_count}</strong> teams</p>
        `;
    } else {
        teamsHtml = `<p class="mb-0">ECS FC: <strong>${data.teams ? data.teams.length : data.team_count}</strong> teams</p>`;
    }
    document.getElementById('reviewTeams').innerHTML = teamsHtml;
}

function createSeason() {
    const btn = document.getElementById('createBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';

    const data = getWizardData();

    fetch('{{ url_for("admin_panel.wizard_create_season") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            AdminPanel.showMobileToast(result.message, 'success');
            setTimeout(() => {
                window.location.href = result.redirect_url || '{{ url_for("admin_panel.league_management_dashboard") }}';
            }, 1500);
        } else {
            AdminPanel.showMobileToast(result.message || 'Failed to create season', 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="ti ti-check me-1"></i> Create Season';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        AdminPanel.showMobileToast('An error occurred', 'danger');
        btn.disabled = false;
        btn.innerHTML = '<i class="ti ti-check me-1"></i> Create Season';
    });
}
</script>
{% endblock %}
