{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert, empty_state, modal_form %}

{% block admin_title %}I-Spy Categories{% endblock %}
{% block panel_description %}Manage I-Spy game categories{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.ispy_management') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">I-Spy</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Categories</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Header Card -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 mb-6 border border-gray-200 dark:border-gray-700">
    <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-category mr-2 text-ecs-green"></i>I-Spy Categories
            </h5>
            <p class="text-sm text-gray-500 dark:text-gray-400">Create and manage scavenger hunt categories</p>
        </div>
        <button type="button" class="px-4 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green/90" data-modal-target="createCategoryModal" data-modal-toggle="createCategoryModal">
            <i class="ti ti-plus mr-1"></i>Create Category
        </button>
    </div>
</div>

<!-- Category Stats -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ stats.total_categories }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Categories</p>
            </div>
            <div class="p-3 bg-ecs-green/10 rounded-full">
                <i class="ti ti-category text-2xl text-ecs-green"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ stats.active_categories }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Active</p>
            </div>
            <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-full">
                <i class="ti ti-check text-2xl text-green-600 dark:text-green-400"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ stats.total_shots }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Shots</p>
            </div>
            <div class="p-3 bg-cyan-100 dark:bg-cyan-900/30 rounded-full">
                <i class="ti ti-camera text-2xl text-cyan-600 dark:text-cyan-400"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ stats.avg_shots_per_category }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Avg Shots/Category</p>
            </div>
            <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-full">
                <i class="ti ti-chart-bar text-2xl text-blue-600 dark:text-blue-400"></i>
            </div>
        </div>
    </div>
</div>

<!-- Categories Table -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
    <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex flex-wrap items-center justify-between gap-3">
        <h5 class="text-lg font-semibold text-gray-900 dark:text-white">All Categories</h5>
        <div class="flex items-center gap-3">
            <div class="relative">
                <input type="text" id="searchCategories" placeholder="Search categories..." class="w-64 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 pl-10 text-sm text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                <i class="ti ti-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <select id="filterStatus" class="rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>
    </div>

    {% if categories %}
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-6 py-3">Category</th>
                    <th scope="col" class="px-6 py-3">Key</th>
                    <th scope="col" class="px-6 py-3">Shots</th>
                    <th scope="col" class="px-6 py-3">Approved</th>
                    <th scope="col" class="px-6 py-3">Status</th>
                    <th scope="col" class="px-6 py-3">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for category in categories %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700" data-status="{{ 'active' if category.is_active else 'inactive' }}">
                    <td class="px-6 py-4">
                        <div>
                            <span class="font-medium text-gray-900 dark:text-white">{{ category.display_name }}</span>
                            <span class="block text-xs text-gray-400 dark:text-gray-500">{{ category.key }}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <code class="px-2 py-0.5 rounded bg-gray-100 dark:bg-gray-700 text-xs font-mono text-gray-700 dark:text-gray-300">{{ category.key }}</code>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-medium text-gray-900 dark:text-white">{{ category_stats[category.id].total_shots }}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-medium text-gray-900 dark:text-white">{{ category_stats[category.id].approved_shots }}</span>
                    </td>
                    <td class="px-6 py-4">
                        {% if category.is_active %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 mr-1.5"></span>
                            Active
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                            <span class="w-1.5 h-1.5 rounded-full bg-gray-500 mr-1.5"></span>
                            Inactive
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-1">
                            <button type="button" class="p-2 text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 rounded-lg" title="Toggle Status" data-action="toggle-category" data-id="{{ category.id }}" data-name="{{ category.display_name }}">
                                <i class="ti ti-{% if category.is_active %}eye-off{% else %}eye{% endif %}"></i>
                            </button>
                            <button type="button" class="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg" title="Delete" data-action="delete-category" data-id="{{ category.id }}" data-name="{{ category.display_name }}">
                                <i class="ti ti-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="flex items-center justify-center w-16 h-16 mx-auto rounded-full bg-gray-100 dark:bg-gray-700 mb-4">
            <i class="ti ti-category-2 text-3xl text-gray-400 dark:text-gray-500"></i>
        </div>
        <h5 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No Categories Yet</h5>
        <p class="text-gray-500 dark:text-gray-400 mb-4">Create your first I-Spy category to get started!</p>
        <button type="button" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green/90" data-modal-target="createCategoryModal" data-modal-toggle="createCategoryModal">
            <i class="ti ti-plus mr-1"></i>Create Category
        </button>
    </div>
    {% endif %}
</div>

<!-- Create Category Modal -->
{% call modal_form('createCategoryModal', 'Create New Category', form_id='createCategoryForm', submit_text='Create Category', loading_text='Creating...') %}
    <div>
        <label for="categoryDisplayName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Display Name <span class="text-red-500">*</span></label>
        <input type="text" id="categoryDisplayName" name="display_name" required class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green" placeholder="e.g. Stadium Exterior">
    </div>
    <div>
        <label for="categoryKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Key</label>
        <input type="text" id="categoryKey" name="key" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-gray-900 dark:text-white font-mono text-sm focus:border-ecs-green focus:ring-1 focus:ring-ecs-green" placeholder="auto-generated from display name" maxlength="20">
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Leave blank to auto-generate from display name. Max 20 characters, lowercase.</p>
    </div>
    <div class="flex items-center">
        <input type="checkbox" id="categoryIsActive" name="is_active" checked class="w-4 h-4 text-ecs-green bg-gray-100 border-gray-300 rounded focus:ring-ecs-green dark:focus:ring-ecs-green dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
        <label for="categoryIsActive" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Active category</label>
    </div>
{% endcall %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');

    // Search functionality
    document.getElementById('searchCategories')?.addEventListener('input', function() {
        const search = this.value.toLowerCase();
        const statusFilter = document.getElementById('filterStatus')?.value || '';
        filterRows(search, statusFilter);
    });

    // Filter by status
    document.getElementById('filterStatus')?.addEventListener('change', function() {
        const search = document.getElementById('searchCategories')?.value.toLowerCase() || '';
        const statusFilter = this.value;
        filterRows(search, statusFilter);
    });

    function filterRows(search, statusFilter) {
        document.querySelectorAll('tbody tr').forEach(row => {
            const text = row.textContent.toLowerCase();
            const rowStatus = row.dataset.status;
            const matchesSearch = !search || text.includes(search);
            const matchesStatus = !statusFilter || rowStatus === statusFilter;
            row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
        });
    }

    // Toggle category status
    document.querySelectorAll('[data-action="toggle-category"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const name = this.dataset.name;
            Swal.fire({
                title: 'Toggle Category Status?',
                text: `Toggle the status of "${name}"?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Toggle',
                confirmButtonColor: '#1a472a',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`{{ url_for('admin_panel.toggle_ispy_category', category_id=0) }}`.replace('/0/', `/${id}/`), {
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
                    }).then(r => r.json()).then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: 'Updated',
                                text: data.message,
                                icon: 'success',
                                timer: 1500,
                                showConfirmButton: false,
                                background: isDark ? '#1f2937' : '#ffffff',
                                color: isDark ? '#f3f4f6' : '#111827'
                            }).then(() => window.location.reload());
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message || 'Failed to toggle category',
                                icon: 'error',
                                background: isDark ? '#1f2937' : '#ffffff',
                                color: isDark ? '#f3f4f6' : '#111827'
                            });
                        }
                    }).catch(() => {
                        Swal.fire({
                            title: 'Error',
                            text: 'An unexpected error occurred',
                            icon: 'error',
                            background: isDark ? '#1f2937' : '#ffffff',
                            color: isDark ? '#f3f4f6' : '#111827'
                        });
                    });
                }
            });
        });
    });

    // Delete category
    document.querySelectorAll('[data-action="delete-category"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const name = this.dataset.name;
            Swal.fire({
                title: 'Delete Category?',
                text: `Are you sure you want to delete "${name}"? This action cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Delete',
                confirmButtonColor: '#dc2626',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`{{ url_for('admin_panel.delete_ispy_category', category_id=0) }}`.replace('/0/', `/${id}/`), {
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
                    }).then(r => r.json()).then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: 'Deleted',
                                text: data.message,
                                icon: 'success',
                                timer: 1500,
                                showConfirmButton: false,
                                background: isDark ? '#1f2937' : '#ffffff',
                                color: isDark ? '#f3f4f6' : '#111827'
                            }).then(() => window.location.reload());
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message || 'Failed to delete category',
                                icon: 'error',
                                background: isDark ? '#1f2937' : '#ffffff',
                                color: isDark ? '#f3f4f6' : '#111827'
                            });
                        }
                    }).catch(() => {
                        Swal.fire({
                            title: 'Error',
                            text: 'An unexpected error occurred',
                            icon: 'error',
                            background: isDark ? '#1f2937' : '#ffffff',
                            color: isDark ? '#f3f4f6' : '#111827'
                        });
                    });
                }
            });
        });
    });

    // Create category form submission
    document.getElementById('createCategoryForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        const loadingText = submitBtn.dataset.loadingText || 'Creating...';

        submitBtn.disabled = true;
        submitBtn.textContent = loadingText;

        const formData = new FormData(this);
        const data = {
            display_name: formData.get('display_name')?.trim() || '',
            key: formData.get('key')?.trim() || '',
            is_active: formData.has('is_active')
        };

        if (!data.display_name) {
            Swal.fire({
                title: 'Validation Error',
                text: 'Display name is required.',
                icon: 'warning',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            });
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }

        try {
            const response = await fetch("{{ url_for('admin_panel.create_ispy_category') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                Swal.fire({
                    title: 'Created',
                    text: result.message,
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false,
                    background: isDark ? '#1f2937' : '#ffffff',
                    color: isDark ? '#f3f4f6' : '#111827'
                }).then(() => window.location.reload());
            } else {
                Swal.fire({
                    title: 'Error',
                    text: result.message || 'Failed to create category',
                    icon: 'error',
                    background: isDark ? '#1f2937' : '#ffffff',
                    color: isDark ? '#f3f4f6' : '#111827'
                });
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'An unexpected error occurred',
                icon: 'error',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            });
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });
});
</script>
{% endblock %}
