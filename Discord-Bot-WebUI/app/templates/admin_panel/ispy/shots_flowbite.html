{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert, empty_state %}

{% block admin_title %}I-Spy Shots{% endblock %}
{% block panel_description %}Review and manage I-Spy photo submissions{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.ispy_management') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">I-Spy</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Shots</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Header Card -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 mb-6 border border-gray-200 dark:border-gray-700">
    <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-camera mr-2 text-ecs-green"></i>I-Spy Shots
            </h5>
            <p class="text-sm text-gray-500 dark:text-gray-400">Review and moderate photo submissions</p>
        </div>
    </div>
</div>

<!-- Shot Stats -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ shot_stats.total_shots }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Shots</p>
            </div>
            <div class="p-3 bg-ecs-green/10 rounded-full">
                <i class="ti ti-camera text-2xl text-ecs-green"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ shot_stats.approved_shots }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Approved</p>
            </div>
            <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-full">
                <i class="ti ti-check text-2xl text-green-600 dark:text-green-400"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ shot_stats.disallowed_shots }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Disallowed</p>
            </div>
            <div class="p-3 bg-red-100 dark:bg-red-900/30 rounded-full">
                <i class="ti ti-ban text-2xl text-red-600 dark:text-red-400"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ shot_stats.avg_points|round(1) }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Avg Points</p>
            </div>
            <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-full">
                <i class="ti ti-star text-2xl text-blue-600 dark:text-blue-400"></i>
            </div>
        </div>
    </div>
</div>

<!-- Filters Bar -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 mb-6">
    <div class="p-4 flex flex-wrap items-center gap-3">
        <select id="filterStatus" class="rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
            <option value="">All Status</option>
            <option value="approved" {% if current_status == 'approved' %}selected{% endif %}>Approved</option>
            <option value="disallowed" {% if current_status == 'disallowed' %}selected{% endif %}>Disallowed</option>
        </select>
        <select id="filterCategory" class="rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
            <option value="">All Categories</option>
            {% for category in categories %}
            <option value="{{ category.id }}" {% if current_category == category.id %}selected{% endif %}>{{ category.display_name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

{% if shots.items %}
<!-- Shots Table -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-6 py-3">ID</th>
                    <th scope="col" class="px-6 py-3">Author</th>
                    <th scope="col" class="px-6 py-3">Category</th>
                    <th scope="col" class="px-6 py-3">Location</th>
                    <th scope="col" class="px-6 py-3">Points</th>
                    <th scope="col" class="px-6 py-3">Status</th>
                    <th scope="col" class="px-6 py-3">Submitted</th>
                    <th scope="col" class="px-6 py-3">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for shot in shots.items %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4">
                        <span class="font-medium text-gray-900 dark:text-white">#{{ shot.id }}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-mono text-xs text-gray-700 dark:text-gray-300">{{ shot.author_discord_id }}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-gray-900 dark:text-white">{{ shot.category.display_name if shot.category else 'N/A' }}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="truncate max-w-[200px] block text-gray-600 dark:text-gray-400">{{ shot.location or '-' }}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-medium text-gray-900 dark:text-white">{{ shot.total_points }}</span>
                    </td>
                    <td class="px-6 py-4">
                        {% if shot.status == 'approved' %}
                        {{ badge("Approved", variant="success") }}
                        {% elif shot.status == 'disallowed' %}
                        {{ badge("Disallowed", variant="danger") }}
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">
                        {{ shot.submitted_at.strftime('%Y-%m-%d %H:%M') if shot.submitted_at else '-' }}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-1">
                            {% if shot.status == 'approved' %}
                            <button type="button" class="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg" title="Disallow" data-action="disallow-shot" data-id="{{ shot.id }}">
                                <i class="ti ti-ban"></i>
                            </button>
                            {% endif %}
                            <button type="button" class="p-2 text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 rounded-lg" title="Delete" data-action="delete-shot" data-id="{{ shot.id }}">
                                <i class="ti ti-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if shots.pages > 1 %}
<div class="mt-6 flex items-center justify-between">
    <p class="text-sm text-gray-700 dark:text-gray-400">
        Showing <span class="font-medium">{{ ((shots.page - 1) * shots.per_page) + 1 }}</span>
        to <span class="font-medium">{{ [shots.page * shots.per_page, shots.total] | min }}</span>
        of <span class="font-medium">{{ shots.total }}</span> shots
    </p>
    <div class="flex gap-2">
        {% if shots.has_prev %}
        <a href="{{ url_for('admin_panel.ispy_shots', page=shots.prev_num, status=current_status or '', category=current_category or '') }}" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700">
            <i class="ti ti-chevron-left mr-1"></i>Previous
        </a>
        {% endif %}
        {% if shots.has_next %}
        <a href="{{ url_for('admin_panel.ispy_shots', page=shots.next_num, status=current_status or '', category=current_category or '') }}" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700">
            Next<i class="ti ti-chevron-right ml-1"></i>
        </a>
        {% endif %}
    </div>
</div>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
    {{ empty_state(
        title="No Shots Found",
        description="No photo submissions match your current filters.",
        icon="camera-off"
    ) }}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');

    // Filter changes reload page with URL params
    ['filterStatus', 'filterCategory'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', function() {
            applyFilters();
        });
    });

    function applyFilters() {
        const status = document.getElementById('filterStatus').value;
        const category = document.getElementById('filterCategory').value;
        const url = new URL(window.location.href);

        url.searchParams.delete('page');

        if (status) url.searchParams.set('status', status);
        else url.searchParams.delete('status');

        if (category) url.searchParams.set('category', category);
        else url.searchParams.delete('category');

        window.location.href = url.toString();
    }

    // Disallow shot with Swal reason input
    document.querySelectorAll('[data-action="disallow-shot"]').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const id = this.dataset.id;
            Swal.fire({
                title: 'Disallow Shot',
                input: 'text',
                inputLabel: 'Reason for disallowing',
                inputPlaceholder: 'Enter reason...',
                showCancelButton: true,
                confirmButtonText: 'Disallow',
                confirmButtonColor: '#dc2626',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`{{ url_for('admin_panel.disallow_ispy_shot', shot_id=0) }}`.replace('0', id), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({ reason: result.value || '' })
                    }).then(response => {
                        if (response.ok) {
                            Swal.fire({
                                title: 'Disallowed',
                                text: 'The shot has been disallowed.',
                                icon: 'success',
                                timer: 1500,
                                showConfirmButton: false,
                                background: isDark ? '#1f2937' : '#ffffff',
                                color: isDark ? '#f3f4f6' : '#111827'
                            }).then(() => window.location.reload());
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: 'Failed to disallow shot.',
                                icon: 'error',
                                background: isDark ? '#1f2937' : '#ffffff',
                                color: isDark ? '#f3f4f6' : '#111827'
                            });
                        }
                    });
                }
            });
        });
    });

    // Delete shot with Swal confirmation
    document.querySelectorAll('[data-action="delete-shot"]').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const id = this.dataset.id;
            Swal.fire({
                title: 'Delete Shot?',
                text: 'This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Delete',
                confirmButtonColor: '#dc2626',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`{{ url_for('admin_panel.delete_ispy_shot', shot_id=0) }}`.replace('0', id), {
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
                    }).then(response => {
                        if (response.ok) {
                            Swal.fire({
                                title: 'Deleted',
                                text: 'The shot has been deleted.',
                                icon: 'success',
                                timer: 1500,
                                showConfirmButton: false,
                                background: isDark ? '#1f2937' : '#ffffff',
                                color: isDark ? '#f3f4f6' : '#111827'
                            }).then(() => window.location.reload());
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: 'Failed to delete shot.',
                                icon: 'error',
                                background: isDark ? '#1f2937' : '#ffffff',
                                color: isDark ? '#f3f4f6' : '#111827'
                            });
                        }
                    });
                }
            });
        });
    });
});
</script>
{% endblock %}
