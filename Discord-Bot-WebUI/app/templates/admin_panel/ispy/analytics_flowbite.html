{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert, empty_state %}

{% block admin_title %}I-Spy Analytics{% endblock %}
{% block panel_description %}View detailed analytics and reports for I-Spy game{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.ispy_management') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">I-Spy</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Analytics</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Analytics Header -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 mb-6 border border-gray-200 dark:border-gray-700">
    <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-chart-line mr-2 text-ecs-green"></i>I-Spy Analytics
            </h5>
            <p class="text-sm text-gray-500 dark:text-gray-400">Comprehensive game statistics and insights</p>
        </div>
        <div class="flex items-center gap-3">
            {{ badge(analytics_data.active_season, variant="primary") }}
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Total Shots -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ analytics_data.overview.total_shots }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Shots</p>
            </div>
            <div class="p-3 bg-cyan-100 dark:bg-cyan-900/30 rounded-full">
                <i class="ti ti-camera text-2xl text-cyan-600 dark:text-cyan-400"></i>
            </div>
        </div>
    </div>

    <!-- Total Players -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ analytics_data.overview.total_players }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Players</p>
            </div>
            <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-full">
                <i class="ti ti-users text-2xl text-blue-600 dark:text-blue-400"></i>
            </div>
        </div>
    </div>

    <!-- Approved Shots -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ analytics_data.overview.approved_shots }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Approved Shots</p>
            </div>
            <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-full">
                <i class="ti ti-check text-2xl text-green-600 dark:text-green-400"></i>
            </div>
        </div>
    </div>

    <!-- Approval Rate -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ analytics_data.overview.approval_rate }}%</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Approval Rate</p>
            </div>
            <div class="p-3 bg-ecs-green/10 rounded-full">
                <i class="ti ti-percentage text-2xl text-ecs-green"></i>
            </div>
        </div>
    </div>
</div>

<!-- Trends & Category Performance -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Daily Shot Trends -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-chart-bar mr-2 text-ecs-green"></i>Daily Shot Trends
            </h5>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Last 14 days</p>
        </div>
        <div class="p-5">
            {% if analytics_data.trends %}
            {% set max_shots = analytics_data.trends|map(attribute='shots')|max or 1 %}
            <div class="space-y-2">
                {% for day in analytics_data.trends %}
                <div class="flex items-center gap-3">
                    <span class="text-xs font-mono text-gray-500 dark:text-gray-400 w-10 flex-shrink-0">{{ day.date }}</span>
                    <div class="flex-1 bg-gray-100 dark:bg-gray-700 rounded-full h-5 overflow-hidden">
                        <div class="bg-ecs-green h-5 rounded-full flex items-center justify-end pr-2 transition-all" style="width: {{ (day.shots / max_shots * 100)|round(1) }}%; min-width: {% if day.shots > 0 %}1.5rem{% else %}0{% endif %};">
                            {% if day.shots > 0 %}
                            <span class="text-xs font-medium text-white">{{ day.shots }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if day.shots == 0 %}
                    <span class="text-xs text-gray-400 dark:text-gray-500 w-6 flex-shrink-0">0</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="flex items-center justify-center h-48 text-gray-400 dark:text-gray-600">
                <div class="text-center">
                    <i class="ti ti-chart-bar text-4xl mb-2"></i>
                    <p class="text-sm">No trend data available</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Category Performance -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-category mr-2 text-ecs-green"></i>Category Performance
            </h5>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Shots and approval by category</p>
        </div>
        <div class="p-5">
            {% if analytics_data.category_performance %}
            <div class="space-y-5">
                {% for cat in analytics_data.category_performance %}
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-900 dark:text-white">{{ cat.display_name }}</span>
                        <div class="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400">
                            <span>{{ cat.approved_shots }}/{{ cat.total_shots }} approved</span>
                            <span class="font-medium text-gray-700 dark:text-gray-300">{{ cat.avg_points }} avg pts</span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                        <div class="bg-ecs-green h-2.5 rounded-full transition-all" style="width: {% if cat.total_shots > 0 %}{{ (cat.approved_shots / cat.total_shots * 100)|round(1) }}%{% else %}0%{% endif %};"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="flex items-center justify-center h-48 text-gray-400 dark:text-gray-600">
                <div class="text-center">
                    <i class="ti ti-category text-4xl mb-2"></i>
                    <p class="text-sm">No category data available</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Engagement Metrics -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <!-- Daily Active -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
        <div class="p-5 text-center">
            <div class="inline-flex items-center justify-center w-12 h-12 mb-3 bg-ecs-green/10 rounded-full">
                <i class="ti ti-activity text-2xl text-ecs-green"></i>
            </div>
            <p class="text-3xl font-bold text-ecs-green">{{ analytics_data.player_engagement.daily_active }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Daily Active Players</p>
        </div>
    </div>

    <!-- Weekly Active -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
        <div class="p-5 text-center">
            <div class="inline-flex items-center justify-center w-12 h-12 mb-3 bg-blue-100 dark:bg-blue-900/30 rounded-full">
                <i class="ti ti-calendar-stats text-2xl text-blue-600 dark:text-blue-400"></i>
            </div>
            <p class="text-3xl font-bold text-blue-600 dark:text-blue-400">{{ analytics_data.player_engagement.weekly_active }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Weekly Active Players</p>
        </div>
    </div>

    <!-- Players in Jail -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
        <div class="p-5 text-center">
            <div class="inline-flex items-center justify-center w-12 h-12 mb-3 bg-red-100 dark:bg-red-900/30 rounded-full">
                <i class="ti ti-lock text-2xl text-red-600 dark:text-red-400"></i>
            </div>
            <p class="text-3xl font-bold text-red-600 dark:text-red-400">{{ analytics_data.player_engagement.players_in_jail }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Players in Jail</p>
        </div>
    </div>
</div>

<!-- Quick Links -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
    <div class="p-5 border-b border-gray-200 dark:border-gray-700">
        <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="ti ti-link mr-2 text-ecs-green"></i>Quick Links
        </h5>
    </div>
    <div class="p-5">
        <div class="flex flex-wrap gap-3">
            {{ button("View Players", variant="primary", icon="users", href=url_for('admin_panel.ispy_players')) }}
            {{ button("View Shots", variant="outline", icon="camera", href=url_for('admin_panel.ispy_shots')) }}
            {{ button("Back to I-Spy Hub", variant="ghost", icon="arrow-left", href=url_for('admin_panel.ispy_management')) }}
        </div>
    </div>
</div>
{% endblock %}
