{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert, empty_state %}

{% block admin_title %}I-Spy Seasons{% endblock %}
{% block panel_description %}Manage I-Spy game seasons{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.ispy_management') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">I-Spy</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Seasons</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Header Card -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 mb-6 border border-gray-200 dark:border-gray-700">
    <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-calendar mr-2 text-ecs-green"></i>I-Spy Seasons
            </h5>
            <p class="text-sm text-gray-500 dark:text-gray-400">Create and manage game seasons</p>
        </div>
        <a href="{{ url_for('admin_panel.ispy_season_form') }}" class="px-4 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green/90">
            <i class="ti ti-plus mr-1"></i>Create Season
        </a>
    </div>
</div>

<!-- Season Stats -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ stats.total_seasons }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Seasons</p>
            </div>
            <div class="p-3 bg-ecs-green/10 rounded-full">
                <i class="ti ti-calendar text-2xl text-ecs-green"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ stats.active_seasons }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Active</p>
            </div>
            <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-full">
                <i class="ti ti-player-play text-2xl text-green-600 dark:text-green-400"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ stats.completed_seasons }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Completed</p>
            </div>
            <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-full">
                <i class="ti ti-check text-2xl text-blue-600 dark:text-blue-400"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ stats.upcoming_seasons }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Upcoming</p>
            </div>
            <div class="p-3 bg-yellow-100 dark:bg-yellow-900/30 rounded-full">
                <i class="ti ti-clock text-2xl text-yellow-600 dark:text-yellow-400"></i>
            </div>
        </div>
    </div>
</div>

<!-- Active Season Highlight -->
{% if active_season %}
<div class="bg-gradient-to-r from-ecs-green/10 to-ecs-gold/10 dark:from-ecs-green/20 dark:to-ecs-gold/20 rounded-lg p-6 mb-6 border border-ecs-green/30 dark:border-ecs-green/50">
    <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-4">
            <div class="flex items-center justify-center w-14 h-14 rounded-lg bg-ecs-green text-white">
                <i class="ti ti-player-play text-2xl"></i>
            </div>
            <div>
                <p class="text-xs font-medium text-ecs-green uppercase tracking-wider mb-1">Currently Active</p>
                <h4 class="text-xl font-bold text-gray-900 dark:text-white">{{ active_season.name }}</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    {{ active_season.start_date.strftime('%b %d') }} - {{ active_season.end_date.strftime('%b %d, %Y') }}
                </p>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-center">
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ active_season.players_count }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Players</p>
            </div>
            <div class="text-center">
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ active_season.shots_count }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Shots</p>
            </div>
            <div class="text-center">
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ active_season.days_remaining }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Days Left</p>
            </div>
            <a href="{{ url_for('admin_panel.ispy_season_form', season_id=active_season.id) }}" class="px-4 py-2 text-sm font-medium text-ecs-green bg-white border border-ecs-green rounded-lg hover:bg-ecs-green/10 dark:bg-gray-800 dark:hover:bg-ecs-green/20">
                <i class="ti ti-edit mr-1"></i>Edit
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Seasons Table -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
    <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex flex-wrap items-center justify-between gap-3">
        <h5 class="text-lg font-semibold text-gray-900 dark:text-white">All Seasons</h5>
        <div class="flex items-center gap-3">
            <select id="filterStatus" class="rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="upcoming">Upcoming</option>
                <option value="completed">Completed</option>
            </select>
        </div>
    </div>

    {% if seasons %}
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-6 py-3">Season</th>
                    <th scope="col" class="px-6 py-3">Date Range</th>
                    <th scope="col" class="px-6 py-3">Players</th>
                    <th scope="col" class="px-6 py-3">Shots</th>
                    <th scope="col" class="px-6 py-3">Status</th>
                    <th scope="col" class="px-6 py-3">Progress</th>
                    <th scope="col" class="px-6 py-3">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for season in seasons %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 {% if season.is_active %}bg-ecs-green/5 dark:bg-ecs-green/10{% endif %}">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            {% if season.is_active %}
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            {% endif %}
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">{{ season.name }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 truncate max-w-xs">{{ season.description or 'No description' }}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm">
                            <p class="text-gray-900 dark:text-white">{{ season.start_date.strftime('%b %d, %Y') }}</p>
                            <p class="text-gray-500 dark:text-gray-400">to {{ season.end_date.strftime('%b %d, %Y') }}</p>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-medium text-gray-900 dark:text-white">{{ season.players_count }}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-medium text-gray-900 dark:text-white">{{ season.shots_count }}</span>
                    </td>
                    <td class="px-6 py-4">
                        {% if season.is_active %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 mr-1.5 animate-pulse"></span>
                            Active
                        </span>
                        {% elif season.is_upcoming %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">
                            <i class="ti ti-clock mr-1"></i>
                            Upcoming
                        </span>
                        {% elif season.is_completed %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">
                            <i class="ti ti-check mr-1"></i>
                            Completed
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                            Draft
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <div class="w-24">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-500 dark:text-gray-400">{{ season.progress_percent }}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700">
                                <div class="h-1.5 rounded-full {% if season.is_completed %}bg-blue-500{% elif season.is_active %}bg-ecs-green{% else %}bg-gray-400{% endif %}" style="width: {{ season.progress_percent }}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-1">
                            <a href="{{ url_for('admin_panel.ispy_season_form', season_id=season.id) }}" class="p-2 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg" title="Edit">
                                <i class="ti ti-edit"></i>
                            </a>
                            {% if not season.is_active %}
                            <button type="button" class="p-2 text-green-600 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg" title="Activate" data-action="activate-season" data-id="{{ season.id }}">
                                <i class="ti ti-player-play"></i>
                            </button>
                            {% else %}
                            <button type="button" class="p-2 text-yellow-600 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded-lg" title="Deactivate" data-action="deactivate-season" data-id="{{ season.id }}">
                                <i class="ti ti-player-pause"></i>
                            </button>
                            {% endif %}
                            <button type="button" class="p-2 text-cyan-600 hover:bg-cyan-100 dark:hover:bg-cyan-900/30 rounded-lg" title="Duplicate" data-action="duplicate-season" data-id="{{ season.id }}">
                                <i class="ti ti-copy"></i>
                            </button>
                            <button type="button" class="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg" title="Delete" data-action="delete-season" data-id="{{ season.id }}" data-name="{{ season.name }}">
                                <i class="ti ti-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="flex items-center justify-center w-16 h-16 mx-auto rounded-full bg-gray-100 dark:bg-gray-700 mb-4">
            <i class="ti ti-calendar-off text-3xl text-gray-400 dark:text-gray-500"></i>
        </div>
        <h5 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No Seasons Yet</h5>
        <p class="text-gray-500 dark:text-gray-400 mb-4">Create your first I-Spy season to get started!</p>
        <a href="{{ url_for('admin_panel.ispy_season_form') }}" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green/90">
            <i class="ti ti-plus mr-1"></i>Create Season
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');

    // Filter by status
    document.getElementById('filterStatus')?.addEventListener('change', function() {
        const status = this.value;
        document.querySelectorAll('tbody tr').forEach(row => {
            if (!status) {
                row.style.display = '';
                return;
            }
            const statusBadge = row.querySelector('td:nth-child(5) span')?.textContent.trim().toLowerCase() || '';
            row.style.display = statusBadge.includes(status) ? '' : 'none';
        });
    });

    // Activate season
    document.querySelectorAll('[data-action="activate-season"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            Swal.fire({
                title: 'Activate Season?',
                text: 'This will deactivate any currently active season.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Activate',
                confirmButtonColor: '#1a472a',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`{{ url_for('admin_panel.ispy_activate_season', season_id=0) }}`.replace('0', id), {
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
                    }).then(() => window.location.reload());
                }
            });
        });
    });

    // Deactivate season
    document.querySelectorAll('[data-action="deactivate-season"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            Swal.fire({
                title: 'Deactivate Season?',
                text: 'Players will not be able to submit shots until another season is activated.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Deactivate',
                confirmButtonColor: '#eab308',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`{{ url_for('admin_panel.ispy_deactivate_season', season_id=0) }}`.replace('0', id), {
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
                    }).then(() => window.location.reload());
                }
            });
        });
    });

    // Duplicate season
    document.querySelectorAll('[data-action="duplicate-season"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            fetch(`{{ url_for('admin_panel.ispy_duplicate_season', season_id=0) }}`.replace('0', id), {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
            }).then(() => window.location.reload());
        });
    });

    // Delete season
    document.querySelectorAll('[data-action="delete-season"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const name = this.dataset.name;
            Swal.fire({
                title: 'Delete Season?',
                html: `Are you sure you want to delete <strong>${name}</strong>?<br><br>This will permanently delete all associated data.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Delete',
                confirmButtonColor: '#dc2626',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`{{ url_for('admin_panel.ispy_delete_season', season_id=0) }}`.replace('0', id), {
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
                    }).then(() => window.location.reload());
                }
            });
        });
    });
});
</script>
{% endblock %}
