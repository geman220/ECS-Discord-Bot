{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert, empty_state, modal_form %}

{% block admin_title %}I-Spy Players{% endblock %}
{% block panel_description %}Manage I-Spy game players and scores{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.ispy_management') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">I-Spy</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Players</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Header Card -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 mb-6 border border-gray-200 dark:border-gray-700">
    <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-users mr-2 text-ecs-green"></i>I-Spy Players
            </h5>
            <p class="text-sm text-gray-500 dark:text-gray-400">
                Manage player scores and jail status
                {% if active_season %}
                <span class="ml-2">{{ badge(active_season.name, variant="primary") }}</span>
                {% endif %}
            </p>
        </div>
    </div>
</div>

<!-- Player Stats -->
<div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ player_stats.total_players }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Players</p>
            </div>
            <div class="p-3 bg-ecs-green/10 rounded-full">
                <i class="ti ti-users text-2xl text-ecs-green"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ player_stats.active_players }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Active</p>
            </div>
            <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-full">
                <i class="ti ti-user-check text-2xl text-green-600 dark:text-green-400"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ player_stats.players_in_jail }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">In Jail</p>
            </div>
            <div class="p-3 bg-red-100 dark:bg-red-900/30 rounded-full">
                <i class="ti ti-lock text-2xl text-red-600 dark:text-red-400"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ player_stats.avg_points|round(1) }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Avg Points</p>
            </div>
            <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-full">
                <i class="ti ti-chart-bar text-2xl text-blue-600 dark:text-blue-400"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ player_stats.top_points }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Top Points</p>
            </div>
            <div class="p-3 bg-ecs-gold/20 rounded-full">
                <i class="ti ti-trophy text-2xl text-ecs-gold"></i>
            </div>
        </div>
    </div>
</div>

<!-- Players Table -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
    <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex flex-wrap items-center justify-between gap-3">
        <h5 class="text-lg font-semibold text-gray-900 dark:text-white">All Players</h5>
        <div class="flex flex-wrap items-center gap-3">
            <div class="relative">
                <input type="text" id="searchPlayers" placeholder="Search by Discord ID..." class="w-64 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 pl-10 text-sm text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                <i class="ti ti-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <select id="filterSeason" class="rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                <option value="">All Seasons</option>
                {% for season in seasons %}
                <option value="{{ season.id }}" {% if active_season and season.id == active_season.id %}selected{% endif %}>{{ season.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    {% if players %}
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400" id="playersTable">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-4 py-3">#</th>
                    <th scope="col" class="px-4 py-3">Discord ID</th>
                    <th scope="col" class="px-4 py-3">Points</th>
                    <th scope="col" class="px-4 py-3">Shots</th>
                    <th scope="col" class="px-4 py-3">Streak</th>
                    <th scope="col" class="px-4 py-3">Last Active</th>
                    <th scope="col" class="px-4 py-3">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for player in players %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700" data-discord-id="{{ player.discord_id }}">
                    <td class="px-4 py-3">
                        <span class="font-medium text-gray-500 dark:text-gray-400">{{ loop.index }}</span>
                        {% if loop.index <= 3 %}
                        <i class="ti ti-trophy ml-1 {% if loop.index == 1 %}text-ecs-gold{% elif loop.index == 2 %}text-gray-400{% else %}text-amber-600{% endif %}"></i>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        <code class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded font-mono">{{ player.discord_id }}</code>
                    </td>
                    <td class="px-4 py-3">
                        <span class="font-bold text-gray-900 dark:text-white">{{ player.total_points }}</span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-1">
                            <span class="text-gray-900 dark:text-white">{{ player.total_shots }}</span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">
                                (<span class="text-green-600 dark:text-green-400">{{ player.approved_shots }}</span>
                                /
                                <span class="text-red-600 dark:text-red-400">{{ player.disallowed_shots }}</span>)
                            </span>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex flex-col">
                            <span class="text-gray-900 dark:text-white">{{ player.current_streak }} current</span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">{{ player.max_streak }} best</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-xs text-gray-500 dark:text-gray-400">
                        {% if player.last_shot_at %}
                        {{ player.last_shot_at.strftime('%b %d, %Y %H:%M') }}
                        {% else %}
                        <span class="text-gray-400">Never</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-1">
                            <button type="button"
                                    class="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg"
                                    title="Send to Jail"
                                    data-action="jail-player"
                                    data-discord-id="{{ player.discord_id }}"
                                    data-points="{{ player.total_points }}">
                                <i class="ti ti-lock"></i>
                            </button>
                            <button type="button"
                                    class="p-2 text-yellow-600 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded-lg"
                                    title="Adjust Score"
                                    data-action="adjust-score"
                                    data-discord-id="{{ player.discord_id }}"
                                    data-points="{{ player.total_points }}">
                                <i class="ti ti-adjustments"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    {{ empty_state(
        title="No Players Found",
        description="No players have joined the I-Spy game yet for this season.",
        icon="users-minus"
    ) }}
    {% endif %}
</div>

<!-- Adjust Score Modal -->
{% call modal_form('adjustScoreModal', 'Adjust Score', form_id='adjustScoreForm', size='sm', submit_text='Apply', loading_text='Applying...') %}
    <input type="hidden" id="adjustDiscordId" name="discord_id">
    <div class="text-center">
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Current Points</p>
        <p id="currentPoints" class="text-4xl font-bold text-gray-900 dark:text-white">0</p>
    </div>
    <div>
        <label for="scoreAdjustment" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Adjustment</label>
        <input type="number" id="scoreAdjustment" name="adjustment" required class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-gray-900 dark:text-white text-center text-xl focus:border-ecs-green focus:ring-1 focus:ring-ecs-green" placeholder="+/- points">
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 text-center">Use negative numbers to subtract points</p>
    </div>
    <div>
        <label for="adjustmentReason" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Reason</label>
        <input type="text" id="adjustmentReason" name="reason" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green" placeholder="Optional reason for adjustment">
    </div>
{% endcall %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');
    const csrfToken = '{{ csrf_token() }}';

    // URL templates using PLACEHOLDER pattern for discord_id routes
    const jailUrl = "{{ url_for('admin_panel.jail_ispy_user', discord_id='PLACEHOLDER') }}";
    const adjustScoreUrl = "{{ url_for('admin_panel.adjust_ispy_score', discord_id='PLACEHOLDER') }}";

    // ----- Search by Discord ID -----
    document.getElementById('searchPlayers')?.addEventListener('input', function() {
        const search = this.value.toLowerCase().trim();
        document.querySelectorAll('#playersTable tbody tr').forEach(row => {
            const discordId = (row.dataset.discordId || '').toLowerCase();
            row.style.display = discordId.includes(search) ? '' : 'none';
        });
    });

    // ----- Season filter (reload page) -----
    document.getElementById('filterSeason')?.addEventListener('change', function() {
        const seasonId = this.value;
        const url = new URL(window.location.href);
        if (seasonId) {
            url.searchParams.set('season', seasonId);
        } else {
            url.searchParams.delete('season');
        }
        window.location.href = url.toString();
    });

    // ----- Jail player with Swal -----
    document.querySelectorAll('[data-action="jail-player"]').forEach(btn => {
        btn.addEventListener('click', async function() {
            const discordId = this.dataset.discordId;

            const { value: formValues } = await Swal.fire({
                title: 'Send to Jail',
                html:
                    '<p class="text-sm text-gray-500 mb-4">Player <strong>' + discordId + '</strong> will be unable to submit shots until released.</p>' +
                    '<div class="mb-3">' +
                        '<label class="block text-sm font-medium text-left mb-1">Reason</label>' +
                        '<input id="swal-reason" class="swal2-input" placeholder="Reason for jailing">' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-sm font-medium text-left mb-1">Duration (hours)</label>' +
                        '<input id="swal-duration" type="number" class="swal2-input" value="24" min="1" placeholder="Duration in hours">' +
                    '</div>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Jail Player',
                confirmButtonColor: '#dc2626',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827',
                preConfirm: () => {
                    return {
                        reason: document.getElementById('swal-reason').value || 'Admin action',
                        duration: parseInt(document.getElementById('swal-duration').value) || 24
                    };
                }
            });

            if (formValues) {
                try {
                    const response = await fetch(jailUrl.replace('PLACEHOLDER', discordId), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            action: 'jail',
                            reason: formValues.reason,
                            duration: formValues.duration
                        })
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        Swal.fire({
                            title: 'Jailed',
                            text: 'Player has been sent to jail.',
                            icon: 'success',
                            background: isDark ? '#1f2937' : '#ffffff',
                            color: isDark ? '#f3f4f6' : '#111827'
                        }).then(() => window.location.reload());
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: data.message || 'Failed to jail player.',
                            icon: 'error',
                            background: isDark ? '#1f2937' : '#ffffff',
                            color: isDark ? '#f3f4f6' : '#111827'
                        });
                    }
                } catch (error) {
                    console.error('Error jailing player:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'An unexpected error occurred.',
                        icon: 'error',
                        background: isDark ? '#1f2937' : '#ffffff',
                        color: isDark ? '#f3f4f6' : '#111827'
                    });
                }
            }
        });
    });

    // ----- Adjust Score Modal -----
    document.querySelectorAll('[data-action="adjust-score"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const discordId = this.dataset.discordId;
            const points = this.dataset.points;
            document.getElementById('adjustDiscordId').value = discordId;
            document.getElementById('currentPoints').textContent = points;
            document.getElementById('scoreAdjustment').value = '';
            document.getElementById('adjustmentReason').value = '';
            // Show modal via Flowbite
            const modalEl = document.getElementById('adjustScoreModal');
            if (window.FlowbiteInstances && window.FlowbiteInstances.getInstance('Modal', 'adjustScoreModal')) {
                window.FlowbiteInstances.getInstance('Modal', 'adjustScoreModal').show();
            } else {
                modalEl.classList.remove('hidden');
                modalEl.classList.add('flex');
            }
        });
    });

    // ----- Submit score adjustment -----
    document.getElementById('adjustScoreForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const discordId = formData.get('discord_id');
        const adjustment = parseInt(formData.get('adjustment'));
        const reason = formData.get('reason');

        if (isNaN(adjustment) || adjustment === 0) {
            Swal.fire({
                title: 'Invalid Adjustment',
                text: 'Please enter a non-zero adjustment value.',
                icon: 'warning',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            });
            return;
        }

        try {
            const response = await fetch(adjustScoreUrl.replace('PLACEHOLDER', discordId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    adjustment: adjustment,
                    reason: reason || 'Admin adjustment'
                })
            });
            const data = await response.json();
            if (response.ok && data.success) {
                Swal.fire({
                    title: 'Score Updated',
                    text: 'Player score has been adjusted.',
                    icon: 'success',
                    background: isDark ? '#1f2937' : '#ffffff',
                    color: isDark ? '#f3f4f6' : '#111827'
                }).then(() => window.location.reload());
            } else {
                Swal.fire({
                    title: 'Error',
                    text: data.message || 'Failed to adjust score.',
                    icon: 'error',
                    background: isDark ? '#1f2937' : '#ffffff',
                    color: isDark ? '#f3f4f6' : '#111827'
                });
            }
        } catch (error) {
            console.error('Error adjusting score:', error);
            Swal.fire({
                title: 'Error',
                text: 'An unexpected error occurred.',
                icon: 'error',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            });
        }
    });

    // ----- Close adjust score modal -----
    document.querySelectorAll('[data-modal-hide="adjustScoreModal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const modalEl = document.getElementById('adjustScoreModal');
            modalEl.classList.add('hidden');
            modalEl.classList.remove('flex');
        });
    });
});
</script>
{% endblock %}
