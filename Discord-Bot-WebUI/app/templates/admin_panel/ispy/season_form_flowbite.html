{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert, input, textarea, select %}

{% block admin_title %}{% if season %}Edit Season: {{ season.name }}{% else %}Create New Season{% endif %} - I-Spy{% endblock %}
{% block panel_description %}{% if season %}Edit I-Spy season details{% else %}Create a new I-Spy game season{% endif %}{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.ispy_management') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">I-Spy</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.ispy_seasons') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">Seasons</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">{% if season %}Edit{% else %}Create{% endif %}</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<div class="max-w-3xl mx-auto">
    <!-- Form Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 mb-6 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center gap-4">
            <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-ecs-green/10">
                <i class="ti ti-calendar-plus text-2xl text-ecs-green"></i>
            </div>
            <div>
                <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
                    {% if season %}Edit Season: {{ season.name }}{% else %}Create New Season{% endif %}
                </h5>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    {% if season %}Update the season details below{% else %}Fill in the details to create a new I-Spy season{% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Season Form -->
    <form id="seasonForm" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Basic Information -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 mb-6">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700">
                <h6 class="text-base font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="ti ti-info-circle mr-2 text-ecs-green"></i>Basic Information
                </h6>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Season Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="name" name="name" required
                        value="{{ season.name if season else '' }}"
                        placeholder="e.g., Spring 2024 Season"
                        class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                </div>
            </div>
        </div>

        <!-- Date Range -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 mb-6">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700">
                <h6 class="text-base font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="ti ti-calendar-event mr-2 text-ecs-green"></i>Date Range
                </h6>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Start Date <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="start_date" name="start_date" required
                            value="{{ season.start_date.strftime('%Y-%m-%d') if season and season.start_date else '' }}"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                    </div>
                    <div>
                        <label for="end_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            End Date <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="end_date" name="end_date" required
                            value="{{ season.end_date.strftime('%Y-%m-%d') if season and season.end_date else '' }}"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                    </div>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                    <i class="ti ti-info-circle mr-1"></i>
                    The season will automatically activate on the start date and deactivate on the end date.
                </p>
            </div>
        </div>

        <!-- Active Season -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 mb-6">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700">
                <h6 class="text-base font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="ti ti-settings mr-2 text-ecs-green"></i>Season Status
                </h6>
            </div>
            <div class="p-6">
                <div class="flex items-center">
                    <input type="checkbox" id="is_active" name="is_active"
                        {{ 'checked' if season and season.is_active else '' }}
                        class="w-4 h-4 text-ecs-green bg-gray-100 border-gray-300 rounded focus:ring-ecs-green dark:focus:ring-ecs-green dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label for="is_active" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                        Set as Active Season
                    </label>
                </div>
                <div class="mt-3 flex items-start p-3 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800">
                    <i class="ti ti-alert-triangle w-5 h-5 text-yellow-500 mr-2 flex-shrink-0 mt-0.5"></i>
                    <p class="text-xs text-yellow-700 dark:text-yellow-300">
                        Activating this season will deactivate any other currently active season. Only one season can be active at a time.
                    </p>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-between gap-4">
            <a href="{{ url_for('admin_panel.ispy_seasons') }}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600">
                <i class="ti ti-arrow-left mr-1"></i>Back to Seasons
            </a>
            <div class="flex items-center gap-3">
                {% if season %}
                <button type="button" id="deleteSeason" class="px-4 py-2 text-sm font-medium text-red-600 bg-white border border-red-300 rounded-lg hover:bg-red-50 dark:bg-gray-700 dark:text-red-400 dark:border-red-600 dark:hover:bg-red-900/20">
                    <i class="ti ti-trash mr-1"></i>Delete Season
                </button>
                {% endif %}
                <button type="submit" id="submitBtn" class="px-6 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green/90">
                    <i class="ti ti-{% if season %}check{% else %}plus{% endif %} mr-1"></i>
                    {% if season %}Save Changes{% else %}Create Season{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');
    const isEditing = {{ 'true' if season else 'false' }};
    const actionUrl = isEditing
        ? "{{ url_for('admin_panel.edit_ispy_season', season_id=season.id) if season else '' }}"
        : "{{ url_for('admin_panel.create_ispy_season') }}";
    const seasonsUrl = "{{ url_for('admin_panel.ispy_seasons') }}";

    // Date validation - enforce end >= start
    const startDate = document.getElementById('start_date');
    const endDate = document.getElementById('end_date');

    startDate?.addEventListener('change', function() {
        if (endDate.value && new Date(endDate.value) < new Date(this.value)) {
            endDate.value = this.value;
        }
        endDate.min = this.value;
    });

    // Set initial min on end_date if start_date has a value
    if (startDate?.value) {
        endDate.min = startDate.value;
    }

    // Delete season confirmation
    {% if season %}
    document.getElementById('deleteSeason')?.addEventListener('click', function() {
        Swal.fire({
            title: 'Delete Season?',
            text: 'This will permanently delete the season and all associated data. This cannot be undone.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, Delete',
            confirmButtonColor: '#dc2626',
            background: isDark ? '#1f2937' : '#ffffff',
            color: isDark ? '#f3f4f6' : '#111827'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch("{{ url_for('admin_panel.delete_ispy_season', season_id=season.id) }}", {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token() }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success || data.status === 'success') {
                        Swal.fire({
                            title: 'Deleted!',
                            text: 'Season has been deleted.',
                            icon: 'success',
                            background: isDark ? '#1f2937' : '#ffffff',
                            color: isDark ? '#f3f4f6' : '#111827'
                        }).then(() => {
                            window.location.href = seasonsUrl;
                        });
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: data.message || data.error || 'Failed to delete season.',
                            icon: 'error',
                            background: isDark ? '#1f2937' : '#ffffff',
                            color: isDark ? '#f3f4f6' : '#111827'
                        });
                    }
                })
                .catch(() => {
                    Swal.fire({
                        title: 'Error',
                        text: 'An unexpected error occurred.',
                        icon: 'error',
                        background: isDark ? '#1f2937' : '#ffffff',
                        color: isDark ? '#f3f4f6' : '#111827'
                    });
                });
            }
        });
    });
    {% endif %}

    // Form submission via fetch JSON POST
    document.getElementById('seasonForm')?.addEventListener('submit', function(e) {
        e.preventDefault();

        const name = document.getElementById('name').value.trim();
        const startDateVal = document.getElementById('start_date').value;
        const endDateVal = document.getElementById('end_date').value;
        const isActive = document.getElementById('is_active').checked;

        // Client-side validation
        if (!name) {
            Swal.fire({
                title: 'Validation Error',
                text: 'Season name is required.',
                icon: 'error',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            });
            return;
        }

        if (!startDateVal || !endDateVal) {
            Swal.fire({
                title: 'Validation Error',
                text: 'Both start date and end date are required.',
                icon: 'error',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            });
            return;
        }

        if (new Date(endDateVal) < new Date(startDateVal)) {
            Swal.fire({
                title: 'Validation Error',
                text: 'End date must be on or after start date.',
                icon: 'error',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            });
            return;
        }

        // Disable submit button
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="ti ti-loader-2 animate-spin mr-1"></i>Saving...';

        const payload = {
            name: name,
            start_date: startDateVal,
            end_date: endDateVal,
            is_active: isActive
        };

        fetch(actionUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success || data.status === 'success') {
                Swal.fire({
                    title: 'Success!',
                    text: isEditing ? 'Season updated successfully.' : 'Season created successfully.',
                    icon: 'success',
                    background: isDark ? '#1f2937' : '#ffffff',
                    color: isDark ? '#f3f4f6' : '#111827'
                }).then(() => {
                    window.location.href = seasonsUrl;
                });
            } else {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                Swal.fire({
                    title: 'Error',
                    text: data.message || data.error || 'Failed to save season.',
                    icon: 'error',
                    background: isDark ? '#1f2937' : '#ffffff',
                    color: isDark ? '#f3f4f6' : '#111827'
                });
            }
        })
        .catch(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            Swal.fire({
                title: 'Error',
                text: 'An unexpected error occurred.',
                icon: 'error',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            });
        });
    });
});
</script>
{% endblock %}
