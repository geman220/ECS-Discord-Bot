{% extends "admin_panel/base.html" %}
{% import 'macros.html' as macros %}

{% block title %}Direct Messaging - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin_panel.communication_hub') }}">Communication</a>
</li>
<li class="breadcrumb-item active">Direct Messaging</li>
{% endblock %}

{% block panel_content %}

    <!-- Statistics Overview -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card bg-primary text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ stats.total_players }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Total Players</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-users u-card-icon-stat"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card bg-success text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ stats.players_with_phone }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">SMS Reachable</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-phone u-card-icon-stat"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card bg-info text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ stats.players_with_discord }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Discord Linked</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-brand-discord u-card-icon-stat"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card bg-warning text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ stats.sms_enabled_users }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">SMS Enabled</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-message u-card-icon-stat"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Send Message Card -->
        <div class="col-lg-8 mb-4">
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-send me-2"></i>Send Direct Message
                    </h5>
                </div>
                <div class="c-card__body">
                    <!-- Player Search -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Search Player</label>
                        <div class="input-group" data-input-group>
                            <span class="input-group-text"><i class="ti ti-search"></i></span>
                            <input type="text" class="form-control" id="playerSearch"
                                   placeholder="Type player name to search..." autocomplete="off" data-form-control>
                        </div>
                        <div id="searchResults" class="list-group mt-2 u-hidden"></div>
                    </div>

                    <!-- Selected Player Info -->
                    <div id="selectedPlayerCard" class="c-card bg-light mb-4 u-hidden">
                        <div class="c-card__body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1" id="selectedPlayerName"></h6>
                                    <div class="text-muted small">
                                        <span id="playerPhone" class="me-3"></span>
                                        <span id="playerDiscord"></span>
                                    </div>
                                    <div class="mt-2">
                                        <span id="smsStatus" class="badge me-1" data-badge></span>
                                        <span id="discordStatus" class="badge" data-badge></span>
                                    </div>
                                </div>
                                <button type="button" class="c-btn c-btn--sm c-btn--outline-secondary js-clear-selection" onclick="clearSelection()">
                                    <i class="ti ti-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Message Type Tabs -->
                    <ul class="nav nav-tabs mb-3" role="tablist" data-tabs>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="sms-tab" data-bs-toggle="tab"
                                    data-bs-target="#sms-panel" type="button" role="tab">
                                <i class="ti ti-phone me-1"></i>SMS
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="discord-tab" data-bs-toggle="tab"
                                    data-bs-target="#discord-panel" type="button" role="tab">
                                <i class="ti ti-brand-discord me-1"></i>Discord DM
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- SMS Tab -->
                        <div class="tab-pane fade show active" id="sms-panel" role="tabpanel" data-tab-pane>
                            <form id="smsForm" method="POST" action="{{ url_for('admin_panel.send_sms') }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="player_id" id="smsPlayerId">
                                <input type="hidden" name="phone" id="smsPhone">

                                <div class="mb-3">
                                    <label for="smsMessage" class="form-label">Message</label>
                                    <textarea class="form-control" id="smsMessage" name="message" rows="4"
                                              placeholder="Enter your SMS message..." required data-form-control></textarea>
                                    <div class="form-text">
                                        <span id="smsCharCount">0</span>/160 characters
                                        <span id="smsSegments" class="text-muted">(1 segment)</span>
                                    </div>
                                </div>

                                <div class="alert alert-info small" data-alert>
                                    <i class="ti ti-info-circle me-1"></i>
                                    SMS messages are subject to rate limiting. Player must have SMS notifications enabled.
                                </div>

                                <button type="submit" class="c-btn c-btn--primary" id="sendSmsBtn" disabled>
                                    <i class="ti ti-send me-1"></i>Send SMS
                                </button>
                            </form>
                        </div>

                        <!-- Discord DM Tab -->
                        <div class="tab-pane fade" id="discord-panel" role="tabpanel" data-tab-pane>
                            <form id="discordForm" method="POST" action="{{ url_for('admin_panel.send_discord_dm') }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="player_id" id="discordPlayerId">

                                <div class="mb-3">
                                    <label for="discordMessage" class="form-label">Message</label>
                                    <textarea class="form-control" id="discordMessage" name="message" rows="4"
                                              placeholder="Enter your Discord DM message..." required data-form-control></textarea>
                                    <div class="form-text">
                                        Discord messages support markdown formatting.
                                    </div>
                                </div>

                                <div class="alert alert-info small" data-alert>
                                    <i class="ti ti-info-circle me-1"></i>
                                    Discord DMs require the bot to share a server with the user. Player must have Discord notifications enabled.
                                </div>

                                <button type="submit" class="c-btn c-btn--primary" id="sendDiscordBtn" disabled>
                                    <i class="ti ti-send me-1"></i>Send Discord DM
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions & Info -->
        <div class="col-lg-4 mb-4">
            <!-- SMS Rate Limit Status -->
            {% if current_user.has_role('Global Admin') %}
            <div class="c-card mb-4">
                <div class="c-card__header">
                    <h6 class="c-card__title mb-0">
                        <i class="ti ti-chart-bar me-2"></i>SMS Rate Limit Status
                    </h6>
                </div>
                <div class="c-card__body" id="smsRateStatus">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status" data-spinner>
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted small mt-2 mb-0">Loading status...</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Recent Players -->
            <div class="c-card mb-4">
                <div class="c-card__header">
                    <h6 class="c-card__title mb-0">
                        <i class="ti ti-clock me-2"></i>Recent Players
                    </h6>
                </div>
                <div class="c-card__body p-0">
                    <div class="list-group list-group-flush u-max-h-300 u-overflow-y-auto">
                        {% for player in recent_players[:10] %}
                        <a href="#" class="list-group-item list-group-item-action quick-select-player"
                           data-id="{{ player.id }}"
                           data-name="{{ player.name }}"
                           data-phone="{{ player.phone or '' }}"
                           data-discord="{{ player.discord_id or '' }}"
                           data-sms="{{ player.user.sms_notifications if player.user else false }}"
                           data-discord-enabled="{{ player.user.discord_notifications if player.user else false }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-medium">{{ player.name }}</div>
                                    <div class="small text-muted">
                                        {% if player.phone %}
                                        <i class="ti ti-phone text-success me-1" title="Has phone"></i>
                                        {% endif %}
                                        {% if player.discord_id %}
                                        <i class="ti ti-brand-discord text-primary me-1" title="Discord linked"></i>
                                        {% endif %}
                                    </div>
                                </div>
                                <i class="ti ti-chevron-right text-muted"></i>
                            </div>
                        </a>
                        {% else %}
                        <div class="list-group-item text-center text-muted py-4">
                            No recent players
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Help Card -->
            <div class="c-card">
                <div class="c-card__header">
                    <h6 class="c-card__title mb-0">
                        <i class="ti ti-help me-2"></i>Help
                    </h6>
                </div>
                <div class="c-card__body">
                    <p class="small text-muted mb-2">
                        <strong>SMS Messages:</strong> Standard SMS rates apply. Messages over 160 characters
                        will be split into multiple segments.
                    </p>
                    <p class="small text-muted mb-0">
                        <strong>Discord DMs:</strong> Sent via the Discord bot. Player must have DMs enabled
                        from server members.
                    </p>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Apply dynamic widths from data attributes
    document.querySelectorAll('[data-width]').forEach(el => {
        el.style.width = el.dataset.width + '%';
    });

    const playerSearch = document.getElementById('playerSearch');
    const searchResults = document.getElementById('searchResults');
    const selectedPlayerCard = document.getElementById('selectedPlayerCard');
    let searchTimeout;
    let selectedPlayer = null;

    // Player search
    playerSearch.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
            searchResults.classList.add('u-hidden');
            return;
        }

        searchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`{{ url_for('admin_panel.player_search') }}?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.players && data.players.length > 0) {
                    searchResults.classList.remove('u-hidden');
                    searchResults.innerHTML = data.players.map(player => {
                        // Determine messaging availability
                        const canSms = player.has_phone && player.sms_enabled;
                        const canDiscord = player.has_discord && player.discord_enabled;
                        const canMessage = canSms || canDiscord;

                        let statusIcons = '';
                        if (canSms) statusIcons += '<i class="ti ti-phone text-success me-1" title="SMS available"></i>';
                        else if (player.has_phone) statusIcons += '<i class="ti ti-phone text-muted me-1" title="SMS disabled"></i>';

                        if (canDiscord) statusIcons += '<i class="ti ti-brand-discord text-primary" title="Discord available"></i>';
                        else if (player.has_discord) statusIcons += '<i class="ti ti-brand-discord text-muted" title="Discord disabled"></i>';

                        if (!canMessage) statusIcons += '<span class="badge bg-warning text-dark ms-1" data-badge>No messaging</span>';

                        return `
                        <a href="#" class="list-group-item list-group-item-action player-result ${!canMessage ? 'list-group-item-warning' : ''}"
                           data-id="${player.id}"
                           data-name="${player.name}"
                           data-phone="${player.phone || ''}"
                           data-discord="${player.discord_id || ''}"
                           data-sms="${player.sms_enabled}"
                           data-discord-enabled="${player.discord_enabled}"
                           data-has-phone="${player.has_phone}"
                           data-has-discord="${player.has_discord}">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${player.name}</span>
                                <span>${statusIcons}</span>
                            </div>
                        </a>`;
                    }).join('');

                    // Add click handlers
                    document.querySelectorAll('.player-result').forEach(el => {
                        el.addEventListener('click', function(e) {
                            e.preventDefault();
                            selectPlayer(this.dataset);
                        });
                    });
                } else {
                    searchResults.classList.remove('u-hidden');
                    searchResults.innerHTML = '<div class="list-group-item text-muted">No players found</div>';
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }, 300);
    });

    // Event delegation for quick select players and clear selection
    document.addEventListener('click', function(e) {
        if (e.target.closest('.quick-select-player')) {
            e.preventDefault();
            selectPlayer(e.target.closest('.quick-select-player').dataset);
        }
        if (e.target.closest('[data-action="clear-selection"]')) {
            e.preventDefault();
            clearSelection();
        }
    });

    // Select player function
    window.selectPlayer = function(data) {
        // Handle both kebab-case (HTML data attributes) and camelCase
        const discordEnabled = data.discordEnabled === 'true' || data.discordEnabled === true ||
                               data['discord-enabled'] === 'true' || data['discord-enabled'] === true;
        const smsEnabled = data.sms === 'true' || data.sms === true;
        const hasPhone = data.hasPhone === 'true' || data.hasPhone === true ||
                        data['has-phone'] === 'true' || data['has-phone'] === true || !!data.phone;
        const hasDiscord = data.hasDiscord === 'true' || data.hasDiscord === true ||
                          data['has-discord'] === 'true' || data['has-discord'] === true || !!data.discord;

        selectedPlayer = {
            id: data.id,
            name: data.name,
            phone: data.phone || '',
            discord_id: data.discord || '',
            has_phone: hasPhone,
            has_discord: hasDiscord,
            sms_enabled: smsEnabled,
            discord_enabled: discordEnabled,
            can_sms: hasPhone && smsEnabled,
            can_discord: hasDiscord && discordEnabled
        };

        // Update UI
        document.getElementById('selectedPlayerName').textContent = data.name;
        document.getElementById('playerPhone').innerHTML = selectedPlayer.phone ?
            `<i class="ti ti-phone me-1"></i>${selectedPlayer.phone}` : '<span class="text-muted">No phone</span>';
        document.getElementById('playerDiscord').innerHTML = selectedPlayer.discord_id ?
            `<i class="ti ti-brand-discord me-1"></i>Linked` : '<span class="text-muted">No Discord</span>';

        // Status badges with detailed info
        const smsStatus = document.getElementById('smsStatus');
        if (!selectedPlayer.has_phone) {
            smsStatus.className = 'badge bg-secondary';
            smsStatus.textContent = 'No Phone';
        } else if (!selectedPlayer.sms_enabled) {
            smsStatus.className = 'badge bg-warning text-dark';
            smsStatus.textContent = 'SMS Disabled by User';
        } else {
            smsStatus.className = 'badge bg-success';
            smsStatus.textContent = 'SMS Available';
        }

        const discordStatus = document.getElementById('discordStatus');
        if (!selectedPlayer.has_discord) {
            discordStatus.className = 'badge bg-secondary';
            discordStatus.textContent = 'No Discord';
        } else if (!selectedPlayer.discord_enabled) {
            discordStatus.className = 'badge bg-warning text-dark';
            discordStatus.textContent = 'Discord DM Disabled by User';
        } else {
            discordStatus.className = 'badge bg-success';
            discordStatus.textContent = 'Discord Available';
        }

        // Update form fields
        document.getElementById('smsPlayerId').value = data.id;
        document.getElementById('smsPhone').value = selectedPlayer.phone;
        document.getElementById('discordPlayerId').value = data.id;

        // Show/hide tabs based on available options
        const smsTab = document.getElementById('sms-tab');
        const discordTab = document.getElementById('discord-tab');
        const smsTabItem = smsTab.closest('.nav-item');
        const discordTabItem = discordTab.closest('.nav-item');

        // Show/hide and enable/disable tabs based on what's available
        smsTabItem.style.display = selectedPlayer.has_phone ? '' : 'none';
        discordTabItem.style.display = selectedPlayer.has_discord ? '' : 'none';

        // Switch to an available tab if current one is hidden
        if (!selectedPlayer.has_phone && smsTab.classList.contains('active')) {
            if (selectedPlayer.has_discord) {
                discordTab.click();
            }
        } else if (!selectedPlayer.has_discord && discordTab.classList.contains('active')) {
            if (selectedPlayer.has_phone) {
                smsTab.click();
            }
        }

        // Show warning if no messaging available
        let noMessagingWarning = document.getElementById('noMessagingWarning');
        if (!selectedPlayer.can_sms && !selectedPlayer.can_discord) {
            if (!noMessagingWarning) {
                noMessagingWarning = document.createElement('div');
                noMessagingWarning.id = 'noMessagingWarning';
                noMessagingWarning.className = 'alert alert-warning mt-3';
                noMessagingWarning.innerHTML = `
                    <i class="ti ti-alert-triangle me-2"></i>
                    <strong>Cannot message this player.</strong>
                    ${!selectedPlayer.has_phone && !selectedPlayer.has_discord ?
                        'Player has no phone number or Discord linked.' :
                        'Player has disabled all notification preferences.'}
                `;
                selectedPlayerCard.querySelector('.card-body').appendChild(noMessagingWarning);
            }
        } else if (noMessagingWarning) {
            noMessagingWarning.remove();
        }

        // Enable/disable buttons
        document.getElementById('sendSmsBtn').disabled = !selectedPlayer.can_sms;
        document.getElementById('sendDiscordBtn').disabled = !selectedPlayer.can_discord;

        selectedPlayerCard.classList.remove('u-hidden');
        searchResults.classList.add('u-hidden');
        playerSearch.value = '';
    };

    // Clear selection
    window.clearSelection = function() {
        selectedPlayer = null;
        selectedPlayerCard.classList.add('u-hidden');
        document.getElementById('smsPlayerId').value = '';
        document.getElementById('smsPhone').value = '';
        document.getElementById('discordPlayerId').value = '';
        document.getElementById('sendSmsBtn').disabled = true;
        document.getElementById('sendDiscordBtn').disabled = true;

        // Reset tabs visibility
        const smsTab = document.getElementById('sms-tab');
        const discordTab = document.getElementById('discord-tab');
        smsTab.closest('.nav-item').style.display = '';
        discordTab.closest('.nav-item').style.display = '';

        // Remove warning if present
        const warning = document.getElementById('noMessagingWarning');
        if (warning) warning.remove();

        // Reset to SMS tab
        if (!smsTab.classList.contains('active')) {
            smsTab.click();
        }
    };

    // SMS character counter
    const smsMessage = document.getElementById('smsMessage');
    const smsCharCount = document.getElementById('smsCharCount');
    const smsSegments = document.getElementById('smsSegments');

    smsMessage.addEventListener('input', function() {
        const len = this.value.length;
        smsCharCount.textContent = len;
        const segments = Math.ceil(len / 160) || 1;
        smsSegments.textContent = `(${segments} segment${segments > 1 ? 's' : ''})`;
    });

    // Load SMS rate limit status
    {% if current_user.has_role('Global Admin') %}
    loadSmsStatus();

    async function loadSmsStatus() {
        try {
            const response = await fetch('{{ url_for("admin_panel.sms_status") }}');
            const data = await response.json();

            const container = document.getElementById('smsRateStatus');

            if (data.error && data.error === 'SMS system not configured') {
                container.innerHTML = `
                    <div class="alert alert-warning mb-0" data-alert>
                        <i class="ti ti-alert-triangle me-1"></i>
                        SMS system not configured
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between small mb-1">
                        <span>System Usage</span>
                        <span>${data.system.total_count} / ${data.system.limit}</span>
                    </div>
                    <div class="progress u-progress-sm">
                        <div class="progress-bar ${data.system.remaining < 10 ? 'bg-danger' : 'bg-primary'}"
                             data-width="${(data.system.total_count / data.system.limit) * 100}"></div>
                    </div>
                </div>
                <div class="small text-muted">
                    <div><strong>Remaining:</strong> ${data.system.remaining}</div>
                    <div><strong>Window:</strong> ${data.system.window_hours.toFixed(1)} hours</div>
                    ${data.system.reset_time ? `<div><strong>Resets:</strong> ${data.system.reset_time}</div>` : ''}
                </div>
            `;
        } catch (error) {
            console.error('Failed to load SMS status:', error);
            document.getElementById('smsRateStatus').innerHTML = `
                <div class="alert alert-danger mb-0 small" data-alert>
                    <i class="ti ti-alert-circle me-1"></i>
                    Failed to load status
                </div>
            `;
        }
    }
    {% endif %}

    // Form submissions with AJAX
    document.getElementById('smsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('sendSmsBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
        btn.disabled = true;

        try {
            const formData = new FormData(this);
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            const data = await response.json();

            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'SMS Sent',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                });
                document.getElementById('smsMessage').value = '';
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Failed',
                    text: data.message
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to send SMS'
            });
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = !selectedPlayer || !selectedPlayer.phone || !selectedPlayer.sms_enabled;
        }
    });

    document.getElementById('discordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('sendDiscordBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
        btn.disabled = true;

        try {
            const formData = new FormData(this);
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            const data = await response.json();

            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Discord DM Sent',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                });
                document.getElementById('discordMessage').value = '';
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Failed',
                    text: data.message
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to send Discord DM'
            });
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = !selectedPlayer || !selectedPlayer.discord_id || !selectedPlayer.discord_enabled;
        }
    });

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!playerSearch.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.add('u-hidden');
        }
    });

    // Apply widths to dynamically created elements
    const observer = new MutationObserver(() => {
        document.querySelectorAll('[data-width]').forEach(el => {
            if (!el.style.width) {
                el.style.width = el.dataset.width + '%';
            }
        });
    });
    observer.observe(document.body, { childList: true, subtree: true });
});
</script>
{% endblock %}
