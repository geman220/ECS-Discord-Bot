{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert %}

{% block admin_title %}Message Templates{% endblock %}
{% block panel_description %}Manage message templates and categories{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.communication_hub') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">Communication</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Message Templates</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Quick Actions -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
    <div class="p-5">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <!-- Search -->
            <div class="flex-grow max-w-md">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i class="ti ti-search text-gray-500 dark:text-gray-400"></i>
                    </div>
                    <input type="text" id="templateSearch" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Search templates, categories, or variables...">
                </div>
            </div>
            <!-- Actions -->
            <div class="flex flex-wrap gap-2">
                <a href="{{ url_for('admin_panel.league_settings') }}" class="px-4 py-2 text-sm font-medium text-cyan-600 bg-cyan-50 border border-cyan-200 rounded-lg hover:bg-cyan-100 dark:bg-cyan-900/30 dark:text-cyan-400 dark:border-cyan-800">
                    <i class="ti ti-trophy mr-1"></i>League Settings
                </a>
                <a href="{{ url_for('admin_panel.announcements') }}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600">
                    <i class="ti ti-speakerphone mr-1"></i>Announcements
                </a>
                <button type="button" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700" data-modal-target="createCategoryModal" data-modal-toggle="createCategoryModal">
                    <i class="ti ti-plus mr-1"></i>Add Category
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Message Categories -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
    <div class="p-5 border-b border-gray-200 dark:border-gray-700">
        <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="flex items-center gap-4">
                <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="ti ti-folder mr-2"></i>Message Categories
                </h5>
                <div class="hidden md:flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                    <span><strong>{{ categories|length }}</strong> categories</span>
                    <span class="text-gray-300 dark:text-gray-600">|</span>
                    <span><strong>{{ total_templates }}</strong> total templates</span>
                    <span class="text-gray-300 dark:text-gray-600">|</span>
                    <span class="text-green-600 dark:text-green-400"><strong>{{ active_templates }}</strong> active</span>
                </div>
            </div>
            <button type="button" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700" data-modal-target="createCategoryModal" data-modal-toggle="createCategoryModal">
                <i class="ti ti-plus mr-1"></i>Add Category
            </button>
        </div>
    </div>
    {% if categories %}
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-4 py-3">Category</th>
                    <th scope="col" class="px-4 py-3">Description</th>
                    <th scope="col" class="px-4 py-3 text-center">Templates</th>
                    <th scope="col" class="px-4 py-3">Last Updated</th>
                    <th scope="col" class="px-4 py-3 text-right">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for category in categories %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 category-row" data-category-name="{{ category.name }}" data-category-desc="{{ category.description or '' }}">
                    <td class="px-4 py-3">
                        <a href="{{ url_for('admin_panel.message_category', category_id=category.id) }}" class="flex items-center text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                            <i class="ti ti-folder-filled mr-2 text-blue-500"></i>
                            <strong>{{ category.name }}</strong>
                        </a>
                    </td>
                    <td class="px-4 py-3">
                        <span class="text-sm text-gray-500 dark:text-gray-400">{{ category.description or 'No description' }}</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% set template_count = category.templates|length %}
                        {% set active_count = category.templates|selectattr('is_active', 'equalto', true)|list|length %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if template_count == 0 %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300{% elif active_count == template_count %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300{% else %}bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-300{% endif %}">
                            {{ template_count }}{% if template_count > 0 %} <span class="ml-1 opacity-75">({{ active_count }} active)</span>{% endif %}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="text-sm text-gray-500 dark:text-gray-400">{{ category.updated_at.strftime('%Y-%m-%d %H:%M') if category.updated_at else 'Never' }}</span>
                    </td>
                    <td class="px-4 py-3 text-right">
                        <div class="flex items-center justify-end gap-1">
                            <a href="{{ url_for('admin_panel.message_category', category_id=category.id) }}" class="p-2 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg" title="View Templates">
                                <i class="ti ti-eye"></i>
                            </a>
                            <button type="button" class="p-2 text-yellow-600 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded-lg" data-action="edit-category" data-category-id="{{ category.id }}" data-category-name="{{ category.name }}" data-category-description="{{ category.description or '' }}" title="Edit Category">
                                <i class="ti ti-edit"></i>
                            </button>
                            {% if category.templates|length == 0 %}
                            <button type="button" class="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg" data-action="delete-category" data-category-id="{{ category.id }}" data-category-name="{{ category.name }}" title="Delete Category">
                                <i class="ti ti-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="flex items-center justify-center w-16 h-16 mx-auto rounded-full bg-gray-100 dark:bg-gray-700 mb-4">
            <i class="ti ti-folder-x text-3xl text-gray-400 dark:text-gray-500"></i>
        </div>
        <h5 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No message categories found</h5>
        <p class="text-gray-500 dark:text-gray-400 mb-4">Create your first message category to get started.</p>
        <button type="button" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700" data-modal-target="createCategoryModal" data-modal-toggle="createCategoryModal">
            <i class="ti ti-plus mr-1"></i>Create Category
        </button>
    </div>
    {% endif %}
</div>

<!-- Recent Announcements -->
{% if recent_announcements %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow">
    <div class="p-5 border-b border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="ti ti-speakerphone mr-2"></i>Recent Announcements
            </h5>
            <a href="{{ url_for('admin_panel.announcements') }}" class="px-3 py-1.5 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800">
                View All <i class="ti ti-arrow-right ml-1"></i>
            </a>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-4 py-3">Title</th>
                    <th scope="col" class="px-4 py-3">Type</th>
                    <th scope="col" class="px-4 py-3">Created</th>
                    <th scope="col" class="px-4 py-3">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for announcement in recent_announcements %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-900 dark:text-white">{{ announcement.title }}</div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">{{ announcement.content[:50] }}...</p>
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">{{ announcement.announcement_type or 'General' }}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="text-sm">{{ announcement.created_at.strftime('%m/%d %H:%M') }}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Active</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Create Category Modal -->
<div id="createCategoryModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Create Message Category</h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="createCategoryModal">
                    <i class="ti ti-x text-lg"></i>
                </button>
            </div>
            <form method="POST" action="{{ url_for('admin_panel.create_message_category') }}">
                <div class="p-4 md:p-5 space-y-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div>
                        <label for="category_name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Category Name</label>
                        <input type="text" name="name" id="category_name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                    </div>
                    <div>
                        <label for="category_description" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Description</label>
                        <textarea name="description" id="category_description" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"></textarea>
                    </div>
                </div>
                <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b dark:border-gray-600 gap-3">
                    <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600" data-modal-hide="createCategoryModal">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Create Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div id="editCategoryModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Edit Message Category</h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="editCategoryModal">
                    <i class="ti ti-x text-lg"></i>
                </button>
            </div>
            <form method="POST" action="{{ url_for('admin_panel.update_message_category') }}">
                <div class="p-4 md:p-5 space-y-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="category_id" id="edit_category_id">
                    <div>
                        <label for="edit_category_name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Category Name</label>
                        <input type="text" name="name" id="edit_category_name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                    </div>
                    <div>
                        <label for="edit_category_description" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Description</label>
                        <textarea name="description" id="edit_category_description" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"></textarea>
                    </div>
                </div>
                <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b dark:border-gray-600 gap-3">
                    <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600" data-modal-hide="editCategoryModal">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Update Category</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');
    const searchInput = document.getElementById('templateSearch');
    const categoryRows = document.querySelectorAll('.category-row');

    // Search functionality
    if (searchInput && categoryRows.length > 0) {
        let debounceTimer;
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const query = this.value.toLowerCase().trim();
                categoryRows.forEach(function(row) {
                    const name = (row.dataset.categoryName || '').toLowerCase();
                    const desc = (row.dataset.categoryDesc || '').toLowerCase();
                    const text = row.textContent.toLowerCase();
                    if (query === '' || name.includes(query) || desc.includes(query) || text.includes(query)) {
                        row.classList.remove('hidden');
                    } else {
                        row.classList.add('hidden');
                    }
                });
            }, 200);
        });
    }

    // Event delegation for actions
    document.addEventListener('click', function(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;

        if (action === 'edit-category') {
            e.preventDefault();
            document.getElementById('edit_category_id').value = target.dataset.categoryId;
            document.getElementById('edit_category_name').value = target.dataset.categoryName;
            document.getElementById('edit_category_description').value = target.dataset.categoryDescription || '';

            const modal = document.getElementById('editCategoryModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        if (action === 'delete-category') {
            e.preventDefault();
            const categoryId = target.dataset.categoryId;
            const categoryName = target.dataset.categoryName;

            Swal.fire({
                title: 'Delete Category?',
                text: `Are you sure you want to delete "${categoryName}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Delete',
                confirmButtonColor: '#dc2626',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    const formData = new FormData();
                    formData.append('category_id', categoryId);

                    fetch('{{ url_for("admin_panel.delete_message_category") }}', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ csrf_token() }}' },
                        body: formData
                    })
                    .then(response => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: 'Category has been deleted.',
                            background: isDark ? '#1f2937' : '#ffffff',
                            color: isDark ? '#f3f4f6' : '#111827'
                        }).then(() => location.reload());
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to delete category.',
                            background: isDark ? '#1f2937' : '#ffffff',
                            color: isDark ? '#f3f4f6' : '#111827'
                        });
                    });
                }
            });
        }
    });

    // Modal close handlers
    document.querySelectorAll('[data-modal-hide]').forEach(btn => {
        btn.addEventListener('click', function() {
            const modalId = this.dataset.modalHide;
            const modal = document.getElementById(modalId);
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });
    });
});
</script>
{% endblock %}
