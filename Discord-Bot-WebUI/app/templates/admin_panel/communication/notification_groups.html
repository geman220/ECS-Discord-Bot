{% extends "admin_panel/base.html" %}
{% import 'macros.html' as macros %}

{% block title %}Notification Groups - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin_panel.communication_hub') }}">Communication</a>
</li>
<li class="breadcrumb-item active">Notification Groups</li>
{% endblock %}

{% block panel_content %}

    <!-- Notification Groups Overview -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card bg-primary text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ groups|length }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Total Groups</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-users-group card-icon-stat"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card bg-success text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ dynamic_groups }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Dynamic Groups</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-adjustments card-icon-stat"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card bg-info text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ static_groups }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Static Groups</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-list-check card-icon-stat"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card bg-warning text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ total_members }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Total Members</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-user-check card-icon-stat"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Groups Management -->
    <div class="row">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__header d-flex justify-content-between align-items-center">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-users-group me-2"></i>Notification Groups
                    </h5>
                    <div>
                        <button class="c-btn c-btn--outline-secondary me-2 js-go-back" data-action="go-back">
                            <i class="ti ti-arrow-left me-1"></i>Back
                        </button>
                        <button class="c-btn c-btn--primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                            <i class="ti ti-plus me-1"></i>New Group
                        </button>
                    </div>
                </div>
                <div class="c-card__body p-0">
                    {% if groups %}
                    <div class="c-table-wrapper" data-table-responsive>
                        <table class="c-table c-table--hoverable mb-0" data-table>
                            <thead class="c-table--light" scope="col">
                                <tr>
                                    <th scope="col">Group Name</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Members/Reach</th>
                                    <th scope="col">Created</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for group in groups %}
                                <tr>
                                    <td>
                                        <div>
                                            <strong>{{ group.name }}</strong>
                                            {% if group.description %}
                                            <br><small class="text-muted">{{ group.description[:60] }}{% if group.description|length > 60 %}...{% endif %}</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if group.group_type == 'dynamic' %}success{% else %}info{% endif %}" data-badge>
                                            <i class="ti ti-{% if group.group_type == 'dynamic' %}adjustments{% else %}list-check{% endif %} me-1"></i>
                                            {{ group.group_type|title }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if group.group_type == 'static' %}
                                        <span class="badge bg-secondary" data-badge>{{ group.members|length if group.members else 0 }} members</span>
                                        {% else %}
                                        <span class="badge bg-secondary" title="Dynamic - based on criteria" data-badge>Dynamic</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ group.created_at.strftime('%Y-%m-%d') if group.created_at else 'N/A' }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if group.is_active %}success{% else %}danger{% endif %}" data-badge>
                                            {% if group.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="c-btn c-btn--outline-info js-view-group"
                                                    data-action="view-group"
                                                    data-group-id="{{ group.id }}"
                                                    title="View Details">
                                                <i class="ti ti-eye"></i>
                                            </button>
                                            <button class="c-btn c-btn--outline-warning js-edit-group"
                                                    data-action="edit-group"
                                                    data-group-id="{{ group.id }}"
                                                    title="Edit Group">
                                                <i class="ti ti-edit"></i>
                                            </button>
                                            {% if group.group_type == 'static' %}
                                            <button class="c-btn c-btn--outline-primary js-manage-members"
                                                    data-action="manage-members"
                                                    data-group-id="{{ group.id }}"
                                                    data-group-name="{{ group.name }}"
                                                    title="Manage Members">
                                                <i class="ti ti-users"></i>
                                            </button>
                                            {% endif %}
                                            <button class="c-btn c-btn--outline-success js-send-to-group"
                                                    data-action="send-to-group"
                                                    data-group-id="{{ group.id }}"
                                                    data-group-name="{{ group.name }}"
                                                    title="Send Notification">
                                                <i class="ti ti-send"></i>
                                            </button>
                                            <button class="c-btn c-btn--outline-danger js-delete-group"
                                                    data-action="delete-group"
                                                    data-group-id="{{ group.id }}"
                                                    data-group-name="{{ group.name }}"
                                                    title="Delete Group">
                                                <i class="ti ti-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="ti ti-users-group text-muted icon-empty-state"></i>
                        <h5 class="text-muted mt-3">No notification groups found</h5>
                        <p class="text-muted">Create your first notification group to target specific audiences.</p>
                        <button class="c-btn c-btn--primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                            <i class="ti ti-plus me-1"></i>Create Group
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal c-modal fade" data-modal id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel">
        <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg" data-modal-dialog>
            <div class="modal-content c-modal__content" data-modal-content data-modal-content>
                <div class="modal-header c-modal__header" data-modal-header data-modal-header>
                    <h5 class="modal-title c-modal__title" id="createGroupModalLabel">
                        <i class="ti ti-plus me-2"></i>Create Notification Group
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
                </div>
                <form id="createGroupForm" class="js-create-group-form">
                    <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="group_name" class="form-label">Group Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="group_name" name="name" required
                                       placeholder="e.g., Premium Members, Team Captains" data-form-control>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="group_type" class="form-label">Group Type <span class="text-danger">*</span></label>
                                <select class="form-select js-group-type-select" id="group_type" name="group_type" required data-form-select>
                                    <option value="dynamic">Dynamic (criteria-based)</option>
                                    <option value="static">Static (manual members)</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="group_description" class="form-label">Description</label>
                            <textarea class="form-control" id="group_description" name="description" rows="2"
                                      placeholder="Describe who belongs to this group..." data-form-control></textarea>
                        </div>

                        <!-- Dynamic Group Options -->
                        <div id="dynamicGroupOptions">
                            <hr>
                            <h6 class="mb-3"><i class="ti ti-adjustments me-2"></i>Dynamic Targeting Criteria</h6>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="criteria_target_type" class="form-label">Target Type</label>
                                    <select class="form-select js-criteria-target-type" id="criteria_target_type" name="criteria_target_type" data-form-select>
                                        <option value="all">All Users with Push Enabled</option>
                                        <option value="team">By Team</option>
                                        <option value="league">By League</option>
                                        <option value="role">By Role</option>
                                        <option value="pool">Substitute Pool</option>
                                        <option value="platform">By Platform</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="criteria_platform" class="form-label">Platform Filter</label>
                                    <select class="form-select" id="criteria_platform" name="criteria_platform" data-form-select>
                                        <option value="all">All Platforms</option>
                                        <option value="ios">iOS Only</option>
                                        <option value="android">Android Only</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Sub-criteria options -->
                            <div id="criteriaTeamContainer" class="mb-3 d-none">
                                <label for="criteria_teams" class="form-label">Select Teams</label>
                                <select class="form-select" id="criteria_teams" name="criteria_teams" multiple data-form-select>
                                    {% for team in teams|default([]) %}
                                    <option value="{{ team.id }}">{{ team.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                            </div>

                            <div id="criteriaLeagueContainer" class="mb-3 d-none">
                                <label for="criteria_leagues" class="form-label">Select Leagues</label>
                                <select class="form-select" id="criteria_leagues" name="criteria_leagues" multiple data-form-select>
                                    {% for league in leagues|default([]) %}
                                    <option value="{{ league.id }}">{{ league.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                            </div>

                            <div id="criteriaRoleContainer" class="mb-3 d-none">
                                <label for="criteria_roles" class="form-label">Select Roles</label>
                                <select class="form-select" id="criteria_roles" name="criteria_roles" multiple data-form-select>
                                    {% for role in roles|default([]) %}
                                    <option value="{{ role.name }}">{{ role.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                            </div>

                            <div id="criteriaPoolContainer" class="mb-3 d-none">
                                <label for="criteria_pool" class="form-label">Select Pool</label>
                                <select class="form-select" id="criteria_pool" name="criteria_pool" data-form-select>
                                    <option value="all">All Pools</option>
                                    <option value="pub_league">Pub League Sub Pool</option>
                                    <option value="ecs_fc">ECS FC Sub Pool</option>
                                </select>
                            </div>
                        </div>

                        <!-- Static Group Options (hidden by default) -->
                        <div id="staticGroupOptions" class="d-none">
                            <hr>
                            <div class="alert alert-info" data-alert>
                                <i class="ti ti-info-circle me-2"></i>
                                After creating the group, you can add members by clicking the "Manage Members" button.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer c-modal__footer" data-modal-footer data-modal-footer>
                        <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                        <button type="submit" class="c-btn c-btn--primary">
                            <i class="ti ti-plus me-1"></i>Create Group
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Group Modal -->
    <div class="modal c-modal fade" data-modal id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel">
        <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg" data-modal-dialog>
            <div class="modal-content c-modal__content" data-modal-content data-modal-content>
                <div class="modal-header c-modal__header" data-modal-header data-modal-header>
                    <h5 class="modal-title c-modal__title" id="editGroupModalLabel">
                        <i class="ti ti-edit me-2"></i>Edit Notification Group
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
                </div>
                <form id="editGroupForm" class="js-edit-group-form">
                    <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" id="edit_group_id" name="group_id">

                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="edit_group_name" class="form-label">Group Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="edit_group_name" name="name" required data-form-control>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Group Type</label>
                                <input type="text" class="form-control" id="edit_group_type" disabled data-form-control>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="edit_group_description" class="form-label">Description</label>
                            <textarea class="form-control" id="edit_group_description" name="description" rows="2" data-form-control></textarea>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="edit_group_active" name="is_active" checked>
                                <label class="form-check-label" for="edit_group_active">Active</label>
                            </div>
                        </div>

                        <!-- Dynamic criteria editor (shown only for dynamic groups) -->
                        <div id="editDynamicCriteria" class="d-none">
                            <hr>
                            <h6 class="mb-3"><i class="ti ti-adjustments me-2"></i>Targeting Criteria</h6>
                            <div id="editCriteriaContent">
                                <!-- Populated via JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer c-modal__footer" data-modal-footer data-modal-footer>
                        <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                        <button type="submit" class="c-btn c-btn--warning">
                            <i class="ti ti-device-floppy me-1"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Group Details Modal -->
    <div class="modal c-modal fade" data-modal id="viewGroupModal" tabindex="-1" aria-labelledby="viewGroupTitle">
        <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg" data-modal-dialog>
            <div class="modal-content c-modal__content" data-modal-content data-modal-content>
                <div class="modal-header c-modal__header" data-modal-header data-modal-header>
                    <h5 class="modal-title c-modal__title" id="viewGroupTitle">Group Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
                </div>
                <div class="modal-body c-modal__body" data-modal-body id="viewGroupContent" data-modal-body aria-labelledby="viewGroupContentLabel">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status" data-spinner></div>
                    </div>
                </div>
                <div class="modal-footer c-modal__footer" data-modal-footer data-modal-footer>
                    <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Members Modal (for static groups) -->
    <div class="modal c-modal fade" data-modal id="manageMembersModal" tabindex="-1" aria-labelledby="viewGroupContentLabel">
        <div class="modal-dialog c-modal__dialog modal-xl c-modal__dialog--xl" data-modal-dialog>
            <div class="modal-content c-modal__content" data-modal-content data-modal-content>
                <div class="modal-header c-modal__header" data-modal-header data-modal-header>
                    <h5 class="modal-title c-modal__title" id="viewGroupContentLabel">
                        <i class="ti ti-users me-2"></i>Manage Members - <span id="memberGroupName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
                </div>
                <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                    <input type="hidden" id="manage_members_group_id">

                    <div class="row">
                        <!-- Add Members Section -->
                        <div class="col-md-6">
                            <div class="c-card">
                                <div class="c-card__header">
                                    <h6 class="mb-0"><i class="ti ti-user-plus me-2"></i>Add Members</h6>
                                </div>
                                <div class="c-card__body">
                                    <div class="mb-3">
                                        <label for="memberSearch" class="form-label">Search Users</label>
                                        <input type="text" class="form-control js-member-search" id="memberSearch"
                                               placeholder="Search by name or email..." data-form-control>
                                    </div>
                                    <div id="searchResults" class="list-group u-max-h-300 u-overflow-y-auto">
                                        <!-- Search results populated via JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Current Members Section -->
                        <div class="col-md-6">
                            <div class="c-card">
                                <div class="c-card__header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="ti ti-users me-2"></i>Current Members</h6>
                                    <span class="badge bg-primary" id="memberCount" data-badge>0</span>
                                </div>
                                <div class="c-card__body">
                                    <div id="currentMembers" class="list-group u-overflow-y-auto" class="u-max-h-350">
                                        <!-- Current members populated via JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer c-modal__footer" data-modal-footer data-modal-footer>
                    <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Close</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block custom_css %}
{{ super() }}
<style>
.card-icon {
    display: flex;
    align-items: center;
    justify-content: center;
}

.list-group-item-action:hover {
    background-color: var(--bs-light);
}

.member-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

@media (max-width: 768px) {
    .btn-group-sm .btn {
        padding: 0.25rem 0.4rem;
        font-size: 0.75rem;
    }

    .table-responsive {
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
const NotificationGroupsConfig = {
    baseUrl: '/admin-panel',
    csrfToken: '{{ csrf_token() }}'
};

// Event delegation for buttons
document.addEventListener('DOMContentLoaded', function() {
    // Back button
    document.querySelectorAll('.js-go-back').forEach(btn => {
        btn.addEventListener('click', function() {
            window.history.back();
        });
    });

    // View group buttons
    document.querySelectorAll('.js-view-group').forEach(btn => {
        btn.addEventListener('click', function() {
            const groupId = this.dataset.groupId;
            viewGroup(groupId);
        });
    });

    // Edit group buttons
    document.querySelectorAll('.js-edit-group').forEach(btn => {
        btn.addEventListener('click', function() {
            const groupId = this.dataset.groupId;
            editGroup(groupId);
        });
    });

    // Manage members buttons
    document.querySelectorAll('.js-manage-members').forEach(btn => {
        btn.addEventListener('click', function() {
            const groupId = this.dataset.groupId;
            const groupName = this.dataset.groupName;
            manageMembers(groupId, groupName);
        });
    });

    // Send to group buttons
    document.querySelectorAll('.js-send-to-group').forEach(btn => {
        btn.addEventListener('click', function() {
            const groupId = this.dataset.groupId;
            const groupName = this.dataset.groupName;
            sendToGroup(groupId, groupName);
        });
    });

    // Delete group buttons
    document.querySelectorAll('.js-delete-group').forEach(btn => {
        btn.addEventListener('click', function() {
            const groupId = this.dataset.groupId;
            const groupName = this.dataset.groupName;
            deleteGroup(groupId, groupName);
        });
    });

    // Group type select
    document.querySelector('.js-group-type-select')?.addEventListener('change', toggleGroupTypeOptions);

    // Criteria target type select
    document.querySelector('.js-criteria-target-type')?.addEventListener('change', toggleCriteriaOptions);

    // Create group form
    document.querySelector('.js-create-group-form')?.addEventListener('submit', submitCreateGroup);

    // Edit group form
    document.querySelector('.js-edit-group-form')?.addEventListener('submit', submitEditGroup);

    // Member search
    document.querySelector('.js-member-search')?.addEventListener('keyup', searchUsers);
});

// Toggle group type options (dynamic vs static)
function toggleGroupTypeOptions() {
    const groupType = document.getElementById('group_type').value;
    const dynamicOptions = document.getElementById('dynamicGroupOptions');
    const staticOptions = document.getElementById('staticGroupOptions');

    if (groupType === 'dynamic') {
        dynamicOptions.classList.remove('d-none');
        staticOptions.classList.add('d-none');
    } else {
        dynamicOptions.classList.add('d-none');
        staticOptions.classList.remove('d-none');
    }
}

// Toggle criteria sub-options
function toggleCriteriaOptions() {
    const targetType = document.getElementById('criteria_target_type').value;

    // Hide all
    document.getElementById('criteriaTeamContainer').classList.add('d-none');
    document.getElementById('criteriaLeagueContainer').classList.add('d-none');
    document.getElementById('criteriaRoleContainer').classList.add('d-none');
    document.getElementById('criteriaPoolContainer').classList.add('d-none');

    // Show selected
    switch (targetType) {
        case 'team':
            document.getElementById('criteriaTeamContainer').classList.remove('d-none');
            break;
        case 'league':
            document.getElementById('criteriaLeagueContainer').classList.remove('d-none');
            break;
        case 'role':
            document.getElementById('criteriaRoleContainer').classList.remove('d-none');
            break;
        case 'pool':
            document.getElementById('criteriaPoolContainer').classList.remove('d-none');
            break;
    }
}

// Submit create group form
async function submitCreateGroup(event) {
    event.preventDefault();

    const form = document.getElementById('createGroupForm');
    const formData = new FormData(form);

    // Build criteria object for dynamic groups
    const groupType = formData.get('group_type');
    let criteria = null;

    if (groupType === 'dynamic') {
        criteria = {
            target_type: formData.get('criteria_target_type'),
            platform: formData.get('criteria_platform')
        };

        const targetType = criteria.target_type;
        if (targetType === 'team') {
            criteria.team_ids = Array.from(document.getElementById('criteria_teams').selectedOptions).map(opt => opt.value);
        } else if (targetType === 'league') {
            criteria.league_ids = Array.from(document.getElementById('criteria_leagues').selectedOptions).map(opt => opt.value);
        } else if (targetType === 'role') {
            criteria.role_names = Array.from(document.getElementById('criteria_roles').selectedOptions).map(opt => opt.value);
        } else if (targetType === 'pool') {
            criteria.pool_type = formData.get('criteria_pool');
        }
    }

    const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        group_type: groupType,
        criteria: criteria
    };

    try {
        const response = await fetch(`${NotificationGroupsConfig.baseUrl}/communication/notification-groups`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': NotificationGroupsConfig.csrfToken
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            Swal.fire('Success', 'Notification group created successfully!', 'success').then(() => {
                location.reload();
            });
        } else {
            Swal.fire('Error', result.error || 'Failed to create group', 'error');
        }
    } catch (error) {
        console.error('Error creating group:', error);
        Swal.fire('Error', 'Failed to create group. Please try again.', 'error');
    }

    return false;
}

// View group details
async function viewGroup(groupId) {
    ModalManager.show('viewGroupModal');

    document.getElementById('viewGroupContent').innerHTML = '<div class="text-center py-4"><div class="spinner-border" role="status" data-spinner></div></div>';

    try {
        const response = await fetch(`${NotificationGroupsConfig.baseUrl}/communication/notification-groups/${groupId}`);
        const data = await response.json();

        if (data.success) {
            const group = data.group;
            document.getElementById('viewGroupTitle').textContent = group.name;

            let criteriaHtml = '';
            if (group.group_type === 'dynamic' && group.criteria) {
                criteriaHtml = `
                    <h6 class="mt-3">Targeting Criteria</h6>
                    <ul class="list-unstyled">
                        <li><strong>Target Type:</strong> ${group.criteria.target_type || 'All'}</li>
                        <li><strong>Platform:</strong> ${group.criteria.platform || 'All'}</li>
                        ${group.criteria.team_ids ? `<li><strong>Team IDs:</strong> ${group.criteria.team_ids.join(', ')}</li>` : ''}
                        ${group.criteria.league_ids ? `<li><strong>League IDs:</strong> ${group.criteria.league_ids.join(', ')}</li>` : ''}
                        ${group.criteria.role_names ? `<li><strong>Roles:</strong> ${group.criteria.role_names.join(', ')}</li>` : ''}
                        ${group.criteria.pool_type ? `<li><strong>Pool:</strong> ${group.criteria.pool_type}</li>` : ''}
                    </ul>
                `;
            }

            document.getElementById('viewGroupContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Name:</strong> ${group.name}</p>
                        <p><strong>Type:</strong> <span class="badge bg-${group.group_type === 'dynamic' ? 'success' : 'info'}" data-badge>${group.group_type}</span></p>
                        <p><strong>Status:</strong> <span class="badge bg-${group.is_active ? 'success' : 'danger'}" data-badge>${group.is_active ? 'Active' : 'Inactive'}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Created:</strong> ${group.created_at || 'N/A'}</p>
                        <p><strong>Updated:</strong> ${group.updated_at || 'N/A'}</p>
                        <p><strong>Members:</strong> ${group.member_count || 0}</p>
                    </div>
                </div>
                ${group.description ? `<p><strong>Description:</strong> ${group.description}</p>` : ''}
                ${criteriaHtml}
            `;
        } else {
            document.getElementById('viewGroupContent').innerHTML = '<div class="alert alert-danger" data-alert>Failed to load group details</div>';
        }
    } catch (error) {
        console.error('Error loading group:', error);
        document.getElementById('viewGroupContent').innerHTML = '<div class="alert alert-danger" data-alert>Failed to load group details</div>';
    }
}

// Edit group
async function editGroup(groupId) {
    try {
        const response = await fetch(`${NotificationGroupsConfig.baseUrl}/communication/notification-groups/${groupId}`);
        const data = await response.json();

        if (data.success) {
            const group = data.group;

            document.getElementById('edit_group_id').value = group.id;
            document.getElementById('edit_group_name').value = group.name;
            document.getElementById('edit_group_type').value = group.group_type;
            document.getElementById('edit_group_description').value = group.description || '';
            document.getElementById('edit_group_active').checked = group.is_active;

            // Show/hide dynamic criteria editor
            const dynamicCriteria = document.getElementById('editDynamicCriteria');
            if (group.group_type === 'dynamic') {
                dynamicCriteria.classList.remove('d-none');
                document.getElementById('editCriteriaContent').innerHTML = `
                    <p><strong>Current Criteria:</strong></p>
                    <pre class="bg-light p-2 rounded">${JSON.stringify(group.criteria, null, 2)}</pre>
                `;
            } else {
                dynamicCriteria.classList.add('d-none');
            }

            ModalManager.show('editGroupModal');
        } else {
            Swal.fire('Error', 'Failed to load group data', 'error');
        }
    } catch (error) {
        console.error('Error loading group:', error);
        Swal.fire('Error', 'Failed to load group data', 'error');
    }
}

// Submit edit group form
async function submitEditGroup(event) {
    event.preventDefault();

    const groupId = document.getElementById('edit_group_id').value;
    const data = {
        name: document.getElementById('edit_group_name').value,
        description: document.getElementById('edit_group_description').value,
        is_active: document.getElementById('edit_group_active').checked
    };

    try {
        const response = await fetch(`${NotificationGroupsConfig.baseUrl}/communication/notification-groups/${groupId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': NotificationGroupsConfig.csrfToken
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            Swal.fire('Success', 'Group updated successfully!', 'success').then(() => {
                location.reload();
            });
        } else {
            Swal.fire('Error', result.error || 'Failed to update group', 'error');
        }
    } catch (error) {
        console.error('Error updating group:', error);
        Swal.fire('Error', 'Failed to update group. Please try again.', 'error');
    }

    return false;
}

// Delete group
function deleteGroup(groupId, groupName) {
    Swal.fire({
        title: 'Delete Group?',
        text: `Are you sure you want to delete "${groupName}"? This action cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('danger') : '#dc3545',
        cancelButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('secondary') : '#6c757d',
        confirmButtonText: 'Yes, delete it!'
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const response = await fetch(`${NotificationGroupsConfig.baseUrl}/communication/notification-groups/${groupId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': NotificationGroupsConfig.csrfToken
                    }
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire('Deleted!', 'The group has been deleted.', 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('Error', data.error || 'Failed to delete group', 'error');
                }
            } catch (error) {
                console.error('Error deleting group:', error);
                Swal.fire('Error', 'Failed to delete group. Please try again.', 'error');
            }
        }
    });
}

// Send notification to group
function sendToGroup(groupId, groupName) {
    // Redirect to push notifications page with group pre-selected
    window.location.href = `{{ url_for('admin_panel.push_notifications') }}?target_type=group&group_id=${groupId}`;
}

// Manage members (for static groups)
let currentMemberGroupId = null;

async function manageMembers(groupId, groupName) {
    currentMemberGroupId = groupId;
    document.getElementById('manage_members_group_id').value = groupId;
    document.getElementById('memberGroupName').textContent = groupName;

    ModalManager.show('manageMembersModal');

    // Load current members
    await loadMembers();
}

async function loadMembers() {
    const groupId = currentMemberGroupId;

    try {
        const response = await fetch(`${NotificationGroupsConfig.baseUrl}/communication/notification-groups/${groupId}/members`);
        const data = await response.json();

        if (data.success) {
            const membersContainer = document.getElementById('currentMembers');
            document.getElementById('memberCount').textContent = data.members.length;

            if (data.members.length === 0) {
                membersContainer.innerHTML = '<div class="text-center text-muted py-3">No members yet</div>';
            } else {
                membersContainer.innerHTML = data.members.map(member => `
                    <div class="list-group-item member-item">
                        <div>
                            <strong>${member.name || 'Unknown'}</strong>
                            <br><small class="text-muted">${member.email || ''}</small>
                        </div>
                        <button class="c-btn c-btn--sm c-btn--outline-danger js-remove-member" data-action="remove-member" data-member-id="${member.id}">
                            <i class="ti ti-x"></i>
                        </button>
                    </div>
                `).join('');

                // Attach event listeners to dynamically created remove buttons
                membersContainer.querySelectorAll('.js-remove-member').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const memberId = this.dataset.memberId;
                        removeMember(memberId);
                    });
                });
            }
        }
    } catch (error) {
        console.error('Error loading members:', error);
    }
}

let searchTimeout = null;
async function searchUsers() {
    const query = document.getElementById('memberSearch').value;

    if (query.length < 2) {
        document.getElementById('searchResults').innerHTML = '<div class="text-center text-muted py-3">Type at least 2 characters</div>';
        return;
    }

    // Debounce search
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`${NotificationGroupsConfig.baseUrl}/communication/notification-groups/${currentMemberGroupId}/members/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (data.success) {
                const resultsContainer = document.getElementById('searchResults');

                if (data.users.length === 0) {
                    resultsContainer.innerHTML = '<div class="text-center text-muted py-3">No users found</div>';
                } else {
                    resultsContainer.innerHTML = data.users.map(user => `
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center js-add-member"
                                data-action="add-member" data-user-id="${user.id}">
                            <div>
                                <strong>${user.name || 'Unknown'}</strong>
                                <br><small class="text-muted">${user.email || ''}</small>
                            </div>
                            <i class="ti ti-plus text-success"></i>
                        </button>
                    `).join('');

                    // Attach event listeners to dynamically created add buttons
                    resultsContainer.querySelectorAll('.js-add-member').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const userId = this.dataset.userId;
                            addMember(userId);
                        });
                    });
                }
            }
        } catch (error) {
            console.error('Error searching users:', error);
        }
    }, 300);
}

async function addMember(userId) {
    try {
        const response = await fetch(`${NotificationGroupsConfig.baseUrl}/communication/notification-groups/${currentMemberGroupId}/members`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': NotificationGroupsConfig.csrfToken
            },
            body: JSON.stringify({ user_id: userId })
        });

        const data = await response.json();

        if (data.success) {
            await loadMembers();
            document.getElementById('memberSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
        } else {
            Swal.fire('Error', data.error || 'Failed to add member', 'error');
        }
    } catch (error) {
        console.error('Error adding member:', error);
    }
}

async function removeMember(userId) {
    try {
        const response = await fetch(`${NotificationGroupsConfig.baseUrl}/communication/notification-groups/${currentMemberGroupId}/members/${userId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': NotificationGroupsConfig.csrfToken
            }
        });

        const data = await response.json();

        if (data.success) {
            await loadMembers();
        } else {
            Swal.fire('Error', data.error || 'Failed to remove member', 'error');
        }
    } catch (error) {
        console.error('Error removing member:', error);
    }
}
</script>
{% endblock %}
