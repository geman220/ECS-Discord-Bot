{% extends "admin_panel/base.html" %}
{% import 'macros.html' as macros %}

{% block title %}Push Campaigns - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin_panel.communication_hub') }}">Communication</a>
</li>
<li class="breadcrumb-item active">Push Campaigns</li>
{% endblock %}

{% block panel_content %}

    <!-- Campaigns Overview -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card campaign-stat-card bg-primary text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ status_counts.all }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Total Campaigns</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-broadcast"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card campaign-stat-card bg-warning text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ status_counts.scheduled }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Scheduled</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card campaign-stat-card bg-success text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ status_counts.sent }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Sent</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-check"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="c-card campaign-stat-card bg-secondary text-white">
                <div class="c-card__body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="c-card__title text-white mb-1">{{ status_counts.draft }}</h5>
                            <p class="c-card__description small opacity-75 mb-0">Drafts</p>
                        </div>
                        <div class="card-icon">
                            <i class="ti ti-file-text"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaigns Management -->
    <div class="row">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__header d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-broadcast me-2"></i>Push Campaigns
                    </h5>
                    <div class="d-flex gap-2 flex-wrap">
                        <!-- Status Filter -->
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('admin_panel.campaigns_list') }}" class="c-btn c-btn--sm btn-{% if not status_filter %}primary{% else %}outline-primary{% endif %}">
                                All ({{ status_counts.all }})
                            </a>
                            <a href="{{ url_for('admin_panel.campaigns_list', status='draft') }}" class="c-btn c-btn--sm btn-{% if status_filter == 'draft' %}secondary{% else %}outline-secondary{% endif %}">
                                Drafts ({{ status_counts.draft }})
                            </a>
                            <a href="{{ url_for('admin_panel.campaigns_list', status='scheduled') }}" class="c-btn c-btn--sm btn-{% if status_filter == 'scheduled' %}warning{% else %}outline-warning{% endif %}">
                                Scheduled ({{ status_counts.scheduled }})
                            </a>
                            <a href="{{ url_for('admin_panel.campaigns_list', status='sent') }}" class="c-btn c-btn--sm btn-{% if status_filter == 'sent' %}success{% else %}outline-success{% endif %}">
                                Sent ({{ status_counts.sent }})
                            </a>
                        </div>

                        <button class="c-btn c-btn--outline-secondary js-go-back" data-action="go-back-campaigns">
                            <i class="ti ti-arrow-left me-1"></i>Back
                        </button>
                        <button class="c-btn c-btn--primary" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
                            <i class="ti ti-plus me-1"></i>New Campaign
                        </button>
                    </div>
                </div>
                <div class="c-card__body p-0">
                    {% if campaigns.items %}
                    <div class="c-table-wrapper" data-table-responsive>
                        <table class="c-table c-table--hoverable mb-0" data-table>
                            <thead class="c-table--light" scope="col">
                                <tr>
                                    <th scope="col">Campaign</th>
                                    <th scope="col">Target</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Schedule</th>
                                    <th scope="col">Analytics</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for campaign in campaigns.items %}
                                <tr>
                                    <td>
                                        <div>
                                            <strong>{{ campaign.name }}</strong>
                                            <br><small class="text-muted">{{ campaign.title }}</small>
                                            {% if campaign.priority == 'urgent' %}
                                            <br><span class="badge campaign-priority-badge priority-urgent" data-badge>Urgent</span>
                                            {% elif campaign.priority == 'high' %}
                                            <br><span class="badge campaign-priority-badge priority-high" data-badge>High</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge campaign-target-badge" data-badge>{{ campaign.target_type|title }}</span>
                                        <br><small class="text-muted">{{ campaign.target_count or 0 }} recipients</small>
                                    </td>
                                    <td>
                                        {% set status = campaign.status %}
                                        <span class="badge campaign-status-badge status-{{ status }}" data-badge>
                                            {{ status|title }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if campaign.scheduled_send_time %}
                                        <small>{{ campaign.scheduled_send_time.strftime('%Y-%m-%d %H:%M') }}</small>
                                        {% elif campaign.actual_send_time %}
                                        <small>Sent: {{ campaign.actual_send_time.strftime('%Y-%m-%d %H:%M') }}</small>
                                        {% else %}
                                        <small class="text-muted">Not scheduled</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="campaign-analytics">
                                            <div class="campaign-analytics-item" title="Sent">
                                                <i class="ti ti-send icon-sent"></i>
                                                <small>{{ campaign.sent_count or 0 }}</small>
                                            </div>
                                            <div class="campaign-analytics-item" title="Delivered">
                                                <i class="ti ti-check icon-delivered"></i>
                                                <small>{{ campaign.delivered_count or 0 }}</small>
                                            </div>
                                            <div class="campaign-analytics-item" title="Clicked">
                                                <i class="ti ti-click icon-clicked"></i>
                                                <small>{{ campaign.click_count or 0 }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="c-btn c-btn--outline-info js-view-campaign" data-action="view-campaign" data-campaign-id="{{ campaign.id }}" title="View Details">
                                                <i class="ti ti-eye"></i>
                                            </button>
                                            {% if campaign.status == 'draft' %}
                                            <button class="c-btn c-btn--outline-warning js-edit-campaign" data-action="edit-campaign" data-campaign-id="{{ campaign.id }}" title="Edit">
                                                <i class="ti ti-edit"></i>
                                            </button>
                                            <button class="c-btn c-btn--outline-success js-send-campaign" data-action="send-campaign" data-campaign-id="{{ campaign.id }}" data-campaign-name="{{ campaign.name }}" title="Send Now">
                                                <i class="ti ti-send"></i>
                                            </button>
                                            <button class="c-btn c-btn--outline-primary js-schedule-campaign" data-action="schedule-campaign" data-campaign-id="{{ campaign.id }}" data-campaign-name="{{ campaign.name }}" title="Schedule">
                                                <i class="ti ti-clock"></i>
                                            </button>
                                            <button class="c-btn c-btn--outline-danger js-delete-campaign" data-action="delete-campaign" data-campaign-id="{{ campaign.id }}" data-campaign-name="{{ campaign.name }}" title="Delete">
                                                <i class="ti ti-trash"></i>
                                            </button>
                                            {% elif campaign.status == 'scheduled' %}
                                            <button class="c-btn c-btn--outline-danger js-cancel-campaign" data-action="cancel-campaign" data-campaign-id="{{ campaign.id }}" data-campaign-name="{{ campaign.name }}" title="Cancel">
                                                <i class="ti ti-x"></i>
                                            </button>
                                            {% endif %}
                                            <button class="c-btn c-btn--outline-secondary js-duplicate-campaign" data-action="duplicate-campaign" data-campaign-id="{{ campaign.id }}" data-campaign-name="{{ campaign.name }}" title="Duplicate">
                                                <i class="ti ti-copy"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if campaigns.pages > 1 %}
                    <nav class="d-flex justify-content-center mt-3">
                        <ul class="pagination" data-pagination>
                            {% if campaigns.has_prev %}
                            <li class="page-item" data-page-item>
                                <a class="page-link" href="{{ url_for('admin_panel.campaigns_list', page=campaigns.prev_num, status=status_filter) }}">Previous</a>
                            </li>
                            {% endif %}

                            {% for page_num in campaigns.iter_pages() %}
                                {% if page_num %}
                                <li class="page-item {% if page_num == campaigns.page %}active{% endif %}" data-page-item data-page-active>
                                    <a class="page-link" href="{{ url_for('admin_panel.campaigns_list', page=page_num, status=status_filter) }}">{{ page_num }}</a>
                                </li>
                                {% else %}
                                <li class="page-item disabled" data-page-item data-page-disabled><span class="page-link">...</span></li>
                                {% endif %}
                            {% endfor %}

                            {% if campaigns.has_next %}
                            <li class="page-item" data-page-item>
                                <a class="page-link" href="{{ url_for('admin_panel.campaigns_list', page=campaigns.next_num, status=status_filter) }}">Next</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    {% else %}
                    <div class="campaigns-empty-state">
                        <i class="ti ti-broadcast-off campaigns-empty-state-icon"></i>
                        <h5 class="mt-3">No campaigns found</h5>
                        <p>Create your first push notification campaign to get started.</p>
                        <button class="c-btn c-btn--primary" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
                            <i class="ti ti-plus me-1"></i>Create Campaign
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Create Campaign Modal -->
    <div class="modal c-modal fade" id="createCampaignModal" tabindex="-1" data-modal aria-labelledby="createCampaignModalLabel">
        <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg" data-modal-dialog>
            <div class="modal-content c-modal__content" data-modal-content data-modal-content>
                <div class="modal-header c-modal__header" data-modal-header data-modal-header>
                    <h5 class="modal-title c-modal__title" id="createCampaignModalLabel">
                        <i class="ti ti-plus me-2"></i>Create Push Campaign
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
                </div>
                <form id="createCampaignForm">
                    <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- Campaign Details -->
                        <div class="campaign-form-section">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="campaign_name" class="form-label">Campaign Name <span class="campaign-form-required">*</span></label>
                                    <input type="text" class="form-control" id="campaign_name" name="name" required
                                           placeholder="e.g., Spring Season Launch" data-form-control>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="campaign_priority" class="form-label">Priority</label>
                                    <select class="form-select" id="campaign_priority" name="priority" data-form-select>
                                        <option value="normal">Normal</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="campaign_title" class="form-label">Notification Title <span class="campaign-form-required">*</span></label>
                                <input type="text" class="form-control" id="campaign_title" name="title" required maxlength="50"
                                       placeholder="e.g., New Season Starting!" data-form-control>
                                <small class="campaign-form-help">Max 50 characters</small>
                            </div>

                            <div class="mb-3">
                                <label for="campaign_body" class="form-label">Message Body <span class="campaign-form-required">*</span></label>
                                <textarea class="form-control" id="campaign_body" name="body" rows="3" required maxlength="200"
                                          placeholder="The notification message..." data-form-control></textarea>
                                <small class="campaign-form-help">Max 200 characters</small>
                            </div>
                        </div>

                        <div class="campaign-form-section">
                            <hr>
                            <h6 class="mb-3"><i class="ti ti-target me-2"></i>Targeting</h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="campaign_target_type" class="form-label">Target Type</label>
                                <select class="form-select" id="campaign_target_type" name="target_type" data-form-select>
                                    <option value="all">All Subscribers</option>
                                    <option value="team">By Team</option>
                                    <option value="league">By League</option>
                                    <option value="role">By Role</option>
                                    <option value="pool">Substitute Pool</option>
                                    <option value="group">Notification Group</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="campaign_platform" class="form-label">Platform</label>
                                <select class="form-select" id="campaign_platform" name="platform_filter" data-form-select>
                                    <option value="all">All Platforms</option>
                                    <option value="ios">iOS Only</option>
                                    <option value="android">Android Only</option>
                                </select>
                            </div>
                        </div>

                        <!-- Dynamic Target Selectors -->
                        <div id="campaignTeamSelector" class="mb-3 d-none">
                            <label for="campaign_teams" class="form-label">Select Teams</label>
                            <select class="form-select" id="campaign_teams" name="team_ids" multiple data-form-select>
                                {% for team in teams %}
                                <option value="{{ team.id }}">{{ team.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div id="campaignLeagueSelector" class="mb-3 d-none">
                            <label for="campaign_leagues" class="form-label">Select Leagues</label>
                            <select class="form-select" id="campaign_leagues" name="league_ids" multiple data-form-select>
                                {% for league in leagues %}
                                <option value="{{ league.id }}">{{ league.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div id="campaignRoleSelector" class="mb-3 d-none">
                            <label for="campaign_roles" class="form-label">Select Roles</label>
                            <select class="form-select" id="campaign_roles" name="role_names" multiple data-form-select>
                                {% for role in roles %}
                                <option value="{{ role.name }}">{{ role.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div id="campaignPoolSelector" class="mb-3 d-none">
                            <label for="campaign_pool" class="form-label">Select Pool</label>
                            <select class="form-select" id="campaign_pool" name="pool_types" data-form-select>
                                <option value="all">All Pools</option>
                                <option value="pub_league">Pub League Sub Pool</option>
                                <option value="ecs_fc">ECS FC Sub Pool</option>
                            </select>
                        </div>

                        <div id="campaignGroupSelector" class="mb-3 d-none">
                            <label for="campaign_group" class="form-label">Select Group</label>
                            <select class="form-select" id="campaign_group" name="notification_group_id" data-form-select>
                                <option value="">Select a group...</option>
                                {% for group in groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <hr>
                        <h6 class="mb-3"><i class="ti ti-clock me-2"></i>Scheduling</h6>

                        <div class="mb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="send_type" id="send_immediately" value="immediate" checked>
                                <label class="form-check-label" for="send_immediately">Save as Draft</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="send_type" id="send_now" value="send_now">
                                <label class="form-check-label" for="send_now">Send Immediately</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="send_type" id="send_scheduled" value="scheduled">
                                <label class="form-check-label" for="send_scheduled">Schedule for Later</label>
                            </div>
                        </div>

                        <div id="campaignScheduleContainer" class="mb-3 d-none">
                            <label for="campaign_schedule_time" class="form-label">Send Date & Time</label>
                            <input type="datetime-local" class="form-control" id="campaign_schedule_time" name="scheduled_send_time" data-form-control>
                        </div>

                        <div class="mb-3">
                            <label for="campaign_action_url" class="form-label">Action URL (Optional)</label>
                            <input type="url" class="form-control" id="campaign_action_url" name="action_url"
                                   placeholder="https://example.com/action" data-form-control>
                            <small class="form-text text-muted">URL to open when notification is clicked</small>
                        </div>
                    </div>
                    <div class="modal-footer c-modal__footer" data-modal-footer data-modal-footer>
                        <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                        <button type="submit" class="c-btn c-btn--primary">
                            <i class="ti ti-plus me-1"></i>Create Campaign
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Campaign Modal -->
    <div class="modal c-modal fade" id="viewCampaignModal" tabindex="-1" data-modal aria-labelledby="viewCampaignTitle">
        <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg" data-modal-dialog>
            <div class="modal-content c-modal__content" data-modal-content data-modal-content>
                <div class="modal-header c-modal__header" data-modal-header data-modal-header>
                    <h5 class="modal-title c-modal__title" id="viewCampaignTitle">Campaign Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
                </div>
                <div class="modal-body c-modal__body" id="viewCampaignContent" data-modal-body data-modal-body aria-labelledby="viewCampaignContentLabel">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status" data-spinner></div>
                    </div>
                </div>
                <div class="modal-footer c-modal__footer" data-modal-footer data-modal-footer>
                    <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Campaign Modal -->
    <div class="modal c-modal fade" id="scheduleCampaignModal" tabindex="-1" data-modal aria-labelledby="viewCampaignContentLabel">
        <div class="modal-dialog c-modal__dialog" data-modal-dialog>
            <div class="modal-content c-modal__content" data-modal-content data-modal-content>
                <div class="modal-header c-modal__header" data-modal-header data-modal-header>
                    <h5 class="modal-title c-modal__title" id="viewCampaignContentLabel">
                        <i class="ti ti-clock me-2"></i>Schedule Campaign
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
                </div>
                <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                    <input type="hidden" id="schedule_campaign_id">
                    <p>Schedule <strong id="schedule_campaign_name"></strong> for delivery:</p>
                    <div class="mb-3">
                        <label for="schedule_send_time" class="form-label">Send Date & Time</label>
                        <input type="datetime-local" class="form-control" id="schedule_send_time" required data-form-control>
                    </div>
                </div>
                <div class="modal-footer c-modal__footer" data-modal-footer data-modal-footer>
                    <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                    <button type="button" class="c-btn c-btn--primary js-confirm-schedule" data-action="confirm-schedule">
                        <i class="ti ti-clock me-1"></i>Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block custom_css %}
{{ super() }}
<style>
.card-icon {
    display: flex;
    align-items: center;
    justify-content: center;
}

.badge-sm {
    font-size: 0.65rem;
}

@media (max-width: 768px) {
    .btn-group-sm .btn {
        padding: 0.25rem 0.4rem;
        font-size: 0.75rem;
    }

    .table-responsive {
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<!-- Campaign Management Configuration -->
<script>
// Expose configuration to external JS
window.CAMPAIGNS_BASE_URL = '{{ url_for('admin_panel.index') }}';
window.CAMPAIGNS_CSRF_TOKEN = '{{ csrf_token() }}';
</script>

<!-- Campaign Management JavaScript -->
<script src="{{ url_for('static', filename='js/admin/push-campaigns.js') }}"></script>
{% endif %}
{% endblock %}
