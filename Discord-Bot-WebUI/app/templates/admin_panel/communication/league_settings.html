{% extends "admin_panel/base.html" %}
{% import 'macros.html' as macros %}

{% block title %}League Settings - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin_panel.communication_hub') }}">Communication</a>
</li>
<li class="breadcrumb-item active">League Settings</li>
{% endblock %}

{% block panel_content %}
    <!-- Help Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info border-0 alert-gradient-info" data-alert>
                <div class="d-flex align-items-start">
                    <i class="ti ti-info-circle me-3 icon-alert-lg"></i>
                    <div>
                        <h6 class="alert-heading mb-1">About League Settings</h6>
                        <p class="mb-2 small">
                            Configure league-specific information that the Discord bot uses when welcoming new players.
                            Changes here are reflected immediately in bot messages.
                        </p>
                        <div class="row small">
                            <div class="col-md-4">
                                <strong>Display Name:</strong>
                                <p class="mb-0">How the league appears in messages</p>
                            </div>
                            <div class="col-md-4">
                                <strong>Welcome Message:</strong>
                                <p class="mb-0">Sent when players select this league</p>
                            </div>
                            <div class="col-md-4">
                                <strong>Contact Info:</strong>
                                <p class="mb-0">Tells players how to get help</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- League Settings Cards -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__header d-flex justify-content-between align-items-center">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-trophy me-2"></i>League Configurations
                    </h5>
                    <button class="c-btn c-btn--primary" data-bs-toggle="modal" data-bs-target="#createLeagueModal">
                        <i class="ti ti-plus me-1"></i>Add League
                    </button>
                </div>
                <div class="c-card__body">
                    {% if settings %}
                    <div class="row" id="leagueSettingsContainer">
                        {% for setting in settings %}
                        <div class="col-lg-4 col-md-6 mb-4" data-league-id="{{ setting.id }}">
                            <div class="c-card h-100 {% if not setting.is_active %}opacity-50{% endif %}">
                                <div class="c-card__header d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        {% if setting.emoji %}
                                        <span class="me-2 fs-4">{{ setting.emoji }}</span>
                                        {% else %}
                                        <i class="ti ti-trophy me-2 text-primary"></i>
                                        {% endif %}
                                        <h6 class="mb-0">{{ setting.display_name }}</h6>
                                    </div>
                                    <div>
                                        {% if setting.is_active %}
                                        <span class="c-badge c-badge--success">Active</span>
                                        {% else %}
                                        <span class="c-badge c-badge--secondary">Inactive</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="c-card__body">
                                    <div class="mb-3">
                                        <label class="form-label text-muted small">League Key</label>
                                        <p class="mb-0"><code>{{ setting.league_key }}</code></p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted small">Welcome Message</label>
                                        <p class="mb-0 small">{{ setting.welcome_message[:100] }}{% if setting.welcome_message|length > 100 %}...{% endif %}</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted small">Contact Info</label>
                                        <p class="mb-0 small">{{ setting.contact_info[:80] }}{% if setting.contact_info|length > 80 %}...{% endif %}</p>
                                    </div>
                                </div>
                                <div class="c-card__footer">
                                    <div class="btn-group btn-group-sm w-100">
                                        <button class="c-btn c-btn--outline-primary flex-fill js-edit-league"
                                                data-setting-id="{{ setting.id }}"
                                                data-league-key="{{ setting.league_key }}"
                                                data-display-name="{{ setting.display_name }}"
                                                data-welcome-message="{{ setting.welcome_message }}"
                                                data-contact-info="{{ setting.contact_info }}"
                                                data-emoji="{{ setting.emoji or '' }}"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editLeagueModal">
                                            <i class="ti ti-edit me-1"></i>Edit
                                        </button>
                                        <form method="POST" action="{{ url_for('admin_panel.toggle_league_setting') }}" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="setting_id" value="{{ setting.id }}">
                                            <button type="submit" class="c-btn c-btn--outline-{% if setting.is_active %}warning{% else %}success{% endif %}">
                                                <i class="ti ti-{% if setting.is_active %}eye-off{% else %}eye{% endif %}"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="ti ti-trophy text-muted icon-empty-state"></i>
                        <h5 class="text-muted mt-3">No league settings configured</h5>
                        <p class="text-muted">Add your first league to enable Discord bot welcome messages.</p>
                        <button class="c-btn c-btn--primary" data-bs-toggle="modal" data-bs-target="#createLeagueModal">
                            <i class="ti ti-plus me-1"></i>Add League
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Section -->
    <div class="row">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__header">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-message me-2"></i>Message Preview
                    </h5>
                </div>
                <div class="c-card__body">
                    <p class="text-muted small mb-3">
                        This is how the welcome message will appear when a user selects a league via Discord.
                    </p>
                    <div class="bg-dark rounded p-3 c-discord-preview">
                        <div class="d-flex align-items-start">
                            <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-3 c-discord-avatar">
                                <i class="ti ti-robot text-white"></i>
                            </div>
                            <div>
                                <div class="mb-1">
                                    <span class="text-primary fw-bold">ECS Bot</span>
                                    <span class="text-muted small ms-2">Today at 12:00 PM</span>
                                </div>
                                <div class="text-white" id="messagePreview">
                                    Perfect! I've updated your profile to show you're interested in <strong>Pub League Classic</strong>.

                                    You'll love our classic recreational league - it's all about having fun and improving your game!

                                    For Pub League Classic questions, reach out to our Pub League coordinators in the #pub-league channels.

                                    Your information has been passed along to our leadership team. Welcome to the community! ðŸŽ‰
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block modals %}
{{ super() }}
<!-- Create League Modal -->
<div class="modal c-modal fade" id="createLeagueModal" tabindex="-1" aria-labelledby="createLeagueModalLabel">
    <div class="modal-dialog modal-lg c-modal__dialog">
        <div class="modal-content c-modal__content">
            <div class="modal-header c-modal__header">
                <h5 class="modal-title c-modal__title" id="createLeagueModalLabel">Add New League</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_panel.create_league_setting') }}">
                <div class="modal-body c-modal__body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="league_key" class="form-label">League Key <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="league_key" name="league_key" required
                                   placeholder="e.g., pub_league_classic"
                                   pattern="[a-z_]+" title="Lowercase letters and underscores only">
                            <small class="text-muted">Unique identifier (lowercase, underscores only)</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="display_name" class="form-label">Display Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="display_name" name="display_name" required
                                   placeholder="e.g., Pub League Classic">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="emoji" class="form-label">Emoji (optional)</label>
                        <input type="text" class="form-control" id="emoji" name="emoji" maxlength="10"
                               placeholder="e.g., ðŸ†">
                        <small class="text-muted">Shown next to the league name</small>
                    </div>
                    <div class="mb-3">
                        <label for="welcome_message" class="form-label">Welcome Message <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="welcome_message" name="welcome_message" rows="3" required
                                  placeholder="Welcome message sent to new players..."></textarea>
                        <small class="text-muted">Displayed when a player selects this league</small>
                    </div>
                    <div class="mb-3">
                        <label for="contact_info" class="form-label">Contact Info <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="contact_info" name="contact_info" rows="2" required
                                  placeholder="How to get help or ask questions..."></textarea>
                        <small class="text-muted">Tells players where to go for help</small>
                    </div>
                </div>
                <div class="modal-footer c-modal__footer">
                    <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="c-btn c-btn--primary">Create League</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit League Modal -->
<div class="modal c-modal fade" id="editLeagueModal" tabindex="-1" aria-labelledby="editLeagueModalLabel">
    <div class="modal-dialog modal-lg c-modal__dialog">
        <div class="modal-content c-modal__content">
            <div class="modal-header c-modal__header">
                <h5 class="modal-title c-modal__title" id="editLeagueModalLabel">Edit League Setting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_panel.update_league_setting') }}">
                <div class="modal-body c-modal__body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="setting_id" id="edit_setting_id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_league_key" class="form-label">League Key</label>
                            <input type="text" class="form-control" id="edit_league_key" disabled>
                            <small class="text-muted">Cannot be changed after creation</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_display_name" class="form-label">Display Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_display_name" name="display_name" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_emoji" class="form-label">Emoji (optional)</label>
                        <input type="text" class="form-control" id="edit_emoji" name="emoji" maxlength="10">
                    </div>
                    <div class="mb-3">
                        <label for="edit_welcome_message" class="form-label">Welcome Message <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="edit_welcome_message" name="welcome_message" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit_contact_info" class="form-label">Contact Info <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="edit_contact_info" name="contact_info" rows="2" required></textarea>
                    </div>
                </div>
                <div class="modal-footer c-modal__footer">
                    <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="c-btn c-btn--primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_css %}
{{ super() }}
<style>
.icon-alert-lg {
    font-size: 1.75rem;
    line-height: 1;
}

.icon-empty-state {
    font-size: 4rem;
    opacity: 0.3;
}

.alert-gradient-info {
    background: linear-gradient(135deg, rgba(13, 110, 253, 0.1) 0%, rgba(13, 110, 253, 0.05) 100%);
    border-left: 4px solid var(--bs-info);
}

.c-card__footer {
    padding: 0.75rem 1rem;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

[data-bs-theme="dark"] .c-card__footer {
    border-top-color: rgba(255, 255, 255, 0.1);
}

#messagePreview {
    white-space: pre-line;
    line-height: 1.5;
}
</style>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle edit button clicks
    document.querySelectorAll('.js-edit-league').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.getElementById('edit_setting_id').value = this.dataset.settingId;
            document.getElementById('edit_league_key').value = this.dataset.leagueKey;
            document.getElementById('edit_display_name').value = this.dataset.displayName;
            document.getElementById('edit_welcome_message').value = this.dataset.welcomeMessage;
            document.getElementById('edit_contact_info').value = this.dataset.contactInfo;
            document.getElementById('edit_emoji').value = this.dataset.emoji || '';
        });
    });

    // Live preview update
    const previewContainer = document.getElementById('messagePreview');
    const firstCard = document.querySelector('[data-setting-id]');
    if (firstCard && previewContainer) {
        updatePreview(firstCard);
    }

    document.querySelectorAll('[data-setting-id]').forEach(function(card) {
        card.addEventListener('click', function() {
            updatePreview(this);
        });
    });

    function updatePreview(card) {
        const displayName = card.dataset.displayName;
        const welcomeMessage = card.dataset.welcomeMessage;
        const contactInfo = card.dataset.contactInfo;

        previewContainer.innerHTML = `Perfect! I've updated your profile to show you're interested in <strong>${displayName}</strong>.

${welcomeMessage}

${contactInfo}

Your information has been passed along to our leadership team. Welcome to the community! ðŸŽ‰`;
    }
});
</script>
{% endblock %}
