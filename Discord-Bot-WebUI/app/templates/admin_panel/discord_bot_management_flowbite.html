{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert %}

{% block admin_title %}Discord Bot Management{% endblock %}
{% block panel_description %}Manage Discord bot settings and status{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.discord_overview') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">Discord</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Bot Management</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<div data-page="admin-discord-bot">

{% if not bot_online %}
<div class="p-4 mb-6 rounded-lg bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800">
    <div class="flex items-center">
        <i class="ti ti-alert-triangle text-xl text-yellow-600 dark:text-yellow-400 mr-3"></i>
        <div class="text-yellow-700 dark:text-yellow-300">
            <strong>Bot API Offline</strong> - Live operations are unavailable. Cached data shown where available.
        </div>
    </div>
</div>
{% endif %}

<!-- Status Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-2">
    <div class="bg-{{ 'green' if stats.bot_status == 'online' else 'red' }}-50 dark:bg-{{ 'green' if stats.bot_status == 'online' else 'red' }}-900/30 rounded-lg shadow p-5">
        <div class="flex items-center justify-between">
            <div>
                <h3 data-stat-id="bot-status" class="text-2xl font-bold text-{{ 'green' if stats.bot_status == 'online' else 'red' }}-600 dark:text-{{ 'green' if stats.bot_status == 'online' else 'red' }}-400">{{ stats.bot_status.title() }}</h3>
                <span class="text-sm text-{{ 'green' if stats.bot_status == 'online' else 'red' }}-700 dark:text-{{ 'green' if stats.bot_status == 'online' else 'red' }}-300">Bot Status</span>
            </div>
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-{{ 'green' if stats.bot_status == 'online' else 'red' }}-100 dark:bg-{{ 'green' if stats.bot_status == 'online' else 'red' }}-900/50">
                <i class="ti ti-brand-discord text-2xl text-{{ 'green' if stats.bot_status == 'online' else 'red' }}-600 dark:text-{{ 'green' if stats.bot_status == 'online' else 'red' }}-400"></i>
            </div>
        </div>
    </div>
    <div class="bg-cyan-50 dark:bg-cyan-900/30 rounded-lg shadow p-5">
        <div class="flex items-center justify-between">
            <div>
                <h3 data-stat-id="guild-count" class="text-2xl font-bold text-cyan-600 dark:text-cyan-400">{{ stats.guilds_connected or 0 }}</h3>
                <span class="text-sm text-cyan-700 dark:text-cyan-300">Connected Guilds</span>
            </div>
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-cyan-100 dark:bg-cyan-900/50">
                <i class="ti ti-server text-2xl text-cyan-600 dark:text-cyan-400"></i>
            </div>
        </div>
    </div>
    <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg shadow p-5">
        <div class="flex items-center justify-between">
            <div>
                <h3 data-stat-id="commands-today" class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ stats.commands_today or 0 }}</h3>
                <span class="text-sm text-blue-700 dark:text-blue-300">Commands Today</span>
            </div>
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/50">
                <i class="ti ti-command text-2xl text-blue-600 dark:text-blue-400"></i>
            </div>
        </div>
    </div>
    <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-lg shadow p-5">
        <div class="flex items-center justify-between">
            <div>
                <h3 data-stat-id="uptime" class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{{ stats.uptime or '0s' }}</h3>
                <span class="text-sm text-yellow-700 dark:text-yellow-300">Uptime</span>
            </div>
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-yellow-100 dark:bg-yellow-900/50">
                <i class="ti ti-clock text-2xl text-yellow-600 dark:text-yellow-400"></i>
            </div>
        </div>
    </div>
</div>
<div class="mb-6 text-right">
    <span data-stat-id="last-updated" class="text-xs text-gray-400 dark:text-gray-500">Live updates every 30s</span>
</div>

<!-- Control & Commands -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Bot Control -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-settings mr-2 text-yellow-500"></i>Bot Control
            </h5>
            <span class="flex items-center">
                <span data-stat-dot class="w-2 h-2 rounded-full {{ 'bg-green-500' if stats.bot_status == 'online' else 'bg-red-500' }} mr-2"></span>
                <span class="text-sm text-gray-500 dark:text-gray-400">{{ stats.bot_status.title() }}</span>
            </span>
        </div>
        <div class="p-5">
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Control bot operations and manage its status</p>
            <div class="space-y-2">
                <button class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700" data-action="restart-bot">
                    <div class="flex items-center">
                        <i class="ti ti-refresh text-xl text-gray-500 dark:text-gray-400 mr-3"></i>
                        <span class="text-gray-900 dark:text-white">Restart Bot</span>
                    </div>
                    <i class="ti ti-chevron-right text-gray-400"></i>
                </button>
                <button class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700" data-action="check-bot-health">
                    <div class="flex items-center">
                        <i class="ti ti-heart text-xl text-gray-500 dark:text-gray-400 mr-3"></i>
                        <span class="text-gray-900 dark:text-white">Health Check</span>
                    </div>
                    <span data-stat-dot class="w-2 h-2 rounded-full {{ 'bg-green-500' if stats.bot_status == 'online' else 'bg-red-500' }}"></span>
                </button>
                <button class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700" data-action="view-bot-logs">
                    <div class="flex items-center">
                        <i class="ti ti-file-text text-xl text-gray-500 dark:text-gray-400 mr-3"></i>
                        <span class="text-gray-900 dark:text-white">View Bot Logs</span>
                    </div>
                    <i class="ti ti-chevron-right text-gray-400"></i>
                </button>
                <button class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700" data-action="sync-commands">
                    <div class="flex items-center">
                        <i class="ti ti-refresh text-xl text-gray-500 dark:text-gray-400 mr-3"></i>
                        <span class="text-gray-900 dark:text-white">Sync Commands</span>
                    </div>
                    <i class="ti ti-chevron-right text-gray-400"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Command Management -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-command mr-2 text-blue-500"></i>Command Management
            </h5>
        </div>
        <div class="p-5">
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Manage bot commands and their permissions</p>
            <div class="space-y-2">
                <button class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700" data-action="view-commands">
                    <div class="flex items-center">
                        <i class="ti ti-list text-xl text-gray-500 dark:text-gray-400 mr-3"></i>
                        <span class="text-gray-900 dark:text-white">View All Commands</span>
                    </div>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">{{ stats.total_commands or 0 }}</span>
                </button>
                <button class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700" data-action="command-permissions">
                    <div class="flex items-center">
                        <i class="ti ti-shield text-xl text-gray-500 dark:text-gray-400 mr-3"></i>
                        <span class="text-gray-900 dark:text-white">Command Permissions</span>
                    </div>
                    <i class="ti ti-chevron-right text-gray-400"></i>
                </button>
                <button class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700" data-action="command-usage">
                    <div class="flex items-center">
                        <i class="ti ti-chart-bar text-xl text-gray-500 dark:text-gray-400 mr-3"></i>
                        <span class="text-gray-900 dark:text-white">Usage Statistics</span>
                    </div>
                    <i class="ti ti-chevron-right text-gray-400"></i>
                </button>
                <button class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700" data-action="custom-commands">
                    <div class="flex items-center">
                        <i class="ti ti-edit text-xl text-gray-500 dark:text-gray-400 mr-3"></i>
                        <span class="text-gray-900 dark:text-white">Custom Commands</span>
                    </div>
                    <i class="ti ti-chevron-right text-gray-400"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Connected Guilds -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
    <div class="p-5 border-b border-gray-200 dark:border-gray-700">
        <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="ti ti-server mr-2 text-cyan-500"></i>Connected Guilds
        </h5>
    </div>
    <div class="p-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Main Guild -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-5">
                <div class="flex items-center justify-between mb-4">
                    <h6 class="font-semibold text-gray-900 dark:text-white">{{ guild_info.name or 'ECS FC Discord' }}</h6>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' if stats.bot_status == 'online' else 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' }}">
                        {{ stats.bot_status.title() }}
                    </span>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="text-center">
                        <div class="text-xl font-bold text-gray-900 dark:text-white">{{ guild_info.member_count or stats.member_count or 0 }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Members</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xl font-bold text-gray-900 dark:text-white">{{ guild_info.channel_count or 0 }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Channels</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xl font-bold text-gray-900 dark:text-white">{{ guild_info.role_count or 0 }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Roles</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="flex-1 px-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400" data-action="manage-guild" data-guild="{{ guild_info.id or '' }}" data-guild-name="{{ guild_info.name or 'ECS FC Discord' }}">
                        <i class="ti ti-settings mr-1"></i>Manage
                    </button>
                    <button class="flex-1 px-3 py-2 text-sm font-medium text-cyan-600 bg-cyan-50 rounded-lg hover:bg-cyan-100 dark:bg-cyan-900/30 dark:text-cyan-400" data-action="guild-stats" data-guild="{{ guild_info.id or '' }}" data-guild-name="{{ guild_info.name or 'ECS FC Discord' }}">
                        <i class="ti ti-chart-dots mr-1"></i>Stats
                    </button>
                </div>
            </div>

            <!-- Add Guild Card -->
            <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-5 flex flex-col items-center justify-center">
                <div class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mb-3">
                    <i class="ti ti-plus text-2xl text-gray-400"></i>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-3 text-center">Connect to additional Discord servers</p>
                <button class="px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400" data-action="add-guild">
                    <i class="ti ti-plus mr-1"></i>Add Guild
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Configuration & Activity -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Bot Configuration -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-tool mr-2 text-green-500"></i>Bot Configuration
            </h5>
        </div>
        <div class="p-5">
            <form id="botConfigForm">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="botPrefix" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Bot Prefix</label>
                        <input type="text" id="botPrefix" value="!" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div>
                        <label for="defaultRole" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Default Role</label>
                        <select id="defaultRole" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">None</option>
                            <option value="member">Member</option>
                            <option value="player">Player</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="activityType" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Activity Type</label>
                        <select id="activityType" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="playing">Playing</option>
                            <option value="listening">Listening to</option>
                            <option value="watching">Watching</option>
                        </select>
                    </div>
                    <div>
                        <label for="activityText" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Activity Text</label>
                        <input type="text" id="activityText" value="ECS FC League" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                </div>

                <div class="space-y-3 mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="autoModeration" checked class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                        <span class="ml-2 text-sm text-gray-900 dark:text-gray-300">Enable Auto Moderation</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="commandLogging" checked class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                        <span class="ml-2 text-sm text-gray-900 dark:text-gray-300">Log All Commands</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="welcomeMessages" checked class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                        <span class="ml-2 text-sm text-gray-900 dark:text-gray-300">Send Welcome Messages</span>
                    </label>
                </div>

                <div class="flex gap-2">
                    <button type="button" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700" data-action="save-bot-config">
                        <i class="ti ti-device-floppy mr-1"></i>Save
                    </button>
                    <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600" data-action="reset-bot-config">
                        <i class="ti ti-refresh mr-1"></i>Reset
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-activity mr-2 text-red-500"></i>Recent Activity
            </h5>
        </div>
        <div class="p-5">
            {% if recent_logs %}
            <div class="space-y-4">
                {% for log in recent_logs[-5:] %}
                <div class="flex items-start">
                    <div class="w-2 h-2 rounded-full mt-2 mr-3 {{ 'bg-red-500' if log.level == 'ERROR' else 'bg-yellow-500' if log.level == 'WARNING' else 'bg-blue-500' if log.level == 'INFO' else 'bg-gray-400' }}"></div>
                    <div>
                        <h6 class="font-medium text-gray-900 dark:text-white">{{ log.message | truncate(50) }}</h6>
                        <p class="text-sm text-gray-500 dark:text-gray-400">{{ log.level }} - {{ log.message }}</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500">{% if log.timestamp is string %}{{ log.timestamp[:16] | replace('T', ' ') }}{% elif log.timestamp %}{{ log.timestamp.strftime('%Y-%m-%d %H:%M') }}{% else %}Unknown time{% endif %}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="ti ti-activity text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
                <h6 class="text-gray-500 dark:text-gray-400">No Recent Activity</h6>
                <p class="text-sm text-gray-400 dark:text-gray-500">Bot API not connected or no recent logs available</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Status Alert -->
<div class="p-4 rounded-lg {{ 'bg-green-50 dark:bg-green-900/30' if stats.bot_status == 'online' else 'bg-red-50 dark:bg-red-900/30' }}">
    <div class="flex items-center">
        <i class="ti ti-{{ 'check-circle text-green-600 dark:text-green-400' if stats.bot_status == 'online' else 'alert-circle text-red-600 dark:text-red-400' }} text-xl mr-3"></i>
        <div class="{{ 'text-green-700 dark:text-green-300' if stats.bot_status == 'online' else 'text-red-700 dark:text-red-300' }}">
            <strong>Bot Status:</strong>
            {% if stats.bot_status == 'online' %}
            Discord bot is online and responding to commands normally.
            {% else %}
            Discord bot appears to be offline. Please check the bot configuration and network connectivity.
            {% endif %}
        </div>
    </div>
</div>

</div><!-- /data-page -->
{% endblock %}

{% block extra_js %}
<script>
window.__BOT_API_URL__ = {{ url_for('admin_panel.bot_api_proxy', path='') | tojson }};
window.__BOT_RECENT_LOGS__ = {{ recent_logs | tojson }};
window.__BOT_COMMANDS__ = {{ commands | tojson }};
window.__BOT_COMMAND_USAGE__ = {{ command_usage | tojson }};
window.__BOT_GUILD_INFO__ = {{ guild_info | tojson }};
window.__BOT_ONLINE__ = {{ bot_online | tojson }};
window.__DISCORD_CLIENT_ID__ = {{ (discord_client_id or '') | tojson }};
</script>
{% endblock %}
