{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert, modal, empty_state %}

{% block admin_title %}Substitute Management{% endblock %}
{% block panel_description %}Manage substitute requests and availability{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.match_operations') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">Match Operations</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Substitute Management</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Header Section -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-6 mb-6">
    <div class="flex items-start gap-4">
        <div class="p-3 bg-ecs-green/10 rounded-lg">
            <i class="ti ti-users text-3xl text-ecs-green"></i>
        </div>
        <div>
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Substitute Management Dashboard</h2>
            <p class="text-gray-500 dark:text-gray-400 mt-1">Manage substitute requests, assign available subs to matches, and track substitute availability for upcoming games.</p>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-5">
        <div class="flex items-center gap-4">
            <div class="p-3 bg-ecs-green/10 rounded-lg">
                <i class="ti ti-clipboard-list text-2xl text-ecs-green"></i>
            </div>
            <div>
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-medium">Total Requests</p>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.total_requests }}</p>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-5">
        <div class="flex items-center gap-4">
            <div class="p-3 bg-yellow-500/10 rounded-lg">
                <i class="ti ti-clock text-2xl text-yellow-500"></i>
            </div>
            <div>
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-medium">Active Requests</p>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.active_requests }}</p>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-5">
        <div class="flex items-center gap-4">
            <div class="p-3 bg-green-500/10 rounded-lg">
                <i class="ti ti-user-check text-2xl text-green-500"></i>
            </div>
            <div>
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-medium">Available Subs</p>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.available_subs }}</p>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-5">
        <div class="flex items-center gap-4">
            <div class="p-3 bg-blue-500/10 rounded-lg">
                <i class="ti ti-calendar text-2xl text-blue-500"></i>
            </div>
            <div>
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-medium">Upcoming Matches</p>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.upcoming_matches }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
{% call card(title="Filters") %}
<form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div>
        <label for="show_requested" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Show Matches</label>
        <select name="show_requested" id="show_requested"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="all" {% if show_requested == 'all' %}selected{% endif %}>All Matches</option>
            <option value="requested" {% if show_requested == 'requested' %}selected{% endif %}>With Sub Requests</option>
            <option value="not_requested" {% if show_requested == 'not_requested' %}selected{% endif %}>Without Sub Requests</option>
        </select>
    </div>

    <div>
        <label for="week" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Week</label>
        <select name="week" id="week"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="">All Weeks</option>
            {% for week in weeks %}
            <option value="{{ week }}" {% if current_week == week %}selected{% endif %}>Week {{ week }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="flex items-end gap-2 md:col-span-2">
        <button type="submit"
                class="text-white bg-ecs-green hover:bg-ecs-green-700 focus:ring-4 focus:ring-ecs-green/50 font-medium rounded-lg text-sm px-5 py-2.5">
            <i class="ti ti-search mr-1"></i>Filter
        </button>
        <a href="{{ url_for('admin_panel.substitute_management') }}"
           class="text-gray-700 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600">
            <i class="ti ti-x mr-1"></i>Clear
        </a>
    </div>
</form>
{% endcall %}

<!-- Active Substitute Requests -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 mt-6">
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
            <i class="ti ti-alert-circle text-yellow-500"></i>Active Substitute Requests
        </h3>
    </div>
    <div class="p-6">
        {% if sub_requests %}
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            {% for request in sub_requests %}
            {% if request.status in ['PENDING', 'APPROVED'] %}
            <div class="bg-white dark:bg-gray-800 rounded-lg border-l-4 border-yellow-500 shadow-md p-4">
                <div class="flex justify-between items-start mb-3">
                    <h4 class="font-semibold text-gray-900 dark:text-white">{{ request.match.home_team.name }} vs {{ request.match.away_team.name }}</h4>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">{{ request.status }}</span>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400 mb-2">
                    <p class="flex items-center gap-1">
                        <i class="ti ti-calendar"></i>{{ request.match.date.strftime('%m/%d/%Y') if request.match.date }}
                        {% if request.match.time %}
                        <i class="ti ti-clock ml-2"></i>{{ request.match.time.strftime('%I:%M %p') }}
                        {% endif %}
                    </p>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-300 mb-3">
                    <p><strong>Team:</strong> {{ request.team.name }}</p>
                    <p><strong>Needed:</strong> {{ request.substitutes_needed }} substitute(s)</p>
                    {% if request.notes %}
                    <p><strong>Notes:</strong> {{ request.notes[:50] }}{% if request.notes|length > 50 %}...{% endif %}</p>
                    {% endif %}
                </div>
                <div class="flex justify-between items-center pt-3 border-t border-gray-200 dark:border-gray-700">
                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ request.assignments_count or 0 }}/{{ request.substitutes_needed }} assigned</span>
                    <div class="flex gap-1">
                        <button class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg dark:text-blue-400 dark:hover:bg-blue-900/50"
                                data-action="show-contact-subs" data-request-id="{{ request.id }}" data-league="{{ request.team.league.name if request.team.league else 'Premier' }}" title="Contact Subs">
                            <i class="ti ti-send"></i>
                        </button>
                        <button class="p-2 text-green-600 hover:bg-green-100 rounded-lg dark:text-green-400 dark:hover:bg-green-900/50"
                                data-action="show-availability" data-request-id="{{ request.id }}" title="View Availability">
                            <i class="ti ti-list-check"></i>
                        </button>
                        <button class="px-3 py-1.5 text-white bg-ecs-green hover:bg-ecs-green-700 rounded-lg text-sm"
                                data-action="show-sub-assignment" data-request-id="{{ request.id }}" data-match-id="{{ request.match.id }}" data-team-id="{{ request.team.id }}">
                            <i class="ti ti-plus mr-1"></i>Assign
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <i class="ti ti-clipboard-list text-gray-300 dark:text-gray-600 text-6xl"></i>
            <h4 class="text-lg font-medium text-gray-500 dark:text-gray-400 mt-4">No active substitute requests</h4>
            <p class="text-gray-400 dark:text-gray-500 mt-2">All substitute requests have been fulfilled or there are no pending requests.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Upcoming Matches -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 mt-6">
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
            <i class="ti ti-calendar text-gray-400"></i>Upcoming Matches
        </h3>
    </div>
    <div class="p-6">
        {% if upcoming_matches %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                    <tr>
                        <th scope="col" class="px-6 py-3">Date</th>
                        <th scope="col" class="px-6 py-3">Match</th>
                        <th scope="col" class="px-6 py-3">Sub Requests</th>
                        <th scope="col" class="px-6 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for match in upcoming_matches %}
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4">
                            <span class="text-gray-900 dark:text-white">{{ match.date.strftime('%m/%d') if match.date else 'TBD' }}</span><br>
                            <span class="text-xs text-gray-500 dark:text-gray-400">{{ match.time.strftime('%I:%M %p') if match.time else '' }}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="font-medium text-gray-900 dark:text-white">{{ match.home_team.name }}</span><br>
                            <span class="text-xs text-gray-500 dark:text-gray-400">vs</span><br>
                            <span class="font-medium text-gray-900 dark:text-white">{{ match.away_team.name }}</span>
                        </td>
                        <td class="px-6 py-4">
                            {% set match_requests = requested_teams_by_match.get(match.id, {}) %}
                            {% if match_requests %}
                            {% for team_id, request in match_requests.items() %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300 mr-1">
                                {{ request.team.name }}: {{ request.assignments_count or 0 }}/{{ request.substitutes_needed }}
                            </span>
                            {% endfor %}
                            {% else %}
                            <span class="text-gray-400 dark:text-gray-500">No requests</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <button class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-ecs-green border border-ecs-green rounded-lg hover:bg-ecs-green hover:text-white transition-colors"
                                    data-action="show-sub-assignment" data-match-id="{{ match.id }}">
                                <i class="ti ti-plus mr-1"></i>Quick Assign
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-12">
            <i class="ti ti-calendar text-gray-300 dark:text-gray-600 text-6xl"></i>
            <h4 class="text-lg font-medium text-gray-500 dark:text-gray-400 mt-4">No upcoming matches</h4>
            <p class="text-gray-400 dark:text-gray-500 mt-2">No matches found for the selected criteria.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Sub Assignment Modal -->
<div id="subAssignmentModal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="fixed inset-0 bg-gray-500/75 dark:bg-gray-900/75" data-modal-backdrop></div>
        <div class="relative w-full max-w-md transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 shadow-xl transition-all">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Assign Substitute</h3>
                <button type="button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-500 dark:hover:text-gray-300" onclick="closeModal('subAssignmentModal')">
                    <i class="ti ti-x text-xl"></i>
                </button>
            </div>
            <form id="subAssignmentForm" method="POST" action="{{ url_for('admin_panel.assign_substitute') }}">
                <div class="p-6 space-y-4">
                    <input type="hidden" name="match_id" id="assignMatchId">
                    <input type="hidden" name="team_id" id="assignTeamId">
                    <input type="hidden" name="request_id" id="assignRequestId">

                    <div>
                        <label for="assignPlayerId" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Available Substitutes</label>
                        <select name="player_id" id="assignPlayerId" required
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">Select a substitute...</option>
                            {% for sub in available_subs %}
                            <option value="{{ sub.id }}">{{ sub.name }}{% if sub.positions %} - {{ sub.positions }}{% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="position_assigned" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Position Assigned</label>
                        <input type="text" name="position_assigned" id="position_assigned" placeholder="e.g., Midfielder"
                               class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>

                    <div>
                        <label for="notes" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Notes (optional)</label>
                        <textarea name="notes" id="notes" rows="2" placeholder="Any additional notes..."
                                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
                    </div>

                    <div class="flex items-center">
                        <input id="sendConfirmation" name="send_confirmation" type="checkbox" value="true" checked
                               class="w-4 h-4 text-ecs-green bg-gray-100 border-gray-300 rounded focus:ring-ecs-green dark:focus:ring-ecs-green dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                        <label for="sendConfirmation" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Send confirmation notification to sub</label>
                    </div>
                </div>
                <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('subAssignmentModal')"
                            class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 text-white bg-ecs-green rounded-lg hover:bg-ecs-green-700">
                        <i class="ti ti-check mr-1"></i>Assign Substitute
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
window.SUB_MANAGEMENT_CONFIG = {
    composeMessageUrl: '/admin-panel/substitute-contact/compose-message',
    availableSubsUrl: '/admin-panel/substitute-contact/available-subs',
    notifyPoolUrl: '/admin-panel/substitute-contact/notify-pool',
    availabilityUrl: '/admin-panel/substitute-contact'
};

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Handle sub assignment buttons
    document.querySelectorAll('[data-action="show-sub-assignment"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const matchId = this.dataset.matchId;
            const teamId = this.dataset.teamId;
            const requestId = this.dataset.requestId;

            document.getElementById('assignMatchId').value = matchId || '';
            document.getElementById('assignTeamId').value = teamId || '';
            document.getElementById('assignRequestId').value = requestId || '';

            openModal('subAssignmentModal');
        });
    });

    // Close modal on backdrop click
    document.querySelectorAll('[data-modal-backdrop]').forEach(backdrop => {
        backdrop.addEventListener('click', function() {
            this.closest('[id$="Modal"]').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        });
    });

    // Form validation
    const subAssignmentForm = document.getElementById('subAssignmentForm');
    if (subAssignmentForm) {
        subAssignmentForm.addEventListener('submit', function(e) {
            const playerId = document.getElementById('assignPlayerId').value;
            const matchId = document.getElementById('assignMatchId').value;

            if (!playerId || !matchId) {
                e.preventDefault();
                const isDark = document.documentElement.classList.contains('dark');
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Please select a substitute and ensure a match is selected.',
                    background: isDark ? '#1f2937' : '#ffffff',
                    color: isDark ? '#f3f4f6' : '#111827'
                });
                return false;
            }
        });
    }
});

// Auto-refresh every 2 minutes
setTimeout(() => location.reload(), 120000);
</script>
{% endblock %}
