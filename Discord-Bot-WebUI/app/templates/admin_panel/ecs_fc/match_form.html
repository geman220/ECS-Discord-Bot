{% extends "admin_panel/base.html" %}

{% block title %}{% if match %}Edit Match{% else %}Create Match{% endif %} - ECS FC{% endblock %}

{% block panel_description %}{% if match %}Edit existing match{% else %}Create a new ECS FC match{% endif %}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_panel.ecs_fc_dashboard') }}">ECS FC Hub</a></li>
<li class="breadcrumb-item active">{% if match %}Edit Match{% else %}Create Match{% endif %}</li>
{% endblock %}

{% block panel_content %}
<div class="row">
    <div class="col-12">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="mb-0">
                    <i class="ti ti-{% if match %}edit{% else %}plus{% endif %} me-2"></i>
                    {% if match %}Edit Match{% else %}Create New Match{% endif %}
                </h5>
            </div>
            <div class="c-card__body">
                <form method="post" id="matchForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-lg-6">
                            <!-- Team Selection -->
                            <div class="mb-4">
                                <label for="team_id" class="c-form-label">Team <span class="text-danger">*</span></label>
                                <select name="team_id" id="team_id" class="c-form-control" required {% if match %}disabled{% endif %}>
                                    <option value="">Select Team...</option>
                                    {% for team in teams %}
                                    <option value="{{ team.id }}"
                                            {% if (match and match.team_id == team.id) or (preselect_team_id == team.id) %}selected{% endif %}>
                                        {{ team.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if match %}
                                <input type="hidden" name="team_id" value="{{ match.team_id }}">
                                {% endif %}
                            </div>

                            <!-- Opponent Selection -->
                            <div class="mb-4">
                                <label class="c-form-label">Opponent <span class="text-danger">*</span></label>
                                <div class="btn-group w-100 mb-3" role="group">
                                    <input type="radio" class="btn-check" name="opponent_source" id="oppLibrary"
                                           value="library" {% if not match or match.external_opponent_id %}checked{% endif %}
                                           data-action="toggle-opponent-source" data-source="library">
                                    <label class="c-btn c-btn--outline-primary" for="oppLibrary">
                                        <i class="ti ti-books me-1"></i>From Library
                                    </label>

                                    <input type="radio" class="btn-check" name="opponent_source" id="oppCustom"
                                           value="custom" {% if match and not match.external_opponent_id %}checked{% endif %}
                                           data-action="toggle-opponent-source" data-source="custom">
                                    <label class="c-btn c-btn--outline-primary" for="oppCustom">
                                        <i class="ti ti-pencil me-1"></i>Custom Entry
                                    </label>
                                </div>

                                <!-- Library dropdown -->
                                <div id="librarySelect" {% if match and not match.external_opponent_id %}style="display: none;"{% endif %}>
                                    <div class="input-group">
                                        <select name="external_opponent_id" id="external_opponent_id" class="c-form-control">
                                            <option value="">Select Opponent...</option>
                                            {% for opp in opponents %}
                                            <option value="{{ opp.id }}"
                                                    {% if match and match.external_opponent_id == opp.id %}selected{% endif %}>
                                                {{ opp.name }}{% if opp.league_affiliation %} ({{ opp.league_affiliation }}){% endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <a href="{{ url_for('admin_panel.ecs_fc_opponents') }}" class="c-btn c-btn--outline-secondary" target="_blank" title="Add new opponent"><i class="ti ti-plus"></i></a>
                                    </div>
                                </div>

                                <!-- Custom input -->
                                <div id="customInput" {% if not match or match.external_opponent_id %}style="display: none;"{% endif %}>
                                    <input type="text" name="opponent_name" id="opponent_name" class="c-form-control"
                                           placeholder="Enter opponent team name (e.g., Seattle United O50)"
                                           value="{% if match and not match.external_opponent_id %}{{ match.opponent_name }}{% endif %}">
                                    <small class="text-muted">Enter the full name of the opposing team</small>
                                </div>
                            </div>

                            <!-- Date and Time -->
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <label for="match_date" class="c-form-label">Date <span class="text-danger">*</span></label>
                                    <input type="date" name="match_date" id="match_date" class="c-form-control" required
                                           value="{% if match %}{{ match.match_date.strftime('%Y-%m-%d') }}{% endif %}">
                                </div>
                                <div class="col-md-6 mb-4">
                                    <label for="match_time" class="c-form-label">Time <span class="text-danger">*</span></label>
                                    <input type="time" name="match_time" id="match_time" class="c-form-control" required
                                           value="{% if match %}{{ match.match_time.strftime('%H:%M') }}{% else %}19:00{% endif %}">
                                </div>
                            </div>

                            <!-- Location and Field -->
                            <div class="row">
                                <div class="col-md-8 mb-4">
                                    <label for="location" class="c-form-label">Location <span class="text-danger">*</span></label>
                                    <input type="text" name="location" id="location" class="c-form-control" required
                                           placeholder="e.g., Memorial Stadium"
                                           value="{% if match %}{{ match.location }}{% endif %}">
                                </div>
                                <div class="col-md-4 mb-4">
                                    <label for="field_name" class="c-form-label">Field Name</label>
                                    <input type="text" name="field_name" id="field_name" class="c-form-control"
                                           placeholder="e.g., Field A"
                                           value="{% if match %}{{ match.field_name }}{% endif %}">
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-lg-6">
                            <!-- Home/Away and RSVP Deadline -->
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <label class="c-form-label">Home/Away <span class="text-danger">*</span></label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="is_home_match" id="isHome"
                                               value="true" {% if not match or match.is_home_match %}checked{% endif %}>
                                        <label class="c-btn c-btn--outline-success" for="isHome">
                                            <i class="ti ti-home me-1"></i>Home
                                        </label>

                                        <input type="radio" class="btn-check" name="is_home_match" id="isAway"
                                               value="false" {% if match and not match.is_home_match %}checked{% endif %}>
                                        <label class="c-btn c-btn--outline-secondary" for="isAway">
                                            <i class="ti ti-map-pin me-1"></i>Away
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <label for="rsvp_deadline" class="c-form-label">RSVP Deadline</label>
                                    <input type="datetime-local" name="rsvp_deadline" id="rsvp_deadline" class="c-form-control"
                                           value="{% if match and match.rsvp_deadline %}{{ match.rsvp_deadline.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
                                </div>
                            </div>

                            {% if match %}
                            <!-- Status (edit only) -->
                            <div class="mb-4">
                                <label for="status" class="c-form-label">Status</label>
                                <select name="status" id="status" class="c-form-control">
                                    <option value="SCHEDULED" {% if match.status == 'SCHEDULED' %}selected{% endif %}>Scheduled</option>
                                    <option value="IN_PROGRESS" {% if match.status == 'IN_PROGRESS' %}selected{% endif %}>In Progress</option>
                                    <option value="COMPLETED" {% if match.status == 'COMPLETED' %}selected{% endif %}>Completed</option>
                                    <option value="CANCELLED" {% if match.status == 'CANCELLED' %}selected{% endif %}>Cancelled</option>
                                    <option value="POSTPONED" {% if match.status == 'POSTPONED' %}selected{% endif %}>Postponed</option>
                                </select>
                            </div>
                            {% endif %}

                            <!-- Notes -->
                            <div class="mb-4">
                                <label for="notes" class="c-form-label">Notes</label>
                                <textarea name="notes" id="notes" class="c-form-control" rows="3"
                                          placeholder="Any additional notes...">{% if match %}{{ match.notes }}{% endif %}</textarea>
                            </div>

                            {% if not match %}
                            <!-- RSVP Scheduling Options (create only) -->
                            <div class="c-card mb-4" style="background: var(--bs-body-bg);">
                                <div class="c-card__body">
                                    <h6 class="mb-3"><i class="ti ti-calendar-event me-2"></i>RSVP Scheduling</h6>
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="schedule_rsvp" name="schedule_rsvp" checked>
                                        <label class="form-check-label" for="schedule_rsvp">
                                            <i class="ti ti-bell-ringing me-1"></i>Schedule RSVP Request
                                        </label>
                                    </div>
                                    <div class="alert alert-info py-2 px-3 mb-0">
                                        <small>
                                            <i class="ti ti-info-circle me-1"></i>
                                            <strong>How it works:</strong> RSVP request will be posted to the team's Discord channel
                                            on <strong>Monday at 9:00 AM</strong> the week before the match.
                                            If the match is less than 7 days away, the RSVP will be posted immediately.
                                            Players can respond with emoji reactions: ✅ Yes, ❌ No, ❓ Maybe.
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="d-flex justify-content-between mt-3">
                        <a href="{{ url_for('admin_panel.ecs_fc_dashboard') }}" class="c-btn c-btn--outline-secondary">
                            <i class="ti ti-arrow-left me-1"></i>Cancel
                        </a>
                        <button type="submit" class="c-btn c-btn--primary">
                            <i class="ti ti-{% if match %}check{% else %}plus{% endif %} me-1"></i>
                            {% if match %}Save Changes{% else %}Create Match{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {% if not match %}
        <!-- Quick Schedule Templates -->
        <div class="c-card mt-4">
            <div class="c-card__header">
                <h6 class="mb-0">
                    <i class="ti ti-template me-2"></i>Quick Schedule Templates
                </h6>
            </div>
            <div class="c-card__body">
                <p class="text-muted small mb-3">Click a template to auto-fill date and time fields</p>
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <button type="button" class="c-btn c-btn--outline-info w-100" data-action="apply-match-template" data-template="weekend">
                            <i class="ti ti-calendar-event me-1"></i>Weekend Match
                            <small class="d-block text-muted">Next Saturday, 3:00 PM</small>
                        </button>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button type="button" class="c-btn c-btn--outline-info w-100" data-action="apply-match-template" data-template="midweek">
                            <i class="ti ti-calendar me-1"></i>Midweek Match
                            <small class="d-block text-muted">Next Wednesday, 7:30 PM</small>
                        </button>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button type="button" class="c-btn c-btn--outline-info w-100" data-action="apply-match-template" data-template="sunday">
                            <i class="ti ti-sun me-1"></i>Sunday Match
                            <small class="d-block text-muted">Next Sunday, 2:00 PM</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

