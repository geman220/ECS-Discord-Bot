{% extends "admin_panel/base.html" %}

{% block title %}Discord Bot Management - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">Discord Bot Management</li>
{% endblock %}

{% block panel_content %}
<div class="c-bot-mgmt" data-component="bot-management">
    <!-- Bot Status Cards -->
    <div class="c-bot-status" data-component="status-overview">
        <div class="c-bot-status__grid">
            <div class="c-stat-card c-stat-card--{% if stats.bot_status == 'online' %}success{% else %}danger{% endif %}"
                 data-stat-card
                 data-stat-type="bot-status">
                <div class="c-stat-card__content">
                    <div class="c-stat-card__value">{{ stats.bot_status.title() }}</div>
                    <div class="c-stat-card__label">Bot Status</div>
                </div>
                <div class="c-stat-card__icon">
                    <i class="ti ti-brand-discord"></i>
                </div>
            </div>

            <div class="c-stat-card c-stat-card--info" data-stat-card data-stat-type="guilds">
                <div class="c-stat-card__content">
                    <div class="c-stat-card__value">{{ stats.guilds_connected or 0 }}</div>
                    <div class="c-stat-card__label">Connected Guilds</div>
                </div>
                <div class="c-stat-card__icon">
                    <i class="ti ti-server"></i>
                </div>
            </div>

            <div class="c-stat-card c-stat-card--primary" data-stat-card data-stat-type="commands">
                <div class="c-stat-card__content">
                    <div class="c-stat-card__value">{{ stats.commands_today or 0 }}</div>
                    <div class="c-stat-card__label">Commands Today</div>
                </div>
                <div class="c-stat-card__icon">
                    <i class="ti ti-command"></i>
                </div>
            </div>

            <div class="c-stat-card c-stat-card--warning" data-stat-card data-stat-type="uptime">
                <div class="c-stat-card__content">
                    <div class="c-stat-card__value">{{ stats.uptime or '0%' }}</div>
                    <div class="c-stat-card__label">Uptime</div>
                </div>
                <div class="c-stat-card__icon">
                    <i class="ti ti-clock"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot Management Sections -->
    <div class="c-bot-sections" data-component="management-sections">
        <div class="c-bot-sections__grid">
            <!-- Bot Control -->
            <div class="c-card" data-card data-section="control">
                <div class="c-card__header">
                    <div class="c-card__title">
                        <i class="ti ti-settings c-card__title-icon c-card__title-icon--warning"></i>
                        <span>Bot Control</span>
                    </div>
                    <div class="c-status-indicator {% if stats.bot_status == 'online' %}c-status-indicator--active{% else %}c-status-indicator--inactive{% endif %}"
                         data-status-indicator></div>
                </div>
                <div class="c-card__body">
                    <p class="c-card__description">Control bot operations and manage its status</p>
                    <nav class="c-link-list" aria-label="Bot control options">
                        <button class="c-link-list__item"
                                type="button"
                                data-action="restart-bot"
                                aria-label="Restart Discord bot">
                            <div class="c-link-list__content">
                                <div class="c-link-list__icon">
                                    <i class="ti ti-refresh"></i>
                                </div>
                                <div class="c-link-list__text">
                                    <div class="c-link-list__title">Restart Bot</div>
                                </div>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </button>

                        <button class="c-link-list__item"
                                type="button"
                                data-action="check-bot-health"
                                aria-label="Check bot health status">
                            <div class="c-link-list__content">
                                <div class="c-link-list__icon">
                                    <i class="ti ti-heart"></i>
                                </div>
                                <div class="c-link-list__text">
                                    <div class="c-link-list__title">Health Check</div>
                                </div>
                            </div>
                            <div class="c-link-list__meta">
                                <span class="c-status-indicator {% if stats.bot_status == 'online' %}c-status-indicator--active{% else %}c-status-indicator--inactive{% endif %}"></span>
                            </div>
                        </button>

                        <button class="c-link-list__item"
                                type="button"
                                data-action="view-bot-logs"
                                aria-label="View bot logs">
                            <div class="c-link-list__content">
                                <div class="c-link-list__icon">
                                    <i class="ti ti-file-text"></i>
                                </div>
                                <div class="c-link-list__text">
                                    <div class="c-link-list__title">View Bot Logs</div>
                                </div>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </button>

                        <button class="c-link-list__item"
                                type="button"
                                data-action="sync-commands"
                                aria-label="Sync bot commands with Discord">
                            <div class="c-link-list__content">
                                <div class="c-link-list__icon">
                                    <i class="ti ti-refresh"></i>
                                </div>
                                <div class="c-link-list__text">
                                    <div class="c-link-list__title">Sync Commands</div>
                                </div>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Command Management -->
            <div class="c-card" data-card data-section="commands">
                <div class="c-card__header">
                    <div class="c-card__title">
                        <i class="ti ti-command c-card__title-icon c-card__title-icon--primary"></i>
                        <span>Command Management</span>
                    </div>
                </div>
                <div class="c-card__body">
                    <p class="c-card__description">Manage bot commands and their permissions</p>
                    <nav class="c-link-list" aria-label="Command management options">
                        <button class="c-link-list__item"
                                type="button"
                                data-action="view-commands"
                                aria-label="View all bot commands">
                            <div class="c-link-list__content">
                                <div class="c-link-list__icon">
                                    <i class="ti ti-list"></i>
                                </div>
                                <div class="c-link-list__text">
                                    <div class="c-link-list__title">View All Commands</div>
                                </div>
                            </div>
                            <div class="c-link-list__meta">
                                <span class="c-badge c-badge--primary" data-badge>{{ stats.total_commands or 0 }}</span>
                            </div>
                        </button>

                        <button class="c-link-list__item"
                                type="button"
                                data-action="command-permissions"
                                aria-label="Manage command permissions">
                            <div class="c-link-list__content">
                                <div class="c-link-list__icon">
                                    <i class="ti ti-shield"></i>
                                </div>
                                <div class="c-link-list__text">
                                    <div class="c-link-list__title">Command Permissions</div>
                                </div>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </button>

                        <button class="c-link-list__item"
                                type="button"
                                data-action="command-usage"
                                aria-label="View command usage statistics">
                            <div class="c-link-list__content">
                                <div class="c-link-list__icon">
                                    <i class="ti ti-chart-bar"></i>
                                </div>
                                <div class="c-link-list__text">
                                    <div class="c-link-list__title">Usage Statistics</div>
                                </div>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </button>

                        <button class="c-link-list__item"
                                type="button"
                                data-action="custom-commands"
                                aria-label="Manage custom commands">
                            <div class="c-link-list__content">
                                <div class="c-link-list__icon">
                                    <i class="ti ti-edit"></i>
                                </div>
                                <div class="c-link-list__text">
                                    <div class="c-link-list__title">Custom Commands</div>
                                </div>
                            </div>
                            <div class="c-link-list__meta">
                                <i class="ti ti-chevron-right c-link-list__arrow"></i>
                            </div>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Guild Management -->
    <div class="c-bot-guild" data-component="guild-management">
        <div class="c-card" data-card>
            <div class="c-card__header">
                <div class="c-card__title">
                    <i class="ti ti-server c-card__title-icon c-card__title-icon--info"></i>
                    <span>Connected Guilds</span>
                </div>
            </div>
            <div class="c-card__body">
                <div class="c-bot-guild__grid">
                    <div class="c-guild-card" data-guild-card>
                        <div class="c-guild-card__header">
                            <h6 class="c-guild-card__name">{{ guild_info.name or 'ECS FC Discord' }}</h6>
                            <span class="c-badge c-badge--{% if stats.bot_status == 'online' %}success{% else %}danger{% endif %}"
                                  data-badge>
                                {{ stats.bot_status.title() }}
                            </span>
                        </div>
                        <div class="c-guild-card__stats">
                            <div class="c-guild-stat" data-guild-stat>
                                <div class="c-guild-stat__value">{{ guild_info.member_count or stats.member_count or 0 }}</div>
                                <div class="c-guild-stat__label">Members</div>
                            </div>
                            <div class="c-guild-stat" data-guild-stat>
                                <div class="c-guild-stat__value">{{ guild_info.channel_count or 45 }}</div>
                                <div class="c-guild-stat__label">Channels</div>
                            </div>
                            <div class="c-guild-stat" data-guild-stat>
                                <div class="c-guild-stat__value">{{ guild_info.role_count or 25 }}</div>
                                <div class="c-guild-stat__label">Roles</div>
                            </div>
                        </div>
                        <div class="c-guild-card__actions">
                            <button class="c-btn c-btn--sm c-btn--outline-primary"
                                    type="button"
                                    data-action="manage-guild"
                                    data-guild="main"
                                    aria-label="Manage guild settings">
                                <i class="ti ti-settings"></i>
                                <span>Manage</span>
                            </button>
                            <button class="c-btn c-btn--sm c-btn--outline-info"
                                    type="button"
                                    data-action="guild-stats"
                                    data-guild="main"
                                    aria-label="View guild statistics">
                                <i class="ti ti-chart-dots"></i>
                                <span>Stats</span>
                            </button>
                        </div>
                    </div>

                    <div class="c-guild-add" data-guild-add>
                        <div class="c-guild-add__icon">
                            <i class="ti ti-plus"></i>
                        </div>
                        <p class="c-guild-add__text">Connect to additional Discord servers</p>
                        <button class="c-btn c-btn--outline-primary"
                                type="button"
                                data-action="add-guild"
                                aria-label="Add new guild">
                            <i class="ti ti-plus"></i>
                            <span>Add Guild</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot Configuration & Recent Activity -->
    <div class="c-bot-details" data-component="bot-details">
        <div class="c-bot-details__grid">
            <!-- Bot Configuration -->
            <div class="c-card" data-card data-section="config">
                <div class="c-card__header">
                    <div class="c-card__title">
                        <i class="ti ti-tool c-card__title-icon c-card__title-icon--success"></i>
                        <span>Bot Configuration</span>
                    </div>
                </div>
                <div class="c-card__body">
                    <form class="c-bot-config" data-config-form>
                        <div class="c-bot-config__group">
                            <label class="c-bot-config__label" for="botPrefix">Bot Prefix</label>
                            <input type="text"
                                   class="c-bot-config__input"
                                   value="!"
                                   id="botPrefix"
                                   data-config-input="prefix"
                                   aria-label="Bot command prefix">
                        </div>

                        <div class="c-bot-config__group">
                            <label class="c-bot-config__label" for="defaultRole">Default Role</label>
                            <select class="c-bot-config__select"
                                    id="defaultRole"
                                    data-config-select="role"
                                    aria-label="Default member role">
                                <option value="">None</option>
                                <option value="member">Member</option>
                                <option value="player">Player</option>
                            </select>
                        </div>

                        <div class="c-bot-config__group">
                            <label class="c-bot-config__label" for="activityType">Activity Type</label>
                            <select class="c-bot-config__select"
                                    id="activityType"
                                    data-config-select="activity"
                                    aria-label="Bot activity type">
                                <option value="playing">Playing</option>
                                <option value="listening">Listening to</option>
                                <option value="watching">Watching</option>
                            </select>
                        </div>

                        <div class="c-bot-config__group">
                            <label class="c-bot-config__label" for="activityText">Activity Text</label>
                            <input type="text"
                                   class="c-bot-config__input"
                                   value="ECS FC League"
                                   id="activityText"
                                   data-config-input="activity-text"
                                   aria-label="Bot activity text">
                        </div>

                        <div class="c-bot-config__toggles">
                            <div class="c-bot-config__toggle" data-config-toggle>
                                <input class="c-bot-config__checkbox"
                                       type="checkbox"
                                       id="autoModeration"
                                       checked
                                       aria-label="Enable auto moderation">
                                <label class="c-bot-config__toggle-label" for="autoModeration">
                                    Enable Auto Moderation
                                </label>
                            </div>

                            <div class="c-bot-config__toggle" data-config-toggle>
                                <input class="c-bot-config__checkbox"
                                       type="checkbox"
                                       id="commandLogging"
                                       checked
                                       aria-label="Enable command logging">
                                <label class="c-bot-config__toggle-label" for="commandLogging">
                                    Log All Commands
                                </label>
                            </div>

                            <div class="c-bot-config__toggle" data-config-toggle>
                                <input class="c-bot-config__checkbox"
                                       type="checkbox"
                                       id="welcomeMessages"
                                       checked
                                       aria-label="Enable welcome messages">
                                <label class="c-bot-config__toggle-label" for="welcomeMessages">
                                    Send Welcome Messages
                                </label>
                            </div>
                        </div>

                        <div class="c-bot-config__actions">
                            <button type="button"
                                    class="c-btn c-btn--primary"
                                    data-action="save-bot-config"
                                    aria-label="Save bot configuration">
                                <i class="ti ti-device-floppy"></i>
                                <span>Save Configuration</span>
                            </button>
                            <button type="button"
                                    class="c-btn c-btn--outline-secondary"
                                    data-action="reset-bot-config"
                                    aria-label="Reset to default configuration">
                                <i class="ti ti-refresh"></i>
                                <span>Reset to Defaults</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="c-card" data-card data-section="activity">
                <div class="c-card__header">
                    <div class="c-card__title">
                        <i class="ti ti-activity c-card__title-icon c-card__title-icon--danger"></i>
                        <span>Recent Activity</span>
                    </div>
                </div>
                <div class="c-card__body">
                    <div class="c-bot-timeline" data-timeline>
                        {% if recent_logs %}
                            {% for log in recent_logs[-5:] %}
                            <div class="c-bot-timeline__item" data-timeline-item>
                                <div class="c-bot-timeline__marker c-bot-timeline__marker--{% if log.level == 'ERROR' %}danger{% elif log.level == 'WARNING' %}warning{% elif log.level == 'INFO' %}info{% else %}secondary{% endif %}"
                                     data-timeline-marker></div>
                                <div class="c-bot-timeline__content">
                                    <h6 class="c-bot-timeline__title">{{ log.message | truncate(50) }}</h6>
                                    <p class="c-bot-timeline__text">{{ log.level }} - {{ log.message }}</p>
                                    <small class="c-bot-timeline__timestamp">{{ log.timestamp.strftime('%Y-%m-%d %H:%M') if log.timestamp else 'Unknown time' }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="c-empty-state" data-component="empty-state">
                                <div class="c-empty-state__icon c-empty-state__icon--secondary">
                                    <i class="ti ti-activity"></i>
                                </div>
                                <h6 class="c-empty-state__title">No Recent Activity</h6>
                                <p class="c-empty-state__description">Bot API not connected or no recent logs available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot Status Alert -->
    <div class="c-bot-alert" data-component="status-alert">
        <div class="c-alert c-alert--{% if stats.bot_status == 'online' %}success{% else %}danger{% endif %}">
            <div class="c-alert__icon">
                <i class="ti ti-{% if stats.bot_status == 'online' %}check-circle{% else %}alert-circle{% endif %}"></i>
            </div>
            <div class="c-alert__content">
                <strong>Bot Status:</strong>
                {% if stats.bot_status == 'online' %}
                    Discord bot is online and responding to commands normally.
                {% else %}
                    Discord bot appears to be offline. Please check the bot configuration and network connectivity.
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin-panel/discord-bot-management.css') }}">
{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') %}
<script src="{{ url_for('static', filename='js/admin-panel-discord-bot.js') }}"></script>
{% endif %}
{% endblock %}
