{% extends "admin_panel/base.html" %}

{% block title %}Security Dashboard - Admin Panel{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/security-dashboard.css') }}">
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_panel.health_dashboard') }}">System</a></li>
<li class="breadcrumb-item active">Security Dashboard</li>
{% endblock %}

{% block panel_content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1">
                    <i class="ti ti-shield-check me-2 text-primary"></i>Security Dashboard
                </h4>
                <p class="text-muted mb-0">Monitor security status, threats, and IP bans</p>
            </div>
            <div>
                <button id="refreshBtn" class="c-btn c-btn--outline-primary c-btn--sm me-2" data-action="refresh-stats">
                    <i class="ti ti-refresh me-1"></i>Refresh
                </button>
                <span class="badge bg-light text-dark" data-badge>
                    <i class="ti ti-clock me-1"></i>
                    Last updated: <span id="lastUpdated">{{ current_time }}</span>
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Security Features Status -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card h-100 security-feature-card {% if stats.security_features.rate_limiting %}feature-enabled{% else %}feature-warning{% endif %}">
            <div class="c-card__body">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="ti ti-shield-lock text-primary security-feature-icon"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Rate Limiting</h6>
                        <span class="badge bg-{% if stats.security_features.rate_limiting %}success{% else %}warning{% endif %}" data-badge>
                            {% if stats.security_features.rate_limiting %}Enabled{% else %}Disabled{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card h-100 security-feature-card {% if stats.security_features.csrf_protection %}feature-enabled{% else %}feature-warning{% endif %}">
            <div class="c-card__body">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="ti ti-shield-check text-info security-feature-icon"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">CSRF Protection</h6>
                        <span class="badge bg-{% if stats.security_features.csrf_protection %}success{% else %}warning{% endif %}" data-badge>
                            {% if stats.security_features.csrf_protection %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card h-100 security-feature-card {% if stats.security_features.attack_detection %}feature-enabled{% else %}feature-disabled{% endif %}">
            <div class="c-card__body">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="ti ti-eye text-warning security-feature-icon"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Attack Detection</h6>
                        <span class="badge bg-{% if stats.security_features.attack_detection %}success{% else %}danger{% endif %}" data-badge>
                            {% if stats.security_features.attack_detection %}Monitoring{% else %}Offline{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card h-100 security-feature-card {% if stats.security_features.auto_ban %}feature-enabled{% else %}feature-warning{% endif %}">
            <div class="c-card__body">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="ti ti-robot text-success security-feature-icon"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Auto-Ban System</h6>
                        <span class="badge bg-{% if stats.security_features.auto_ban %}success{% else %}warning{% endif %}" data-badge>
                            {% if stats.security_features.auto_ban %}Active ({{ stats.auto_ban_config.attack_threshold }} strikes){% else %}Disabled{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Row -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="c-card text-center security-stat-card">
            <div class="c-card__body">
                <i class="ti ti-eye text-primary security-stat-icon"></i>
                <h3 class="mb-1" id="monitoredIps">{{ stats.total_monitored_ips }}</h3>
                <p class="text-muted mb-0">Monitored IPs</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="c-card text-center security-stat-card">
            <div class="c-card__body">
                <i class="ti ti-ban text-danger security-stat-icon"></i>
                <h3 class="mb-1 text-danger" id="blacklistedIps">{{ stats.total_blacklisted_ips }}</h3>
                <p class="text-muted mb-0">Blacklisted IPs</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="c-card text-center security-stat-card">
            <div class="c-card__body">
                <i class="ti ti-alert-triangle text-warning security-stat-icon"></i>
                <h3 class="mb-1 text-warning" id="attackAttempts">{{ stats.total_attack_attempts }}</h3>
                <p class="text-muted mb-0">Attack Attempts</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="c-card text-center security-stat-card">
            <div class="c-card__body">
                <i class="ti ti-users text-info security-stat-icon"></i>
                <h3 class="mb-1" id="uniqueAttackers">{{ stats.unique_attackers }}</h3>
                <p class="text-muted mb-0">Unique Attackers</p>
            </div>
        </div>
    </div>
</div>

<!-- Auto-Ban Config and Banned IPs -->
<div class="row mb-4">
    <!-- Auto-Ban Configuration -->
    <div class="col-lg-5 mb-3">
        <div class="c-card h-100">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-robot me-2"></i>Auto-Ban Configuration
                </h5>
            </div>
            <div class="c-card__body">
                <div class="row">
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-{% if stats.auto_ban_config.enabled %}success{% else %}danger{% endif %} me-2" data-badge>
                                {% if stats.auto_ban_config.enabled %}ON{% else %}OFF{% endif %}
                            </span>
                            <span class="text-muted">Auto-Ban System</span>
                        </div>
                    </div>
                    <div class="col-6 mb-3 text-end">
                        <strong>{{ stats.auto_ban_config.attack_threshold }}</strong>
                        <small class="text-muted d-block">Attack Threshold</small>
                    </div>
                    <div class="col-6 mb-3">
                        <strong>{{ stats.auto_ban_config.rate_threshold }}</strong>
                        <small class="text-muted d-block">Rate Limit (req/hr)</small>
                    </div>
                    <div class="col-6 mb-3 text-end">
                        <strong>{{ stats.auto_ban_config.duration_hours }}h</strong>
                        <small class="text-muted d-block">Initial Ban Duration</small>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <span class="badge bg-{% if stats.auto_ban_config.escalation_enabled %}warning{% else %}secondary{% endif %} me-2" data-badge>
                                    {% if stats.auto_ban_config.escalation_enabled %}ESCALATION{% else %}FIXED{% endif %}
                                </span>
                                <span class="text-muted small">Ban escalation</span>
                            </div>
                            <div class="text-end">
                                <strong>{{ stats.auto_ban_config.max_duration_hours }}h</strong>
                                <small class="text-muted d-block">Max Ban Duration</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Banned IPs List -->
    <div class="col-lg-7 mb-3">
        <div class="c-card h-100">
            <div class="c-card__header d-flex justify-content-between align-items-center">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-ban me-2"></i>Banned IPs
                    <span class="badge bg-danger ms-2" data-badge>{{ blacklisted_ips|length }}</span>
                </h5>
                <div>
                    {% if 'Global Admin' in user_roles %}
                    <button class="c-btn c-btn--sm c-btn--outline-success me-1" data-action="show-ban-ip-modal">
                        <i class="ti ti-plus"></i> Ban IP
                    </button>
                    <button class="c-btn c-btn--sm c-btn--outline-danger" data-action="clear-all-bans">
                        <i class="ti ti-trash"></i> Clear All
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="c-card__body">
                {% if blacklisted_ips %}
                <div class="c-table-wrapper banned-ips-table-container" data-table-responsive>
                    <table class="c-table c-table--compact c-table--hoverable" data-table>
                        <thead class="c-table--light sticky-top" scope="col">
                            <tr>
                                <th scope="col">IP Address</th>
                                <th scope="col">Reason</th>
                                <th scope="col">Banned By</th>
                                <th scope="col">Expires</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ban in blacklisted_ips %}
                            <tr>
                                <td><code>{{ ban.ip }}</code></td>
                                <td>
                                    <small>{{ ban.reason[:30] }}{% if ban.reason|length > 30 %}...{% endif %}</small>
                                </td>
                                <td><small>{{ ban.banned_by }}</small></td>
                                <td>
                                    {% if ban.is_permanent %}
                                    <span class="badge bg-dark" data-badge>Permanent</span>
                                    {% else %}
                                    <small>{{ ban.expires_at.strftime('%m/%d %H:%M') if ban.expires_at else 'N/A' }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if 'Global Admin' in user_roles %}
                                    <button class="c-btn btn-xs c-btn--outline-success" data-action="unban-ip" data-ip="{{ ban.ip }}" title="Unban">
                                        <i class="ti ti-check"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="security-empty-state">
                    <i class="ti ti-shield-check security-empty-state-icon"></i>
                    <p>No IPs currently banned</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Monitored IPs -->
{% if stats.monitored_ips %}
<div class="row">
    <div class="col-12">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-eye me-2"></i>Top Monitored IPs
                </h5>
            </div>
            <div class="c-card__body">
                <div class="c-table-wrapper" data-table-responsive>
                    <table class="c-table c-table--compact" data-table>
                        <thead scope="col">
                            <tr>
                                <th scope="col">IP Address</th>
                                <th scope="col">Request Count</th>
                                <th scope="col">Attack Count</th>
                                <th scope="col">Last Seen</th>
                                <th scope="col">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ip in stats.monitored_ips %}
                            <tr>
                                <td><code>{{ ip.ip }}</code></td>
                                <td>{{ ip.request_count }}</td>
                                <td>
                                    {% if ip.attack_count > 0 %}
                                    <span class="text-danger">{{ ip.attack_count }}</span>
                                    {% else %}
                                    <span class="text-muted">0</span>
                                    {% endif %}
                                </td>
                                <td><small>{{ ip.last_seen }}</small></td>
                                <td>
                                    {% if ip.attack_count >= stats.auto_ban_config.attack_threshold %}
                                    <span class="badge bg-danger" data-badge>At Risk</span>
                                    {% elif ip.attack_count > 0 %}
                                    <span class="badge bg-warning" data-badge>Warning</span>
                                    {% else %}
                                    <span class="badge bg-success" data-badge>Normal</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Ban IP Modal -->
<div class="modal c-modal fade" id="banIpModal" tabindex="-1" data-modal aria-labelledby="banIpModalLabel">
    <div class="modal-dialog c-modal__dialog" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="banIpModalLabel">
                    <i class="ti ti-ban me-2"></i>Ban IP Address
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body>
                <div class="mb-3">
                    <label class="form-label">IP Address</label>
                    <input type="text" class="form-control" id="banIpAddress" placeholder="e.g., 192.168.1.100" data-form-control>
                </div>
                <div class="mb-3">
                    <label class="form-label">Reason</label>
                    <input type="text" class="form-control" id="banReason" placeholder="Reason for ban" data-form-control>
                </div>
                <div class="mb-3">
                    <label class="form-label">Duration (hours)</label>
                    <input type="number" class="form-control" id="banDuration" value="24" min="1" data-form-control>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="banPermanent">
                    <label class="form-check-label" for="banPermanent">Permanent ban</label>
                </div>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="button" class="c-btn c-btn--danger" data-action="ban-ip">Ban IP</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
/**
 * Security Dashboard - Admin Panel
 * CONVERTED TO EVENT DELEGATION (Phase 2.2 Sprint 3)
 * All event listeners removed, now using centralized event-delegation.js
 */

const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

// Helper function for refreshStats - used by event delegation
async function refreshStats() {
    try {
        const response = await fetch('{{ url_for("admin_panel.api_security_status") }}');
        const data = await response.json();

        if (data.success) {
            document.getElementById('monitoredIps').textContent = data.stats.total_monitored_ips;
            document.getElementById('blacklistedIps').textContent = data.stats.total_blacklisted_ips;
            document.getElementById('attackAttempts').textContent = data.stats.total_attack_attempts;
            document.getElementById('uniqueAttackers').textContent = data.stats.unique_attackers;
            document.getElementById('lastUpdated').textContent = data.stats.current_time;
        }
    } catch (error) {
        console.error('Error refreshing stats:', error);
    }
}

function showBanIpModal() {
    ModalManager.show('banIpModal');
}

async function banIp() {
    const ipAddress = document.getElementById('banIpAddress').value.trim();
    const reason = document.getElementById('banReason').value.trim();
    const durationHours = parseInt(document.getElementById('banDuration').value);
    const permanent = document.getElementById('banPermanent').checked;

    if (!ipAddress) {
        Swal.fire('Error', 'IP address is required', 'error');
        return;
    }

    try {
        const response = await fetch('{{ url_for("admin_panel.security_ban_ip") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                ip_address: ipAddress,
                reason: reason || 'Manual ban',
                duration_hours: durationHours,
                permanent: permanent
            })
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire('Success', data.message, 'success').then(() => location.reload());
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    } catch (error) {
        Swal.fire('Error', 'Failed to ban IP', 'error');
    }
}

async function unbanIp(ipAddress) {
    const result = await Swal.fire({
        title: 'Unban IP?',
        text: `Are you sure you want to unban ${ipAddress}?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, unban'
    });

    if (!result.isConfirmed) return;

    try {
        const response = await fetch('{{ url_for("admin_panel.security_unban_ip") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ ip_address: ipAddress })
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire('Success', data.message, 'success').then(() => location.reload());
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    } catch (error) {
        Swal.fire('Error', 'Failed to unban IP', 'error');
    }
}

async function clearAllBans() {
    const result = await Swal.fire({
        title: 'Clear All Bans?',
        text: 'This will remove ALL IP bans. Are you sure?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('danger') : '#dc3545',
        confirmButtonText: 'Yes, clear all'
    });

    if (!result.isConfirmed) return;

    try {
        const response = await fetch('{{ url_for("admin_panel.security_clear_all_bans") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire('Success', data.message, 'success').then(() => location.reload());
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    } catch (error) {
        Swal.fire('Error', 'Failed to clear bans', 'error');
    }
}

// Auto-refresh every 30 seconds
setInterval(refreshStats, 30000);
</script>
{% endblock %}
