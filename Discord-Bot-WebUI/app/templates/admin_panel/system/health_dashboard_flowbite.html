{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert %}

{% block admin_title %}System Health{% endblock %}
{% block panel_description %}System health monitoring and diagnostics{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.system_monitoring') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">System</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Health Dashboard</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- System Health Overview -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
    <div class="flex items-center justify-between p-5 border-b border-gray-200 dark:border-gray-700">
        <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
            <i class="ti ti-heartbeat mr-2"></i>System Health Overview
        </h5>
        <div class="flex gap-2">
            <button type="button" id="health-refresh-btn" class="px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                <i class="ti ti-refresh mr-1"></i>Refresh
            </button>
            <button type="button" id="twilio-test-btn" class="px-3 py-2 text-sm font-medium text-white bg-cyan-500 rounded-lg hover:bg-cyan-600">
                <i class="ti ti-phone mr-1"></i>Test Twilio
            </button>
        </div>
    </div>
    <div class="p-5">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Overall Status -->
            <div class="flex flex-col items-center justify-center p-6 rounded-lg {{ 'bg-green-50 dark:bg-green-900/30' if health_status.status == 'healthy' else 'bg-yellow-50 dark:bg-yellow-900/30' if health_status.status == 'degraded' else 'bg-red-50 dark:bg-red-900/30' }}">
                <div class="flex items-center justify-center w-16 h-16 rounded-full mb-3 {{ 'bg-green-100 dark:bg-green-900/50' if health_status.status == 'healthy' else 'bg-yellow-100 dark:bg-yellow-900/50' if health_status.status == 'degraded' else 'bg-red-100 dark:bg-red-900/50' }}">
                    <i class="ti ti-{{ 'check' if health_status.status == 'healthy' else 'alert-triangle' if health_status.status == 'degraded' else 'x' }} text-3xl {{ 'text-green-600 dark:text-green-400' if health_status.status == 'healthy' else 'text-yellow-600 dark:text-yellow-400' if health_status.status == 'degraded' else 'text-red-600 dark:text-red-400' }}"></i>
                </div>
                <h4 class="text-xl font-bold capitalize {{ 'text-green-600 dark:text-green-400' if health_status.status == 'healthy' else 'text-yellow-600 dark:text-yellow-400' if health_status.status == 'degraded' else 'text-red-600 dark:text-red-400' }}" id="overall-status">{{ health_status.status }}</h4>
                <p class="text-xs text-gray-500 dark:text-gray-400" id="last-check">Last check: {{ health_status.timestamp }}</p>
            </div>

            <!-- Component Cards Grid -->
            <div class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="component-cards">
                {% for name, component in health_status.components.items() %}
                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                    <div class="flex items-center mb-2">
                        <span class="w-3 h-3 rounded-full mr-2 {{ 'bg-green-500' if component.status == 'healthy' else 'bg-yellow-500' if component.status == 'warning' else 'bg-red-500' }}"></span>
                        <h6 class="font-semibold text-gray-900 dark:text-white capitalize">{{ name }}</h6>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">{{ component.message }}</p>
                    {% if component.worker_count is defined %}
                    <span class="inline-flex items-center mt-2 px-2 py-0.5 rounded text-xs font-medium bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-300">{{ component.worker_count }} workers</span>
                    {% endif %}
                    {% if component.running_count is defined %}
                    <span class="inline-flex items-center mt-2 px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">{{ component.running_count }}/{{ component.container_count }} running</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Task Status & System Diagnostics -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Task Status -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="ti ti-list-check mr-2"></i>Task Status
            </h5>
        </div>
        <div class="p-5" id="task-status-content">
            <div class="flex flex-col items-center justify-center py-8">
                <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-3"></div>
                <p class="text-gray-500 dark:text-gray-400">Loading task status...</p>
            </div>
        </div>
    </div>

    <!-- System Diagnostics -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="ti ti-info-circle mr-2"></i>System Diagnostics
            </h5>
        </div>
        <div class="p-5">
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-gray-600 dark:text-gray-400">Environment</span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">{{ diagnostics.environment }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600 dark:text-gray-400">Debug Mode</span>
                    {% if diagnostics.debug_mode %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Enabled</span>
                    {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Disabled</span>
                    {% endif %}
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600 dark:text-gray-400">Last Check</span>
                    <span class="text-gray-900 dark:text-white">{{ diagnostics.timestamp }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Twilio Test Results (Hidden by default) -->
<div class="hidden mb-6" id="twilio-results-section">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="ti ti-phone mr-2"></i>Twilio Configuration Test Results
            </h5>
        </div>
        <div class="p-5" id="twilio-results">
            <!-- Results will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Quick Actions -->
{% call card(title="Quick Actions") %}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <a href="{{ url_for('admin_panel.redis_management') }}" class="flex items-center justify-center px-4 py-3 text-sm font-medium text-blue-600 bg-white border border-blue-600 rounded-lg hover:bg-blue-50 dark:bg-gray-800 dark:hover:bg-gray-700">
        <i class="ti ti-database mr-2"></i>Redis Management
    </a>
    <a href="{{ url_for('admin_panel.docker_management') }}" class="flex items-center justify-center px-4 py-3 text-sm font-medium text-blue-600 bg-white border border-blue-600 rounded-lg hover:bg-blue-50 dark:bg-gray-800 dark:hover:bg-gray-700">
        <i class="ti ti-box mr-2"></i>Docker Management
    </a>
    <a href="{{ url_for('admin_panel.task_monitoring_page') }}" class="flex items-center justify-center px-4 py-3 text-sm font-medium text-blue-600 bg-white border border-blue-600 rounded-lg hover:bg-blue-50 dark:bg-gray-800 dark:hover:bg-gray-700">
        <i class="ti ti-list-check mr-2"></i>Task Monitor
    </a>
    <a href="{{ url_for('admin_panel.system_monitoring') }}" class="flex items-center justify-center px-4 py-3 text-sm font-medium text-blue-600 bg-white border border-blue-600 rounded-lg hover:bg-blue-50 dark:bg-gray-800 dark:hover:bg-gray-700">
        <i class="ti ti-activity mr-2"></i>System Monitoring
    </a>
</div>
{% endcall %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadTaskStatus();

    // Auto-refresh every 30 seconds
    setInterval(refreshHealth, 30000);

    document.getElementById('health-refresh-btn')?.addEventListener('click', refreshHealth);
    document.getElementById('twilio-test-btn')?.addEventListener('click', testTwilio);
});

function refreshHealth() {
    const btn = document.getElementById('health-refresh-btn');
    if (btn) {
        btn.innerHTML = '<i class="ti ti-refresh mr-1 animate-spin"></i>Refreshing...';
        btn.disabled = true;
    }

    fetch('{{ url_for("admin_panel.health_check_api") }}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('overall-status').textContent = data.status;
            document.getElementById('last-check').textContent = 'Last check: ' + data.timestamp;
            loadTaskStatus();
        })
        .catch(error => console.error('Error:', error))
        .finally(() => {
            if (btn) {
                btn.innerHTML = '<i class="ti ti-refresh mr-1"></i>Refresh';
                btn.disabled = false;
            }
        });
}

function loadTaskStatus() {
    fetch('{{ url_for("admin_panel.task_status_api") }}')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('task-status-content');
            if (!container) return;

            if (data.status === 'error') {
                container.innerHTML = `<div class="bg-red-50 dark:bg-red-900/30 text-red-800 dark:text-red-300 p-4 rounded-lg">${data.message}</div>`;
                return;
            }

            let html = `
                <div class="grid grid-cols-3 gap-4 text-center mb-4">
                    <div>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">${data.stats.total || 0}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Total (1hr)</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-green-600 dark:text-green-400">${data.stats.completed || 0}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Completed</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-red-600 dark:text-red-400">${data.stats.failed || 0}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Failed</p>
                    </div>
                </div>
            `;

            if (data.zombie_count > 0) {
                html += `<div class="flex items-center p-4 rounded-lg bg-yellow-50 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300"><i class="ti ti-alert-triangle mr-2"></i>${data.zombie_count} zombie task(s) detected</div>`;
            } else {
                html += `<div class="flex items-center p-4 rounded-lg bg-green-50 dark:bg-green-900/30 text-green-800 dark:text-green-300"><i class="ti ti-check mr-2"></i>No zombie tasks detected</div>`;
            }

            container.innerHTML = html;
        })
        .catch(error => {
            const container = document.getElementById('task-status-content');
            if (container) {
                container.innerHTML = '<div class="bg-yellow-50 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 p-4 rounded-lg">Unable to load task status</div>';
            }
        });
}

function testTwilio() {
    const btn = document.getElementById('twilio-test-btn');
    if (!btn) return;

    btn.innerHTML = '<i class="ti ti-loader mr-1 animate-spin"></i>Testing...';
    btn.disabled = true;

    fetch('{{ url_for("admin_panel.test_twilio_config") }}')
        .then(response => response.json())
        .then(data => {
            const section = document.getElementById('twilio-results-section');
            const container = document.getElementById('twilio-results');
            if (!section || !container) return;

            section.classList.remove('hidden');

            let html = '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';

            html += `
                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                    <h6 class="font-semibold text-gray-900 dark:text-white mb-2">Config Check</h6>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${data.config_check ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'}">${data.config_check ? 'Passed' : 'Failed'}</span>
                </div>
            `;

            html += `
                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                    <h6 class="font-semibold text-gray-900 dark:text-white mb-2">Connection Test</h6>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${data.connection_test.status === 'SUCCESS' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'}">${data.connection_test.status}</span>
                    ${data.connection_test.message ? `<p class="text-sm text-gray-500 dark:text-gray-400 mt-2">${data.connection_test.message}</p>` : ''}
                </div>
            `;

            html += `
                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                    <h6 class="font-semibold text-gray-900 dark:text-white mb-2">Environment Variables</h6>
                    <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
            `;
            for (const [key, value] of Object.entries(data.environment_vars || {})) {
                html += `<li><code class="text-xs">${key}</code>: ${value}</li>`;
            }
            html += '</ul></div></div>';
            container.innerHTML = html;

            section.scrollIntoView({ behavior: 'smooth' });
        })
        .catch(error => console.error('Error:', error))
        .finally(() => {
            btn.innerHTML = '<i class="ti ti-phone mr-1"></i>Test Twilio';
            btn.disabled = false;
        });
}
</script>
{% endblock %}
