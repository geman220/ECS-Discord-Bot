{% extends "admin_panel/base.html" %}

{% block title %}System Health - Admin Panel{% endblock %}

{% block panel_description %}System health monitoring and diagnostics{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_panel.system_monitoring') }}">System</a></li>
<li class="breadcrumb-item active">Health Dashboard</li>
{% endblock %}

{% block panel_content %}
<div class="row">
    <!-- Overall Health Status -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="ti ti-heartbeat me-2"></i>System Health Overview</h5>
                <div>
                    <button id="refresh-btn" class="btn btn-primary btn-sm">
                        <i class="ti ti-refresh me-1"></i>Refresh
                    </button>
                    <button id="twilio-test-btn" class="btn btn-info btn-sm ms-2">
                        <i class="ti ti-phone me-1"></i>Test Twilio
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center p-3 rounded
                            {% if health_status.status == 'healthy' %}bg-success bg-opacity-10
                            {% elif health_status.status == 'degraded' %}bg-warning bg-opacity-10
                            {% else %}bg-danger bg-opacity-10{% endif %}">
                            <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-2"
                                 style="width: 60px; height: 60px;
                                 {% if health_status.status == 'healthy' %}background-color: rgba(40, 167, 69, 0.2);
                                 {% elif health_status.status == 'degraded' %}background-color: rgba(255, 193, 7, 0.2);
                                 {% else %}background-color: rgba(220, 53, 69, 0.2);{% endif %}">
                                <i class="ti ti-{% if health_status.status == 'healthy' %}check{% elif health_status.status == 'degraded' %}alert-triangle{% else %}x{% endif %} fs-2
                                   {% if health_status.status == 'healthy' %}text-success
                                   {% elif health_status.status == 'degraded' %}text-warning
                                   {% else %}text-danger{% endif %}"></i>
                            </div>
                            <h4 class="mb-1 text-capitalize" id="overall-status">{{ health_status.status }}</h4>
                            <small class="text-muted" id="last-check">Last check: {{ health_status.timestamp }}</small>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="row" id="component-cards">
                            {% for name, component in health_status.components.items() %}
                            <div class="col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="status-indicator me-2
                                                {% if component.status == 'healthy' %}active
                                                {% elif component.status == 'warning' %}bg-warning
                                                {% else %}inactive{% endif %}"></span>
                                            <h6 class="mb-0 text-capitalize">{{ name }}</h6>
                                        </div>
                                        <p class="small text-muted mb-0">{{ component.message }}</p>
                                        {% if component.worker_count is defined %}
                                        <span class="badge bg-info mt-1">{{ component.worker_count }} workers</span>
                                        {% endif %}
                                        {% if component.running_count is defined %}
                                        <span class="badge bg-success mt-1">{{ component.running_count }}/{{ component.container_count }} running</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Status -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="ti ti-list-check me-2"></i>Task Status</h5>
            </div>
            <div class="card-body">
                <div id="task-status-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading task status...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Diagnostics -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="ti ti-info-circle me-2"></i>System Diagnostics</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td>Environment</td>
                            <td><span class="badge bg-primary">{{ diagnostics.environment }}</span></td>
                        </tr>
                        <tr>
                            <td>Debug Mode</td>
                            <td>
                                {% if diagnostics.debug_mode %}
                                <span class="badge bg-warning">Enabled</span>
                                {% else %}
                                <span class="badge bg-success">Disabled</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>Last Check</td>
                            <td>{{ diagnostics.timestamp }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Twilio Test Results -->
    <div class="col-12 mb-4" id="twilio-results-section" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="ti ti-phone me-2"></i>Twilio Configuration Test Results</h5>
            </div>
            <div class="card-body">
                <div id="twilio-results">
                    <!-- Results will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="ti ti-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('admin_panel.redis_management') }}" class="btn btn-outline-primary w-100">
                            <i class="ti ti-database me-2"></i>Redis Management
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('admin_panel.docker_management') }}" class="btn btn-outline-primary w-100">
                            <i class="ti ti-box me-2"></i>Docker Management
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('admin_panel.task_monitoring_page') }}" class="btn btn-outline-primary w-100">
                            <i class="ti ti-list-check me-2"></i>Task Monitor
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('admin_panel.system_monitoring') }}" class="btn btn-outline-primary w-100">
                            <i class="ti ti-activity me-2"></i>System Monitoring
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadTaskStatus();

    // Auto-refresh every 30 seconds
    setInterval(refreshHealth, 30000);
});

function refreshHealth() {
    const refreshBtn = document.getElementById('refresh-btn');
    refreshBtn.innerHTML = '<i class="ti ti-refresh me-1 spin"></i>Refreshing...';
    refreshBtn.disabled = true;

    fetch('{{ url_for("admin_panel.health_check_api") }}')
        .then(response => response.json())
        .then(data => {
            updateHealthDisplay(data);
            loadTaskStatus();
        })
        .catch(error => {
            console.error('Error refreshing health:', error);
            AdminPanel.showMobileToast('Error refreshing health status', 'danger');
        })
        .finally(() => {
            refreshBtn.innerHTML = '<i class="ti ti-refresh me-1"></i>Refresh';
            refreshBtn.disabled = false;
        });
}

function updateHealthDisplay(data) {
    const statusEl = document.getElementById('overall-status');
    const lastCheckEl = document.getElementById('last-check');

    statusEl.textContent = data.status;
    lastCheckEl.textContent = 'Last check: ' + data.timestamp;

    // Update component cards would require more complex DOM manipulation
    // For now, just show a toast
    AdminPanel.showMobileToast('Health status refreshed', 'success');
}

function loadTaskStatus() {
    fetch('{{ url_for("admin_panel.task_status_api") }}')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('task-status-content');

            if (data.status === 'error') {
                container.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                return;
            }

            let html = `
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <h4 class="mb-0">${data.stats.total || 0}</h4>
                        <small class="text-muted">Total (1hr)</small>
                    </div>
                    <div class="col-4">
                        <h4 class="mb-0 text-success">${data.stats.completed || 0}</h4>
                        <small class="text-muted">Completed</small>
                    </div>
                    <div class="col-4">
                        <h4 class="mb-0 text-danger">${data.stats.failed || 0}</h4>
                        <small class="text-muted">Failed</small>
                    </div>
                </div>
            `;

            if (data.zombie_count > 0) {
                html += `
                    <div class="alert alert-warning mb-0">
                        <i class="ti ti-alert-triangle me-2"></i>
                        ${data.zombie_count} zombie task(s) detected
                    </div>
                `;
            } else {
                html += `
                    <div class="alert alert-success mb-0">
                        <i class="ti ti-check me-2"></i>
                        No zombie tasks detected
                    </div>
                `;
            }

            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading task status:', error);
            document.getElementById('task-status-content').innerHTML =
                '<div class="alert alert-warning">Unable to load task status</div>';
        });
}

document.getElementById('refresh-btn').addEventListener('click', refreshHealth);

document.getElementById('twilio-test-btn').addEventListener('click', function() {
    const btn = this;
    btn.innerHTML = '<i class="ti ti-loader me-1 spin"></i>Testing...';
    btn.disabled = true;

    fetch('{{ url_for("admin_panel.test_twilio_config") }}')
        .then(response => response.json())
        .then(data => {
            const section = document.getElementById('twilio-results-section');
            const container = document.getElementById('twilio-results');

            section.style.display = 'block';

            let html = '<div class="row">';

            // Config check
            html += `
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6>Config Check</h6>
                            <span class="badge ${data.config_check ? 'bg-success' : 'bg-danger'}">
                                ${data.config_check ? 'Passed' : 'Failed'}
                            </span>
                        </div>
                    </div>
                </div>
            `;

            // Connection test
            html += `
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6>Connection Test</h6>
                            <span class="badge ${data.connection_test.status === 'SUCCESS' ? 'bg-success' : 'bg-danger'}">
                                ${data.connection_test.status}
                            </span>
                            ${data.connection_test.message ? `<p class="small text-muted mt-2 mb-0">${data.connection_test.message}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;

            // Environment variables
            html += `
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6>Environment Variables</h6>
                            <ul class="list-unstyled mb-0 small">
            `;
            for (const [key, value] of Object.entries(data.environment_vars || {})) {
                html += `<li><code>${key}</code>: ${value}</li>`;
            }
            html += `
                            </ul>
                        </div>
                    </div>
                </div>
            `;

            html += '</div>';
            container.innerHTML = html;

            section.scrollIntoView({ behavior: 'smooth' });
        })
        .catch(error => {
            console.error('Error testing Twilio:', error);
            AdminPanel.showMobileToast('Error testing Twilio configuration', 'danger');
        })
        .finally(() => {
            btn.innerHTML = '<i class="ti ti-phone me-1"></i>Test Twilio';
            btn.disabled = false;
        });
});

// Add spin animation
const style = document.createElement('style');
style.textContent = `
    .spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
