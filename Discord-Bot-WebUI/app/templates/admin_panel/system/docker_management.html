{% extends "admin_panel/base.html" %}

{% block title %}Docker Management - Admin Panel{% endblock %}

{% block panel_description %}Docker container monitoring and management{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_panel.system_monitoring') }}">System</a></li>
<li class="breadcrumb-item active">Docker Management</li>
{% endblock %}

{% block panel_content %}
<div class="row">
    <!-- Header -->
    <div class="col-12 mb-4">
        <div class="c-card">
            <div class="c-card__header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="ti ti-box me-2"></i>Docker Container Management</h5>
                <button id="docker-refresh-btn" class="c-btn c-btn--primary c-btn--sm">
                    <i class="ti ti-refresh me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Container Stats -->
    <div class="col-md-4 mb-4">
        <div class="c-card h-100 bg-success bg-opacity-10">
            <div class="c-card__body text-center">
                <i class="ti ti-circle-check fs-1 text-success mb-2"></i>
                <h3 class="mb-0" id="running-count">{{ containers|selectattr('status', 'startswith', 'running')|list|length }}</h3>
                <small class="text-muted">Running</small>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="c-card h-100 bg-warning bg-opacity-10">
            <div class="c-card__body text-center">
                <i class="ti ti-circle-pause fs-1 text-warning mb-2"></i>
                <h3 class="mb-0" id="stopped-count">{{ containers|rejectattr('status', 'startswith', 'running')|list|length }}</h3>
                <small class="text-muted">Stopped</small>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="c-card h-100 bg-info bg-opacity-10">
            <div class="c-card__body text-center">
                <i class="ti ti-box fs-1 text-info mb-2"></i>
                <h3 class="mb-0" id="total-count">{{ containers|length }}</h3>
                <small class="text-muted">Total Containers</small>
            </div>
        </div>
    </div>

    <!-- Container List -->
    <div class="col-12 mb-4">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="mb-0"><i class="ti ti-list me-2"></i>Containers</h5>
            </div>
            <div class="c-card__body">
                {% if containers %}
                <div class="c-table-wrapper" data-table-responsive>
                    <table class="c-table c-table--hoverable" data-table>
                        <thead scope="col">
                            <tr>
                                <th scope="col">Name</th>
                                <th scope="col">Image</th>
                                <th scope="col">Status</th>
                                <th scope="col">Ports</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="container-list">
                            {% for container in containers %}
                            <tr data-container-id="{{ container.id }}">
                                <td>
                                    <i class="ti ti-box me-2 text-muted"></i>
                                    <strong>{{ container.name }}</strong>
                                </td>
                                <td><code class="small">{{ container.image }}</code></td>
                                <td>
                                    {% if container.status.startswith('running') %}
                                    <span class="badge bg-success" data-badge>
                                        <i class="ti ti-circle-check me-1"></i>Running
                                    </span>
                                    {% elif container.status.startswith('exited') %}
                                    <span class="badge bg-danger" data-badge>
                                        <i class="ti ti-circle-x me-1"></i>Exited
                                    </span>
                                    {% else %}
                                    <span class="badge bg-warning" data-badge>
                                        <i class="ti ti-circle-pause me-1"></i>{{ container.status }}
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if container.ports %}
                                    <span class="small">{{ container.ports }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% if container.status.startswith('running') %}
                                        <button class="c-btn c-btn--outline-warning js-manage-container" data-action="manage-container" data-container-id="{{ container.id }}" data-container-action="stop" title="Stop">
                                            <i class="ti ti-player-stop"></i>
                                        </button>
                                        <button class="c-btn c-btn--outline-info js-manage-container" data-action="manage-container" data-container-id="{{ container.id }}" data-container-action="restart" title="Restart">
                                            <i class="ti ti-refresh"></i>
                                        </button>
                                        {% else %}
                                        <button class="c-btn c-btn--outline-success js-manage-container" data-action="manage-container" data-container-id="{{ container.id }}" data-container-action="start" title="Start">
                                            <i class="ti ti-player-play"></i>
                                        </button>
                                        {% endif %}
                                        <button class="c-btn c-btn--outline-secondary js-view-logs" data-action="view-logs" data-container-id="{{ container.id }}" data-container-name="{{ container.name }}" title="View Logs">
                                            <i class="ti ti-file-text"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="ti ti-box-off fs-1 text-muted mb-3"></i>
                    <p class="text-muted">No Docker containers found or Docker is not available.</p>
                    <a href="{{ url_for('admin_panel.health_dashboard') }}" class="c-btn c-btn--outline-primary">
                        <i class="ti ti-heartbeat me-2"></i>Check System Health
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick Links -->
    <div class="col-12">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="mb-0"><i class="ti ti-link me-2"></i>Related Tools</h5>
            </div>
            <div class="c-card__body">
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('admin_panel.health_dashboard') }}" class="c-btn c-btn--outline-primary w-100">
                            <i class="ti ti-heartbeat me-2"></i>Health Dashboard
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('admin_panel.redis_management') }}" class="c-btn c-btn--outline-primary w-100">
                            <i class="ti ti-database me-2"></i>Redis Management
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('admin_panel.system_monitoring') }}" class="c-btn c-btn--outline-primary w-100">
                            <i class="ti ti-activity me-2"></i>System Monitoring
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('admin_panel.task_monitoring_page') }}" class="c-btn c-btn--outline-primary w-100">
                            <i class="ti ti-list-check me-2"></i>Task Monitor
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Modal -->
<div class="modal c-modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true" data-modal>
    <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg modal-dialog-scrollable c-modal__dialog--scrollable" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="logModalLabel">
                    <i class="ti ti-file-text me-2"></i>Container Logs
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-dismiss></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body>
                <div id="log-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status" data-spinner>
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading logs...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Close</button>
                <button type="button" class="c-btn c-btn--primary js-refresh-logs" data-action="refresh-logs">
                    <i class="ti ti-refresh me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
let currentContainerId = null;
let logModal = null;

document.addEventListener('DOMContentLoaded', function() {
    logModal = ModalManager.getInstance('logModal');

    // Manage container buttons
    document.querySelectorAll('.js-manage-container').forEach(btn => {
        btn.addEventListener('click', function() {
            const containerId = this.dataset.containerId;
            const action = this.dataset.containerAction;
            manageContainer(containerId, action);
        });
    });

    // View logs buttons
    document.querySelectorAll('.js-view-logs').forEach(btn => {
        btn.addEventListener('click', function() {
            const containerId = this.dataset.containerId;
            const containerName = this.dataset.containerName;
            viewLogs(containerId, containerName);
        });
    });

    // Refresh logs button in modal
    document.querySelectorAll('.js-refresh-logs').forEach(btn => {
        btn.addEventListener('click', function() {
            refreshLogs();
        });
    });
});

function refreshContainers() {
    const refreshBtn = document.getElementById('refresh-btn');
    refreshBtn.innerHTML = '<i class="ti ti-loader spin me-1"></i>Refreshing...';
    refreshBtn.disabled = true;

    fetch('{{ url_for("admin_panel.docker_status_api") }}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateContainerDisplay(data.containers);
                AdminPanel.showMobileToast('Container status refreshed', 'success');
            } else {
                AdminPanel.showMobileToast('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error refreshing containers:', error);
            AdminPanel.showMobileToast('Error refreshing container status', 'danger');
        })
        .finally(() => {
            refreshBtn.innerHTML = '<i class="ti ti-refresh me-1"></i>Refresh';
            refreshBtn.disabled = false;
        });
}

function updateContainerDisplay(containers) {
    const running = containers.filter(c => c.status && c.status.startsWith('running')).length;
    const stopped = containers.length - running;

    document.getElementById('running-count').textContent = running;
    document.getElementById('stopped-count').textContent = stopped;
    document.getElementById('total-count').textContent = containers.length;
}

function manageContainer(containerId, action) {
    if (!confirm(`Are you sure you want to ${action} this container?`)) {
        return;
    }

    fetch(`{{ url_for('admin_panel.docker_manage_container', container_id='CONTAINER_ID', action='ACTION') }}`
        .replace('CONTAINER_ID', containerId)
        .replace('ACTION', action), {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            AdminPanel.showMobileToast(data.message, 'success');
            setTimeout(refreshContainers, 1000);
        } else {
            AdminPanel.showMobileToast('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error managing container:', error);
        AdminPanel.showMobileToast('Error managing container', 'danger');
    });
}

function viewLogs(containerId, containerName) {
    currentContainerId = containerId;
    document.getElementById('logModalLabel').innerHTML =
        `<i class="ti ti-file-text me-2"></i>Logs: ${containerName}`;
    document.getElementById('log-content').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status" data-spinner>
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading logs...</p>
        </div>
    `;

    logModal.show();
    fetchLogs(containerId);
}

function fetchLogs(containerId) {
    fetch(`{{ url_for('admin_panel.docker_view_logs', container_id='CONTAINER_ID') }}`
        .replace('CONTAINER_ID', containerId))
    .then(response => response.json())
    .then(data => {
        const logContent = document.getElementById('log-content');
        if (data.error) {
            logContent.innerHTML = `<div class="alert alert-danger" data-alert>${data.error}</div>`;
        } else {
            const logs = data.logs || 'No logs available';
            logContent.innerHTML = `
                <pre class="bg-dark text-light p-3 rounded u-h-400 u-overflow-y-auto" class="u-font-size-0-8rem">${escapeHtml(logs)}</pre>
            `;
        }
    })
    .catch(error => {
        console.error('Error fetching logs:', error);
        document.getElementById('log-content').innerHTML =
            `<div class="alert alert-danger" data-alert>Error loading logs: ${error}</div>`;
    });
}

function refreshLogs() {
    if (currentContainerId) {
        document.getElementById('log-content').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status" data-spinner>
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Refreshing logs...</p>
            </div>
        `;
        fetchLogs(currentContainerId);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

document.getElementById('refresh-btn').addEventListener('click', refreshContainers);

// Add spin animation
const style = document.createElement('style');
style.textContent = `
    .spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
