{% extends "admin_panel/base.html" %}
{% import 'macros.html' as macros %}

{% block title %}Feature Toggles - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">Feature Toggles</li>
{% endblock %}

{% block panel_content %}
<div class="c-feature-toggles" data-component="feature-toggles">
    <!-- Feature Categories -->
    {% for category, settings in categories.items() %}
    <div class="c-feature-category" data-category="{{ category }}" data-component="feature-category">
        <div class="c-card" data-card>
            <div class="c-card__header">
                <h5 class="c-card__title">
                    {% if category == 'navigation' %}
                        <i class="ti ti-navigation c-card__title-icon c-card__title-icon--primary"></i>Navigation Settings
                    {% elif category == 'registration' %}
                        <i class="ti ti-user-plus c-card__title-icon c-card__title-icon--success"></i>Registration Settings
                    {% elif category == 'features' %}
                        <i class="ti ti-apps c-card__title-icon c-card__title-icon--warning"></i>Feature Settings
                    {% elif category == 'system' %}
                        <i class="ti ti-server c-card__title-icon c-card__title-icon--info"></i>System Settings
                    {% else %}
                        <i class="ti ti-settings c-card__title-icon c-card__title-icon--secondary"></i>{{ category.title() }} Settings
                    {% endif %}
                </h5>
            </div>
            <div class="c-card__body">
                {% for setting in settings %}
                <div class="c-setting-row" data-setting-row data-setting-key="{{ setting.key }}">
                    <div class="c-setting-row__info">
                        <div class="c-setting-row__icon">
                            {% if setting.data_type == 'boolean' %}
                                {% if setting.parsed_value %}
                                    <i class="ti ti-toggle-right c-setting-row__status-icon c-setting-row__status-icon--enabled"></i>
                                {% else %}
                                    <i class="ti ti-toggle-left c-setting-row__status-icon c-setting-row__status-icon--disabled"></i>
                                {% endif %}
                            {% else %}
                                <i class="ti ti-adjustments-horizontal c-setting-row__status-icon c-setting-row__status-icon--default"></i>
                            {% endif %}
                        </div>
                        <div class="c-setting-row__content">
                            <h6 class="c-setting-row__title">{{ setting.key.replace('_', ' ').title() }}</h6>
                            <p class="c-setting-row__description">{{ setting.description or 'No description available' }}</p>
                            <div class="c-setting-row__meta">
                                <span class="c-badge c-badge--light" data-badge data-type="{{ setting.data_type }}">{{ setting.data_type }}</span>
                                <small class="c-setting-row__timestamp">
                                    Last updated: {{ setting.updated_at.strftime('%Y-%m-%d %H:%M') }}
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="c-setting-row__control">
                        {% if setting.data_type == 'boolean' %}
                            <!-- Boolean Toggle -->
                            <div class="c-toggle-switch" data-toggle-switch>
                                <input class="c-toggle-switch__input"
                                       type="checkbox"
                                       data-setting-toggle
                                       data-setting-key="{{ setting.key }}"
                                       {% if setting.parsed_value %}checked{% endif %}
                                       aria-label="Toggle {{ setting.key.replace('_', ' ') }}">
                                <label class="c-toggle-switch__label" data-toggle-label>
                                    <span class="c-toggle-switch__status" data-toggle-status>
                                        {% if setting.parsed_value %}Enabled{% else %}Disabled{% endif %}
                                    </span>
                                </label>
                            </div>
                        {% else %}
                            <!-- Text/Number Input -->
                            <form method="POST"
                                  action="{{ url_for('admin_panel.update_setting') }}"
                                  class="c-setting-form"
                                  data-setting-form>
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="key" value="{{ setting.key }}">
                                <div class="c-setting-form__group">
                                    {% if setting.data_type == 'integer' %}
                                        <input type="number"
                                               class="c-setting-form__input"
                                               name="value"
                                               value="{{ setting.value or '' }}"
                                               placeholder="Enter {{ setting.data_type }}"
                                               aria-label="{{ setting.key.replace('_', ' ') }} value">
                                    {% else %}
                                        <input type="text"
                                               class="c-setting-form__input"
                                               name="value"
                                               value="{{ setting.value or '' }}"
                                               placeholder="Enter {{ setting.data_type }}"
                                               aria-label="{{ setting.key.replace('_', ' ') }} value">
                                    {% endif %}
                                    <button type="submit"
                                            class="c-setting-form__submit"
                                            aria-label="Save {{ setting.key.replace('_', ' ') }}">
                                        <i class="ti ti-check"></i>
                                    </button>
                                </div>
                            </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Critical Settings Warning -->
    <div class="c-feature-warning" data-component="warning-alert">
        <div class="c-alert c-alert--warning">
            <div class="c-alert__icon">
                <i class="ti ti-alert-triangle"></i>
            </div>
            <div class="c-alert__content">
                <strong>Important:</strong> Changes to these settings take effect immediately.
                Be careful when modifying critical features like Teams navigation and Waitlist registration,
                as they directly affect user experience.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_css %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin-panel/feature-toggles.css') }}">
{% endif %}
{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script type="module" src="{{ url_for('static', filename='js/admin-panel-feature-toggles.js') }}"></script>
{% endif %}
{% endblock %}
