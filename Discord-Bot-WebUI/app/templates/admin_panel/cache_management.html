{% extends "admin_panel/base.html" %}

{% block title %}Cache Management - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">Cache Management</li>
{% endblock %}

{% block panel_content %}
<!-- Cache Status Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card bg-{% if stats.redis_status == 'connected' %}success{% else %}danger{% endif %} text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title text-white mb-1">{{ stats.redis_status.title() }}</h5>
                        <p class="card-text small opacity-75 mb-0">Redis Status</p>
                    </div>
                    <div class="card-icon">
                        <i class="ti ti-database" style="font-size: 2rem; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title text-white mb-1">{{ stats.total_keys or 0 }}</h5>
                        <p class="card-text small opacity-75 mb-0">Total Keys</p>
                    </div>
                    <div class="card-icon">
                        <i class="ti ti-key" style="font-size: 2rem; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title text-white mb-1">{{ stats.memory_usage or '0MB' }}</h5>
                        <p class="card-text small opacity-75 mb-0">Memory Usage</p>
                    </div>
                    <div class="card-icon">
                        <i class="ti ti-device-desktop" style="font-size: 2rem; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title text-white mb-1">{{ stats.hit_rate or '0%' }}</h5>
                        <p class="card-text small opacity-75 mb-0">Hit Rate</p>
                    </div>
                    <div class="card-icon">
                        <i class="ti ti-target" style="font-size: 2rem; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cache Operations -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ti ti-settings me-2"></i>Cache Operations
                </h5>
            </div>
            <div class="card-body">
                <p>Manage cache keys, clear specific caches, and perform maintenance</p>
                <div class="list-group list-group-flush">
                    <button class="list-group-item list-group-item-action" onclick="clearAllCache()">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="ti ti-trash me-2 text-danger"></i>Clear All Cache
                            </div>
                            <i class="ti ti-alert-triangle text-warning"></i>
                        </div>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="clearUserCache()">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="ti ti-users me-2"></i>Clear User Cache
                            </div>
                            <i class="ti ti-chevron-right"></i>
                        </div>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="clearSessionCache()">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="ti ti-key me-2"></i>Clear Session Cache
                            </div>
                            <i class="ti ti-chevron-right"></i>
                        </div>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="refreshCacheStats()">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="ti ti-refresh me-2 text-success"></i>Refresh Statistics
                            </div>
                            <i class="ti ti-chevron-right"></i>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ti ti-chart-bar me-2"></i>Cache Analytics
                </h5>
            </div>
            <div class="card-body">
                <p>Monitor cache performance and usage patterns</p>
                <div class="row">
                    <div class="col-sm-6">
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span class="fw-medium">Operations Today:</span>
                            <span>{{ stats.cache_operations_today or 0 }}</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span class="fw-medium">Hit Rate:</span>
                            <span class="text-success">{{ stats.hit_rate or '0%' }}</span>
                        </div>
                        <div class="d-flex justify-content-between py-2">
                            <span class="fw-medium">Miss Rate:</span>
                            <span class="text-warning">{{ (100 - (stats.hit_rate|replace('%', '')|int if stats.hit_rate else 0))|string + '%' }}</span>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span class="fw-medium">Memory Used:</span>
                            <span>{{ stats.memory_usage or '0MB' }}</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span class="fw-medium">Connections:</span>
                            <span>{{ stats.active_connections or 1 }}</span>
                        </div>
                        <div class="d-flex justify-content-between py-2">
                            <span class="fw-medium">Uptime:</span>
                            <span class="text-success">{{ stats.uptime or '99.9%' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cache Configuration -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ti ti-tool me-2"></i>Cache Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Default TTL (seconds)</label>
                            <input type="number" class="form-control" value="3600" id="defaultTTL">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Max Memory Policy</label>
                            <select class="form-select" id="maxMemoryPolicy">
                                <option value="allkeys-lru">All Keys LRU</option>
                                <option value="volatile-lru">Volatile LRU</option>
                                <option value="allkeys-random">All Keys Random</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Enable Cache</label>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="enableCache" checked>
                                <label class="form-check-label" for="enableCache">
                                    Cache Enabled
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <button class="btn btn-primary" onclick="updateCacheConfig()">
                            <i class="ti ti-device-floppy me-1"></i>Save Configuration
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="resetCacheConfig()">
                            <i class="ti ti-refresh me-1"></i>Reset to Defaults
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cache Status Alert -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-{% if stats.redis_status == 'connected' %}success{% else %}danger{% endif %}">
            <div class="d-flex align-items-center">
                <i class="ti ti-{% if stats.redis_status == 'connected' %}check-circle{% else %}alert-circle{% endif %} me-2"></i>
                <div>
                    <strong>Cache Status:</strong> 
                    {% if stats.redis_status == 'connected' %}
                        Redis cache is operational and performing well.
                    {% else %}
                        Redis cache connection issues detected. Please check configuration.
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script>
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

async function clearCacheByType(cacheType, title) {
    const result = await Swal.fire({
        title: title,
        text: 'This action cannot be undone. Continue?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('danger') : '#dc3545',
        cancelButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('info') : '#3085d6',
        confirmButtonText: 'Yes, clear it!'
    });

    if (!result.isConfirmed) return;

    try {
        const formData = new FormData();
        formData.append('cache_type', cacheType);

        const response = await fetch('{{ url_for("admin_panel.clear_cache") }}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        });

        if (response.redirected) {
            window.location.href = response.url;
        } else {
            Swal.fire({
                icon: 'success',
                title: 'Cache Cleared',
                text: 'The cache has been successfully cleared.',
                timer: 2000,
                showConfirmButton: false
            }).then(() => location.reload());
        }
    } catch (error) {
        Swal.fire('Error', 'Failed to clear cache. Check server connectivity.', 'error');
    }
}

function clearAllCache() {
    clearCacheByType('all', 'Clear All Cache?');
}

function clearUserCache() {
    clearCacheByType('user', 'Clear User Cache?');
}

function clearSessionCache() {
    clearCacheByType('session', 'Clear Session Cache?');
}

function refreshCacheStats() {
    Swal.fire({
        title: 'Refreshing...',
        text: 'Updating cache statistics',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
    });
}

async function updateCacheConfig() {
    const config = {
        defaultTTL: document.getElementById('defaultTTL').value,
        maxMemoryPolicy: document.getElementById('maxMemoryPolicy').value,
        enableCache: document.getElementById('enableCache').checked
    };

    Swal.fire({
        icon: 'success',
        title: 'Configuration Saved',
        text: 'Cache configuration has been updated.',
        timer: 2000,
        showConfirmButton: false
    });
}

function resetCacheConfig() {
    document.getElementById('defaultTTL').value = '3600';
    document.getElementById('maxMemoryPolicy').value = 'allkeys-lru';
    document.getElementById('enableCache').checked = true;

    Swal.fire({
        icon: 'info',
        title: 'Reset Complete',
        text: 'Configuration has been reset to defaults.'
    });
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+R to refresh stats
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        refreshCacheStats();
    }
});
</script>
{% endblock %}