{% extends "admin_panel/base.html" %}

{% block title %}User Analytics - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_panel.user_management') }}">User Management</a></li>
<li class="breadcrumb-item active">Analytics</li>
{% endblock %}

{% block panel_content %}

<!-- Analytics Overview Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card bg-primary text-white">
            <div class="c-card__body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="c-card__title text-white mb-1">{{ "{:,}".format(analytics_data.overview.total_users) }}</h5>
                        <p class="c-card__description small opacity-75 mb-0">Total Users</p>
                    </div>
                    <div class="card-icon">
                        <i class="ti ti-users card-icon-stat"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-white-50">
                        <i class="ti ti-trending-up me-1"></i>
                        +{{ analytics_data.overview.new_users_30d }} this month
                    </small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card bg-success text-white">
            <div class="c-card__body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="c-card__title text-white mb-1">{{ "{:,}".format(analytics_data.overview.active_users) }}</h5>
                        <p class="c-card__description small opacity-75 mb-0">Active Users</p>
                    </div>
                    <div class="card-icon">
                        <i class="ti ti-user-check card-icon-stat"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-white-50">
                        <i class="ti ti-activity me-1"></i>
                        {{ analytics_data.overview.growth_rate_30d }}% growth rate
                    </small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card bg-warning text-white">
            <div class="c-card__body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="c-card__title text-white mb-1">{{ analytics_data.approvals.pending }}</h5>
                        <p class="c-card__description small opacity-75 mb-0">Pending Approvals</p>
                    </div>
                    <div class="card-icon">
                        <i class="ti ti-clock card-icon-stat"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-white-50">
                        <i class="ti ti-percentage me-1"></i>
                        {{ analytics_data.approvals.approval_rate }}% approval rate
                    </small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card bg-info text-white">
            <div class="c-card__body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="c-card__title text-white mb-1">{{ analytics_data.engagement.discord_connected }}</h5>
                        <p class="c-card__description small opacity-75 mb-0">Discord Connected</p>
                    </div>
                    <div class="card-icon">
                        <i class="ti ti-brand-discord card-icon-stat"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-white-50">
                        <i class="ti ti-link me-1"></i>
                        Integration active
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="c-card">
            <div class="c-card__header d-flex justify-content-between align-items-center">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-chart-line me-2"></i>User Registration Trends
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="trendPeriod" id="trend30d" checked>
                    <label class="c-btn c-btn--outline-primary" for="trend30d">30 Days</label>
                    <input type="radio" class="btn-check" name="trendPeriod" id="trend90d">
                    <label class="c-btn c-btn--outline-primary" for="trend90d">90 Days</label>
                    <input type="radio" class="btn-check" name="trendPeriod" id="trend12m">
                    <label class="c-btn c-btn--outline-primary" for="trend12m">12 Months</label>
                </div>
            </div>
            <div class="c-card__body">
                <canvas id="registrationTrendsChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-chart-pie me-2"></i>Approval Status
                </h5>
            </div>
            <div class="c-card__body">
                <canvas id="approvalStatusChart" width="300" height="300"></canvas>
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">Processing Rate:</span>
                        <strong>{{ analytics_data.approval_analytics.processing_rate }}</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">Avg. Wait Time:</span>
                        <strong>{{ analytics_data.approval_analytics.avg_processing_time }}</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small">Backlog Trend:</span>
                        <strong class="text-{% if 'Decreasing' in analytics_data.approval_analytics.backlog_trend %}success{% elif 'Increasing' in analytics_data.approval_analytics.backlog_trend %}warning{% else %}info{% endif %}">
                            {{ analytics_data.approval_analytics.backlog_trend }}
                        </strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Role and League Distribution -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="c-card">
            <div class="c-card__header d-flex justify-content-between align-items-center">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-shield me-2"></i>Role Distribution
                </h5>
                <button type="button" class="c-btn c-btn--outline-primary c-btn--sm js-export-role-data" data-action="export-role-data">
                    <i class="ti ti-download me-1"></i>Export
                </button>
            </div>
            <div class="c-card__body">
                <div class="role-distribution u-scrollable u-h-300">
                    {% for role, count in analytics_data.role_distribution.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong>{{ role }}</strong>
                            <br><small class="text-muted">{{ (count / analytics_data.overview.total_users * 100)|round(1) }}% of users</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-primary" data-badge>{{ count }}</span>
                            <div class="progress mt-1 u-w-100 u-h-4">
                                <div class="progress-bar" data-width-percent="{{ (count / analytics_data.overview.total_users * 100)|round(1) }}"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="c-card">
            <div class="c-card__header d-flex justify-content-between align-items-center">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-trophy me-2"></i>League Distribution
                </h5>
                <button type="button" class="c-btn c-btn--outline-primary c-btn--sm js-export-league-data" data-action="export-league-data">
                    <i class="ti ti-download me-1"></i>Export
                </button>
            </div>
            <div class="c-card__body">
                {% if analytics_data.league_distribution %}
                <div class="league-distribution">
                    {% for league, count in analytics_data.league_distribution.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong>{{ league|title }} League</strong>
                            <br><small class="text-muted">{{ (count / analytics_data.approvals.approved * 100)|round(1) }}% of approved</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success" data-badge>{{ count }}</span>
                            <div class="progress mt-1 u-w-100 u-h-4">
                                <div class="progress-bar bg-success" data-width-percent="{{ (count / analytics_data.approvals.approved * 100)|round(1) if analytics_data.approvals.approved > 0 else 0 }}"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="ti ti-trophy icon-empty-state u-opacity-3"></i>
                    <p class="text-muted mt-2">No league assignments yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Engagement and Activity Metrics -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-activity me-2"></i>User Engagement Metrics
                </h5>
            </div>
            <div class="c-card__body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center p-3">
                            <div class="display-6 text-primary">{{ analytics_data.engagement.users_with_players }}</div>
                            <div class="small text-muted">Users with Player Profiles</div>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-primary" data-width-percent="{{ (analytics_data.engagement.users_with_players / analytics_data.overview.total_users * 100)|round(1) if analytics_data.overview.total_users > 0 else 0 }}"></div>
                            </div>
                            <small class="text-muted">{{ (analytics_data.engagement.users_with_players / analytics_data.overview.total_users * 100)|round(1) if analytics_data.overview.total_users > 0 else 0 }}%</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3">
                            <div class="display-6 text-success">{{ analytics_data.engagement.users_with_roles }}</div>
                            <div class="small text-muted">Users with Roles</div>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-success" data-width-percent="{{ (analytics_data.engagement.users_with_roles / analytics_data.overview.total_users * 100)|round(1) if analytics_data.overview.total_users > 0 else 0 }}"></div>
                            </div>
                            <small class="text-muted">{{ (analytics_data.engagement.users_with_roles / analytics_data.overview.total_users * 100)|round(1) if analytics_data.overview.total_users > 0 else 0 }}%</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3">
                            <div class="display-6 text-info">{{ analytics_data.engagement.discord_connected }}</div>
                            <div class="small text-muted">Discord Connected</div>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-info" data-width-percent="{{ (analytics_data.engagement.discord_connected / analytics_data.overview.total_users * 100)|round(1) if analytics_data.overview.total_users > 0 else 0 }}"></div>
                            </div>
                            <small class="text-muted">{{ (analytics_data.engagement.discord_connected / analytics_data.overview.total_users * 100)|round(1) if analytics_data.overview.total_users > 0 else 0 }}%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-users me-2"></i>Admin Activity
                </h5>
            </div>
            <div class="c-card__body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small">Recent Actions (30d):</span>
                        <strong class="text-primary">{{ analytics_data.activity.recent_activity }}</strong>
                    </div>
                </div>
                {% if analytics_data.activity.admin_activity %}
                <div class="admin-activity-list">
                    <h6 class="small text-muted mb-2">Most Active Admins:</h6>
                    {% for activity in analytics_data.activity.admin_activity[:5] %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">Admin {{ activity.user_id }}</span>
                        <span class="badge bg-secondary" data-badge>{{ activity.count }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="ti ti-user-x card-icon-stat u-opacity-3"></i>
                    <p class="text-muted small mt-2">No recent admin activity</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Export and Actions -->
<div class="row">
    <div class="col-12">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-download me-2"></i>Export Analytics
                </h5>
            </div>
            <div class="c-card__body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button type="button" class="c-btn c-btn--primary js-export-analytics" data-action="export-analytics" data-export-type="users" data-export-format="csv">
                                <i class="ti ti-file-csv me-2"></i>Export Users (CSV)
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button type="button" class="c-btn c-btn--success js-export-analytics" data-action="export-analytics" data-export-type="roles" data-export-format="csv">
                                <i class="ti ti-file-csv me-2"></i>Export Roles (CSV)
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button type="button" class="c-btn c-btn--info js-export-analytics" data-action="export-analytics" data-export-type="activity" data-export-format="json">
                                <i class="ti ti-file-code me-2"></i>Export Activity (JSON)
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button type="button" class="c-btn c-btn--warning js-generate-report" data-action="generate-report">
                                <i class="ti ti-report me-2"></i>Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();

    // Apply dynamic progress bar widths
    applyProgressBarWidths();

    // Event delegation for export buttons
    document.querySelector('.js-export-role-data')?.addEventListener('click', exportRoleData);
    document.querySelector('.js-export-league-data')?.addEventListener('click', exportLeagueData);
    document.querySelector('.js-generate-report')?.addEventListener('click', generateReport);

    document.querySelectorAll('.js-export-analytics').forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.dataset.exportType;
            const format = this.dataset.exportFormat;
            exportAnalytics(type, format);
        });
    });
});

function applyProgressBarWidths() {
    document.querySelectorAll('[data-width-percent]').forEach(bar => {
        const width = bar.getAttribute('data-width-percent');
        bar.style.width = width + '%';
    });
}

function initializeCharts() {
    initializeRegistrationTrendsChart();
    initializeApprovalStatusChart();
}

function initializeRegistrationTrendsChart() {
    const ctx = document.getElementById('registrationTrendsChart').getContext('2d');
    const trendsData = {{ analytics_data.registration_trends|tojson }};
    
    const labels = trendsData.map(item => item.month);
    const data = trendsData.map(item => item.count);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'New Registrations',
                data: data,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function initializeApprovalStatusChart() {
    const ctx = document.getElementById('approvalStatusChart').getContext('2d');
    const approvalData = {{ analytics_data.approvals|tojson }};
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Approved', 'Pending', 'Denied'],
            datasets: [{
                data: [approvalData.approved, approvalData.pending, approvalData.denied],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

function exportAnalytics(type, format) {
    // Show loading
    Swal.fire({
        title: 'Exporting Analytics',
        text: 'Preparing your export...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    fetch('/admin-panel/users/analytics/export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: type,
            format: format,
            date_range: '30_days' // Could be made configurable
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                title: 'Export Ready',
                text: 'Your analytics export is ready for download.',
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'Download',
                cancelButtonText: 'Close'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.open(data.download_url, '_blank');
                }
            });
        } else {
            Swal.fire('Error', data.message || 'Export failed', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Could not export analytics data', 'error');
    });
}

function exportRoleData() {
    exportAnalytics('roles', 'csv');
}

function exportLeagueData() {
    exportAnalytics('leagues', 'csv');
}

function generateReport() {
    Swal.fire({
        title: 'Generate Comprehensive Report',
        text: 'This will generate a detailed analytics report including all metrics.',
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Generate Report'
    }).then((result) => {
        if (result.isConfirmed) {
            exportAnalytics('comprehensive', 'pdf');
        }
    });
}

// Trend period selection
document.querySelectorAll('input[name="trendPeriod"]').forEach(radio => {
    radio.addEventListener('change', function() {
        // In a real implementation, this would update the chart with new data
        console.log('Trend period changed to:', this.id);
    });
});

// Auto-refresh analytics every 5 minutes
setInterval(() => {
    // In a real implementation, this would refresh key metrics
    console.log('Auto-refreshing analytics data...');
}, 300000); // 5 minutes
</script>
{% endif %}
{% endblock %}