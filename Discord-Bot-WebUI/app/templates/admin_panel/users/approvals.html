{% extends "admin_panel/base.html" %}
{% import 'macros.html' as macros %}

{% block title %}User Approvals - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin_panel.user_management') }}">User Management</a>
</li>
<li class="breadcrumb-item active">User Approvals</li>
{% endblock %}

{% block panel_content %}

    <!-- User Approvals Overview -->
    <div class="l-grid l-grid--4-col u-mb-4">
        <div class="c-stat-card c-stat-card--warning">
            <div class="c-stat-card__content">
                <div class="c-stat-card__value">{{ pending_users|length }}</div>
                <div class="c-stat-card__label">Pending Approvals</div>
            </div>
            <div class="c-stat-card__icon">
                <i class="ti ti-user-check"></i>
            </div>
        </div>
        <div class="c-stat-card c-stat-card--success">
            <div class="c-stat-card__content">
                <div class="c-stat-card__value">{{ approved_count }}</div>
                <div class="c-stat-card__label">Total Approved</div>
            </div>
            <div class="c-stat-card__icon">
                <i class="ti ti-check-circle"></i>
            </div>
        </div>
        <div class="c-stat-card c-stat-card--danger">
            <div class="c-stat-card__content">
                <div class="c-stat-card__value">{{ rejected_count }}</div>
                <div class="c-stat-card__label">Rejected Users</div>
            </div>
            <div class="c-stat-card__icon">
                <i class="ti ti-x-circle"></i>
            </div>
        </div>
        <div class="c-stat-card c-stat-card--info">
            <div class="c-stat-card__content">
                <div class="c-stat-card__value">{{ total_users }}</div>
                <div class="c-stat-card__label">Total Users</div>
            </div>
            <div class="c-stat-card__icon">
                <i class="ti ti-users"></i>
            </div>
        </div>
    </div>

    <!-- Filter and Actions -->
    <div class="l-container u-mb-4">
        <div class="c-card-modern">
            <div class="c-card-modern__header">
                <div class="c-card-modern__title">
                    <i class="ti ti-filter"></i>
                    <span>Filter Users</span>
                </div>
                <div class="c-card-modern__actions c-action-bar">
                    <button class="c-btn-modern c-btn-modern--secondary c-btn-modern--sm" data-action="back">
                        <i class="ti ti-arrow-left"></i>
                        <span>Back</span>
                    </button>
                    {% if pending_users %}
                    <button class="c-btn-modern c-btn-modern--success c-btn-modern--sm" data-action="approve-all">
                        <i class="ti ti-check-circle"></i>
                        <span>Approve All Pending</span>
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="c-card-modern__body">
                <form method="GET" class="c-form-modern">
                    <div class="c-form-modern__row">
                        <div class="c-form-modern__group">
                            <label for="status_filter" class="c-form-modern__label">Status</label>
                            <select class="c-form-modern__select" id="status_filter" name="status">
                                <option value="">All Users</option>
                                <option value="pending" {% if request.args.get('status') == 'pending' %}selected{% endif %}>Pending Approval</option>
                                <option value="approved" {% if request.args.get('status') == 'approved' %}selected{% endif %}>Approved</option>
                                <option value="rejected" {% if request.args.get('status') == 'rejected' %}selected{% endif %}>Rejected</option>
                            </select>
                        </div>
                        <div class="c-form-modern__group">
                            <label for="league_filter" class="c-form-modern__label">League</label>
                            <select class="c-form-modern__select" id="league_filter" name="league">
                                <option value="">All Leagues</option>
                                <option value="pl-premier" {% if request.args.get('league') == 'pl-premier' %}selected{% endif %}>PL Premier</option>
                                <option value="pl-classic" {% if request.args.get('league') == 'pl-classic' %}selected{% endif %}>PL Classic</option>
                            </select>
                        </div>
                        <div class="c-form-modern__group c-form-modern__group--grow">
                            <label for="search" class="c-form-modern__label">Search</label>
                            <input type="text" class="c-form-modern__input" id="search" name="search"
                                   placeholder="Search by name or email..." value="{{ request.args.get('search', '') }}">
                        </div>
                        <div class="c-form-modern__group c-form-modern__group--actions c-action-bar">
                            <button type="submit" class="c-btn-modern c-btn-modern--primary">Filter</button>
                            <a href="{{ url_for('admin_panel.user_approvals') }}" class="c-btn-modern c-btn-modern--secondary">Clear</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Pending Users -->
    {% if pending_users %}
    <div class="l-container u-mb-4">
        <div class="c-card-modern">
            <div class="c-card-modern__header">
                <div class="c-card-modern__title">
                    <i class="ti ti-user-check"></i>
                    <span>Pending Approvals ({{ pending_users|length }})</span>
                </div>
            </div>
            <div class="c-card-modern__body c-card-modern__body--no-padding">
                <div class="c-table-modern__wrapper">
                    <table class="c-table-modern" data-mobile-table data-table-type="users">
                        <thead class="c-table-modern__header">
                            <tr class="c-table-modern__row">
                                <th class="c-table-modern__cell c-table-modern__cell--header">User</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Email</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Discord</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Registered</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">League Interest</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="c-table-modern__body">
                            {% for user in pending_users %}
                            <tr class="c-table-modern__row" data-user-id="{{ user.id }}">
                                <td class="c-table-modern__cell" data-label="User">
                                    <div class="c-user-avatar">
                                        <div class="c-user-avatar__image c-user-avatar__image--primary">
                                            {{ (user.name or user.username)[0].upper() }}
                                        </div>
                                        <div class="c-user-avatar__info">
                                            <div class="c-user-avatar__name">{{ user.name or user.username }}</div>
                                            {% if user.name and user.username and user.name != user.username %}
                                            <div class="c-user-avatar__meta">@{{ user.username }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="c-table-modern__cell" data-label="Email">
                                    <span class="u-text-sm">{{ user.email or 'Not provided' }}</span>
                                </td>
                                <td class="c-table-modern__cell" data-label="Discord">
                                    {% if user.discord_id %}
                                    <span class="c-badge c-badge--success">
                                        <i class="ti ti-brand-discord"></i>
                                        <span>Connected</span>
                                    </span>
                                    {% else %}
                                    <span class="c-badge c-badge--warning">
                                        <i class="ti ti-unlink"></i>
                                        <span>Not Connected</span>
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="c-table-modern__cell" data-label="Registered">
                                    <span class="u-text-sm u-text-muted">
                                        {{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'Unknown' }}
                                    </span>
                                </td>
                                <td class="c-table-modern__cell" data-label="League Interest">
                                    {% if user.player and user.player.league_interest %}
                                    <span class="c-badge c-badge--info">{{ user.player.league_interest }}</span>
                                    {% else %}
                                    <span class="u-text-muted">Not specified</span>
                                    {% endif %}
                                </td>
                                <td class="c-table-modern__cell" data-label="Actions">
                                    <div class="c-btn-group">
                                        <button class="c-btn-modern c-btn-modern--info c-btn-modern--sm c-btn-modern--icon"
                                                data-action="view-user"
                                                data-user-id="{{ user.id }}"
                                                data-user-name="{{ user.name or user.username }}" aria-label="View"><i class="ti ti-eye"></i></button>
                                        <button class="c-btn-modern c-btn-modern--success c-btn-modern--sm c-btn-modern--icon"
                                                data-action="approve-user"
                                                data-user-id="{{ user.id }}"
                                                data-user-name="{{ user.name or user.username }}" aria-label="Confirm"><i class="ti ti-check"></i></button>
                                        <button class="c-btn-modern c-btn-modern--danger c-btn-modern--sm c-btn-modern--icon"
                                                data-action="reject-user"
                                                data-user-id="{{ user.id }}"
                                                data-user-name="{{ user.name or user.username }}" aria-label="Button"><i class="ti ti-x"></i></button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- All Users (filtered) -->
    {% if filtered_users %}
    <div class="l-container">
        <div class="c-card-modern">
            <div class="c-card-modern__header">
                <div class="c-card-modern__title">
                    <i class="ti ti-users"></i>
                    <span>{{ status_title or 'All Users' }} ({{ filtered_users|length }})</span>
                </div>
            </div>
            <div class="c-card-modern__body c-card-modern__body--no-padding">
                <div class="c-table-modern__wrapper">
                    <table class="c-table-modern" data-mobile-table data-table-type="users">
                        <thead class="c-table-modern__header">
                            <tr class="c-table-modern__row">
                                <th class="c-table-modern__cell c-table-modern__cell--header">User</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Email</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Status</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Discord</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Registered</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">League</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="c-table-modern__body">
                            {% for user in filtered_users %}
                            <tr class="c-table-modern__row" data-user-id="{{ user.id }}">
                                <td class="c-table-modern__cell" data-label="User">
                                    <div class="c-user-avatar">
                                        <div class="c-user-avatar__image c-user-avatar__image--primary">
                                            {{ (user.name or user.username)[0].upper() }}
                                        </div>
                                        <div class="c-user-avatar__info">
                                            <div class="c-user-avatar__name">{{ user.name or user.username }}</div>
                                            {% if user.name and user.username and user.name != user.username %}
                                            <div class="c-user-avatar__meta">@{{ user.username }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="c-table-modern__cell" data-label="Email">
                                    <span class="u-text-sm">{{ user.email or 'Not provided' }}</span>
                                </td>
                                <td class="c-table-modern__cell" data-label="Status">
                                    {% if user.is_approved %}
                                    <span class="c-badge c-badge--success">Approved</span>
                                    {% else %}
                                    <span class="c-badge c-badge--warning">Pending</span>
                                    {% endif %}
                                </td>
                                <td class="c-table-modern__cell" data-label="Discord">
                                    {% if user.discord_id %}
                                    <span class="c-badge c-badge--success">
                                        <i class="ti ti-brand-discord"></i>
                                        <span>Connected</span>
                                    </span>
                                    {% else %}
                                    <span class="c-badge c-badge--warning">
                                        <i class="ti ti-unlink"></i>
                                        <span>Not Connected</span>
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="c-table-modern__cell" data-label="Registered">
                                    <span class="u-text-sm u-text-muted">
                                        {{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'Unknown' }}
                                    </span>
                                </td>
                                <td class="c-table-modern__cell" data-label="League">
                                    {% if user.player and user.player.league_interest %}
                                    <span class="c-badge c-badge--info">{{ user.player.league_interest }}</span>
                                    {% else %}
                                    <span class="u-text-muted">Not specified</span>
                                    {% endif %}
                                </td>
                                <td class="c-table-modern__cell" data-label="Actions">
                                    <div class="c-btn-group">
                                        <button class="c-btn-modern c-btn-modern--info c-btn-modern--sm c-btn-modern--icon"
                                                data-action="view-user"
                                                data-user-id="{{ user.id }}"
                                                data-user-name="{{ user.name or user.username }}" aria-label="View"><i class="ti ti-eye"></i></button>
                                        {% if not user.is_approved %}
                                        <button class="c-btn-modern c-btn-modern--success c-btn-modern--sm c-btn-modern--icon"
                                                data-action="approve-user"
                                                data-user-id="{{ user.id }}"
                                                data-user-name="{{ user.name or user.username }}" aria-label="Confirm"><i class="ti ti-check"></i></button>
                                        <button class="c-btn-modern c-btn-modern--danger c-btn-modern--sm c-btn-modern--icon"
                                                data-action="reject-user"
                                                data-user-id="{{ user.id }}"
                                                data-user-name="{{ user.name or user.username }}" aria-label="Button"><i class="ti ti-x"></i></button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if not pending_users and not filtered_users %}
    <div class="l-container">
        <div class="c-card-modern">
            <div class="c-card-modern__body c-empty-state">
                <i class="ti ti-user-search c-empty-state__icon"></i>
                <h5 class="c-empty-state__title">No users found</h5>
                <p class="c-empty-state__text">No users match your current filter criteria.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- User Details Modal -->
    <div class="c-modal" id="userDetailsModal" tabindex="-1" aria-labelledby="user_details_title">
        <div class="c-modal__dialog c-modal__dialog--lg">
            <div class="c-modal__content">
                <div class="c-modal__header">
                    <h5 class="c-modal__title" id="user_details_title">User Details</h5>
                    <button type="button" class="c-modal__close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="c-modal__body" id="user_details_content">
                    <!-- User details will be loaded here -->
                </div>
                <div class="c-modal__footer">
                    <button type="button" class="c-btn-modern c-btn-modern--secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block custom_css %}
{{ super() }}
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
// Event delegation for all user actions
document.addEventListener('click', function(e) {
    const target = e.target.closest('[data-action]');
    if (!target) return;

    const action = target.dataset.action;
    const userId = target.dataset.userId;
    const userName = target.dataset.userName;

    switch(action) {
        case 'back':
            window.history.back();
            break;
        case 'approve-all':
            approveAllPending();
            break;
        case 'view-user':
            viewUserDetails(userId, userName);
            break;
        case 'approve-user':
            approveUser(userId, userName);
            break;
        case 'reject-user':
            rejectUser(userId, userName);
            break;
    }
});

function viewUserDetails(userId, userName) {
    document.getElementById('user_details_title').textContent = `Details for ${userName}`;
    document.getElementById('user_details_content').innerHTML = '<div class="text-center"><div class="spinner-border" role="status" data-spinner></div></div>';

    ModalManager.show('userDetailsModal');
    
    // Load user details via AJAX
    fetch(`{{ url_for('admin_panel.get_user_details') }}?user_id=${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('user_details_content').innerHTML = data.html;
            } else {
                document.getElementById('user_details_content').innerHTML = '<div class="alert alert-danger" data-alert>Error loading user details</div>';
            }
        })
        .catch(error => {
            document.getElementById('user_details_content').innerHTML = '<div class="alert alert-danger" data-alert>Error loading user details</div>';
        });
}

function approveUser(userId, userName) {
    Swal.fire({
        title: 'Approve User?',
        text: `Are you sure you want to approve "${userName}"?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('success') : '#28a745',
        cancelButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('secondary') : '#6c757d',
        confirmButtonText: 'Yes, approve!'
    }).then((result) => {
        if (result.isConfirmed) {
            submitUserAction('approve', userId);
        }
    });
}

function rejectUser(userId, userName) {
    Swal.fire({
        title: 'Reject User?',
        text: `Are you sure you want to reject "${userName}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('danger') : '#dc3545',
        cancelButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('secondary') : '#6c757d',
        confirmButtonText: 'Yes, reject!'
    }).then((result) => {
        if (result.isConfirmed) {
            submitUserAction('reject', userId);
        }
    });
}

function approveAllPending() {
    const pendingCount = {{ pending_users|length }};
    Swal.fire({
        title: 'Approve All Pending Users?',
        text: `This will approve ${pendingCount} pending users. This action cannot be undone.`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('success') : '#28a745',
        cancelButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('secondary') : '#6c757d',
        confirmButtonText: 'Yes, approve all!'
    }).then((result) => {
        if (result.isConfirmed) {
            submitUserAction('approve_all', null);
        }
    });
}

function submitUserAction(action, userId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `{{ url_for('admin_panel.process_user_approval') }}`;
    
    const _csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrf_token';
    csrfToken.value = '{{ csrf_token() }}';
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = action;
    
    form.appendChild(csrfToken);
    form.appendChild(actionInput);
    
    if (userId) {
        const userIdInput = document.createElement('input');
        userIdInput.type = 'hidden';
        userIdInput.name = 'user_id';
        userIdInput.value = userId;
        form.appendChild(userIdInput);
    }
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}