{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert, stat_card %}

{% block admin_title %}User Analytics{% endblock %}
{% block panel_description %}Track user registration trends and engagement metrics{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.user_management') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">User Management</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Analytics</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Analytics Overview Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
    <!-- Total Users -->
    <div class="rounded-lg p-5 bg-ecs-green text-white">
        <div class="flex justify-between items-start">
            <div>
                <h3 class="text-2xl font-bold">{{ "{:,}".format(analytics_data.overview.total_users) }}</h3>
                <p class="text-sm text-white/80">Total Users</p>
            </div>
            <i class="ti ti-users text-4xl text-white/50"></i>
        </div>
        <div class="mt-3 flex items-center text-sm text-white/70">
            <i class="ti ti-trending-up mr-1"></i>
            +{{ analytics_data.overview.new_users_30d }} this month
        </div>
    </div>

    <!-- Active Users -->
    <div class="rounded-lg p-5 bg-green-500 text-white">
        <div class="flex justify-between items-start">
            <div>
                <h3 class="text-2xl font-bold">{{ "{:,}".format(analytics_data.overview.active_users) }}</h3>
                <p class="text-sm text-white/80">Active Users</p>
            </div>
            <i class="ti ti-user-check text-4xl text-white/50"></i>
        </div>
        <div class="mt-3 flex items-center text-sm text-white/70">
            <i class="ti ti-activity mr-1"></i>
            {{ analytics_data.overview.growth_rate_30d }}% growth rate
        </div>
    </div>

    <!-- Pending Approvals -->
    <div class="rounded-lg p-5 bg-yellow-500 text-white">
        <div class="flex justify-between items-start">
            <div>
                <h3 class="text-2xl font-bold">{{ analytics_data.approvals.pending }}</h3>
                <p class="text-sm text-white/80">Pending Approvals</p>
            </div>
            <i class="ti ti-clock text-4xl text-white/50"></i>
        </div>
        <div class="mt-3 flex items-center text-sm text-white/70">
            <i class="ti ti-percentage mr-1"></i>
            {{ analytics_data.approvals.approval_rate }}% approval rate
        </div>
    </div>

    <!-- Discord Connected -->
    <div class="rounded-lg p-5 bg-blue-500 text-white">
        <div class="flex justify-between items-start">
            <div>
                <h3 class="text-2xl font-bold">{{ analytics_data.engagement.discord_connected }}</h3>
                <p class="text-sm text-white/80">Discord Connected</p>
            </div>
            <i class="ti ti-brand-discord text-4xl text-white/50"></i>
        </div>
        <div class="mt-3 flex items-center text-sm text-white/70">
            <i class="ti ti-link mr-1"></i>
            Integration active
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Registration Trends Chart -->
    <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                <i class="ti ti-chart-line text-gray-400"></i>
                User Registration Trends
            </h3>
            <div class="flex rounded-lg overflow-hidden border border-gray-300 dark:border-gray-600">
                <button type="button" class="px-3 py-1.5 text-xs font-medium bg-ecs-green text-white" data-period="30d">30 Days</button>
                <button type="button" class="px-3 py-1.5 text-xs font-medium bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600" data-period="90d">90 Days</button>
                <button type="button" class="px-3 py-1.5 text-xs font-medium bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600" data-period="12m">12 Months</button>
            </div>
        </div>
        <div class="p-6">
            <canvas id="registrationTrendsChart" height="200"></canvas>
        </div>
    </div>

    <!-- Approval Status Chart -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                <i class="ti ti-chart-pie text-gray-400"></i>
                Approval Status
            </h3>
        </div>
        <div class="p-6">
            <canvas id="approvalStatusChart" height="200"></canvas>
            <div class="mt-4 space-y-2">
                <div class="flex justify-between items-center text-sm">
                    <span class="text-gray-500 dark:text-gray-400">Processing Rate:</span>
                    <span class="font-medium text-gray-900 dark:text-white">{{ analytics_data.approval_analytics.processing_rate }}</span>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <span class="text-gray-500 dark:text-gray-400">Avg. Wait Time:</span>
                    <span class="font-medium text-gray-900 dark:text-white">{{ analytics_data.approval_analytics.avg_processing_time }}</span>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <span class="text-gray-500 dark:text-gray-400">Backlog Trend:</span>
                    <span class="font-medium {% if 'Decreasing' in analytics_data.approval_analytics.backlog_trend %}text-green-600 dark:text-green-400{% elif 'Increasing' in analytics_data.approval_analytics.backlog_trend %}text-yellow-600 dark:text-yellow-400{% else %}text-blue-600 dark:text-blue-400{% endif %}">
                        {{ analytics_data.approval_analytics.backlog_trend }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Role and League Distribution -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Role Distribution -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                <i class="ti ti-shield text-gray-400"></i>
                Role Distribution
            </h3>
            <button type="button" class="px-3 py-1.5 text-sm font-medium text-ecs-green bg-white border border-ecs-green rounded-lg hover:bg-ecs-green/10 dark:bg-gray-700" data-action="export-role-data">
                <i class="ti ti-download mr-1"></i>Export
            </button>
        </div>
        <div class="p-6 max-h-80 overflow-y-auto">
            {% for role, count in analytics_data.role_distribution.items() %}
            <div class="flex items-center justify-between py-3 {% if not loop.last %}border-b border-gray-100 dark:border-gray-700{% endif %}">
                <div>
                    <p class="font-medium text-gray-900 dark:text-white">{{ role }}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">{{ (count / analytics_data.overview.total_users * 100)|round(1) }}% of users</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div class="bg-ecs-green h-2 rounded-full" style="width: {{ (count / analytics_data.overview.total_users * 100)|round(1) }}%"></div>
                    </div>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-ecs-green/10 text-ecs-green dark:bg-ecs-green/20">
                        {{ count }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- League Distribution -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                <i class="ti ti-trophy text-gray-400"></i>
                League Distribution
            </h3>
            <button type="button" class="px-3 py-1.5 text-sm font-medium text-ecs-green bg-white border border-ecs-green rounded-lg hover:bg-ecs-green/10 dark:bg-gray-700" data-action="export-league-data">
                <i class="ti ti-download mr-1"></i>Export
            </button>
        </div>
        <div class="p-6">
            {% if analytics_data.league_distribution %}
            <div class="space-y-4">
                {% for league, count in analytics_data.league_distribution.items() %}
                <div class="flex items-center justify-between py-3 {% if not loop.last %}border-b border-gray-100 dark:border-gray-700{% endif %}">
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white">{{ league|title }} League</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">{{ (count / analytics_data.approvals.approved * 100)|round(1) if analytics_data.approvals.approved > 0 else 0 }}% of approved</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: {{ (count / analytics_data.approvals.approved * 100)|round(1) if analytics_data.approvals.approved > 0 else 0 }}%"></div>
                        </div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">
                            {{ count }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="ti ti-trophy text-5xl text-gray-300 dark:text-gray-600"></i>
                <p class="text-gray-500 dark:text-gray-400 mt-2">No league assignments yet</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Engagement and Activity Metrics -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- User Engagement Metrics -->
    <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                <i class="ti ti-activity text-gray-400"></i>
                User Engagement Metrics
            </h3>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Users with Player Profiles -->
                <div class="text-center p-4 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                    <p class="text-3xl font-bold text-ecs-green">{{ analytics_data.engagement.users_with_players }}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Users with Player Profiles</p>
                    <div class="mt-3">
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-ecs-green h-2 rounded-full" style="width: {{ (analytics_data.engagement.users_with_players / analytics_data.overview.total_users * 100)|round(1) if analytics_data.overview.total_users > 0 else 0 }}%"></div>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ (analytics_data.engagement.users_with_players / analytics_data.overview.total_users * 100)|round(1) if analytics_data.overview.total_users > 0 else 0 }}%</p>
                    </div>
                </div>

                <!-- Users with Roles -->
                <div class="text-center p-4 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                    <p class="text-3xl font-bold text-green-500">{{ analytics_data.engagement.users_with_roles }}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Users with Roles</p>
                    <div class="mt-3">
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: {{ (analytics_data.engagement.users_with_roles / analytics_data.overview.total_users * 100)|round(1) if analytics_data.overview.total_users > 0 else 0 }}%"></div>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ (analytics_data.engagement.users_with_roles / analytics_data.overview.total_users * 100)|round(1) if analytics_data.overview.total_users > 0 else 0 }}%</p>
                    </div>
                </div>

                <!-- Discord Connected -->
                <div class="text-center p-4 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                    <p class="text-3xl font-bold text-blue-500">{{ analytics_data.engagement.discord_connected }}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Discord Connected</p>
                    <div class="mt-3">
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: {{ (analytics_data.engagement.discord_connected / analytics_data.overview.total_users * 100)|round(1) if analytics_data.overview.total_users > 0 else 0 }}%"></div>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ (analytics_data.engagement.discord_connected / analytics_data.overview.total_users * 100)|round(1) if analytics_data.overview.total_users > 0 else 0 }}%</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Activity -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                <i class="ti ti-users text-gray-400"></i>
                Admin Activity
            </h3>
        </div>
        <div class="p-6">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-100 dark:border-gray-700">
                <span class="text-sm text-gray-500 dark:text-gray-400">Recent Actions (30d):</span>
                <span class="text-lg font-bold text-ecs-green">{{ analytics_data.activity.recent_activity }}</span>
            </div>
            {% if analytics_data.activity.admin_activity %}
            <div>
                <h6 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-3">Most Active Admins:</h6>
                <div class="space-y-2">
                    {% for activity in analytics_data.activity.admin_activity[:5] %}
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-700 dark:text-gray-300">Admin {{ activity.user_id }}</span>
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                            {{ activity.count }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="ti ti-user-x text-4xl text-gray-300 dark:text-gray-600"></i>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">No recent admin activity</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Export Analytics -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
            <i class="ti ti-download text-gray-400"></i>
            Export Analytics
        </h3>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <button type="button" class="w-full px-4 py-3 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green/90 transition-colors flex items-center justify-center gap-2" data-action="export-analytics" data-export-type="users" data-export-format="csv">
                <i class="ti ti-file-csv"></i>
                Export Users (CSV)
            </button>
            <button type="button" class="w-full px-4 py-3 text-sm font-medium text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2" data-action="export-analytics" data-export-type="roles" data-export-format="csv">
                <i class="ti ti-file-csv"></i>
                Export Roles (CSV)
            </button>
            <button type="button" class="w-full px-4 py-3 text-sm font-medium text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center gap-2" data-action="export-analytics" data-export-type="activity" data-export-format="json">
                <i class="ti ti-file-code"></i>
                Export Activity (JSON)
            </button>
            <button type="button" class="w-full px-4 py-3 text-sm font-medium text-white bg-yellow-500 rounded-lg hover:bg-yellow-600 transition-colors flex items-center justify-center gap-2" data-action="generate-report">
                <i class="ti ti-report"></i>
                Generate Report
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');
    const textColor = isDark ? '#9ca3af' : '#6b7280';
    const gridColor = isDark ? '#374151' : '#e5e7eb';

    // Registration Trends Chart
    const registrationCtx = document.getElementById('registrationTrendsChart');
    if (registrationCtx) {
        const trendsData = {{ analytics_data.registration_trends|tojson }};
        new Chart(registrationCtx, {
            type: 'line',
            data: {
                labels: trendsData.map(d => d.date || d.period),
                datasets: [{
                    label: 'New Registrations',
                    data: trendsData.map(d => d.count),
                    borderColor: '#1a472a',
                    backgroundColor: 'rgba(26, 71, 42, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: { color: gridColor },
                        ticks: { color: textColor }
                    },
                    y: {
                        grid: { color: gridColor },
                        ticks: { color: textColor }
                    }
                }
            }
        });
    }

    // Approval Status Chart
    const approvalCtx = document.getElementById('approvalStatusChart');
    if (approvalCtx) {
        const approvalsData = {{ analytics_data.approvals|tojson }};
        new Chart(approvalCtx, {
            type: 'doughnut',
            data: {
                labels: ['Approved', 'Pending', 'Denied'],
                datasets: [{
                    data: [approvalsData.approved, approvalsData.pending, approvalsData.denied],
                    backgroundColor: ['#22c55e', '#eab308', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: textColor }
                    }
                }
            }
        });
    }

    // Period toggle buttons
    document.querySelectorAll('[data-period]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-period]').forEach(b => {
                b.classList.remove('bg-ecs-green', 'text-white');
                b.classList.add('bg-white', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });
            this.classList.remove('bg-white', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            this.classList.add('bg-ecs-green', 'text-white');
            // TODO: Reload chart data for selected period
        });
    });

    // Export actions
    document.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.dataset.action;
            if (action === 'export-analytics') {
                const type = this.dataset.exportType;
                const format = this.dataset.exportFormat;
                console.log(`Exporting ${type} as ${format}`);
                // TODO: Implement export functionality
            } else if (action === 'generate-report') {
                console.log('Generating report');
                // TODO: Implement report generation
            }
        });
    });
});
</script>
{% endblock %}
