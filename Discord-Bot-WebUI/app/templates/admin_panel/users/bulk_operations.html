{% extends "admin_panel/base.html" %}

{% block title %}Bulk Operations - User Management{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_panel.user_management') }}">User Management</a></li>
<li class="breadcrumb-item active">Bulk Operations</li>
{% endblock %}

{% block panel_content %}

<!-- Bulk Operations Overview -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card bg-warning text-white">
            <div class="c-card__body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="c-card__title text-white mb-1">{{ bulk_stats.pending_users }}</h5>
                        <p class="c-card__description small opacity-75 mb-0">Pending Approvals</p>
                    </div>
                    <div class="card-icon">
                        <i class="ti ti-clock card-icon-stat"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card bg-info text-white">
            <div class="c-card__body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="c-card__title text-white mb-1">{{ bulk_stats.waitlist_users }}</h5>
                        <p class="c-card__description small opacity-75 mb-0">Waitlist Users</p>
                    </div>
                    <div class="card-icon">
                        <i class="ti ti-users card-icon-stat"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card bg-success text-white">
            <div class="c-card__body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="c-card__title text-white mb-1">{{ bulk_stats.total_roles }}</h5>
                        <p class="c-card__description small opacity-75 mb-0">Available Roles</p>
                    </div>
                    <div class="card-icon">
                        <i class="ti ti-shield card-icon-stat"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="c-card bg-primary text-white">
            <div class="c-card__body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="c-card__title text-white mb-1">{{ bulk_stats.recent_operations }}</h5>
                        <p class="c-card__description small opacity-75 mb-0">Recent Operations</p>
                    </div>
                    <div class="card-icon">
                        <i class="ti ti-activity card-icon-stat"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Operations Actions -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-user-check me-2"></i>Bulk Approvals
                </h5>
            </div>
            <div class="c-card__body">
                <p class="c-card__description">Approve multiple pending users at once with league assignments.</p>
                <div class="d-grid gap-2">
                    <button type="button" class="c-btn c-btn--primary js-show-bulk-approval-modal" data-action="show-bulk-approval-modal">
                        <i class="ti ti-users me-2"></i>Bulk Approve Users
                    </button>
                    <button type="button" class="c-btn c-btn--outline-primary js-load-pending-users" data-action="load-pending-users">
                        <i class="ti ti-list me-2"></i>View Pending Users
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-shield me-2"></i>Role Management
                </h5>
            </div>
            <div class="c-card__body">
                <p class="c-card__description">Assign, remove, or replace roles for multiple users simultaneously.</p>
                <div class="d-grid gap-2">
                    <button type="button" class="c-btn c-btn--success js-show-bulk-role-modal" data-action="show-bulk-role-modal">
                        <i class="ti ti-shield-plus me-2"></i>Bulk Role Assignment
                    </button>
                    <button type="button" class="c-btn c-btn--outline-success js-view-role-distribution" data-action="view-role-distribution">
                        <i class="ti ti-chart-pie me-2"></i>Role Distribution
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-list-check me-2"></i>Waitlist Management
                </h5>
            </div>
            <div class="c-card__body">
                <p class="c-card__description">Process waitlist users in bulk to move them to pending approval.</p>
                <div class="d-grid gap-2">
                    <button type="button" class="c-btn c-btn--info js-show-bulk-waitlist-modal" data-action="show-bulk-waitlist-modal">
                        <i class="ti ti-arrow-right me-2"></i>Process Waitlist
                    </button>
                    <button type="button" class="c-btn c-btn--outline-info js-load-waitlist-users" data-action="load-waitlist-users">
                        <i class="ti ti-eye me-2"></i>View Waitlist
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Bulk Operations -->
<div class="row mb-4">
    <div class="col-12">
        <div class="c-card">
            <div class="c-card__header d-flex justify-content-between align-items-center">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-history me-2"></i>Recent Bulk Operations
                </h5>
                <button type="button" class="c-btn c-btn--outline-primary c-btn--sm js-refresh-operation-history" data-action="refresh-operation-history">
                    <i class="ti ti-refresh me-1"></i>Refresh
                </button>
            </div>
            <div class="c-card__body">
                {% if recent_bulk_ops %}
                <div class="c-table-wrapper" data-table-responsive>
                    <table class="c-table c-table--hoverable" data-table data-mobile-table data-table-type="users">
                        <thead scope="col">
                            <tr>
                                <th scope="col">Operation</th>
                                <th scope="col">Admin</th>
                                <th scope="col">Details</th>
                                <th scope="col">Date</th>
                                <th scope="col">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for op in recent_bulk_ops %}
                            <tr>
                                <td>
                                    <span class="badge bg-primary" data-badge>{{ op.action|title }}</span>
                                </td>
                                <td>{{ op.user.username if op.user else 'System' }}</td>
                                <td>{{ op.new_value or op.details or 'No details' }}</td>
                                <td>
                                    <small>{{ op.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-success" data-badge>Completed</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="ti ti-inbox icon-empty-state"></i>
                    <p class="text-muted mt-2">No recent bulk operations found</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Role Distribution Chart -->
<div class="row">
    <div class="col-12">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-chart-donut me-2"></i>Role Distribution
                </h5>
            </div>
            <div class="c-card__body">
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="roleDistributionChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-4">
                        <div class="role-stats">
                            {% for role, count in role_stats.items() %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <strong>{{ role }}</strong>
                                </div>
                                <div>
                                    <span class="badge bg-primary" data-badge>{{ count }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block modals %}
{{ super() }}
<!-- Bulk Approval Modal -->
<div class="modal c-modal fade" id="bulkApprovalModal" tabindex="-1" data-modal aria-labelledby="bulkApprovalModalLabel">
    <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="bulkApprovalModalLabel">Bulk User Approval</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body>
                <div id="bulkApprovalContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status" data-spinner>
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading pending users...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="button" class="c-btn c-btn--primary js-process-bulk-approval" data-action="process-bulk-approval" id="bulkApprovalBtn" disabled>
                    <i class="ti ti-check me-2"></i>Approve Selected
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Role Assignment Modal -->
<div class="modal c-modal fade" id="bulkRoleModal" tabindex="-1" data-modal aria-labelledby="bulkRoleModalLabel">
    <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="bulkRoleModalLabel">Bulk Role Assignment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body>
                <div id="bulkRoleContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status" data-spinner>
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading role assignment interface...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="button" class="c-btn c-btn--success js-process-bulk-role-assignment" data-action="process-bulk-role-assignment" id="bulkRoleBtn" disabled>
                    <i class="ti ti-shield-plus me-2"></i>Assign Roles
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Waitlist Processing Modal -->
<div class="modal c-modal fade" id="bulkWaitlistModal" tabindex="-1" data-modal aria-labelledby="bulkWaitlistModalLabel">
    <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="bulkWaitlistModalLabel">Bulk Waitlist Processing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body>
                <div id="bulkWaitlistContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status" data-spinner>
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading waitlist users...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer>
                <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="button" class="c-btn c-btn--info js-process-bulk-waitlist" data-action="process-bulk-waitlist" id="bulkWaitlistBtn" disabled>
                    <i class="ti ti-arrow-right me-2"></i>Process Selected
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Bulk Operations Module (extracted from inline JS) -->
<script src="{{ url_for('static', filename='custom_js/bulk-operations.js') }}"></script>
<script>
// Initialize BulkOperations with template data
BulkOperations.init({
    roleStats: {{ role_stats|tojson }},
    roles: {{ roles|tojson }},
    bulkStats: {
        pending_users: {{ bulk_stats.pending_users }},
        waitlist_users: {{ bulk_stats.waitlist_users }}
    },
    urls: {
        bulkApprove: '/admin-panel/users/bulk-operations/approve',
        bulkRoleAssign: '/admin-panel/users/bulk-operations/role-assign',
        bulkWaitlistProcess: '/admin-panel/users/bulk-operations/waitlist-process',
        userApprovals: '{{ url_for("admin_panel.user_approvals") }}',
        userWaitlist: '{{ url_for("admin_panel.user_waitlist") }}',
        rolesManagement: '{{ url_for("admin_panel.roles_management") }}'
    }
});
</script>
{% endif %}
{% endblock %}