{% extends "admin_panel/base.html" %}
{% import 'macros.html' as macros %}

{% block title %}Waitlist Management - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin_panel.user_management') }}">User Management</a>
</li>
<li class="breadcrumb-item active">Waitlist Management</li>
{% endblock %}

{% block panel_content %}

    <!-- Waitlist Overview -->
    <div class="l-grid l-grid--4-col u-mb-4">
        <div class="c-stat-card c-stat-card--warning">
            <div class="c-stat-card__content">
                <div class="c-stat-card__value">{{ waitlist_users|length }}</div>
                <div class="c-stat-card__label">Total Waitlist</div>
            </div>
            <div class="c-stat-card__icon">
                <i class="ti ti-clipboard-list"></i>
            </div>
        </div>
        <div class="c-stat-card c-stat-card--info">
            <div class="c-stat-card__content">
                <div class="c-stat-card__value">{{ recent_waitlist|length }}</div>
                <div class="c-stat-card__label">New This Week</div>
            </div>
            <div class="c-stat-card__icon">
                <i class="ti ti-user-plus"></i>
            </div>
        </div>
        <div class="c-stat-card c-stat-card--success">
            <div class="c-stat-card__content">
                <div class="c-stat-card__value">{{ processed_count or 0 }}</div>
                <div class="c-stat-card__label">Processed This Month</div>
            </div>
            <div class="c-stat-card__icon">
                <i class="ti ti-check-circle"></i>
            </div>
        </div>
        <div class="c-stat-card c-stat-card--primary">
            <div class="c-stat-card__content">
                <div class="c-stat-card__value">{{ avg_wait_time or 'N/A' }}</div>
                <div class="c-stat-card__label">Avg Wait Time</div>
            </div>
            <div class="c-stat-card__icon">
                <i class="ti ti-clock"></i>
            </div>
        </div>
    </div>

    <!-- Waitlist Management Actions -->
    <div class="l-container u-mb-4">
        <div class="c-card-modern">
            <div class="c-card-modern__header">
                <div class="c-card-modern__title">
                    <i class="ti ti-clipboard-list"></i>
                    <span>Waitlist Queue</span>
                </div>
                <div class="c-card-modern__actions">
                    <button class="c-btn-modern c-btn-modern--secondary c-btn-modern--sm" data-action="back">
                        <i class="ti ti-arrow-left"></i>
                        <span>Back</span>
                    </button>
                    <button class="c-btn-modern c-btn-modern--success c-btn-modern--sm" data-action="process-all"
                            {% if not waitlist_users %}disabled{% endif %}>
                        <i class="ti ti-check-circle"></i>
                        <span>Process All</span>
                    </button>
                </div>
            </div>
            <div class="c-card-modern__body c-card-modern__body--no-padding">
                {% if waitlist_users %}
                <div class="c-table-modern__wrapper">
                    <table class="c-table-modern">
                        <thead class="c-table-modern__header">
                            <tr class="c-table-modern__row">
                                <th class="c-table-modern__cell c-table-modern__cell--header">
                                    <input type="checkbox" class="c-form-modern__checkbox" data-action="toggle-select-all">
                                </th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">User</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Contact</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Joined Waitlist</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Wait Time</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">League Interest</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Priority</th>
                                <th class="c-table-modern__cell c-table-modern__cell--header">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="c-table-modern__body">
                            {% for user in waitlist_users %}
                            <tr class="c-table-modern__row" data-user-id="{{ user.id }}">
                                <td class="c-table-modern__cell" data-label="">
                                    <input type="checkbox" class="c-form-modern__checkbox js-user-checkbox" value="{{ user.id }}">
                                </td>
                                <td class="c-table-modern__cell" data-label="User">
                                    <div class="c-user-avatar">
                                        <div class="c-user-avatar__image c-user-avatar__image--primary">
                                            {{ (user.name or user.username or 'U')[0].upper() }}
                                        </div>
                                        <div class="c-user-avatar__info">
                                            <div class="c-user-avatar__name">{{ user.name or user.username or 'Unknown' }}</div>
                                            {% if user.discord_id %}
                                            <div class="c-user-avatar__meta u-text-success">Discord Connected</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="c-table-modern__cell" data-label="Contact">
                                    <div class="u-stack u-stack--sm">
                                        {% if user.email %}
                                        <div class="u-text-sm"><i class="ti ti-mail"></i> {{ user.email }}</div>
                                        {% endif %}
                                        {% if user.discord_username %}
                                        <div class="u-text-sm"><i class="ti ti-brand-discord"></i> {{ user.discord_username }}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="c-table-modern__cell" data-label="Joined Waitlist">
                                    <span class="u-text-sm">{{ user.waitlist_joined_at.strftime('%Y-%m-%d %H:%M') if user.waitlist_joined_at else user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'Unknown' }}</span>
                                </td>
                                <td class="c-table-modern__cell" data-label="Wait Time">
                                    {% set wait_days = ((now - (user.waitlist_joined_at or user.created_at)).days) if (user.waitlist_joined_at or user.created_at) else 0 %}
                                    <span class="c-badge c-badge--{% if wait_days > 30 %}danger{% elif wait_days > 14 %}warning{% else %}info{% endif %}">
                                        {{ wait_days }} days
                                    </span>
                                </td>
                                <td class="c-table-modern__cell" data-label="League Interest">
                                    <span class="c-badge c-badge--secondary">{{ user.preferred_league or 'Any' }}</span>
                                </td>
                                <td class="c-table-modern__cell" data-label="Priority">
                                    {% if wait_days > 30 %}
                                    <span class="c-badge c-badge--danger">High</span>
                                    {% elif wait_days > 14 %}
                                    <span class="c-badge c-badge--warning">Medium</span>
                                    {% else %}
                                    <span class="c-badge c-badge--info">Normal</span>
                                    {% endif %}
                                </td>
                                <td class="c-table-modern__cell" data-label="Actions">
                                    <div class="c-btn-group">
                                        <button class="c-btn-modern c-btn-modern--info c-btn-modern--sm c-btn-modern--icon"
                                                data-action="view-user"
                                                data-user-id="{{ user.id }}"
                                                data-user-name="{{ user.name or user.username }}">
                                            <i class="ti ti-eye"></i>
                                        </button>
                                        <button class="c-btn-modern c-btn-modern--success c-btn-modern--sm c-btn-modern--icon"
                                                data-action="process-user"
                                                data-user-id="{{ user.id }}"
                                                data-user-name="{{ user.name or user.username }}">
                                            <i class="ti ti-check"></i>
                                        </button>
                                        <button class="c-btn-modern c-btn-modern--danger c-btn-modern--sm c-btn-modern--icon"
                                                data-action="remove-user"
                                                data-user-id="{{ user.id }}"
                                                data-user-name="{{ user.name or user.username }}">
                                            <i class="ti ti-x"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="c-empty-state">
                    <i class="ti ti-clipboard-x c-empty-state__icon"></i>
                    <h5 class="c-empty-state__title">No users in waitlist</h5>
                    <p class="c-empty-state__text">The waitlist is currently empty.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Waitlist Settings -->
    <div class="l-grid l-grid--2-col">
        <div class="c-card-modern">
            <div class="c-card-modern__header">
                <div class="c-card-modern__title">
                    <i class="ti ti-settings"></i>
                    <span>Waitlist Settings</span>
                </div>
            </div>
            <div class="c-card-modern__body c-card-modern__body--no-padding">
                <div class="c-list-group">
                    <div class="c-list-group__item">
                        <div class="c-list-group__content">
                            <div class="c-list-group__icon">
                                <i class="ti ti-toggle-left"></i>
                            </div>
                            <div class="c-list-group__text">
                                <div class="c-list-group__title">Waitlist Registration</div>
                                <div class="c-list-group__subtitle">Allow new users to join waitlist</div>
                            </div>
                        </div>
                        <div class="c-list-group__actions">
                            <span class="c-badge c-badge--{% if waitlist_registration_enabled %}success{% else %}danger{% endif %}">
                                {% if waitlist_registration_enabled %}Open{% else %}Closed{% endif %}
                            </span>
                            <a href="{{ url_for('admin_panel.feature_toggles') }}#registration"
                               class="c-btn-modern c-btn-modern--primary c-btn-modern--sm c-btn-modern--icon">
                                <i class="ti ti-settings"></i>
                            </a>
                        </div>
                    </div>
                    <div class="c-list-group__item">
                        <div class="c-list-group__content">
                            <div class="c-list-group__icon">
                                <i class="ti ti-bell"></i>
                            </div>
                            <div class="c-list-group__text">
                                <div class="c-list-group__title">Auto Notifications</div>
                                <div class="c-list-group__subtitle">Notify users when processed</div>
                            </div>
                        </div>
                        <div class="c-list-group__actions">
                            <span class="c-badge c-badge--success">Enabled</span>
                            <a href="{{ url_for('admin_panel.feature_toggles') }}#notifications"
                               class="c-btn-modern c-btn-modern--primary c-btn-modern--sm c-btn-modern--icon">
                                <i class="ti ti-settings"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="c-card-modern">
            <div class="c-card-modern__header">
                <div class="c-card-modern__title">
                    <i class="ti ti-chart-bar"></i>
                    <span>Waitlist Analytics</span>
                </div>
            </div>
            <div class="c-card-modern__body c-card-modern__body--no-padding">
                <div class="c-list-group">
                    <div class="c-list-group__item">
                        <div class="c-list-group__content">
                            <div class="c-list-group__icon">
                                <i class="ti ti-clock"></i>
                            </div>
                            <div class="c-list-group__text">
                                <div class="c-list-group__title">Average Wait Time</div>
                            </div>
                        </div>
                        <div class="c-list-group__actions">
                            <span class="c-badge c-badge--info">{{ avg_wait_time or '7 days' }}</span>
                        </div>
                    </div>
                    <div class="c-list-group__item">
                        <div class="c-list-group__content">
                            <div class="c-list-group__icon">
                                <i class="ti ti-check-circle"></i>
                            </div>
                            <div class="c-list-group__text">
                                <div class="c-list-group__title">Processing Rate</div>
                            </div>
                        </div>
                        <div class="c-list-group__actions">
                            <span class="c-badge c-badge--success">{{ processing_rate or '85%' }}</span>
                        </div>
                    </div>
                    <div class="c-list-group__item">
                        <div class="c-list-group__content">
                            <div class="c-list-group__icon">
                                <i class="ti ti-users"></i>
                            </div>
                            <div class="c-list-group__text">
                                <div class="c-list-group__title">Conversion Rate</div>
                            </div>
                        </div>
                        <div class="c-list-group__actions">
                            <span class="c-badge c-badge--primary">{{ conversion_rate or '92%' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div class="c-modal" id="waitlistUserModal" tabindex="-1" aria-labelledby="waitlist_user_title">
        <div class="c-modal__dialog c-modal__dialog--lg">
            <div class="c-modal__content">
                <div class="c-modal__header">
                    <h5 class="c-modal__title" id="waitlist_user_title">User Details</h5>
                    <button type="button" class="c-modal__close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="c-modal__body" id="waitlist_user_content">
                    <!-- User details will be loaded here -->
                </div>
                <div class="c-modal__footer">
                    <button type="button" class="c-btn-modern c-btn-modern--secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="c-btn-modern c-btn-modern--success" data-action="process-from-modal">
                        <i class="ti ti-check"></i>
                        <span>Process User</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block custom_css %}
{{ super() }}
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
let selectedUserId = null;

// Event delegation for all actions
document.addEventListener('click', function(e) {
    const target = e.target.closest('[data-action]');
    if (!target) return;

    const action = target.dataset.action;
    const userId = target.dataset.userId;
    const userName = target.dataset.userName;

    switch(action) {
        case 'back':
            window.history.back();
            break;
        case 'process-all':
            processAllFromWaitlist();
            break;
        case 'view-user':
            viewWaitlistUser(userId, userName);
            break;
        case 'process-user':
            processFromWaitlist(userId, userName);
            break;
        case 'remove-user':
            removeFromWaitlist(userId, userName);
            break;
        case 'process-from-modal':
            processUserFromModal();
            break;
    }
});

document.addEventListener('change', function(e) {
    if (e.target.matches('[data-action="toggle-select-all"]')) {
        const checkboxes = document.querySelectorAll('.js-user-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = e.target.checked;
        });
    }
});

function viewWaitlistUser(userId, userName) {
    selectedUserId = userId;
    document.getElementById('waitlist_user_title').textContent = `Details for ${userName}`;
    document.getElementById('waitlist_user_content').innerHTML = '<div class="text-center"><div class="spinner-border" role="status" data-spinner></div></div>';

    ModalManager.show('waitlistUserModal');
    
    // Load user details via AJAX
    fetch(`{{ url_for('admin_panel.get_user_details') }}?user_id=${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('waitlist_user_content').innerHTML = data.html;
            } else {
                document.getElementById('waitlist_user_content').innerHTML = '<div class="alert alert-danger" data-alert>Error loading user details</div>';
            }
        })
        .catch(error => {
            document.getElementById('waitlist_user_content').innerHTML = '<div class="alert alert-danger" data-alert>Error loading user details</div>';
        });
}

function processFromWaitlist(userId, userName) {
    Swal.fire({
        title: 'Process User from Waitlist?',
        text: `Process "${userName}" from the waitlist and approve their registration?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('success') : '#28a745',
        cancelButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('secondary') : '#6c757d',
        confirmButtonText: 'Yes, process user!'
    }).then((result) => {
        if (result.isConfirmed) {
            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("admin_panel.process_waitlist_user") }}';
            
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrf_token';
            csrfToken.value = '{{ csrf_token() }}';
            
            const userIdInput = document.createElement('input');
            userIdInput.type = 'hidden';
            userIdInput.name = 'user_id';
            userIdInput.value = userId;
            
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'process';
            
            form.appendChild(csrfToken);
            form.appendChild(userIdInput);
            form.appendChild(actionInput);
            document.body.appendChild(form);
            form.submit();
        }
    });
}

function removeFromWaitlist(userId, userName) {
    Swal.fire({
        title: 'Remove from Waitlist?',
        text: `Remove "${userName}" from the waitlist? This action cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('danger') : '#dc3545',
        cancelButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('secondary') : '#6c757d',
        confirmButtonText: 'Yes, remove!'
    }).then((result) => {
        if (result.isConfirmed) {
            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("admin_panel.process_waitlist_user") }}';
            
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrf_token';
            csrfToken.value = '{{ csrf_token() }}';
            
            const userIdInput = document.createElement('input');
            userIdInput.type = 'hidden';
            userIdInput.name = 'user_id';
            userIdInput.value = userId;
            
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'remove';
            
            form.appendChild(csrfToken);
            form.appendChild(userIdInput);
            form.appendChild(actionInput);
            document.body.appendChild(form);
            form.submit();
        }
    });
}

function processAllFromWaitlist() {
    const checkboxes = document.querySelectorAll('.js-user-checkbox:checked');
    const selectedCount = checkboxes.length;
    
    if (selectedCount === 0) {
        // Process all users
        Swal.fire({
            title: 'Process All Users?',
            text: 'Process all users from the waitlist and approve their registrations?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('success') : '#28a745',
            cancelButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('secondary') : '#6c757d',
            confirmButtonText: 'Yes, process all!'
        }).then((result) => {
            if (result.isConfirmed) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("admin_panel.process_waitlist_user") }}';
                
                const csrfToken = document.createElement('input');
                csrfToken.type = 'hidden';
                csrfToken.name = 'csrf_token';
                csrfToken.value = '{{ csrf_token() }}';
                
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'process_all';
                
                form.appendChild(csrfToken);
                form.appendChild(actionInput);
                document.body.appendChild(form);
                form.submit();
            }
        });
    } else {
        // Process selected users
        Swal.fire({
            title: `Process ${selectedCount} Selected Users?`,
            text: `Process ${selectedCount} selected users from the waitlist?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('success') : '#28a745',
            cancelButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('secondary') : '#6c757d',
            confirmButtonText: 'Yes, process selected!'
        }).then((result) => {
            if (result.isConfirmed) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("admin_panel.process_waitlist_user") }}';
                
                const csrfToken = document.createElement('input');
                csrfToken.type = 'hidden';
                csrfToken.name = 'csrf_token';
                csrfToken.value = '{{ csrf_token() }}';
                
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'process_selected';
                
                // Add selected user IDs
                checkboxes.forEach(checkbox => {
                    const userIdInput = document.createElement('input');
                    userIdInput.type = 'hidden';
                    userIdInput.name = 'selected_users';
                    userIdInput.value = checkbox.value;
                    form.appendChild(userIdInput);
                });
                
                form.appendChild(csrfToken);
                form.appendChild(actionInput);
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
}

function processUserFromModal() {
    if (selectedUserId) {
        processFromWaitlist(selectedUserId, 'this user');
    }
}
</script>
{% endblock %}