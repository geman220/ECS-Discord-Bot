{% extends "admin_panel/base.html" %}

{% block title %}All Matches - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_panel.match_management') }}">Match Management</a></li>
<li class="breadcrumb-item active">All Matches</li>
{% endblock %}

{% block panel_content %}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">All Matches</h4>
    <div class="btn-group">
        <a href="{{ url_for('admin_panel.create_match') }}" class="c-btn c-btn--primary">
            <i class="ti ti-plus me-2"></i>Create Match
        </a>
        <button type="button" class="c-btn c-btn--outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" data-dropdown-toggle>
            <span class="visually-hidden">Toggle Dropdown</span>
        </button>
        <ul class="dropdown-menu" data-dropdown-menu>
            <li><a class="dropdown-item js-bulk-actions" href="#" data-action="bulk-actions"><i class="ti ti-check-circle me-2"></i>Bulk Actions</a></li>
            <li><a class="dropdown-item js-export-matches" href="#" data-action="export-matches"><i class="ti ti-download me-2"></i>Export Matches</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item js-bulk-schedule" href="#" data-action="bulk-schedule"><i class="ti ti-calendar-plus me-2"></i>Bulk Schedule</a></li>
        </ul>
    </div>
</div>

<!-- Filters -->
<div class="c-card mb-4">
    <div class="c-card__body">
        <form method="GET" class="row g-3">
            <div class="col-md-2">
                <label class="form-label">League</label>
                <select name="league" class="form-select" data-form-select>
                    <option value="all" {% if current_filters.league == 'all' %}selected{% endif %}>All Leagues</option>
                    {% for league in leagues %}
                    <option value="{{ league }}" {% if current_filters.league == league %}selected{% endif %}>
                        {{ league }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Season</label>
                <select name="season" class="form-select" data-form-select>
                    <option value="all" {% if current_filters.season == 'all' %}selected{% endif %}>All Seasons</option>
                    {% for season in seasons %}
                    <option value="{{ season.id }}" {% if current_filters.season == season.id|string %}selected{% endif %}>
                        {{ season.league.name }} {{ season.year }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select name="status" class="form-select" data-form-select>
                    <option value="all" {% if current_filters.status == 'all' %}selected{% endif %}>All Status</option>
                    <option value="upcoming" {% if current_filters.status == 'upcoming' %}selected{% endif %}>Upcoming</option>
                    <option value="today" {% if current_filters.status == 'today' %}selected{% endif %}>Today</option>
                    <option value="past" {% if current_filters.status == 'past' %}selected{% endif %}>Past</option>
                    {% for status in statuses %}
                    <option value="{{ status }}" {% if current_filters.status == status %}selected{% endif %}>
                        {{ status.title() }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Team</label>
                <select name="team" class="form-select" data-form-select>
                    <option value="all" {% if current_filters.team == 'all' %}selected{% endif %}>All Teams</option>
                    {% for team in teams %}
                    <option value="{{ team.id }}" {% if current_filters.team == team.id|string %}selected{% endif %}>
                        {{ team.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">From Date</label>
                <input type="date" name="date_from" class="form-control" value="{{ current_filters.date_from }}" data-form-control>
            </div>
            <div class="col-md-2">
                <label class="form-label">To Date</label>
                <input type="date" name="date_to" class="form-control" value="{{ current_filters.date_to }}" data-form-control>
            </div>
            <div class="col-md-8">
                <label class="form-label">Search</label>
                <div class="input-group" data-input-group>
                    <input type="text" name="search" class="form-control" placeholder="Search teams, location..." value="{{ current_filters.search }}" data-form-control aria-label="Search teams, location...">
                    <button type="submit" class="c-btn c-btn--outline-primary" aria-label="Search"><i class="ti ti-search"></i></button>
                </div>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <a href="{{ url_for('admin_panel.match_list') }}" class="c-btn c-btn--outline-secondary me-2" title="Clear filters">
                    <i class="ti ti-x"></i> Clear
                </a>
                <button type="button" class="c-btn c-btn--info js-refresh" data-action="refresh" title="Refresh">
                    <i class="ti ti-refresh"></i> Refresh
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Matches Table -->
<div class="c-card">
    <div class="c-card__body p-0">
        {% if matches.items %}
        <div class="c-table-wrapper" data-table-responsive>
            <table class="c-c-table c-table--hoverable mb-0" data-table data-mobile-table data-table-type="matches">
                <thead class="c-table--light" scope="col">
                    <tr>
                        <th width="50" scope="col">
                            <div class="form-check">
                                <input class="form-check-input js-select-all" type="checkbox" id="matches-selectAll" data-action="toggle-select-all">
                            </div>
                        </th>
                        <th scope="col">Match</th>
                        <th scope="col">Date & Time</th>
                        <th scope="col">League</th>
                        <th scope="col">Location</th>
                        <th scope="col">Status</th>
                        <th scope="col">RSVPs</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for match in matches.items %}
                    <tr>
                        <td data-label="Select">
                            <div class="form-check">
                                <input class="form-check-input match-checkbox" type="checkbox" value="{{ match.id }}">
                            </div>
                        </td>
                        <td data-label="Match">
                            <div class="d-flex align-items-center">
                                <div>
                                    <strong>{{ match.home_team.name }}</strong>
                                    <small class="text-primary mx-2">vs</small>
                                    <strong>{{ match.away_team.name }}</strong>
                                </div>
                            </div>
                        </td>
                        <td data-label="Date & Time">
                            <div>
                                <strong>{{ match.date.strftime('%Y-%m-%d') if match.date else 'TBD' }}</strong>
                                {% if match.time %}
                                <br><small class="text-muted">{{ match.time.strftime('%H:%M') }}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td data-label="League">
                            {% if match.season and match.season.league %}
                            <span class="badge bg-secondary" data-badge>{{ match.season.league.name }}</span>
                            <br><small class="text-muted">{{ match.season.year }}</small>
                            {% else %}
                            <span class="text-muted">Unknown</span>
                            {% endif %}
                        </td>
                        <td data-label="Location">
                            <small>{{ match.location or 'TBD' }}</small>
                        </td>
                        <td data-label="Status">
                            {% if hasattr(match, 'status') and match.status %}
                            <span class="badge bg-{% if match.status == 'completed' %}success{% elif match.status == 'live' %}warning{% elif match.status == 'cancelled' %}danger{% elif match.status == 'postponed' %}secondary{% else %}primary{% endif %}" data-badge>
                                {{ match.status.title() }}
                            </span>
                            {% elif match.date %}
                                {% if match.date > date.today() %}
                                <span class="badge bg-primary" data-badge>Scheduled</span>
                                {% elif match.date == date.today() %}
                                <span class="badge bg-warning" data-badge>Today</span>
                                {% else %}
                                <span class="badge bg-success" data-badge>Completed</span>
                                {% endif %}
                            {% else %}
                            <span class="badge bg-secondary" data-badge>TBD</span>
                            {% endif %}
                        </td>
                        <td data-label="RSVPs">
                            <small class="text-muted">
                                <!-- RSVP count would go here -->
                                <i class="ti ti-users me-1"></i>-
                            </small>
                        </td>
                        <td data-label="Actions">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="c-btn c-btn--outline-info js-view-details"
                                        data-action="view-match" data-match-id="{{ match.id }}" title="View Details">
                                    <i class="ti ti-eye"></i>
                                </button>
                                <a href="{{ url_for('admin_panel.edit_match', match_id=match.id) }}" 
                                   class="c-btn c-btn--outline-primary" title="Edit">
                                    <i class="ti ti-edit"></i>
                                </a>
                                <div class="dropdown">
                                    <button class="c-btn c-btn--outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-dropdown-toggle aria-label="More options"><i class="ti ti-dots"></i></button>
                                    <ul class="dropdown-menu" data-dropdown-menu>
                                        <li><a class="dropdown-item js-duplicate-match" href="#" data-action="duplicate-match" data-match-id="{{ match.id }}">
                                            <i class="ti ti-copy me-2"></i>Duplicate
                                        </a></li>
                                        <li><a class="dropdown-item js-schedule-match" href="#" data-action="schedule-match" data-match-id="{{ match.id }}">
                                            <i class="ti ti-calendar me-2"></i>Schedule
                                        </a></li>
                                        {% if hasattr(match, 'status') and match.status != 'cancelled' %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-warning js-postpone-match" href="#" data-action="postpone-match" data-match-id="{{ match.id }}">
                                            <i class="ti ti-clock me-2"></i>Postpone
                                        </a></li>
                                        <li><a class="dropdown-item text-danger js-cancel-match" href="#" data-action="cancel-match" data-match-id="{{ match.id }}">
                                            <i class="ti ti-x me-2"></i>Cancel
                                        </a></li>
                                        {% endif %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger js-delete-match" href="#" data-action="delete-match" data-match-id="{{ match.id }}" data-match-name="{{ match.home_team.name }} vs {{ match.away_team.name }}">
                                            <i class="ti ti-trash me-2"></i>Delete
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if matches.pages > 1 %}
        <div class="c-card__footer">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0" data-pagination>
                    {% if matches.has_prev %}
                    <li class="page-item" data-page-item>
                        <a class="page-link" href="{{ url_for('admin_panel.match_list', page=matches.prev_num, **current_filters) }}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in matches.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != matches.page %}
                            <li class="page-item" data-page-item>
                                <a class="page-link" href="{{ url_for('admin_panel.match_list', page=page_num, **current_filters) }}">{{ page_num }}</a>
                            </li>
                            {% else %}
                            <li class="page-item active" data-page-item data-page-active>
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                        <li class="page-item disabled" data-page-item data-page-disabled>
                            <span class="page-link">â€¦</span>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if matches.has_next %}
                    <li class="page-item" data-page-item>
                        <a class="page-link" href="{{ url_for('admin_panel.match_list', page=matches.next_num, **current_filters) }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="ti ti-trophy text-muted icon-empty-state"></i>
            <h5 class="text-muted mt-3">No Matches Found</h5>
            <p class="text-muted">No matches match your current filters.</p>
            <a href="{{ url_for('admin_panel.create_match') }}" class="c-btn c-btn--primary">
                <i class="ti ti-plus me-2"></i>Create First Match
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Summary Statistics -->
{% if matches.items %}
<div class="row mt-4">
    <div class="col-md-3">
        <div class="c-card bg-light">
            <div class="c-card__body text-center">
                <i class="ti ti-trophy text-primary card-icon-stat"></i>
                <h6 class="c-card__title mt-2">{{ matches.total }}</h6>
                <p class="c-card__description small text-muted">Total Matches</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="c-card bg-light">
            <div class="c-card__body text-center">
                <i class="ti ti-calendar text-success card-icon-stat"></i>
                <h6 class="c-card__title mt-2">{{ matches.items | selectattr('date') | selectattr('date', 'ge', date.today()) | list | length }}</h6>
                <p class="c-card__description small text-muted">Upcoming</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="c-card bg-light">
            <div class="c-card__body text-center">
                <i class="ti ti-clock text-warning card-icon-stat"></i>
                <h6 class="c-card__title mt-2">{{ matches.items | selectattr('date', 'equalto', date.today()) | list | length }}</h6>
                <p class="c-card__description small text-muted">Today</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="c-card bg-light">
            <div class="c-card__body text-center">
                <i class="ti ti-check-circle text-info card-icon-stat"></i>
                <h6 class="c-card__title mt-2">{{ matches.items | selectattr('date', 'lt', date.today()) | list | length }}</h6>
                <p class="c-card__description small text-muted">Completed</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
// Event delegation for match actions
document.addEventListener('DOMContentLoaded', function() {
    // Handle select all checkbox
    const selectAllCheckbox = document.querySelector('.js-select-all');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', toggleSelectAll);
    }

    // Handle refresh button
    const refreshBtn = document.querySelector('.js-refresh');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            location.reload();
        });
    }

    // Handle bulk actions
    const bulkActionsBtn = document.querySelector('.js-bulk-actions');
    if (bulkActionsBtn) {
        bulkActionsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            bulkActions();
        });
    }

    const exportBtn = document.querySelector('.js-export-matches');
    if (exportBtn) {
        exportBtn.addEventListener('click', function(e) {
            e.preventDefault();
            exportMatches();
        });
    }

    const bulkScheduleBtn = document.querySelector('.js-bulk-schedule');
    if (bulkScheduleBtn) {
        bulkScheduleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            bulkScheduleMatches();
        });
    }

    // Handle view details buttons
    document.querySelectorAll('.js-view-details').forEach(btn => {
        btn.addEventListener('click', function() {
            const matchId = this.dataset.matchId;
            viewMatchDetails(matchId);
        });
    });

    // Handle delete match buttons
    document.querySelectorAll('.js-delete-match').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const matchId = this.dataset.matchId;
            const matchName = this.dataset.matchName;
            deleteMatch(matchId, matchName);
        });
    });

    // Handle duplicate match buttons
    document.querySelectorAll('.js-duplicate-match').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const matchId = this.dataset.matchId;
            duplicateMatch(matchId);
        });
    });

    // Handle schedule match buttons
    document.querySelectorAll('.js-schedule-match').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const matchId = this.dataset.matchId;
            scheduleMatch(matchId);
        });
    });

    // Handle postpone match buttons
    document.querySelectorAll('.js-postpone-match').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const matchId = this.dataset.matchId;
            postponeMatch(matchId);
        });
    });

    // Handle cancel match buttons
    document.querySelectorAll('.js-cancel-match').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const matchId = this.dataset.matchId;
            cancelMatch(matchId);
        });
    });
});

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.match-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function getSelectedMatches() {
    const checkboxes = document.querySelectorAll('.match-checkbox:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.value));
}

function viewMatchDetails(matchId) {
    fetch(`/admin-panel/matches/${matchId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const match = data.match;
                let detailsHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Match Information</h6>
                            <p><strong>Teams:</strong> ${match.home_team} vs ${match.away_team}</p>
                            <p><strong>Date:</strong> ${match.date || 'TBD'}</p>
                            <p><strong>Time:</strong> ${match.time || 'TBD'}</p>
                            <p><strong>Location:</strong> ${match.location}</p>
                            <p><strong>Status:</strong> <span class="badge bg-primary" data-badge>${match.status}</span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>League & Season</h6>
                            <p><strong>League:</strong> ${match.league}</p>
                            <p><strong>Season:</strong> ${match.season}</p>
                        </div>
                    </div>
                `;
                
                if (match.rsvp_data && match.rsvp_data.total > 0) {
                    detailsHtml += `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>RSVP Information</h6>
                                <p><strong>Total RSVPs:</strong> ${match.rsvp_data.total}</p>
                                ${match.rsvp_data.status_breakdown ? Object.entries(match.rsvp_data.status_breakdown).map(([status, count]) => 
                                    `<span class="badge bg-secondary me-1" data-badge>${status}: ${count}</span>`
                                ).join('') : ''}
                            </div>
                        </div>
                    `;
                }
                
                if (match.team_history && match.team_history.length > 0) {
                    detailsHtml += `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Recent Head-to-Head</h6>
                                <div class="c-table-wrapper" data-table-responsive>
                                    <table class="c-c-table c-table--compact" data-table data-mobile-table data-table-type="history">
                                        <thead scope="col"><tr><th scope="col">Date</th><th scope="col">Match</th><th scope="col">Status</th></tr></thead>
                                        <tbody>
                                            ${match.team_history.map(h => 
                                                `<tr><td>${h.date}</td><td>${h.home_team} vs ${h.away_team}</td><td>${h.status}</td></tr>`
                                            ).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                Swal.fire({
                    title: 'Match Details',
                    html: detailsHtml,
                    width: '700px',
                    confirmButtonText: 'Close'
                });
            } else {
                Swal.fire('Error', 'Could not load match details', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', 'Could not load match details', 'error');
        });
}

function deleteMatch(matchId, matchName) {
    Swal.fire({
        title: 'Delete Match?',
        text: `Are you sure you want to delete "${matchName}"? This action cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('danger') : '#dc3545',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/admin-panel/matches/${matchId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Deleted!', 'Match has been deleted.', 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('Error', data.error || 'Could not delete match', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Could not delete match', 'error');
            });
        }
    });
}

function bulkActions() {
    const selectedMatches = getSelectedMatches();
    
    if (selectedMatches.length === 0) {
        Swal.fire('No Selection', 'Please select matches to perform bulk actions.', 'warning');
        return;
    }
    
    Swal.fire({
        title: 'Bulk Actions',
        text: `Perform action on ${selectedMatches.length} selected matches:`,
        input: 'select',
        inputOptions: {
            'update_status': 'Update Status',
            'delete': 'Delete Matches',
            'export': 'Export Selected'
        },
        showCancelButton: true,
        confirmButtonText: 'Execute'
    }).then((result) => {
        if (result.isConfirmed) {
            if (result.value === 'delete') {
                confirmBulkDelete(selectedMatches);
            } else if (result.value === 'update_status') {
                bulkUpdateStatus(selectedMatches);
            } else if (result.value === 'export') {
                exportSelectedMatches(selectedMatches);
            }
        }
    });
}

function confirmBulkDelete(matchIds) {
    Swal.fire({
        title: 'Confirm Bulk Delete',
        text: `Are you sure you want to delete ${matchIds.length} matches? This cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: (typeof ECSTheme !== 'undefined') ? ECSTheme.getColor('danger') : '#dc3545',
        confirmButtonText: 'Yes, delete them!'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/admin-panel/matches/bulk-actions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'delete',
                    match_ids: matchIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Success!', data.message, 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Could not perform bulk delete', 'error');
            });
        }
    });
}

function bulkUpdateStatus(matchIds) {
    Swal.fire({
        title: 'Update Status',
        text: 'Select new status for selected matches:',
        input: 'select',
        inputOptions: {
            'scheduled': 'Scheduled',
            'live': 'Live',
            'completed': 'Completed',
            'cancelled': 'Cancelled',
            'postponed': 'Postponed'
        },
        showCancelButton: true,
        confirmButtonText: 'Update'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/admin-panel/matches/bulk-actions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'update_status',
                    match_ids: matchIds,
                    status: result.value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Success!', data.message, 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Could not update status', 'error');
            });
        }
    });
}

function duplicateMatch(matchId) {
    Swal.fire({
        title: 'Duplicate Match',
        text: 'This will create a copy of the match. You can edit the details after creation.',
        showCancelButton: true,
        confirmButtonText: 'Duplicate',
        showLoaderOnConfirm: true,
        preConfirm: () => {
            return fetch(`/admin-panel/matches/${matchId}/details`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success && !data.id) {
                        throw new Error(data.message || 'Failed to fetch match details');
                    }
                    // Create duplicate with slightly modified data
                    const matchData = {
                        home_team_id: data.home_team_id,
                        away_team_id: data.away_team_id,
                        league_id: data.league_id,
                        week: data.week,
                        notes: `Copy of match #${matchId}`
                    };
                    return fetch('/auto-schedule/add-match', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                        },
                        body: JSON.stringify(matchData)
                    });
                })
                .then(response => response.json());
        },
        allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
        if (result.isConfirmed) {
            if (result.value && result.value.success) {
                Swal.fire('Duplicated!', 'Match has been duplicated. Redirecting to edit...', 'success')
                    .then(() => {
                        if (result.value.match_id) {
                            window.location.href = `/admin-panel/matches/${result.value.match_id}/edit`;
                        } else {
                            window.location.reload();
                        }
                    });
            } else {
                Swal.fire('Error', result.value?.message || 'Failed to duplicate match', 'error');
            }
        }
    }).catch(error => {
        Swal.fire('Error', error.message || 'Failed to duplicate match', 'error');
    });
}

function scheduleMatch(matchId) {
    Swal.fire({
        title: 'Schedule Match',
        html: `
            <div class="text-start">
                <div class="mb-3">
                    <label for="matchDate" class="form-label">Date</label>
                    <input type="date" id="matchDate" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="matchTime" class="form-label">Time</label>
                    <input type="time" id="matchTime" class="form-control">
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Schedule',
        showLoaderOnConfirm: true,
        preConfirm: () => {
            const date = document.getElementById('matchDate').value;
            const time = document.getElementById('matchTime').value;
            if (!date || !time) {
                Swal.showValidationMessage('Please fill in both date and time');
                return false;
            }
            return fetch('/auto-schedule/update-match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    match_id: matchId,
                    date: date,
                    time: time
                })
            }).then(response => response.json());
        },
        allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
        if (result.isConfirmed) {
            if (result.value && result.value.success) {
                Swal.fire('Scheduled!', 'Match has been scheduled.', 'success')
                    .then(() => window.location.reload());
            } else {
                Swal.fire('Error', result.value?.message || 'Failed to schedule match', 'error');
            }
        }
    });
}

function postponeMatch(matchId) {
    Swal.fire({
        title: 'Postpone Match',
        html: `
            <div class="text-start">
                <div class="mb-3">
                    <label for="postponeReason" class="form-label">Reason for postponement</label>
                    <textarea id="postponeReason" class="form-control" rows="3" placeholder="Weather, scheduling conflict, etc."></textarea>
                </div>
                <div class="mb-3">
                    <label for="newDate" class="form-label">New Date (optional)</label>
                    <input type="date" id="newDate" class="form-control">
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Postpone',
        showLoaderOnConfirm: true,
        preConfirm: () => {
            const reason = document.getElementById('postponeReason').value;
            const newDate = document.getElementById('newDate').value;
            return fetch('/auto-schedule/update-match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    match_id: matchId,
                    status: 'POSTPONED',
                    date: newDate || null,
                    notes: reason ? `Postponed: ${reason}` : 'Match postponed'
                })
            }).then(response => response.json());
        },
        allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
        if (result.isConfirmed) {
            if (result.value && result.value.success) {
                Swal.fire('Postponed!', 'Match has been postponed.', 'success')
                    .then(() => window.location.reload());
            } else {
                Swal.fire('Error', result.value?.message || 'Failed to postpone match', 'error');
            }
        }
    });
}

function cancelMatch(matchId) {
    Swal.fire({
        title: 'Cancel Match',
        text: 'Are you sure you want to cancel this match? This action cannot be easily undone.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, cancel it!',
        confirmButtonColor: '#dc3545',
        showLoaderOnConfirm: true,
        preConfirm: () => {
            return fetch('/auto-schedule/update-match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    match_id: matchId,
                    status: 'CANCELLED'
                })
            }).then(response => response.json());
        },
        allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
        if (result.isConfirmed) {
            if (result.value && result.value.success) {
                Swal.fire('Cancelled!', 'Match has been cancelled.', 'success')
                    .then(() => window.location.reload());
            } else {
                Swal.fire('Error', result.value?.message || 'Failed to cancel match', 'error');
            }
        }
    });
}

function exportMatches() {
    Swal.fire({
        title: 'Export Matches',
        text: 'Choose export format:',
        input: 'select',
        inputOptions: {
            'csv': 'CSV',
            'json': 'JSON'
        },
        showCancelButton: true,
        confirmButtonText: 'Export'
    }).then((result) => {
        if (result.isConfirmed) {
            const format = result.value;
            // Collect visible match data from the table
            const table = document.querySelector('.c-table, table');
            if (!table) {
                Swal.fire('Error', 'No match data found to export', 'error');
                return;
            }
            const headers = Array.from(table.querySelectorAll('thead th'))
                .map(th => th.textContent.trim())
                .filter(h => h !== 'Actions');
            const rows = Array.from(table.querySelectorAll('tbody tr')).map(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                return cells.slice(0, -1).map(cell => cell.textContent.trim()); // Exclude actions column
            });

            if (format === 'csv') {
                const csvContent = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(','))].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `matches_export_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                URL.revokeObjectURL(url);
                Swal.fire('Exported!', 'Matches exported to CSV successfully.', 'success');
            } else if (format === 'json') {
                const jsonData = rows.map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    return obj;
                });
                const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `matches_export_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                Swal.fire('Exported!', 'Matches exported to JSON successfully.', 'success');
            }
        }
    });
}

function exportSelectedMatches(matchIds) {
    if (!matchIds || matchIds.length === 0) {
        Swal.fire('No Selection', 'Please select matches to export.', 'warning');
        return;
    }
    const selectedRows = matchIds.map(id => document.querySelector(`tr[data-match-id="${id}"]`)).filter(Boolean);
    if (selectedRows.length === 0) {
        Swal.fire('Error', 'Could not find selected match data.', 'error');
        return;
    }
    const headers = Array.from(document.querySelectorAll('.c-table thead th, table thead th'))
        .map(th => th.textContent.trim())
        .filter(h => h !== 'Actions' && h !== '');
    const rows = selectedRows.map(row => {
        const cells = Array.from(row.querySelectorAll('td'));
        return cells.slice(0, -1).map(cell => cell.textContent.trim());
    });
    const csvContent = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `selected_matches_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    Swal.fire('Exported!', `${matchIds.length} matches exported successfully.`, 'success');
}

function bulkScheduleMatches() {
    Swal.fire({
        title: 'Bulk Schedule Matches',
        html: `
            <div class="text-start">
                <p class="mb-3">Select multiple matches from the table, then set a common schedule pattern.</p>
                <div class="mb-3">
                    <label for="bulkStartDate" class="form-label">Starting Date</label>
                    <input type="date" id="bulkStartDate" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="bulkTime" class="form-label">Match Time</label>
                    <input type="time" id="bulkTime" class="form-control" value="19:00">
                </div>
                <div class="mb-3">
                    <label for="bulkInterval" class="form-label">Days Between Matches</label>
                    <input type="number" id="bulkInterval" class="form-control" value="7" min="1">
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Apply Schedule',
        footer: '<small class="text-muted">First select matches using the checkboxes in the table</small>'
    }).then((result) => {
        if (result.isConfirmed) {
            const selectedMatches = getSelectedMatchIds();
            if (!selectedMatches || selectedMatches.length === 0) {
                Swal.fire('No Selection', 'Please select matches first using the checkboxes.', 'warning');
                return;
            }
            Swal.fire('Scheduling...', `Bulk scheduling ${selectedMatches.length} matches...`, 'info');
        }
    });
}
</script>
{% endblock %}