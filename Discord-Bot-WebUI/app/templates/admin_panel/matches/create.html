{% extends "admin_panel/base.html" %}

{% block title %}Create Match - Admin Panel{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_panel.match_management') }}">Match Management</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('admin_panel.match_list') }}">All Matches</a></li>
<li class="breadcrumb-item active">Create Match</li>
{% endblock %}

{% block panel_content %}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="c-card__title mb-0">
                    <i class="ti ti-plus me-2"></i>Create New Match
                </h5>
            </div>
            <div class="c-card__body">
                <form method="POST" id="createMatchForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="home_team_id" class="form-label">Home Team <span class="text-danger">*</span></label>
                            <select class="form-select" id="home_team_id" name="home_team_id" required data-form-select>
                                <option value="">Select Home Team</option>
                                {% for team in teams %}
                                <option value="{{ team.id }}">{{ team.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="away_team_id" class="form-label">Away Team <span class="text-danger">*</span></label>
                            <select class="form-select" id="away_team_id" name="away_team_id" required data-form-select>
                                <option value="">Select Away Team</option>
                                {% for team in teams %}
                                <option value="{{ team.id }}">{{ team.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="season_id" class="form-label">Season <span class="text-danger">*</span></label>
                            <select class="form-select" id="season_id" name="season_id" required data-form-select>
                                <option value="">Select Season</option>
                                {% for season in seasons %}
                                <option value="{{ season.id }}">
                                    {{ season.league.name }} {{ season.year }}
                                    {% if season.is_current %}(Current){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="match-create-date" class="form-label">Match Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="match-create-date" name="date" required data-form-control>
                        </div>
                        <div class="col-md-6">
                            <label for="match-create-time" class="form-label">Match Time</label>
                            <input type="time" class="form-control" id="match-create-time" name="time" value="19:00" data-form-control>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="match-create-location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="match-create-location" name="location" 
                               placeholder="Match venue or location" data-form-control>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="create_rsvp" name="create_rsvp" checked>
                                <label class="form-check-label" for="create_rsvp">
                                    Create RSVP for this match
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notify_teams" name="notify_teams" checked>
                                <label class="form-check-label" for="notify_teams">
                                    Notify teams about the match
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('admin_panel.match_list') }}" class="c-btn c-btn--secondary">
                            <i class="ti ti-arrow-left me-1"></i>Cancel
                        </a>
                        <div>
                            <button type="button" class="c-btn c-btn--outline-primary me-2 js-preview-match" data-action="preview-match">
                                <i class="ti ti-eye me-1"></i>Preview
                            </button>
                            <button type="submit" class="c-btn c-btn--primary">
                                <i class="ti ti-device-floppy me-1"></i>Create Match
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Quick Schedule Templates -->
        <div class="c-card mt-4">
            <div class="c-card__header">
                <h6 class="c-card__title mb-0">
                    <i class="ti ti-template me-2"></i>Quick Schedule Templates
                </h6>
            </div>
            <div class="c-card__body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <button type="button" class="c-btn c-btn--outline-info c-btn--sm w-100 js-apply-template" data-action="apply-template" data-template="weekend">
                            <i class="ti ti-calendar-event me-1"></i>Weekend Match
                        </button>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button type="button" class="c-btn c-btn--outline-info c-btn--sm w-100 js-apply-template" data-action="apply-template" data-template="midweek">
                            <i class="ti ti-calendar me-1"></i>Midweek Match
                        </button>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button type="button" class="c-btn c-btn--outline-info c-btn--sm w-100 js-apply-template" data-action="apply-template" data-template="tournament">
                            <i class="ti ti-trophy me-1"></i>Tournament Match
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Event delegation for match creation actions
    document.querySelectorAll('.js-preview-match').forEach(btn => {
        btn.addEventListener('click', function() {
            previewMatch();
        });
    });

    document.querySelectorAll('.js-apply-template').forEach(btn => {
        btn.addEventListener('click', function() {
            const template = this.getAttribute('data-template');
            applyTemplate(template);
        });
    });
});

// Set minimum date to today
document.getElementById('date').min = new Date().toISOString().split('T')[0];

// Prevent selecting same team for home and away
document.getElementById('home_team_id').addEventListener('change', function() {
    const awaySelect = document.getElementById('away_team_id');
    const homeValue = this.value;
    
    Array.from(awaySelect.options).forEach(option => {
        option.disabled = option.value === homeValue;
        if (option.value === homeValue && option.selected) {
            awaySelect.value = '';
        }
    });
});

document.getElementById('away_team_id').addEventListener('change', function() {
    const homeSelect = document.getElementById('home_team_id');
    const awayValue = this.value;
    
    Array.from(homeSelect.options).forEach(option => {
        option.disabled = option.value === awayValue;
        if (option.value === awayValue && option.selected) {
            homeSelect.value = '';
        }
    });
});

// Handle form submission
document.getElementById('createMatchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    // Validation
    if (data.home_team_id === data.away_team_id) {
        Swal.fire('Invalid Selection', 'Home and away teams must be different.', 'error');
        return;
    }
    
    // Submit the form
    fetch('{{ url_for("admin_panel.create_match") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                title: 'Success!',
                text: 'Match created successfully!',
                icon: 'success',
                confirmButtonText: 'View Match'
            }).then(() => {
                window.location.href = '{{ url_for("admin_panel.match_list") }}';
            });
        } else {
            Swal.fire('Error', data.error || 'Could not create match', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Could not create match', 'error');
    });
});

function previewMatch() {
    const form = document.getElementById('createMatchForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Get team names
    const homeTeamName = document.querySelector(`#home_team_id option[value="${data.home_team_id}"]`)?.text || 'Home Team';
    const awayTeamName = document.querySelector(`#away_team_id option[value="${data.away_team_id}"]`)?.text || 'Away Team';
    const seasonName = document.querySelector(`#season_id option[value="${data.season_id}"]`)?.text || 'Season';
    
    let previewHtml = `
        <div class="text-start">
            <h6>Match Preview</h6>
            <div class="c-card">
                <div class="c-card__body">
                    <div class="text-center mb-3">
                        <h5>${homeTeamName} <span class="text-primary">vs</span> ${awayTeamName}</h5>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Date:</strong> ${data.date || 'TBD'}</p>
                            <p><strong>Time:</strong> ${data.time || 'TBD'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Season:</strong> ${seasonName}</p>
                            <p><strong>Location:</strong> ${data.location || 'TBD'}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>RSVP:</strong> ${data.create_rsvp ? 'Yes' : 'No'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Notifications:</strong> ${data.notify_teams ? 'Yes' : 'No'}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    Swal.fire({
        title: 'Match Preview',
        html: previewHtml,
        width: '600px',
        confirmButtonText: 'Looks Good!'
    });
}

function applyTemplate(template) {
    const dateInput = document.getElementById('date');
    const timeInput = document.getElementById('time');
    const locationInput = document.getElementById('location');
    
    const today = new Date();
    
    switch (template) {
        case 'weekend':
            // Set to next Saturday
            const nextSaturday = new Date(today);
            nextSaturday.setDate(today.getDate() + (6 - today.getDay()) % 7);
            if (nextSaturday <= today) nextSaturday.setDate(nextSaturday.getDate() + 7);
            
            dateInput.value = nextSaturday.toISOString().split('T')[0];
            timeInput.value = '15:00';
            locationInput.value = 'Home Stadium';
            break;
            
        case 'midweek':
            // Set to next Wednesday
            const nextWednesday = new Date(today);
            nextWednesday.setDate(today.getDate() + (3 - today.getDay() + 7) % 7);
            if (nextWednesday <= today) nextWednesday.setDate(nextWednesday.getDate() + 7);
            
            dateInput.value = nextWednesday.toISOString().split('T')[0];
            timeInput.value = '19:30';
            locationInput.value = 'Training Ground';
            break;
            
        case 'tournament':
            // Set to next Sunday
            const nextSunday = new Date(today);
            nextSunday.setDate(today.getDate() + (7 - today.getDay()) % 7);
            if (nextSunday <= today) nextSunday.setDate(nextSunday.getDate() + 7);
            
            dateInput.value = nextSunday.toISOString().split('T')[0];
            timeInput.value = '14:00';
            locationInput.value = 'Tournament Venue';
            break;
    }
    
    Swal.fire({
        title: 'Template Applied',
        text: `${template.charAt(0).toUpperCase() + template.slice(1)} match template has been applied.`,
        icon: 'success',
        timer: 1500,
        showConfirmButton: false
    });
}
</script>
{% endblock %}