{% extends "admin_panel/base.html" %}

{% block title %}Performance Monitoring - Admin Panel{% endblock %}

{% block panel_content %}
<div class="c-perf-monitor" data-component="performance-monitor">
    <!-- Performance Overview Cards -->
    <div class="c-perf-stats" data-component="stats-grid">
        <div class="c-perf-stats__grid">
            <div class="c-stat-card c-stat-card--primary" data-stat-card data-stat-type="query-time">
                <div class="c-stat-card__content">
                    <h5 class="c-stat-card__value">{{ "%.1f"|format(report.database.avg_query_time * 1000) }}ms</h5>
                    <p class="c-stat-card__label">Avg Query Time</p>
                </div>
                <div class="c-stat-card__icon">
                    <i class="ti ti-database"></i>
                </div>
            </div>
            <div class="c-stat-card c-stat-card--{% if report.database.slow_queries > 5 %}danger{% elif report.database.slow_queries > 2 %}warning{% else %}success{% endif %}" data-stat-card data-stat-type="slow-queries">
                <div class="c-stat-card__content">
                    <h5 class="c-stat-card__value">{{ report.database.slow_queries }}</h5>
                    <p class="c-stat-card__label">Slow Queries</p>
                </div>
                <div class="c-stat-card__icon">
                    <i class="ti ti-clock-exclamation"></i>
                </div>
            </div>
            <div class="c-stat-card c-stat-card--info" data-stat-card data-stat-type="cache-entries">
                <div class="c-stat-card__content">
                    <h5 class="c-stat-card__value">{{ report.cache.active_entries }}</h5>
                    <p class="c-stat-card__label">Cache Entries</p>
                </div>
                <div class="c-stat-card__icon">
                    <i class="ti ti-server"></i>
                </div>
            </div>
            <div class="c-stat-card c-stat-card--{% if report.cache.cache_size_mb > 50 %}warning{% else %}secondary{% endif %}" data-stat-card data-stat-type="cache-size">
                <div class="c-stat-card__content">
                    <h5 class="c-stat-card__value">{{ "%.1f"|format(report.cache.cache_size_mb) }}MB</h5>
                    <p class="c-stat-card__label">Cache Size</p>
                </div>
                <div class="c-stat-card__icon">
                    <i class="ti ti-memory"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Details -->
    <div class="c-perf-details" data-component="details-grid">
        <div class="c-perf-details__grid">
            <!-- Database Performance -->
            <div class="c-card" data-card data-section="database">
                <div class="c-card__header">
                    <h5 class="c-card__title">
                        <i class="ti ti-database c-card__title-icon c-card__title-icon--primary"></i>
                        Database Performance
                    </h5>
                    <div class="c-status-indicator {% if report.database.slow_queries <= 2 %}c-status-indicator--active{% else %}c-status-indicator--inactive{% endif %}" data-status-indicator></div>
                </div>
                <div class="c-card__body">
                    <div class="c-perf-metrics" data-metrics>
                        <div class="c-perf-metrics__grid">
                            <div class="c-perf-metric" data-metric>
                                <span class="c-perf-metric__label">Total Queries:</span>
                                <strong class="c-perf-metric__value">{{ report.database.total_queries }}</strong>
                            </div>
                            <div class="c-perf-metric" data-metric>
                                <span class="c-perf-metric__label">Slow Queries:</span>
                                <strong class="c-perf-metric__value c-perf-metric__value--{% if report.database.slow_queries > 5 %}danger{% elif report.database.slow_queries > 2 %}warning{% else %}success{% endif %}">
                                    {{ report.database.slow_queries }}
                                </strong>
                            </div>
                            <div class="c-perf-metric" data-metric>
                                <span class="c-perf-metric__label">Average Time:</span>
                                <strong class="c-perf-metric__value">{{ "%.3f"|format(report.database.avg_query_time) }}s</strong>
                            </div>
                            <div class="c-perf-metric" data-metric>
                                <span class="c-perf-metric__label">Min Time:</span>
                                <strong class="c-perf-metric__value">{{ "%.3f"|format(report.database.min_query_time) }}s</strong>
                            </div>
                            <div class="c-perf-metric" data-metric>
                                <span class="c-perf-metric__label">Max Time:</span>
                                <strong class="c-perf-metric__value c-perf-metric__value--{% if report.database.max_query_time > 2 %}danger{% elif report.database.max_query_time > 1 %}warning{% endif %}">
                                    {{ "%.3f"|format(report.database.max_query_time) }}s
                                </strong>
                            </div>
                            <div class="c-perf-metric" data-metric>
                                <span class="c-perf-metric__label">Performance:</span>
                                <span class="c-badge c-badge--{% if report.database.avg_query_time < 0.1 %}success{% elif report.database.avg_query_time < 0.5 %}warning{% else %}danger{% endif %}" data-badge>
                                    {% if report.database.avg_query_time < 0.1 %}Excellent{% elif report.database.avg_query_time < 0.5 %}Good{% else %}Slow{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="c-perf-chart" data-chart-container>
                        <canvas data-chart="query-performance" data-chart-type="line"></canvas>
                    </div>
                </div>
            </div>

            <!-- Cache Performance -->
            <div class="c-card" data-card data-section="cache">
                <div class="c-card__header">
                    <h5 class="c-card__title">
                        <i class="ti ti-server c-card__title-icon c-card__title-icon--info"></i>
                        Cache Performance
                    </h5>
                    <form method="POST" action="{{ url_for('admin_panel.clear_performance_cache') }}" data-form="cache-clear">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="c-btn c-btn--sm c-btn--outline-danger" data-action="clear-cache">
                            <i class="ti ti-trash"></i> Clear Cache
                        </button>
                    </form>
                </div>
                <div class="c-card__body">
                    <div class="c-perf-metrics" data-metrics>
                        <div class="c-perf-metrics__grid">
                            <div class="c-perf-metric" data-metric>
                                <span class="c-perf-metric__label">Total Entries:</span>
                                <strong class="c-perf-metric__value">{{ report.cache.total_entries }}</strong>
                            </div>
                            <div class="c-perf-metric" data-metric>
                                <span class="c-perf-metric__label">Active Entries:</span>
                                <strong class="c-perf-metric__value c-perf-metric__value--success">{{ report.cache.active_entries }}</strong>
                            </div>
                            <div class="c-perf-metric" data-metric>
                                <span class="c-perf-metric__label">Expired Entries:</span>
                                <strong class="c-perf-metric__value c-perf-metric__value--{% if report.cache.expired_entries > report.cache.active_entries %}warning{% else %}muted{% endif %}">
                                    {{ report.cache.expired_entries }}
                                </strong>
                            </div>
                            <div class="c-perf-metric" data-metric>
                                <span class="c-perf-metric__label">Cache Size:</span>
                                <strong class="c-perf-metric__value c-perf-metric__value--{% if report.cache.cache_size_mb > 50 %}warning{% endif %}">
                                    {{ "%.2f"|format(report.cache.cache_size_mb) }} MB
                                </strong>
                            </div>
                            <div class="c-perf-metric" data-metric>
                                <span class="c-perf-metric__label">Hit Rate:</span>
                                {% set hit_rate = (report.cache.active_entries / (report.cache.total_entries or 1)) * 100 %}
                                <span class="c-badge c-badge--{% if report.cache.active_entries > report.cache.expired_entries %}success{% else %}warning{% endif %}" data-badge>
                                    {{ "%.1f"|format(hit_rate) }}%
                                </span>
                            </div>
                            <div class="c-perf-metric" data-metric>
                                <span class="c-perf-metric__label">Status:</span>
                                <span class="c-badge c-badge--{% if report.cache.cache_size_mb < 25 and report.cache.active_entries > 0 %}success{% elif report.cache.cache_size_mb < 50 %}warning{% else %}danger{% endif %}" data-badge>
                                    {% if report.cache.cache_size_mb < 25 and report.cache.active_entries > 0 %}Optimal{% elif report.cache.cache_size_mb < 50 %}Fair{% else %}Bloated{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="c-perf-chart" data-chart-container>
                        <canvas data-chart="cache-usage" data-chart-type="doughnut"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Recommendations -->
    {% if report.recommendations %}
    <div class="c-perf-recommendations" data-component="recommendations">
        <div class="c-card" data-card>
            <div class="c-card__header">
                <h5 class="c-card__title">
                    <i class="ti ti-bulb c-card__title-icon c-card__title-icon--warning"></i>
                    Performance Recommendations
                </h5>
            </div>
            <div class="c-card__body">
                <div class="c-alert c-alert--info">
                    <div class="c-alert__icon">
                        <i class="ti ti-info-circle"></i>
                    </div>
                    <div class="c-alert__content">
                        <strong>Performance Optimization Suggestions:</strong>
                        <ul class="c-alert__list">
                            {% for recommendation in report.recommendations %}
                            <li>{{ recommendation }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Real-time Metrics -->
    <div class="c-perf-realtime" data-component="realtime-metrics">
        <div class="c-card" data-card>
            <div class="c-card__header">
                <h5 class="c-card__title">
                    <i class="ti ti-activity c-card__title-icon c-card__title-icon--success"></i>
                    Real-time Performance Metrics
                </h5>
                <div class="c-perf-realtime__controls">
                    <button data-action="toggle-auto-refresh" class="c-btn c-btn--sm c-btn--outline-primary">
                        <i class="ti ti-refresh"></i> Auto Refresh: <span data-status="auto-refresh">ON</span>
                    </button>
                    <small class="c-perf-realtime__timestamp">
                        Last updated: <span data-timestamp>{{ report.timestamp }}</span>
                    </small>
                </div>
            </div>
            <div class="c-card__body">
                <div class="c-perf-realtime__grid" data-realtime-metrics>
                    <div class="c-perf-realtime__metric" data-realtime-metric="query-time">
                        <h3 class="c-perf-realtime__value c-perf-realtime__value--primary" data-live-value="query-time">{{ "%.1f"|format(report.database.avg_query_time * 1000) }}ms</h3>
                        <p class="c-perf-realtime__label">Current Avg Query</p>
                    </div>
                    <div class="c-perf-realtime__metric" data-realtime-metric="slow-queries">
                        <h3 class="c-perf-realtime__value c-perf-realtime__value--{% if report.database.slow_queries > 5 %}danger{% elif report.database.slow_queries > 2 %}warning{% else %}success{% endif %}" data-live-value="slow-queries">{{ report.database.slow_queries }}</h3>
                        <p class="c-perf-realtime__label">Slow Queries</p>
                    </div>
                    <div class="c-perf-realtime__metric" data-realtime-metric="cache-hits">
                        <h3 class="c-perf-realtime__value c-perf-realtime__value--info" data-live-value="cache-hits">{{ report.cache.active_entries }}</h3>
                        <p class="c-perf-realtime__label">Cache Hits</p>
                    </div>
                    <div class="c-perf-realtime__metric" data-realtime-metric="cache-size">
                        <h3 class="c-perf-realtime__value c-perf-realtime__value--{% if report.cache.cache_size_mb > 50 %}warning{% else %}secondary{% endif %}" data-live-value="cache-size">{{ "%.1f"|format(report.cache.cache_size_mb) }}MB</h3>
                        <p class="c-perf-realtime__label">Cache Size</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="u-hidden"
     data-perf-data
     data-db-avg-query-time="{{ report.database.avg_query_time }}"
     data-cache-active="{{ report.cache.active_entries }}"
     data-cache-expired="{{ report.cache.expired_entries }}"></div>
{% endblock %}

{% block custom_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin-panel/performance.css') }}">
{% endblock %}

{% block custom_js %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/admin-panel-performance.js') }}"></script>
{% endblock %}
