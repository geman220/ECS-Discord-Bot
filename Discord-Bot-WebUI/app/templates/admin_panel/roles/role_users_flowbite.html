{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, avatar %}

{% block admin_title %}Role Users - {{ role.name }}{% endblock %}
{% block panel_description %}View and manage users assigned to this role{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.roles_comprehensive') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">Role Management</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">{{ role.name }}</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Role Info Header -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 mb-6">
    <div class="p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-4">
                <div class="flex items-center justify-center w-16 h-16 rounded-full {{ 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300' if 'admin' in role.name.lower() else 'bg-ecs-green/10 text-ecs-green' if 'coach' in role.name.lower() else 'bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300' if 'pl-' in role.name.lower() else 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300' }} text-2xl font-bold">
                    {{ role.name[0].upper() }}
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">{{ role.name }}</h2>
                    {% if role.description %}
                    <p class="text-gray-500 dark:text-gray-400 mt-1">{{ role.description }}</p>
                    {% endif %}
                    <div class="flex items-center gap-2 mt-2">
                        {% if 'admin' in role.name.lower() %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">Admin Role</span>
                        {% elif 'coach' in role.name.lower() %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-ecs-green/10 text-ecs-green dark:bg-ecs-green/20">Coach Role</span>
                        {% elif 'pl-' in role.name.lower() %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">Player Role</span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">Custom Role</span>
                        {% endif %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">
                            {{ users|length }} {{ 'user' if users|length == 1 else 'users' }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap gap-2">
                <a href="{{ url_for('admin_panel.roles_comprehensive') }}" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                    <i class="ti ti-arrow-left mr-2"></i>Back to Roles
                </a>
                <button type="button" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green-700 focus:ring-4 focus:ring-ecs-green/50" data-modal-target="assignUserModal" data-modal-toggle="assignUserModal">
                    <i class="ti ti-user-plus mr-2"></i>Assign User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Users List -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="ti ti-users mr-2 text-ecs-green"></i>
            Users with this Role
        </h3>
        {% if users %}
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
            {{ users|length }} total
        </span>
        {% endif %}
    </div>

    {% if users %}
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-6 py-3">User</th>
                    <th scope="col" class="px-6 py-3">Email</th>
                    <th scope="col" class="px-6 py-3">Player</th>
                    <th scope="col" class="px-6 py-3">Assigned</th>
                    <th scope="col" class="px-6 py-3 w-24">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="relative inline-flex mr-3">
                                {% if user.player and user.player.profile_picture_url %}
                                <img class="w-10 h-10 rounded-full object-cover" src="{{ user.player.profile_picture_url }}" alt="{{ user.username }}" />
                                {% else %}
                                <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center font-medium text-gray-600 dark:text-gray-300">
                                    {{ user.username[0].upper() }}
                                </div>
                                {% endif %}
                            </div>
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">{{ user.username }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">ID: {{ user.id }}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        {% if user.email %}
                        <span class="text-gray-700 dark:text-gray-300">{{ user.email }}</span>
                        {% else %}
                        <span class="text-gray-400 dark:text-gray-500 italic">No email</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        {% if user.player %}
                        <a href="{{ url_for('players.player_profile', player_id=user.player.id) }}" class="text-ecs-green hover:underline">
                            {{ user.player.name }}
                        </a>
                        {% else %}
                        <span class="text-gray-400 dark:text-gray-500 italic">Not linked</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-xs text-gray-500 dark:text-gray-400">
                        {% if user.created_at %}
                        {{ user.created_at.strftime('%b %d, %Y') }}
                        {% else %}
                        <span class="text-gray-400">Unknown</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-1">
                            <a href="{{ url_for('admin_panel.user_detail', user_id=user.id) }}" class="p-2 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg" title="View User">
                                <i class="ti ti-eye"></i>
                            </a>
                            <button type="button" class="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg" data-action="remove-user" data-user-id="{{ user.id }}" data-username="{{ user.username }}" title="Remove from Role">
                                <i class="ti ti-user-minus"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="flex items-center justify-center w-16 h-16 mx-auto rounded-full bg-gray-100 dark:bg-gray-700 mb-4">
            <i class="ti ti-users-group text-3xl text-gray-400 dark:text-gray-500"></i>
        </div>
        <h5 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No Users Assigned</h5>
        <p class="text-gray-500 dark:text-gray-400 mb-4">No users have been assigned to this role yet.</p>
        <button type="button" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green-700 focus:ring-4 focus:ring-ecs-green/50" data-modal-target="assignUserModal" data-modal-toggle="assignUserModal">
            <i class="ti ti-user-plus mr-2"></i>Assign First User
        </button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block modals %}
<!-- Assign User Modal -->
<div id="assignUserModal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 overflow-y-auto overflow-x-hidden">
    <div class="fixed inset-0 bg-gray-900/50 dark:bg-gray-900/80"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative w-full max-w-md">
            <div class="relative bg-white rounded-lg shadow dark:bg-gray-800">
                <form method="POST" id="assignUserForm" action="{{ url_for('admin_panel.assign_role_to_user_comprehensive', role_id=role.id) }}">
                    <div class="flex items-center justify-between p-4 border-b dark:border-gray-700">
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="ti ti-user-plus mr-2 text-ecs-green"></i>
                            Assign User to {{ role.name }}
                        </h3>
                        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="assignUserModal">
                            <i class="ti ti-x text-lg"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="role_id" value="{{ role.id }}">

                        <div class="mb-4">
                            <label for="selectUser" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select User</label>
                            <select id="selectUser" name="user_id" required class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-gray-900 dark:text-white focus:border-ecs-green focus:ring-1 focus:ring-ecs-green">
                                <option value="">Choose a user...</option>
                                {% for available_user in available_users %}
                                <option value="{{ available_user.id }}">{{ available_user.username }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="flex items-start p-4 rounded-lg border bg-blue-50 dark:bg-gray-700 border-blue-300 dark:border-blue-800 text-blue-800 dark:text-blue-400">
                            <i class="ti ti-info-circle flex-shrink-0 w-5 h-5 mr-3"></i>
                            <div class="text-sm">
                                The selected user will be assigned to the <span class="font-medium">{{ role.name }}</span> role.
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-end gap-3 p-4 border-t dark:border-gray-700">
                        <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" data-modal-hide="assignUserModal">Cancel</button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green-700 focus:ring-4 focus:ring-ecs-green/50">
                            <i class="ti ti-user-plus mr-1"></i>Assign User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');
    const roleId = {{ role.id }};

    // Remove user from role
    document.querySelectorAll('[data-action="remove-user"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            const username = this.dataset.username;

            Swal.fire({
                title: 'Remove User from Role?',
                text: `Are you sure you want to remove "${username}" from this role?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, remove',
                confirmButtonColor: '#dc2626',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/admin-panel/roles-management/${roleId}/remove-user/${userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').content
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Removed!', data.message, 'success').then(() => location.reload());
                        } else {
                            Swal.fire('Error', data.message || 'Failed to remove user from role', 'error');
                        }
                    })
                    .catch(() => Swal.fire('Error', 'Failed to remove user from role', 'error'));
                }
            });
        });
    });

    // Form submission
    const assignForm = document.getElementById('assignUserForm');
    if (assignForm) {
        assignForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(assignForm);

            fetch(assignForm.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('assignUserModal').classList.add('hidden');
                    Swal.fire('Success', data.message, 'success').then(() => location.reload());
                } else {
                    Swal.fire('Error', data.message || 'Failed to assign user', 'error');
                }
            })
            .catch(() => Swal.fire('Error', 'Failed to assign user', 'error'));
        });
    }

    // Modal toggle handlers
    document.querySelectorAll('[data-modal-toggle]').forEach(btn => {
        btn.addEventListener('click', function() {
            const modalId = this.dataset.modalTarget;
            const modal = document.getElementById(modalId);
            modal.classList.toggle('hidden');
        });
    });

    document.querySelectorAll('[data-modal-hide]').forEach(btn => {
        btn.addEventListener('click', function() {
            const modalId = this.dataset.modalHide;
            document.getElementById(modalId).classList.add('hidden');
        });
    });
});
</script>
{% endblock %}
