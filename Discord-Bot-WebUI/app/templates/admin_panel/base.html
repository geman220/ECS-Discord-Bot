{% extends "base.html" %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Admin Panel Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-column flex-md-row">
                        <div class="text-center text-md-start mb-3 mb-md-0">
                            <h1 class="text-white mb-2 h3 h-md-1">
                                <i class="ti ti-settings me-2"></i>Admin Panel
                            </h1>
                            <p class="mb-0 opacity-75 small">
                                {% block panel_description %}Centralized administrative control center for ECS FC{% endblock %}
                            </p>
                        </div>
                        <div class="text-center text-md-end">
                            <div class="badge bg-white text-primary mb-2">
                                <i class="ti ti-shield-check me-1"></i>
                                <span class="d-none d-sm-inline">{% if 'Global Admin' in user_roles %}Global Admin{% else %}Pub League Admin{% endif %}</span>
                                <span class="d-sm-none">Admin</span>
                            </div>
                            <div class="small opacity-75">
                                <span class="d-none d-md-inline">Logged in as: </span>
                                <span class="d-md-none">{{ (safe_current_user.name or safe_current_user.username)[:15] }}{% if (safe_current_user.name or safe_current_user.username)|length > 15 %}...{% endif %}</span>
                                <span class="d-none d-md-inline">{{ safe_current_user.name or safe_current_user.username }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation Toggle -->
    <div class="d-lg-none mb-3">
        <button class="btn btn-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#mobileNavigation" aria-expanded="false" aria-controls="mobileNavigation">
            <i class="ti ti-menu-2 me-2"></i>Admin Navigation
        </button>
    </div>

    <!-- Navigation Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary rounded-3 shadow-sm p-3">
                <div class="container">
                    <div class="collapse navbar-collapse" id="mobileNavigation">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0 w-100 justify-content-around flex-lg-row flex-column">
                        <!-- Dashboard -->
                        <li class="nav-item mb-2 mb-lg-0">
                            <a class="nav-link {% if request.endpoint == 'admin_panel.dashboard' %}active{% endif %}" 
                               href="{{ url_for('admin_panel.dashboard') }}">
                                <i class="ti ti-dashboard me-1"></i><span class="d-lg-inline d-md-none">Dashboard</span>
                            </a>
                        </li>
                        
                        <!-- System Management -->
                        <li class="nav-item dropdown mb-2 mb-lg-0">
                            <a class="nav-link dropdown-toggle {% if 'feature_toggles' in request.endpoint or 'monitoring' in request.endpoint or 'cache' in request.endpoint %}active{% endif %}" 
                               href="#" role="button" data-bs-toggle="dropdown">
                                <i class="ti ti-settings me-1"></i><span class="d-lg-inline d-md-none">System</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.feature_toggles') }}">
                                    <i class="ti ti-toggle-left me-2"></i>Feature Toggles</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.system_monitoring') }}">
                                    <i class="ti ti-activity me-2"></i>System Monitoring</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.cache_management') }}">
                                    <i class="ti ti-database me-2"></i>Cache Management</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.api_management') }}">
                                    <i class="ti ti-api me-2"></i>API Management</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.navigation_settings') }}">
                                    <i class="ti ti-navigation me-2"></i>Navigation Settings</a></li>
                                {% if 'Global Admin' in user_roles %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.performance_monitoring') }}">
                                    <i class="ti ti-chart-line me-2"></i>Performance Monitor</a></li>
                                {% endif %}
                            </ul>
                        </li>
                        
                        <!-- User & Communication -->
                        <li class="nav-item dropdown mb-2 mb-lg-0">
                            <a class="nav-link dropdown-toggle {% if 'users' in request.endpoint or 'communication' in request.endpoint or 'message' in request.endpoint %}active{% endif %}" 
                               href="#" role="button" data-bs-toggle="dropdown">
                                <i class="ti ti-users me-1"></i><span class="d-lg-inline d-md-none">Users & Comms</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.user_management') }}">
                                    <i class="ti ti-users me-2"></i>User Management</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.communication_hub') }}">
                                    <i class="ti ti-message-circle me-2"></i>Communication Hub</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.message_template_management') }}">
                                    <i class="ti ti-template me-2"></i>Message Templates</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.push_notifications') }}">
                                    <i class="ti ti-bell me-2"></i>Push Notifications</a></li>
                            </ul>
                        </li>
                        
                        <!-- League Operations -->
                        <li class="nav-item dropdown mb-2 mb-lg-0">
                            <a class="nav-link dropdown-toggle {% if 'match' in request.endpoint or 'substitute' in request.endpoint or 'playoff' in request.endpoint or 'mls' in request.endpoint or 'admin_live' in request.endpoint %}active{% endif %}"
                               href="#" role="button" data-bs-toggle="dropdown">
                                <i class="ti ti-trophy me-1"></i><span class="d-lg-inline d-md-none">League Ops</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.match_operations') }}">
                                    <i class="ti ti-trophy me-2"></i>Match Operations</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_live.dashboard') }}">
                                    <i class="ti ti-broadcast me-2"></i>Live Reporting</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.match_verification') }}">
                                    <i class="ti ti-shield-check me-2"></i>Match Verification</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.substitute_management') }}">
                                    <i class="ti ti-users me-2"></i>Substitute Management</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.playoff_management') }}">
                                    <i class="ti ti-tournament me-2"></i>Playoff Management</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.quick_actions') }}">
                                    <i class="ti ti-bolt me-2"></i>Quick Actions</a></li>
                            </ul>
                        </li>
                        
                        <!-- External Services -->
                        <li class="nav-item dropdown mb-2 mb-lg-0">
                            <a class="nav-link dropdown-toggle {% if 'mobile_features' in request.endpoint or 'discord' in request.endpoint or 'store' in request.endpoint %}active{% endif %}" 
                               href="#" role="button" data-bs-toggle="dropdown">
                                <i class="ti ti-world me-1"></i><span class="d-lg-inline d-md-none">Services</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.mobile_features') }}">
                                    <i class="ti ti-device-mobile me-2"></i>Mobile Features</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.discord_bot_management') }}">
                                    <i class="ti ti-brand-discord me-2"></i>Discord Bot</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_panel.store_management') }}">
                                    <i class="ti ti-shopping-cart me-2"></i>Store Management</a></li>
                            </ul>
                        </li>
                        
                        <!-- Audit & Logs -->
                        <li class="nav-item mb-2 mb-lg-0">
                            <a class="nav-link {% if 'audit' in request.endpoint %}active{% endif %}" 
                               href="{{ url_for('admin_panel.audit_logs') }}">
                                <i class="ti ti-history me-1"></i><span class="d-lg-inline d-md-none">Audit Logs</span>
                            </a>
                        </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- Breadcrumb -->
    {% block breadcrumb %}
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('admin_panel.dashboard') }}">Admin Panel</a>
            </li>
            {% block breadcrumb_items %}{% endblock %}
        </ol>
    </nav>
    {% endblock %}

    <!-- Page Content -->
    {% block panel_content %}{% endblock %}
</div>
{% endblock %}

{% block custom_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-mobile.css') }}">
<style>
/* Enhanced navigation styling */
.nav-pills .nav-link {
    color: #6c757d;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    transition: all 0.2s ease;
}

.nav-pills .nav-link:hover {
    background-color: rgba(13, 110, 253, 0.1);
    color: #0d6efd;
}

.nav-pills .nav-link.active {
    background-color: #0d6efd;
    color: white;
}

.nav-pills .nav-link i {
    font-size: 1.1rem;
}

/* Card hover effects */
.admin-card {
    transition: all 0.2s ease;
    cursor: pointer;
}

.admin-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

/* Status indicators */
.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
}

.status-indicator.active {
    background-color: #28a745;
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
}

.status-indicator.inactive {
    background-color: #dc3545;
    box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
}

/* Additional page-specific styles can go here */
</style>

<!-- Network Status Indicator -->
<div class="network-status status-indicator active" title="Online"></div>

<!-- Toast Container for Mobile Notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
// Mobile-first JavaScript enhancements
document.addEventListener('DOMContentLoaded', function() {
    // Mobile navigation auto-collapse
    const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
    const navbarCollapse = document.querySelector('.navbar-collapse');
    
    navLinks.forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth < 992 && navbarCollapse && navbarCollapse.classList.contains('show')) {
                const bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                if (bsCollapse) {
                    bsCollapse.hide();
                }
            }
        });
    });
    
    // Touch gesture support for cards
    const adminCards = document.querySelectorAll('.admin-card');
    adminCards.forEach(card => {
        let touchStartY = 0;
        
        card.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        });
        
        card.addEventListener('touchend', (e) => {
            const touchEndY = e.changedTouches[0].clientY;
            const diff = touchStartY - touchEndY;
            
            // Simple swipe up gesture for card interaction
            if (Math.abs(diff) > 50 && diff > 0) {
                card.click();
            }
        });
    });
    
    // Progressive loading for heavy content
    if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('loaded');
                }
            });
        });
        
        document.querySelectorAll('.lazy-load').forEach(el => {
            observer.observe(el);
        });
    }
    
    // Responsive table handling
    function handleResponsiveTables() {
        const tables = document.querySelectorAll('.table-responsive table');
        
        tables.forEach(table => {
            if (window.innerWidth < 768) {
                // Add mobile-friendly attributes
                const headers = table.querySelectorAll('th');
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    cells.forEach((cell, index) => {
                        if (headers[index]) {
                            cell.setAttribute('data-label', headers[index].textContent);
                        }
                    });
                });
                
                // Add mobile stack class for very small screens
                if (window.innerWidth < 576) {
                    table.classList.add('table-mobile-stack');
                }
            } else {
                table.classList.remove('table-mobile-stack');
            }
        });
    }
    
    // Call on load and resize
    handleResponsiveTables();
    window.addEventListener('resize', handleResponsiveTables);
    
    // Network status monitoring
    function updateNetworkStatus() {
        const statusIndicator = document.querySelector('.network-status');
        if (statusIndicator) {
            if (navigator.onLine) {
                statusIndicator.className = 'network-status status-indicator active';
                statusIndicator.title = 'Online';
            } else {
                statusIndicator.className = 'network-status status-indicator danger';
                statusIndicator.title = 'Offline';
                
                // Show offline notification
                AdminPanel.showMobileToast('You are currently offline. Some features may not work.', 'warning');
            }
        }
    }
    
    window.addEventListener('online', () => {
        updateNetworkStatus();
        AdminPanel.showMobileToast('Connection restored', 'success');
    });
    
    window.addEventListener('offline', updateNetworkStatus);
    updateNetworkStatus();
    
    // Auto-refresh management for mobile battery optimization
    let autoRefreshInterval;
    function manageAutoRefresh() {
        if (window.innerWidth < 768) {
            // Clear any existing auto-refresh on mobile
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                console.log('Auto-refresh disabled on mobile for battery optimization');
            }
        }
    }
    
    window.addEventListener('resize', manageAutoRefresh);
    manageAutoRefresh();
    
    // Performance monitoring
    if ('PerformanceObserver' in window) {
        const observer = new PerformanceObserver((list) => {
            const entries = list.getEntries();
            entries.forEach(entry => {
                if (entry.entryType === 'navigation') {
                    const loadTime = entry.loadEventEnd - entry.loadEventStart;
                    console.log('Page load time:', loadTime + 'ms');
                    
                    // Warn on slow loading for mobile
                    if (loadTime > 3000 && window.innerWidth < 768) {
                        console.warn('Slow page load detected on mobile');
                    }
                }
            });
        });
        
        try {
            observer.observe({ entryTypes: ['navigation'] });
        } catch (e) {
            console.log('Performance observer not fully supported');
        }
    }
    
    // Prevent double-tap zoom on buttons and forms
    document.querySelectorAll('button, .btn, input, select, textarea').forEach(element => {
        element.addEventListener('touchend', function(e) {
            e.preventDefault();
            this.click();
        });
        
        element.addEventListener('click', function(e) {
            if (e.detail > 1) {
                e.preventDefault();
            }
        });
    });
    
    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});

// Global mobile utilities
window.AdminPanel = {
    isMobile: () => window.innerWidth < 768,
    isTablet: () => window.innerWidth >= 768 && window.innerWidth < 992,
    isDesktop: () => window.innerWidth >= 992,
    
    showMobileToast: (message, type = 'info') => {
        // Mobile-optimized toast notifications
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        const container = document.querySelector('.toast-container');
        if (container) {
            container.appendChild(toast);
            
            const toastInstance = new bootstrap.Toast(toast, {
                autohide: true,
                delay: AdminPanel.isMobile() ? 3000 : 5000
            });
            
            toastInstance.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }
    },
    
    confirmAction: (message, callback) => {
        if (AdminPanel.isMobile()) {
            // Use native confirm on mobile for better UX
            if (confirm(message)) {
                callback();
            }
        } else {
            // Use SweetAlert2 on desktop if available
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: 'Confirm Action',
                    text: message,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes',
                    cancelButtonText: 'No'
                }).then((result) => {
                    if (result.isConfirmed) {
                        callback();
                    }
                });
            } else {
                if (confirm(message)) {
                    callback();
                }
            }
        }
    },
    
    showLoading: (element) => {
        if (element) {
            element.classList.add('loading');
        }
    },
    
    hideLoading: (element) => {
        if (element) {
            element.classList.remove('loading');
        }
    },
    
    // Optimized fetch for mobile
    fetch: async (url, options = {}) => {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), AdminPanel.isMobile() ? 10000 : 30000);
        
        try {
            const response = await fetch(url, {
                ...options,
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            return response;
        } catch (error) {
            clearTimeout(timeoutId);
            
            if (error.name === 'AbortError') {
                AdminPanel.showMobileToast('Request timed out. Please try again.', 'warning');
            } else if (!navigator.onLine) {
                AdminPanel.showMobileToast('No internet connection. Please check your network.', 'danger');
            }
            
            throw error;
        }
    }
};

// Register service worker for offline support
if ('serviceWorker' in navigator && 'caches' in window) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/js/sw.js')
            .then(registration => {
                console.log('SW registered:', registration);
            })
            .catch(error => {
                console.log('SW registration failed:', error);
            });
    });
}

// Prevent iOS bounce scroll
document.body.addEventListener('touchstart', function(e) {
    if (e.target === document.body) {
        e.preventDefault();
    }
}, { passive: false });

document.body.addEventListener('touchend', function(e) {
    if (e.target === document.body) {
        e.preventDefault();
    }
}, { passive: false });

document.body.addEventListener('touchmove', function(e) {
    if (e.target === document.body) {
        e.preventDefault();
    }
}, { passive: false });
</script>
{% endblock %}