{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert %}

{% block admin_title %}Mobile User Management{% endblock %}
{% block panel_description %}Advanced mobile user administration and access control{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.mobile_features') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">Mobile Features</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">User Management</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- User Management Header -->
<div class="flex items-center p-4 mb-6 text-ecs-green rounded-lg bg-ecs-green/10 dark:bg-ecs-green/20" role="alert">
    <i class="ti ti-users-group mr-3 text-xl"></i>
    <div>
        <span class="font-medium">Mobile User Management</span>
        <p class="text-sm opacity-80">Manage mobile app user permissions, access levels, and account settings.</p>
    </div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg shadow p-5">
        <div class="flex flex-col items-center text-center">
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/50 mb-3">
                <i class="ti ti-users text-2xl text-blue-600 dark:text-blue-400"></i>
            </div>
            <h3 class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ stats.total_users or 0 }}</h3>
            <span class="text-sm text-blue-700 dark:text-blue-300">Total Users</span>
        </div>
    </div>
    <div class="bg-green-50 dark:bg-green-900/30 rounded-lg shadow p-5">
        <div class="flex flex-col items-center text-center">
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/50 mb-3">
                <i class="ti ti-user-check text-2xl text-green-600 dark:text-green-400"></i>
            </div>
            <h3 class="text-2xl font-bold text-green-600 dark:text-green-400">{{ stats.verified_users or 0 }}</h3>
            <span class="text-sm text-green-700 dark:text-green-300">Verified Users</span>
        </div>
    </div>
    <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-lg shadow p-5">
        <div class="flex flex-col items-center text-center">
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-yellow-100 dark:bg-yellow-900/50 mb-3">
                <i class="ti ti-user-exclamation text-2xl text-yellow-600 dark:text-yellow-400"></i>
            </div>
            <h3 class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{{ stats.pending_users or 0 }}</h3>
            <span class="text-sm text-yellow-700 dark:text-yellow-300">Pending Approval</span>
        </div>
    </div>
    <div class="bg-red-50 dark:bg-red-900/30 rounded-lg shadow p-5">
        <div class="flex flex-col items-center text-center">
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/50 mb-3">
                <i class="ti ti-user-off text-2xl text-red-600 dark:text-red-400"></i>
            </div>
            <h3 class="text-2xl font-bold text-red-600 dark:text-red-400">{{ stats.suspended_users or 0 }}</h3>
            <span class="text-sm text-red-700 dark:text-red-300">Suspended</span>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
    <div class="p-5 border-b border-gray-200 dark:border-gray-700">
        <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="ti ti-bolt mr-2"></i>Quick Actions
        </h5>
    </div>
    <div class="p-5">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <button type="button" class="flex items-center justify-center px-4 py-3 text-sm font-medium text-green-600 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800" data-action="approve-all-pending">
                <i class="ti ti-checks mr-2"></i>Approve Pending
            </button>
            <button type="button" class="flex items-center justify-center px-4 py-3 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800" data-action="invite-users">
                <i class="ti ti-user-plus mr-2"></i>Invite Users
            </button>
            <button type="button" class="flex items-center justify-center px-4 py-3 text-sm font-medium text-cyan-600 bg-cyan-50 border border-cyan-200 rounded-lg hover:bg-cyan-100 dark:bg-cyan-900/30 dark:text-cyan-400 dark:border-cyan-800" data-action="export-users">
                <i class="ti ti-download mr-2"></i>Export Users
            </button>
            <button type="button" class="flex items-center justify-center px-4 py-3 text-sm font-medium text-yellow-600 bg-yellow-50 border border-yellow-200 rounded-lg hover:bg-yellow-100 dark:bg-yellow-900/30 dark:text-yellow-400 dark:border-yellow-800" data-action="sync-discord">
                <i class="ti ti-brand-discord mr-2"></i>Sync Discord
            </button>
        </div>
    </div>
</div>

<!-- User Management Sections -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Pending Approvals -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="flex items-center justify-between p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-user-exclamation mr-2 text-yellow-500"></i>Pending Approvals
            </h5>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">
                {{ stats.pending_users or 0 }} pending
            </span>
        </div>
        {% if pending_users %}
        <div class="p-5 space-y-3 max-h-80 overflow-y-auto">
            {% for user in pending_users %}
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div class="flex items-center">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-900/50 flex items-center justify-center mr-3">
                        <span class="text-sm font-medium text-yellow-600 dark:text-yellow-400">{{ user.username[0].upper() if user.username else '?' }}</span>
                    </div>
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white">{{ user.username or 'Unknown' }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">{{ user.email or 'No email' }}</p>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button type="button" class="p-2 text-green-600 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg" data-action="approve-user" data-user-id="{{ user.id }}" title="Approve">
                        <i class="ti ti-check"></i>
                    </button>
                    <button type="button" class="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg" data-action="reject-user" data-user-id="{{ user.id }}" title="Reject">
                        <i class="ti ti-x"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <div class="flex items-center justify-center w-12 h-12 mx-auto rounded-full bg-green-100 dark:bg-green-900/50 mb-3">
                <i class="ti ti-check text-xl text-green-600 dark:text-green-400"></i>
            </div>
            <p class="text-gray-500 dark:text-gray-400">No pending approvals</p>
        </div>
        {% endif %}
    </div>

    <!-- Recent Activity -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="flex items-center justify-between p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="ti ti-activity mr-2 text-blue-500"></i>Recent Activity
            </h5>
            <a href="#" class="text-sm text-blue-600 hover:underline dark:text-blue-400">View All</a>
        </div>
        <div class="p-5 space-y-3 max-h-80 overflow-y-auto">
            {% for activity in recent_activities or [{'user': 'John Doe', 'action': 'Logged in', 'time': '2 min ago', 'type': 'login'}, {'user': 'Jane Smith', 'action': 'Updated profile', 'time': '15 min ago', 'type': 'update'}, {'user': 'Mike Brown', 'action': 'Enabled push', 'time': '1 hour ago', 'type': 'settings'}] %}
            <div class="flex items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div class="flex-shrink-0 w-10 h-10 rounded-full {{ 'bg-green-100 dark:bg-green-900/50' if activity.type == 'login' else 'bg-blue-100 dark:bg-blue-900/50' if activity.type == 'update' else 'bg-cyan-100 dark:bg-cyan-900/50' }} flex items-center justify-center mr-3">
                    <i class="ti ti-{{ 'login' if activity.type == 'login' else 'edit' if activity.type == 'update' else 'settings' }} {{ 'text-green-600 dark:text-green-400' if activity.type == 'login' else 'text-blue-600 dark:text-blue-400' if activity.type == 'update' else 'text-cyan-600 dark:text-cyan-400' }}"></i>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900 dark:text-white">{{ activity.user }}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">{{ activity.action }}</p>
                </div>
                <span class="text-xs text-gray-400 dark:text-gray-500">{{ activity.time }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- User Access Levels -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
    <div class="flex items-center justify-between p-5 border-b border-gray-200 dark:border-gray-700">
        <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="ti ti-shield mr-2"></i>Access Levels
        </h5>
        <button type="button" class="px-3 py-2 text-sm font-medium text-ecs-green bg-ecs-green/10 border border-ecs-green/30 rounded-lg hover:bg-ecs-green/20" data-action="manage-roles">
            <i class="ti ti-settings mr-1"></i>Manage Roles
        </button>
    </div>
    <div class="p-5">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <h6 class="font-medium text-gray-900 dark:text-white">Admin</h6>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">
                        {{ stats.admin_users or 0 }}
                    </span>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Full administrative access to all mobile features</p>
                <div class="mt-3 flex flex-wrap gap-1">
                    <span class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded">All Features</span>
                    <span class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded">User Mgmt</span>
                </div>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <h6 class="font-medium text-gray-900 dark:text-white">Player</h6>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">
                        {{ stats.player_users or 0 }}
                    </span>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Standard player access to team and match info</p>
                <div class="mt-3 flex flex-wrap gap-1">
                    <span class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded">Schedule</span>
                    <span class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded">Stats</span>
                    <span class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded">RSVP</span>
                </div>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <h6 class="font-medium text-gray-900 dark:text-white">Guest</h6>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-300">
                        {{ stats.guest_users or 0 }}
                    </span>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Limited read-only access to public info</p>
                <div class="mt-3 flex flex-wrap gap-1">
                    <span class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded">View Only</span>
                    <span class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded">Public</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Search & Management -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow">
    <div class="flex flex-wrap items-center justify-between gap-4 p-5 border-b border-gray-200 dark:border-gray-700">
        <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="ti ti-search mr-2"></i>User Search
        </h5>
        <div class="flex gap-2">
            <div class="relative">
                <input type="search" id="user-search" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-64 pl-10 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Search users...">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <i class="ti ti-search text-gray-500 dark:text-gray-400"></i>
                </div>
            </div>
            <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="">All Roles</option>
                <option value="admin">Admin</option>
                <option value="player">Player</option>
                <option value="guest">Guest</option>
            </select>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-4 py-3">User</th>
                    <th scope="col" class="px-4 py-3">Role</th>
                    <th scope="col" class="px-4 py-3">Status</th>
                    <th scope="col" class="px-4 py-3">Last Active</th>
                    <th scope="col" class="px-4 py-3">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users or [] %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-ecs-green/20 flex items-center justify-center mr-3">
                                <span class="text-sm font-medium text-ecs-green">{{ user.username[0].upper() if user.username else '?' }}</span>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">{{ user.username }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ user.email }}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' if user.role == 'admin' else 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300' if user.role == 'player' else 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300' }}">
                            {{ user.role|title }}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' if user.status == 'active' else 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' if user.status == 'pending' else 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' }}">
                            {{ user.status|title }}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-gray-600 dark:text-gray-400">{{ user.last_active or 'Never' }}</td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-1">
                            <button type="button" class="p-2 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg" data-action="edit-user" data-user-id="{{ user.id }}" title="Edit">
                                <i class="ti ti-edit"></i>
                            </button>
                            <button type="button" class="p-2 text-yellow-600 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded-lg" data-action="change-role" data-user-id="{{ user.id }}" title="Change Role">
                                <i class="ti ti-shield"></i>
                            </button>
                            <button type="button" class="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg" data-action="suspend-user" data-user-id="{{ user.id }}" title="Suspend">
                                <i class="ti ti-ban"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr class="bg-white dark:bg-gray-800">
                    <td colspan="5" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                        <i class="ti ti-users text-3xl mb-2 block"></i>
                        No users found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';

    document.addEventListener('DOMContentLoaded', function() {
        // User search functionality
        const searchInput = document.getElementById('user-search');
        if (searchInput) {
            searchInput.addEventListener('input', debounce(function(e) {
                const query = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(query) ? '' : 'none';
                });
            }, 300));
        }
    });

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
})();
</script>
{% endblock %}
