{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, alert %}

{% block admin_title %}API Management{% endblock %}
{% block panel_description %}Monitor and manage API endpoints{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">API Management</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Stats Cards -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="bg-blue-500 text-white rounded-lg shadow p-5">
        <div class="flex justify-between items-center">
            <div>
                <p class="text-3xl font-bold">{{ stats.total_endpoints }}</p>
                <p class="text-sm text-white/80">Total Endpoints</p>
            </div>
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-white/20">
                <i class="ti ti-api text-2xl"></i>
            </div>
        </div>
    </div>
    <div class="bg-green-500 text-white rounded-lg shadow p-5">
        <div class="flex justify-between items-center">
            <div>
                <p class="text-3xl font-bold">{{ stats.active_endpoints }}</p>
                <p class="text-sm text-white/80">Active Endpoints</p>
            </div>
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-white/20">
                <i class="ti ti-check-circle text-2xl"></i>
            </div>
        </div>
    </div>
    <div class="bg-cyan-500 text-white rounded-lg shadow p-5">
        <div class="flex justify-between items-center">
            <div>
                <p class="text-3xl font-bold">{{ "{:,}".format(stats.total_requests_today) }}</p>
                <p class="text-sm text-white/80">Requests Today</p>
            </div>
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-white/20">
                <i class="ti ti-activity text-2xl"></i>
            </div>
        </div>
    </div>
    <div class="bg-yellow-500 text-white rounded-lg shadow p-5">
        <div class="flex justify-between items-center">
            <div>
                <p class="text-3xl font-bold">{{ "%.1f"|format(stats.error_rate) }}%</p>
                <p class="text-sm text-white/80">Error Rate</p>
            </div>
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-white/20">
                <i class="ti ti-alert-triangle text-2xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions & Performance -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Quick Actions -->
    <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="ti ti-rocket mr-2"></i>Quick Actions
            </h5>
        </div>
        <div class="p-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <a href="{{ url_for('admin_panel.api_endpoints') }}" class="flex items-center justify-center px-4 py-3 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                    <i class="ti ti-list mr-2"></i>View All Endpoints
                </a>
                <a href="{{ url_for('admin_panel.api_analytics') }}" class="flex items-center justify-center px-4 py-3 text-sm font-medium text-white bg-cyan-500 rounded-lg hover:bg-cyan-600">
                    <i class="ti ti-chart-line mr-2"></i>View Analytics
                </a>
                <button type="button" class="flex items-center justify-center px-4 py-3 text-sm font-medium text-blue-600 bg-white border border-blue-600 rounded-lg hover:bg-blue-50 dark:bg-gray-800 dark:hover:bg-gray-700" data-action="test-endpoint">
                    <i class="ti ti-test-pipe mr-2"></i>Test Endpoint
                </button>
                <button type="button" class="flex items-center justify-center px-4 py-3 text-sm font-medium text-yellow-600 bg-white border border-yellow-600 rounded-lg hover:bg-yellow-50 dark:bg-gray-800 dark:hover:bg-gray-700" data-action="export-api">
                    <i class="ti ti-download mr-2"></i>Export Data
                </button>
            </div>
        </div>
    </div>

    <!-- Performance -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="ti ti-gauge mr-2"></i>Performance
            </h5>
        </div>
        <div class="p-5">
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Avg Response Time</span>
                    <span class="text-sm font-bold text-gray-900 dark:text-white">{{ "%.3f"|format(stats.avg_response_time) }}s</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                    <div class="bg-green-500 h-2 rounded-full" style="width: {{ (1 - stats.avg_response_time) * 100 }}%"></div>
                </div>
            </div>
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Success Rate</span>
                    <span class="text-sm font-bold text-gray-900 dark:text-white">{{ "%.1f"|format(100 - stats.error_rate) }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: {{ 100 - stats.error_rate }}%"></div>
                </div>
            </div>
            <div class="text-center">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium {{ 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' if stats.error_rate < 2 else 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' if stats.error_rate < 5 else 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' }}">
                    {% if stats.error_rate < 2 %}Excellent{% elif stats.error_rate < 5 %}Good{% else %}Needs Attention{% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Blueprint Breakdown & Recent Activity -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Blueprint Breakdown -->
    <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="ti ti-components mr-2"></i>Endpoint Breakdown by Blueprint
            </h5>
        </div>
        {% if stats.endpoint_breakdown %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                    <tr>
                        <th scope="col" class="px-4 py-3">Blueprint</th>
                        <th scope="col" class="px-4 py-3">Total</th>
                        <th scope="col" class="px-4 py-3">Active</th>
                        <th scope="col" class="px-4 py-3">Requests</th>
                        <th scope="col" class="px-4 py-3">Avg Response</th>
                        <th scope="col" class="px-4 py-3">Health</th>
                    </tr>
                </thead>
                <tbody>
                    {% for blueprint, blueprint_stats in stats.endpoint_breakdown.items() %}
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                        <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">{{ blueprint }}</td>
                        <td class="px-4 py-3">{{ blueprint_stats.count }}</td>
                        <td class="px-4 py-3">{{ blueprint_stats.active }}</td>
                        <td class="px-4 py-3">{{ "{:,}".format(blueprint_stats.total_requests) }}</td>
                        <td class="px-4 py-3">{{ "%.3f"|format(blueprint_stats.avg_response_time) }}s</td>
                        <td class="px-4 py-3">
                            {% set health_score = (blueprint_stats.active / blueprint_stats.count) * 100 if blueprint_stats.count > 0 else 0 %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' if health_score > 80 else 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' if health_score > 60 else 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' }}">
                                {{ "%.0f"|format(health_score) }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-5 text-gray-500 dark:text-gray-400">No endpoint data available</div>
        {% endif %}
    </div>

    <!-- Recent Activity -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="ti ti-activity mr-2"></i>Recent Activity
            </h5>
        </div>
        <div class="p-5">
            {% if recent_activity %}
            <div class="space-y-4">
                {% for activity in recent_activity %}
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-3 h-3 mt-1.5 rounded-full bg-blue-500"></div>
                    <div class="ml-4 flex-1">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-900 dark:text-white">{{ activity.description }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ activity.timestamp.strftime('%H:%M') }}</p>
                            </div>
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-300">API</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 dark:text-gray-400">No recent activity</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Top Endpoints -->
{% call card(title="Top Endpoints", no_padding=true) %}
{% if endpoints %}
<div class="overflow-x-auto">
    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
                <th scope="col" class="px-4 py-3">Endpoint</th>
                <th scope="col" class="px-4 py-3">Blueprint</th>
                <th scope="col" class="px-4 py-3">Methods</th>
                <th scope="col" class="px-4 py-3">Requests</th>
                <th scope="col" class="px-4 py-3">Avg Response</th>
                <th scope="col" class="px-4 py-3">Status</th>
                <th scope="col" class="px-4 py-3">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for endpoint in endpoints %}
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                <td class="px-4 py-3">
                    <code class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">{{ endpoint.path }}</code>
                    {% if endpoint.description %}
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ endpoint.description }}</p>
                    {% endif %}
                </td>
                <td class="px-4 py-3">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">{{ endpoint.blueprint }}</span>
                </td>
                <td class="px-4 py-3">
                    <div class="flex flex-wrap gap-1">
                        {% for method in endpoint.methods %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium {{ 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-300' if method == 'GET' else 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300' if method == 'POST' else 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' if method == 'PUT' else 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' if method == 'DELETE' else 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300' }}">{{ method }}</span>
                        {% endfor %}
                    </div>
                </td>
                <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">{{ "{:,}".format(endpoint.request_count) }}</td>
                <td class="px-4 py-3">{{ "%.3f"|format(endpoint.avg_response_time) }}s</td>
                <td class="px-4 py-3">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' if endpoint.status == 'active' else 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' }}">{{ endpoint.status }}</span>
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-1">
                        <button type="button" class="p-2 text-cyan-600 hover:bg-cyan-100 dark:hover:bg-cyan-900/30 rounded-lg" data-action="view-endpoint" data-endpoint-path="{{ endpoint.path[1:] }}" title="View Details">
                            <i class="ti ti-eye"></i>
                        </button>
                        <button type="button" class="p-2 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg" data-action="test-specific" data-endpoint-path="{{ endpoint.path }}" data-methods="{{ endpoint.methods | tojson }}" title="Test">
                            <i class="ti ti-test-pipe"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div class="p-4 text-center border-t border-gray-200 dark:border-gray-700">
    <a href="{{ url_for('admin_panel.api_endpoints') }}" class="px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800">
        View All Endpoints
    </a>
</div>
{% else %}
<div class="p-5 text-gray-500 dark:text-gray-400">No endpoints available</div>
{% endif %}
{% endcall %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');

    // Test endpoint button
    document.querySelectorAll('[data-action="test-endpoint"]').forEach(btn => {
        btn.addEventListener('click', testEndpoint);
    });

    // Export API button
    document.querySelectorAll('[data-action="export-api"]').forEach(btn => {
        btn.addEventListener('click', exportAPIData);
    });

    // View endpoint details
    document.querySelectorAll('[data-action="view-endpoint"]').forEach(btn => {
        btn.addEventListener('click', function() {
            viewEndpointDetails(this.dataset.endpointPath);
        });
    });

    // Test specific endpoint
    document.querySelectorAll('[data-action="test-specific"]').forEach(btn => {
        btn.addEventListener('click', function() {
            testSpecificEndpoint(this.dataset.endpointPath, JSON.parse(this.dataset.methods));
        });
    });

    function testEndpoint() {
        Swal.fire({
            title: 'Test API Endpoint',
            html: `
                <div class="text-left">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Endpoint Path</label>
                        <input type="text" id="test-endpoint" class="w-full px-3 py-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="/api/example">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Method</label>
                        <select id="test-method" class="w-full px-3 py-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Parameters (JSON)</label>
                        <textarea id="test-params" class="w-full px-3 py-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows="3" placeholder='{"key": "value"}'></textarea>
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Test Endpoint',
            background: isDark ? '#1f2937' : '#ffffff',
            color: isDark ? '#f3f4f6' : '#111827',
            preConfirm: () => {
                const endpoint = document.getElementById('test-endpoint').value;
                const method = document.getElementById('test-method').value;
                const paramsText = document.getElementById('test-params').value;

                if (!endpoint) {
                    Swal.showValidationMessage('Please enter an endpoint path');
                    return false;
                }

                let parameters = {};
                if (paramsText.trim()) {
                    try {
                        parameters = JSON.parse(paramsText);
                    } catch (e) {
                        Swal.showValidationMessage('Invalid JSON in parameters');
                        return false;
                    }
                }

                return { endpoint, method, parameters };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Testing...',
                    text: 'Sending request to endpoint',
                    icon: 'info',
                    background: isDark ? '#1f2937' : '#ffffff',
                    color: isDark ? '#f3f4f6' : '#111827'
                });
            }
        });
    }

    function testSpecificEndpoint(endpoint, methods) {
        Swal.fire({
            title: 'Test Endpoint',
            text: `Test ${endpoint} with method:`,
            input: 'select',
            inputOptions: methods.reduce((obj, method) => {
                obj[method] = method;
                return obj;
            }, {}),
            showCancelButton: true,
            confirmButtonText: 'Test',
            background: isDark ? '#1f2937' : '#ffffff',
            color: isDark ? '#f3f4f6' : '#111827'
        });
    }

    function viewEndpointDetails(endpointPath) {
        Swal.fire({
            title: 'Loading...',
            text: 'Fetching endpoint details',
            icon: 'info',
            background: isDark ? '#1f2937' : '#ffffff',
            color: isDark ? '#f3f4f6' : '#111827'
        });
    }

    function exportAPIData() {
        Swal.fire({
            title: 'Export API Data',
            text: 'Choose export format:',
            input: 'select',
            inputOptions: {
                'csv': 'CSV',
                'json': 'JSON',
                'xlsx': 'Excel'
            },
            showCancelButton: true,
            confirmButtonText: 'Export',
            background: isDark ? '#1f2937' : '#ffffff',
            color: isDark ? '#f3f4f6' : '#111827'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Export Started',
                    text: `API data export in ${result.value.toUpperCase()} format has been queued.`,
                    icon: 'info',
                    background: isDark ? '#1f2937' : '#ffffff',
                    color: isDark ? '#f3f4f6' : '#111827'
                });
            }
        });
    }
});
</script>
{% endblock %}
