{% extends "admin_panel/base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, stat_card %}

{% block admin_title %}Feedback Management{% endblock %}
{% block panel_description %}Manage user feedback and support requests{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <a href="{{ url_for('admin_panel.reports_dashboard') }}" class="ml-1 text-sm font-medium text-gray-500 hover:text-ecs-green dark:text-gray-400 dark:hover:text-white">Reports</a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <i class="ti ti-chevron-right w-4 h-4 text-gray-400"></i>
        <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Feedback</span>
    </div>
</li>
{% endblock %}

{% block panel_content %}
<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Total</p>
                <p class="text-2xl font-bold text-ecs-green">{{ stats.total }}</p>
            </div>
            <div class="p-3 bg-ecs-green/10 rounded-lg">
                <i class="ti ti-message-circle text-2xl text-ecs-green"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Open</p>
                <p class="text-2xl font-bold text-yellow-500">{{ stats.open }}</p>
            </div>
            <div class="p-3 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg">
                <i class="ti ti-alert-circle text-2xl text-yellow-500"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">In Progress</p>
                <p class="text-2xl font-bold text-blue-500">{{ stats.in_progress }}</p>
            </div>
            <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
                <i class="ti ti-clock text-2xl text-blue-500"></i>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Closed</p>
                <p class="text-2xl font-bold text-green-500">{{ stats.closed }}</p>
            </div>
            <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-lg">
                <i class="ti ti-check text-2xl text-green-500"></i>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 mb-6 p-5">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex flex-wrap gap-2">
            <a href="{{ url_for('admin_panel.feedback_list') }}"
               class="px-4 py-2 text-sm font-medium rounded-lg {{ 'bg-ecs-green text-white' if not status_filter else 'bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600' }}">
                All
            </a>
            <a href="{{ url_for('admin_panel.feedback_list', status='Open') }}"
               class="px-4 py-2 text-sm font-medium rounded-lg {{ 'bg-yellow-500 text-white' if status_filter == 'Open' else 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:hover:bg-yellow-900/50' }}">
                Open
            </a>
            <a href="{{ url_for('admin_panel.feedback_list', status='In Progress') }}"
               class="px-4 py-2 text-sm font-medium rounded-lg {{ 'bg-blue-500 text-white' if status_filter == 'In Progress' else 'bg-blue-100 text-blue-700 hover:bg-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:hover:bg-blue-900/50' }}">
                In Progress
            </a>
            <a href="{{ url_for('admin_panel.feedback_list', status='Closed') }}"
               class="px-4 py-2 text-sm font-medium rounded-lg {{ 'bg-green-500 text-white' if status_filter == 'Closed' else 'bg-green-100 text-green-700 hover:bg-green-200 dark:bg-green-900/30 dark:text-green-300 dark:hover:bg-green-900/50' }}">
                Closed
            </a>
        </div>
        <div>
            <select id="priority-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="">All Priorities</option>
                <option value="High" {{ 'selected' if priority_filter == 'High' }}>High</option>
                <option value="Medium" {{ 'selected' if priority_filter == 'Medium' }}>Medium</option>
                <option value="Low" {{ 'selected' if priority_filter == 'Low' }}>Low</option>
            </select>
        </div>
    </div>
</div>

<!-- Feedback List Table -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="ti ti-message-circle mr-2 text-ecs-green"></i>
            Feedback Items
        </h3>
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
            {{ pagination.total }} items
        </span>
    </div>

    {% if feedbacks %}
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-4 py-3">ID</th>
                    <th scope="col" class="px-4 py-3">Subject</th>
                    <th scope="col" class="px-4 py-3">User</th>
                    <th scope="col" class="px-4 py-3">Status</th>
                    <th scope="col" class="px-4 py-3">Priority</th>
                    <th scope="col" class="px-4 py-3">Created</th>
                    <th scope="col" class="px-4 py-3">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for feedback in feedbacks %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">#{{ feedback.id }}</td>
                    <td class="px-4 py-3">
                        <a href="{{ url_for('admin_panel.view_feedback', feedback_id=feedback.id) }}" class="text-ecs-green hover:underline">
                            {{ feedback.subject|truncate(50) }}
                        </a>
                    </td>
                    <td class="px-4 py-3">{{ feedback.user.username if feedback.user else 'Anonymous' }}</td>
                    <td class="px-4 py-3">
                        {% if feedback.status == 'Open' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Open</span>
                        {% elif feedback.status == 'In Progress' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">In Progress</span>
                        {% elif feedback.status == 'Closed' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Closed</span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">{{ feedback.status }}</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        {% if feedback.priority == 'High' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">High</span>
                        {% elif feedback.priority == 'Medium' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Medium</span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">Low</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-xs text-gray-500 dark:text-gray-400">
                        {{ feedback.created_at.strftime('%b %d, %Y') if feedback.created_at else 'N/A' }}
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-1">
                            <a href="{{ url_for('admin_panel.view_feedback', feedback_id=feedback.id) }}" class="p-2 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg" title="View">
                                <i class="ti ti-eye"></i>
                            </a>
                            {% if feedback.status != 'Closed' %}
                            <button type="button" class="p-2 text-green-600 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg" data-action="close-feedback" data-feedback-id="{{ feedback.id }}" title="Close">
                                <i class="ti ti-check"></i>
                            </button>
                            {% endif %}
                            <button type="button" class="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg" data-action="delete-feedback" data-feedback-id="{{ feedback.id }}" title="Delete">
                                <i class="ti ti-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <div class="flex items-center justify-center p-4 border-t border-gray-200 dark:border-gray-700">
        <nav aria-label="Page navigation">
            <ul class="inline-flex -space-x-px text-sm">
                {% if pagination.has_prev %}
                <li>
                    <a href="{{ url_for('admin_panel.feedback_list', page=pagination.prev_num, status=status_filter, priority=priority_filter) }}" class="flex items-center justify-center px-3 h-8 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
                        <i class="ti ti-chevron-left"></i>
                    </a>
                </li>
                {% endif %}

                {% for p in range(1, pagination.pages + 1) %}
                    {% if p >= pagination.page - 2 and p <= pagination.page + 2 %}
                    <li>
                        <a href="{{ url_for('admin_panel.feedback_list', page=p, status=status_filter, priority=priority_filter) }}" class="flex items-center justify-center px-3 h-8 leading-tight {{ 'text-white bg-ecs-green border-ecs-green' if p == pagination.page else 'text-gray-500 bg-white border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white' }} border">
                            {{ p }}
                        </a>
                    </li>
                    {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                <li>
                    <a href="{{ url_for('admin_panel.feedback_list', page=pagination.next_num, status=status_filter, priority=priority_filter) }}" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
                        <i class="ti ti-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}

    {% else %}
    <div class="text-center py-12">
        <div class="flex items-center justify-center w-16 h-16 mx-auto rounded-full bg-gray-100 dark:bg-gray-700 mb-4">
            <i class="ti ti-message-off text-3xl text-gray-400 dark:text-gray-500"></i>
        </div>
        <h5 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No Feedback Found</h5>
        <p class="text-gray-500 dark:text-gray-400">No feedback found with current filters.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');

    // Priority filter change
    document.getElementById('priority-filter').addEventListener('change', function() {
        const priority = this.value;
        const url = new URL(window.location.href);
        if (priority) {
            url.searchParams.set('priority', priority);
        } else {
            url.searchParams.delete('priority');
        }
        window.location.href = url.toString();
    });

    // Close feedback action
    document.querySelectorAll('[data-action="close-feedback"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const feedbackId = this.dataset.feedbackId;

            Swal.fire({
                title: 'Close Feedback?',
                text: 'Are you sure you want to close this feedback?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, close it',
                confirmButtonColor: '#1a472a',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/admin-panel/feedback/${feedbackId}/close`;

                    const csrfToken = document.querySelector('meta[name=csrf-token]');
                    if (csrfToken) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'csrf_token';
                        input.value = csrfToken.getAttribute('content');
                        form.appendChild(input);
                    }

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        });
    });

    // Delete feedback action
    document.querySelectorAll('[data-action="delete-feedback"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const feedbackId = this.dataset.feedbackId;

            Swal.fire({
                title: 'Delete Feedback?',
                text: 'This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                confirmButtonColor: '#dc2626',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/admin-panel/feedback/${feedbackId}/delete`;

                    const csrfToken = document.querySelector('meta[name=csrf-token]');
                    if (csrfToken) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'csrf_token';
                        input.value = csrfToken.getAttribute('content');
                        form.appendChild(input);
                    }

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        });
    });
});
</script>
{% endblock %}
