{% extends "admin_panel/base.html" %}

{% block title %}Discord Role Sync - Admin Panel{% endblock %}

{% block panel_description %}Discord role synchronization management{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_panel.discord_overview') }}">Discord Management</a></li>
<li class="breadcrumb-item active">Role Sync</li>
{% endblock %}

{% block panel_content %}
<div class="row">
    <!-- Stats -->
    <div class="col-md-6 mb-4">
        <div class="c-card h-100 bg-info bg-opacity-10">
            <div class="c-card__body text-center">
                <i class="ti ti-refresh fs-1 text-info mb-2"></i>
                <h2 class="mb-0">{{ players_needing_sync }}</h2>
                <p class="text-muted mb-0">Players Needing Sync</p>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="c-card h-100 bg-warning bg-opacity-10">
            <div class="c-card__body text-center">
                <i class="ti ti-alert-triangle fs-1 text-warning mb-2"></i>
                <h2 class="mb-0">{{ players_needs_update }}</h2>
                <p class="text-muted mb-0">Flagged for Update</p>
            </div>
        </div>
    </div>

    <!-- Mass Sync Section -->
    <div class="col-12 mb-4">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="mb-0"><i class="ti ti-bolt me-2"></i>Mass Role Synchronization</h5>
            </div>
            <div class="c-card__body">
                <p class="text-muted">Synchronize Discord roles for all players who need updates. This process runs in the background and may take several minutes to complete.</p>

                <div class="row">
                    <div class="col-md-6">
                        <h6>Sync All Players</h6>
                        <p class="small text-muted">Updates Discord roles for all players with Discord IDs.</p>
                        <button id="mass-sync-btn" class="c-btn c-btn--primary">
                            <i class="ti ti-bolt me-2"></i>Start Mass Sync
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>Sync Flagged Players</h6>
                        <p class="small text-muted">Only sync players who are flagged as needing an update.</p>
                        <button id="sync-flagged-btn" class="c-btn c-btn--outline-primary">
                            <i class="ti ti-flag me-2"></i>Sync Flagged Only
                        </button>
                    </div>
                </div>

                <!-- Progress Section (hidden by default) -->
                <div id="sync-progress" class="mt-4 d-none">
                    <h6>Sync Progress</h6>
                    <div class="progress mb-2" class="u-h-25">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" data-width="0">0%</div>
                    </div>
                    <p id="sync-status" class="small text-muted">Starting sync...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Status Section -->
    <div class="col-12 mb-4">
        <div class="c-card">
            <div class="c-card__header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="ti ti-list-check me-2"></i>Recent Sync Tasks</h5>
                <button id="refresh-tasks-btn" class="c-btn c-btn--sm c-btn--outline-secondary" aria-label="Refresh"><i class="ti ti-refresh"></i></button>
            </div>
            <div class="c-card__body">
                <div id="task-list">
                    <p class="text-muted text-center">No recent tasks</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Information -->
    <div class="col-12">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="mb-0"><i class="ti ti-info-circle me-2"></i>Role Sync Information</h5>
            </div>
            <div class="c-card__body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>What gets synced?</h6>
                        <ul class="small text-muted">
                            <li>Team roles based on current season assignments</li>
                            <li>League roles (Pub League Classic, Premier, ECS FC)</li>
                            <li>Captain roles for team captains</li>
                            <li>Admin roles for designated administrators</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>How it works</h6>
                        <ul class="small text-muted">
                            <li>Tasks are processed in batches to avoid rate limits</li>
                            <li>Players are marked as synced after successful update</li>
                            <li>Errors are logged for troubleshooting</li>
                            <li>Background processing allows continued use of the panel</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
let activeTaskId = null;

function startMassSync() {
    if (!confirm('This will sync Discord roles for all players. This may take several minutes. Continue?')) return;

    const btn = document.getElementById('mass-sync-btn');
    btn.innerHTML = '<i class="ti ti-loader spin me-2"></i>Starting...';
    btn.disabled = true;

    fetch('{{ url_for("admin_panel.discord_mass_sync_roles") }}', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                AdminPanel.showMobileToast(data.message, 'success');
                activeTaskId = data.task_id;
                document.getElementById('sync-progress').classList.remove('d-none');
                pollTaskStatus();
            } else {
                AdminPanel.showMobileToast('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            AdminPanel.showMobileToast('Error starting sync', 'danger');
        })
        .finally(() => {
            btn.innerHTML = '<i class="ti ti-bolt me-2"></i>Start Mass Sync';
            btn.disabled = false;
        });
}

function pollTaskStatus() {
    if (!activeTaskId) return;

    fetch(`{{ url_for('admin_panel.discord_check_role_status', task_id='TASK_ID') }}`.replace('TASK_ID', activeTaskId))
        .then(response => response.json())
        .then(data => {
            const statusEl = document.getElementById('sync-status');
            const progressBar = document.getElementById('progress-bar');

            if (data.state === 'COMPLETE') {
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                progressBar.classList.remove('progress-bar-animated');
                statusEl.textContent = 'Sync completed successfully!';
                AdminPanel.showMobileToast('Sync completed', 'success');
                activeTaskId = null;
            } else if (data.state === 'FAILED') {
                progressBar.classList.remove('bg-primary');
                progressBar.classList.add('bg-danger');
                statusEl.textContent = 'Sync failed: ' + data.error;
                AdminPanel.showMobileToast('Sync failed', 'danger');
                activeTaskId = null;
            } else if (data.state === 'PENDING') {
                statusEl.textContent = 'Processing...';
                setTimeout(pollTaskStatus, 2000);
            }
        })
        .catch(error => {
            console.error('Error polling task status:', error);
            setTimeout(pollTaskStatus, 5000);
        });
}

document.getElementById('mass-sync-btn').addEventListener('click', startMassSync);
document.getElementById('sync-flagged-btn').addEventListener('click', startMassSync);

// Spin animation
const style = document.createElement('style');
style.textContent = `.spin { animation: spin 1s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`;
document.head.appendChild(style);
</script>
{% endblock %}
