{% extends "admin_panel/base.html" %}

{% block title %}Discord Management - Admin Panel{% endblock %}

{% block panel_description %}Discord server management and player status overview{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">Discord Management</li>
{% endblock %}

{% block panel_content %}
<div class="row">
    <!-- Stats Cards -->
    <div class="col-md-4 col-sm-6 mb-4">
        <div class="c-card h-100 bg-primary bg-opacity-10">
            <div class="c-card__body text-center">
                <i class="ti ti-users fs-1 text-primary mb-2"></i>
                <h3 class="mb-0" id="total-players">{{ stats.total_players }}</h3>
                <small class="text-muted">Total Players with Discord</small>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-4">
        <div class="c-card h-100 bg-success bg-opacity-10">
            <div class="c-card__body text-center">
                <i class="ti ti-check fs-1 text-success mb-2"></i>
                <h3 class="mb-0" id="in-server">{{ stats.in_server }}</h3>
                <small class="text-muted">In Discord Server</small>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-4">
        <div class="c-card h-100 bg-danger bg-opacity-10">
            <div class="c-card__body text-center">
                <i class="ti ti-x fs-1 text-danger mb-2"></i>
                <h3 class="mb-0" id="not-in-server">{{ stats.not_in_server }}</h3>
                <small class="text-muted">Not In Server</small>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-4">
        <div class="c-card h-100 bg-warning bg-opacity-10">
            <div class="c-card__body text-center">
                <i class="ti ti-question-mark fs-1 text-warning mb-2"></i>
                <h3 class="mb-0" id="unknown-status">{{ stats.unknown_status }}</h3>
                <small class="text-muted">Unknown Status</small>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-4">
        <div class="c-card h-100 bg-info bg-opacity-10">
            <div class="c-card__body text-center">
                <i class="ti ti-refresh fs-1 text-info mb-2"></i>
                <h3 class="mb-0" id="needs-sync">{{ stats.needs_sync }}</h3>
                <small class="text-muted">Needs Role Sync</small>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-4">
        <div class="c-card h-100">
            <div class="c-card__body text-center d-flex flex-column justify-content-center">
                <button id="refresh-stats" class="c-btn c-btn--outline-primary mb-2">
                    <i class="ti ti-refresh me-2"></i>Refresh Stats
                </button>
                <small class="text-muted" id="last-updated">Click to update</small>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-12 mb-4">
        <div class="c-card">
            <div class="c-card__header">
                <h5 class="mb-0"><i class="ti ti-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="c-card__body">
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('admin_panel.discord_players') }}" class="c-btn c-btn--primary w-100">
                            <i class="ti ti-users me-2"></i>Manage Players
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('admin_panel.discord_roles') }}" class="c-btn c-btn--info w-100">
                            <i class="ti ti-shield me-2"></i>Role Sync
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('admin_panel.discord_role_mapping') }}" class="c-btn c-btn--secondary w-100">
                            <i class="ti ti-link me-2"></i>Role Mapping
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('admin_panel.discord_onboarding') }}" class="c-btn c-btn--success w-100">
                            <i class="ti ti-user-plus me-2"></i>Onboarding
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <button id="refresh-unknown-btn" class="c-btn c-btn--warning w-100">
                            <i class="ti ti-search me-2"></i>Check Unknown
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Sections -->
    <div class="col-md-6 mb-4">
        <div class="c-card h-100">
            <div class="c-card__header">
                <h5 class="mb-0"><i class="ti ti-users me-2"></i>Player Management</h5>
            </div>
            <div class="c-card__body">
                <p class="text-muted">View and manage Discord status for all players.</p>
                <div class="list-group list-group-flush">
                    <a href="{{ url_for('admin_panel.discord_players', status='not_in_server') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="ti ti-user-x me-2"></i>Not In Server</span>
                        <span class="badge bg-danger" data-badge>{{ stats.not_in_server }}</span>
                    </a>
                    <a href="{{ url_for('admin_panel.discord_players', status='unknown') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="ti ti-user-question me-2"></i>Unknown Status</span>
                        <span class="badge bg-warning" data-badge>{{ stats.unknown_status }}</span>
                    </a>
                    <a href="{{ url_for('admin_panel.discord_players', status='in_server') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="ti ti-user-check me-2"></i>In Server</span>
                        <span class="badge bg-success" data-badge>{{ stats.in_server }}</span>
                    </a>
                    <a href="{{ url_for('admin_panel.discord_players', status='all') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="ti ti-users me-2"></i>All Players</span>
                        <span class="badge bg-primary" data-badge>{{ stats.total_players }}</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="c-card h-100">
            <div class="c-card__header">
                <h5 class="mb-0"><i class="ti ti-shield me-2"></i>Role Synchronization</h5>
            </div>
            <div class="c-card__body">
                <p class="text-muted">Manage Discord role assignments for players.</p>
                <div class="list-group list-group-flush">
                    <a href="{{ url_for('admin_panel.discord_roles') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="ti ti-refresh me-2"></i>Needs Sync</span>
                        <span class="badge bg-info" data-badge>{{ stats.needs_sync }}</span>
                    </a>
                    <button class="list-group-item list-group-item-action" id="mass-sync-btn">
                        <i class="ti ti-bolt me-2"></i>Mass Sync All Roles
                    </button>
                </div>
                <hr>
                <a href="{{ url_for('admin_panel.discord_onboarding') }}" class="c-btn c-btn--outline-success w-100">
                    <i class="ti ti-user-plus me-2"></i>View Onboarding Status
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
function refreshStats() {
    const btn = document.getElementById('refresh-stats');
    btn.innerHTML = '<i class="ti ti-loader spin me-2"></i>Refreshing...';
    btn.disabled = true;

    fetch('{{ url_for("admin_panel.discord_stats_api") }}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                AdminPanel.showMobileToast('Error: ' + data.error, 'danger');
                return;
            }

            document.getElementById('total-players').textContent = data.total_players;
            document.getElementById('in-server').textContent = data.in_server;
            document.getElementById('not-in-server').textContent = data.not_in_server;
            document.getElementById('unknown-status').textContent = data.unknown_status;
            document.getElementById('needs-sync').textContent = data.needs_sync;
            document.getElementById('last-updated').textContent = 'Updated: ' + new Date().toLocaleTimeString();

            AdminPanel.showMobileToast('Stats refreshed', 'success');
        })
        .catch(error => {
            AdminPanel.showMobileToast('Error refreshing stats', 'danger');
        })
        .finally(() => {
            btn.innerHTML = '<i class="ti ti-refresh me-2"></i>Refresh Stats';
            btn.disabled = false;
        });
}

function refreshUnknownStatus() {
    const btn = document.getElementById('refresh-unknown-btn');
    btn.innerHTML = '<i class="ti ti-loader spin me-2"></i>Checking...';
    btn.disabled = true;

    fetch('{{ url_for("admin_panel.discord_refresh_unknown_status") }}', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                AdminPanel.showMobileToast(data.message, 'success');
                refreshStats();
            } else {
                AdminPanel.showMobileToast('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            AdminPanel.showMobileToast('Error checking status', 'danger');
        })
        .finally(() => {
            btn.innerHTML = '<i class="ti ti-search me-2"></i>Check Unknown';
            btn.disabled = false;
        });
}

function massSyncRoles() {
    if (!confirm('This will sync Discord roles for all players. Continue?')) return;

    const btn = document.getElementById('mass-sync-btn');
    btn.innerHTML = '<i class="ti ti-loader spin me-2"></i>Syncing...';
    btn.disabled = true;

    fetch('{{ url_for("admin_panel.discord_mass_sync_roles") }}', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                AdminPanel.showMobileToast(data.message, 'success');
            } else {
                AdminPanel.showMobileToast('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            AdminPanel.showMobileToast('Error syncing roles', 'danger');
        })
        .finally(() => {
            btn.innerHTML = '<i class="ti ti-bolt me-2"></i>Mass Sync All Roles';
            btn.disabled = false;
        });
}

document.getElementById('refresh-stats').addEventListener('click', refreshStats);
document.getElementById('refresh-unknown-btn').addEventListener('click', refreshUnknownStatus);
document.getElementById('mass-sync-btn').addEventListener('click', massSyncRoles);

// Add spin animation
const style = document.createElement('style');
style.textContent = `
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
`;
document.head.appendChild(style);
</script>
{% endblock %}
