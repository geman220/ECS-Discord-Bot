{% extends "base.html" %}

{% block title %}ECS FC Management{% endblock %}

{% block custom_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/features/schedule-manager.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/schedule-wizard.css') }}">
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Provide leagues data to JavaScript
    window.leagues = {{ leagues | tojson | safe }};
    window.seasonId = {{ season.id }};
</script>
<script src="{{ url_for('static', filename='custom_js/ecsfc-schedule.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/schedule-management.js') }}"></script>
{% endblock %}

{% block main_content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="c-schedule-manager" data-component="schedule-manager">
        <div class="c-schedule-manager__header">
            <h2 class="c-schedule-manager__title">ECS FC Management</h2>
        </div>

        <!-- Tabbed Interface for Leagues -->
        <div class="c-schedule-manager__tabs">
            <ul class="nav nav-tabs" id="leagueTabs" role="tablist" data-tabs>
                {% for league in leagues %}
                <li class="nav-item">
                    <a class="nav-link {% if loop.first %}active{% endif %}"
                       id="{{ league.name }}-tab"
                       data-bs-toggle="tab"
                       href="#{{ league.name }}"
                       role="tab"
                       aria-controls="{{ league.name }}"
                       aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                        {{ league.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>

            <div class="tab-content mt-4" id="leagueTabsContent">
                {% for league in leagues %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
                     id="{{ league.name }}"
                     role="tabpanel"
                     aria-labelledby="{{ league.name }}-tab"
                     data-tab-pane>

                    <!-- Bulk Match Creation Form -->
                    <div class="c-schedule-manager__bulk-form c-card mb-4">
                        <div class="c-card__header c-schedule-manager__bulk-header">
                            <h6 class="c-schedule-manager__bulk-title">
                                Bulk Match Creation for {{ league.name }}
                            </h6>
                            <button class="c-btn c-btn--primary"
                                    data-action="generate-form"
                                    data-league-name="{{ league.name }}">
                                Generate Input Form
                            </button>
                        </div>
                        <div class="c-card__body">
                            <form method="POST"
                                  id="bulkCreationForm-{{ league.name }}"
                                  action="{{ url_for('publeague.schedule.bulk_create_ecsfc_matches', season_id=season.id, league_name=league.name) }}"
                                  data-component="bulk-form">
                                {{ form_hidden_fields() }}
                                <div class="row g-3">
                                    {{ form_input_group("Total Weeks", "number", "total_weeks", "11", league.name) }}
                                    {{ form_input_group("Matches per Week", "number", "matches_per_week", "8", league.name) }}
                                    {{ form_input_group("Start Time", "time", "start_time", "", league.name) }}
                                    {{ form_input_group("Fun Week (No Matches)", "number", "fun_week", "9", league.name) }}
                                    {{ form_input_group("TST Week (No Matches)", "number", "tst_week", "11", league.name) }}
                                    {{ form_select_group("Default Location", "location", ["North", "South"], league.name) }}
                                </div>
                            </form>
                            <button type="button"
                                    class="c-btn c-btn--secondary mt-2"
                                    data-bs-toggle="modal"
                                    data-bs-target="#addWeekModal"
                                    data-action="add-single-week"
                                    data-league-name="{{ league.name }}">
                                Add Single Week
                            </button>
                        </div>
                    </div>

                    <!-- Detailed Input Form for Bulk Matches -->
                    <div id="detailedInputForm-{{ league.name }}"
                         class="c-schedule-manager__detailed-form"></div>

                    <!-- Current Schedule Display -->
                    <div class="c-card mt-4">
                        <div class="c-card__header">
                            <h6 class="c-schedule-manager__schedule-title">
                                Current Schedule for {{ league.name }}
                            </h6>
                        </div>
                        <div class="c-card__body">
                            {% if schedule[league.name] %}
                            <div class="row g-2">
                                {% for week, data in schedule[league.name].items() %}
                                {{ render_week_card(week, data, season.id, league.name) }}
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="c-schedule-manager__empty-state">No matches scheduled yet.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Add Week Modal -->
{{ render_add_week_modal() }}

<!-- Edit Match Modal -->
{{ render_edit_match_modal() }}

{% endblock %}

{% macro form_hidden_fields() %}
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
{% endmacro %}

{% macro form_input_group(label, type, name, defaultValue, leagueName) %}
<div class="col-12 col-sm-6 col-md-3">
    <label for="{{ name }}-{{ leagueName }}" class="c-form-group__label">{{ label }}</label>
    <input type="{{ type }}"
           class="c-form-group__input"
           id="{{ name }}-{{ leagueName }}"
           name="{{ name }}"
           value="{{ defaultValue }}"
           required
           data-form-control>
</div>
{% endmacro %}

{% macro form_select_group(label, name, options, leagueName) %}
<div class="col-12 col-sm-6 col-md-3">
    <label for="{{ name }}-{{ leagueName }}" class="c-form-group__label">{{ label }}</label>
    <select class="c-form-group__input"
            id="{{ name }}-{{ leagueName }}"
            name="{{ name }}"
            data-form-select>
        {% for option in options %}
        <option value="{{ option }}">{{ option }}</option>
        {% endfor %}
    </select>
</div>
{% endmacro %}

{% macro render_week_card(week, data, season_id, league_name) %}
<div class="col-12 col-md-6 col-lg-4 mb-4">
    <div class="c-week-card c-card h-100" data-component="week-card" data-week="{{ week }}">
        <div class="c-card__header c-week-card__header">
            <h6 class="c-week-card__title">Week {{ week }} - {{ data.date }}</h6>
            <form method="POST"
                  action="{{ url_for('ecsfc.schedule.delete_week', league_type='ecsfc', season_id=season_id, week_number=week) }}"
                  class="c-week-card__delete-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                        class="c-btn c-btn--danger c-btn--sm"
                        data-action="delete-week">
                    Delete Week
                </button>
            </form>
        </div>
        <div class="c-card__body">
            {% set sorted_matches = data.matches | sort(attribute='time') %}
            {% set sorted_matches = sorted_matches | sort(attribute='location', reverse=false) %}
            {% for match in sorted_matches %}
            <div class="c-match-item" data-component="match-item" data-match-id="{{ match.match_id }}">
                <div class="c-match-item__info">
                    <p class="c-match-item__teams">{{ match.team_a }} vs {{ match.team_b }}</p>
                </div>
                <div class="c-match-item__actions">
                    <p class="c-match-item__meta">{{ match.time }} - {{ match.location }}</p>
                    <button class="c-btn c-btn--warning c-btn--sm"
                            data-bs-toggle="modal"
                            data-bs-target="#manage-ecsfc-editModal"
                            data-action="edit-match"
                            data-match-id="{{ match.match_id }}"
                            data-team-a="{{ match.team_a }}"
                            data-team-b="{{ match.team_b }}"
                            data-time="{{ match.time }}"
                            data-location="{{ match.location }}"
                            data-date="{{ match.date }}"
                            data-league-name="{{ league_name }}">
                        Edit
                    </button>
                    <form action="{{ url_for('ecsfc.schedule.delete_match', match_id=match.match_id) }}"
                          method="POST"
                          class="c-match-item__delete-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit"
                                class="c-btn c-btn--danger c-btn--sm"
                                data-action="delete-match">
                            Delete
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endmacro %}

{% macro render_add_week_modal() %}
<div class="modal c-modal fade"
     data-modal
     id="addWeekModal"
     tabindex="-1"
     role="dialog"
     aria-labelledby="addWeekModalLabel"
     aria-hidden="true">
    <div class="modal-dialog c-modal__dialog" data-modal-dialog role="document">
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="addWeekModalLabel">Add New Week</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('publeague.schedule.manage_ecsfc_schedule', season_id=season.id) }}">
                <input type="hidden" name="action" value="add">
                <div class="modal-body c-modal__body" data-modal-body>
                    {{ form_hidden_fields() }}
                    <input type="hidden" id="modal_league_name" name="league_name" value="">
                    <div class="c-form-group">
                        <label for="week" class="c-form-group__label">Week Number</label>
                        <input type="number"
                               class="c-form-group__input"
                               id="week"
                               name="week"
                               required
                               data-form-control>
                    </div>
                    <div class="c-form-group">
                        <label for="manage-ecsfc-date" class="c-form-group__label">Date</label>
                        <input type="date"
                               class="c-form-group__input"
                               id="manage-ecsfc-date"
                               name="date"
                               required
                               data-form-control>
                    </div>
                    <div class="c-form-group">
                        <label for="teamA" class="c-form-group__label">Team A</label>
                        <select class="c-form-group__input" id="teamA" name="teamA" required data-form-select></select>
                    </div>
                    <div class="c-form-group">
                        <label for="teamB" class="c-form-group__label">Team B</label>
                        <select class="c-form-group__input" id="teamB" name="teamB" required data-form-select></select>
                    </div>
                    <div class="c-form-group">
                        <label for="manage-ecsfc-time" class="c-form-group__label">Time</label>
                        <input type="time"
                               class="c-form-group__input"
                               id="manage-ecsfc-time"
                               name="time"
                               required
                               data-form-control>
                    </div>
                    <div class="c-form-group">
                        <label for="manage-ecsfc-location" class="c-form-group__label">Location</label>
                        <select class="c-form-group__input" id="manage-ecsfc-location" name="location" required data-form-select>
                            <option value="North">North</option>
                            <option value="South">South</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer c-modal__footer" data-modal-footer>
                    <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Close</button>
                    <button type="submit" class="c-btn c-btn--primary">Add Week</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endmacro %}

{% macro render_edit_match_modal() %}
<div class="modal c-modal fade"
     data-modal
     id="manage-ecsfc-editModal"
     tabindex="-1"
     role="dialog"
     aria-labelledby="editMatchModalLabel"
     aria-hidden="true">
    <div class="modal-dialog c-modal__dialog" data-modal-dialog role="document">
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="editMatchModalLabel">Edit Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <form method="POST" action="#">
                {{ form_hidden_fields() }}
                <div class="modal-body c-modal__body" data-modal-body>
                    <div class="c-form-group">
                        <label for="edit_team_a" class="c-form-group__label">Team A</label>
                        <select class="c-form-group__input" id="edit_team_a" name="teamA" required data-form-select></select>
                    </div>
                    <div class="c-form-group">
                        <label for="edit_team_b" class="c-form-group__label">Team B</label>
                        <select class="c-form-group__input" id="edit_team_b" name="teamB" required data-form-select></select>
                    </div>
                    <div class="c-form-group">
                        <label for="edit_time" class="c-form-group__label">Time</label>
                        <input type="time" class="c-form-group__input" id="edit_time" name="time" required data-form-control>
                    </div>
                    <div class="c-form-group">
                        <label for="edit_location" class="c-form-group__label">Location</label>
                        <select class="c-form-group__input" id="edit_location" name="location" required data-form-select>
                            <option value="North">North</option>
                            <option value="South">South</option>
                        </select>
                    </div>
                    <input type="hidden" id="edit_date" name="date">
                </div>
                <div class="modal-footer c-modal__footer" data-modal-footer>
                    <button type="button" class="c-btn c-btn--secondary" data-bs-dismiss="modal" data-dismiss>Close</button>
                    <button type="submit" class="c-btn c-btn--primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endmacro %}
