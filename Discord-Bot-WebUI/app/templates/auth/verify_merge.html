{% extends "base_unauthenticated.html" %}

{% block page_css %}

{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/authentication.css') }}" />
{% endif %}
{% endblock %}

{% block main_content %}

<div class="c-auth-wrapper">
    <div class="c-auth-inner">
        <!-- ECS Logos -->
        <div class="c-auth-branding c-auth-branding--desktop">
            <div class="c-auth-branding__content">
                <img src="{{ url_for('static', filename='img/ecs_logo.png') }}" alt="ECS Logo" class="c-auth-branding__logo c-auth-branding__logo--primary">
                <img src="{{ url_for('static', filename='img/ecs_pl_logo.png') }}" alt="ECS FC Pub League Logo" class="c-auth-branding__logo c-auth-branding__logo--secondary">
            </div>
        </div>

        <!-- Verification Content -->
        <div class="c-auth-panel">
            <div class="c-auth-panel__content">

                {% if verification_sent %}
                <!-- Verification Email Sent -->
                <div class="c-auth-status c-auth-status--success">
                    <div class="c-auth-status__icon">
                        <i class="ti ti-mail-check"></i>
                    </div>
                    <h1 class="c-auth-status__title">Verification Email Sent!</h1>
                    <p class="c-auth-status__description">
                        We've sent a verification email to <strong>{{ old_email }}</strong>.
                        Please check your inbox and click the verification link to merge your accounts.
                    </p>

                    <div class="c-alert c-alert--info" role="alert" data-alert>
                        <div class="c-alert__icon">
                            <i class="ti ti-info-circle"></i>
                        </div>
                        <div class="c-alert__content">
                            <h6 class="c-alert__title">What happens next?</h6>
                            <ol class="c-alert__list">
                                <li>Check your email inbox (and spam folder)</li>
                                <li>Click the verification link in the email</li>
                                <li>Your accounts will be automatically merged</li>
                                <li>You'll be able to log in with your new Discord email</li>
                            </ol>
                        </div>
                    </div>

                    <div class="c-auth-actions c-auth-actions--stack">
                        <button type="button"
                                class="c-btn c-btn--secondary c-btn--block js-resend-email"
                                id="resend-email-btn"
                                data-action="resend-email">
                            <i class="ti ti-mail"></i>
                            <span>Resend Email</span>
                        </button>
                        <a href="{{ url_for('auth.login') }}"
                           class="c-btn c-btn--ghost c-btn--block"
                           data-action="back-to-login">
                            <i class="ti ti-arrow-left"></i>
                            <span>Back to Login</span>
                        </a>
                    </div>
                </div>

                {% elif verification_token %}
                <!-- Process Verification Token -->
                <div class="c-auth-status c-auth-status--loading">
                    <div class="c-auth-status__icon c-auth-status__icon--loading">
                        <i class="ti ti-loader-2"></i>
                    </div>
                    <h1 class="c-auth-status__title">Verifying Your Account...</h1>
                    <p class="c-auth-status__description">Please wait while we merge your accounts.</p>
                </div>

                <form method="POST" id="verify-form" data-form="verify-merge">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="token" value="{{ verification_token }}">
                </form>

                {% else %}
                <!-- Invalid or Expired Link -->
                <div class="c-auth-status c-auth-status--warning">
                    <div class="c-auth-status__icon">
                        <i class="ti ti-alert-triangle"></i>
                    </div>
                    <h1 class="c-auth-status__title">Invalid Verification Link</h1>
                    <p class="c-auth-status__description">
                        This verification link is invalid or has expired. Verification links are only valid for 24 hours.
                    </p>

                    <div class="c-alert c-alert--warning" role="alert" data-alert>
                        <div class="c-alert__icon">
                            <i class="ti ti-clock"></i>
                        </div>
                        <div class="c-alert__content">
                            <h6 class="c-alert__title">What can you do?</h6>
                            <p class="c-alert__message">
                                Try logging in with Discord again. If you see the duplicate check screen,
                                you can request a new verification email.
                            </p>
                        </div>
                    </div>

                    <div class="c-auth-actions c-auth-actions--stack">
                        <a href="{{ url_for('auth.login') }}"
                           class="c-btn c-btn--primary c-btn--block"
                           data-action="retry-login">
                            <i class="ti ti-login"></i>
                            <span>Try Logging In Again</span>
                        </a>
                        <a href="mailto:support@ecsfc.com"
                           class="c-btn c-btn--secondary c-btn--block"
                           data-action="contact-support">
                            <i class="ti ti-mail"></i>
                            <span>Contact Support</span>
                        </a>
                    </div>
                </div>
                {% endif %}

                {% if not verification_sent and not verification_token %}
                <!-- Footer Help -->
                <div class="c-auth-footer">
                    <p class="c-auth-help-text">
                        Need help? <a href="mailto:support@ecsfc.com" class="c-link">Contact Support</a>
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script>
    // Pass data to JavaScript
    window.verifyMergeData = {
        hasToken: {{ 'true' if verification_token else 'false' }},
        oldEmail: "{{ old_email if old_email else '' }}",
        csrfToken: "{{ csrf_token() }}",
        resendUrl: "{{ url_for('auth.resend_merge_verification') }}",
        mergeData: {{ merge_data | tojson if merge_data else '{}' }}
    };
</script>
<script src="{{ url_for('static', filename='custom_js/verify-merge.js') }}"></script>
{% endif %}
{% endblock %}