{% extends "base.html" %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Page Header -->
    <div class="c-calendar-header" data-component="calendar-header">
        <div class="c-calendar-header__content">
            <div class="c-calendar-header__info">
                <h4 class="c-calendar-header__title">
                    <i class="ti ti-calendar c-calendar-header__icon"></i>
                    Pub League Calendar
                </h4>
                <nav class="c-calendar-header__breadcrumb" aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="/"><i class="ti ti-home"></i> Home</a>
                        </li>
                        <li class="breadcrumb-item active">Calendar</li>
                    </ol>
                </nav>
            </div>
            <div class="c-calendar-header__actions">
                <button class="c-calendar-btn c-calendar-btn--primary"
                        id="refreshScheduleBtn"
                        data-action="refresh-schedule">
                    <i class="ti ti-refresh"></i>
                    Refresh
                </button>
                {% if can_edit_events %}
                <button class="c-calendar-btn c-calendar-btn--success"
                        id="addLeagueEventBtn"
                        data-action="add-event">
                    <i class="ti ti-calendar-plus"></i>
                    Add Event
                </button>
                {% endif %}
                {% if can_assign_referee and not is_referee %}
                <button class="c-calendar-btn c-calendar-btn--outline"
                        id="toggleAssignmentMode"
                        data-action="toggle-assignment-mode">
                    <i class="ti ti-user-check"></i>
                    Assignment Mode
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    {% if is_referee %}
    <!-- Referee View -->
    <div class="row">
        <!-- My Assignments Section -->
        <div class="col-lg-6 mb-4">
            <div class="c-calendar-card" data-component="calendar-card">
                <div class="c-calendar-card__header">
                    <h5 class="c-calendar-card__title">
                        <i class="ti ti-user-check c-calendar-card__icon"></i>
                        My Assignments
                    </h5>
                    <span class="c-badge c-badge--primary c-badge--pill"
                          id="myAssignmentsCount"
                          data-badge
                          data-count="assignments">0</span>
                </div>
                <div class="c-calendar-card__body c-calendar-card__body--no-padding">
                    <div id="myAssignmentsList" class="c-calendar-assignments">
                        <div class="c-loading-state" data-component="loading-state">
                            <div class="c-loading-state__spinner"></div>
                            <p class="c-loading-state__text">Loading assignments...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Availability Toggle -->
        <div class="col-lg-6 mb-4">
            <div class="c-card h-100">
                <div class="c-card__header border-bottom">
                    <h5 class="c-card__title mb-0">
                        <i class="ti ti-toggle-right me-2 text-primary"></i>
                        Availability Status
                    </h5>
                </div>
                <div class="c-card__body text-center">
                    <div class="availability-container">
                        <div class="availability-status mb-3" id="availabilityStatus">
                            <div class="spinner-border text-primary mb-2" role="status" data-spinner>
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted">Loading status...</p>
                        </div>
                        <button type="button" class="c-btn c-btn--primary" id="toggleAvailabilityBtn" disabled>
                            <i class="ti ti-loader ti-spin me-1"></i> Loading...
                        </button>
                        <div class="mt-3">
                            <small class="text-muted">
                                Toggle your availability for referee assignments. When unavailable, you won't be shown in the assignment pool.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="row">
        <!-- Main Content Column -->
        <div class="col-lg-8 col-xl-9 mb-4 mb-lg-0">
            <div class="c-calendar-main" data-component="calendar-main">
                <div class="c-calendar-main__header">
                    <h5 class="c-calendar-main__title">Match Schedule</h5>
                    <div class="c-calendar-main__controls">
                        <div class="c-calendar-search" data-component="calendar-search">
                            <span class="c-calendar-search__icon">
                                <i class="ti ti-search"></i>
                            </span>
                            <input type="text"
                                   class="c-calendar-search__input"
                                   id="matchSearchInput"
                                   placeholder="Search matches..."
                                   data-input="search">
                        </div>
                        <div class="c-calendar-views" data-component="calendar-views">
                            <button type="button"
                                    class="c-calendar-view"
                                    data-view="day"
                                    id="viewDayBtn"
                                    data-action="change-view">Day</button>
                            <button type="button"
                                    class="c-calendar-view"
                                    data-view="week"
                                    id="viewWeekBtn"
                                    data-action="change-view">Week</button>
                            <button type="button"
                                    class="c-calendar-view c-calendar-view--active"
                                    data-view="month"
                                    id="viewMonthBtn"
                                    data-action="change-view">Month</button>
                            <button type="button"
                                    class="c-calendar-view"
                                    data-view="list"
                                    id="viewListBtn"
                                    data-action="change-view">List</button>
                        </div>
                        <button type="button"
                                class="c-calendar-help-btn"
                                id="keyboardHelpBtn"
                                title="Keyboard shortcuts (?)"
                                data-action="show-shortcuts">
                            <i class="ti ti-keyboard"></i>
                        </button>
                    </div>
                </div>
                <div class="c-card__body p-0">
                    <!-- Custom Schedule View -->
                    <div id="scheduleContainer" class="p-4 h-100">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex gap-2 align-items-center">
                                <button class="c-btn c-btn--sm c-btn--icon-only c-btn--outline-primary" id="calendar-prevBtn" title="Previous">
                                    <i class="ti ti-chevron-left"></i>
                                </button>
                                <button class="c-btn c-btn--sm c-btn--outline-secondary" id="todayBtn" title="Go to today">
                                    Today
                                </button>
                            </div>
                            <h5 id="currentDateDisplay" class="mb-0 fw-semibold">Sunday, April 7, 2024</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="c-btn c-btn--sm c-btn--outline-info" id="nextEventBtn" title="Jump to next scheduled event">
                                    <i class="ti ti-calendar-event me-1"></i>Next
                                </button>
                                <button class="c-btn c-btn--sm c-btn--icon-only c-btn--outline-primary" id="calendar-nextBtn" title="Next">
                                    <i class="ti ti-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Schedule content will be loaded here dynamically -->
                        <div id="scheduleContent" class="schedule-content">
                            <div class="text-center py-5">
                                <div class="spinner-border spinner-border-lg text-primary mb-2" role="status" data-spinner>
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h6 class="fw-normal text-primary mb-1">Loading schedule...</h6>
                                <p class="text-muted small">Retrieving match data and referee assignments</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4 col-xl-3">
            <!-- Mini Calendar Card -->
            <div class="c-calendar-sidebar-card" data-component="mini-calendar-card">
                <div class="c-calendar-sidebar-card__header">
                    <div class="c-calendar-sidebar-card__icon">
                        <i class="ti ti-calendar"></i>
                    </div>
                    <h5 class="c-calendar-sidebar-card__title">Quick Jump</h5>
                </div>
                <div class="c-calendar-sidebar-card__body c-calendar-sidebar-card__body--compact">
                    <div id="miniCalendar" class="c-mini-calendar" data-component="mini-calendar"></div>
                </div>
            </div>

            <!-- Calendar Filters Card -->
            <div class="c-calendar-sidebar-card" data-component="filters-card">
                <div class="c-calendar-sidebar-card__header">
                    <div class="c-calendar-sidebar-card__icon c-calendar-sidebar-card__icon--info">
                        <i class="ti ti-filter"></i>
                    </div>
                    <h5 class="c-calendar-sidebar-card__title">Filters</h5>
                </div>
                <div class="c-calendar-sidebar-card__body c-calendar-filters" data-component="calendar-filters">
                    <!-- Event Type Filters -->
                    <div class="c-filter-section" data-component="filter-section">
                        <label class="c-filter-section__label">Event Types</label>
                        <div class="c-filter-option" data-component="filter-option">
                            <input class="c-filter-option__input"
                                   type="checkbox"
                                   id="filterShowMatches"
                                   checked
                                   data-filter="matches">
                            <label class="c-filter-option__label" for="filterShowMatches">
                                <i class="ti ti-ball-football c-filter-option__icon"></i>
                                Matches
                            </label>
                        </div>
                        <div class="c-filter-option" data-component="filter-option">
                            <input class="c-filter-option__input"
                                   type="checkbox"
                                   id="filterShowLeagueEvents"
                                   checked
                                   data-filter="events">
                            <label class="c-filter-option__label" for="filterShowLeagueEvents">
                                <i class="ti ti-calendar-event c-filter-option__icon"></i>
                                League Events
                            </label>
                        </div>
                    </div>

                    <!-- Division Filters -->
                    <div class="mb-3">
                        <label class="form-label text-muted small text-uppercase d-flex justify-content-between align-items-center">
                            <span>Divisions</span>
                            <span>
                                <button type="button" class="c-btn c-btn--link c-btn--sm p-0 me-2" id="filterSelectAllDivisions">All</button>
                                <button type="button" class="c-btn c-btn--link c-btn--sm p-0" id="filterClearAllDivisions">None</button>
                            </span>
                        </label>
                        <div class="form-check mb-2">
                            <input class="form-check-input filter-division" type="checkbox" value="Premier" id="filterDivPremier" checked>
                            <label class="form-check-label" for="filterDivPremier">
                                <span class="badge bg-primary me-1" data-badge>&nbsp;</span>Premier
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input filter-division" type="checkbox" value="Classic" id="filterDivClassic" checked>
                            <label class="form-check-label" for="filterDivClassic">
                                <span class="badge bg-success me-1" data-badge>&nbsp;</span>Classic
                            </label>
                        </div>
                    </div>

                    <!-- Reset Button -->
                    <div class="d-grid">
                        <button type="button" class="c-btn c-btn--outline-secondary c-btn--sm" id="filterResetBtn">
                            <i class="ti ti-refresh me-1"></i>Reset Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Stats Card -->
            {% if can_view_schedule_stats %}
            <div class="c-card mb-4">
                <div class="c-card__header border-bottom">
                    <div class="d-flex align-items-center">
                        <div class="avatar avatar-sm me-2 bg-label-primary">
                            <i class="ti ti-chart-pie"></i>
                        </div>
                        <h5 class="c-card__title mb-0">Schedule Statistics</h5>
                    </div>
                </div>
                <div class="c-card__body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="stat-card bg-label-primary shadow-sm rounded-3">
                                <div class="stat-card-body">
                                    <h5 class="stat-card-title" id="totalMatches">0</h5>
                                    <p class="stat-card-text">Total Matches</p>
                                </div>
                                <div class="stat-card-icon">
                                    <i class="ti ti-soccer-field"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card bg-label-success shadow-sm rounded-3">
                                <div class="stat-card-body">
                                    <h5 class="stat-card-title" id="assignedRefs">0</h5>
                                    <p class="stat-card-text">Assigned Refs</p>
                                </div>
                                <div class="stat-card-icon">
                                    <i class="ti ti-user-check"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card bg-label-danger shadow-sm rounded-3">
                                <div class="stat-card-body">
                                    <h5 class="stat-card-title" id="unassignedMatches">0</h5>
                                    <p class="stat-card-text">Unassigned</p>
                                </div>
                                <div class="stat-card-icon">
                                    <i class="ti ti-user-x"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card bg-label-info shadow-sm rounded-3">
                                <div class="stat-card-body">
                                    <h5 class="stat-card-title" id="totalReferees">0</h5>
                                    <p class="stat-card-text">Referees</p>
                                </div>
                                <div class="stat-card-icon">
                                    <i class="ti ti-whistle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Referee List Card - Only show for admins -->
            {% if not is_referee and can_view_available_referees %}
            <div class="c-card">
                <div class="c-card__header border-bottom">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="avatar avatar-sm me-2 bg-label-primary">
                                <i class="ti ti-users"></i>
                            </div>
                            <h5 class="c-card__title mb-0">Available Referees</h5>
                        </div>
                        <span class="badge bg-primary rounded-pill" id="refCount" data-badge>0</span>
                    </div>
                </div>
                <div class="c-card__body p-0">
                    <div class="p-3">
                        <div class="input-group" data-input-group>
                            <span class="input-group-text border-end-0 ps-3 pe-1 bg-body">
                                <i class="ti ti-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-start-0 ps-1" id="refSearchInput" placeholder="Search referees..." data-form-control>
                        </div>
                    </div>
                    <div class="referee-list" id="refereeList">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary mb-2" role="status" data-spinner>
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-primary mb-0 small fw-medium">Loading referees...</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
{{ super() }}
<!-- Referee Assignment Modal -->
<div class="modal c-modal fade" data-modal id="assignRefModal" tabindex="-1" aria-labelledby="assignRefModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content data-modal-content>
            <div class="modal-header c-modal__header border-bottom" data-modal-header>
                <h5 class="modal-title c-modal__title" id="assignRefModalLabel">
                    <i class="ti ti-user-check text-primary me-1"></i> Referee Assignment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                <form id="assignRefForm" data-on-submit="assign-referee">
                    <input type="hidden" id="matchId" name="match_id">
                    
                    <div class="match-detail-card mb-3 bg-label-primary rounded-3">
                        <div class="match-detail-header">
                            <i class="ti ti-calendar-event me-2"></i>
                            <span id="matchDateTime">Date & Time</span>
                        </div>
                        <div class="match-detail-body">
                            <div class="match-teams mb-2">
                                <span id="homeTeam" class="fw-bold">Home Team</span>
                                <span class="vs">vs</span>
                                <span id="awayTeam" class="fw-bold">Away Team</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <p class="match-location mb-0">
                                    <i class="ti ti-map-pin me-1"></i>
                                    <span id="matchLocation">Location</span>
                                </p>
                                <span class="badge bg-primary rounded-pill" id="matchDivision" data-badge>Division</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="currentRefereeSection">
                        <label class="form-label fw-semibold">Current Referee</label>
                        <div class="current-ref-container border rounded-3">
                            <div class="current-ref-status">
                                <div class="avatar avatar-sm me-2 bg-label-primary">
                                    <i class="ti ti-user current-ref-icon"></i>
                                </div>
                                <span id="currentRefereeName" class="fw-semibold">Unassigned</span>
                            </div>
                            <button type="button" class="c-btn c-btn--outline-danger c-btn--sm" id="removeRefButton" data-action="remove-referee">
                                <i class="ti ti-user-x me-1"></i> Remove
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="refSelect" class="form-label fw-semibold">Assign Referee</label>
                        <select class="form-select" id="refSelect" name="ref_id" required data-form-select>
                            <option value="" selected disabled>Choose a referee</option>
                        </select>
                        <div class="form-text">Select a referee from the list to assign to this match</div>
                    </div>
                    
                    <div id="assignRefFeedback" class="mt-2"></div>
                </form>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer data-modal-footer>
                <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="submit" form="assignRefForm" class="c-btn c-btn--primary" id="assignRefButton">
                    <i class="ti ti-user-check me-1"></i> Assign Referee
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Match Details Modal -->
<div class="modal c-modal fade" data-modal id="matchDetailsModal" tabindex="-1" aria-labelledby="matchDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content data-modal-content>
            <div class="modal-header c-modal__header border-bottom" data-modal-header>
                <h5 class="modal-title c-modal__title" id="matchDetailsModalLabel">
                    <i class="ti ti-soccer-field text-primary me-1"></i> Match Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                <div class="match-detail-full">
                    <div class="match-teams-container">
                        <div class="team home-team">
                            <div class="avatar avatar-lg bg-label-primary">
                                <i class="ti ti-home"></i>
                            </div>
                            <div class="team-name fw-bold" id="detailHomeTeam">Home Team</div>
                        </div>
                        <div class="match-vs">VS</div>
                        <div class="team away-team">
                            <div class="avatar avatar-lg bg-label-secondary">
                                <i class="ti ti-plane-departure"></i>
                            </div>
                            <div class="team-name fw-bold" id="detailAwayTeam">Away Team</div>
                        </div>
                    </div>
                    
                    <div class="match-info-grid mt-4">
                        <div class="match-info-item">
                            <i class="ti ti-calendar text-primary"></i>
                            <span id="detailMatchDate" class="fw-semibold">Date</span>
                        </div>
                        <div class="match-info-item">
                            <i class="ti ti-clock text-primary"></i>
                            <span id="detailMatchTime" class="fw-semibold">Time</span>
                        </div>
                        <div class="match-info-item">
                            <i class="ti ti-map-pin text-primary"></i>
                            <span id="detailMatchLocation" class="fw-semibold">Location</span>
                        </div>
                        <div class="match-info-item">
                            <i class="ti ti-flag text-primary"></i>
                            <span id="detailMatchDivision" class="fw-semibold">Division</span>
                        </div>
                    </div>
                    
                    <div class="referee-section mt-4 bg-label-primary rounded-3 p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0">Referee Assignment</h6>
                            {% if can_assign_referee %}
                            <button type="button" class="c-btn c-btn--sm c-btn--primary" id="openAssignRefBtnTop">
                                <i class="ti ti-user-check me-1"></i> Assign Referee
                            </button>
                            {% endif %}
                        </div>
                        <div class="referee-detail">
                            <div class="d-flex align-items-center">
                                <div class="avatar avatar-sm me-2 bg-white">
                                    <i class="ti ti-user-circle text-primary"></i>
                                </div>
                                <span id="detailMatchReferee" class="fw-semibold">Unassigned</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer data-modal-footer>
                <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>Close</button>
                {% if can_assign_referee %}
                <button type="button" class="c-btn c-btn--primary" id="openAssignRefBtn">
                    <i class="ti ti-user-check me-1"></i> Assign Referee
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- League Event Modal (for admin event creation/editing) -->
{% if can_edit_events %}
<div class="modal c-modal fade" data-modal id="leagueEventModal" tabindex="-1" aria-labelledby="leagueEventModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header data-modal-header>
                <h5 class="modal-title c-modal__title" id="leagueEventModalLabel">
                    <i class="ti ti-calendar-plus me-2"></i>
                    <span id="eventModalTitle">Create League Event</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                <form id="leagueEventForm">
                    <input type="hidden" id="eventId" value="">

                    <div class="mb-3">
                        <label for="eventTitle" class="form-label">Event Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="eventTitle" placeholder="e.g., Pre-Season Party" required data-form-control>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="eventType" class="form-label">Event Type</label>
                            <select class="form-select" id="eventType" data-form-select>
                                <option value="party">Party</option>
                                <option value="meeting">Meeting</option>
                                <option value="social">Social Event</option>
                                <option value="training">Training</option>
                                <option value="tournament">Tournament</option>
                                <option value="other" selected>Other</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="eventLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="eventLocation" placeholder="e.g., The Local Pub" data-form-control>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="eventStartDate" class="form-label">Start Date/Time <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="eventStartDate" required data-form-control>
                        </div>
                        <div class="col-md-6">
                            <label for="eventEndDate" class="form-label">End Date/Time</label>
                            <input type="datetime-local" class="form-control" id="eventEndDate" data-form-control>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="eventAllDay">
                            <label class="form-check-label" for="eventAllDay">
                                All-day event
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="3" placeholder="Event details..." data-form-control></textarea>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="eventNotifyDiscord">
                            <label class="form-check-label" for="eventNotifyDiscord">
                                <i class="ti ti-brand-discord me-1"></i>
                                Announce in Discord
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer c-modal__footer" data-modal-footer data-modal-footer>
                <button type="button" class="c-btn c-btn--outline-danger me-auto calendar-delete-event-btn" id="deleteEventBtn">
                    <i class="ti ti-trash me-1"></i> Delete
                </button>
                <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>Cancel</button>
                <button type="button" class="c-btn c-btn--primary" id="saveEventBtn">
                    <i class="ti ti-check me-1"></i> Save Event
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock modals %}

{% block custom_js %}
{{ super() }}

<!-- Calendar Module JS -->
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="{{ url_for('static', filename='assets/js/calendar/calendar-league-events.js') }}"></script>
<script src="{{ url_for('static', filename='assets/js/calendar/calendar-filters.js') }}"></script>
<script>
{% endif %}
document.addEventListener('DOMContentLoaded', () => {
    // State variables
    let isAssignmentMode = false;
    let allEvents = [];
    let currentViewEvents = [];
    let currentView = 'month';  // Default to month view for better overview
    let currentDate = new Date();
    const canAssignReferee = {{ 'true' if can_assign_referee else 'false' }};
    const isReferee = {{ 'true' if is_referee else 'false' }};
    const canEditRefereeMatches = {{ 'true' if can_edit_referee_matches else 'false' }};
    const _csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    let refereeAssignedMatches = [];
    
    // Initialize tooltips
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(el => new bootstrap.Tooltip(el));
    
    // View toggle buttons
    const viewButtons = document.querySelectorAll('[data-view]');
    viewButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active button
            viewButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Switch view
            currentView = this.dataset.view;
            renderSchedule();
        });
    });
    
    // Toggle assignment mode
    const toggleAssignmentMode = document.getElementById('toggleAssignmentMode');
    if (toggleAssignmentMode) {
        toggleAssignmentMode.addEventListener('click', function() {
            isAssignmentMode = !isAssignmentMode;
            this.classList.toggle('btn-primary', isAssignmentMode);
            this.classList.toggle('btn-outline-primary', !isAssignmentMode);
            this.innerHTML = isAssignmentMode 
                ? '<i class="ti ti-x me-1"></i> Exit Assignment Mode' 
                : '<i class="ti ti-user-check me-1"></i> Assignment Mode';
            
            // Toggle assignment mode UI
            toggleAssignmentModeUI(isAssignmentMode);
        });
    }
    
    // Navigation buttons
    document.getElementById('prevBtn').addEventListener('click', () => {
        navigateDate(-1);
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
        navigateDate(1);
    });

    // Today button - jump back to current date
    document.getElementById('todayBtn').addEventListener('click', () => {
        currentDate = new Date();
        updateDateDisplay();
        renderSchedule();
    });

    // Keyboard help button
    document.getElementById('keyboardHelpBtn').addEventListener('click', () => {
        showKeyboardShortcuts();
    });

    // Next Event button - jump to next scheduled event
    document.getElementById('nextEventBtn').addEventListener('click', () => {
        jumpToNextEvent();
    });

    function jumpToNextEvent() {
        if (allEvents.length === 0) {
            showToast('warning', 'No events loaded');
            return;
        }

        const now = new Date();
        // Find the next event that's in the future
        const futureEvents = allEvents
            .filter(event => new Date(event.start) > now)
            .sort((a, b) => new Date(a.start) - new Date(b.start));

        if (futureEvents.length > 0) {
            currentDate = new Date(futureEvents[0].start);
            updateDateDisplay();
            renderSchedule();
            showToast('info', `Jumped to ${currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`);
        } else {
            // No future events, jump to the most recent past event
            const sortedEvents = [...allEvents].sort((a, b) => new Date(b.start) - new Date(a.start));
            if (sortedEvents.length > 0) {
                currentDate = new Date(sortedEvents[0].start);
                updateDateDisplay();
                renderSchedule();
                showToast('info', `Showing most recent event on ${currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`);
            }
        }
    }
    
    function navigateDate(direction) {
        switch(currentView) {
            case 'day':
                currentDate.setDate(currentDate.getDate() + direction);
                break;
            case 'week':
                currentDate.setDate(currentDate.getDate() + (direction * 7));
                break;
            case 'month':
                currentDate.setMonth(currentDate.getMonth() + direction);
                break;
            default:
                currentDate.setDate(currentDate.getDate() + direction);
        }
        
        updateDateDisplay();
        renderSchedule();
    }
    
    function updateDateDisplay() {
        const dateDisplay = document.getElementById('currentDateDisplay');
        
        if (currentView === 'day') {
            dateDisplay.textContent = currentDate.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
        } else if (currentView === 'week') {
            // Get first and last day of week
            const firstDay = new Date(currentDate);
            firstDay.setDate(currentDate.getDate() - currentDate.getDay());
            
            const lastDay = new Date(firstDay);
            lastDay.setDate(firstDay.getDate() + 6);
            
            dateDisplay.textContent = `${firstDay.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})} - ${lastDay.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
        } else if (currentView === 'month') {
            dateDisplay.textContent = currentDate.toLocaleDateString('en-US', {
                month: 'long',
                year: 'numeric'
            });
        } else {
            dateDisplay.textContent = 'All Matches';
        }
    }
    
    // Search functionality for referees
    const refSearchInput = document.getElementById('refSearchInput');
    if (refSearchInput) {
        refSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const refItems = document.querySelectorAll('.referee-item');
            
            refItems.forEach(item => {
                const refName = item.querySelector('.referee-name')?.textContent.toLowerCase() || '';
                if (refName.includes(searchTerm) || searchTerm === '') {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
    // Search functionality for matches
    const matchSearchInput = document.getElementById('matchSearchInput');
    if (matchSearchInput) {
        matchSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            // Filter displayed matches based on view type
            if (currentView === 'list') {
                const matchItems = document.querySelectorAll('.match-item');
                matchItems.forEach(item => {
                    const matchText = item.textContent.toLowerCase();
                    if (matchText.includes(searchTerm) || searchTerm === '') {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            } else {
                // Re-render with filtered events
                renderSchedule(searchTerm);
            }
        });
    }
    
    // Refresh button
    const refreshButton = document.getElementById('refreshScheduleBtn');
    if (refreshButton) {
        refreshButton.addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="ti ti-loader ti-spin me-1"></i> Refreshing';
            
            Promise.all([
                loadScheduleEvents(),
                fetchAvailableReferees()
            ]).then(() => {
                this.disabled = false;
                this.innerHTML = '<i class="ti ti-refresh me-1"></i> Refresh';
                showToast('success', 'Schedule refreshed successfully');
            }).catch(error => {
                console.error('Error refreshing data:', error);
                this.disabled = false;
                this.innerHTML = '<i class="ti ti-refresh me-1"></i> Refresh';
                showToast('danger', 'Failed to refresh data');
            });
        });
    }
    
    // Load events and initialize the view
    async function loadScheduleEvents() {
        try {
            const response = await fetch('/calendar/events');
            if (!response.ok) throw new Error('Failed to fetch events.');
            
            const data = await response.json();
            allEvents = data.events.map(event => {
                return {
                    ...event,
                    type: event.type || 'match',  // Default to 'match' for legacy events
                    date: new Date(event.start),
                    // Parse more data needed for rendering
                    homeTeam: event.teams ? event.teams.split(' vs ')[0] : event.title,
                    awayTeam: event.teams ? event.teams.split(' vs ')[1] : '',
                    location: event.description ? event.description.replace('Location: ', '') : event.location || '',
                    time: new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})
                };
            });
            
            // Update stats
            updateQuickStats(data.stats);
            
            // Store referee assigned matches if available
            if (data.referee_assigned_matches) {
                refereeAssignedMatches = data.referee_assigned_matches;
            }

            // Auto-navigate to first upcoming event if today has no events
            if (allEvents.length > 0) {
                const today = new Date();
                const todayStr = today.toDateString();
                const hasEventsToday = allEvents.some(event => new Date(event.start).toDateString() === todayStr);

                if (!hasEventsToday) {
                    // Find next upcoming event
                    const futureEvents = allEvents
                        .filter(event => new Date(event.start) > today)
                        .sort((a, b) => new Date(a.start) - new Date(b.start));

                    if (futureEvents.length > 0) {
                        currentDate = new Date(futureEvents[0].start);
                    }
                }
            }

            // Render the schedule with the loaded events
            renderSchedule();

            return data;
        } catch (error) {
            console.error('Error loading events:', error);
            document.getElementById('scheduleContent').innerHTML = `
                <div class="empty-state">
                    <i class="ti ti-alert-triangle empty-state-icon text-danger"></i>
                    <h5 class="empty-state-text text-danger">Failed to load schedule</h5>
                    <p class="empty-state-subtext">There was a problem retrieving the match data</p>
                    <button class="c-btn c-btn--sm c-btn--outline-danger mt-3 js-refresh-schedule" data-action="refresh-schedule">
                        <i class="ti ti-refresh me-1"></i> Try Again
                    </button>
                </div>
            `;
            throw error;
        }
    }
    
    async function fetchAvailableReferees() {
        try {
            // Get start and end dates based on current view
            let startDate = new Date(currentDate);
            let endDate = new Date(currentDate);
            
            if (currentView === 'week') {
                // Start of week (Sunday)
                startDate.setDate(currentDate.getDate() - currentDate.getDay());
                // End of week (Saturday)
                endDate.setDate(startDate.getDate() + 6);
            } else if (currentView === 'month') {
                // Start of month
                startDate.setDate(1);
                // End of month
                endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            } else if (currentView === 'list') {
                // Use a broader date range for list view
                startDate = new Date();
                endDate = new Date();
                endDate.setMonth(endDate.getMonth() + 3);
            }
            
            const response = await fetch(`/calendar/available_refs?start_date=${startDate.toISOString()}&end_date=${endDate.toISOString()}`);
            if (!response.ok) throw new Error('Failed to fetch referees.');
            
            const referees = await response.json();
            renderRefereeList(referees);
            
            // Update total count
            document.getElementById('totalReferees').textContent = referees.length;
            document.getElementById('refCount').textContent = referees.length;
            
            return referees;
        } catch (error) {
            console.error('Error fetching referees:', error);
            document.getElementById('refereeList').innerHTML = `
                <div class="text-center py-4">
                    <i class="ti ti-alert-triangle text-danger mb-2 calendar-icon-alert-lg"></i>
                    <p class="text-danger mb-1 fw-medium">Failed to load referees</p>
                    <button class="c-btn c-btn--sm c-btn--outline-danger mt-2 js-refresh-schedule" data-action="refresh-schedule">
                        <i class="ti ti-refresh me-1"></i> Retry
                    </button>
                </div>
            `;
            throw error;
        }
    }
    
    function renderRefereeList(referees) {
        const refList = document.getElementById('refereeList');
        refList.innerHTML = '';
        
        if (referees.length === 0) {
            refList.innerHTML = `
                <div class="text-center py-4">
                    <div class="avatar avatar-lg bg-label-primary mx-auto mb-2">
                        <i class="ti ti-user-off"></i>
                    </div>
                    <h6 class="text-muted mb-1">No Referees Available</h6>
                    <p class="text-muted small mb-0">No eligible referees found for the selected timeframe</p>
                </div>
            `;
            return;
        }
        
        const refListContainer = document.createElement('div');
        refListContainer.className = 'p-2';
        
        // Sort referees by assignments (least to most)
        referees.sort((a, b) => a.matches_assigned_in_week - b.matches_assigned_in_week);
        
        referees.forEach(ref => {
            const refItem = document.createElement('div');
            refItem.className = 'referee-item';
            
            // Highlight refs with no assignments this week
            const highlightClass = ref.matches_assigned_in_week === 0 ? 'referee-available' : '';
            
            refItem.innerHTML = `
                <div class="c-card mb-2 ${highlightClass} referee-card" data-ref-id="${ref.id}" data-ref-name="${ref.name}">
                    <div class="c-card__body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="avatar avatar-sm me-2 bg-label-primary">
                                    <i class="ti ti-user"></i>
                                </div>
                                <div>
                                    <span class="referee-name fw-semibold">${ref.name}</span>
                                    ${ref.matches_assigned_in_week > 0 
                                        ? `<span class="badge bg-warning ms-2" title="Assigned this week" data-badge>${ref.matches_assigned_in_week}</span>` 
                                        : '<span class="badge bg-success ms-2" data-badge>Available</span>'}
                                </div>
                            </div>
                            <div>
                                <span class="badge bg-primary rounded-pill" title="Total matches assigned" data-badge>
                                    ${ref.total_matches_assigned}
                                </span>
                            </div>
                        </div>
                        <div class="progress mt-2 calendar-progress-thin">
                            <div class="progress-bar" role="progressbar"
                                aria-valuenow="${ref.matches_assigned_in_week}"
                                aria-valuemin="0"
                                aria-valuemax="3">
                            </div>
                        </div>
                        <div class="assignment-mode-overlay d-none">
                            <div class="text-center">
                                <i class="ti ti-click text-primary mb-1 calendar-icon-click-lg"></i>
                                <div class="small text-primary fw-medium">Click to Select</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            refListContainer.appendChild(refItem);
        });
        
        refList.appendChild(refListContainer);
    }
    
    function updateQuickStats(stats) {
        document.getElementById('totalMatches').textContent = stats.totalMatches;
        document.getElementById('assignedRefs').textContent = stats.assignedRefs;
        document.getElementById('unassignedMatches').textContent = stats.unassignedMatches;
    }
    
    function renderSchedule(searchTerm = '') {
        const scheduleContent = document.getElementById('scheduleContent');
        
        // Update date display
        updateDateDisplay();
        
        // Filter events based on current view and search term
        currentViewEvents = filterEventsByView();
        
        if (searchTerm) {
            currentViewEvents = currentViewEvents.filter(event => {
                const matchText = `${event.homeTeam} ${event.awayTeam} ${event.location} ${event.division} ${event.ref}`.toLowerCase();
                return matchText.includes(searchTerm.toLowerCase());
            });
        }
        
        // Render based on current view
        if (currentViewEvents.length === 0) {
            scheduleContent.innerHTML = `
                <div class="empty-state">
                    <i class="ti ti-calendar-off empty-state-icon"></i>
                    <h5 class="empty-state-text">No matches scheduled</h5>
                    <p class="empty-state-subtext">Try a different date or view to see scheduled matches</p>
                    <button class="c-btn c-btn--sm c-btn--outline-primary mt-3 js-refresh-schedule" data-action="refresh-schedule">
                        <i class="ti ti-refresh me-1"></i> Refresh Schedule
                    </button>
                </div>
            `;
            return;
        }
        
        switch(currentView) {
            case 'day':
                renderDayView();
                break;
            case 'week':
                renderWeekView();
                break;
            case 'month':
                renderMonthView();
                break;
            case 'list':
                renderListView();
                break;
            default:
                renderDayView();
        }
    }
    
    function filterEventsByView() {
        let filteredEvents = allEvents;

        // Apply CalendarFilterManager filters first (if available)
        if (typeof CalendarFilterManager !== 'undefined') {
            const filters = CalendarFilterManager.getFilters();

            filteredEvents = filteredEvents.filter(event => {
                // Filter by event type (matches vs league events)
                if (event.type === 'match' && !filters.showMatches) {
                    return false;
                }
                if (event.type === 'league_event' && !filters.showLeagueEvents) {
                    return false;
                }

                // Filter by division (matches only)
                if (event.type === 'match' && filters.divisions && filters.divisions.length > 0) {
                    if (!filters.divisions.includes(event.division)) {
                        return false;
                    }
                }

                return true;
            });
        }

        // Then filter by date range based on view
        if (currentView === 'day') {
            // Filter events for the selected day
            return filteredEvents.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate.toDateString() === currentDate.toDateString();
            });
        } else if (currentView === 'week') {
            // Filter events for the selected week
            const weekStart = new Date(currentDate);
            weekStart.setDate(currentDate.getDate() - currentDate.getDay()); // Start from Sunday

            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6); // End on Saturday

            return filteredEvents.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate >= weekStart && eventDate <= weekEnd;
            });
        } else if (currentView === 'month') {
            // Filter events for the selected month
            return filteredEvents.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate.getMonth() === currentDate.getMonth() &&
                       eventDate.getFullYear() === currentDate.getFullYear();
            });
        } else {
            // List view - show all filtered events, sorted by date
            return [...filteredEvents].sort((a, b) => new Date(a.start) - new Date(b.start));
        }
    }
    
    function renderDayView() {
        const scheduleContent = document.getElementById('scheduleContent');
        
        // Sort events by time
        const sortedEvents = [...currentViewEvents].sort((a, b) => {
            return new Date(a.start).getTime() - new Date(b.start).getTime();
        });
        
        // Group events by time slots
        const timeSlots = {};
        sortedEvents.forEach(event => {
            const time = new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            if (!timeSlots[time]) {
                timeSlots[time] = [];
            }
            timeSlots[time].push(event);
        });
        
        // Create timeline view
        let html = '<div class="day-schedule">';
        
        for (const time in timeSlots) {
            html += `
                <div class="time-slot">
                    <div class="time-label">${time}</div>
                    <div class="time-events">
            `;
            
            timeSlots[time].forEach(event => {
                const isAssigned = event.ref !== 'Unassigned';
                
                const assignmentClass = (!isAssigned && isAssignmentMode) ? 'unassigned-match' : '';
                
                html += `
                    <div class="match-item c-card mb-3 ${assignmentClass}" data-event-id="${event.id}">
                        <div class="c-card__body p-3">
                            <div class="match-header d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-${event.division === 'Premier' ? 'primary' : 'success'} me-2" data-badge>${event.division}</span>
                                <small class="text-muted"><i class="ti ti-map-pin me-1"></i>${event.location}</small>
                            </div>
                            
                            <div class="match-teams mb-2">
                                <div class="home-team">${event.homeTeam}</div>
                                <div class="vs">vs</div>
                                <div class="away-team">${event.awayTeam}</div>
                            </div>
                            
                            <div class="match-footer d-flex justify-content-between align-items-center">
                                <div class="ref-badge ${isAssigned ? 'ref-assigned' : 'ref-unassigned'}">
                                    <i class="ti ti-user-circle me-1"></i>
                                    <span>${event.ref}</span>
                                    ${(!isAssigned && isAssignmentMode) ? '<i class="ti ti-alert-triangle text-warning ms-1" title="Needs referee assignment"></i>' : ''}
                                </div>
                                
                                <div class="match-actions">
                                    ${!isAssignmentMode ? `
                                    <button class="c-btn c-btn--sm c-btn--outline-secondary view-match-btn">
                                        <i class="ti ti-eye me-1"></i>View
                                    </button>
                                    ${canAssignReferee ? `
                                    <button class="c-btn c-btn--sm ${isAssigned ? 'btn-outline-success' : 'btn-primary'} assign-ref-btn" title="${isAssigned ? 'Change Referee' : 'Assign Referee'}">
                                        <i class="ti ti-user-check me-1"></i>${isAssigned ? 'Change' : 'Assign'}
                                    </button>
                                    ` : ''}
                                    ${(canEditRefereeMatches && refereeAssignedMatches.includes(event.id)) ? `
                                    <button class="c-btn c-btn--sm c-btn--outline-primary edit-match-btn" title="Edit Match Report">
                                        <i class="ti ti-edit me-1"></i>Edit
                                    </button>
                                    ` : ''}
                                    ` : `
                                    ${!isAssigned ? `
                                    <div class="assignment-hint text-primary small">
                                        <i class="ti ti-click me-1"></i>Click to assign selected referee
                                    </div>
                                    ` : `
                                    <div class="assigned-indicator text-success small">
                                        <i class="ti ti-check me-1"></i>Assigned
                                    </div>
                                    `}
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
        }
        
        html += '</div>';
        
        scheduleContent.innerHTML = html;
        
        // Add event listeners to the match items
        addMatchItemEventListeners();
        
        // Update assignment mode count if active
        if (isAssignmentMode) {
            updateUnassignedCount();
        }
    }
    
    function renderWeekView() {
        const scheduleContent = document.getElementById('scheduleContent');
        
        // Get the start date of the week (Sunday)
        const weekStart = new Date(currentDate);
        weekStart.setDate(currentDate.getDate() - currentDate.getDay());
        
        // Create an array of days in the week
        const weekDays = [];
        for (let i = 0; i < 7; i++) {
            const day = new Date(weekStart);
            day.setDate(weekStart.getDate() + i);
            weekDays.push(day);
        }
        
        let html = '<div class="week-schedule">';
        
        // Create the weekday headers
        html += '<div class="week-header">';
        weekDays.forEach(day => {
            const isToday = day.toDateString() === new Date().toDateString();
            html += `
                <div class="day-header ${isToday ? 'today' : ''}">
                    <div class="day-name">${day.toLocaleDateString('en-US', {weekday: 'short'})}</div>
                    <div class="day-date">${day.getDate()}</div>
                </div>
            `;
        });
        html += '</div>';
        
        // Create the week grid
        html += '<div class="week-grid">';
        
        weekDays.forEach(day => {
            // Find events for this day
            const dayEvents = currentViewEvents.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate.toDateString() === day.toDateString();
            });
            
            // Sort events by time
            dayEvents.sort((a, b) => new Date(a.start).getTime() - new Date(b.start).getTime());
            
            // Create day column
            const isToday = day.toDateString() === new Date().toDateString();
            html += `<div class="day-column ${isToday ? 'today' : ''}" data-date="${day.toDateString()}">`;
            
            if (dayEvents.length === 0) {
                html += `
                    <div class="day-empty">
                        <div class="avatar avatar-sm bg-label-secondary mx-auto mb-2">
                            <i class="ti ti-calendar-off"></i>
                        </div>
                        <small class="text-muted d-block">No matches</small>
                    </div>
                `;
            } else {
                dayEvents.forEach(event => {
                    const isAssigned = event.ref !== 'Unassigned';
                    
                    html += `
                        <div class="match-item c-card mb-2" data-event-id="${event.id}">
                            <div class="c-card__body p-2">
                                <div class="match-time text-muted mb-1">
                                    <i class="ti ti-clock me-1"></i>${event.time}
                                </div>
                                
                                <div class="match-teams-compact mb-1">
                                    <span class="badge bg-${event.division === 'Premier' ? 'primary' : 'success'} me-1" data-badge>${event.division}</span>
                                    <small>${event.homeTeam} vs ${event.awayTeam}</small>
                                </div>
                                
                                <div class="match-footer d-flex justify-content-between align-items-center">
                                    <div class="ref-badge-small ${isAssigned ? 'ref-assigned' : 'ref-unassigned'}">
                                        <i class="ti ti-user-circle me-1"></i>
                                        <small>${event.ref}</small>
                                    </div>
                                    
                                    <div class="match-actions">
                                        <button class="c-btn c-btn--sm c-btn--icon-only c-btn--outline-secondary view-match-btn" title="View Details">
                                            <i class="ti ti-eye"></i>
                                        </button>
                                        ${canAssignReferee ? `
                                        <button class="c-btn c-btn--sm c-btn--icon-only ${isAssigned ? 'btn-outline-success' : 'btn-primary'} assign-ref-btn" title="${isAssigned ? 'Change Referee' : 'Assign Referee'}">
                                            <i class="ti ti-user-check"></i>
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
        });
        
        html += '</div></div>';
        
        scheduleContent.innerHTML = html;
        
        // Add event listeners to the match items
        addMatchItemEventListeners();
        
        // Update assignment mode count if active
        if (isAssignmentMode) {
            updateUnassignedCount();
        }
    }
    
    function renderMonthView() {
        const scheduleContent = document.getElementById('scheduleContent');
        
        // Get first day of month
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
        
        // Get number of days in month
        const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        // Calculate days from previous month to show
        const prevMonthDays = startingDayOfWeek;
        
        // Calculate days from next month to show (to complete the grid)
        const totalCells = Math.ceil((prevMonthDays + daysInMonth) / 7) * 7;
        const nextMonthDays = totalCells - (prevMonthDays + daysInMonth);
        
        // Create month view
        let html = `<div class="month-schedule">`;
        
        // Create weekday headers
        const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        html += `<div class="month-weekdays">`;
        weekdays.forEach(day => {
            html += `<div class="month-weekday">${day}</div>`;
        });
        html += `</div>`;
        
        // Create month grid
        html += `<div class="month-grid">`;
        
        // Previous month days
        const prevMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0);
        const prevMonthLastDay = prevMonth.getDate();
        
        for (let i = prevMonthDays - 1; i >= 0; i--) {
            const day = prevMonthLastDay - i;
            html += `
                <div class="month-day prev-month">
                    <div class="month-day-header">${day}</div>
                    <div class="month-day-content"></div>
                </div>
            `;
        }
        
        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            const isToday = date.toDateString() === new Date().toDateString();
            
            // Find events for this day
            const dayEvents = currentViewEvents.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate.toDateString() === date.toDateString();
            });
            
            // Build event count badge
            const eventCountBadge = dayEvents.length > 0
                ? `<span class="event-count-badge" data-badge>${dayEvents.length}</span>`
                : '';

            html += `
                <div class="month-day ${isToday ? 'today' : ''} ${dayEvents.length > 0 ? 'has-events' : ''}">
                    <div class="month-day-header">
                        <span class="day-number">${day}</span>
                        ${eventCountBadge}
                    </div>
                    <div class="month-day-content">
            `;

            if (dayEvents.length > 0) {
                // Sort events by time
                dayEvents.sort((a, b) => new Date(a.start).getTime() - new Date(b.start).getTime());
                
                // Show up to 3 events with a "+X more" indicator if needed
                const displayEvents = dayEvents.slice(0, 3);
                
                displayEvents.forEach(event => {
                    const isAssigned = event.ref !== 'Unassigned';
                    html += `
                        <div class="month-event ${event.division === 'Premier' ? 'premier' : 'classic'}" data-event-id="${event.id}">
                            <div class="month-event-time">${event.time}</div>
                            <div class="month-event-title">${event.homeTeam} vs ${event.awayTeam}</div>
                            <div class="month-event-ref ${isAssigned ? 'assigned' : 'unassigned'}" title="${isAssigned ? 'Referee: ' + event.ref : 'No referee assigned'}">
                                <i class="ti ti-user-circle"></i>
                                ${canAssignReferee && !isAssigned ? '<i class="ti ti-plus ref-add-icon" title="Assign Referee"></i>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                if (dayEvents.length > 3) {
                    html += `
                        <div class="month-more-events">
                            +${dayEvents.length - 3} more matches
                        </div>
                    `;
                }
            }
            
            html += `</div></div>`;
        }
        
        // Next month days
        for (let day = 1; day <= nextMonthDays; day++) {
            html += `
                <div class="month-day next-month">
                    <div class="month-day-header">${day}</div>
                    <div class="month-day-content"></div>
                </div>
            `;
        }
        
        html += `</div></div>`;
        
        scheduleContent.innerHTML = html;
        
        // Add event listeners to month events
        document.querySelectorAll('.month-event').forEach(item => {
            item.addEventListener('click', function() {
                const eventId = this.dataset.eventId;
                const event = allEvents.find(e => e.id == eventId);
                
                if (event) {
                    if (isAssignmentMode && canAssignReferee) {
                        showAssignRefModal(event);
                    } else {
                        showMatchDetailsModal(event);
                    }
                }
            });
        });
        
        // Add event listener to "more events" indicators
        document.querySelectorAll('.month-more-events').forEach(item => {
            item.addEventListener('click', function() {
                // Get the day from the parent month-day element
                const dayElement = this.closest('.month-day');
                const dayNumber = dayElement.querySelector('.day-number').textContent;
                
                // Set current date to this day
                currentDate.setDate(parseInt(dayNumber));
                currentView = 'day';
                
                // Update view buttons
                viewButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.view === 'day') {
                        btn.classList.add('active');
                    }
                });
                
                // Render the day view
                renderSchedule();
            });
        });
    }
    
    function renderListView() {
        const scheduleContent = document.getElementById('scheduleContent');
        
        // Sort all events by date
        const sortedEvents = [...currentViewEvents].sort((a, b) => {
            return new Date(a.start).getTime() - new Date(b.start).getTime();
        });
        
        // Group events by date
        const eventsByDate = {};
        sortedEvents.forEach(event => {
            const dateKey = new Date(event.start).toDateString();
            if (!eventsByDate[dateKey]) {
                eventsByDate[dateKey] = [];
            }
            eventsByDate[dateKey].push(event);
        });
        
        // Create list view
        let html = '<div class="list-schedule">';
        
        for (const dateKey in eventsByDate) {
            const date = new Date(dateKey);
            const isToday = dateKey === new Date().toDateString();
            
            html += `
                <div class="date-group ${isToday ? 'today' : ''}">
                    <div class="date-header">
                        <i class="ti ti-calendar-event me-2"></i>
                        ${date.toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'})}
                    </div>
                    <div class="date-matches">
            `;
            
            eventsByDate[dateKey].forEach(event => {
                const isAssigned = event.ref !== 'Unassigned';
                const assignmentClass = (!isAssigned && isAssignmentMode) ? 'unassigned-match' : '';
                
                html += `
                    <div class="match-item c-card mb-3 ${assignmentClass}" data-event-id="${event.id}">
                        <div class="c-card__body p-3">
                            <div class="match-header d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <span class="badge bg-${event.division === 'Premier' ? 'primary' : 'success'} me-2" data-badge>${event.division}</span>
                                    <span class="match-time text-muted">
                                        <i class="ti ti-clock me-1"></i>${event.time}
                                    </span>
                                </div>
                                <small class="text-muted">
                                    <i class="ti ti-map-pin me-1"></i>${event.location}
                                </small>
                            </div>
                            
                            <div class="match-teams mb-2">
                                <div class="home-team">${event.homeTeam}</div>
                                <div class="vs">vs</div>
                                <div class="away-team">${event.awayTeam}</div>
                            </div>
                            
                            <div class="match-footer d-flex justify-content-between align-items-center">
                                <div class="ref-badge ${isAssigned ? 'ref-assigned' : 'ref-unassigned'}">
                                    <i class="ti ti-user-circle me-1"></i>
                                    <span>${event.ref}</span>
                                </div>
                                
                                <div class="match-actions">
                                    <button class="c-btn c-btn--sm c-btn--outline-secondary view-match-btn">
                                        <i class="ti ti-eye me-1"></i>View
                                    </button>
                                    ${canAssignReferee ? `
                                    <button class="c-btn c-btn--sm ${isAssigned ? 'btn-outline-success' : 'btn-primary'} assign-ref-btn" title="${isAssigned ? 'Change Referee' : 'Assign Referee'}">
                                        <i class="ti ti-user-check me-1"></i>${isAssigned ? 'Change' : 'Assign'}
                                    </button>
                                    ` : ''}
                                    ${(canEditRefereeMatches && refereeAssignedMatches.includes(event.id)) ? `
                                    <button class="c-btn c-btn--sm c-btn--outline-primary edit-match-btn" title="Edit Match Report">
                                        <i class="ti ti-edit me-1"></i>Edit
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
        }
        
        html += '</div>';
        
        scheduleContent.innerHTML = html;
        
        // Add event listeners to the match items
        addMatchItemEventListeners();
        
        // Update assignment mode count if active
        if (isAssignmentMode) {
            updateUnassignedCount();
        }
    }
    
    function addMatchItemEventListeners() {
        // Add event listeners for match items
        document.querySelectorAll('.match-item').forEach(item => {
            // Make the whole card clickable
            item.addEventListener('click', function(e) {
                // Only trigger if not clicking a button
                if (!e.target.closest('button')) {
                    const eventId = this.dataset.eventId;
                    const event = allEvents.find(evt => evt.id == eventId);
                    
                    if (event) {
                        showMatchDetailsModal(event);
                    }
                }
            });
            
            // View button
            const viewBtn = item.querySelector('.view-match-btn');
            if (viewBtn) {
                viewBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const eventId = item.dataset.eventId;
                    const event = allEvents.find(evt => evt.id == eventId);
                    
                    if (event) {
                        showMatchDetailsModal(event);
                    }
                });
            }
            
            // Assign ref button
            const assignBtn = item.querySelector('.assign-ref-btn');
            if (assignBtn) {
                assignBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const eventId = item.dataset.eventId;
                    const event = allEvents.find(evt => evt.id == eventId);
                    
                    if (event) {
                        showAssignRefModal(event);
                    }
                });
            }
            
            // Edit match button
            const editBtn = item.querySelector('.edit-match-btn');
            if (editBtn) {
                editBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const eventId = item.dataset.eventId;
                    
                    // Load match modals and show the edit modal
                    loadMatchModals(eventId);
                });
            }
        });
    }
    
    // Match details modal functions
    function showMatchDetailsModal(event) {
        const modal = document.getElementById('matchDetailsModal');
        if (!modal) return;
        
        // Populate modal fields
        document.getElementById('detailHomeTeam').textContent = event.homeTeam;
        document.getElementById('detailAwayTeam').textContent = event.awayTeam;
        document.getElementById('detailMatchDate').textContent = event.date.toLocaleDateString('en-US', {
            weekday: 'long', 
            month: 'long', 
            day: 'numeric'
        });
        document.getElementById('detailMatchTime').textContent = event.time;
        document.getElementById('detailMatchLocation').textContent = event.location;
        document.getElementById('detailMatchDivision').textContent = event.division;
        document.getElementById('detailMatchReferee').textContent = event.ref;
        
        // Set up the assign referee buttons (both top and bottom button)
        const openAssignRefBtn = document.getElementById('openAssignRefBtn');
        const openAssignRefBtnTop = document.getElementById('openAssignRefBtnTop');
        
        if (openAssignRefBtn) {
            openAssignRefBtn.addEventListener('click', function() {
                bootstrap.Modal.getInstance(modal).hide();
                setTimeout(() => showAssignRefModal(event), 500);
            });
        }

        if (openAssignRefBtnTop) {
            openAssignRefBtnTop.addEventListener('click', function() {
                bootstrap.Modal.getInstance(modal).hide();
                setTimeout(() => showAssignRefModal(event), 500);
            });
        }

        ModalManager.show(modal.id);
    }

    // Referee assignment modal functions
    function showAssignRefModal(event) {
        const modal = document.getElementById('assignRefModal');
        if (!modal) return;
        
        // Populate modal fields
        document.getElementById('matchId').value = event.id;
        document.getElementById('homeTeam').textContent = event.homeTeam;
        document.getElementById('awayTeam').textContent = event.awayTeam;
        document.getElementById('matchDateTime').textContent = `${event.date.toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric'
        })} at ${event.time}`;
        document.getElementById('matchLocation').textContent = event.location;
        document.getElementById('matchDivision').textContent = event.division;
        
        // Set current referee status
        if (event.ref !== 'Unassigned') {
            document.getElementById('currentRefereeSection').style.display = 'block';
            document.getElementById('currentRefereeName').textContent = event.ref;
            document.getElementById('removeRefButton').style.display = 'inline-block';
        } else {
            document.getElementById('currentRefereeSection').style.display = 'none';
            document.getElementById('removeRefButton').style.display = 'none';
        }
        
        // Fetch available referees for the match
        fetchRefereesForMatch(event.id);

        // Clear previous feedback
        document.getElementById('assignRefFeedback').innerHTML = '';

        ModalManager.show(modal.id);
    }
    
    async function fetchRefereesForMatch(matchId) {
        try {
            const response = await fetch(`/calendar/refs?match_id=${matchId}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to fetch referees for this match.');
            }
            
            const referees = await response.json();
            const refSelect = document.getElementById('refSelect');
            refSelect.innerHTML = '<option value="" selected disabled>Choose a referee</option>';
            
            // Add an explanatory note above the dropdown
            const notesContainer = document.createElement('div');
            notesContainer.className = 'referee-notes mb-2';
            notesContainer.innerHTML = `
                <div class="alert alert-info p-2" data-alert>
                    <p class="mb-1 small"><i class="ti ti-info-circle me-1"></i> <strong>Notes:</strong></p>
                    <ul class="mb-0 ps-3 small">
                        <li>Referees who play on either team are automatically excluded</li>
                        <li>Referees already assigned to other matches at this time are automatically excluded</li>
                        <li>Referees with fewer assignments are listed first</li>
                    </ul>
                </div>
            `;
            refSelect.parentNode.insertBefore(notesContainer, refSelect);
            
            if (referees.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "No eligible referees available";
                option.disabled = true;
                refSelect.appendChild(option);
                
                document.getElementById('assignRefButton').disabled = true;
                
                // Add explanation about why there might be no referees
                displayModalFeedback('assignRefFeedback', 
                    'No eligible referees available. This may be because all referees play on one of the teams in this match or are already assigned to other matches at this time.', 
                    'warning');
            } else {
                // Sort referees by the number of matches they're currently assigned
                referees.sort((a, b) => a.matches_assigned_in_week - b.matches_assigned_in_week);
                
                // Add optgroup for available and assigned referees
                const availableGroup = document.createElement('optgroup');
                availableGroup.label = "Available Referees (0 assignments this week)";
                
                const assignedGroup = document.createElement('optgroup');
                assignedGroup.label = "Assigned Referees (with other assignments)";
                
                let hasAvailable = false;
                let hasAssigned = false;
                
                referees.forEach(ref => {
                    const option = document.createElement('option');
                    option.value = ref.id;
                    
                    let assignmentLabel = '';
                    if (ref.matches_assigned_in_week > 0) {
                        assignmentLabel = `(${ref.matches_assigned_in_week} assignment${ref.matches_assigned_in_week > 1 ? 's' : ''} this week)`;
                        option.dataset.assigned = 'true';
                        assignedGroup.appendChild(option);
                        hasAssigned = true;
                    } else {
                        assignmentLabel = '(Available)';
                        option.classList.add('text-success', 'fw-bold');
                        availableGroup.appendChild(option);
                        hasAvailable = true;
                    }
                    
                    option.textContent = `${ref.name} ${assignmentLabel}`;
                });
                
                // Add the groups to the select
                if (hasAvailable) {
                    refSelect.appendChild(availableGroup);
                }
                
                if (hasAssigned) {
                    refSelect.appendChild(assignedGroup);
                }
                
                refSelect.disabled = false;
                document.getElementById('assignRefButton').disabled = false;
            }
        } catch (error) {
            console.error('Error fetching referees:', error);
            displayModalFeedback('assignRefFeedback', `Error fetching referees: ${error.message}`, 'danger');
        }
    }
    
    // Assign referee form submission
    document.getElementById('assignRefForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const matchId = document.getElementById('matchId').value;
        const refId = document.getElementById('refSelect').value;
        
        if (!refId) {
            displayModalFeedback('assignRefFeedback', 'Please select a referee.', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/calendar/assign_ref', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': _csrfToken,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ match_id: matchId, ref_id: refId })
            });
            
            const result = await response.json();
            
            if (!response.ok || result.error) {
                const errorMsg = result.error || 'Failed to assign referee.';
                displayModalFeedback('assignRefFeedback', errorMsg, 'danger');
                return;
            }
            
            displayModalFeedback('assignRefFeedback', 'Referee assigned successfully!', 'success');
            
            // Refresh data after a short delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('assignRefModal')).hide();
                
                // Reload both schedule and refs
                Promise.all([
                    loadScheduleEvents(),
                    fetchAvailableReferees()
                ]).then(() => {
                    showToast('success', 'Referee assigned successfully');
                });
            }, 1000);
        } catch (error) {
            console.error('Error assigning referee:', error);
            displayModalFeedback('assignRefFeedback', 'Error assigning referee.', 'danger');
        }
    });
    
    // Remove referee button click
    document.getElementById('removeRefButton').addEventListener('click', async function() {
        const matchId = document.getElementById('matchId').value;
        
        if (!confirm('Are you sure you want to remove the referee from this match?')) {
            return;
        }
        
        try {
            const response = await fetch('/calendar/remove_ref', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': _csrfToken,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ match_id: matchId })
            });
            
            const result = await response.json();
            
            if (!response.ok || result.error) {
                const errorMsg = result.error || 'Failed to remove referee.';
                displayModalFeedback('assignRefFeedback', errorMsg, 'danger');
                return;
            }
            
            displayModalFeedback('assignRefFeedback', 'Referee removed successfully!', 'success');
            
            // Refresh data after a short delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('assignRefModal')).hide();
                
                // Reload both schedule and refs
                Promise.all([
                    loadScheduleEvents(),
                    fetchAvailableReferees()
                ]).then(() => {
                    showToast('success', 'Referee removed successfully');
                });
            }, 1000);
        } catch (error) {
            console.error('Error removing referee:', error);
            displayModalFeedback('assignRefFeedback', 'Error removing referee.', 'danger');
        }
    });
    
    function displayModalFeedback(elementId, message, type) {
        const feedbackEl = document.getElementById(elementId);
        const icons = {
            success: '<i class="ti ti-circle-check me-2"></i>',
            danger: '<i class="ti ti-circle-x me-2"></i>',
            warning: '<i class="ti ti-alert-triangle me-2"></i>',
            info: '<i class="ti ti-info-circle me-2"></i>'
        };
        
        feedbackEl.innerHTML = `
            <div class="alert alert-${type} d-flex align-items-center p-2 m-0 rounded-3" role="alert" data-alert>
                ${icons[type] || ''}
                <span class="fw-semibold small">${message}</span>
            </div>
        `;
    }
    
    function showToast(type, message) {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        const toastId = 'toast-' + Date.now();
        const icons = {
            success: '<i class="ti ti-circle-check me-2"></i>',
            danger: '<i class="ti ti-circle-x me-2"></i>',
            warning: '<i class="ti ti-alert-triangle me-2"></i>',
            info: '<i class="ti ti-info-circle me-2"></i>'
        };
        
        const toastHtml = `
            <div id="${toastId}" class="toast shadow-lg rounded-3" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex p-3">
                    <div class="toast-body d-flex align-items-center text-${type}">
                        ${icons[type] || ''}
                        <span class="fw-semibold">${message}</span>
                    </div>
                    <button type="button" class="btn-close me-2 m-auto text-${type}" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        
        if (toastElement) {
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 3000
            });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', function() {
                this.remove();
            });
        }
    }
    
    // Load referee assignments for the current user
    async function loadRefereeAssignments() {
        try {
            const response = await fetch('/calendar/my_assignments');
            if (!response.ok) throw new Error('Failed to fetch assignments.');
            
            const data = await response.json();
            renderRefereeAssignments(data.assignments);
            
            // Update assignment count
            document.getElementById('myAssignmentsCount').textContent = data.total_assignments;
            
        } catch (error) {
            console.error('Error loading referee assignments:', error);
            document.getElementById('myAssignmentsList').innerHTML = `
                <div class="text-center py-4">
                    <i class="ti ti-alert-triangle text-danger mb-2 calendar-icon-alert-lg"></i>
                    <p class="text-danger mb-1 fw-medium">Failed to load assignments</p>
                    <button class="c-btn c-btn--sm c-btn--outline-danger mt-2 js-load-referee-assignments" data-action="load-referee-assignments">
                        <i class="ti ti-refresh me-1"></i> Retry
                    </button>
                </div>
            `;
        }
    }
    
    function renderRefereeAssignments(assignments) {
        const assignmentsList = document.getElementById('myAssignmentsList');
        
        if (assignments.length === 0) {
            assignmentsList.innerHTML = `
                <div class="text-center py-4">
                    <div class="avatar avatar-lg bg-label-primary mx-auto mb-2">
                        <i class="ti ti-calendar-off"></i>
                    </div>
                    <h6 class="text-muted mb-1">No Assignments Yet</h6>
                    <p class="text-muted small mb-0">You don't have any upcoming referee assignments</p>
                </div>
            `;
            return;
        }
        
        let html = '<div class="list-group list-group-flush">';
        
        assignments.forEach(assignment => {
            const matchDate = new Date(assignment.start);
            const isUpcoming = matchDate > new Date();
            
            html += `
                <div class="list-group-item border-0 px-3 py-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1 fw-semibold">${assignment.title}</h6>
                            <div class="d-flex align-items-center text-muted small mb-1">
                                <i class="ti ti-calendar me-1"></i>
                                <span>${assignment.date}</span>
                                <i class="ti ti-clock ms-2 me-1"></i>
                                <span>${assignment.time}</span>
                            </div>
                            <div class="d-flex align-items-center text-muted small">
                                <i class="ti ti-map-pin me-1"></i>
                                <span>${assignment.location}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-${assignment.division === 'Premier' ? 'primary' : 'success'} mb-1" data-badge>${assignment.division}</span>
                            <br>
                            <span class="badge bg-${isUpcoming ? 'info' : 'secondary'} small" data-badge>
                                ${isUpcoming ? 'Upcoming' : 'Completed'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        assignmentsList.innerHTML = html;
    }
    
    // Load referee availability status
    async function loadRefereeAvailabilityStatus() {
        try {
            const response = await fetch('/calendar/availability_status');
            if (!response.ok) throw new Error('Failed to fetch availability status.');
            
            const data = await response.json();
            renderAvailabilityStatus(data.is_available, data.referee_name);
            
        } catch (error) {
            console.error('Error loading availability status:', error);
            document.getElementById('availabilityStatus').innerHTML = `
                <i class="ti ti-alert-triangle text-danger mb-2 calendar-icon-alert-lg"></i>
                <p class="text-danger">Failed to load status</p>
            `;
        }
    }
    
    function renderAvailabilityStatus(isAvailable, refereeName) {
        const statusEl = document.getElementById('availabilityStatus');
        const toggleBtn = document.getElementById('toggleAvailabilityBtn');
        
        statusEl.innerHTML = `
            <div class="avatar avatar-lg bg-${isAvailable ? 'success' : 'secondary'} mx-auto mb-2">
                <i class="ti ti-${isAvailable ? 'check' : 'x'}"></i>
            </div>
            <h6 class="mb-1">You are ${isAvailable ? 'Available' : 'Unavailable'}</h6>
            <p class="text-muted small mb-0">for referee assignments</p>
        `;
        
        toggleBtn.disabled = false;
        toggleBtn.innerHTML = `
            <i class="ti ti-toggle-${isAvailable ? 'right' : 'left'} me-1"></i>
            ${isAvailable ? 'Set Unavailable' : 'Set Available'}
        `;
        
        // Add click handler for toggle button
        toggleBtn.addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<i class="ti ti-loader ti-spin me-1"></i> Updating...';
            
            try {
                const response = await fetch('/calendar/toggle_availability', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': _csrfToken
                    }
                });
                
                if (!response.ok) throw new Error('Failed to update availability.');
                
                const result = await response.json();
                renderAvailabilityStatus(result.is_available, refereeName);
                showToast('success', result.message);
                
            } catch (error) {
                console.error('Error toggling availability:', error);
                showToast('danger', 'Failed to update availability');
                this.disabled = false;
                this.innerHTML = `<i class="ti ti-toggle-${isAvailable ? 'right' : 'left'} me-1"></i> ${isAvailable ? 'Set Unavailable' : 'Set Available'}`;
            }
        });
    }
    
    // Assignment Mode Functions
    function toggleAssignmentModeUI(enabled) {
        const assignmentModeOverlay = document.getElementById('assignmentModeOverlay');
        const scheduleContent = document.getElementById('scheduleContent');
        const sidebar = document.querySelector('.col-lg-4.col-xl-3');
        
        if (enabled) {
            // Show assignment mode overlay
            if (assignmentModeOverlay) {
                assignmentModeOverlay.style.display = 'block';
            }
            
            // Add assignment mode classes to existing elements
            document.body.classList.add('assignment-mode-active');
            
            // Hide stats cards for referees
            if (isReferee) {
                const refereeCards = document.querySelectorAll('#myAssignmentsList, .availability-container');
                refereeCards.forEach(card => {
                    const cardParent = card.closest('.card');
                    if (cardParent) cardParent.style.display = 'none';
                });
            }
            
            // Enhance referee list for assignment mode
            enhanceRefereeListForAssignment();
            
            // Re-render schedule with assignment mode styling
            renderSchedule();
            
            // Show assignment helper
            showAssignmentHelper();
            
        } else {
            // Hide assignment mode overlay
            if (assignmentModeOverlay) {
                assignmentModeOverlay.style.display = 'none';
            }
            
            // Remove assignment mode classes
            document.body.classList.remove('assignment-mode-active');
            
            // Restore referee cards
            if (isReferee) {
                const refereeCards = document.querySelectorAll('#myAssignmentsList, .availability-container');
                refereeCards.forEach(card => {
                    const cardParent = card.closest('.card');
                    if (cardParent) cardParent.style.display = 'block';
                });
            }
            
            // Restore normal referee list
            fetchAvailableReferees();
            
            // Re-render schedule in normal mode
            renderSchedule();
            
            // Hide assignment helper
            hideAssignmentHelper();
        }
    }
    
    function enhanceRefereeListForAssignment() {
        const refereeList = document.getElementById('refereeList');
        if (!refereeList) return;
        
        // Add assignment mode header to referee list
        const currentHeader = refereeList.previousElementSibling;
        if (currentHeader && currentHeader.classList.contains('card-header')) {
            const titleElement = currentHeader.querySelector('.card-title');
            if (titleElement && !titleElement.innerHTML.includes('Quick Assign')) {
                titleElement.innerHTML = '<i class="ti ti-user-plus me-2"></i>Quick Assign Referees';
            }
        }
        
        // Add click handlers to referee items for quick assignment
        refereeList.addEventListener('click', handleRefereeAssignmentClick);
    }
    
    function handleRefereeAssignmentClick(event) {
        if (!isAssignmentMode) return;
        
        const refItem = event.target.closest('[data-ref-id]');
        if (!refItem) return;
        
        const refId = refItem.dataset.refId;
        const refName = refItem.dataset.refName;
        
        // Highlight selected referee
        document.querySelectorAll('[data-ref-id]').forEach(item => {
            item.classList.remove('selected-referee');
        });
        refItem.classList.add('selected-referee');
        
        // Enable quick assignment mode for matches
        enableQuickAssignmentForMatches(refId, refName);
        
        showToast('info', `Click on any unassigned match to assign ${refName}`);
    }
    
    function enableQuickAssignmentForMatches(refId, refName) {
        // Store selected referee for quick assignment
        window.selectedRefereeForAssignment = { id: refId, name: refName };
        
        // Highlight unassigned matches
        document.querySelectorAll('.match-item').forEach(matchItem => {
            const eventId = matchItem.dataset.eventId;
            const event = allEvents.find(evt => evt.id == eventId);
            
            if (event && event.ref === 'Unassigned') {
                matchItem.classList.add('assignable-match');
                
                // Add click handler for quick assignment
                const quickAssignHandler = function(e) {
                    e.stopPropagation();
                    performQuickAssignment(eventId, refId, refName);
                };
                
                // Remove existing handlers
                matchItem.removeEventListener('click', quickAssignHandler);
                // Add new handler
                matchItem.addEventListener('click', quickAssignHandler);
            }
        });
    }
    
    function performQuickAssignment(matchId, refId, refName) {
        // Disable the match item temporarily
        const matchItem = document.querySelector(`[data-event-id="${matchId}"]`);
        if (matchItem) {
            matchItem.style.pointerEvents = 'none';
            matchItem.style.opacity = '0.6';
        }
        
        // Perform the assignment
        fetch('/calendar/assign_ref', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': _csrfToken
            },
            body: JSON.stringify({
                match_id: parseInt(matchId),
                ref_id: parseInt(refId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                // Success - update the UI
                const event = allEvents.find(evt => evt.id == matchId);
                if (event) {
                    event.ref = refName;
                }
                
                // Re-render the schedule to reflect changes
                renderSchedule();
                
                // Update stats
                loadScheduleEvents();
                
                showToast('success', `${refName} assigned successfully!`);
                
                // Clear selection
                clearQuickAssignmentSelection();
                
            } else {
                throw new Error(data.error || 'Assignment failed');
            }
        })
        .catch(error => {
            console.error('Assignment error:', error);
            showToast('danger', `Failed to assign referee: ${error.message}`);
            
            // Re-enable the match item
            if (matchItem) {
                matchItem.style.pointerEvents = 'auto';
                matchItem.style.opacity = '1';
            }
        });
    }
    
    function clearQuickAssignmentSelection() {
        // Clear selected referee
        window.selectedRefereeForAssignment = null;
        
        // Remove highlighting
        document.querySelectorAll('[data-ref-id]').forEach(item => {
            item.classList.remove('selected-referee');
        });
        
        document.querySelectorAll('.match-item').forEach(item => {
            item.classList.remove('assignable-match');
        });
    }
    
    function showAssignmentHelper() {
        // Create and show assignment helper overlay
        const helper = document.createElement('div');
        helper.id = 'assignmentHelper';
        helper.className = 'assignment-helper';
        helper.innerHTML = `
            <div class="assignment-helper-content">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="mb-0 text-primary">
                        <i class="ti ti-info-circle me-1"></i>
                        Assignment Mode Active
                    </h6>
                    <button type="button" class="c-btn c-btn--sm c-btn--outline-secondary js-toggle-assignment-mode" data-action="toggle-assignment-mode" aria-label="Button"><i class="ti ti-x"></i></button>
                </div>
                <p class="small mb-2">
                    1. Click a referee in the sidebar to select them<br>
                    2. Click any unassigned match to quickly assign the selected referee<br>
                    3. Unassigned matches are highlighted in red
                </p>
                <div class="assignment-stats small text-muted">
                    <span id="unassignedCount">0</span> unassigned matches
                </div>
            </div>
        `;
        
        // Remove existing helper
        const existing = document.getElementById('assignmentHelper');
        if (existing) existing.remove();
        
        // Add to the top of the schedule content
        const scheduleContent = document.getElementById('scheduleContent');
        scheduleContent.insertBefore(helper, scheduleContent.firstChild);
        
        // Update unassigned count
        updateUnassignedCount();
    }
    
    function hideAssignmentHelper() {
        const helper = document.getElementById('assignmentHelper');
        if (helper) helper.remove();
        
        // Clear any selection
        clearQuickAssignmentSelection();
    }
    
    function updateUnassignedCount() {
        const unassignedMatches = allEvents.filter(event => event.ref === 'Unassigned');
        const countElement = document.getElementById('unassignedCount');
        if (countElement) {
            countElement.textContent = unassignedMatches.length;
        }
    }
    
    // Function to load match modals and show the edit modal
    async function loadMatchModals(matchId) {
        try {
            // Load the modals for this specific match
            const response = await fetch(`/render_modals?match_ids=${matchId}`);
            if (!response.ok) throw new Error('Failed to load match modals');
            
            const modalHtml = await response.text();
            
            // Create a temporary container to hold the modal
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = modalHtml;
            
            // Find the modal and append it to the body
            const modal = tempDiv.querySelector(`#reportMatchModal-${matchId}`);
            if (modal) {
                // Remove any existing modal with the same ID
                const existingModal = document.querySelector(`#reportMatchModal-${matchId}`);
                if (existingModal) {
                    existingModal.remove();
                }

                // Append the new modal to the body
                document.body.appendChild(modal);

                ModalManager.show(modal.id);

                // Clean up when modal is hidden
                modal.addEventListener('hidden.bs.modal', function() {
                    modal.remove();
                });
            } else {
                showToast('danger', 'Failed to load match edit modal');
            }
        } catch (error) {
            console.error('Error loading match modals:', error);
            showToast('danger', 'Failed to load match edit interface');
        }
    }
    
    // Initialize mini calendar with flatpickr
    let miniCalendarInstance = null;
    const miniCalendarEl = document.getElementById('miniCalendar');
    if (miniCalendarEl && typeof flatpickr !== 'undefined') {
        miniCalendarInstance = flatpickr(miniCalendarEl, {
            inline: true,
            monthSelectorType: 'static',
            defaultDate: currentDate,
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0) {
                    currentDate = selectedDates[0];
                    updateDateDisplay();
                    renderSchedule();
                }
            },
            onDayCreate: function(dObj, dStr, fp, dayElem) {
                // Highlight days with events
                const date = dayElem.dateObj;
                if (date && allEvents.length > 0) {
                    const hasEvents = allEvents.some(event => {
                        const eventDate = new Date(event.start);
                        return eventDate.toDateString() === date.toDateString();
                    });
                    if (hasEvents) {
                        dayElem.classList.add('has-event');
                    }
                }
            }
        });
    }

    // Function to update mini calendar when events load
    function updateMiniCalendarDots() {
        if (miniCalendarInstance) {
            miniCalendarInstance.redraw();
        }
    }

    // Initialize the page
    loadScheduleEvents().then(() => {
        updateMiniCalendarDots();
    });
    fetchAvailableReferees();

    // Load referee assignments if user is a referee
    if (isReferee) {
        loadRefereeAssignments();
        loadRefereeAvailabilityStatus();
    }

    // Initialize League Event Manager (for admins)
    const canEditEvents = {{ 'true' if can_edit_events else 'false' }};
    if (typeof LeagueEventManager !== 'undefined') {
        LeagueEventManager.init({ isAdmin: canEditEvents });

        // Bind Add Event button
        const addEventBtn = document.getElementById('addLeagueEventBtn');
        if (addEventBtn) {
            addEventBtn.addEventListener('click', function() {
                LeagueEventManager.openCreateModal();
            });
        }
    }

    // Initialize Calendar Filter Manager
    if (typeof CalendarFilterManager !== 'undefined') {
        CalendarFilterManager.init({
            onFilterChange: function(filters) {
                // Re-render schedule with new filters applied
                renderSchedule();
            }
        });

        // Reset filters button
        const resetFiltersBtn = document.getElementById('filterResetBtn');
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', function() {
                CalendarFilterManager.resetFilters();
            });
        }
    }

    // Expose refreshCalendar globally for use by other modules
    window.refreshCalendar = function() {
        loadScheduleEvents();
        fetchAvailableReferees();
    };

    // Keyboard navigation for calendar
    document.addEventListener('keydown', function(e) {
        // Don't handle keyboard events when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
            return;
        }

        // Don't handle if a modal is open
        const openModal = document.querySelector('.modal.show');
        if (openModal) {
            return;
        }

        switch(e.key) {
            case 'ArrowLeft':
                // Navigate to previous period
                e.preventDefault();
                navigateDate(-1);
                break;

            case 'ArrowRight':
                // Navigate to next period
                e.preventDefault();
                navigateDate(1);
                break;

            case 'ArrowUp':
                // Switch to more detailed view
                e.preventDefault();
                switchView('up');
                break;

            case 'ArrowDown':
                // Switch to less detailed view
                e.preventDefault();
                switchView('down');
                break;

            case 't':
            case 'T':
                // Go to today
                e.preventDefault();
                document.getElementById('todayBtn').click();
                break;

            case 'n':
            case 'N':
                // Go to next event
                e.preventDefault();
                jumpToNextEvent();
                break;

            case 'd':
            case 'D':
                // Switch to day view
                if (!e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    setView('day');
                }
                break;

            case 'w':
            case 'W':
                // Switch to week view
                if (!e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    setView('week');
                }
                break;

            case 'm':
            case 'M':
                // Switch to month view
                if (!e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    setView('month');
                }
                break;

            case 'l':
            case 'L':
                // Switch to list view
                if (!e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    setView('list');
                }
                break;

            case '?':
                // Show keyboard shortcuts help
                e.preventDefault();
                showKeyboardShortcuts();
                break;
        }
    });

    // Event delegation for data-action attributes (standardized pattern)
    document.addEventListener('click', function(e) {
        const actionElement = e.target.closest('[data-action]');
        if (!actionElement) return;

        const action = actionElement.dataset.action;

        switch(action) {
            case 'refresh-schedule':
                e.preventDefault();
                document.getElementById('refreshScheduleBtn')?.click();
                break;
            case 'load-referee-assignments':
                e.preventDefault();
                loadRefereeAssignments();
                break;
            case 'toggle-assignment-mode':
                e.preventDefault();
                document.getElementById('toggleAssignmentMode')?.click();
                break;
        }
    });

    function switchView(direction) {
        const views = ['month', 'week', 'day'];
        const currentIndex = views.indexOf(currentView);

        if (direction === 'up' && currentIndex < views.length - 1) {
            setView(views[currentIndex + 1]);
        } else if (direction === 'down' && currentIndex > 0) {
            setView(views[currentIndex - 1]);
        }
    }

    function setView(view) {
        currentView = view;
        viewButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === view);
        });
        renderSchedule();
    }

    function showKeyboardShortcuts() {
        const shortcuts = [
            { key: ' / ', desc: 'Navigate previous/next' },
            { key: ' / ', desc: 'Zoom in/out views' },
            { key: 'T', desc: 'Go to today' },
            { key: 'N', desc: 'Jump to next event' },
            { key: 'D / W / M / L', desc: 'Day/Week/Month/List view' },
            { key: '?', desc: 'Show this help' }
        ];

        const html = `
            <div class="modal c-modal fade" data-modal id="keyboardShortcutsModal" tabindex="-1" aria-labelledby="keyboardShortcutsModalLabel">
                <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered modal-sm c-modal__dialog--sm" data-modal-dialog>
                    <div class="modal-content c-modal__content" data-modal-content data-modal-content>
                        <div class="modal-header c-modal__header border-bottom py-2" data-modal-header>
                            <h6 class="modal-title c-modal__title" id="keyboardShortcutsModalLabel">
                                <i class="ti ti-keyboard me-2"></i>Keyboard Shortcuts
                            </h6>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
                        </div>
                        <div class="modal-body c-modal__body py-3" data-modal-body>
                            <table class="c-table c-table--compact mb-0" data-table data-mobile-table data-table-type="calendar">
                                <tbody>
                                    ${shortcuts.map(s => `
                                        <tr>
                                            <td><kbd>${s.key}</kbd></td>
                                            <td class="text-muted small">${s.desc}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal
        const existing = document.getElementById('keyboardShortcutsModal');
        if (existing) existing.remove();

        // Add and show new modal
        document.body.insertAdjacentHTML('beforeend', html);
        ModalManager.show('keyboardShortcutsModal');
    }
});
</script>
{% endblock %}

{% block custom_css %}
{{ super() }}
<!-- Calendar Page Specific Styles -->
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/calendar.css') }}">
{% endif %}
<style>
/* Mini Calendar Styles */
#miniCalendar {
    display: flex;
    justify-content: center;
}
#miniCalendar .flatpickr-calendar {
    box-shadow: none !important;
    border: none !important;
    width: 100% !important;
    max-width: 280px;
}
#miniCalendar .flatpickr-innerContainer {
    padding: 0;
}
#miniCalendar .flatpickr-day {
    max-width: 36px;
    height: 36px;
    line-height: 36px;
    border-radius: 50%;
}
#miniCalendar .flatpickr-day.has-event {
    position: relative;
}
#miniCalendar .flatpickr-day.has-event::after {
    content: '';
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    background: var(--bs-primary);
    border-radius: 50%;
}
#miniCalendar .flatpickr-day.selected.has-event::after {
    background: white;
}
#miniCalendar .flatpickr-day.today {
    border: 2px solid var(--bs-primary) !important;
}
#miniCalendar .flatpickr-months {
    padding-bottom: 0.5rem;
}
#miniCalendar .flatpickr-monthDropdown-months {
    font-weight: 600;
}
/* Dark mode support for mini calendar */
[data-bs-theme="dark"] #miniCalendar .flatpickr-calendar,
.dark-style #miniCalendar .flatpickr-calendar {
    background: var(--bs-card-bg, #2b2c40);
    color: var(--bs-body-color, #a3a4cc);
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-day,
.dark-style #miniCalendar .flatpickr-day {
    color: var(--bs-body-color, #a3a4cc);
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-day:hover,
.dark-style #miniCalendar .flatpickr-day:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: transparent;
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-day.prevMonthDay,
[data-bs-theme="dark"] #miniCalendar .flatpickr-day.nextMonthDay,
.dark-style #miniCalendar .flatpickr-day.prevMonthDay,
.dark-style #miniCalendar .flatpickr-day.nextMonthDay {
    color: rgba(163, 164, 204, 0.4);
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-day.selected,
.dark-style #miniCalendar .flatpickr-day.selected {
    background: var(--bs-primary);
    border-color: var(--bs-primary);
    color: var(--ecs-neutral-0, #ffffff);
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-day.today,
.dark-style #miniCalendar .flatpickr-day.today {
    border-color: var(--bs-primary) !important;
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-months,
.dark-style #miniCalendar .flatpickr-months {
    background: var(--bs-card-bg, #2b2c40);
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-months .flatpickr-month,
.dark-style #miniCalendar .flatpickr-months .flatpickr-month {
    background: transparent;
    color: var(--bs-body-color, #a3a4cc);
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-current-month,
.dark-style #miniCalendar .flatpickr-current-month {
    color: var(--bs-body-color, #a3a4cc);
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-current-month .flatpickr-monthDropdown-months,
.dark-style #miniCalendar .flatpickr-current-month .flatpickr-monthDropdown-months {
    background: var(--bs-card-bg, #2b2c40);
    color: var(--bs-body-color, #a3a4cc);
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-current-month input.cur-year,
.dark-style #miniCalendar .flatpickr-current-month input.cur-year {
    color: var(--bs-body-color, #a3a4cc);
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-weekdays,
.dark-style #miniCalendar .flatpickr-weekdays {
    background: var(--bs-card-bg, #2b2c40);
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-weekday,
.dark-style #miniCalendar .flatpickr-weekday {
    color: var(--bs-body-color, #a3a4cc);
    background: transparent;
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-prev-month,
[data-bs-theme="dark"] #miniCalendar .flatpickr-next-month,
.dark-style #miniCalendar .flatpickr-prev-month,
.dark-style #miniCalendar .flatpickr-next-month {
    fill: var(--bs-body-color, #a3a4cc);
    color: var(--bs-body-color, #a3a4cc);
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-prev-month:hover,
[data-bs-theme="dark"] #miniCalendar .flatpickr-next-month:hover,
.dark-style #miniCalendar .flatpickr-prev-month:hover,
.dark-style #miniCalendar .flatpickr-next-month:hover {
    fill: var(--bs-primary);
    color: var(--bs-primary);
}
[data-bs-theme="dark"] #miniCalendar .flatpickr-innerContainer,
.dark-style #miniCalendar .flatpickr-innerContainer {
    background: var(--bs-card-bg, #2b2c40);
    border-color: var(--bs-border-color, #444564);
}
/* Schedule Views */
.schedule-content {
    min-height: 500px;
}
/* Day View - Timeline style */
.day-schedule {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
}
.time-slot {
    display: flex;
    gap: 1rem;
}
.time-label {
    flex: 0 0 80px;
    padding: 0.5rem;
    font-weight: bold;
    text-align: right;
    color: var(--bs-primary);
    position: relative;
}
.time-label::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    width: 2px;
    background: linear-gradient(to bottom, rgba(var(--bs-primary-rgb), 0.1), rgba(var(--bs-primary-rgb), 0.3), rgba(var(--bs-primary-rgb), 0.1));
    border-radius: 2px;
}
.time-events {
    flex: 1;
    min-width: 0;
    padding-top: 0.5rem;
}
/* Week View */
.week-schedule {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}
.week-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    padding-bottom: 0.75rem;
    margin-bottom: 0.75rem;
}
.day-header {
    text-align: center;
    padding: 0.5rem;
    border-radius: 0.375rem;
    transition: background-color 0.2s ease;
}
.day-header.today {
    background-color: rgba(var(--bs-primary-rgb), 0.1);
    font-weight: bold;
}
.day-name {
    font-weight: bold;
}
.day-date {
    font-size: 1.25rem;
}
.week-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.75rem;
    min-height: 500px;
}
.day-column {
    padding: 0.75rem;
    border-radius: 0.375rem;
    background-color: rgba(0,0,0,0.02);
    overflow-y: auto;
    max-height: 500px;
    transition: all 0.2s ease;
    border: 1px solid rgba(0,0,0,0.05);
}
.day-column:hover {
    background-color: rgba(0,0,0,0.03);
    border-color: rgba(0,0,0,0.08);
}
.day-column.today {
    background-color: rgba(var(--bs-primary-rgb), 0.05);
    border: 1px solid rgba(var(--bs-primary-rgb), 0.2);
}
.day-empty {
    display: flex;
    height: 100%;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    gap: 0.5rem;
    opacity: 0.6;
}
/* Month View */
.month-schedule {
    display: flex;
    flex-direction: column;
}
.month-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
    text-align: center;
    font-weight: bold;
    color: var(--bs-primary);
    margin-bottom: 0.75rem;
}
.month-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
}
.month-day {
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 0.375rem;
    height: 120px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.2s ease;
}
.month-day:hover {
    border-color: rgba(var(--bs-primary-rgb), 0.2);
    background-color: rgba(var(--bs-primary-rgb), 0.01);
}
.month-day.today {
    border: 1px solid rgba(var(--bs-primary-rgb), 0.3);
    background-color: rgba(var(--bs-primary-rgb), 0.05);
    box-shadow: 0 0 0 1px rgba(var(--bs-primary-rgb), 0.1);
}
.month-day.prev-month, .month-day.next-month {
    opacity: 0.5;
    background-color: rgba(0,0,0,0.03);
}
.month-day-header {
    padding: 0.25rem 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    background-color: rgba(0,0,0,0.02);
}
.month-day-header .day-number {
    font-size: 0.9rem;
}
.event-count-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.25rem;
    height: 1.25rem;
    padding: 0 0.35rem;
    font-size: 0.7rem;
    font-weight: 600;
    background: var(--bs-primary);
    color: white;
    border-radius: 50px;
}
.month-day.has-events {
    background-color: rgba(var(--bs-primary-rgb), 0.02);
}
.month-day-content {
    flex: 1;
    overflow-y: auto;
    padding: 0.25rem;
}
.month-event {
    padding: 0.375rem;
    border-radius: 0.375rem;
    margin-bottom: 0.25rem;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    background: rgba(var(--bs-primary-rgb), 0.075);
    border-left: 3px solid var(--bs-primary);
    transition: all 0.2s ease;
}
.month-event:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(var(--bs-primary-rgb), 0.15);
    background: rgba(var(--bs-primary-rgb), 0.1);
}
.month-event.premier {
    background: rgba(var(--bs-primary-rgb), 0.075);
    border-left: 3px solid var(--bs-primary);
}
.month-event.premier:hover {
    background: rgba(var(--bs-primary-rgb), 0.1);
}
.month-event.classic {
    background: rgba(var(--bs-success-rgb), 0.075);
    border-left: 3px solid var(--bs-success);
}
.month-event.classic:hover {
    background: rgba(var(--bs-success-rgb), 0.1);
    box-shadow: 0 2px 5px rgba(var(--bs-success-rgb), 0.15);
}
.month-event-time {
    font-weight: bold;
    margin-right: 0.5rem;
    flex-shrink: 0;
}
.month-event-title {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.month-event-ref {
    margin-left: 0.5rem;
    flex-shrink: 0;
    position: relative;
}
.month-event-ref.assigned {
    color: var(--bs-success);
}
.month-event-ref.unassigned {
    color: var(--bs-danger);
}
.ref-add-icon {
    font-size: 0.6rem;
    position: absolute;
    bottom: -1px;
    right: -1px;
    background-color: var(--bs-primary);
    color: white;
    border-radius: 50%;
    padding: 1px;
}
.month-more-events {
    text-align: center;
    font-size: 0.8rem;
    font-weight: bold;
    color: var(--bs-primary);
    padding: 0.25rem;
    cursor: pointer;
    background-color: rgba(var(--bs-primary-rgb), 0.05);
    border-radius: 0.375rem;
    transition: all 0.2s ease;
}
.month-more-events:hover {
    background-color: rgba(var(--bs-primary-rgb), 0.1);
    transform: translateY(-1px);
}
/* List View */
.list-schedule {
    display: flex;
    flex-direction: column;
}
.date-group {
    margin-bottom: 1.75rem;
}
.date-group.today .date-header {
    background-color: rgba(var(--bs-primary-rgb), 0.08);
    border-left: 4px solid var(--bs-primary);
}
.date-header {
    font-weight: bold;
    padding: 0.75rem;
    margin-bottom: 1rem;
    color: var(--bs-primary);
    border-radius: 0.375rem 0 0 0.375rem;
    border-bottom: 1px solid rgba(var(--bs-primary-rgb), 0.2);
    background-color: rgba(var(--bs-primary-rgb), 0.03);
}
.date-matches {
    padding-left: 1rem;
}
/* Match Item Styling */
.match-item {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid rgba(0,0,0,0.06);
    background-color: var(--ecs-neutral-0, #ffffff);
}
.match-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 0.25rem 1rem rgba(161, 172, 184, 0.15);
    border-color: rgba(var(--bs-primary-rgb), 0.2);
    z-index: 1;
}
.match-teams {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
    font-weight: bold;
}
.home-team, .away-team {
    flex: 1;
}
.home-team {
    text-align: right;
}
.away-team {
    text-align: left;
}
.vs {
    margin: 0 1rem;
    color: var(--bs-secondary);
    font-size: 0.875rem;
    opacity: 0.8;
}
.match-teams-compact {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.ref-badge {
    display: flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    background-color: rgba(var(--bs-primary-rgb), 0.075);
    color: var(--bs-primary);
    transition: all 0.2s ease;
}
.match-item:hover .ref-badge {
    background-color: rgba(var(--bs-primary-rgb), 0.1);
}
.ref-badge-small {
    display: flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    background-color: rgba(var(--bs-primary-rgb), 0.075);
    color: var(--bs-primary);
    transition: all 0.2s ease;
}
.ref-assigned {
    background-color: rgba(var(--bs-success-rgb), 0.075) !important;
    color: var(--bs-success);
}
.match-item:hover .ref-assigned {
    background-color: rgba(var(--bs-success-rgb), 0.1) !important;
}
.ref-unassigned {
    background-color: rgba(var(--bs-danger-rgb), 0.075) !important;
    color: var(--bs-danger);
}
.match-item:hover .ref-unassigned {
    background-color: rgba(var(--bs-danger-rgb), 0.1) !important;
}
/* Referee List Styling */
.referee-list {
    max-height: 600px;
    overflow-y: auto;
}
.referee-item {
    cursor: pointer;
    transition: all 0.2s ease;
}
.referee-item:hover .card {
    transform: translateY(-3px);
    box-shadow: 0 0.25rem 0.5rem rgba(161, 172, 184, 0.12);
    border-color: rgba(var(--bs-primary-rgb), 0.2);
}
.referee-available {
    border-left: 3px solid var(--bs-success);
}
/* Modal Styling */
.match-detail-card {
    border-radius: 0.5rem;
    overflow: hidden;
    transition: all 0.2s ease;
    background-color: rgba(var(--bs-primary-rgb), 0.04);
}
.match-detail-header {
    padding: 0.75rem 1rem;
    color: white;
    font-weight: 500;
    background-color: rgba(var(--bs-primary-rgb), 0.9);
}
.match-detail-body {
    padding: 1rem;
}
.match-location {
    font-size: 0.875rem;
    color: var(--bs-secondary);
}
.current-ref-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: white;
    padding: 0.75rem 1rem;
}
.current-ref-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.current-ref-icon {
    font-size: 1.25rem;
    color: var(--bs-primary);
}
/* Match Details Modal */
.match-detail-full {
    padding: 0;
}
.match-teams-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.75rem;
    text-align: center;
    padding: 0.5rem;
}
.team {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
}
.avatar-lg {
    width: 56px;
    height: 56px;
    font-size: 1.5rem;
}
.team-name {
    font-size: 1.25rem;
}
.match-vs {
    padding: 0 1rem;
    font-weight: bold;
    color: var(--bs-secondary);
    font-size: 1.5rem;
    opacity: 0.7;
}
.match-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
    margin-bottom: 1.75rem;
    padding: 0 0.5rem;
}
.match-info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.referee-section {
    padding: 1.25rem;
    border-radius: 0.5rem;
}
.referee-title {
    margin-bottom: 0.5rem;
    color: var(--bs-primary);
}
.referee-detail {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
}
/* Stats Card Styling */
.stat-card {
    position: relative;
    padding: 1rem;
    overflow: hidden;
    height: 100%;
    box-shadow: 0 2px 6px rgba(var(--bs-primary-rgb), 0.08);
    transition: all 0.2s ease;
}
.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(var(--bs-primary-rgb), 0.12);
}
.stat-card-body {
    position: relative;
    z-index: 1;
}
.stat-card-title {
    font-size: 1.75rem;
    font-weight: bold;
    margin-bottom: 0.25rem;
}
.stat-card-text {
    font-size: 0.85rem;
    margin-bottom: 0;
    opacity: 0.8;
}
.stat-card-icon {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    font-size: 1.75rem;
    opacity: 0.2;
}
/* Empty States */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    text-align: center;
    background-color: rgba(var(--bs-primary-rgb), 0.02);
    border-radius: 0.5rem;
    border: 1px dashed rgba(var(--bs-primary-rgb), 0.15);
}
.empty-state-icon {
    font-size: 3rem;
    color: rgba(var(--bs-primary-rgb), 0.3);
    margin-bottom: 1rem;
}
.empty-state-text {
    color: var(--bs-secondary);
    margin-bottom: 0.5rem;
}
.empty-state-subtext {
    color: var(--bs-secondary);
    font-size: 0.875rem;
    opacity: 0.7;
}
/* Button and Icon Styling */
.btn-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.25rem;
    height: 2.25rem;
    padding: 0;
}
.btn-icon-text {
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.btn-icon-text i {
    margin-right: 0.375rem;
}
/* Responsive adjustments */
@media (max-width: 992px) {
    .week-grid, .month-grid {
        display: flex;
        flex-direction: column;
    }
    .month-day {
        height: auto;
        min-height: 120px;
    }
    .day-column {
        margin-bottom: 1rem;
    }
    .match-info-grid {
        grid-template-columns: 1fr;
    }
    .match-teams-container {
        flex-direction: column;
        gap: 1rem;
    }
    .match-vs {
        padding: 0.5rem 0;
    }
    .card-header .d-flex {
        flex-wrap: wrap;
        gap: 0.5rem;
    }
}
/* Animation for day change */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
#scheduleContent {
    animation: fadeIn 0.3s ease-out;
}
/* Assignment Mode Styles */
.assignment-mode-active .referee-card {
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}
.assignment-mode-active .referee-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.assignment-mode-active .referee-card .assignment-mode-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(var(--bs-primary-rgb), 0.95);
    color: white;
    display: flex !important;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s ease;
    border-radius: 0.375rem;
}
.assignment-mode-active .referee-card:hover .assignment-mode-overlay {
    opacity: 1;
}
.selected-referee {
    border: 2px solid var(--bs-primary) !important;
    background: rgba(var(--bs-primary-rgb), 0.1) !important;
}
.selected-referee .assignment-mode-overlay {
    opacity: 1 !important;
    background: rgba(var(--bs-success-rgb), 0.95) !important;
}
/* Assignment Mode - Unassigned Match Highlighting */
.unassigned-match {
    border: 2px solid var(--bs-danger) !important;
    background: rgba(var(--bs-danger-rgb), 0.05) !important;
    animation: pulse-unassigned 2s infinite;
}
@keyframes pulse-unassigned {
    0% { box-shadow: 0 0 0 0 rgba(var(--bs-danger-rgb), 0.4); }
    70% { box-shadow: 0 0 0 8px rgba(var(--bs-danger-rgb), 0); }
    100% { box-shadow: 0 0 0 0 rgba(var(--bs-danger-rgb), 0); }
}
.assignable-match {
    cursor: pointer !important;
    border: 2px solid var(--bs-warning) !important;
    background: rgba(var(--bs-warning-rgb), 0.1) !important;
}
.assignable-match:hover {
    border-color: var(--bs-success) !important;
    background: rgba(var(--bs-success-rgb), 0.1) !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
/* Assignment Helper */
.assignment-helper {
    background: linear-gradient(135deg, rgba(var(--bs-primary-rgb), 0.1), rgba(var(--bs-info-rgb), 0.1));
    border: 1px solid rgba(var(--bs-primary-rgb), 0.2);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    backdrop-filter: blur(10px);
    animation: slideInDown 0.3s ease;
}
@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.assignment-helper-content h6 {
    font-size: 0.875rem;
    font-weight: 600;
}
.assignment-helper-content p {
    margin-bottom: 0.5rem;
    line-height: 1.4;
}
.assignment-stats {
    padding: 0.25rem 0.5rem;
    background: rgba(255,255,255,0.7);
    border-radius: 0.25rem;
    display: inline-block;
}
/* Assignment Mode Match Actions */
.assignment-hint {
    display: flex;
    align-items: center;
    font-weight: 500;
    animation: fadeInOut 2s infinite;
}
@keyframes fadeInOut {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}
.assigned-indicator {
    display: flex;
    align-items: center;
    font-weight: 500;
}
/* Assignment Mode Enhancements */
.assignment-mode-active .match-item {
    transition: all 0.2s ease;
}
.assignment-mode-active .unassigned-match .ref-badge {
    color: var(--bs-danger) !important;
    font-weight: 600;
}
/* Hide normal buttons in assignment mode */
.assignment-mode-active .assign-ref-btn,
.assignment-mode-active .view-match-btn,
.assignment-mode-active .edit-match-btn {
    display: none !important;
}
/* Show assignment hints only in assignment mode */
.assignment-hint,
.assigned-indicator {
    display: none;
}
.assignment-mode-active .assignment-hint,
.assignment-mode-active .assigned-indicator {
    display: flex !important;
}
</style>
{% endblock %}