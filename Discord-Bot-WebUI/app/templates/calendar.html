{% extends "base.html" %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Page Header -->
    <div class="card bg-primary mb-4">
        <div class="card-body p-3 position-relative overflow-hidden">
            <div class="row align-items-center">
                <div class="col">
                    <h2 class="text-white mb-0">Pub League Calendar</h2>
                    <p class="text-white-50 mb-0">View match schedule and manage referee assignments</p>
                </div>
                <div class="col-auto">
                    <div class="d-flex gap-2">
                        <button class="btn btn-light" id="refreshScheduleBtn">
                            <i class="ti ti-refresh me-1"></i> Refresh
                        </button>
                        {% if has_permission('assign_referee') %}
                        <button class="btn btn-light" id="toggleAssignmentMode">
                            <i class="ti ti-user-check me-1"></i> Assignment Mode
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content Column -->
        <div class="col-lg-8 col-xl-9 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Match Schedule</h5>
                    <div class="d-flex align-items-center">
                        <div class="input-group me-2" style="width: 250px;">
                            <span class="input-group-text"><i class="ti ti-search"></i></span>
                            <input type="text" class="form-control" id="matchSearchInput" placeholder="Search matches...">
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary btn-sm active" data-view="day" id="viewDayBtn">Day</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" data-view="week" id="viewWeekBtn">Week</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" data-view="month" id="viewMonthBtn">Month</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" data-view="list" id="viewListBtn">List</button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Custom Schedule View -->
                    <div id="scheduleContainer" class="p-3 h-100">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <button class="btn btn-sm btn-outline-primary" id="prevBtn">
                                <i class="ti ti-chevron-left"></i>
                            </button>
                            <h5 id="currentDateDisplay" class="mb-0">Sunday, April 7, 2024</h5>
                            <button class="btn btn-sm btn-outline-primary" id="nextBtn">
                                <i class="ti ti-chevron-right"></i>
                            </button>
                        </div>
                        
                        <!-- Schedule content will be loaded here dynamically -->
                        <div id="scheduleContent" class="schedule-content">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading schedule...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4 col-xl-3">
            <!-- Quick Stats Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Schedule Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="stat-card bg-label-primary">
                                <div class="stat-card-body">
                                    <h5 class="stat-card-title" id="totalMatches">0</h5>
                                    <p class="stat-card-text">Total Matches</p>
                                </div>
                                <div class="stat-card-icon">
                                    <i class="ti ti-soccer-field"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card bg-label-success">
                                <div class="stat-card-body">
                                    <h5 class="stat-card-title" id="assignedRefs">0</h5>
                                    <p class="stat-card-text">Assigned Refs</p>
                                </div>
                                <div class="stat-card-icon">
                                    <i class="ti ti-user-check"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card bg-label-danger">
                                <div class="stat-card-body">
                                    <h5 class="stat-card-title" id="unassignedMatches">0</h5>
                                    <p class="stat-card-text">Unassigned</p>
                                </div>
                                <div class="stat-card-icon">
                                    <i class="ti ti-user-x"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card bg-label-info">
                                <div class="stat-card-body">
                                    <h5 class="stat-card-title" id="totalReferees">0</h5>
                                    <p class="stat-card-text">Referees</p>
                                </div>
                                <div class="stat-card-icon">
                                    <i class="ti ti-whistle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Referee List Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0 d-flex justify-content-between">
                        <span>Available Referees</span>
                        <span class="badge bg-white text-primary rounded-pill" id="refCount">0</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="p-3">
                        <div class="input-group mb-3">
                            <span class="input-group-text"><i class="ti ti-search"></i></span>
                            <input type="text" class="form-control" id="refSearchInput" placeholder="Search referees...">
                        </div>
                    </div>
                    <div class="referee-list" id="refereeList">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading referees...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Referee Assignment Modal -->
<div class="modal fade" id="assignRefModal" tabindex="-1" aria-labelledby="assignRefModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="assignRefModalLabel">Referee Assignment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="assignRefForm">
                    <input type="hidden" id="matchId" name="match_id">
                    
                    <div class="match-detail-card mb-3">
                        <div class="match-detail-header">
                            <i class="ti ti-calendar-event me-2"></i>
                            <span id="matchDateTime">Date & Time</span>
                        </div>
                        <div class="match-detail-body">
                            <div class="match-teams mb-2">
                                <span id="homeTeam">Home Team</span>
                                <span class="vs">vs</span>
                                <span id="awayTeam">Away Team</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <p class="match-location mb-0">
                                    <i class="ti ti-map-pin me-1"></i>
                                    <span id="matchLocation">Location</span>
                                </p>
                                <span class="badge bg-primary" id="matchDivision">Division</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="currentRefereeSection">
                        <label class="form-label text-primary fw-semibold">Current Referee</label>
                        <div class="current-ref-container">
                            <div class="current-ref-status">
                                <i class="ti ti-user-circle current-ref-icon"></i>
                                <span id="currentRefereeName">Unassigned</span>
                            </div>
                            <button type="button" class="btn btn-outline-danger btn-sm" id="removeRefButton">
                                <i class="ti ti-user-x me-1"></i> Remove
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="refSelect" class="form-label text-primary fw-semibold">Assign Referee</label>
                        <select class="form-select" id="refSelect" name="ref_id" required>
                            <option value="" selected disabled>Choose a referee</option>
                        </select>
                        <div class="form-text">Select a referee from the list to assign to this match</div>
                    </div>
                    
                    <div id="assignRefFeedback" class="mt-2"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="assignRefForm" class="btn btn-primary" id="assignRefButton">
                    <i class="ti ti-user-check me-1"></i> Assign Referee
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Match Details Modal -->
<div class="modal fade" id="matchDetailsModal" tabindex="-1" aria-labelledby="matchDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="matchDetailsModalLabel">Match Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="match-detail-full">
                    <div class="match-teams-container">
                        <div class="team home-team">
                            <div class="team-logo">
                                <i class="ti ti-home text-primary" style="font-size: 1.5rem;"></i>
                            </div>
                            <div class="team-name" id="detailHomeTeam">Home Team</div>
                        </div>
                        <div class="match-vs">VS</div>
                        <div class="team away-team">
                            <div class="team-logo">
                                <i class="ti ti-plane-departure text-primary" style="font-size: 1.5rem;"></i>
                            </div>
                            <div class="team-name" id="detailAwayTeam">Away Team</div>
                        </div>
                    </div>
                    
                    <div class="match-info-grid">
                        <div class="match-info-item">
                            <i class="ti ti-calendar"></i>
                            <span id="detailMatchDate">Date</span>
                        </div>
                        <div class="match-info-item">
                            <i class="ti ti-clock"></i>
                            <span id="detailMatchTime">Time</span>
                        </div>
                        <div class="match-info-item">
                            <i class="ti ti-map-pin"></i>
                            <span id="detailMatchLocation">Location</span>
                        </div>
                        <div class="match-info-item">
                            <i class="ti ti-flag"></i>
                            <span id="detailMatchDivision">Division</span>
                        </div>
                    </div>
                    
                    <div class="referee-section">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="referee-title mb-0">Referee Assignment</h6>
                            <button type="button" class="btn btn-sm btn-primary" id="openAssignRefBtnTop">
                                <i class="ti ti-user-check me-1"></i> Assign Referee
                            </button>
                        </div>
                        <div class="referee-detail">
                            <i class="ti ti-user-circle referee-icon"></i>
                            <span id="detailMatchReferee">Unassigned</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="openAssignRefBtn">
                    <i class="ti ti-user-check me-1"></i> Assign Referee
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // State variables
    let isAssignmentMode = false;
    let allEvents = [];
    let currentViewEvents = [];
    let currentView = 'day';
    let currentDate = new Date();
    const isAdmin = true; // Always enable admin features
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    // Initialize tooltips
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(el => new bootstrap.Tooltip(el));
    
    // View toggle buttons
    const viewButtons = document.querySelectorAll('[data-view]');
    viewButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active button
            viewButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Switch view
            currentView = this.dataset.view;
            renderSchedule();
        });
    });
    
    // Toggle assignment mode
    const toggleAssignmentMode = document.getElementById('toggleAssignmentMode');
    if (toggleAssignmentMode) {
        toggleAssignmentMode.addEventListener('click', function() {
            isAssignmentMode = !isAssignmentMode;
            this.classList.toggle('btn-primary', isAssignmentMode);
            this.classList.toggle('btn-light', !isAssignmentMode);
            this.innerHTML = isAssignmentMode 
                ? '<i class="ti ti-user-check me-1"></i> Exit Assignment Mode' 
                : '<i class="ti ti-user-check me-1"></i> Assignment Mode';
                
            // Update the UI to show assignment controls
            document.querySelectorAll('.match-ref-controls').forEach(el => {
                el.style.display = isAssignmentMode ? 'flex' : 'none';
            });
        });
    }
    
    // Navigation buttons
    document.getElementById('prevBtn').addEventListener('click', () => {
        navigateDate(-1);
    });
    
    document.getElementById('nextBtn').addEventListener('click', () => {
        navigateDate(1);
    });
    
    function navigateDate(direction) {
        switch(currentView) {
            case 'day':
                currentDate.setDate(currentDate.getDate() + direction);
                break;
            case 'week':
                currentDate.setDate(currentDate.getDate() + (direction * 7));
                break;
            case 'month':
                currentDate.setMonth(currentDate.getMonth() + direction);
                break;
            default:
                currentDate.setDate(currentDate.getDate() + direction);
        }
        
        updateDateDisplay();
        renderSchedule();
    }
    
    function updateDateDisplay() {
        const dateDisplay = document.getElementById('currentDateDisplay');
        
        if (currentView === 'day') {
            dateDisplay.textContent = currentDate.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
        } else if (currentView === 'week') {
            // Get first and last day of week
            const firstDay = new Date(currentDate);
            firstDay.setDate(currentDate.getDate() - currentDate.getDay());
            
            const lastDay = new Date(firstDay);
            lastDay.setDate(firstDay.getDate() + 6);
            
            dateDisplay.textContent = `${firstDay.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})} - ${lastDay.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
        } else if (currentView === 'month') {
            dateDisplay.textContent = currentDate.toLocaleDateString('en-US', {
                month: 'long',
                year: 'numeric'
            });
        } else {
            dateDisplay.textContent = 'All Matches';
        }
    }
    
    // Search functionality for referees
    const refSearchInput = document.getElementById('refSearchInput');
    if (refSearchInput) {
        refSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const refItems = document.querySelectorAll('.referee-item');
            
            refItems.forEach(item => {
                const refName = item.querySelector('.referee-name')?.textContent.toLowerCase() || '';
                if (refName.includes(searchTerm) || searchTerm === '') {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
    // Search functionality for matches
    const matchSearchInput = document.getElementById('matchSearchInput');
    if (matchSearchInput) {
        matchSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            // Filter displayed matches based on view type
            if (currentView === 'list') {
                const matchItems = document.querySelectorAll('.match-item');
                matchItems.forEach(item => {
                    const matchText = item.textContent.toLowerCase();
                    if (matchText.includes(searchTerm) || searchTerm === '') {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            } else {
                // Re-render with filtered events
                renderSchedule(searchTerm);
            }
        });
    }
    
    // Refresh button
    const refreshButton = document.getElementById('refreshScheduleBtn');
    if (refreshButton) {
        refreshButton.addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="ti ti-loader ti-spin me-1"></i> Refreshing';
            
            Promise.all([
                loadScheduleEvents(),
                fetchAvailableReferees()
            ]).then(() => {
                this.disabled = false;
                this.innerHTML = '<i class="ti ti-refresh me-1"></i> Refresh';
                showToast('success', 'Schedule refreshed successfully');
            }).catch(error => {
                console.error('Error refreshing data:', error);
                this.disabled = false;
                this.innerHTML = '<i class="ti ti-refresh me-1"></i> Refresh';
                showToast('danger', 'Failed to refresh data');
            });
        });
    }
    
    // Load events and initialize the view
    async function loadScheduleEvents() {
        try {
            const response = await fetch('/calendar/events');
            if (!response.ok) throw new Error('Failed to fetch events.');
            
            const data = await response.json();
            allEvents = data.events.map(event => {
                return {
                    ...event,
                    date: new Date(event.start),
                    // Parse more data needed for rendering
                    homeTeam: event.teams.split(' vs ')[0],
                    awayTeam: event.teams.split(' vs ')[1],
                    location: event.description.replace('Location: ', ''),
                    time: new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})
                };
            });
            
            // Update stats
            updateQuickStats(data.stats);
            
            // Render the schedule with the loaded events
            renderSchedule();
            
            return data;
        } catch (error) {
            console.error('Error loading events:', error);
            document.getElementById('scheduleContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="ti ti-alert-circle me-2"></i>
                    Failed to load schedule. Please try refreshing.
                </div>
            `;
            throw error;
        }
    }
    
    async function fetchAvailableReferees() {
        try {
            // Get start and end dates based on current view
            let startDate = new Date(currentDate);
            let endDate = new Date(currentDate);
            
            if (currentView === 'week') {
                // Start of week (Sunday)
                startDate.setDate(currentDate.getDate() - currentDate.getDay());
                // End of week (Saturday)
                endDate.setDate(startDate.getDate() + 6);
            } else if (currentView === 'month') {
                // Start of month
                startDate.setDate(1);
                // End of month
                endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            } else if (currentView === 'list') {
                // Use a broader date range for list view
                startDate = new Date();
                endDate = new Date();
                endDate.setMonth(endDate.getMonth() + 3);
            }
            
            const response = await fetch(`/calendar/available_refs?start_date=${startDate.toISOString()}&end_date=${endDate.toISOString()}`);
            if (!response.ok) throw new Error('Failed to fetch referees.');
            
            const referees = await response.json();
            renderRefereeList(referees);
            
            // Update total count
            document.getElementById('totalReferees').textContent = referees.length;
            document.getElementById('refCount').textContent = referees.length;
            
            return referees;
        } catch (error) {
            console.error('Error fetching referees:', error);
            document.getElementById('refereeList').innerHTML = `
                <div class="alert alert-danger m-3">
                    <i class="ti ti-alert-circle me-2"></i>
                    Failed to load referees.
                </div>
            `;
            throw error;
        }
    }
    
    function renderRefereeList(referees) {
        const refList = document.getElementById('refereeList');
        refList.innerHTML = '';
        
        if (referees.length === 0) {
            refList.innerHTML = `
                <div class="text-center py-4">
                    <i class="ti ti-user-off mb-2" style="font-size: 2rem; opacity: 0.5;"></i>
                    <p class="text-muted">No referees available</p>
                </div>
            `;
            return;
        }
        
        const refListContainer = document.createElement('div');
        refListContainer.className = 'p-2';
        
        // Sort referees by assignments (least to most)
        referees.sort((a, b) => a.matches_assigned_in_week - b.matches_assigned_in_week);
        
        referees.forEach(ref => {
            const refItem = document.createElement('div');
            refItem.className = 'referee-item';
            
            // Highlight refs with no assignments this week
            const highlightClass = ref.matches_assigned_in_week === 0 ? 'referee-available' : '';
            
            refItem.innerHTML = `
                <div class="card mb-2 ${highlightClass}">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="avatar avatar-sm me-2 bg-label-primary">
                                    <i class="ti ti-user"></i>
                                </div>
                                <div>
                                    <span class="referee-name fw-semibold">${ref.name}</span>
                                    ${ref.matches_assigned_in_week > 0 
                                        ? `<span class="badge bg-warning ms-2" title="Assigned this week">${ref.matches_assigned_in_week}</span>` 
                                        : '<span class="badge bg-success ms-2">Available</span>'}
                                </div>
                            </div>
                            <div>
                                <span class="badge bg-primary rounded-pill" title="Total matches assigned">
                                    ${ref.total_matches_assigned}
                                </span>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar" role="progressbar" 
                                style="width: ${Math.min(ref.matches_assigned_in_week * 33, 100)}%;" 
                                aria-valuenow="${ref.matches_assigned_in_week}" 
                                aria-valuemin="0" 
                                aria-valuemax="3">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            refListContainer.appendChild(refItem);
        });
        
        refList.appendChild(refListContainer);
    }
    
    function updateQuickStats(stats) {
        document.getElementById('totalMatches').textContent = stats.totalMatches;
        document.getElementById('assignedRefs').textContent = stats.assignedRefs;
        document.getElementById('unassignedMatches').textContent = stats.unassignedMatches;
    }
    
    function renderSchedule(searchTerm = '') {
        const scheduleContent = document.getElementById('scheduleContent');
        
        // Update date display
        updateDateDisplay();
        
        // Filter events based on current view and search term
        currentViewEvents = filterEventsByView();
        
        if (searchTerm) {
            currentViewEvents = currentViewEvents.filter(event => {
                const matchText = `${event.homeTeam} ${event.awayTeam} ${event.location} ${event.division} ${event.ref}`.toLowerCase();
                return matchText.includes(searchTerm.toLowerCase());
            });
        }
        
        // Render based on current view
        if (currentViewEvents.length === 0) {
            scheduleContent.innerHTML = `
                <div class="text-center py-5">
                    <i class="ti ti-calendar-off mb-3" style="font-size: 3rem; opacity: 0.5;"></i>
                    <h5 class="text-muted">No matches scheduled</h5>
                    <p class="text-muted">Try a different date or view</p>
                </div>
            `;
            return;
        }
        
        switch(currentView) {
            case 'day':
                renderDayView();
                break;
            case 'week':
                renderWeekView();
                break;
            case 'month':
                renderMonthView();
                break;
            case 'list':
                renderListView();
                break;
            default:
                renderDayView();
        }
    }
    
    function filterEventsByView() {
        if (currentView === 'day') {
            // Filter events for the selected day
            return allEvents.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate.toDateString() === currentDate.toDateString();
            });
        } else if (currentView === 'week') {
            // Filter events for the selected week
            const weekStart = new Date(currentDate);
            weekStart.setDate(currentDate.getDate() - currentDate.getDay()); // Start from Sunday
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6); // End on Saturday
            
            return allEvents.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate >= weekStart && eventDate <= weekEnd;
            });
        } else if (currentView === 'month') {
            // Filter events for the selected month
            return allEvents.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate.getMonth() === currentDate.getMonth() && 
                       eventDate.getFullYear() === currentDate.getFullYear();
            });
        } else {
            // List view - show all events, sorted by date
            return [...allEvents].sort((a, b) => new Date(a.start) - new Date(b.start));
        }
    }
    
    function renderDayView() {
        const scheduleContent = document.getElementById('scheduleContent');
        
        // Sort events by time
        const sortedEvents = [...currentViewEvents].sort((a, b) => {
            return new Date(a.start).getTime() - new Date(b.start).getTime();
        });
        
        // Group events by time slots
        const timeSlots = {};
        sortedEvents.forEach(event => {
            const time = new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            if (!timeSlots[time]) {
                timeSlots[time] = [];
            }
            timeSlots[time].push(event);
        });
        
        // Create timeline view
        let html = '<div class="day-schedule">';
        
        for (const time in timeSlots) {
            html += `
                <div class="time-slot">
                    <div class="time-label">${time}</div>
                    <div class="time-events">
            `;
            
            timeSlots[time].forEach(event => {
                const isAssigned = event.ref !== 'Unassigned';
                
                html += `
                    <div class="match-item card mb-3" data-event-id="${event.id}">
                        <div class="card-body p-3">
                            <div class="match-header d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-${event.division === 'Premier' ? 'primary' : 'success'} me-2">${event.division}</span>
                                <small class="text-muted"><i class="ti ti-map-pin me-1"></i>${event.location}</small>
                            </div>
                            
                            <div class="match-teams mb-2">
                                <div class="home-team">${event.homeTeam}</div>
                                <div class="vs">vs</div>
                                <div class="away-team">${event.awayTeam}</div>
                            </div>
                            
                            <div class="match-footer d-flex justify-content-between align-items-center">
                                <div class="ref-badge ${isAssigned ? 'ref-assigned' : 'ref-unassigned'}">
                                    <i class="ti ti-user-circle me-1"></i>
                                    <span>${event.ref}</span>
                                </div>
                                
                                <div class="match-actions">
                                    <button class="btn btn-sm btn-outline-secondary view-match-btn">
                                        <i class="ti ti-eye me-1"></i>View
                                    </button>
                                    ${isAdmin ? `
                                    <button class="btn btn-sm ${isAssigned ? 'btn-outline-success' : 'btn-primary'} assign-ref-btn" title="${isAssigned ? 'Change Referee' : 'Assign Referee'}">
                                        <i class="ti ti-user-check me-1"></i>${isAssigned ? 'Change' : 'Assign'}
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
        }
        
        html += '</div>';
        
        scheduleContent.innerHTML = html;
        
        // Add event listeners to the match items
        addMatchItemEventListeners();
    }
    
    function renderWeekView() {
        const scheduleContent = document.getElementById('scheduleContent');
        
        // Get the start date of the week (Sunday)
        const weekStart = new Date(currentDate);
        weekStart.setDate(currentDate.getDate() - currentDate.getDay());
        
        // Create an array of days in the week
        const weekDays = [];
        for (let i = 0; i < 7; i++) {
            const day = new Date(weekStart);
            day.setDate(weekStart.getDate() + i);
            weekDays.push(day);
        }
        
        let html = '<div class="week-schedule">';
        
        // Create the weekday headers
        html += '<div class="week-header">';
        weekDays.forEach(day => {
            const isToday = day.toDateString() === new Date().toDateString();
            html += `
                <div class="day-header ${isToday ? 'today' : ''}">
                    <div class="day-name">${day.toLocaleDateString('en-US', {weekday: 'short'})}</div>
                    <div class="day-date">${day.getDate()}</div>
                </div>
            `;
        });
        html += '</div>';
        
        // Create the week grid
        html += '<div class="week-grid">';
        
        weekDays.forEach(day => {
            // Find events for this day
            const dayEvents = currentViewEvents.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate.toDateString() === day.toDateString();
            });
            
            // Sort events by time
            dayEvents.sort((a, b) => new Date(a.start).getTime() - new Date(b.start).getTime());
            
            // Create day column
            const isToday = day.toDateString() === new Date().toDateString();
            html += `<div class="day-column ${isToday ? 'today' : ''}" data-date="${day.toDateString()}">`;
            
            if (dayEvents.length === 0) {
                html += `
                    <div class="day-empty">
                        <div class="text-center text-muted">
                            <i class="ti ti-calendar-off"></i>
                            <small>No matches</small>
                        </div>
                    </div>
                `;
            } else {
                dayEvents.forEach(event => {
                    const isAssigned = event.ref !== 'Unassigned';
                    
                    html += `
                        <div class="match-item card mb-2" data-event-id="${event.id}">
                            <div class="card-body p-2">
                                <div class="match-time text-muted mb-1">
                                    <i class="ti ti-clock me-1"></i>${event.time}
                                </div>
                                
                                <div class="match-teams-compact mb-1">
                                    <span class="badge bg-${event.division === 'Premier' ? 'primary' : 'success'} me-1">${event.division}</span>
                                    <small>${event.homeTeam} vs ${event.awayTeam}</small>
                                </div>
                                
                                <div class="match-footer d-flex justify-content-between align-items-center">
                                    <div class="ref-badge-small ${isAssigned ? 'ref-assigned' : 'ref-unassigned'}">
                                        <i class="ti ti-user-circle me-1"></i>
                                        <small>${event.ref}</small>
                                    </div>
                                    
                                    <div class="match-actions">
                                        <button class="btn btn-sm btn-icon btn-outline-secondary view-match-btn" title="View Details">
                                            <i class="ti ti-eye"></i>
                                        </button>
                                        ${isAdmin ? `
                                        <button class="btn btn-sm btn-icon ${isAssigned ? 'btn-outline-success' : 'btn-primary'} assign-ref-btn" title="${isAssigned ? 'Change Referee' : 'Assign Referee'}">
                                            <i class="ti ti-user-check"></i>
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
        });
        
        html += '</div></div>';
        
        scheduleContent.innerHTML = html;
        
        // Add event listeners to the match items
        addMatchItemEventListeners();
    }
    
    function renderMonthView() {
        const scheduleContent = document.getElementById('scheduleContent');
        
        // Get first day of month
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
        
        // Get number of days in month
        const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        // Calculate days from previous month to show
        const prevMonthDays = startingDayOfWeek;
        
        // Calculate days from next month to show (to complete the grid)
        const totalCells = Math.ceil((prevMonthDays + daysInMonth) / 7) * 7;
        const nextMonthDays = totalCells - (prevMonthDays + daysInMonth);
        
        // Create month view
        let html = `<div class="month-schedule">`;
        
        // Create weekday headers
        const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        html += `<div class="month-weekdays">`;
        weekdays.forEach(day => {
            html += `<div class="month-weekday">${day}</div>`;
        });
        html += `</div>`;
        
        // Create month grid
        html += `<div class="month-grid">`;
        
        // Previous month days
        const prevMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0);
        const prevMonthLastDay = prevMonth.getDate();
        
        for (let i = prevMonthDays - 1; i >= 0; i--) {
            const day = prevMonthLastDay - i;
            html += `
                <div class="month-day prev-month">
                    <div class="month-day-header">${day}</div>
                    <div class="month-day-content"></div>
                </div>
            `;
        }
        
        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            const isToday = date.toDateString() === new Date().toDateString();
            
            // Find events for this day
            const dayEvents = currentViewEvents.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate.toDateString() === date.toDateString();
            });
            
            html += `
                <div class="month-day ${isToday ? 'today' : ''}">
                    <div class="month-day-header">${day}</div>
                    <div class="month-day-content">
            `;
            
            if (dayEvents.length > 0) {
                // Sort events by time
                dayEvents.sort((a, b) => new Date(a.start).getTime() - new Date(b.start).getTime());
                
                // Show up to 3 events with a "+X more" indicator if needed
                const displayEvents = dayEvents.slice(0, 3);
                
                displayEvents.forEach(event => {
                    const isAssigned = event.ref !== 'Unassigned';
                    html += `
                        <div class="month-event ${event.division === 'Premier' ? 'premier' : 'classic'}" data-event-id="${event.id}">
                            <div class="month-event-time">${event.time}</div>
                            <div class="month-event-title">${event.homeTeam} vs ${event.awayTeam}</div>
                            <div class="month-event-ref ${isAssigned ? 'assigned' : 'unassigned'}" title="${isAssigned ? 'Referee: ' + event.ref : 'No referee assigned'}">
                                <i class="ti ti-user-circle"></i>
                                ${isAdmin && !isAssigned ? '<i class="ti ti-plus ref-add-icon" title="Assign Referee"></i>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                if (dayEvents.length > 3) {
                    html += `
                        <div class="month-more-events">
                            +${dayEvents.length - 3} more matches
                        </div>
                    `;
                }
            }
            
            html += `</div></div>`;
        }
        
        // Next month days
        for (let day = 1; day <= nextMonthDays; day++) {
            html += `
                <div class="month-day next-month">
                    <div class="month-day-header">${day}</div>
                    <div class="month-day-content"></div>
                </div>
            `;
        }
        
        html += `</div></div>`;
        
        scheduleContent.innerHTML = html;
        
        // Add event listeners to month events
        document.querySelectorAll('.month-event').forEach(item => {
            item.addEventListener('click', function() {
                const eventId = this.dataset.eventId;
                const event = allEvents.find(e => e.id == eventId);
                
                if (event) {
                    if (isAssignmentMode && isAdmin) {
                        showAssignRefModal(event);
                    } else {
                        showMatchDetailsModal(event);
                    }
                }
            });
        });
        
        // Add event listener to "more events" indicators
        document.querySelectorAll('.month-more-events').forEach(item => {
            item.addEventListener('click', function() {
                // Get the day from the parent month-day element
                const dayElement = this.closest('.month-day');
                const dayNumber = dayElement.querySelector('.month-day-header').textContent;
                
                // Set current date to this day
                currentDate.setDate(parseInt(dayNumber));
                currentView = 'day';
                
                // Update view buttons
                viewButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.view === 'day') {
                        btn.classList.add('active');
                    }
                });
                
                // Render the day view
                renderSchedule();
            });
        });
    }
    
    function renderListView() {
        const scheduleContent = document.getElementById('scheduleContent');
        
        // Sort all events by date
        const sortedEvents = [...currentViewEvents].sort((a, b) => {
            return new Date(a.start).getTime() - new Date(b.start).getTime();
        });
        
        // Group events by date
        const eventsByDate = {};
        sortedEvents.forEach(event => {
            const dateKey = new Date(event.start).toDateString();
            if (!eventsByDate[dateKey]) {
                eventsByDate[dateKey] = [];
            }
            eventsByDate[dateKey].push(event);
        });
        
        // Create list view
        let html = '<div class="list-schedule">';
        
        for (const dateKey in eventsByDate) {
            const date = new Date(dateKey);
            const isToday = dateKey === new Date().toDateString();
            
            html += `
                <div class="date-group ${isToday ? 'today' : ''}">
                    <div class="date-header">
                        <i class="ti ti-calendar-event me-2"></i>
                        ${date.toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'})}
                    </div>
                    <div class="date-matches">
            `;
            
            eventsByDate[dateKey].forEach(event => {
                const isAssigned = event.ref !== 'Unassigned';
                
                html += `
                    <div class="match-item card mb-3" data-event-id="${event.id}">
                        <div class="card-body p-3">
                            <div class="match-header d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <span class="badge bg-${event.division === 'Premier' ? 'primary' : 'success'} me-2">${event.division}</span>
                                    <span class="match-time text-muted">
                                        <i class="ti ti-clock me-1"></i>${event.time}
                                    </span>
                                </div>
                                <small class="text-muted">
                                    <i class="ti ti-map-pin me-1"></i>${event.location}
                                </small>
                            </div>
                            
                            <div class="match-teams mb-2">
                                <div class="home-team">${event.homeTeam}</div>
                                <div class="vs">vs</div>
                                <div class="away-team">${event.awayTeam}</div>
                            </div>
                            
                            <div class="match-footer d-flex justify-content-between align-items-center">
                                <div class="ref-badge ${isAssigned ? 'ref-assigned' : 'ref-unassigned'}">
                                    <i class="ti ti-user-circle me-1"></i>
                                    <span>${event.ref}</span>
                                </div>
                                
                                <div class="match-actions">
                                    <button class="btn btn-sm btn-outline-secondary view-match-btn">
                                        <i class="ti ti-eye me-1"></i>View
                                    </button>
                                    ${isAdmin ? `
                                    <button class="btn btn-sm ${isAssigned ? 'btn-outline-success' : 'btn-primary'} assign-ref-btn" title="${isAssigned ? 'Change Referee' : 'Assign Referee'}">
                                        <i class="ti ti-user-check me-1"></i>${isAssigned ? 'Change' : 'Assign'}
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
        }
        
        html += '</div>';
        
        scheduleContent.innerHTML = html;
        
        // Add event listeners to the match items
        addMatchItemEventListeners();
    }
    
    function addMatchItemEventListeners() {
        // Add event listeners for match items
        document.querySelectorAll('.match-item').forEach(item => {
            // Make the whole card clickable
            item.addEventListener('click', function(e) {
                // Only trigger if not clicking a button
                if (!e.target.closest('button')) {
                    const eventId = this.dataset.eventId;
                    const event = allEvents.find(evt => evt.id == eventId);
                    
                    if (event) {
                        showMatchDetailsModal(event);
                    }
                }
            });
            
            // View button
            const viewBtn = item.querySelector('.view-match-btn');
            if (viewBtn) {
                viewBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const eventId = item.dataset.eventId;
                    const event = allEvents.find(evt => evt.id == eventId);
                    
                    if (event) {
                        showMatchDetailsModal(event);
                    }
                });
            }
            
            // Assign ref button
            const assignBtn = item.querySelector('.assign-ref-btn');
            if (assignBtn) {
                assignBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const eventId = item.dataset.eventId;
                    const event = allEvents.find(evt => evt.id == eventId);
                    
                    if (event) {
                        showAssignRefModal(event);
                    }
                });
            }
        });
    }
    
    // Match details modal functions
    function showMatchDetailsModal(event) {
        const modal = document.getElementById('matchDetailsModal');
        if (!modal) return;
        
        // Populate modal fields
        document.getElementById('detailHomeTeam').textContent = event.homeTeam;
        document.getElementById('detailAwayTeam').textContent = event.awayTeam;
        document.getElementById('detailMatchDate').textContent = event.date.toLocaleDateString('en-US', {
            weekday: 'long', 
            month: 'long', 
            day: 'numeric'
        });
        document.getElementById('detailMatchTime').textContent = event.time;
        document.getElementById('detailMatchLocation').textContent = event.location;
        document.getElementById('detailMatchDivision').textContent = event.division;
        document.getElementById('detailMatchReferee').textContent = event.ref;
        
        // Set up the assign referee buttons (both top and bottom button)
        const openAssignRefBtn = document.getElementById('openAssignRefBtn');
        const openAssignRefBtnTop = document.getElementById('openAssignRefBtnTop');
        
        if (openAssignRefBtn) {
            openAssignRefBtn.onclick = function() {
                bootstrap.Modal.getInstance(modal).hide();
                setTimeout(() => showAssignRefModal(event), 500);
            };
        }
        
        if (openAssignRefBtnTop) {
            openAssignRefBtnTop.onclick = function() {
                bootstrap.Modal.getInstance(modal).hide();
                setTimeout(() => showAssignRefModal(event), 500);
            };
        }
        
        // Show modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }
    
    // Referee assignment modal functions
    function showAssignRefModal(event) {
        const modal = document.getElementById('assignRefModal');
        if (!modal) return;
        
        // Populate modal fields
        document.getElementById('matchId').value = event.id;
        document.getElementById('homeTeam').textContent = event.homeTeam;
        document.getElementById('awayTeam').textContent = event.awayTeam;
        document.getElementById('matchDateTime').textContent = `${event.date.toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric'
        })} at ${event.time}`;
        document.getElementById('matchLocation').textContent = event.location;
        document.getElementById('matchDivision').textContent = event.division;
        
        // Set current referee status
        if (event.ref !== 'Unassigned') {
            document.getElementById('currentRefereeSection').style.display = 'block';
            document.getElementById('currentRefereeName').textContent = event.ref;
            document.getElementById('removeRefButton').style.display = 'inline-block';
        } else {
            document.getElementById('currentRefereeSection').style.display = 'none';
            document.getElementById('removeRefButton').style.display = 'none';
        }
        
        // Fetch available referees for the match
        fetchRefereesForMatch(event.id);
        
        // Clear previous feedback
        document.getElementById('assignRefFeedback').innerHTML = '';
        
        // Show modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }
    
    async function fetchRefereesForMatch(matchId) {
        try {
            const response = await fetch(`/calendar/refs?match_id=${matchId}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to fetch referees for this match.');
            }
            
            const referees = await response.json();
            const refSelect = document.getElementById('refSelect');
            refSelect.innerHTML = '<option value="" selected disabled>Choose a referee</option>';
            
            // Add an explanatory note above the dropdown
            const notesContainer = document.createElement('div');
            notesContainer.className = 'referee-notes mb-2';
            notesContainer.innerHTML = `
                <div class="alert alert-info p-2">
                    <p class="mb-1 small"><i class="ti ti-info-circle me-1"></i> <strong>Notes:</strong></p>
                    <ul class="mb-0 ps-3 small">
                        <li>Referees who play on either team are automatically excluded</li>
                        <li>Referees already assigned to other matches at this time are automatically excluded</li>
                        <li>Referees with fewer assignments are listed first</li>
                    </ul>
                </div>
            `;
            refSelect.parentNode.insertBefore(notesContainer, refSelect);
            
            if (referees.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "No eligible referees available";
                option.disabled = true;
                refSelect.appendChild(option);
                
                document.getElementById('assignRefButton').disabled = true;
                
                // Add explanation about why there might be no referees
                displayModalFeedback('assignRefFeedback', 
                    'No eligible referees available. This may be because all referees play on one of the teams in this match or are already assigned to other matches at this time.', 
                    'warning');
            } else {
                // Sort referees by the number of matches they're currently assigned
                referees.sort((a, b) => a.matches_assigned_in_week - b.matches_assigned_in_week);
                
                // Add optgroup for available and assigned referees
                const availableGroup = document.createElement('optgroup');
                availableGroup.label = "Available Referees (0 assignments this week)";
                
                const assignedGroup = document.createElement('optgroup');
                assignedGroup.label = "Assigned Referees (with other assignments)";
                
                let hasAvailable = false;
                let hasAssigned = false;
                
                referees.forEach(ref => {
                    const option = document.createElement('option');
                    option.value = ref.id;
                    
                    let assignmentLabel = '';
                    if (ref.matches_assigned_in_week > 0) {
                        assignmentLabel = `(${ref.matches_assigned_in_week} assignment${ref.matches_assigned_in_week > 1 ? 's' : ''} this week)`;
                        option.dataset.assigned = 'true';
                        assignedGroup.appendChild(option);
                        hasAssigned = true;
                    } else {
                        assignmentLabel = '(Available)';
                        option.classList.add('text-success', 'fw-bold');
                        availableGroup.appendChild(option);
                        hasAvailable = true;
                    }
                    
                    option.textContent = `${ref.name} ${assignmentLabel}`;
                });
                
                // Add the groups to the select
                if (hasAvailable) {
                    refSelect.appendChild(availableGroup);
                }
                
                if (hasAssigned) {
                    refSelect.appendChild(assignedGroup);
                }
                
                refSelect.disabled = false;
                document.getElementById('assignRefButton').disabled = false;
            }
        } catch (error) {
            console.error('Error fetching referees:', error);
            displayModalFeedback('assignRefFeedback', `Error fetching referees: ${error.message}`, 'danger');
        }
    }
    
    // Assign referee form submission
    document.getElementById('assignRefForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const matchId = document.getElementById('matchId').value;
        const refId = document.getElementById('refSelect').value;
        
        if (!refId) {
            displayModalFeedback('assignRefFeedback', 'Please select a referee.', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/calendar/assign_ref', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ match_id: matchId, ref_id: refId })
            });
            
            const result = await response.json();
            
            if (!response.ok || result.error) {
                const errorMsg = result.error || 'Failed to assign referee.';
                displayModalFeedback('assignRefFeedback', errorMsg, 'danger');
                return;
            }
            
            displayModalFeedback('assignRefFeedback', 'Referee assigned successfully!', 'success');
            
            // Refresh data after a short delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('assignRefModal')).hide();
                
                // Reload both schedule and refs
                Promise.all([
                    loadScheduleEvents(),
                    fetchAvailableReferees()
                ]).then(() => {
                    showToast('success', 'Referee assigned successfully');
                });
            }, 1000);
        } catch (error) {
            console.error('Error assigning referee:', error);
            displayModalFeedback('assignRefFeedback', 'Error assigning referee.', 'danger');
        }
    });
    
    // Remove referee button click
    document.getElementById('removeRefButton').addEventListener('click', async function() {
        const matchId = document.getElementById('matchId').value;
        
        if (!confirm('Are you sure you want to remove the referee from this match?')) {
            return;
        }
        
        try {
            const response = await fetch('/calendar/remove_ref', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ match_id: matchId })
            });
            
            const result = await response.json();
            
            if (!response.ok || result.error) {
                const errorMsg = result.error || 'Failed to remove referee.';
                displayModalFeedback('assignRefFeedback', errorMsg, 'danger');
                return;
            }
            
            displayModalFeedback('assignRefFeedback', 'Referee removed successfully!', 'success');
            
            // Refresh data after a short delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('assignRefModal')).hide();
                
                // Reload both schedule and refs
                Promise.all([
                    loadScheduleEvents(),
                    fetchAvailableReferees()
                ]).then(() => {
                    showToast('success', 'Referee removed successfully');
                });
            }, 1000);
        } catch (error) {
            console.error('Error removing referee:', error);
            displayModalFeedback('assignRefFeedback', 'Error removing referee.', 'danger');
        }
    });
    
    function displayModalFeedback(elementId, message, type) {
        const feedbackEl = document.getElementById(elementId);
        feedbackEl.innerHTML = `<div class="alert alert-${type} p-2 m-0" role="alert">${message}</div>`;
    }
    
    function showToast(type, message) {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center border-0 bg-${type} text-white" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        
        if (toastElement) {
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 3000
            });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', function() {
                this.remove();
            });
        }
    }
    
    // Initialize the page
    loadScheduleEvents();
    fetchAvailableReferees();
});
</script>
{% endblock %}

{% block custom_css %}
<style>
/* Schedule Views */
.schedule-content {
    min-height: 500px;
}

/* Day View - Timeline style */
.day-schedule {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.time-slot {
    display: flex;
    gap: 1rem;
}

.time-label {
    flex: 0 0 80px;
    padding: 0.5rem;
    font-weight: bold;
    text-align: right;
    color: var(--bs-primary);
    border-right: 2px solid rgba(var(--bs-primary-rgb), 0.2);
}

.time-events {
    flex: 1;
    min-width: 0;
    padding-top: 0.5rem;
}

/* Week View */
.week-schedule {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.week-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    padding-bottom: 0.5rem;
}

.day-header {
    text-align: center;
    padding: 0.5rem;
    border-radius: 0.25rem;
}

.day-header.today {
    background-color: rgba(var(--bs-primary-rgb), 0.1);
    font-weight: bold;
}

.day-name {
    font-weight: bold;
}

.day-date {
    font-size: 1.25rem;
}

.week-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
    min-height: 500px;
}

.day-column {
    padding: 0.5rem;
    border-radius: 0.25rem;
    background-color: rgba(0,0,0,0.02);
    overflow-y: auto;
    max-height: 500px;
}

.day-column.today {
    background-color: rgba(var(--bs-primary-rgb), 0.05);
    border: 1px dashed rgba(var(--bs-primary-rgb), 0.3);
}

.day-empty {
    display: flex;
    height: 100%;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    gap: 0.5rem;
    opacity: 0.5;
}

/* Month View */
.month-schedule {
    display: flex;
    flex-direction: column;
}

.month-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
    text-align: center;
    font-weight: bold;
    color: var(--bs-primary);
    margin-bottom: 0.5rem;
}

.month-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
}

.month-day {
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 0.25rem;
    height: 120px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.month-day.today {
    border: 2px solid var(--bs-primary);
    background-color: rgba(var(--bs-primary-rgb), 0.05);
}

.month-day.prev-month, .month-day.next-month {
    opacity: 0.5;
    background-color: rgba(0,0,0,0.03);
}

.month-day-header {
    padding: 0.25rem;
    text-align: center;
    font-weight: bold;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    background-color: rgba(0,0,0,0.02);
}

.month-day-content {
    flex: 1;
    overflow-y: auto;
    padding: 0.25rem;
}

.month-event {
    padding: 0.25rem;
    border-radius: 0.25rem;
    margin-bottom: 0.25rem;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    background: rgba(var(--bs-primary-rgb), 0.1);
    border-left: 3px solid var(--bs-primary);
}

.month-event.premier {
    background: rgba(var(--bs-primary-rgb), 0.1);
    border-left: 3px solid var(--bs-primary);
}

.month-event.classic {
    background: rgba(var(--bs-success-rgb), 0.1);
    border-left: 3px solid var(--bs-success);
}

.month-event-time {
    font-weight: bold;
    margin-right: 0.5rem;
    flex-shrink: 0;
}

.month-event-title {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.month-event-ref {
    margin-left: 0.5rem;
    flex-shrink: 0;
    position: relative;
}

.month-event-ref.assigned {
    color: var(--bs-success);
}

.month-event-ref.unassigned {
    color: var(--bs-danger);
}

.ref-add-icon {
    font-size: 0.6rem;
    position: absolute;
    bottom: -1px;
    right: -1px;
    background-color: var(--bs-primary);
    color: white;
    border-radius: 50%;
    padding: 1px;
}

.month-more-events {
    text-align: center;
    font-size: 0.8rem;
    font-weight: bold;
    color: var(--bs-primary);
    padding: 0.25rem;
    cursor: pointer;
    background-color: rgba(var(--bs-primary-rgb), 0.05);
    border-radius: 0.25rem;
}

.month-more-events:hover {
    background-color: rgba(var(--bs-primary-rgb), 0.1);
}

/* List View */
.list-schedule {
    display: flex;
    flex-direction: column;
}

.date-group {
    margin-bottom: 1.5rem;
}

.date-group.today .date-header {
    background-color: rgba(var(--bs-primary-rgb), 0.1);
    border-left: 4px solid var(--bs-primary);
}

.date-header {
    font-weight: bold;
    padding: 0.5rem;
    margin-bottom: 1rem;
    color: var(--bs-primary);
    border-bottom: 1px solid rgba(var(--bs-primary-rgb), 0.2);
}

.date-matches {
    padding-left: 1rem;
}

/* Match Item Styling */
.match-item {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid rgba(0,0,0,0.1);
}

.match-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.25rem 1rem rgba(161, 172, 184, 0.45) !important;
}

.match-teams {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-weight: bold;
}

.home-team, .away-team {
    flex: 1;
}

.home-team {
    text-align: right;
}

.away-team {
    text-align: left;
}

.vs {
    margin: 0 1rem;
    color: var(--bs-secondary);
    font-size: 0.875rem;
}

.match-teams-compact {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.ref-badge {
    display: flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    background-color: rgba(var(--bs-primary-rgb), 0.1);
    color: var(--bs-primary);
}

.ref-badge-small {
    display: flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    background-color: rgba(var(--bs-primary-rgb), 0.1);
    color: var(--bs-primary);
}

.ref-assigned {
    background-color: rgba(var(--bs-success-rgb), 0.1);
    color: var(--bs-success);
}

.ref-unassigned {
    background-color: rgba(var(--bs-danger-rgb), 0.1);
    color: var(--bs-danger);
}

/* Referee List Styling */
.referee-list {
    max-height: 600px;
    overflow-y: auto;
}

.referee-item {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.referee-item:hover .card {
    transform: translateY(-2px);
    box-shadow: 0 0.25rem 0.5rem rgba(161, 172, 184, 0.2) !important;
}

.referee-available {
    border-left: 3px solid var(--bs-success);
}

/* Modal Styling */
.match-detail-card {
    background-color: rgba(var(--bs-primary-rgb), 0.05);
    border-radius: 0.5rem;
    overflow: hidden;
}

.match-detail-header {
    padding: 0.75rem 1rem;
    background-color: var(--bs-primary);
    color: white;
    font-weight: 500;
}

.match-detail-body {
    padding: 1rem;
}

.match-location {
    font-size: 0.875rem;
    color: var(--bs-secondary);
}

.current-ref-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: white;
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
    border: 1px solid rgba(0,0,0,0.1);
}

.current-ref-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.current-ref-icon {
    font-size: 1.25rem;
    color: var(--bs-primary);
}

/* Match Details Modal */
.match-detail-full {
    padding: 1rem;
}

.match-teams-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    text-align: center;
}

.team {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.team-logo {
    width: 50px;
    height: 50px;
    background-color: rgba(var(--bs-primary-rgb), 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.team-name {
    font-size: 1.25rem;
    font-weight: bold;
}

.match-vs {
    padding: 0 1rem;
    font-weight: bold;
    color: var(--bs-secondary);
    font-size: 1.5rem;
}

.match-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.match-info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.match-info-item i {
    color: var(--bs-primary);
}

.referee-section {
    background-color: rgba(var(--bs-primary-rgb), 0.05);
    padding: 1rem;
    border-radius: 0.5rem;
}

.referee-title {
    margin-bottom: 0.5rem;
    color: var(--bs-primary);
}

.referee-detail {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
}

.referee-icon {
    color: var(--bs-primary);
}

/* Stats Card Styling */
.stat-card {
    position: relative;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow: hidden;
    height: 100%;
}

.stat-card-body {
    position: relative;
    z-index: 1;
}

.stat-card-title {
    font-size: 1.75rem;
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.stat-card-text {
    font-size: 0.85rem;
    margin-bottom: 0;
    opacity: 0.8;
}

.stat-card-icon {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    font-size: 1.75rem;
    opacity: 0.2;
}

/* Responsive adjustments */
@media (max-width: 992px) {
    .week-grid, .month-grid {
        display: flex;
        flex-direction: column;
    }
    
    .month-day {
        height: auto;
        min-height: 120px;
    }
    
    .day-column {
        margin-bottom: 1rem;
    }
    
    .match-info-grid {
        grid-template-columns: 1fr;
    }
    
    .match-teams-container {
        flex-direction: column;
        gap: 1rem;
    }
    
    .match-vs {
        padding: 0.5rem 0;
    }
}
</style>
{% endblock %}