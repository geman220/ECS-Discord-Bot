{% extends "base.html" %}

{% block main_content %}
<div class="container">
    <div class="content-header row">
        <div class="col-12 mb-2">
            <h2 class="fs-4 mb-0">Pub League Management</h2>
        </div>
    </div>

    <div class="content-body">
        <!-- Tabbed Interface for Leagues -->
        <ul class="nav nav-tabs justify-content-center" id="leagueTabs" role="tablist">
            {% for league in leagues %}
            <li class="nav-item">
                <a class="nav-link {% if loop.first %}active{% endif %}" id="{{ league.name }}-tab" data-bs-toggle="tab" href="#{{ league.name }}" role="tab" aria-controls="{{ league.name }}" aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                    {{ league.name }}
                </a>
            </li>
            {% endfor %}
        </ul>

        <div class="tab-content mt-4" id="leagueTabsContent">
            {% for league in leagues %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{ league.name }}" role="tabpanel" aria-labelledby="{{ league.name }}-tab">
                <!-- Bulk Match Creation Form -->
                <div class="card card-bordered mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title text-primary">Bulk Match Creation for {{ league.name }}</h6>
                        <button class="btn btn-primary btn-sm" id="generateForm-{{ league.name }}">
                            <i data-feather="plus"></i> Generate Input Form
                        </button>
                    </div>
                    <div class="card-body">
                        <form method="POST" id="bulkCreationForm-{{ league.name }}" action="{{ url_for('publeague.schedule.manage_publeague_schedule', season_id=season.id) }}" class="needs-validation" novalidate>
                            {{ form_hidden_fields() }}
                            <div class="row g-3">
                                {{ form_input_group("Total Weeks", "number", "total_weeks", "11", league.name) }}
                                {{ form_input_group("Matches per Week", "number", "matches_per_week", "8", league.name) }}
                                {{ form_input_group("Start Time", "time", "start_time", "", league.name) }}
                                {{ form_input_group("Fun Week (No Matches)", "number", "fun_week", "9", league.name) }}
                                {{ form_input_group("TST Week (No Matches)", "number", "tst_week", "11", league.name) }}
                                {{ form_select_group("Default Location", "location", ["North", "South"], league.name) }}
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-success">Submit</button>
                            </div>
                        </form>
                        <button type="button" class="btn btn-secondary mt-2" data-bs-toggle="modal" data-bs-target="#addWeekModal" data-league-name="{{ league.name }}">
                            <i data-feather="plus-circle"></i> Add Single Week
                        </button>
                    </div>
                </div>

                <!-- Detailed Input Form for Bulk Matches -->
                <div id="detailedInputForm-{{ league.name }}"></div>

                <!-- Current Schedule Display -->
                <div class="card card-bordered mt-4">
                    <div class="card-header">
                        <h6 class="card-title text-primary">Current Schedule for {{ league.name }}</h6>
                    </div>
                    <div class="card-body">
                        {% if schedule and schedule[league.name] %}
                        <div class="row g-2">
                            {% for week, data in schedule[league.name].items() %}
                            {{ render_week_card(week, data, season.id, league.name) }}
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">No matches scheduled yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add Week Modal -->
{{ render_add_week_modal() }}

<!-- Edit Match Modal -->
{{ render_edit_match_modal() }}

{% endblock %}

{% block custom_css %}
<style>
    /* Remove custom CSS in favor of Vuexy's utility classes */
</style>
{% endblock %}

{% block custom_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Feather Icons
        if (feather) {
            feather.replace();
        }

        // Initialize Bootstrap tooltips if used
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        const leagues = {{ leagues | tojson | safe }};
        leagues.forEach(league => {
            document.getElementById(`generateForm-${league.name}`).addEventListener('click', function () {
                handleGenerateForm(league.name);
            });
        });
    });

    function handleGenerateForm(leagueName) {
        const totalWeeks = document.getElementById(`total_weeks-${leagueName}`).value;
        const matchesPerWeek = document.getElementById(`matches_per_week-${leagueName}`).value;
        const funWeek = document.getElementById(`fun_week-${leagueName}`).value;
        const tstWeek = document.getElementById(`tst_week-${leagueName}`).value;
        const startTimeStr = document.getElementById(`start_time-${leagueName}`).value;
        const location = document.getElementById(`location-${leagueName}`).value;

        if (!totalWeeks || !matchesPerWeek || !startTimeStr) {
            Swal.fire({
                icon: 'error',
                title: 'Missing Information',
                text: 'Total Weeks, Matches Per Week, and Start Time are required!'
            });
            return;
        }

        const league = leagues.find(l => l.name === leagueName);
        const detailedForm = generateDetailedInputForm(totalWeeks, matchesPerWeek, funWeek, tstWeek, startTimeStr, location, league.teams, leagueName);
        document.getElementById(`detailedInputForm-${leagueName}`).innerHTML = detailedForm;

        // Optionally, scroll to the generated form
        document.getElementById(`detailedInputForm-${leagueName}`).scrollIntoView({ behavior: 'smooth' });
    }

    function generateDetailedInputForm(totalWeeks, matchesPerWeek, funWeek, tstWeek, startTimeStr, location, teams, leagueName) {
        const csrfToken = "{{ csrf_token() }}";
        let formHTML = `<form method="POST" action="/publeague/bulk_create_matches/${season.id}/${leagueName}" class="needs-validation" novalidate>
            <input type="hidden" name="csrf_token" value="${csrfToken}">
            <div class="row g-3">`;

        for (let week = 1; week <= totalWeeks; week++) {
            let weekDetails = week == funWeek ? 'Fun Week' : week == tstWeek ? 'TST Week' : `Week ${week}`;
            formHTML += `<div class="col-lg-4 col-md-6 col-sm-12">
                <div class="card card-bordered">
                    <div class="card-header">
                        <h6 class="card-title text-primary">${weekDetails}</h6>
                    </div>
                    <div class="card-body">
                        ${ (week == funWeek || week == tstWeek) ? `<p>No matches scheduled this week.</p>` : `
                        <div class="mb-2">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" name="date_week${week}" required>
                        </div>
                        ${ generateMatchesSection(week, matchesPerWeek, teams, startTimeStr, location) }
                        `}
                    </div>
                </div>
            </div>`;
        }

        formHTML += `</div>
            <div class="mt-3">
                <button type="submit" class="btn btn-success">Save Matches</button>
            </div>
        </form>`;
        return formHTML;
    }

    function generateMatchesSection(week, matchesPerWeek, teams, startTimeStr, location) {
        let matchesHTML = '';
        for (let match = 1; match <= matchesPerWeek; match++) {
            matchesHTML += `<div class="mb-3">
                <label class="form-label">Match ${match}</label>
                <div class="row g-2 align-items-center">
                    <div class="col-md-3">
                        <select class="form-select" name="teamA_week${week}_match${match}" required>
                            <option value="" disabled selected>Select Team A</option>
                            ${ teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('') }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="teamB_week${week}_match${match}" required>
                            <option value="" disabled selected>Select Team B</option>
                            ${ teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('') }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="time" class="form-control" name="time_week${week}_match${match}" value="${startTimeStr}" required>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="location_week${week}_match${match}" required>
                            <option value="North" ${location === 'North' ? 'selected' : ''}>North</option>
                            <option value="South" ${location === 'South' ? 'selected' : ''}>South</option>
                        </select>
                    </div>
                </div>
            </div>`;
        }
        return matchesHTML;
    }

    function loadMatchData(matchId, teamA, teamB, time, location, date, leagueName) {
        const formattedDate = new Date(date).toISOString().split('T')[0];

        const teamASelect = document.getElementById('edit_team_a');
        const teamBSelect = document.getElementById('edit_team_b');
        const league = {{ leagues | tojson | safe }}.find(l => l.name === leagueName);

        // Populate Team A dropdown
        teamASelect.innerHTML = league.teams.map(team =>
            `<option value="${team.id}" ${team.id === teamA ? 'selected' : ''}>${team.name}</option>`
        ).join('');

        // Populate Team B dropdown
        teamBSelect.innerHTML = league.teams.map(team =>
            `<option value="${team.id}" ${team.id === teamB ? 'selected' : ''}>${team.name}</option>`
        ).join('');

        document.getElementById('edit_time').value = time;
        document.getElementById('edit_location').value = location;
        document.getElementById('edit_date').value = formattedDate;

        // Set the match ID as a data attribute on the form
        document.querySelector('#editMatchForm').setAttribute('data-match-id', matchId);
    }

    function submitEditForm() {
        const form = document.getElementById('editMatchForm');

        // Get the match ID from the data attribute
        const matchId = form.getAttribute('data-match-id');

        // If matchId is null or undefined, throw an error and stop form submission
        if (!matchId) {
            console.error('Match ID is missing');
            return;
        }

        const formData = new FormData(form);

        fetch(`/publeague/schedules/edit_match/${matchId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': formData.get('csrf_token'),  // Ensure CSRF token is sent in the headers
                'Accept': 'application/json',
            },
            body: formData
        })
            .then(response => {
                if (!response.ok) throw new Error('Failed to update match.');
                return response.json();  // Assuming your server responds with JSON
            })
            .then(data => {
                alert('Match updated successfully!');
                // Optionally close the modal
                bootstrap.Modal.getInstance(document.getElementById('editMatchModal')).hide();
                // Refresh the page or update the UI
                location.reload();  // Simple page reload (could be replaced by a partial refresh)
            })
            .catch(error => {
                console.error('Error updating match:', error);
                alert('Error updating match.');
            });
    }
</script>
{% endblock %}

{% macro form_hidden_fields() %}
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
{% endmacro %}

{% macro form_input_group(label, type, name, defaultValue, leagueName, required="required") %}
<div class="col-12 col-sm-6 col-md-3">
    <label for="{{ name }}-{{ leagueName }}" class="form-label">{{ label }}</label>
    <input type="{{ type }}" class="form-control mb-2" id="{{ name }}-{{ leagueName }}" name="{{ name }}" value="{{ defaultValue }}" {{ required }}>
    <div class="invalid-feedback">
        Please provide a valid {{ label.lower() }}.
    </div>
</div>
{% endmacro %}

{% macro form_select_group(label, name, options, leagueName) %}
<div class="col-12 col-sm-6 col-md-3">
    <label for="{{ name }}-{{ leagueName }}" class="form-label">{{ label }}</label>
    <select class="form-select mb-2" id="{{ name }}-{{ leagueName }}" name="{{ name }}" required>
        <option value="" disabled selected>Select {{ label }}</option>
        {% for option in options %}
        <option value="{{ option }}">{{ option }}</option>
        {% endfor %}
    </select>
    <div class="invalid-feedback">
        Please select a {{ label.lower() }}.
    </div>
</div>
{% endmacro %}

{% macro render_add_week_modal() %}
<div class="modal fade" id="addWeekModal" tabindex="-1" aria-labelledby="addWeekModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Week</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('publeague.schedule.manage_publeague_schedule', season_id=season.id) }}" class="needs-validation" novalidate>
                <input type="hidden" name="action" value="add">
                <div class="modal-body">
                    {{ form_hidden_fields() }}
                    <input type="hidden" id="modal_league_name" name="league_name" value="">
                    <div class="mb-3">
                        <label for="week" class="form-label">Week Number</label>
                        <input type="number" class="form-control" id="week" name="week" required>
                        <div class="invalid-feedback">
                            Please provide a week number.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="date" name="date" required>
                        <div class="invalid-feedback">
                            Please provide a valid date.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="teamA" class="form-label">Team A</label>
                        <select class="form-select" id="teamA" name="teamA" required></select>
                        <div class="invalid-feedback">
                            Please select Team A.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="teamB" class="form-label">Team B</label>
                        <select class="form-select" id="teamB" name="teamB" required></select>
                        <div class="invalid-feedback">
                            Please select Team B.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="time" class="form-label">Time</label>
                        <input type="time" class="form-control" id="time" name="time" required>
                        <div class="invalid-feedback">
                            Please provide a valid time.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <select class="form-select" id="location" name="location" required>
                            <option value="" disabled selected>Select Location</option>
                            <option value="North">North</option>
                            <option value="South">South</option>
                        </select>
                        <div class="invalid-feedback">
                            Please select a location.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Week</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endmacro %}

{% macro render_week_card(week, data, season_id, league_name) %}
<div class="col-12 col-md-6 col-lg-4 mb-4">
    <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Week {{ week }} - {{ data.date }}</h6>
            <form method="POST" action="{{ url_for('publeague.schedule.delete_week', league_type='publeague', season_id=season_id, week_number=week) }}" style="display:inline;">
                {{ form_hidden_fields() }}
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete Week {{ week }}?');">Delete Week</button>
            </form>
        </div>
        <div class="card-body">
            {% if data.matches and data.matches | length > 0 %}
            {% set sorted_matches = data.matches | sort(attribute='time') %}
            {% for match in sorted_matches %}
            <div class="d-flex justify-content-between align-items-center mb-2">
                <p class="mb-0">{{ match.team_a }} vs {{ match.team_b }}</p>
                <div class="d-flex align-items-center">
                    <p class="mb-0 text-muted text-right">{{ match.time }} - {{ match.location }}</p>
                    <button class="btn btn-warning btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#editMatchModal"
                            onclick="loadMatchData({{ match.match_id }}, {{ match.team_a_id }}, {{ match.team_b_id }}, '{{ match.time }}', '{{ match.location }}', '{{ data.date }}', '{{ league_name }}')">
                        Edit
                    </button>
                    <form action="{{ url_for('publeague.schedule.delete_match', match_id=match.match_id) }}" method="POST" class="ms-2">
                        {{ form_hidden_fields() }}
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this match?');">Delete</button>
                    </form>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted">No matches scheduled for this week.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}

{% macro render_edit_match_modal() %}
<div class="modal fade" id="editMatchModal" tabindex="-1" aria-labelledby="editMatchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="editMatchForm">
                {{ form_hidden_fields() }}
                <div class="modal-header">
                    <h5 class="modal-title" id="editMatchModalLabel">Edit Match</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_team_a" class="form-label">Team A</label>
                        <select id="edit_team_a" name="teamA" class="form-select" required></select>
                    </div>

                    <div class="mb-3">
                        <label for="edit_team_b" class="form-label">Team B</label>
                        <select id="edit_team_b" name="teamB" class="form-select" required></select>
                    </div>

                    <div class="mb-3">
                        <label for="edit_date" class="form-label">Date</label>
                        <input type="date" id="edit_date" name="date" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label for="edit_time" class="form-label">Time</label>
                        <input type="time" id="edit_time" name="time" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label for="edit_location" class="form-label">Location</label>
                        <input type="text" id="edit_location" name="location" class="form-control" required>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="submitEditForm()">Save Changes</button>
            </form>
        </div>
    </div>
</div>
{% endmacro %}