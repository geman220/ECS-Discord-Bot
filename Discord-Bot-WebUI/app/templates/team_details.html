{% extends "base.html" %}

{% import 'macros.html' as macros %}

{% block title %}{{ team.name }} - Team Details{% endblock %}

{% block custom_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/team-detail.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/c-schedule.css') }}">
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Team Header -->
    <div class="c-team-header" data-component="team-header">
        {% if team.background_image_url %}
        <div class="c-team-header__background"
             data-background-url="{{ team.background_image_url }}"
             {% if team.background_size %}data-background-size="{{ team.background_size }}"{% endif %}
             {% if team.background_position %}data-background-position="{{ team.background_position }}"{% endif %}></div>
        {% else %}
        <div class="c-team-header__background c-team-header__background--gradient"></div>
        {% endif %}

        <div class="c-team-header__content">
            <div class="c-team-header__info">
                {% if team.kit_url %}
                <div class="c-team-header__logo">
                    <img src="{{ team.kit_url }}"
                         alt="{{ team.name }} kit"
                         class="c-team-header__logo-image">
                </div>
                {% endif %}

                <div class="c-team-header__details">
                    <h1 class="c-team-header__name">{{ team.name }}</h1>
                    <div class="c-team-header__meta">
                        <span class="c-badge c-badge--primary" data-badge>
                            <i class="ti ti-trophy"></i>{{ league.name }}
                        </span>
                        <span class="c-badge c-badge--info" data-badge>
                            <i class="ti ti-calendar"></i>{{ season.name if season else 'No active season' }}
                        </span>
                    </div>
                </div>
            </div>

            {% if can_upload_kit %}
            <div class="c-team-header__actions">
                <!-- Team Kit Upload -->
                <form action="{{ url_for('teams.upload_team_kit', team_id=team.id) }}"
                      method="post"
                      enctype="multipart/form-data"
                      class="c-upload-form"
                      data-form="upload-kit">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="file"
                           name="team_kit"
                           class="c-upload-form__input u-visually-hidden"
                           data-action="auto-submit"
                           data-target="team_kit"
                           accept="image/*">
                    <button type="button"
                            class="c-btn c-btn--outline-primary c-btn--sm"
                            data-action="trigger-file-input"
                            data-target="team_kit"
                            aria-label="Upload Team Kit"
                            data-bs-toggle="tooltip"
                            title="Upload Team Kit">
                        <i class="ti ti-upload"></i>
                        <span class="c-team-header__action-text">Upload Kit</span>
                    </button>
                </form>

                <!-- Team Background Upload -->
                <input type="file"
                       class="c-upload-form__input u-visually-hidden"
                       data-action="load-image-cropping"
                       data-target="team_background"
                       accept="image/*">
                <button type="button"
                        class="c-btn c-btn--outline-primary c-btn--sm"
                        data-action="trigger-background-input"
                        data-target="team_background"
                        aria-label="Upload Team Background"
                        data-bs-toggle="tooltip"
                        title="Upload Team Background">
                    <i class="ti ti-photo"></i>
                    <span class="c-team-header__action-text">Upload Background</span>
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Team Members Section -->
        <div class="col-lg-6 col-12 mb-4">
            <div class="c-card-modern">
                <div class="c-card-modern__header">
                    <h5 class="c-card-modern__title">Team Members</h5>
                    <div class="c-card-modern__actions">
                        {% if has_role('Global Admin') or has_role('Pub League Admin') %}
                        <button class="c-btn c-btn--warning c-btn--sm"
                                data-action="assign-discord-roles"
                                data-team-id="{{ team.id }}">
                            <i class="ti ti-brand-discord"></i>
                            <span class="c-btn-text">Assign Discord Roles</span>
                        </button>
                        <button class="c-btn c-btn--info c-btn--sm"
                                data-action="refresh-discord-status"
                                data-team-id="{{ team.id }}">
                            <i class="ti ti-refresh"></i>
                            <span class="c-btn-text">Refresh Discord Status</span>
                        </button>
                        {% endif %}
                        {% if can_add_player %}
                        <a href="{{ url_for('teams.add_player', team_id=team.id) }}"
                           class="c-btn c-btn--primary c-btn--sm">
                            <i class="ti ti-plus"></i>
                            <span class="c-btn-text">Add Player</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="c-card-modern__body c-card-modern__body--no-padding">
                    <div class="c-roster-grid" data-component="roster-grid">
                        {% for player in players %}
                        <div class="c-roster-card" data-player-id="{{ player.id }}">
                            <a href="{{ url_for('players.player_profile', player_id=player.id) }}"
                               class="c-roster-card__link">
                                <div class="c-roster-card__avatar">
                                    <img src="{{ player.profile_picture_url or url_for('static', filename='img/default_player.png') }}"
                                         alt="{{ player.name }}"
                                         class="c-roster-card__avatar-image">
                                    {% if player.user_id %}
                                    <span class="c-online-status c-online-status--sm is-offline"
                                          data-online-status="{{ player.user_id }}"
                                          title="Offline"
                                          aria-label="Online status"></span>
                                    {% endif %}
                                    {% if player.is_coach %}
                                    <span class="c-roster-card__badge c-roster-card__badge--coach"
                                          data-bs-toggle="tooltip"
                                          title="Coach">
                                        <i class="ti ti-trophy"></i>
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="c-roster-card__info">
                                    <h6 class="c-roster-card__name">{{ player.name }}</h6>
                                    {% if player.favorite_position %}
                                    <small class="c-roster-card__position">{{ format_position(player.favorite_position) }}</small>
                                    {% endif %}
                                </div>
                            </a>

                            <div class="c-roster-card__stats">
                                {% if can_view_player_stats %}
                                <span class="c-stat-badge" data-bs-toggle="tooltip" title="Goals">
                                    <i class="ti ti-ball-football"></i>{{ player.season_goals(season.id) }}
                                </span>
                                <span class="c-stat-badge" data-bs-toggle="tooltip" title="Assists">
                                    <i class="ti ti-arrow-big-right-lines"></i>{{ player.season_assists(season.id) }}
                                </span>
                                {% endif %}

                                {% if can_view_player_cards %}
                                <span class="c-stat-badge c-stat-badge--yellow" data-bs-toggle="tooltip" title="Yellow Cards">
                                    ðŸŸ¨{{ player.season_yellow_cards(season.id) }}
                                </span>
                                <span class="c-stat-badge c-stat-badge--red" data-bs-toggle="tooltip" title="Red Cards">
                                    ðŸŸ¥{{ player.season_red_cards(season.id) }}
                                </span>
                                {% endif %}

                                {% if player.discord_id %}
                                <span class="c-discord-badge {% if player.discord_in_server %}c-discord-badge--active{% elif player.discord_in_server is false %}c-discord-badge--inactive{% endif %}"
                                      data-bs-toggle="tooltip"
                                      title="Discord: {{ player.discord_username or player.discord_id }}{% if player.discord_in_server is not none %} - {% if player.discord_in_server %}In Server{% else %}Not in Server{% endif %}{% endif %}"
                                      {% if has_role('Global Admin') or has_role('Pub League Admin') %}
                                      data-action="refresh-player-discord"
                                      data-player-id="{{ player.id }}"
                                      data-player-name="{{ player.name }}"
                                      {% endif %}>
                                    <i class="ti ti-brand-discord"></i>
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="c-empty-state" data-component="empty-state">
                            <div class="c-empty-state__icon">
                                <i class="ti ti-users-off"></i>
                            </div>
                            <p class="c-empty-state__text">No players have been assigned to this team yet.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Schedule Section -->
        <div class="col-lg-6 col-12 mb-4">
            <div class="c-card-modern">
                <div class="c-card-modern__header">
                    <h5 class="c-card-modern__title">Team Schedule</h5>
                    <div class="c-card-modern__actions">
                        {% if schedule %}
                        <div class="c-schedule-controls">
                            <button type="button"
                                    class="c-schedule-controls__btn"
                                    data-action="expand-all-schedule"
                                    aria-label="Expand all dates">
                                <i class="ti ti-arrows-maximize"></i>
                                <span>Expand</span>
                            </button>
                            <button type="button"
                                    class="c-schedule-controls__btn"
                                    data-action="collapse-all-schedule"
                                    aria-label="Collapse all dates">
                                <i class="ti ti-arrows-minimize"></i>
                                <span>Collapse</span>
                            </button>
                        </div>
                        {% endif %}
                        {% if can_add_match %}
                        <a href="{{ url_for('matches.add_match', team_id=team.id) }}"
                           class="c-btn c-btn--primary c-btn--sm">
                            <i class="ti ti-plus"></i>Add Match
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="c-card-modern__body c-card-modern__body--no-padding">
                    {% if schedule %}
                    <div class="c-schedule" data-component="team-schedule">
                        {% for date, matches_on_date in schedule.items() %}
                        {% set wins = matches_on_date|selectattr('result_text', 'equalto', 'W')|list|length %}
                        {% set losses = matches_on_date|selectattr('result_text', 'equalto', 'L')|list|length %}
                        {% set draws = matches_on_date|selectattr('result_text', 'equalto', 'D')|list|length %}
                        {% set pending = matches_on_date|rejectattr('reported')|list|length %}
                        {# Native HTML details/summary - browser handles collapse/expand #}
                        <details class="c-schedule__week" data-date="{{ date.strftime('%Y-%m-%d') }}">
                            <summary class="c-schedule__header">
                                <i class="ti ti-calendar-event c-schedule__icon"></i>
                                <span class="c-schedule__date">{{ date.strftime('%B %d, %Y') }}</span>
                                <span class="c-schedule__badges">
                                    {% if wins > 0 %}
                                    <span class="c-schedule__badge c-schedule__badge--win" title="{{ wins }} Win{{ 's' if wins > 1 else '' }}">W{{ wins }}</span>
                                    {% endif %}
                                    {% if losses > 0 %}
                                    <span class="c-schedule__badge c-schedule__badge--loss" title="{{ losses }} Loss{{ 'es' if losses > 1 else '' }}">L{{ losses }}</span>
                                    {% endif %}
                                    {% if draws > 0 %}
                                    <span class="c-schedule__badge c-schedule__badge--draw" title="{{ draws }} Draw{{ 's' if draws > 1 else '' }}">D{{ draws }}</span>
                                    {% endif %}
                                    {% if pending > 0 %}
                                    <span class="c-schedule__badge c-schedule__badge--pending" title="{{ pending }} Pending">{{ pending }}</span>
                                    {% endif %}
                                </span>
                                <i class="ti ti-chevron-down c-schedule__chevron"></i>
                            </summary>
                            <div class="c-schedule__matches">
                            {% for match in matches_on_date %}
                            {% set current_team_id = team.id %}
                            {% if match.home_team_id == current_team_id %}
                                {% set display_home = match.home_team_name %}
                                {% set display_away = match.away_team_name %}
                                {% set result_class = match.result_class %}
                                {% set result_text = match.result_text %}
                            {% else %}
                                {% set display_home = match.away_team_name %}
                                {% set display_away = match.home_team_name %}
                                {% set result_class = match.result_class %}
                                {% set result_text = match.result_text %}
                            {% endif %}

                            <div class="c-schedule__match" data-match-id="{{ match.id }}">
                                <div class="c-schedule__time">
                                    <i class="ti ti-clock"></i>{{ match.time.strftime('%I:%M %p') }}
                                </div>

                                <div class="c-schedule__details">
                                    {% if not match.is_ecs_fc %}
                                    <a href="{{ url_for('match_pages.view_match', match_id=match.id) }}"
                                       class="c-schedule__link">
                                    {% endif %}

                                        <div class="c-schedule__teams">
                                            {% if match.week_type in ['FUN', 'TST', 'BYE', 'BONUS', 'PLAYOFF', 'PRACTICE'] %}
                                            <span class="c-badge c-badge--info">{{ match.week_type }}</span>
                                            {% else %}
                                            <strong>{{ display_home }}</strong> vs <strong>{{ display_away }}</strong>
                                            {% endif %}
                                        </div>

                                        <div class="c-schedule__location">
                                            <i class="ti ti-map-pin"></i>{{ match.location }}
                                            {% if match.field_name %}- {{ match.field_name }}{% endif %}
                                        </div>

                                    {% if not match.is_ecs_fc %}
                                    </a>
                                    {% endif %}
                                </div>

                                {% if can_view_game_results and match.reported %}
                                <div class="c-schedule__result">
                                    <span class="c-badge c-badge--{{ result_class }}">
                                        {{ result_text }}
                                    </span>
                                </div>
                                {% endif %}

                                {% if can_report_match %}
                                <div class="c-schedule__actions">
                                    <button class="c-btn c-btn--sm c-btn--icon-only {% if match.reported %}btn-warning{% else %}btn-primary{% endif %}"
                                            data-action="edit-match"
                                            data-match-id="{{ match.id }}"
                                            aria-label="{{ 'Edit Match' if match.reported else 'Report Match' }}"
                                            data-bs-toggle="tooltip"
                                            title="{{ 'Edit Match' if match.reported else 'Report Match' }}">
                                        <i class="ti ti-{% if match.reported %}edit{% else %}report{% endif %}"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                            </div>{# .c-schedule__matches #}
                        </details>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="c-empty-state" data-component="empty-state">
                        <div class="c-empty-state__icon">
                            <i class="ti ti-calendar-off"></i>
                        </div>
                        <p class="c-empty-state__text">No matches have been scheduled for this team yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Team Information Card -->
        <div class="col-12 mb-4">
            <div class="c-card-modern">
                <div class="c-card-modern__header">
                    <h5 class="c-card-modern__title">Team Information</h5>
                </div>
                <div class="c-card-modern__body">
                    <div class="c-team-stats" data-component="team-stats">
                        <div class="c-team-stats__item">
                            <div class="c-team-stats__icon c-team-stats__icon--primary">
                                <i class="ti ti-users"></i>
                            </div>
                            <div class="c-team-stats__content">
                                <div class="c-team-stats__label">Total Players</div>
                                <div class="c-team-stats__value">{{ players|length }}</div>
                            </div>
                        </div>

                        <div class="c-team-stats__item">
                            <div class="c-team-stats__icon c-team-stats__icon--success">
                                <i class="ti ti-calendar-event"></i>
                            </div>
                            <div class="c-team-stats__content">
                                <div class="c-team-stats__label">Current Season</div>
                                <div class="c-team-stats__value">{{ season.name if season else 'No active season' }}</div>
                            </div>
                        </div>

                        <div class="c-team-stats__item">
                            <div class="c-team-stats__icon c-team-stats__icon--info">
                                <i class="ti ti-trophy"></i>
                            </div>
                            <div class="c-team-stats__content">
                                <div class="c-team-stats__label">Division</div>
                                <div class="c-team-stats__value">{{ league.name }}</div>
                            </div>
                        </div>

                        {% if next_match %}
                        <div class="c-team-stats__item c-team-stats__item--wide">
                            <div class="c-team-stats__icon c-team-stats__icon--warning">
                                <i class="ti ti-calendar-time"></i>
                            </div>
                            <div class="c-team-stats__content">
                                <div class="c-team-stats__label">Next Match</div>
                                <div class="c-team-stats__value">
                                    {{ next_match.date.strftime('%B %d, %Y') }} at {{ next_match.time.strftime('%I:%M %p') }}
                                    <br>
                                    <small>{{ next_match.location }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Background Image Cropping Modal -->
<div class="modal c-modal fade"
     id="cropBackgroundModal"
     tabindex="-1"
     aria-labelledby="cropBackgroundModalLabel"
     aria-hidden="true"
     data-bs-backdrop="static"
     data-modal="crop-background">
    <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg modal-dialog-centered c-modal__dialog--centered">
        <div class="modal-content c-modal__content">
            <div class="modal-header c-modal__header">
                <h5 class="modal-title c-modal__title" id="cropBackgroundModalLabel">Position Team Background Image</h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                        data-action="close-modal"></button>
            </div>
            <div class="modal-body c-modal__body">
                <p class="text-muted text-center mb-3">
                    Position and scale your team photo. The preview below has the exact same aspect ratio as your team header (3.33:1).
                </p>

                <div class="c-image-position" data-component="image-position">
                    <div class="c-image-position__preview" id="headerPreview">
                        <div class="c-image-position__wrapper" id="previewImageWrapper">
                            <div class="c-image-position__hint" id="dragHint">
                                <i class="ti ti-hand-move"></i>Drag to reposition
                            </div>
                        </div>
                    </div>

                    <div class="c-image-position__controls">
                        <div class="mb-3">
                            <label class="form-label">Zoom Level</label>
                            <div class="d-flex align-items-center gap-3">
                                <button type="button"
                                        class="c-btn c-btn--sm c-btn--outline-secondary"
                                        data-action="adjust-zoom"
                                        data-delta="-0.1">
                                    <i class="ti ti-minus"></i>
                                </button>
                                <input type="range"
                                       class="form-range flex-grow-1"
                                       id="zoomSlider"
                                       min="1"
                                       max="3"
                                       step="0.1"
                                       value="1">
                                <button type="button"
                                        class="c-btn c-btn--sm c-btn--outline-secondary"
                                        data-action="adjust-zoom"
                                        data-delta="0.1">
                                    <i class="ti ti-plus"></i>
                                </button>
                                <span class="text-muted" id="zoomValue">100%</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Horizontal Position</label>
                                <input type="range" class="form-range" id="xPosSlider" min="0" max="100" value="50">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Vertical Position</label>
                                <input type="range" class="form-range" id="yPosSlider" min="0" max="100" value="50">
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button type="button"
                                    class="c-btn c-btn--sm c-btn--outline-secondary"
                                    data-action="reset-image-position">
                                <i class="ti ti-refresh"></i>Reset Position
                            </button>
                        </div>
                    </div>

                    <input type="hidden" id="originalImageData">
                </div>
            </div>
            <div class="modal-footer c-modal__footer">
                <button type="button"
                        class="c-btn c-btn--secondary"
                        data-bs-dismiss="modal"
                        data-action="close-modal">Cancel</button>
                <button type="button"
                        class="c-btn c-btn--primary"
                        data-action="upload-cropped-image">
                    <i class="ti ti-upload"></i>Upload Background
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include ECS FC Schedule Section if applicable -->
{% include 'ecs_fc_schedule_section.html' %}

{% endblock %}

{% block custom_js %}
<script>
// Match data for reporting
window.TEAM_MATCH_DATA = {
    {% for date, matches_on_date in schedule.items() %}
    {% for match in matches_on_date %}
    "{{ match.id }}": {
        homeTeamName: "{{ match.home_team_name|escape }}",
        awayTeamName: "{{ match.away_team_name|escape }}",
        homeTeamId: "{{ match.home_team_id }}",
        awayTeamId: "{{ match.away_team_id }}",
        homeTeamPlayers: [
            {% for player in match.home_players %}
            {id: "{{ player.id }}", name: "{{ player.name|escape }}"}{{ "," if not loop.last else "" }}
            {% endfor %}
        ],
        awayTeamPlayers: [
            {% for player in match.away_players %}
            {id: "{{ player.id }}", name: "{{ player.name|escape }}"}{{ "," if not loop.last else "" }}
            {% endfor %}
        ]
    }{{ "," if not loop.last else "" }}
    {% endfor %}
    {% endfor %}
};
</script>
<script src="{{ url_for('static', filename='custom_js/team-detail.js') }}"></script>
{% if not config.get('ASSETS_PRODUCTION_MODE') %}
<script src="{{ url_for('static', filename='custom_js/report_match.js') }}"></script>
{% endif %}
{% endblock %}
