{% extends "base.html" %}

{% block title %}WooCommerce Sync Review{% endblock %}

{% block page_css %}

{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/sync-review.css') }}">
{% endif %}
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold py-3 mb-2">
                        <i class="ti ti-refresh me-2 text-primary"></i>WooCommerce Sync Review
                    </h2>
                    <div class="text-muted">
                        Review and resolve sync issues before applying changes
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('user_management.manage_users') }}" class="c-btn c-btn--outline-secondary">
                        <i class="ti ti-arrow-left me-1"></i> Back to User Management
                    </a>
                    <button type="button" class="c-btn c-btn--outline-primary js-refresh-sync" data-action="refresh-sync">
                        <i class="ti ti-refresh me-1"></i> Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__body">
                    <h6 class="c-card__title mb-3">Resolution Progress</h6>
                    <div class="progress progress-detailed">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="resolutionProgress" role="progressbar">
                            <span id="progressText" class="fw-semibold">0% Complete</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="c-card stats-card text-center shadow-sm">
                <div class="c-card__body py-3">
                    <h3 class="c-card__title text-primary mb-1" id="newPlayersCount">{{ sync_data.new_players|length }}</h3>
                    <p class="c-card__description text-muted mb-0">New Players</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="c-card stats-card text-center shadow-sm">
                <div class="c-card__body py-3">
                    <h3 class="c-card__title text-success mb-1" id="existingPlayersCount">{{ sync_data.player_league_updates|length }}</h3>
                    <p class="c-card__description text-muted mb-0">Existing Players</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="c-card stats-card text-center shadow-sm">
                <div class="c-card__body py-3">
                    <h3 class="c-card__title text-warning mb-1" id="flaggedOrdersCount">{{ sync_data.flagged_multi_orders|length }}</h3>
                    <p class="c-card__description text-muted mb-0">Multi-Orders</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="c-card stats-card text-center shadow-sm">
                <div class="c-card__body py-3">
                    <h3 class="c-card__title text-danger mb-1" id="emailMismatchCount">{{ sync_data.email_mismatch_players|length }}</h3>
                    <p class="c-card__description text-muted mb-0">Email Mismatches</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="c-card stats-card text-center shadow-sm">
                <div class="c-card__body py-3">
                    <h3 class="c-card__title text-info mb-1" id="potentialInactiveCount">{{ sync_data.potential_inactive|length }}</h3>
                    <p class="c-card__description text-muted mb-0">Potential Inactive</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="c-card stats-card text-center shadow-sm">
                <div class="c-card__body py-3">
                    <h3 class="c-card__title text-secondary mb-1" id="issuesResolvedCount">0</h3>
                    <p class="c-card__description text-muted mb-0">Issues Resolved</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Issues Card with Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__header border-bottom">
                    <ul class="nav nav-tabs c-card__header c-card__header--tabs" id="issuesTab" role="tablist" data-tabs>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="multi-orders-tab" data-bs-toggle="tab" data-bs-target="#multi-orders" type="button" role="tab">
                                <i class="ti ti-users me-1"></i>Multi-Person Orders
                                <span class="badge bg-warning ms-2" id="multiOrdersBadge" data-badge>{{ sync_data.flagged_multi_orders|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="new-players-tab" data-bs-toggle="tab" data-bs-target="#new-players" type="button" role="tab">
                                <i class="ti ti-user-plus me-1"></i>New Players
                                <span class="badge bg-primary ms-2" id="newPlayersBadge" data-badge>{{ sync_data.new_players|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="email-mismatches-tab" data-bs-toggle="tab" data-bs-target="#email-mismatches" type="button" role="tab">
                                <i class="ti ti-mail me-1"></i>Email Mismatches
                                <span class="badge bg-danger ms-2" id="emailMismatchBadge" data-badge>{{ sync_data.email_mismatch_players|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="existing-players-tab" data-bs-toggle="tab" data-bs-target="#existing-players" type="button" role="tab">
                                <i class="ti ti-user-check me-1"></i>Existing Players
                                <span class="badge bg-success ms-2" id="existingPlayersBadge" data-badge>{{ sync_data.player_league_updates|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="inactive-players-tab" data-bs-toggle="tab" data-bs-target="#inactive-players" type="button" role="tab">
                                <i class="ti ti-user-off me-1"></i>Mark Inactive
                                <span class="badge bg-warning ms-2" id="inactivePlayersBadge" data-badge>{{ sync_data.players_to_inactivate|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">
                                <i class="ti ti-check-circle me-1"></i>Final Review
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="tab-content">
                    <!-- Multi-Person Orders Tab -->
                    <div class="tab-pane fade show active" id="multi-orders" role="tabpanel" data-tab-pane>
                        <div class="c-card__body">
                            {% if sync_data.flagged_multi_orders|length > 0 %}
                                <div class="alert alert-warning border-start border-warning border-3 py-3 px-4 mb-4" data-alert>
                                    <div class="d-flex align-items-center">
                                        <i class="ti ti-alert-triangle me-2 fs-4"></i>
                                        <div>
                                            <h6 class="alert-heading mb-1">Multi-Person Orders Detected</h6>
                                            <p class="mb-0">These buyers purchased multiple memberships. Please assign each order to the correct player profile.</p>
                                        </div>
                                    </div>
                                </div>

                                {% for order in sync_data.flagged_multi_orders %}
                                {% set outer_loop = loop %}
                                <div class="issue-card issue-pending border rounded p-4 mb-4" data-issue-type="multi-order" data-issue-id="{{ loop.index0 }}">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="ti ti-user me-2 text-primary"></i>
                                                <h5 class="mb-0">{{ order.buyer_info.name }}</h5>
                                                <span class="status-badge badge bg-warning ms-3" data-badge>Pending Assignment</span>
                                            </div>
                                            <p class="text-muted mb-3">
                                                <i class="ti ti-mail me-1"></i>{{ order.buyer_info.email }}<br>
                                                <small>{{ order.reason }}</small>
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <h6 class="text-primary mb-3">
                                                <i class="ti ti-shopping-cart me-1"></i>Orders to Assign
                                            </h6>
                                            {% for ord in order.orders %}
                                            <div class="order-details mb-3" data-order-index="{{ loop.index0 }}">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        <strong class="text-dark">Order #{{ ord.order.order_id }}</strong>
                                                        <span class="badge bg-light text-dark ms-2" data-badge>Qty: {{ ord.order.quantity }}</span>
                                                        <br>
                                                        <div class="mt-2 p-2 bg-light rounded">
                                                            <h6 class="mb-1 text-primary"><i class="ti ti-info-circle me-1"></i>Order Information:</h6>
                                                            <div class="small">
                                                                <strong>Product:</strong> {{ ord.order.product_name }}<br>
                                                                <strong>Name:</strong> {{ ord.player_info.name }}<br>
                                                                <strong>Email:</strong> {{ ord.player_info.email or 'Not provided' }}<br>
                                                                <strong>Phone:</strong> {{ ord.player_info.phone or 'Not provided' }}<br>
                                                                <strong>Jersey Size:</strong> {{ ord.jersey_size or 'Not provided' }}<br>
                                                                <strong>League:</strong> {{ ord.league_name }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="resolution-actions">
                                                <h6 class="text-warning mb-3">
                                                    <i class="ti ti-user-check me-1"></i>Player Assignments
                                                </h6>
                                                <div id="assignments-{{ outer_loop.index0 }}">
                                                    {% for ord in order.orders %}
                                                    <div class="player-assignment mb-3">
                                                        <label class="form-label fw-semibold">Order #{{ ord.order.order_id }}:</label>
                                                        
                                                        <!-- Current Assignment Display -->
                                                        <div class="current-assignment mb-2" id="current-assignment-{{ outer_loop.index0 }}-{{ loop.index0 }}">
                                                            <div class="alert alert-success py-2 mb-2" data-alert>
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <div>
                                                                        <i class="ti ti-check-circle me-1"></i>
                                                                        <span class="assignment-text"></span>
                                                                    </div>
                                                                    <button type="button" class="c-btn c-btn--sm c-btn--outline-danger js-remove-assignment" data-action="remove-assignment" data-issue-id="{{ outer_loop.index0 }}" data-order-index="{{ loop.index0 }}">
                                                                        <i class="ti ti-x me-1"></i>Remove
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Assignment Selection -->
                                                        <div class="assignment-selection" id="assignment-selection-{{ outer_loop.index0 }}-{{ loop.index0 }}">
                                                            <select class="form-select assignment-select mb-2" 
                                                                    data-issue-id="{{ outer_loop.index0 }}" 
                                                                    data-order-index="{{ loop.index0 }}" data-form-select>
                                                                <option value="">Select Assignment...</option>
                                                                <option value="new">Create New Player Profile</option>
                                                                <option value="search">Assign to Existing Player</option>
                                                            </select>
                                                        </div>
                                                        
                                                        <!-- New Player Creation Form -->
                                                        <div class="d-none" id="create-new-{{ outer_loop.index0 }}-{{ loop.index0 }}">
                                                            <div class="c-card border-success border-2 mt-2">
                                                                <div class="c-card__header bg-success text-white py-2">
                                                                    <h6 class="mb-0"><i class="ti ti-user-plus me-1"></i>Create New Player from WooCommerce Order</h6>
                                                                </div>
                                                                <div class="c-card__body p-3">
                                                                    <div class="mb-2">
                                                                        <label class="form-label fw-semibold">Player Name *</label>
                                                                        <input type="text" class="form-control form-control-sm new-player-name" value="{{ ord.player_info.name }}" required data-form-control aria-label="Player Name">
                                                                        <div class="form-text">Pre-filled from WooCommerce order - edit if needed</div>
                                                                    </div>
                                                                    
                                                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                                                        <button class="c-btn c-btn--success c-btn--sm js-create-player-form" data-action="create-player-form" data-issue-id="{{ outer_loop.index0 }}" data-order-index="{{ loop.index0 }}">
                                                                            <i class="ti ti-plus me-1"></i>Create Player with Order Data
                                                                        </button>
                                                                        <button class="c-btn c-btn--secondary c-btn--sm js-cancel-creation" data-action="cancel-creation" data-issue-id="{{ outer_loop.index0 }}" data-order-index="{{ loop.index0 }}">Cancel</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Player Search Form -->
                                                        <div class="d-none" id="search-{{ outer_loop.index0 }}-{{ loop.index0 }}">
                                                            <div class="c-card border-primary border-2 mt-2">
                                                                <div class="c-card__header bg-primary text-white py-2">
                                                                    <h6 class="mb-0"><i class="ti ti-search me-1"></i>Search Existing Players</h6>
                                                                </div>
                                                                <div class="c-card__body p-3">
                                                                    <div class="mb-2">
                                                                        <input type="text" class="form-control form-control-sm player-search js-player-search" data-issue-id="{{ outer_loop.index0 }}" data-order-index="{{ loop.index0 }}" placeholder="Search by name, email, or phone..." data-form-control aria-label="Search by name, email, or phone...">
                                                                        <div class="form-text">Type at least 2 characters to search</div>
                                                                    </div>
                                                                    <div class="search-results" id="search-results-{{ outer_loop.index0 }}-{{ loop.index0 }}"></div>
                                                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-2">
                                                                        <button class="c-btn c-btn--secondary c-btn--sm js-cancel-search" data-action="cancel-search" data-issue-id="{{ outer_loop.index0 }}" data-order-index="{{ loop.index0 }}">Cancel</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <button class="c-btn c-btn--success js-resolve-multi-order" data-action="resolve-multi-order" data-issue-id="{{ outer_loop.index0 }}">
                                                    <i class="ti ti-check me-1"></i> Save Assignments
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="ti ti-circle-check text-success empty-state-icon"></i>
                                    <h4 class="text-success mt-3">No Multi-Person Orders!</h4>
                                    <p class="text-muted">All orders have single assignments.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- New Players Tab -->
                    <div class="tab-pane fade" id="new-players" role="tabpanel" data-tab-pane>
                        <div class="c-card__body">
                            {% if sync_data.new_players|length > 0 %}
                                <div class="alert alert-info border-start border-info border-3 py-3 px-4 mb-4" data-alert>
                                    <div class="d-flex align-items-center">
                                        <i class="ti ti-info-circle me-2 fs-4"></i>
                                        <div>
                                            <h6 class="alert-heading mb-1">New Players Found</h6>
                                            <p class="mb-0">These players were not found in the database. Verify they are legitimate new registrations.</p>
                                        </div>
                                    </div>
                                </div>

                                {% for player in sync_data.new_players %}
                                <div class="issue-card issue-pending border rounded p-4 mb-4" data-issue-type="new-player" data-issue-id="{{ loop.index0 }}">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="d-flex align-items-center">
                                            <i class="ti ti-user-plus me-2 text-primary"></i>
                                            <h5 class="mb-0">{{ player.info.name }}</h5>
                                            <span class="status-badge badge bg-primary ms-3" data-badge>New Player</span>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <h6 class="text-primary mb-3">
                                                <i class="ti ti-info-circle me-1"></i>Player Information
                                            </h6>
                                            <div class="mb-3">
                                                <div class="row g-2">
                                                    <div class="col-sm-4"><strong>Email:</strong></div>
                                                    <div class="col-sm-8">{{ player.info.email }}</div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="row g-2">
                                                    <div class="col-sm-4"><strong>Phone:</strong></div>
                                                    <div class="col-sm-8">{{ player.info.phone or 'Not provided' }}</div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="row g-2">
                                                    <div class="col-sm-4"><strong>League:</strong></div>
                                                    <div class="col-sm-8">{{ player.league_name or 'Unknown' }}</div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="row g-2">
                                                    <div class="col-sm-4"><strong>Jersey Size:</strong></div>
                                                    <div class="col-sm-8">{{ player.jersey_size or 'Not provided' }}</div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="row g-2">
                                                    <div class="col-sm-4"><strong>Order:</strong></div>
                                                    <div class="col-sm-8">#{{ player.order_id }}</div>
                                                </div>
                                            </div>
                                            {% if player.reason %}
                                            <div class="alert alert-warning py-2 px-3" data-alert>
                                                <small><i class="ti ti-alert-triangle me-1"></i>{{ player.reason }}</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="resolution-actions">
                                                <h6 class="text-warning mb-3">
                                                    <i class="ti ti-tools me-1"></i>Resolution Options
                                                </h6>
                                                <div class="d-grid gap-2">
                                                    <button class="c-btn c-btn--success js-create-new-player" data-action="create-new-player" data-issue-id="{{ loop.index0 }}">
                                                        <i class="ti ti-user-plus me-1"></i> Create New Player Profile
                                                    </button>
                                                    <button class="c-btn c-btn--warning js-search-existing" data-action="search-existing" data-issue-id="{{ loop.index0 }}">
                                                        <i class="ti ti-search me-1"></i> Search for Existing Player
                                                    </button>
                                                    <button class="c-btn c-btn--danger js-flag-invalid" data-action="flag-invalid" data-issue-id="{{ loop.index0 }}">
                                                        <i class="ti ti-x me-1"></i> Mark as Invalid Order
                                                    </button>
                                                </div>
                                                <div class="mt-3 d-none" id="player-search-{{ loop.index0 }}">
                                                    <input type="text" class="form-control" placeholder="Search existing players..." data-form-control aria-label="Search existing players...">
                                                    <div class="search-results mt-2"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="ti ti-circle-check text-success empty-state-icon"></i>
                                    <h4 class="text-success mt-3">No New Players!</h4>
                                    <p class="text-muted">All players were found in the existing database.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Email Mismatches Tab -->
                    <div class="tab-pane fade" id="email-mismatches" role="tabpanel" data-tab-pane>
                        <div class="c-card__body">
                            {% if sync_data.email_mismatch_players|length > 0 %}
                                <div class="alert alert-danger border-start border-danger border-3 py-3 px-4 mb-4" data-alert>
                                    <div class="d-flex align-items-center">
                                        <i class="ti ti-mail-x me-2 fs-4"></i>
                                        <div>
                                            <h6 class="alert-heading mb-1">Email Address Conflicts</h6>
                                            <p class="mb-0">These players were matched but have different email addresses between the database and WooCommerce.</p>
                                        </div>
                                    </div>
                                </div>

                                {% for player in sync_data.email_mismatch_players %}
                                <div class="issue-card issue-pending border rounded p-4 mb-4" data-issue-type="email-mismatch" data-issue-id="{{ loop.index0 }}">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="d-flex align-items-center">
                                            <i class="ti ti-mail-x me-2 text-danger"></i>
                                            <h5 class="mb-0">{{ player.existing_player.name }}</h5>
                                            <span class="status-badge badge bg-danger ms-3" data-badge>Email Mismatch</span>
                                        </div>
                                        <div>
                                            <a href="/players/profile/{{ player.existing_player.id }}" target="_blank" class="c-btn c-btn--outline-primary c-btn--sm">
                                                <i class="ti ti-external-link me-1"></i>View Profile
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-lg-7">
                                            <h6 class="text-primary mb-3">
                                                <i class="ti ti-search me-1"></i>Match Analysis
                                            </h6>
                                            
                                            <!-- Database Player Info -->
                                            <div class="alert alert-info py-2 mb-3" data-alert>
                                                <h6 class="mb-1"><i class="ti ti-database me-1"></i>Database Player:</h6>
                                                <div class="small">
                                                    <strong>Name:</strong> {{ player.existing_player.name }}<br>
                                                    <strong>Email:</strong> <code class="text-success">{{ player.existing_player.discord_email }}</code><br>
                                                    <strong>Phone:</strong> {{ player.existing_player.phone or 'Not provided' }}
                                                </div>
                                            </div>
                                            
                                            <!-- WooCommerce Order Info -->
                                            <div class="alert alert-warning py-2 mb-3" data-alert>
                                                <h6 class="mb-1"><i class="ti ti-shopping-cart me-1"></i>WooCommerce Order:</h6>
                                                <div class="small">
                                                    <strong>Name:</strong> {{ player.order_info.woo_name }}<br>
                                                    <strong>Email:</strong> <code class="text-warning">{{ player.order_info.woo_email }}</code><br>
                                                    <strong>Phone:</strong> {{ player.order_info.woo_phone or 'Not provided' }}<br>
                                                    <strong>Jersey Size:</strong> {{ player.order_info.jersey_size or 'Not provided' }}<br>
                                                    <strong>Order ID:</strong> #{{ player.order_info.order_id }}
                                                </div>
                                            </div>
                                            
                                            <!-- Match Details -->
                                            <div class="mb-3">
                                                <h6 class="text-info mb-2"><i class="ti ti-chart-line me-1"></i>What Matched:</h6>
                                                <div class="row g-2 small">
                                                    <div class="col-sm-6">
                                                        {% if player.existing_player.name|lower == player.order_info.woo_name|lower %}
                                                            <span class="badge bg-success" data-badge><i class="ti ti-check me-1"></i>Name Match</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary" data-badge><i class="ti ti-x me-1"></i>Name Similar</span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-sm-6">
                                                        {% set db_phone = player.existing_player.phone|replace('-', '')|replace('(', '')|replace(')', '')|replace(' ', '')|replace('+', '')|replace('.', '') %}
                                                        {% set woo_phone = player.order_info.woo_phone|replace('-', '')|replace('(', '')|replace(')', '')|replace(' ', '')|replace('+', '')|replace('.', '') %}
                                                        {% if db_phone and db_phone|length == 11 and db_phone.startswith('1') %}
                                                            {% set db_phone = db_phone[1:] %}
                                                        {% endif %}
                                                        {% if woo_phone and woo_phone|length == 11 and woo_phone.startswith('1') %}
                                                            {% set woo_phone = woo_phone[1:] %}
                                                        {% endif %}
                                                        {% if player.existing_player.phone and player.order_info.woo_phone and db_phone == woo_phone %}
                                                            <span class="badge bg-success" data-badge><i class="ti ti-check me-1"></i>Phone Match</span>
                                                        {% else %}
                                                            <span class="badge bg-danger" data-badge><i class="ti ti-x me-1"></i>Phone Differs</span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12 mt-2">
                                                        <span class="badge bg-danger" data-badge><i class="ti ti-mail-x me-1"></i>Email Mismatch</span>
                                                        <span class="badge bg-info ms-2" data-badge>Confidence: {{ (player.match_details.confidence * 100)|round|int }}%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-5">
                                            <div class="resolution-actions">
                                                <h6 class="text-warning mb-3">
                                                    <i class="ti ti-tools me-1"></i>Resolution Options
                                                </h6>
                                                <div class="d-grid gap-2">
                                                    <button class="c-btn c-btn--success js-confirm-match" data-action="confirm-match" data-issue-id="{{ loop.index0 }}">
                                                        <i class="ti ti-check-circle me-1"></i> Confirm This Match
                                                        <div class="small">Keep database email as authoritative</div>
                                                    </button>
                                                    <button class="c-btn c-btn--warning js-create-separate" data-action="create-separate" data-issue-id="{{ loop.index0 }}">
                                                        <i class="ti ti-user-plus me-1"></i> Create Separate Player
                                                        <div class="small">These are different people</div>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="ti ti-circle-check text-success empty-state-icon"></i>
                                    <h4 class="text-success mt-3">No Email Mismatches!</h4>
                                    <p class="text-muted">All player emails match between database and WooCommerce.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Existing Players Tab -->
                    <div class="tab-pane fade" id="existing-players" role="tabpanel" data-tab-pane>
                        <div class="c-card__body">
                            {% if sync_data.player_league_updates|length > 0 %}
                                <div class="alert alert-info border-start border-info border-3 py-3 px-4 mb-4" data-alert>
                                    <div class="d-flex align-items-center">
                                        <i class="ti ti-user-check me-2 fs-4"></i>
                                        <div>
                                            <h6 class="alert-heading mb-1">Existing Players Found</h6>
                                            <p class="mb-0">These players already exist in the database and will have their status updated (active/inactive only).</p>
                                        </div>
                                    </div>
                                </div>

                                {% for update in sync_data.player_league_updates %}
                                <div class="issue-card issue-resolved border rounded p-4 mb-3">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <h6 class="mb-1">
                                                <i class="ti ti-user-check text-success me-2"></i>
                                                {{ update.buyer_info.name }}
                                            </h6>
                                            <small class="text-muted">
                                                <i class="ti ti-mail me-1"></i>{{ update.buyer_info.email }}<br>
                                                <i class="ti ti-phone me-1"></i>{{ update.buyer_info.phone }}
                                            </small>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="order-details">
                                                <strong>Order #{{ update.order_id }}</strong><br>
                                                <small>Qty: {{ update.quantity }}</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="match-details">
                                                <span class="badge bg-success" data-badge>{{ update.match_type }}</span>
                                                <small class="d-block text-muted mt-1">
                                                    Confidence: {{ "%.0f"|format(update.confidence * 100) }}%
                                                </small>
                                                {% if update.name_updated %}
                                                <div class="mt-1">
                                                    <span class="badge bg-warning" data-badge>Name Updated</span>
                                                    <small class="d-block text-muted mt-1">{{ update.name_update_reason }}</small>
                                                </div>
                                                {% endif %}
                                                {% if update.flags %}
                                                <div class="mt-1">
                                                    {% for flag in update.flags %}
                                                    <span class="badge bg-secondary badge-sm" data-badge>{{ flag }}</span>
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="ti ti-users text-muted empty-state-icon"></i>
                                    <h4 class="text-muted mt-3">No Existing Players Found</h4>
                                    <p class="text-muted">All orders are for new players or flagged for review.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Inactive Players Tab -->
                    <div class="tab-pane fade" id="inactive-players" role="tabpanel" data-tab-pane>
                        <div class="c-card__body">
                            {% if sync_data.players_to_inactivate|length > 0 %}
                                <div class="alert alert-warning border-start border-warning border-3 py-3 px-4 mb-4" data-alert>
                                    <div class="d-flex align-items-center">
                                        <i class="ti ti-user-off me-2 fs-4"></i>
                                        <div>
                                            <h6 class="alert-heading mb-1">Players to Mark Inactive</h6>
                                            <p class="mb-0">These players are currently active but have no current WooCommerce membership orders. They will be marked as inactive.</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">
                                                <strong>{{ sync_data.players_to_inactivate|length }}</strong> players will be marked inactive
                                            </span>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="confirmInactiveProcess" checked>
                                                <label class="form-check-label fw-semibold" for="confirmInactiveProcess">
                                                    Proceed with marking these players inactive
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% for player in sync_data.players_to_inactivate %}
                                <div class="issue-card inactive-player-card border rounded p-3 mb-3">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <h6 class="mb-1">
                                                <i class="ti ti-user-off text-warning me-2"></i>
                                                {{ player.player_name }}
                                            </h6>
                                            <small class="text-muted">
                                                <i class="ti ti-user me-1"></i>Username: {{ player.username }}<br>
                                                <i class="ti ti-shield me-1"></i>League: {{ player.league_name }}
                                            </small>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center">
                                                <span class="badge bg-success" data-badge>Currently Active</span>
                                                <div class="mt-2">
                                                    <i class="ti ti-arrow-down text-warning"></i>
                                                </div>
                                                <span class="badge bg-warning" data-badge>Will be Inactive</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-end">
                                                <small class="text-muted">
                                                    <i class="ti ti-info-circle me-1"></i>{{ player.reason }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="ti ti-circle-check text-success empty-state-icon"></i>
                                    <h4 class="text-success mt-3">No Players to Mark Inactive!</h4>
                                    <p class="text-muted">All currently active players have current WooCommerce memberships.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Final Review Tab -->
                    <div class="tab-pane fade" id="summary" role="tabpanel" data-tab-pane>
                        <div class="c-card__body">
                            <div id="commitValidation">
                                <div class="alert alert-warning border-start border-warning border-3 py-3 px-4" data-alert>
                                    <div class="d-flex align-items-center">
                                        <i class="ti ti-alert-circle me-2 fs-4"></i>
                                        <div>
                                            <h6 class="alert-heading mb-1">Issues Require Resolution</h6>
                                            <p class="mb-0">Please resolve all outstanding issues in the previous tabs before committing changes.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-none" id="readyToCommit">
                                <div class="commit-section">
                                    <h3 class="text-success mb-3">
                                        <i class="ti ti-circle-check me-2"></i>Ready to Commit Changes!
                                    </h3>
                                    <p class="mb-4">All issues have been resolved. The following changes will be applied to your database:</p>
                                    
                                    <div class="row text-start mb-4">
                                        <div class="col-md-6">
                                            <div class="c-card border-start border-success border-3">
                                                <div class="c-card__body">
                                                    <h6 class="c-card__title text-success">
                                                        <i class="ti ti-users me-1"></i>Player Updates
                                                    </h6>
                                                    <ul id="playerUpdatesSummary" class="list-unstyled mb-0">
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="c-card border-start border-info border-3">
                                                <div class="c-card__body">
                                                    <h6 class="c-card__title text-info">
                                                        <i class="ti ti-toggle-left me-1"></i>Status Changes
                                                    </h6>
                                                    <ul id="statusChangesSummary" class="list-unstyled mb-0">
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-check mb-4">
                                        <input class="form-check-input" type="checkbox" id="processInactiveCheck" checked>
                                        <label class="form-check-label fw-semibold" for="processInactiveCheck">
                                            Update Player Status Automatically
                                            <br><small class="text-muted">Mark players WITHOUT current memberships as inactive, and activate those WITH memberships</small>
                                        </label>
                                    </div>
                                    
                                    <button class="c-btn c-btn--success c-btn--lg js-commit-changes" id="finalCommitBtn" data-action="commit-changes">
                                        <i class="ti ti-database-import me-2"></i> Commit All Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block modals %}
{{ super() }}
<!-- Player Search Modal -->
<div class="modal c-modal fade" id="playerSearchModal" tabindex="-1" data-modal aria-labelledby="playerSearchModalLabel">
    <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content>
            <div class="modal-header c-modal__header" data-modal-header>
                <h5 class="modal-title c-modal__title" id="playerSearchModalLabel">
                    <i class="ti ti-search me-2"></i>Search for Existing Player
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body>
                <input type="text" class="form-control mb-3" id="playerSearchInput" placeholder="Type to search players by name or email..." data-form-control>
                <div id="playerSearchResults"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="{{ url_for('static', filename='custom_js/sync-review.js') }}"></script>
{% endif %}
<script>
// Initialize sync review module with server data
document.addEventListener('DOMContentLoaded', function() {
    if (typeof initSyncReview === 'function') {
        initSyncReview(
            {{ sync_data|tojson }},
            "{{ task_id }}",
            "{{ csrf_token() }}"
        );
    }
});
</script>
{% endblock %}

{% endblock %}