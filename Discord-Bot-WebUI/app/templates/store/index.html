{% extends "base.html" %}

{% block page_css %}

{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/store.css') }}" />
{% endif %}
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Page Header -->
    <div class="c-page-header" data-component="page-header">
        <div class="c-page-header__content">
            <h1 class="c-page-header__title">
                <i class="ti ti-shopping-cart me-2"></i>League Store
            </h1>
            <p class="c-page-header__description">
                Order league merchandise and equipment
                {% if current_season %}
                <br><small class="fw-medium">Current Season: {{ current_season.name }}</small>
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Navigation -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <a href="{{ url_for('store.my_orders') }}" class="c-btn c-btn--outline-primary me-2">
                        <i class="ti ti-list me-1"></i> My Orders
                    </a>
                    {% if user_roles and ('Pub League Admin' in user_roles or 'Global Admin' in user_roles) %}
                    <a href="{{ url_for('store.admin') }}" class="c-btn c-btn--warning">
                        <i class="ti ti-settings me-1"></i> Store Administration
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Season Order Status -->
    {% if has_ordered_this_season and current_season_order %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center" data-alert>
                <i class="ti ti-info-circle me-2"></i>
                <div>
                    <strong>You have already placed your order for {{ current_season.name }}!</strong><br>
                    <small>You ordered: <strong>{{ current_season_order.item.name if current_season_order.item else 'Unknown Item' }}</strong>
                    {% if current_season_order.selected_color %} in {{ current_season_order.selected_color }}{% endif %}
                    {% if current_season_order.selected_size %} ({{ current_season_order.selected_size }}){% endif %}
                    - Status: {{ current_season_order.status }}</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Orders (if any) -->
    {% if recent_orders %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__header border-bottom">
                    <h5 class="c-card__title mb-0">Recent Orders</h5>
                </div>
                <div class="c-card__body">
                    <div class="c-table-wrapper" data-table-responsive>
                        <table class="c-table c-table--compact" data-table>
                            <thead scope="col">
                                <tr>
                                    <th scope="col">Item</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Details</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Season</th>
                                    <th scope="col">Order Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in recent_orders %}
                                <tr>
                                    <td>{{ order.item.name if order.item else 'Unknown Item' }}</td>
                                    <td>{{ order.quantity }}</td>
                                    <td>
                                        {% if order.selected_color %}
                                        <span class="badge bg-label-info" data-badge>{{ order.selected_color }}</span>
                                        {% endif %}
                                        {% if order.selected_size %}
                                        <span class="badge bg-label-secondary" data-badge>{{ order.selected_size }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if order.status == 'PENDING' %}
                                        <span class="badge bg-label-warning" data-badge>Pending</span>
                                        {% elif order.status == 'PROCESSING' %}
                                        <span class="badge bg-label-info" data-badge>Processing</span>
                                        {% elif order.status == 'ORDERED' %}
                                        <span class="badge bg-label-primary" data-badge>Ordered</span>
                                        {% elif order.status == 'DELIVERED' %}
                                        <span class="badge bg-label-success" data-badge>Delivered</span>
                                        {% elif order.status == 'CANCELLED' %}
                                        <span class="badge bg-label-danger" data-badge>Cancelled</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ order.season.name if order.season else 'Unknown' }}</td>
                                    <td>{{ format_pacific_time_short(order.order_date) if order.order_date else '' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Store Items -->
    <div class="row">
        {% if items %}
        {% for item in items %}
        <div class="col-xl-4 col-lg-6 col-md-6 col-12 mb-4">
            <div class="c-card h-100 c-store-card" data-component="store-card" data-item-id="{{ item.id }}">
                {% if item.image_url %}
                <img src="{{ item.image_url }}" class="c-store-card__image" alt="{{ item.name }}">
                {% else %}
                <div class="c-store-card__placeholder">
                    <i class="ti ti-photo"></i>
                </div>
                {% endif %}

                <div class="c-card__body d-flex flex-column">
                    <div class="flex-grow-1">
                        <h5 class="c-store-card__title">{{ item.name }}</h5>
                        {% if item.category %}
                        <span class="badge bg-label-primary mb-2" data-badge>{{ item.category }}</span>
                        {% endif %}
                        {% if item.description %}
                        <p class="c-card__description">{{ item.description }}</p>
                        {% endif %}
                        
                        <!-- Available Options -->
                        <div class="mb-3">
                            {% if item.available_colors %}
                            {% set colors = item.available_colors | replace("'", '"') | fromjson %}
                            {% if colors %}
                            <h6 class="small mb-1">Available Colors:</h6>
                            <div class="mb-2">
                                {% for color in colors %}
                                <span class="badge bg-label-info me-1" data-badge>{{ color }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% endif %}
                            
                            {% if item.available_sizes %}
                            {% set sizes = item.available_sizes | replace("'", '"') | fromjson %}
                            {% if sizes %}
                            <h6 class="small mb-1">Available Sizes:</h6>
                            <div class="mb-2">
                                {% for size in sizes %}
                                <span class="badge bg-label-secondary me-1" data-badge>{{ size }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="c-store-card__actions">
                        {% if has_ordered_this_season %}
                        <button type="button" class="c-btn c-btn--secondary w-100" disabled>
                            <i class="ti ti-check me-1"></i> Already Ordered This Season
                        </button>
                        {% else %}
                        <button type="button" class="c-btn c-btn--primary w-100" data-bs-toggle="modal" data-bs-target="#orderModal{{ item.id }}" data-action="order-item">
                            <i class="ti ti-shopping-cart me-1"></i> Order Item
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Order Modal for this item -->
        <div class="modal c-modal fade" data-modal id="orderModal{{ item.id }}" tabindex="-1" aria-labelledby="orderModalLabel{{ item.id }}" aria-hidden="true">
            <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
                <div class="modal-content c-modal__content" data-modal-content>
                    <form class="c-order-form" data-component="order-form" data-form="place-order" data-item-id="{{ item.id }}">
                        <div class="modal-header c-modal__header bg-light" data-modal-header>
                            <h5 class="modal-title c-modal__title" id="orderModalLabel{{ item.id }}">
                                <i class="ti ti-shopping-cart me-2"></i>Order: {{ item.name }}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
                        </div>
                        <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="quantity" value="1">
                            
                            <div class="alert alert-info alert-sm mb-3" data-alert>
                                <i class="ti ti-info-circle me-1"></i>
                                <strong>Note:</strong> Both color and size selections are required for all orders.
                            </div>
                            
                            {% if item.available_colors %}
                            {% set colors = item.available_colors | replace("'", '"') | fromjson %}
                            {% else %}
                            {% set colors = [] %}
                            {% endif %}
                            
                            <div class="mb-3">
                                <label for="color{{ item.id }}" class="form-label">Color *</label>
                                <select class="form-select" id="color{{ item.id }}" name="color" required data-form-select>
                                    {% if colors|length == 0 %}
                                    <option value="N/A" selected>N/A (No color options)</option>
                                    {% elif colors|length == 1 %}
                                    <option value="{{ colors[0] }}" selected>{{ colors[0] }}</option>
                                    {% else %}
                                    <option value="">Select a color</option>
                                    {% for color in colors %}
                                    <option value="{{ color }}">{{ color }}</option>
                                    {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            
                            {% if item.available_sizes %}
                            {% set sizes = item.available_sizes | replace("'", '"') | fromjson %}
                            {% else %}
                            {% set sizes = [] %}
                            {% endif %}
                            
                            <div class="mb-3">
                                <label for="size{{ item.id }}" class="form-label">Size *</label>
                                <select class="form-select" id="size{{ item.id }}" name="size" required data-form-select>
                                    {% if sizes|length == 0 %}
                                    <option value="One Size" selected>One Size</option>
                                    {% elif sizes|length == 1 %}
                                    <option value="{{ sizes[0] }}" selected>{{ sizes[0] }}</option>
                                    {% else %}
                                    <option value="">Select a size</option>
                                    {% for size in sizes %}
                                    <option value="{{ size }}">{{ size }}</option>
                                    {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer c-modal__footer bg-light" data-modal-footer>
                            <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>
                                <i class="ti ti-x me-1"></i>Cancel
                            </button>
                            <button type="submit" class="c-btn c-btn--primary">
                                <i class="ti ti-shopping-cart me-1"></i>Place Order
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="c-card">
                <div class="c-card__body text-center py-5">
                    <i class="ti ti-shopping-cart-off text-muted mb-3 store-empty-icon"></i>
                    <h4 class="text-muted">No Items Available</h4>
                    <p class="text-muted">There are currently no items available in the store.</p>
                    {% if user_roles and ('Pub League Admin' in user_roles or 'Global Admin' in user_roles) %}
                    <a href="{{ url_for('store.admin') }}" class="c-btn c-btn--primary">
                        <i class="ti ti-plus me-1"></i>Add Items
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle order form submissions using data-form attribute
    const orderForms = document.querySelectorAll('[data-form="place-order"]');
    orderForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const itemId = this.dataset.itemId;
            const formData = new FormData(this);
            const modalId = `orderModal${itemId}`;
            const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));

            // Validate color selection
            const colorSelect = this.querySelector(`#color${itemId}`);
            const sizeSelect = this.querySelector(`#size${itemId}`);

            if (colorSelect && !colorSelect.value) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Color Required',
                    text: 'Please select a color for this item.'
                });
                colorSelect.focus();
                return;
            }

            if (sizeSelect && !sizeSelect.value) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Size Required',
                    text: 'Please select a size for this item.'
                });
                sizeSelect.focus();
                return;
            }

            // Show loading
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-1" role="status" data-spinner></div>Ordering...';

            fetch(`{{ url_for('store.place_order', item_id=0) }}`.replace('0', itemId), {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Order Placed!',
                        text: data.message
                    }).then(() => {
                        modal.hide();
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Order Failed',
                        text: data.message
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while placing your order.'
                });
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    });
});
</script>
{% endblock %}