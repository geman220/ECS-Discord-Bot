{% extends "base.html" %}

{% block page_css %}

{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/store.css') }}" />
{% endif %}
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Page Header -->
    <div class="c-admin-header" data-component="admin-header">
        <div class="c-admin-header__content">
            <h1 class="c-admin-header__title">
                <i class="ti ti-settings me-2"></i>Store Administration
            </h1>
            <p class="c-admin-header__description">Manage store items and orders</p>
        </div>
    </div>

    <!-- Navigation -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-action-bar" data-component="action-bar">
                <div class="c-action-bar__group">
                    <a href="{{ url_for('store.index') }}" class="c-btn c-btn--outline-primary me-2">
                        <i class="ti ti-arrow-left me-1"></i> Back to Store
                    </a>
                    <button type="button" class="c-btn c-btn--success" data-bs-toggle="modal" data-bs-target="#createItemModal" data-action="create-item">
                        <i class="ti ti-plus me-1"></i> Add New Item
                    </button>
                    <button type="button" class="c-btn c-btn--warning ms-2" data-bs-toggle="modal" data-bs-target="#resetOrderingModal" data-action="reset-season">
                        <i class="ti ti-refresh me-1"></i> Reset Season Ordering
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Store Items Management -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-card" data-component="store-items-table">
                <div class="c-card__header border-bottom">
                    <h5 class="c-card__title mb-0">Store Items</h5>
                </div>
                <div class="c-table-wrapper" data-table-responsive>
                    <table class="c-c-table c-table--hoverable mb-0" data-table data-mobile-table data-table-type="orders">
                        <thead class="c-table--light" scope="col">
                            <tr>
                                <th scope="col">Item</th>
                                <th scope="col">Category</th>
                                <th scope="col">Price</th>
                                <th scope="col">Options</th>
                                <th scope="col">Status</th>
                                <th scope="col">Created</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr data-item-id="{{ item.id }}">
                                <td data-label="Item">
                                    <div class="c-store-item" data-component="store-item">
                                        {% if item.image_url %}
                                        <img src="{{ item.image_url }}" alt="{{ item.name }}" class="c-store-item__image">
                                        {% else %}
                                        <div class="c-store-item__placeholder">
                                            <i class="ti ti-photo"></i>
                                        </div>
                                        {% endif %}
                                        <div class="c-store-item__details">
                                            <h6 class="c-store-item__name">{{ item.name }}</h6>
                                            {% if item.description %}
                                            <small class="c-store-item__description">{{ item.description[:50] }}{% if item.description|length > 50 %}...{% endif %}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td data-label="Category">
                                    {% if item.category %}
                                    <span class="badge bg-label-primary" data-badge>{{ item.category }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td data-label="Price">
                                    {% if item.price %}
                                    <span class="fw-medium">${{ "%.2f"|format(item.price) }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td data-label="Options">
                                    {% if item.available_colors %}
                                    {% set colors = item.available_colors | replace("'", '"') | fromjson %}
                                    <small class="text-muted">Colors: {{ colors|length }}</small><br>
                                    {% endif %}
                                    {% if item.available_sizes %}
                                    {% set sizes = item.available_sizes | replace("'", '"') | fromjson %}
                                    <small class="text-muted">Sizes: {{ sizes|length }}</small>
                                    {% endif %}
                                    {% if not item.available_colors and not item.available_sizes %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td data-label="Status">
                                    {% if item.is_active %}
                                    <span class="badge bg-label-success" data-badge>Active</span>
                                    {% else %}
                                    <span class="badge bg-label-danger" data-badge>Inactive</span>
                                    {% endif %}
                                </td>
                                <td data-label="Created">
                                    {{ format_pacific_time_short(item.created_at) if item.created_at else '' }}<br>
                                    <small class="text-muted">by {{ item.creator.username if item.creator else 'Unknown' }}</small>
                                </td>
                                <td data-label="Actions">
                                    <div class="dropdown">
                                        <button class="c-btn c-btn--sm c-btn--icon-only btn-text-secondary rounded-pill dropdown-toggle hide-arrow" type="button" data-bs-toggle="dropdown" data-dropdown-toggle aria-label="More options"><i class="ti ti-dots-vertical"></i></button>
                                        <ul class="dropdown-menu dropdown-menu-end" data-dropdown-menu>
                                            <li>
                                                <a class="dropdown-item" href="{{ url_for('store.edit_item', item_id=item.id) }}" data-action="edit">
                                                    <i class="ti ti-edit me-2"></i>Edit
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item text-danger delete-item-btn" href="#" data-action="delete-item" data-item-id="{{ item.id }}" data-item-name="{{ item.name }}">
                                                    <i class="ti ti-trash me-2"></i>Delete
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Management -->
    <div class="row">
        <div class="col-12">
            <div class="c-card" data-component="orders-table">
                <div class="c-card__header border-bottom">
                    <div class="c-orders-header" data-component="orders-header">
                        <h5 class="c-orders-header__title">Recent Orders</h5>
                        <div class="c-orders-header__actions">
                            <select id="bulk-status-select" class="form-select form-select-sm c-bulk-select" data-form-select data-action="bulk-status-select">
                                <option value="">Bulk Update Status</option>
                                <option value="PENDING">Mark as Pending</option>
                                <option value="PROCESSING">Mark as Processing</option>
                                <option value="ORDERED">Mark as Ordered</option>
                                <option value="DELIVERED">Mark as Delivered</option>
                                <option value="CANCELLED">Mark as Cancelled</option>
                            </select>
                            <button type="button" class="c-btn c-btn--sm c-btn--primary" id="bulk-update-btn" disabled data-action="bulk-update">
                                <i class="ti ti-check me-1"></i>Update Selected
                            </button>
                            <button type="button" class="c-btn c-btn--sm c-btn--danger" id="bulk-delete-btn" disabled data-action="bulk-delete">
                                <i class="ti ti-trash me-1"></i>Delete Selected
                            </button>
                        </div>
                    </div>
                </div>
                <div class="c-table-wrapper" data-table-responsive>
                    <table class="c-c-table c-table--hoverable mb-0" data-table data-mobile-table data-table-type="orders">
                        <thead class="c-table--light" scope="col">
                            <tr>
                                <th scope="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="select-all-orders">
                                        <label class="form-check-label" for="select-all-orders"></label>
                                    </div>
                                </th>
                                <th scope="col">Order ID</th>
                                <th scope="col">Customer</th>
                                <th scope="col">Item</th>
                                <th scope="col">Details</th>
                                <th scope="col">Status</th>
                                <th scope="col">Order Date</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr data-order-id="{{ order.id }}">
                                <td data-label="Select">
                                    <div class="form-check">
                                        <input class="form-check-input order-checkbox" type="checkbox" value="{{ order.id }}" id="order-{{ order.id }}" data-action="select-order">
                                        <label class="form-check-label" for="order-{{ order.id }}"></label>
                                    </div>
                                </td>
                                <td data-label="Order ID" class="c-order__id">#{{ order.id }}</td>
                                <td data-label="Customer" class="c-order__customer">{{ order.orderer.username if order.orderer else 'Unknown' }}</td>
                                <td data-label="Item">
                                    <div class="c-order__item">
                                        <strong class="c-order__item-name">{{ order.item.name if order.item else 'Unknown Item' }}</strong>
                                        <br><small class="c-order__item-qty">Qty: {{ order.quantity }}</small>
                                    </div>
                                </td>
                                <td data-label="Details">
                                    {% if order.selected_color %}
                                    <span class="badge bg-label-info me-1" data-badge>{{ order.selected_color }}</span>
                                    {% endif %}
                                    {% if order.selected_size %}
                                    <span class="badge bg-label-secondary me-1" data-badge>{{ order.selected_size }}</span>
                                    {% endif %}
                                    {% if order.notes %}
                                    <br><small class="text-muted">{{ order.notes[:30] }}{% if order.notes|length > 30 %}...{% endif %}</small>
                                    {% endif %}
                                </td>
                                <td data-label="Status">
                                    <select class="form-select form-select-sm c-order-status" data-action="update-order-status" data-order-id="{{ order.id }}" data-current-status="{{ order.status }}" data-form-select>
                                        <option value="PENDING" {% if order.status == 'PENDING' %}selected{% endif %}>Pending</option>
                                        <option value="PROCESSING" {% if order.status == 'PROCESSING' %}selected{% endif %}>Processing</option>
                                        <option value="ORDERED" {% if order.status == 'ORDERED' %}selected{% endif %}>Ordered</option>
                                        <option value="DELIVERED" {% if order.status == 'DELIVERED' %}selected{% endif %}>Delivered</option>
                                        <option value="CANCELLED" {% if order.status == 'CANCELLED' %}selected{% endif %}>Cancelled</option>
                                    </select>
                                </td>
                                <td data-label="Order Date" class="c-order__date">
                                    {{ format_pacific_time_short(order.order_date) if order.order_date else '' }}
                                    {% if order.processed_by %}
                                    <br><small class="c-order__processor">Processed by {{ order.processor.username if order.processor else 'Unknown' }}</small>
                                    {% endif %}
                                </td>
                                <td data-label="Actions">
                                    <div class="c-order__actions">
                                        <button type="button" class="c-btn c-btn--sm c-btn--outline-info view-order-btn" data-action="view-order" data-order-id="{{ order.id }}" title="View Order">
                                            <i class="ti ti-eye"></i>
                                        </button>
                                        <button type="button" class="c-btn c-btn--sm c-btn--outline-danger delete-order-btn"
                                                data-action="delete-order"
                                                data-order-id="{{ order.id }}"
                                                data-order-info="Order #{{ order.id }} for {{ order.item.name if order.item else 'Unknown Item' }}"
                                                data-customer-name="{{ order.orderer.username if order.orderer else 'Unknown Customer' }}"
                                                title="Delete Order">
                                            <i class="ti ti-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
{{ super() }}
<!-- Create Item Modal -->
<div class="modal c-modal fade" data-modal id="createItemModal" tabindex="-1" aria-labelledby="createItemModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content data-modal-content>
            <form id="createItemForm" enctype="multipart/form-data">
                <div class="modal-header c-modal__header bg-light" data-modal-header>
                    <h5 class="modal-title c-modal__title" id="createItemModalLabel">
                        <i class="ti ti-plus me-2"></i>Add New Store Item
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
                </div>
                <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="store-admin-item-name" class="form-label">Item Name *</label>
                                <input type="text" class="form-control" id="store-admin-item-name" name="name" required
                                       placeholder="e.g. 0857 Pioneer Pullover" data-form-control>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="price" class="form-label">Price (Admin Only)</label>
                                <div class="input-group" data-input-group>
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="price" name="price"
                                           step="0.01" min="0" placeholder="15.00" data-form-control>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="store-admin-item-description" class="form-label">Description</label>
                        <textarea class="form-control" id="store-admin-item-description" name="description" rows="3"
                                  placeholder="Describe the item, materials, features, etc." data-form-control></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <input type="text" class="form-control" id="category" name="category"
                               placeholder="e.g. Apparel, Equipment, Accessories" data-form-control>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Image</label>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="image_file" class="form-label">Upload Image</label>
                                <input type="file" class="form-control" id="image_file" name="image_file"
                                       accept="image/*" data-form-control>
                                <div class="form-text">Upload an image file</div>
                            </div>
                            <div class="col-md-6">
                                <label for="image_url" class="form-label">Or Image URL</label>
                                <input type="url" class="form-control" id="image_url" name="image_url"
                                       placeholder="https://example.com/image.jpg" data-form-control>
                                <div class="form-text">Provide a direct link to an image</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Available Colors</label>
                                <div id="colors-container">
                                    <div class="input-group mb-2" data-input-group>
                                        <input type="text" class="form-control" name="colors[]" placeholder="e.g. Navy, Black, White" data-form-control aria-label="e.g. Navy, Black, White">
                                        <button type="button" class="c-btn c-btn--outline-danger remove-color d-none" aria-label="Button"><i class="ti ti-x"></i></button>
                                    </div>
                                </div>
                                <button type="button" class="c-btn c-btn--sm c-btn--outline-primary" id="add-color">
                                    <i class="ti ti-plus me-1"></i>Add Color
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Available Sizes</label>
                                <div id="sizes-container">
                                    <div class="input-group mb-2" data-input-group>
                                        <input type="text" class="form-control" name="sizes[]" placeholder="e.g. YXS, YS, YM, YL, AS, AM, AL" data-form-control aria-label="e.g. YXS, YS, YM, YL, AS, AM, AL">
                                        <button type="button" class="c-btn c-btn--outline-danger remove-size d-none" aria-label="Button"><i class="ti ti-x"></i></button>
                                    </div>
                                </div>
                                <button type="button" class="c-btn c-btn--sm c-btn--outline-primary" id="add-size">
                                    <i class="ti ti-plus me-1"></i>Add Size
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer c-modal__footer bg-light" data-modal-footer>
                    <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>
                        <i class="ti ti-x me-1"></i>Cancel
                    </button>
                    <button type="submit" class="c-btn c-btn--success">
                        <i class="ti ti-device-floppy me-1"></i>Create Item
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reset Season Ordering Modal -->
<div class="modal c-modal fade" data-modal id="resetOrderingModal" tabindex="-1" aria-labelledby="resetOrderingModalLabel" aria-hidden="true">
    <div class="modal-dialog c-modal__dialog modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content" data-modal-content data-modal-content>
            <div class="modal-header c-modal__header bg-warning-subtle" data-modal-header>
                <h5 class="modal-title c-modal__title" id="resetOrderingModalLabel">
                    <i class="ti ti-refresh me-2"></i>Reset Season Ordering
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss aria-label="Close"></button>
            </div>
            <div class="modal-body c-modal__body" data-modal-body data-modal-body>
                <div class="alert alert-warning" data-alert>
                    <i class="ti ti-alert-triangle me-2"></i>
                    <strong>Warning:</strong> This action will allow all coaches to place new orders for the current season,
                    even if they have already placed an order. Use this at the beginning of a new season.
                </div>

                <p class="mb-3">Choose how to reset ordering eligibility:</p>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="resetType" id="resetAll" value="all" checked>
                    <label class="form-check-label" for="resetAll">
                        <strong>Delete all orders for current season</strong><br>
                        <small class="text-muted">This will permanently delete all orders for the current season and allow everyone to order again.</small>
                    </label>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="resetType" id="resetEligibility" value="eligibility">
                    <label class="form-check-label" for="resetEligibility">
                        <strong>Reset eligibility only</strong><br>
                        <small class="text-muted">Keep existing orders but allow coaches to place additional orders (useful for special promotions).</small>
                    </label>
                </div>
            </div>
            <div class="modal-footer c-modal__footer bg-warning-subtle" data-modal-footer>
                <button type="button" class="c-btn c-btn--outline-secondary" data-bs-dismiss="modal" data-dismiss>
                    <i class="ti ti-x me-1"></i>Cancel
                </button>
                <button type="button" class="c-btn c-btn--warning" id="confirmResetBtn">
                    <i class="ti ti-refresh me-1"></i>Reset Season Ordering
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{{ super() }}
<!-- Store Admin Module loaded via Vite in production, or directly in development -->
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script type="module" src="{{ url_for('static', filename='custom_js/store-admin.js') }}"></script>
{% endif %}
{% endblock %}