{% extends "base_flowbite.html" %}
{% from 'macros/flowbite.html' import card, button, badge, avatar, stat_card, alert %}

{% block title %}{{ player.name }} - Player Profile{% endblock %}

{% block main_content %}
<!-- Player Header -->
<div class="bg-gradient-to-r from-ecs-green to-ecs-green/80 rounded-xl mb-6 overflow-hidden">
    <div class="p-6 md:p-8">
        <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
            <!-- Profile Picture -->
            <div class="relative flex-shrink-0">
                <div class="w-24 h-24 md:w-32 md:h-32 rounded-full ring-4 ring-white/30 overflow-hidden bg-white/20">
                    {% if player.profile_picture_url %}
                    <img src="{{ player.profile_picture_url }}?v={{ player.updated_at.timestamp() if player.updated_at else '0' }}"
                         class="w-full h-full object-cover" alt="Profile Picture">
                    {% else %}
                    <img src="{{ url_for('static', filename='img/default_player.png') }}"
                         class="w-full h-full object-cover" alt="Default Profile Picture">
                    {% endif %}
                </div>
                <!-- Badges -->
                <div class="absolute -bottom-1 -right-1 flex gap-1">
                    {% if player.is_coach %}
                    <span class="w-8 h-8 rounded-full bg-yellow-500 flex items-center justify-center text-white shadow-lg" title="Coach">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                    </span>
                    {% endif %}
                    {% if player.is_ref %}
                    <span class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white shadow-lg" title="Referee">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path></svg>
                    </span>
                    {% endif %}
                </div>
                <!-- Online Status -->
                <span class="absolute top-0 right-0 w-4 h-4 rounded-full {{ 'bg-green-500' if player_is_online else 'bg-gray-400' }} ring-2 ring-white"
                      data-online-status="{{ player.user_id }}" title="{{ 'Online' if player_is_online else 'Offline' }}"></span>
            </div>

            <!-- Player Info -->
            <div class="flex-1 text-center md:text-left">
                <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">{{ player.name }}</h1>

                {% if can_view_detailed_profile or is_own_profile or is_admin %}
                <div class="flex flex-wrap justify-center md:justify-start gap-2 mb-4">
                    {% if current_season_teams and current_season_teams|length > 0 %}
                    {% for t in current_season_teams %}
                    <a href="{{ url_for('teams.team_details', team_id=t.id) }}" class="inline-flex items-center px-3 py-1 rounded-full bg-white/20 text-white text-sm hover:bg-white/30 transition-colors">
                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        {{ t.name }}
                    </a>
                    {% endfor %}
                    {% else %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full bg-white/10 text-white/70 text-sm">
                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                        No Team
                    </span>
                    {% endif %}
                </div>
                {% elif profile_is_restricted %}
                <div class="mb-4">
                    <span class="inline-flex items-center px-3 py-1 rounded-full bg-white/10 text-white/70 text-sm">
                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        Profile is Private
                    </span>
                </div>
                {% endif %}

                <!-- Action Buttons -->
                <div class="flex flex-wrap justify-center md:justify-start gap-2">
                    {% if safe_current_user.is_authenticated and player.user_id and player.user_id != safe_current_user.id %}
                    <a href="{{ url_for('messages_pages.messages_inbox', user=player.user_id) }}" class="inline-flex items-center px-4 py-2 text-sm font-medium text-ecs-green bg-white rounded-lg hover:bg-gray-100 focus:ring-4 focus:ring-white/30">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        Message
                    </a>
                    {% endif %}

                    {% if is_admin or is_player %}
                    <button type="button" data-modal-target="profileImageModal" data-modal-toggle="profileImageModal" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-white/20 rounded-lg hover:bg-white/30 focus:ring-4 focus:ring-white/30">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Upload Photo
                    </button>
                    {% endif %}

                    {% if is_admin or 'Pub League Coach' in user_roles %}
                    {% set has_email = user.email and user.email_notifications %}
                    {% set has_sms = player.phone and user.sms_notifications %}
                    {% set has_discord = player.discord_id and user.discord_notifications %}
                    {% if has_email or has_sms or has_discord %}
                    <button type="button" data-modal-target="contactPlayerModal" data-modal-toggle="contactPlayerModal" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-white/20 rounded-lg hover:bg-white/30 focus:ring-4 focus:ring-white/30">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        Contact
                    </button>
                    {% endif %}
                    {% endif %}

                    {% if not player.discord_id and safe_current_user.is_authenticated and safe_current_user.id == player.user.id %}
                    <a href="{{ url_for('auth.discord_login') }}" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300">
                        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/></svg>
                        Link Discord
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column -->
    <div class="lg:col-span-1 space-y-6">
        <!-- Contact Info Card -->
        {% if can_view_contact_info or is_own_profile %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Contact Information</h3>
            </div>
            <div class="p-4 space-y-4">
                {% if can_view_contact_info %}
                <div class="flex items-center">
                    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center">
                        <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-500 dark:text-gray-400">Email</p>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">{{ user.email }}</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-cyan-100 dark:bg-cyan-900/50 flex items-center justify-center">
                        <svg class="w-5 h-5 text-cyan-600 dark:text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-500 dark:text-gray-400">Phone</p>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">{{ player.phone or 'Not provided' }}</p>
                    </div>
                </div>
                {% endif %}
                <div class="flex items-center">
                    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/50 flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-500 dark:text-gray-400">Jersey Size</p>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">{{ player.jersey_size or 'Not set' }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Profile Verification Card -->
        {% if is_own_profile or 'Pub League Admin' in user_roles or 'Global Admin' in user_roles or 'Pub League Coach' in user_roles %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Profile Status</h3>
            </div>
            <div class="p-4">
                {% if player.profile_last_updated %}
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/50 flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-500 dark:text-gray-400">Last Updated</p>
                        <p class="text-sm font-medium text-green-600 dark:text-green-400">{{ format_pacific_time(player.profile_last_updated) }}</p>
                    </div>
                </div>
                {% else %}
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-yellow-100 dark:bg-yellow-900/50 flex items-center justify-center">
                        <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-500 dark:text-gray-400">Profile Status</p>
                        <p class="text-sm font-medium text-yellow-600 dark:text-yellow-400">
                            {% if is_own_profile %}Please verify your profile{% else %}Not verified{% endif %}
                        </p>
                    </div>
                </div>
                {% endif %}

                {% if is_own_profile %}
                <button type="button" data-action="verify-profile" data-player-id="{{ player.id }}" class="w-full inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green/90 focus:ring-4 focus:ring-ecs-green/50">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    {% if player.profile_last_updated %}Confirm Profile is Accurate{% else %}Verify My Profile{% endif %}
                </button>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400 text-center">Click to confirm your profile information is current</p>
                {% endif %}

                {% if not player.profile_last_updated %}
                <div class="mt-4 p-3 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-red-900/50 dark:text-red-300">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    {% if is_own_profile %}Your profile needs verification{% else %}Player needs to verify their profile{% endif %}
                </div>
                {% elif profile_expired %}
                <div class="mt-4 p-3 text-sm text-yellow-800 rounded-lg bg-yellow-50 dark:bg-yellow-900/50 dark:text-yellow-300">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    Profile verification expired
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Stats Card -->
        {% if has_permission('view_player_goals_assists') or has_permission('view_player_cards') %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Player Statistics</h3>
            </div>
            <div class="p-4">
                <!-- Season Stats -->
                <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">Season Stats ({{ season.name }})</h4>
                <div class="grid grid-cols-4 gap-2 mb-6">
                    <div class="text-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <div class="text-xl">&#9917;</div>
                        <div class="text-lg font-bold text-gray-900 dark:text-white">{{ player.season_goals(season.id) }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Goals</div>
                    </div>
                    <div class="text-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <div class="text-xl">&#127344;&#65039;</div>
                        <div class="text-lg font-bold text-gray-900 dark:text-white">{{ player.season_assists(season.id) }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Assists</div>
                    </div>
                    <div class="text-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <div class="text-xl">&#128995;</div>
                        <div class="text-lg font-bold text-gray-900 dark:text-white">{{ player.season_yellow_cards(season.id) }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Yellow</div>
                    </div>
                    <div class="text-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <div class="text-xl">&#128997;</div>
                        <div class="text-lg font-bold text-gray-900 dark:text-white">{{ player.season_red_cards(season.id) }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Red</div>
                    </div>
                </div>

                <!-- Career Stats -->
                <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">Career Stats</h4>
                <div class="grid grid-cols-4 gap-2">
                    <div class="text-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <div class="text-xl">&#9917;</div>
                        <div class="text-lg font-bold text-gray-900 dark:text-white">{{ player.get_career_goals() }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Goals</div>
                    </div>
                    <div class="text-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <div class="text-xl">&#127344;&#65039;</div>
                        <div class="text-lg font-bold text-gray-900 dark:text-white">{{ player.get_career_assists() }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Assists</div>
                    </div>
                    <div class="text-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <div class="text-xl">&#128995;</div>
                        <div class="text-lg font-bold text-gray-900 dark:text-white">{{ player.get_career_yellow_cards() }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Yellow</div>
                    </div>
                    <div class="text-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <div class="text-xl">&#128997;</div>
                        <div class="text-lg font-bold text-gray-900 dark:text-white">{{ player.get_career_red_cards() }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Red</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Team History Card -->
        {% if can_view_team_history or is_own_profile or is_admin %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Team History</h3>
            </div>
            <div class="divide-y divide-gray-200 dark:divide-gray-700">
                {% if team_history %}
                {% for pts in team_history %}
                <div class="p-4 flex items-center justify-between">
                    <div>
                        <a href="{{ url_for('teams.team_details', team_id=pts.team.id) }}" class="font-medium text-gray-900 dark:text-white hover:text-ecs-green dark:hover:text-ecs-green">
                            {{ pts.team.name }}
                        </a>
                        {% if can_view_draft_history %}
                        {% set draft_key = pts.season.name + '_league_' + pts.team.league_id|string %}
                        {% if draft_history and draft_history.get(draft_key) %}
                        <span class="ml-2 px-2 py-0.5 text-xs font-medium text-blue-800 bg-blue-100 rounded dark:bg-blue-900/50 dark:text-blue-300">#{{ draft_history[draft_key] }}</span>
                        {% endif %}
                        {% endif %}
                        <p class="text-sm text-gray-500 dark:text-gray-400">{{ pts.season.name }}</p>
                    </div>
                    {% if pts.season.is_current %}
                    <span class="px-2.5 py-0.5 text-xs font-medium text-green-800 bg-green-100 rounded dark:bg-green-900/50 dark:text-green-300">Current</span>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <div class="p-8 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">No team history available</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Private Profile Message -->
        {% if profile_is_restricted and not is_own_profile and not is_admin %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-8 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            <h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-white">Private Profile</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">This player has set their profile to private. Only their name and photo are visible.</p>
        </div>
        {% endif %}

        <!-- Admin Actions -->
        {% if can_edit_stats %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <button type="button" class="w-full p-4 flex items-center justify-between text-left" data-collapse-toggle="adminActionsCollapse">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Admin Actions</h3>
                <svg class="w-5 h-5 text-gray-500 transform transition-transform" id="adminCollapseIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div class="hidden border-t border-gray-200 dark:border-gray-700" id="adminActionsCollapse">
                <div class="p-4 space-y-4">
                    <form method="POST" action="{{ url_for('players.player_profile', player_id=player.id) }}">
                        {{ form.csrf_token }}
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" name="is_coach" {% if player.is_coach %}checked{% endif %} class="sr-only peer" onchange="this.form.submit()">
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-ecs-green/50 dark:peer-focus:ring-ecs-green/50 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-ecs-green"></div>
                            <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300">Mark as Coach</span>
                        </label>
                        <input type="hidden" name="update_coach_status" value="1">
                    </form>
                    <form method="POST" action="{{ url_for('players.player_profile', player_id=player.id) }}">
                        {{ form.csrf_token }}
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" name="is_ref" {% if player.is_ref %}checked{% endif %} class="sr-only peer" onchange="this.form.submit()">
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-ecs-green/50 dark:peer-focus:ring-ecs-green/50 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-ecs-green"></div>
                            <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300">Mark as Referee</span>
                        </label>
                        <input type="hidden" name="update_ref_status" value="1">
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Right Column -->
    <div class="lg:col-span-2">
        {% if can_view_detailed_profile or can_edit_profile or can_view_contact_info or is_own_profile or is_admin %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <!-- Tabs -->
            <div class="border-b border-gray-200 dark:border-gray-700">
                <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="profileTabs" role="tablist">
                    <li class="mr-2" role="presentation">
                        <button class="inline-block p-4 border-b-2 border-ecs-green text-ecs-green" id="details-tab" data-tabs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            Player Details
                        </button>
                    </li>
                    {% if can_edit_stats %}
                    <li class="mr-2" role="presentation">
                        <button class="inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" id="admin-tab" data-tabs-target="#admin" type="button" role="tab" aria-controls="admin" aria-selected="false">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            Admin Settings
                        </button>
                    </li>
                    {% endif %}
                </ul>
            </div>

            <!-- Tab Content -->
            <div id="profileTabContent">
                <!-- Details Tab -->
                <div class="p-6" id="details" role="tabpanel" aria-labelledby="details-tab">
                    {% if safe_current_user.id == player.user.id or is_admin %}
                    <!-- Editable Contact Section -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Contact Information</h4>
                            <button type="button" class="text-sm text-ecs-green hover:text-ecs-green/80" data-action="edit-toggle" data-section="contact-info">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                Edit
                            </button>
                        </div>
                        <form method="POST" enctype="multipart/form-data" id="contact-info-form">
                            {{ form.hidden_tag() }}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name</label>
                                    <div class="view-mode text-gray-900 dark:text-white py-2">{{ player.name }}</div>
                                    <div class="edit-mode hidden">
                                        {{ form.name(class_="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white", required=True) }}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                                    <div class="view-mode text-gray-900 dark:text-white py-2">{{ user.email }}</div>
                                    <div class="edit-mode hidden">
                                        {{ form.email(class_="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white", required=True) }}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone</label>
                                    <div class="view-mode text-gray-900 dark:text-white py-2">{{ player.phone or 'Not provided' }}</div>
                                    <div class="edit-mode hidden">
                                        {{ form.phone(class_="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white") }}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jersey Size</label>
                                    <div class="view-mode text-gray-900 dark:text-white py-2">{{ player.jersey_size or 'Not set' }}</div>
                                    <div class="edit-mode hidden">
                                        {{ form.jersey_size(class_="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white") }}
                                    </div>
                                </div>
                            </div>
                            <div class="edit-mode hidden mt-4 flex gap-2">
                                <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600" data-action="cancel-edit" data-section="contact-info">Cancel</button>
                                <button type="submit" name="update_profile" class="px-4 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green/90">Save Changes</button>
                            </div>
                        </form>
                    </div>

                    <!-- Player Preferences Section -->
                    <div class="mb-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Player Preferences</h4>
                            <button type="button" class="text-sm text-ecs-green hover:text-ecs-green/80" data-action="edit-toggle" data-section="player-prefs">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                Edit
                            </button>
                        </div>
                        <form method="POST" enctype="multipart/form-data" id="player-prefs-form">
                            {{ form.hidden_tag() }}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pronouns</label>
                                    <div class="view-mode text-gray-900 dark:text-white py-2">{{ player.pronouns or 'Not set' }}</div>
                                    <div class="edit-mode hidden">
                                        {{ form.pronouns(class_="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white") }}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Expected Availability</label>
                                    <div class="view-mode text-gray-900 dark:text-white py-2">{{ player.expected_weeks_available or 'Not set' }}</div>
                                    <div class="edit-mode hidden">
                                        {{ form.expected_weeks_available(class_="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white") }}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Favorite Position</label>
                                    <div class="view-mode text-gray-900 dark:text-white py-2">{{ format_position(player.favorite_position) if player.favorite_position else 'Not set' }}</div>
                                    <div class="edit-mode hidden">
                                        {{ form.favorite_position(class_="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white") }}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Goalkeeper Frequency</label>
                                    {% set goal_frequency_map = {
                                    '0': 'Never',
                                    '1': 'Only if needed',
                                    '2': 'Fill in as needed',
                                    '3': 'Half the time',
                                    '4': 'Every game'
                                    } %}
                                    <div class="view-mode text-gray-900 dark:text-white py-2">{{ goal_frequency_map.get(player.frequency_play_goal|string, 'Not set') }}</div>
                                    <div class="edit-mode hidden">
                                        {{ form.frequency_play_goal(class_="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-ecs-green focus:border-ecs-green block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white") }}
                                    </div>
                                </div>
                            </div>
                            <div class="edit-mode hidden mt-4 flex gap-2">
                                <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600" data-action="cancel-edit" data-section="player-prefs">Cancel</button>
                                <button type="submit" name="update_profile" class="px-4 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green/90">Save Changes</button>
                            </div>
                        </form>
                    </div>

                    {% if can_view_admin_notes or is_own_profile %}
                    <!-- Player Notes Section -->
                    <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Player Notes</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400">{% if is_own_profile %}Notes to share with coaches/admins{% else %}Notes from the player{% endif %}</p>
                            </div>
                            <button type="button" class="text-sm text-ecs-green hover:text-ecs-green/80" data-action="edit-toggle" data-section="player-notes">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                Edit
                            </button>
                        </div>
                        <form method="POST" enctype="multipart/form-data" id="player-notes-form">
                            {{ form.hidden_tag() }}
                            <div class="view-mode p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-gray-900 dark:text-white">
                                {{ player.player_notes or 'No notes available' }}
                            </div>
                            <div class="edit-mode hidden">
                                {{ form.player_notes(class_="block w-full p-2.5 text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-ecs-green focus:border-ecs-green dark:bg-gray-700 dark:border-gray-600 dark:text-white", rows=3) }}
                                <div class="mt-4 flex gap-2">
                                    <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600" data-action="cancel-edit" data-section="player-notes">Cancel</button>
                                    <button type="submit" name="update_profile" class="px-4 py-2 text-sm font-medium text-white bg-ecs-green rounded-lg hover:bg-ecs-green/90">Save Notes</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    {% endif %}

                    {% else %}
                    <!-- Read-only view for non-owners -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Pronouns</p>
                                <p class="text-gray-900 dark:text-white">{{ player.pronouns or 'Not set' }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Favorite Position</p>
                                <p class="text-gray-900 dark:text-white">{{ format_position(player.favorite_position) if player.favorite_position else 'Not set' }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Expected Availability</p>
                                <p class="text-gray-900 dark:text-white">{{ player.expected_weeks_available or 'Not set' }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                {% if can_edit_stats %}
                <!-- Admin Tab (hidden by default) -->
                <div class="hidden p-6" id="admin" role="tabpanel" aria-labelledby="admin-tab">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Administrative Settings</h4>
                    <p class="text-gray-500 dark:text-gray-400">Admin-specific settings and actions for this player.</p>
                    <!-- Add admin content here as needed -->
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Profile Image Modal -->
<div id="profileImageModal" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative w-full max-w-lg max-h-full">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <div class="flex items-center justify-between p-4 border-b rounded-t dark:border-gray-600">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Update Profile Picture</h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="profileImageModal">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <form method="POST" enctype="multipart/form-data" action="{{ url_for('players.player_profile', player_id=player.id) }}">
                {{ form.hidden_tag() }}
                <div class="p-6">
                    <div class="flex justify-center mb-4">
                        <div class="w-32 h-32 rounded-full overflow-hidden bg-gray-100 dark:bg-gray-600">
                            <img id="imagePreview" src="{{ player.profile_picture_url or url_for('static', filename='img/default_player.png') }}" class="w-full h-full object-cover" alt="Preview">
                        </div>
                    </div>
                    <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Choose Image</label>
                    <input type="file" name="profile_picture" accept="image/*" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400" id="profilePictureInput">
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">PNG, JPG or WEBP (MAX. 2MB)</p>
                </div>
                <div class="flex items-center justify-end p-4 border-t border-gray-200 dark:border-gray-600 gap-2">
                    <button type="button" data-modal-hide="profileImageModal" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:bg-gray-600">Cancel</button>
                    <button type="submit" name="update_picture" class="text-white bg-ecs-green hover:bg-ecs-green/90 focus:ring-4 focus:ring-ecs-green/50 font-medium rounded-lg text-sm px-5 py-2.5">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Contact Player Modal -->
{% if is_admin or 'Pub League Coach' in user_roles %}
<div id="contactPlayerModal" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative w-full max-w-lg max-h-full">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <div class="flex items-center justify-between p-4 border-b rounded-t dark:border-gray-600">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Contact {{ player.name }}</h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="contactPlayerModal">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <form method="POST" action="{{ url_for('admin.contact_player', player_id=player.id) }}">
                {{ form.hidden_tag() }}
                <div class="p-6">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Select how you want to contact this player:</p>

                    {% set email_available = user.email %}
                    {% set email_enabled = user.email_notifications %}
                    {% set sms_available = player.phone %}
                    {% set sms_enabled = user.sms_notifications %}
                    {% set discord_available = player.discord_id %}
                    {% set discord_enabled = user.discord_notifications %}

                    <div class="space-y-3 mb-4">
                        <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-600 rounded-lg cursor-pointer {{ 'opacity-50' if not email_available or not email_enabled }}">
                            <input type="checkbox" name="contact_channels" value="email" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" {% if not email_available or not email_enabled %}disabled{% endif %}>
                            <svg class="w-5 h-5 ml-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            <span class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Email</span>
                            {% if not email_available %}
                            <span class="ml-auto text-xs text-red-500">No email</span>
                            {% elif not email_enabled %}
                            <span class="ml-auto text-xs text-yellow-500">Disabled</span>
                            {% endif %}
                        </label>

                        <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-600 rounded-lg cursor-pointer {{ 'opacity-50' if not sms_available or not sms_enabled }}">
                            <input type="checkbox" name="contact_channels" value="sms" class="w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 dark:bg-gray-700 dark:border-gray-600" {% if not sms_available or not sms_enabled %}disabled{% endif %}>
                            <svg class="w-5 h-5 ml-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <span class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">SMS</span>
                            {% if not sms_available %}
                            <span class="ml-auto text-xs text-red-500">No phone</span>
                            {% elif not sms_enabled %}
                            <span class="ml-auto text-xs text-yellow-500">Disabled</span>
                            {% endif %}
                        </label>

                        <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-600 rounded-lg cursor-pointer {{ 'opacity-50' if not discord_available or not discord_enabled }}">
                            <input type="checkbox" name="contact_channels" value="discord" class="w-4 h-4 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600" {% if not discord_available or not discord_enabled %}disabled{% endif %}>
                            <svg class="w-5 h-5 ml-3 text-indigo-500" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/></svg>
                            <span class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Discord</span>
                            {% if not discord_available %}
                            <span class="ml-auto text-xs text-red-500">Not linked</span>
                            {% elif not discord_enabled %}
                            <span class="ml-auto text-xs text-yellow-500">Disabled</span>
                            {% endif %}
                        </label>
                    </div>

                    <div class="mb-4">
                        <label for="contactMessage" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Message</label>
                        <textarea id="contactMessage" name="message" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-ecs-green focus:border-ecs-green dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Enter your message..." required></textarea>
                    </div>

                    <div class="p-3 text-sm text-blue-800 rounded-lg bg-blue-50 dark:bg-blue-900/50 dark:text-blue-300">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Discord messages are delivered via the ECS Bot.
                    </div>
                </div>
                <div class="flex items-center justify-end p-4 border-t border-gray-200 dark:border-gray-600 gap-2">
                    <button type="button" data-modal-hide="contactPlayerModal" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="text-white bg-ecs-green hover:bg-ecs-green/90 focus:ring-4 focus:ring-ecs-green/50 font-medium rounded-lg text-sm px-5 py-2.5">Send Message</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
const isDark = document.documentElement.classList.contains('dark');

document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    const tabButtons = document.querySelectorAll('[data-tabs-target]');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const target = document.querySelector(button.dataset.tabsTarget);

            // Hide all panels
            document.querySelectorAll('[role="tabpanel"]').forEach(panel => {
                panel.classList.add('hidden');
            });

            // Deactivate all tabs
            tabButtons.forEach(btn => {
                btn.classList.remove('border-ecs-green', 'text-ecs-green');
                btn.classList.add('border-transparent');
                btn.setAttribute('aria-selected', 'false');
            });

            // Show selected panel
            target.classList.remove('hidden');
            button.classList.add('border-ecs-green', 'text-ecs-green');
            button.classList.remove('border-transparent');
            button.setAttribute('aria-selected', 'true');
        });
    });

    // Edit toggle functionality
    document.querySelectorAll('[data-action="edit-toggle"]').forEach(button => {
        button.addEventListener('click', () => {
            const section = button.dataset.section;
            const form = document.getElementById(section + '-form');
            if (form) {
                form.querySelectorAll('.view-mode').forEach(el => el.classList.toggle('hidden'));
                form.querySelectorAll('.edit-mode').forEach(el => el.classList.toggle('hidden'));
            }
        });
    });

    // Cancel edit functionality
    document.querySelectorAll('[data-action="cancel-edit"]').forEach(button => {
        button.addEventListener('click', () => {
            const section = button.dataset.section;
            const form = document.getElementById(section + '-form');
            if (form) {
                form.querySelectorAll('.view-mode').forEach(el => el.classList.remove('hidden'));
                form.querySelectorAll('.edit-mode').forEach(el => el.classList.add('hidden'));
            }
        });
    });

    // Admin collapse toggle
    const adminCollapseBtn = document.querySelector('[data-collapse-toggle="adminActionsCollapse"]');
    const adminCollapseContent = document.getElementById('adminActionsCollapse');
    const adminCollapseIcon = document.getElementById('adminCollapseIcon');

    if (adminCollapseBtn && adminCollapseContent) {
        adminCollapseBtn.addEventListener('click', () => {
            adminCollapseContent.classList.toggle('hidden');
            adminCollapseIcon.classList.toggle('rotate-180');
        });
    }

    // Image preview
    const profilePictureInput = document.getElementById('profilePictureInput');
    const imagePreview = document.getElementById('imagePreview');

    if (profilePictureInput && imagePreview) {
        profilePictureInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Profile verification
    const verifyBtn = document.querySelector('[data-action="verify-profile"]');
    if (verifyBtn) {
        verifyBtn.addEventListener('click', () => {
            const playerId = verifyBtn.dataset.playerId;
            Swal.fire({
                title: 'Verify Profile',
                text: 'Are you sure your profile information is current and accurate?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#1a472a',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, verify my profile',
                background: isDark ? '#1f2937' : '#ffffff',
                color: isDark ? '#f3f4f6' : '#111827'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/players/' + playerId + '/verify';
                }
            });
        });
    }
});
</script>
{% endblock %}
