{% extends "base.html" %}
{% import 'macros.html' as macros %}

{% block title %}Dashboard{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Enhanced Onboarding Modal -->
    {% if show_onboarding or session.get('force_onboarding') %}
    <div class="modal fade" id="onboardingSlideModal" tabindex="-1" aria-labelledby="onboardingModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <!-- Modal Header -->
                <div class="modal-header bg-light border-bottom-0 py-3">
                    <h5 class="modal-title fw-bold" id="onboardingModalLabel">
                        <i class="ti ti-user-circle me-2 text-primary"></i>Player Profile Setup
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <!-- Modal Body -->
                <div class="modal-body p-0">
                    {% include 'onboarding_modal_content.html' %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if player %}
    <div id="rsvp-data"
         data-player-id="{{ player.id }}"
         data-discord-id="{{ player.discord_id }}"
         data-csrf-token="{{ csrf_token() }}">
    </div>
    {% endif %}

    <!-- Welcome Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card welcome-header">
                <div class="card-body">
                    <div class="welcome-header-content">
                        {% if player %}
                        <!-- Simple welcome with team info -->
                        <div class="welcome-content">
                            <h2 class="text-primary mb-2">Welcome, {{ player.name }}!</h2>
                            {% if user_team and user_team|length > 0 %}
                            <div class="team-info">
                                <span class="text-muted me-2">You're playing for:</span>
                                {% for team in user_team %}
                                    <a href="{{ url_for('teams.team_details', team_id=team.id) }}" class="text-decoration-none">
                                        <span class="badge bg-primary me-1">{{ team.name }}</span>
                                    </a>{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-muted mb-0">You are not currently assigned to a team</p>
                            {% endif %}
                        </div>
                        {% else %}
                        <!-- No player profile state -->
                        <div class="text-center">
                            <h2 class="text-primary mb-1">Welcome!</h2>
                            <p class="text-muted mb-2">Please create your player profile to get started</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if not show_onboarding %}
    <!-- Announcements Card (simple design) -->
    {% if announcements %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body p-3">
                    <div id="announcementsCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="8000">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 me-3">
                                <i class="ti ti-bell text-primary" style="font-size: 2rem;"></i>
                            </div>
                            <div class="carousel-inner flex-grow-1">
                                {% for announcement in announcements %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <h5 class="text-primary mb-1">{{ announcement.title }}</h5>
                                    <p class="mb-0">{{ announcement.content }}</p>
                                    <small class="text-muted">{{ announcement.created_at.strftime('%B %d, %Y') }}</small>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="flex-shrink-0 ms-3">
                                <button class="btn btn-sm btn-icon btn-outline-primary rounded-circle" type="button" 
                                        data-bs-target="#announcementsCarousel" data-bs-slide="next">
                                    <i class="ti ti-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    {% if not player %}
    <!-- Create Profile Card (if no player profile) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body text-center p-4">
                    <div class="mb-3">
                        <img src="{{ url_for('static', filename='img/undraw_profile_details_re_ch9r.svg') }}" 
                             alt="Create Profile" style="height: 150px;">
                    </div>
                    <h3>Get Started</h3>
                    <p class="mb-4">Create your player profile to access team information, match scheduling, and more.</p>
                    <form method="POST" action="{{ url_for('main.index') }}" class="d-inline">
                        {{ onboarding_form.hidden_tag() }}
                        <input type="hidden" name="form_action" id="form_action" value="reset_skip_profile">
                        <button type="submit" class="btn btn-primary">
                            <i class="ti ti-user-plus me-2"></i>Create Player Profile
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if player %}
    <!-- Upcoming Matches Quick View -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4 class="mb-0">Upcoming Matches</h4>
                {% if user_team and user_team|length > 0 %}
                <div class="nav nav-pills" id="match-tabs" role="tablist">
                    {% for t in user_team %}
                        <button class="nav-link {% if loop.first %}active{% endif %}" 
                                id="team-{{ t.id }}-tab" data-bs-toggle="pill" 
                                data-bs-target="#team-{{ t.id }}-content" type="button" 
                                role="tab" aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                            {{ t.name }}
                        </button>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <div class="tab-content" id="match-tab-content">
                {% if user_team and user_team|length > 0 %}
                {% for t in user_team %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                     id="team-{{ t.id }}-content" role="tabpanel" 
                     aria-labelledby="team-{{ t.id }}-tab">
                    
                    {% set team_next_matches = team_matches.get(t.id, {}).get('next', {}) %}
                    
                    {% if team_next_matches|length > 0 %}
                        {% for date, matches in team_next_matches.items() | sort %}
                            <div class="card shadow-sm mb-3">
                                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">
                                        <i class="ti ti-calendar-event me-2"></i>
                                        {{ date.strftime('%A, %B %d, %Y') }}
                                    </h5>
                                    {% if t.league %}
                                    <span class="badge bg-primary">{{ t.league.name }}</span>
                                    {% endif %}
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        {% for match_data in matches %}
                                        {% set match = match_data['match'] %}
                                        {% set home_team_name = match_data['home_team_name'] %}
                                        {% set opponent_team_name = match_data['opponent_name'] %}
                                        
                                        {% if match_data['home_team_id'] == t.id %}
                                            {% set is_home = true %}
                                            {% set opponent_name = opponent_team_name %}
                                        {% else %}
                                            {% set is_home = false %}
                                            {% set opponent_name = home_team_name %}
                                        {% endif %}
                                        
                                        <div class="list-group-item p-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div class="d-flex align-items-center">
                                                        <div class="match-badge {% if is_home %}bg-success{% else %}bg-info{% endif %} me-2">
                                                            {% if is_home %}H{% else %}A{% endif %}
                                                        </div>
                                                        <h6 class="mb-0">
                                                            {% if match.week_type in ['FUN', 'TST', 'BYE', 'BONUS', 'PLAYOFF'] %}
                                                                <span class="badge bg-info">
                                                                    {% if match.week_type == 'FUN' %}
                                                                        Fun Week
                                                                    {% elif match.week_type == 'TST' %}
                                                                        TST Week
                                                                    {% elif match.week_type == 'BYE' %}
                                                                        Bye Week
                                                                    {% elif match.week_type == 'BONUS' %}
                                                                        Bonus Week
                                                                    {% elif match.week_type == 'PLAYOFF' %}
                                                                        Playoff Week
                                                                    {% endif %}
                                                                </span>
                                                                <span class="text-muted">
                                                                    {% if match.week_type == 'FUN' %}
                                                                        - Special activities
                                                                    {% elif match.week_type == 'TST' %}
                                                                        - Tournament events
                                                                    {% elif match.week_type == 'BYE' %}
                                                                        - Week off
                                                                    {% elif match.week_type == 'BONUS' %}
                                                                        - Additional activities
                                                                    {% elif match.week_type == 'PLAYOFF' %}
                                                                        - TBD
                                                                    {% endif %}
                                                                </span>
                                                            {% else %}
                                                                {% if is_home %}
                                                                    <span class="text-success fw-bold">{{ t.name }}</span> vs {{ opponent_name }}
                                                                {% else %}
                                                                    {{ opponent_name }} vs <span class="text-success fw-bold">{{ t.name }}</span>
                                                                {% endif %}
                                                            {% endif %}
                                                        </h6>
                                                    </div>
                                                    <div class="text-muted small mt-1">
                                                        <i class="ti ti-clock me-1"></i>{{ match.time.strftime('%I:%M %p') }}
                                                        <i class="ti ti-map-pin ms-2 me-1"></i>{{ match.location }}
                                                    </div>
                                                </div>
                                                <div class="d-flex align-items-center mt-3 mt-md-0">
                                                    <div class="rsvp-controls me-2">
                                                        <div class="btn-group" role="group">
                                                            <input type="radio" class="btn-check rsvp-input" name="response-{{ match.id }}" id="responseYes-{{ match.id }}" value="yes" autocomplete="off">
                                                            <label class="btn btn-outline-success" for="responseYes-{{ match.id }}" title="I can play">
                                                                <i class="ti ti-check"></i>
                                                            </label>
                                                            
                                                            <input type="radio" class="btn-check rsvp-input" name="response-{{ match.id }}" id="responseMaybe-{{ match.id }}" value="maybe" autocomplete="off">
                                                            <label class="btn btn-outline-warning" for="responseMaybe-{{ match.id }}" title="Maybe">
                                                                <i class="ti ti-question-mark"></i>
                                                            </label>
                                                            
                                                            <input type="radio" class="btn-check rsvp-input" name="response-{{ match.id }}" id="responseNo-{{ match.id }}" value="no" autocomplete="off">
                                                            <label class="btn btn-outline-danger" for="responseNo-{{ match.id }}" title="Can't play">
                                                                <i class="ti ti-x"></i>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        {% if has_permission('view_match_page') %}
                                                        <a href="{{ url_for('match_pages.view_match', match_id=match.id) }}" class="btn btn-primary">
                                                            Details
                                                        </a>
                                                        {% endif %}
                                                        {% if has_permission('report_match') %}
                                                        <button class="btn btn-outline-secondary ms-1 edit-match-btn"
                                                                data-match-id="{{ match.id }}"
                                                                type="button">
                                                            <i class="ti ti-{% if match.reported %}edit{% else %}report{% endif %} me-1"></i>
                                                            <span class="d-none d-sm-inline">{% if match.reported %}Edit Match Report{% else %}Submit Match Report{% endif %}</span>
                                                            <span class="d-sm-none">{% if match.reported %}Edit Match Report{% else %}Submit Report{% endif %}</span>
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Modals moved to bottom of page -->
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="card shadow-sm">
                            <div class="card-body text-center p-4">
                                <img src="{{ url_for('static', filename='img/undraw_notify_re_65on.svg') }}" 
                                     alt="No Matches" style="height: 150px; margin-bottom: 1rem;">
                                <h5>No Upcoming Matches</h5>
                                <p class="text-muted">There are no upcoming matches scheduled for {{ t.name }}.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <div class="card shadow-sm">
                    <div class="card-body text-center p-4">
                        <img src="{{ url_for('static', filename='img/undraw_notify_re_65on.svg') }}" 
                             alt="No Matches" style="height: 150px; margin-bottom: 1rem;">
                        <h5>No Upcoming Matches</h5>
                        <p class="text-muted">You are not currently assigned to any teams.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recent Matches -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4 class="mb-0">Recent Matches</h4>
                {% if user_team and user_team|length > 0 %}
                <div class="nav nav-pills" id="recent-match-tabs" role="tablist">
                    {% for t in user_team %}
                        <button class="nav-link {% if loop.first %}active{% endif %}" 
                                id="recent-team-{{ t.id }}-tab" data-bs-toggle="pill" 
                                data-bs-target="#recent-team-{{ t.id }}-content" type="button" 
                                role="tab" aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                            {{ t.name }}
                        </button>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <div class="tab-content" id="recent-match-tab-content">
                {% if user_team and user_team|length > 0 %}
                {% for t in user_team %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                     id="recent-team-{{ t.id }}-content" role="tabpanel" 
                     aria-labelledby="recent-team-{{ t.id }}-tab">
                    
                    {% set team_prev_matches = team_matches.get(t.id, {}).get('prev', {}) %}
                    
                    {% if team_prev_matches|length > 0 %}
                        <div class="card shadow-sm">
                            <div class="list-group list-group-flush">
                                {% for date, matches in team_prev_matches.items() | sort(reverse=true) %}
                                    {% for match_data in matches %}
                                    {% set match = match_data['match'] %}
                                    {% set home_team_name = match_data['home_team_name'] %}
                                    {% set opponent_team_name = match_data['opponent_name'] %}
                                    
                                    {% if match_data['home_team_id'] == t.id %}
                                        {% set is_home = true %}
                                        {% set opponent_name = opponent_team_name %}
                                    {% else %}
                                        {% set is_home = false %}
                                        {% set opponent_name = home_team_name %}
                                    {% endif %}
                                    
                                    <div class="list-group-item p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="d-flex align-items-center">
                                                    <div class="match-badge {% if is_home %}bg-success{% else %}bg-info{% endif %} text-white me-2">
                                                        {% if is_home %}H{% else %}A{% endif %}
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-0">
                                                            {% if match.week_type in ['FUN', 'TST', 'BYE', 'BONUS', 'PLAYOFF'] %}
                                                                <span class="badge bg-info">
                                                                    {% if match.week_type == 'FUN' %}
                                                                        Fun Week
                                                                    {% elif match.week_type == 'TST' %}
                                                                        TST Week
                                                                    {% elif match.week_type == 'BYE' %}
                                                                        Bye Week
                                                                    {% elif match.week_type == 'BONUS' %}
                                                                        Bonus Week
                                                                    {% elif match.week_type == 'PLAYOFF' %}
                                                                        Playoff Week
                                                                    {% endif %}
                                                                </span>
                                                                <span class="text-muted">
                                                                    {% if match.week_type == 'FUN' %}
                                                                        - Special activities
                                                                    {% elif match.week_type == 'TST' %}
                                                                        - Tournament events
                                                                    {% elif match.week_type == 'BYE' %}
                                                                        - Week off
                                                                    {% elif match.week_type == 'BONUS' %}
                                                                        - Additional activities
                                                                    {% elif match.week_type == 'PLAYOFF' %}
                                                                        - TBD
                                                                    {% endif %}
                                                                </span>
                                                            {% else %}
                                                                {% if is_home %}
                                                                    <span class="fw-bold">{{ t.name }}</span> vs {{ opponent_name }}
                                                                {% else %}
                                                                    {{ opponent_name }} vs <span class="fw-bold">{{ t.name }}</span>
                                                                {% endif %}
                                                            {% endif %}
                                                        </h6>
                                                        <div class="text-muted small mt-1">
                                                            {{ date.strftime('%a, %b %d') }} ¬∑ {{ match.time.strftime('%I:%M %p') }} ¬∑ {{ match.location }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3 mt-md-0">
                                                {% if has_permission('view_match_page') %}
                                                <a href="{{ url_for('match_pages.view_match', match_id=match.id) }}" class="btn btn-primary">Details</a>
                                                {% endif %}
                                                {% if has_permission('report_match') %}
                                                <button class="btn btn-outline-secondary ms-1 edit-match-btn"
                                                        data-match-id="{{ match.id }}"
                                                        type="button">
                                                    <i class="ti ti-{% if match.reported %}edit{% else %}report{% endif %} me-1"></i>
                                                    <span class="d-none d-sm-inline">{% if match.reported %}Edit Match Report{% else %}Submit Match Report{% endif %}</span>
                                                    <span class="d-sm-none">{% if match.reported %}Edit Match Report{% else %}Submit Report{% endif %}</span>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Modals are loaded via AJAX by base.html -->
                                    {% endfor %}
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="card shadow-sm">
                            <div class="card-body text-center p-4">
                                <img src="{{ url_for('static', filename='img/undraw_goal_-0-v5v.svg') }}" 
                                     alt="No Matches" style="height: 150px; margin-bottom: 1rem;">
                                <h5>No Recent Matches</h5>
                                <p class="text-muted">There are no recent matches for {{ t.name }}.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <div class="card shadow-sm">
                    <div class="card-body text-center p-4">
                        <img src="{{ url_for('static', filename='img/undraw_goal_-0-v5v.svg') }}" 
                             alt="No Matches" style="height: 150px; margin-bottom: 1rem;">
                        <h5>No Recent Matches</h5>
                        <p class="text-muted">You are not currently assigned to any teams.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Admin features - hidden but can be re-enabled if needed -->
    {% if false and safe_current_user.has_permission('view_match_reporting') %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">Debug Information</h5>
                </div>
                <div class="card-body">
                    <!-- Debug content removed -->
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block custom_css %}
<style>
    /* Match badge styling */
    .match-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        color: white;
        font-weight: bold;
        font-size: 0.8rem;
    }
    
    /* Card hover effect */
    .shadow-sm {
        transition: all 0.2s ease;
    }
    
    .shadow-sm:hover {
        box-shadow: 0 0.25rem 1rem rgba(161, 172, 184, 0.45) !important;
    }
    
    /* Tabs styling */
    .nav-pills .nav-link {
        font-size: 0.875rem;
        padding: 0.4rem 0.8rem;
        white-space: nowrap;
        margin: 0 2px;
    }
    
    /* Small tabs for mobile */
    .small-tabs {
        margin-bottom: 0.5rem;
    }
    
    .small-tabs .nav-link {
        padding: 0.35rem 0.7rem;
        font-size: 0.8rem;
    }
    
    /* Scrollable tabs on small screens */
    .overflow-auto::-webkit-scrollbar {
        height: 4px;
    }
    
    .overflow-auto::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.2);
        border-radius: 4px;
    }
    
    /* RSVP controls */
    .rsvp-controls .btn-group label {
        padding: 0.25rem 0.5rem;
    }
    
    /* Carousel indicators position */
    .carousel-indicators {
        bottom: -5px;
    }
    
    /* Remove all custom modal styling to avoid conflicts */
    
    /* Prevent buttons from growing too large when clicked */
    .btn {
        transition: none !important;
        transform: none !important;
    }
    
    .btn:active, .btn.active, .btn:focus {
        transform: none !important;
        box-shadow: none !important;
    }
    
    /* Mobile adaptations */
    @media (max-width: 767.98px) {
        .card-header .card-title {
            font-size: 1rem;
        }
        
        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
        }
        
        /* Touch-friendly controls - fixed to prevent growing */
        .btn-group > .btn {
            padding: 0.4rem 0.6rem;
            min-height: 44px;
            max-height: 44px;
        }
        
        /* Adjust spacing on mobile */
        .mb-md-0 {
            margin-bottom: 0.5rem !important;
        }
        
        /* Fix for iOS devices */
        .nav-pills {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
            scrollbar-width: none; /* Firefox */
            position: relative;
            z-index: 1;
        }
        
        .nav-pills::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }
        
        /* Remove fade-out gradient that causes white fade */
        .nav-pills:after {
            display: none;
        }
        
        /* Better match-item layout for mobile */
        .list-group-item {
            padding: 0.75rem 0.5rem !important;
        }
        
        .list-group-item .d-flex {
            flex-direction: column;
            align-items: flex-start !important;
        }
        
        .list-group-item .d-flex > div:first-child {
            margin-bottom: 0.5rem;
            width: 100%;
        }
        
        .list-group-item .d-flex > div:last-child {
            width: 100%;
            display: flex;
            justify-content: space-between;
        }
        
        /* RSVP controls on mobile - bigger touch targets */
        .rsvp-controls {
            width: 65%;
        }
        
        .rsvp-controls .btn-group {
            width: 100%;
        }
        
        .rsvp-controls .btn-group label {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            min-height: 44px;
        }
        
        /* Button enhancements for mobile */
        .btn {
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-sm {
            min-height: 38px;
        }
        
        /* Improved welcome header for mobile */
        .welcome-header h2 {
            font-size: 1.5rem;
        }
        
        .welcome-content {
            text-align: center;
        }
        
        .team-info {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        /* Improved tab styling on mobile */
        .nav-link {
            padding: 0.75rem 1rem;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 2px;
            border-radius: 0.25rem;
        }
    }
    
    /* Fix for iOS 100vh issue */
    :root {
        --vh: 1vh;
    }
    
    .full-height {
        height: calc(var(--vh, 1vh) * 100);
    }
    
    /* iOS Specific Styles */
    @supports (-webkit-touch-callout: none) {
        /* Safari/iOS specific style adjustments */
        input[type="radio"], 
        input[type="checkbox"] {
            -webkit-appearance: none;
        }
        
        /* Fix for iOS button styles */
        .btn {
            -webkit-appearance: none;
        }
        
        /* Prevent unwanted zoom on input focus */
        input[type="text"],
        input[type="email"],
        input[type="password"],
        select,
        textarea {
            font-size: 16px !important;
        }
    }
    
    /* Active state for tabs */
    .nav-pills .nav-link.active {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block custom_js %}
<script>
    const showTour = {{ show_tour | tojson }};
    // Make player choices globally available for our fix script
    window.playerChoices = {{ player_choices | tojson }};
    const playerChoices = window.playerChoices;
    
    // Fix iOS 100vh issue
    function setViewportHeight() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    
    // Initialize and handle mobile-specific behaviors
    document.addEventListener('DOMContentLoaded', function() {
        // Set viewport height fix
        setViewportHeight();
        window.addEventListener('resize', function() {
            setViewportHeight();
        });
        window.addEventListener('orientationchange', setViewportHeight);
        
        // Make tabs touch-friendly - ONLY ON MOBILE
        const tabContainers = document.querySelectorAll('.nav-pills');
        tabContainers.forEach(container => {
            // Only apply mobile enhancements if we're actually on mobile
            if (window.innerWidth < 768) {
                container.classList.add('small-tabs', 'overflow-auto', 'flex-nowrap');
                
                // Add touch swipe to navigate between tabs on mobile
                let touchStartX = 0;
                let touchEndX = 0;
                const tabPanes = container.closest('.tab-content') || 
                                 document.querySelector(container.getAttribute('aria-controls')) ||
                                 document.querySelector('.tab-content');
                
                if (tabPanes) {
                    tabPanes.addEventListener('touchstart', function(e) {
                        touchStartX = e.changedTouches[0].screenX;
                    }, {passive: true});
                    
                    tabPanes.addEventListener('touchend', function(e) {
                        touchEndX = e.changedTouches[0].screenX;
                        handleSwipeNav(container);
                    }, {passive: true});
                    
                    function handleSwipeNav(tabContainer) {
                        // Get all tabs and find active tab index
                        const tabs = Array.from(tabContainer.querySelectorAll('.nav-link'));
                        const activeIndex = tabs.findIndex(tab => tab.classList.contains('active'));
                        
                        // Minimum 50px swipe to trigger navigation
                        if (touchEndX < touchStartX - 50 && activeIndex < tabs.length - 1) {
                            // Swipe left - go to next tab
                            tabs[activeIndex + 1].click();
                        } else if (touchEndX > touchStartX + 50 && activeIndex > 0) {
                            // Swipe right - go to previous tab
                            tabs[activeIndex - 1].click();
                        }
                    }
                }
            }
        });
        
        // Improve lists on mobile
        if (window.innerWidth < 768) {
            // Make any button-group controls easier to tap
            const btnGroups = document.querySelectorAll('.btn-group');
            btnGroups.forEach(group => {
                const labels = group.querySelectorAll('label.btn');
                labels.forEach(label => {
                    label.style.minHeight = '44px';
                    label.style.minWidth = '44px';
                    label.style.display = 'flex';
                    label.style.alignItems = 'center';
                    label.style.justifyContent = 'center';
                });
            });
            
            // Auto-scroll active tabs into view
            document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tabEl => {
                tabEl.addEventListener('shown.bs.tab', function() {
                    // Scroll this tab into view if it's not fully visible
                    const container = this.closest('.nav-pills');
                    if (container) {
                        const tabRect = this.getBoundingClientRect();
                        const containerRect = container.getBoundingClientRect();
                        
                        if (tabRect.right > containerRect.right || tabRect.left < containerRect.left) {
                            this.scrollIntoView({
                                behavior: 'smooth',
                                block: 'nearest',
                                inline: 'center'
                            });
                        }
                    }
                });
            });
        }
        
        // Handle any modals better on mobile
        const allModals = document.querySelectorAll('.modal');
        allModals.forEach(modal => {
            modal.addEventListener('shown.bs.modal', function() {
                // Fix for iOS scroll issues in modals
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    document.body.style.overflow = 'hidden';
                    document.body.style.position = 'fixed';
                    document.body.style.width = '100%';
                }
            });
            
            modal.addEventListener('hidden.bs.modal', function() {
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    document.body.style.overflow = '';
                    document.body.style.position = '';
                    document.body.style.width = '';
                }
            });
        });
        
        // Enable fast click on mobile devices to reduce tap delay
        if ('ontouchstart' in window) {
            const buttons = document.querySelectorAll('button, .btn, a');
            buttons.forEach(button => {
                button.addEventListener('touchstart', function() {}, {passive: true});
            });
        }
    });
    
    // Register service worker if supported by the browser
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/static/js/service-worker.js')
                .then(function(registration) {
                    console.log('ServiceWorker registered: ', registration);
                })
                .catch(function(error) {
                    console.log('ServiceWorker registration failed: ', error);
                });
        });
    }
</script>
<script src="{{ url_for('static', filename='custom_js/tour.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/report_match.js') }}"></script>
{% if show_onboarding or session.get('force_onboarding') %}
<script src="{{ url_for('static', filename='custom_js/onboarding.js') }}"></script>
<script>
    // Auto-open the onboarding modal when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Check if the modal element exists
        const modalElement = document.getElementById('onboardingSlideModal');
        if (modalElement) {
            console.log("Auto-opening onboarding modal");
            try {
                const onboardingModal = new bootstrap.Modal(modalElement, {
                    backdrop: 'static',
                    keyboard: false
                });
                onboardingModal.show();
            } catch (error) {
                console.error("Error auto-opening modal:", error);
            }
        }
    });
</script>
{% endif %}
{% if player %}
<script src="{{ url_for('static', filename='custom_js/rsvp.js') }}"></script>

<!-- Discord Membership Detection for Dashboard -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const playerDiscordId = '{{ player.discord_id }}';
    
    if (playerDiscordId && playerDiscordId !== 'None' && playerDiscordId !== '') {
        // Player has Discord linked - check if they're in the server
        // This check will be handled by the global Discord membership checker
        // but we can add dashboard-specific logic here
        
        // Check if they've been shown the Discord prompt recently
        const lastPromptShown = localStorage.getItem('discord_prompt_shown');
        const now = new Date().getTime();
        const oneWeek = 7 * 24 * 60 * 60 * 1000; // One week in milliseconds
        
        if (!lastPromptShown || (now - parseInt(lastPromptShown)) > oneWeek) {
            // Show a more subtle reminder on the dashboard
            setTimeout(() => {
                // Only show if there are upcoming matches or RSVP opportunities
                const rsvpButtons = document.querySelectorAll('[data-rsvp]');
                if (rsvpButtons.length > 0) {
                    DiscordMembershipChecker.showJoinPrompt({
                        title: 'üí° Stay Connected on Discord',
                        urgency: 'info',
                        showUrgentPopup: true
                    });
                    
                    // Mark as shown
                    localStorage.setItem('discord_prompt_shown', now.toString());
                }
            }, 5000); // Show after 5 seconds on dashboard
        }
    } else {
        // Player doesn't have Discord linked at all
        setTimeout(() => {
            Swal.fire({
                title: 'üîó Connect Your Discord Account',
                html: `
                    <div class="text-start">
                        <p><strong>Your Discord account isn't connected yet!</strong></p>
                        <p>Connecting Discord is important for:</p>
                        <ul class="text-start ms-3">
                            <li>üîî Getting match notifications and updates</li>
                            <li>üí¨ Communicating with teammates</li>
                            <li>üìÖ Receiving RSVP reminders</li>
                            <li>üèÜ Staying updated on league announcements</li>
                        </ul>
                        <p class="mt-3"><strong>Connect now to enhance your experience!</strong></p>
                    </div>
                `,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: '<i class="fab fa-discord me-2"></i>Connect Discord',
                cancelButtonText: 'Maybe Later',
                confirmButtonColor: '#5865F2',
                cancelButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '{{ url_for("auth.discord_login") }}';
                }
            });
        }, 10000); // Show after 10 seconds on dashboard for unlinked accounts
    }
});
</script>

<!-- Simple Cropper for Onboarding Modal -->
<script src="{{ url_for('static', filename='custom_js/simple-cropper.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/onboarding.js') }}"></script>

{% endif %}

<!-- Modals are loaded via AJAX by base.html -->
{% endblock %}