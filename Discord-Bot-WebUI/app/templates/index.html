{% extends "base.html" %}
{% import 'macros.html' as macros %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Enhanced Onboarding Modal -->
    {% if show_onboarding %}
    <div class="modal fade" id="onboardingSlideModal" tabindex="-1" aria-labelledby="onboardingModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <!-- Modal Header -->
                <div class="modal-header bg-light border-bottom-0 py-3">
                    <h5 class="modal-title fw-bold" id="onboardingModalLabel">
                        <i class="ti ti-user-circle me-2 text-primary"></i>Player Profile Setup
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <!-- Modal Body -->
                <div class="modal-body p-0">
                    {% include 'onboarding_modal_content.html' %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if player %}
    <div id="rsvp-data"
         data-player-id="{{ player.id }}"
         data-discord-id="{{ player.discord_id }}"
         data-csrf-token="{{ csrf_token() }}">
    </div>
    {% endif %}

    <!-- Welcome Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card welcome-header">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {% if player %}
                            <h2 class="text-primary mb-1">Welcome, {{ player.name }}!</h2>
                            <p class="text-muted mb-2">
                                {% if player.teams and player.teams|length > 0 %}
                                    {% set unique_leagues = (
                                    player.teams
                                    |selectattr('league')
                                    |map(attribute='league')
                                    |map(attribute='name')
                                    |unique
                                    |list
                                    ) %}
                                    You are playing in {{ unique_leagues|join(', ') }} league(s)
                                {% else %}
                                    You are not currently assigned to a team
                                {% endif %}
                            </p>
                            {% else %}
                            <h2 class="text-primary mb-1">Welcome!</h2>
                            <p class="text-muted mb-2">Please create your player profile to get started</p>
                            {% endif %}
                        </div>
                        {% if player %}
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <img src="{{ player.profile_picture_url or url_for('static', filename='img/default_player.png') }}" 
                                     alt="Profile" class="rounded-circle" style="width: 48px; height: 48px; object-fit: cover;">
                            </div>
                            <a href="{{ url_for('players.player_profile', player_id=player.id) }}" class="btn btn-outline-primary btn-sm">
                                <i class="ti ti-user-circle me-1"></i> My Profile
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if not show_onboarding %}
    <!-- Announcements Card (simple design) -->
    {% if announcements %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body p-3">
                    <div id="announcementsCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="8000">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 me-3">
                                <i class="ti ti-bell text-primary" style="font-size: 2rem;"></i>
                            </div>
                            <div class="carousel-inner flex-grow-1">
                                {% for announcement in announcements %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <h5 class="text-primary mb-1">{{ announcement.title }}</h5>
                                    <p class="mb-0">{{ announcement.content }}</p>
                                    <small class="text-muted">{{ announcement.created_at.strftime('%B %d, %Y') }}</small>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="flex-shrink-0 ms-3">
                                <button class="btn btn-sm btn-icon btn-outline-primary rounded-circle" type="button" 
                                        data-bs-target="#announcementsCarousel" data-bs-slide="next">
                                    <i class="ti ti-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    {% if not player %}
    <!-- Create Profile Card (if no player profile) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body text-center p-4">
                    <div class="mb-3">
                        <img src="{{ url_for('static', filename='img/undraw_profile_details_re_ch9r.svg') }}" 
                             alt="Create Profile" style="height: 150px;">
                    </div>
                    <h3>Get Started</h3>
                    <p class="mb-4">Create your player profile to access team information, match scheduling, and more.</p>
                    <form method="POST" action="{{ url_for('main.index') }}" class="d-inline">
                        {{ onboarding_form.hidden_tag() }}
                        <input type="hidden" name="form_action" id="form_action" value="reset_skip_profile">
                        <button type="submit" class="btn btn-primary">
                            <i class="ti ti-user-plus me-2"></i>Create Player Profile
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if player and player.teams and player.teams|length > 0 %}
    <!-- Upcoming Matches Quick View -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4 class="mb-0">Upcoming Matches</h4>
                <div class="nav nav-pills" id="match-tabs" role="tablist">
                    {% for t in player.teams %}
                        <button class="nav-link {% if loop.first %}active{% endif %}" 
                                id="team-{{ t.id }}-tab" data-bs-toggle="pill" 
                                data-bs-target="#team-{{ t.id }}-content" type="button" 
                                role="tab" aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                            {{ t.name }}
                        </button>
                    {% endfor %}
                </div>
            </div>
            
            <div class="tab-content" id="match-tab-content">
                {% for t in player.teams %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                     id="team-{{ t.id }}-content" role="tabpanel" 
                     aria-labelledby="team-{{ t.id }}-tab">
                    
                    {% set team_next_matches = team_matches.get(t.id, {}).get('next', {}) %}
                    
                    {% if team_next_matches|length > 0 %}
                        {% for date, matches in team_next_matches.items() | sort %}
                            <div class="card shadow-sm mb-3">
                                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">
                                        <i class="ti ti-calendar-event me-2"></i>
                                        {{ date.strftime('%A, %B %d, %Y') }}
                                    </h5>
                                    {% if t.league %}
                                    <span class="badge bg-primary">{{ t.league.name }}</span>
                                    {% endif %}
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        {% for match_data in matches %}
                                        {% set match = match_data['match'] %}
                                        {% set home_team_name = match_data['home_team_name'] %}
                                        {% set opponent_team_name = match_data['opponent_name'] %}
                                        
                                        {% if match_data['home_team_id'] == t.id %}
                                            {% set is_home = true %}
                                            {% set opponent_name = opponent_team_name %}
                                        {% else %}
                                            {% set is_home = false %}
                                            {% set opponent_name = home_team_name %}
                                        {% endif %}
                                        
                                        <div class="list-group-item p-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div class="d-flex align-items-center">
                                                        <div class="match-badge {% if is_home %}bg-success{% else %}bg-info{% endif %} me-2">
                                                            {% if is_home %}H{% else %}A{% endif %}
                                                        </div>
                                                        <h6 class="mb-0">
                                                            {% if is_home %}
                                                                <span class="text-success fw-bold">{{ t.name }}</span> vs {{ opponent_name }}
                                                            {% else %}
                                                                {{ opponent_name }} vs <span class="text-success fw-bold">{{ t.name }}</span>
                                                            {% endif %}
                                                        </h6>
                                                    </div>
                                                    <div class="text-muted small mt-1">
                                                        <i class="ti ti-clock me-1"></i>{{ match.time.strftime('%I:%M %p') }}
                                                        <i class="ti ti-map-pin ms-2 me-1"></i>{{ match.location }}
                                                    </div>
                                                </div>
                                                <div class="d-flex align-items-center mt-3 mt-md-0">
                                                    <div class="rsvp-controls me-2">
                                                        <div class="btn-group" role="group">
                                                            <input type="radio" class="btn-check rsvp-input" name="response-{{ match.id }}" id="responseYes-{{ match.id }}" value="yes" autocomplete="off">
                                                            <label class="btn btn-outline-success" for="responseYes-{{ match.id }}" title="I can play">
                                                                <i class="ti ti-check"></i>
                                                            </label>
                                                            
                                                            <input type="radio" class="btn-check rsvp-input" name="response-{{ match.id }}" id="responseMaybe-{{ match.id }}" value="maybe" autocomplete="off">
                                                            <label class="btn btn-outline-warning" for="responseMaybe-{{ match.id }}" title="Maybe">
                                                                <i class="ti ti-question-mark"></i>
                                                            </label>
                                                            
                                                            <input type="radio" class="btn-check rsvp-input" name="response-{{ match.id }}" id="responseNo-{{ match.id }}" value="no" autocomplete="off">
                                                            <label class="btn btn-outline-danger" for="responseNo-{{ match.id }}" title="Can't play">
                                                                <i class="ti ti-x"></i>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <a href="{{ url_for('match_pages.view_match', match_id=match.id) }}" class="btn btn-primary">
                                                            Details
                                                        </a>
                                                        {% if safe_current_user.has_permission('view_match_reporting') %}
                                                        <button class="btn btn-outline-secondary ms-1 edit-match-btn"
                                                                data-match-id="{{ match.id }}"
                                                                type="button">
                                                            <i class="ti ti-edit"></i>
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Modals moved to bottom of page -->
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="card shadow-sm">
                            <div class="card-body text-center p-4">
                                <img src="{{ url_for('static', filename='img/undraw_notify_re_65on.svg') }}" 
                                     alt="No Matches" style="height: 150px; margin-bottom: 1rem;">
                                <h5>No Upcoming Matches</h5>
                                <p class="text-muted">There are no upcoming matches scheduled for {{ t.name }}.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Recent Matches -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4 class="mb-0">Recent Matches</h4>
                <div class="nav nav-pills" id="recent-match-tabs" role="tablist">
                    {% for t in player.teams %}
                        <button class="nav-link {% if loop.first %}active{% endif %}" 
                                id="recent-team-{{ t.id }}-tab" data-bs-toggle="pill" 
                                data-bs-target="#recent-team-{{ t.id }}-content" type="button" 
                                role="tab" aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                            {{ t.name }}
                        </button>
                    {% endfor %}
                </div>
            </div>
            
            <div class="tab-content" id="recent-match-tab-content">
                {% for t in player.teams %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                     id="recent-team-{{ t.id }}-content" role="tabpanel" 
                     aria-labelledby="recent-team-{{ t.id }}-tab">
                    
                    {% set team_prev_matches = team_matches.get(t.id, {}).get('prev', {}) %}
                    
                    {% if team_prev_matches|length > 0 %}
                        <div class="card shadow-sm">
                            <div class="list-group list-group-flush">
                                {% for date, matches in team_prev_matches.items() | sort(reverse=true) %}
                                    {% for match_data in matches %}
                                    {% set match = match_data['match'] %}
                                    {% set home_team_name = match_data['home_team_name'] %}
                                    {% set opponent_team_name = match_data['opponent_name'] %}
                                    
                                    {% if match_data['home_team_id'] == t.id %}
                                        {% set is_home = true %}
                                        {% set opponent_name = opponent_team_name %}
                                    {% else %}
                                        {% set is_home = false %}
                                        {% set opponent_name = home_team_name %}
                                    {% endif %}
                                    
                                    <div class="list-group-item p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="d-flex align-items-center">
                                                    <div class="match-badge {% if is_home %}bg-success{% else %}bg-info{% endif %} text-white me-2">
                                                        {% if is_home %}H{% else %}A{% endif %}
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-0">
                                                            {% if is_home %}
                                                                <span class="fw-bold">{{ t.name }}</span> vs {{ opponent_name }}
                                                            {% else %}
                                                                {{ opponent_name }} vs <span class="fw-bold">{{ t.name }}</span>
                                                            {% endif %}
                                                        </h6>
                                                        <div class="text-muted small mt-1">
                                                            {{ date.strftime('%a, %b %d') }} · {{ match.time.strftime('%I:%M %p') }} · {{ match.location }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3 mt-md-0">
                                                <a href="{{ url_for('match_pages.view_match', match_id=match.id) }}" class="btn btn-primary">Details</a>
                                                {% if safe_current_user.has_permission('view_match_reporting') %}
                                                <button class="btn btn-outline-secondary ms-1 edit-match-btn"
                                                        data-match-id="{{ match.id }}"
                                                        type="button">
                                                    <i class="ti ti-edit"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Modals are loaded via AJAX by base.html -->
                                    {% endfor %}
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="card shadow-sm">
                            <div class="card-body text-center p-4">
                                <img src="{{ url_for('static', filename='img/undraw_goal_-0-v5v.svg') }}" 
                                     alt="No Matches" style="height: 150px; margin-bottom: 1rem;">
                                <h5>No Recent Matches</h5>
                                <p class="text-muted">There are no recent matches for {{ t.name }}.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Admin features - hidden but can be re-enabled if needed -->
    {% if false and safe_current_user.has_permission('view_match_reporting') %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">Debug Information</h5>
                </div>
                <div class="card-body">
                    <!-- Debug content removed -->
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block custom_css %}
<style>
    /* Match badge styling */
    .match-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        color: white;
        font-weight: bold;
        font-size: 0.8rem;
    }
    
    /* Card hover effect */
    .shadow-sm {
        transition: all 0.2s ease;
    }
    
    .shadow-sm:hover {
        box-shadow: 0 0.25rem 1rem rgba(161, 172, 184, 0.45) !important;
    }
    
    /* Tabs styling */
    .nav-pills .nav-link {
        font-size: 0.875rem;
        padding: 0.4rem 0.8rem;
        white-space: nowrap;
        margin: 0 2px;
    }
    
    /* Small tabs for mobile */
    .small-tabs {
        margin-bottom: 0.5rem;
    }
    
    .small-tabs .nav-link {
        padding: 0.35rem 0.7rem;
        font-size: 0.8rem;
    }
    
    /* Scrollable tabs on small screens */
    .overflow-auto::-webkit-scrollbar {
        height: 4px;
    }
    
    .overflow-auto::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.2);
        border-radius: 4px;
    }
    
    /* RSVP controls */
    .rsvp-controls .btn-group label {
        padding: 0.25rem 0.5rem;
    }
    
    /* Carousel indicators position */
    .carousel-indicators {
        bottom: -5px;
    }
    
    /* Remove all custom modal styling to avoid conflicts */
    
    /* Prevent buttons from growing too large when clicked */
    .btn {
        transition: none !important;
        transform: none !important;
    }
    
    .btn:active, .btn.active, .btn:focus {
        transform: none !important;
        box-shadow: none !important;
    }
    
    /* Mobile adaptations */
    @media (max-width: 767.98px) {
        .card-header .card-title {
            font-size: 1rem;
        }
        
        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
        }
        
        /* Touch-friendly controls - fixed to prevent growing */
        .btn-group > .btn {
            padding: 0.4rem 0.6rem;
            min-height: 44px;
            max-height: 44px;
        }
        
        /* Adjust spacing on mobile */
        .mb-md-0 {
            margin-bottom: 0.5rem !important;
        }
        
        /* Fix for iOS devices */
        .nav-pills {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
            scrollbar-width: none; /* Firefox */
            position: relative;
            z-index: 1;
        }
        
        .nav-pills::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }
        
        .nav-pills:after {
            content: "";
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, var(--bs-body-bg) 80%);
            pointer-events: none;
            z-index: 2;
        }
        
        /* Better match-item layout for mobile */
        .list-group-item {
            padding: 0.75rem 0.5rem !important;
        }
        
        .list-group-item .d-flex {
            flex-direction: column;
            align-items: flex-start !important;
        }
        
        .list-group-item .d-flex > div:first-child {
            margin-bottom: 0.5rem;
            width: 100%;
        }
        
        .list-group-item .d-flex > div:last-child {
            width: 100%;
            display: flex;
            justify-content: space-between;
        }
        
        /* RSVP controls on mobile - bigger touch targets */
        .rsvp-controls {
            width: 65%;
        }
        
        .rsvp-controls .btn-group {
            width: 100%;
        }
        
        .rsvp-controls .btn-group label {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            min-height: 44px;
        }
        
        /* Button enhancements for mobile */
        .btn {
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-sm {
            min-height: 38px;
        }
        
        /* Improved welcome header for mobile */
        .welcome-header h2 {
            font-size: 1.5rem;
        }
        
        .welcome-header .d-flex {
            flex-direction: column;
            align-items: flex-start !important;
        }
        
        .welcome-header .d-flex > div:last-child {
            margin-top: 0.75rem;
            align-self: flex-start;
        }
        
        /* Improved tab styling on mobile */
        .nav-link {
            padding: 0.75rem 1rem;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 2px;
            border-radius: 0.25rem;
        }
    }
    
    /* Fix for iOS 100vh issue */
    :root {
        --vh: 1vh;
    }
    
    .full-height {
        height: calc(var(--vh, 1vh) * 100);
    }
    
    /* iOS Specific Styles */
    @supports (-webkit-touch-callout: none) {
        /* Safari/iOS specific style adjustments */
        input[type="radio"], 
        input[type="checkbox"] {
            -webkit-appearance: none;
        }
        
        /* Fix for iOS button styles */
        .btn {
            -webkit-appearance: none;
        }
        
        /* Prevent unwanted zoom on input focus */
        input[type="text"],
        input[type="email"],
        input[type="password"],
        select,
        textarea {
            font-size: 16px !important;
        }
    }
    
    /* Active state for tabs */
    .nav-pills .nav-link.active {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block custom_js %}
<script>
    const showTour = {{ show_tour | tojson }};
    // Make player choices globally available for our fix script
    window.playerChoices = {{ player_choices | tojson }};
    const playerChoices = window.playerChoices;
    
    // Fix iOS 100vh issue
    function setViewportHeight() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    
    // Initialize and handle mobile-specific behaviors
    document.addEventListener('DOMContentLoaded', function() {
        // Set viewport height fix
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);
        
        // Make tabs touch-friendly
        const tabContainers = document.querySelectorAll('.nav-pills');
        tabContainers.forEach(container => {
            if (window.innerWidth < 768) {
                container.classList.add('small-tabs', 'overflow-auto', 'flex-nowrap');
                
                // Add scroll indicators to let users know they can scroll
                const navWidth = container.scrollWidth;
                const containerWidth = container.clientWidth;
                
                if (navWidth > containerWidth) {
                    // Add scroll indicator element
                    const indicator = document.createElement('div');
                    indicator.className = 'text-center text-muted small fst-italic mt-1 mb-2';
                    indicator.innerHTML = '<i class="ti ti-chevron-left"></i> Swipe for more teams <i class="ti ti-chevron-right"></i>';
                    container.parentNode.insertBefore(indicator, container.nextSibling);
                    
                    // Fade out after a few seconds
                    setTimeout(() => {
                        indicator.style.transition = 'opacity 1s ease';
                        indicator.style.opacity = '0.5';
                    }, 3000);
                }
                
                // Add touch swipe to navigate between tabs on mobile
                let touchStartX = 0;
                let touchEndX = 0;
                const tabPanes = container.closest('.tab-content') || 
                                 document.querySelector(container.getAttribute('aria-controls')) ||
                                 document.querySelector('.tab-content');
                
                if (tabPanes) {
                    tabPanes.addEventListener('touchstart', function(e) {
                        touchStartX = e.changedTouches[0].screenX;
                    }, {passive: true});
                    
                    tabPanes.addEventListener('touchend', function(e) {
                        touchEndX = e.changedTouches[0].screenX;
                        handleSwipeNav(container);
                    }, {passive: true});
                    
                    function handleSwipeNav(tabContainer) {
                        // Get all tabs and find active tab index
                        const tabs = Array.from(tabContainer.querySelectorAll('.nav-link'));
                        const activeIndex = tabs.findIndex(tab => tab.classList.contains('active'));
                        
                        // Minimum 50px swipe to trigger navigation
                        if (touchEndX < touchStartX - 50 && activeIndex < tabs.length - 1) {
                            // Swipe left - go to next tab
                            tabs[activeIndex + 1].click();
                        } else if (touchEndX > touchStartX + 50 && activeIndex > 0) {
                            // Swipe right - go to previous tab
                            tabs[activeIndex - 1].click();
                        }
                    }
                }
            }
        });
        
        // Improve lists on mobile
        if (window.innerWidth < 768) {
            // Make any button-group controls easier to tap
            const btnGroups = document.querySelectorAll('.btn-group');
            btnGroups.forEach(group => {
                const labels = group.querySelectorAll('label.btn');
                labels.forEach(label => {
                    label.style.minHeight = '44px';
                    label.style.minWidth = '44px';
                    label.style.display = 'flex';
                    label.style.alignItems = 'center';
                    label.style.justifyContent = 'center';
                });
            });
            
            // Auto-scroll active tabs into view
            document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tabEl => {
                tabEl.addEventListener('shown.bs.tab', function() {
                    // Scroll this tab into view if it's not fully visible
                    const container = this.closest('.nav-pills');
                    if (container) {
                        const tabRect = this.getBoundingClientRect();
                        const containerRect = container.getBoundingClientRect();
                        
                        if (tabRect.right > containerRect.right || tabRect.left < containerRect.left) {
                            this.scrollIntoView({
                                behavior: 'smooth',
                                block: 'nearest',
                                inline: 'center'
                            });
                        }
                    }
                });
            });
        }
        
        // Handle any modals better on mobile
        const allModals = document.querySelectorAll('.modal');
        allModals.forEach(modal => {
            modal.addEventListener('shown.bs.modal', function() {
                // Fix for iOS scroll issues in modals
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    document.body.style.overflow = 'hidden';
                    document.body.style.position = 'fixed';
                    document.body.style.width = '100%';
                }
            });
            
            modal.addEventListener('hidden.bs.modal', function() {
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    document.body.style.overflow = '';
                    document.body.style.position = '';
                    document.body.style.width = '';
                }
            });
        });
        
        // Enable fast click on mobile devices to reduce tap delay
        if ('ontouchstart' in window) {
            const buttons = document.querySelectorAll('button, .btn, a');
            buttons.forEach(button => {
                button.addEventListener('touchstart', function() {}, {passive: true});
            });
        }
        
        // Add pull-to-refresh functionality (modified to prevent unwanted triggers)
        let startY;
        document.addEventListener('touchstart', function(e) {
            startY = e.touches[0].pageY;
        }, {passive: true});
        
        document.addEventListener('touchmove', function(e) {
            // Pull down refresh only if at the top of the page
            if (window.scrollY === 0 && e.touches[0].pageY - startY > 60 && !document.querySelector('.refresh-spinner')) {
                // Create and show refresh indicator
                const spinner = document.createElement('div');
                spinner.className = 'refresh-spinner position-fixed w-100 text-center pt-2';
                spinner.style.top = '0';
                spinner.style.zIndex = '9999';
                spinner.innerHTML = '<i class="ti ti-refresh rotate"></i> Pull down to refresh...';
                document.body.appendChild(spinner);
            }
        }, {passive: true});
        
        document.addEventListener('touchend', function(e) {
            // Only trigger refresh if deliberate pull and at page top
            if (window.scrollY === 0 && document.querySelector('.refresh-spinner')) {
                const spinner = document.querySelector('.refresh-spinner');
                // Only refresh if pulled far enough (100px) and user isn't scrolling back up quickly
                const pullDistance = e.changedTouches[0].pageY - startY;
                
                if (pullDistance > 100) {
                    spinner.innerHTML = '<i class="ti ti-refresh rotate ti-spin"></i> Refreshing...';
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    // Remove spinner if not pulled far enough
                    if (spinner.parentNode) {
                        spinner.parentNode.removeChild(spinner);
                    }
                }
            } else if (document.querySelector('.refresh-spinner')) {
                // Remove spinner in all other cases
                const spinner = document.querySelector('.refresh-spinner');
                if (spinner.parentNode) {
                    spinner.parentNode.removeChild(spinner);
                }
            }
        }, {passive: true});
    });
    
    // Register service worker if supported by the browser
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/static/js/service-worker.js')
                .then(function(registration) {
                    console.log('ServiceWorker registered: ', registration);
                })
                .catch(function(error) {
                    console.log('ServiceWorker registration failed: ', error);
                });
        });
    }
</script>
<script src="{{ url_for('static', filename='custom_js/tour.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/report_match.js') }}"></script>
{% if show_onboarding %}
<script src="{{ url_for('static', filename='custom_js/onboarding.js') }}"></script>
{% endif %}
{% if player %}
<script src="{{ url_for('static', filename='custom_js/rsvp.js') }}"></script>
{% endif %}

<!-- Modals are loaded via AJAX by base.html -->
{% endblock %}