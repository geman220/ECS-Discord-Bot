{% extends "base.html" %}
{% import 'macros.html' as macros %}

{% block title %}Dashboard{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y c-home-page">
    {% if player %}
    <div id="rsvp-data"
         data-player-id="{{ player.id }}"
         data-discord-id="{{ player.discord_id }}"
         data-discord-in-server="{{ 'true' if player.discord_in_server else 'false' if player.discord_in_server is not none else 'unknown' }}"
         data-discord-last-checked="{{ player.discord_last_checked.isoformat() if player.discord_last_checked else '' }}"
         data-csrf-token="{{ csrf_token() }}"
         data-discord-auth-url="{{ url_for('auth.discord_login') }}">
    </div>
    {% endif %}

    <!-- Welcome Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="c-welcome" data-component="welcome-header">
                {% if player %}
                <!-- Simple welcome with team info -->
                <div class="c-welcome__content">
                    <h2 class="c-welcome__title">Welcome, {{ player.name }}!</h2>
                    {% if user_team and user_team|length > 0 %}
                    <div class="c-welcome__teams">
                        <span class="c-welcome__teams-label">You're playing for:</span>
                        {% for team in user_team %}
                            <a href="{{ url_for('teams.team_details', team_id=team.id) }}" class="text-decoration-none">
                                <span class="c-badge c-badge--primary" data-badge data-team-id="{{ team.id }}">{{ team.name }}</span>
                            </a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="c-welcome__no-team">You are not currently assigned to a team</p>
                    {% endif %}
                </div>
                {% else %}
                <!-- No player profile state -->
                <div class="c-welcome__content c-welcome__center">
                    <h2 class="c-welcome__title">Welcome!</h2>
                    <p class="c-welcome__no-team">Please create your player profile to get started</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if not show_onboarding %}
    <!-- Announcements Card -->
    {% if announcements %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="c-announcements" data-component="announcements">
                <div id="announcementsCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="8000">
                    <div class="c-announcements__wrapper">
                        <div class="c-announcements__icon">
                            <i class="ti ti-bell"></i>
                        </div>
                        <div class="carousel-inner c-announcements__content">
                            {% for announcement in announcements %}
                            <div class="carousel-item c-announcements__item {% if loop.first %}active{% endif %}">
                                <h5 class="c-announcements__title">{{ announcement.title }}</h5>
                                <p class="c-announcements__text">{{ announcement.content }}</p>
                                <small class="c-announcements__date">{{ announcement.created_at.strftime('%B %d, %Y') }}</small>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="c-announcements__nav">
                            <button class="c-carousel-nav" type="button"
                                    data-bs-target="#announcementsCarousel" data-bs-slide="next"
                                    data-action="next-announcement" aria-label="Next announcement">
                                <i class="ti ti-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    {% if not player %}
    <!-- Create Profile Card (if no player profile) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="c-create-profile" data-component="create-profile">
                <img src="{{ url_for('static', filename='img/undraw_profile_details_re_ch9r.svg') }}"
                     alt="Create Profile" class="c-create-profile__image">
                <h3 class="c-create-profile__title">Get Started</h3>
                <p class="c-create-profile__text">Create your player profile to access team information, match scheduling, and more.</p>
                <form method="POST" action="{{ url_for('main.index') }}" data-form="create-profile">
                    {{ onboarding_form.hidden_tag() }}
                    <input type="hidden" name="form_action" id="form_action" value="reset_skip_profile">
                    <button type="submit" class="c-btn c-btn--primary c-btn--lg" data-action="create-profile">
                        <i class="ti ti-user-plus c-btn__icon"></i>Create Player Profile
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    {% if player %}
    <!-- Upcoming Matches Quick View -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="c-section-header" data-component="section-header">
                <h4 class="c-section-header__title">Upcoming Matches</h4>
                {% if user_team and user_team|length > 0 %}
                <div class="c-section-header__controls">
                <div class="c-tabs" id="match-tabs" role="tablist" data-role="tab-navigation" aria-controls="match-tab-content">
                    {% for t in user_team %}
                        <button class="c-tabs__item {% if loop.first %}is-active{% endif %}"
                                id="team-{{ t.id }}-tab"
                                data-action="switch-tab"
                                data-bs-toggle="pill"
                                data-bs-target="#team-{{ t.id }}-content"
                                type="button"
                                role="tab"
                                aria-selected="{% if loop.first %}true{% else %}false{% endif %}"
                                aria-controls="team-{{ t.id }}-content"
                                data-team-id="{{ t.id }}">
                            {{ t.name }}
                        </button>
                    {% endfor %}
                </div>
                </div>
                {% endif %}
            </div>

            <div class="tab-content" id="match-tab-content" data-role="tab-content">
                {% if user_team and user_team|length > 0 %}
                {% for t in user_team %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
                     id="team-{{ t.id }}-content"
                     role="tabpanel"
                     aria-labelledby="team-{{ t.id }}-tab"
                     data-tab-pane
                     data-team-id="{{ t.id }}">

                    {% set team_next_matches = team_matches.get(t.id, {}).get('next', {}) %}

                    {% if team_next_matches|length > 0 %}
                        {% for date, matches in team_next_matches.items() | sort %}
                            <div class="c-match-c-card" data-component="match-card" data-match-date="{{ date }}">
                                <div class="c-match-card__header">
                                    <h5 class="c-match-card__header-title">
                                        <i class="ti ti-calendar-event c-match-card__header-icon"></i>
                                        {{ date.strftime('%A, %B %d, %Y') }}
                                    </h5>
                                    {% if t.league %}
                                    <span class="c-badge c-badge--primary" data-badge data-league-id="{{ t.league.id }}">{{ t.league.name }}</span>
                                    {% endif %}
                                </div>
                                <div class="c-match-card__body">
                                    {% for match_data in matches %}
                                    {% set match = match_data['match'] %}
                                    {% set home_team_name = match_data['home_team_name'] %}
                                    {% set opponent_team_name = match_data['opponent_name'] %}

                                    {% if match_data['home_team_id'] == t.id %}
                                        {% set is_home = true %}
                                        {% set opponent_name = opponent_team_name %}
                                    {% else %}
                                        {% set is_home = false %}
                                        {% set opponent_name = home_team_name %}
                                    {% endif %}

                                    <div class="c-match-card__item" data-match-id="{{ match.id }}">
                                        <div class="c-match-card__info">
                                            <div class="c-match-card__matchup">
                                                <div class="c-match-badge c-match-badge--{% if is_home %}home{% else %}away{% endif %}"
                                                     data-badge
                                                     data-location-type="{% if is_home %}home{% else %}away{% endif %}">
                                                    {% if is_home %}H{% else %}A{% endif %}
                                                </div>
                                                <h6 class="c-match-card__matchup-text">
                                                    {% if match.week_type in ['FUN', 'TST', 'BYE', 'BONUS', 'PLAYOFF'] %}
                                                        <span class="c-badge c-badge--info" data-badge data-week-type="{{ match.week_type }}">
                                                            {% if match.week_type == 'FUN' %}
                                                                Fun Week
                                                            {% elif match.week_type == 'TST' %}
                                                                TST Week
                                                            {% elif match.week_type == 'BYE' %}
                                                                Bye Week
                                                            {% elif match.week_type == 'BONUS' %}
                                                                Bonus Week
                                                            {% elif match.week_type == 'PLAYOFF' %}
                                                                Playoff Week
                                                            {% endif %}
                                                        </span>
                                                        <span class="c-match-card__text--muted">
                                                            {% if match.week_type == 'FUN' %}
                                                                - Special activities
                                                            {% elif match.week_type == 'TST' %}
                                                                - Tournament events
                                                            {% elif match.week_type == 'BYE' %}
                                                                - Week off
                                                            {% elif match.week_type == 'BONUS' %}
                                                                - Additional activities
                                                            {% elif match.week_type == 'PLAYOFF' %}
                                                                {% if match.home_team_id != match.away_team_id %}
                                                                    - vs {{ opponent_name }}
                                                                {% else %}
                                                                    - TBD
                                                                {% endif %}
                                                            {% endif %}
                                                        </span>
                                                    {% else %}
                                                        {% if is_home %}
                                                            <span class="c-match-card__team--highlight">{{ t.name }}</span> vs {{ opponent_name }}
                                                        {% else %}
                                                            {{ opponent_name }} vs <span class="c-match-card__team--highlight">{{ t.name }}</span>
                                                        {% endif %}
                                                    {% endif %}
                                                </h6>
                                            </div>
                                            <div class="c-match-card__details">
                                                <span class="c-match-card__detail">
                                                    <i class="ti ti-clock"></i>{{ match.time.strftime('%I:%M %p') }}
                                                </span>
                                                <span class="c-match-card__detail">
                                                    <i class="ti ti-map-pin"></i>{{ match.location }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="c-match-card__actions">
                                            <div class="c-rsvp" data-component="rsvp-controls" data-match-id="{{ match.id }}">
                                                <div class="c-rsvp__group" role="group" aria-label="RSVP options">
                                                    <input type="radio" class="btn-check rsvp-input" name="response-{{ match.id }}" id="responseYes-{{ match.id }}" value="yes" autocomplete="off">
                                                    <label class="c-rsvp__option c-rsvp__option--yes" for="responseYes-{{ match.id }}" title="I can play" data-rsvp="yes">
                                                        <i class="ti ti-check"></i>
                                                    </label>

                                                    <input type="radio" class="btn-check rsvp-input" name="response-{{ match.id }}" id="responseMaybe-{{ match.id }}" value="maybe" autocomplete="off">
                                                    <label class="c-rsvp__option c-rsvp__option--maybe" for="responseMaybe-{{ match.id }}" title="Maybe" data-rsvp="maybe">
                                                        <i class="ti ti-question-mark"></i>
                                                    </label>

                                                    <input type="radio" class="btn-check rsvp-input" name="response-{{ match.id }}" id="responseNo-{{ match.id }}" value="no" autocomplete="off">
                                                    <label class="c-rsvp__option c-rsvp__option--no" for="responseNo-{{ match.id }}" title="Can't play" data-rsvp="no">
                                                        <i class="ti ti-x"></i>
                                                    </label>
                                                </div>
                                            </div>
                                            <div>
                                                {% if has_permission('view_match_page') %}
                                                <a href="{{ url_for('match_pages.view_match', match_id=match.id) }}"
                                                   class="c-btn c-btn--primary"
                                                   data-action="view-match-details"
                                                   data-match-id="{{ match.id }}">
                                                    Details
                                                </a>
                                                {% endif %}
                                                {% if has_permission('report_match') %}
                                                <button class="c-btn c-btn--outline"
                                                        data-action="edit-match"
                                                        data-match-id="{{ match.id }}"
                                                        data-reported="{{ match.reported | lower }}"
                                                        type="button">
                                                    <i class="ti ti-{% if match.reported %}edit{% else %}report{% endif %} me-1"></i>
                                                    <span class="d-none d-sm-inline">{% if match.reported %}Edit Match Report{% else %}Submit Match Report{% endif %}</span>
                                                    <span class="d-sm-none">{% if match.reported %}Edit{% else %}Report{% endif %}</span>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="c-empty-state" data-component="empty-state">
                            <img src="{{ url_for('static', filename='img/undraw_notify_re_65on.svg') }}"
                                 alt="No Matches" class="c-empty-state__image">
                            <h5 class="c-empty-state__title">No Upcoming Matches</h5>
                            <p class="c-empty-state__text">There are no upcoming matches scheduled for {{ t.name }}.</p>
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <div class="c-empty-state" data-component="empty-state">
                    <img src="{{ url_for('static', filename='img/undraw_notify_re_65on.svg') }}"
                         alt="No Matches" class="c-empty-state__image">
                    <h5 class="c-empty-state__title">No Upcoming Matches</h5>
                    <p class="c-empty-state__text">You are not currently assigned to any teams.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recent Matches -->
    <div class="row">
        <div class="col-12">
            <div class="c-section-header" data-component="section-header">
                <h4 class="c-section-header__title">Recent Matches</h4>
                {% if user_team and user_team|length > 0 %}
                <div class="c-section-header__controls">
                <div class="c-tabs" id="recent-match-tabs" role="tablist" data-role="tab-navigation" aria-controls="recent-match-tab-content">
                    {% for t in user_team %}
                        <button class="c-tabs__item {% if loop.first %}is-active{% endif %}"
                                id="recent-team-{{ t.id }}-tab"
                                data-action="switch-tab"
                                data-bs-toggle="pill"
                                data-bs-target="#recent-team-{{ t.id }}-content"
                                type="button"
                                role="tab"
                                aria-selected="{% if loop.first %}true{% else %}false{% endif %}"
                                aria-controls="recent-team-{{ t.id }}-content"
                                data-team-id="{{ t.id }}">
                            {{ t.name }}
                        </button>
                    {% endfor %}
                </div>
                </div>
                {% endif %}
            </div>

            <div class="tab-content" id="recent-match-tab-content" data-role="tab-content">
                {% if user_team and user_team|length > 0 %}
                {% for t in user_team %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
                     id="recent-team-{{ t.id }}-content"
                     role="tabpanel"
                     aria-labelledby="recent-team-{{ t.id }}-tab"
                     data-tab-pane
                     data-team-id="{{ t.id }}">

                    {% set team_prev_matches = team_matches.get(t.id, {}).get('prev', {}) %}

                    {% if team_prev_matches|length > 0 %}
                        <div class="c-match-c-card" data-component="match-card" data-match-type="recent">
                            <div class="c-match-card__body">
                                {% for date, matches in team_prev_matches.items() | sort(reverse=true) %}
                                    {% for match_data in matches %}
                                    {% set match = match_data['match'] %}
                                    {% set home_team_name = match_data['home_team_name'] %}
                                    {% set opponent_team_name = match_data['opponent_name'] %}

                                    {% if match_data['home_team_id'] == t.id %}
                                        {% set is_home = true %}
                                        {% set opponent_name = opponent_team_name %}
                                    {% else %}
                                        {% set is_home = false %}
                                        {% set opponent_name = home_team_name %}
                                    {% endif %}

                                    <div class="c-match-card__item" data-match-id="{{ match.id }}">
                                        <div class="c-match-card__info">
                                            <div class="c-match-card__matchup">
                                                <div class="c-match-badge c-match-badge--{% if is_home %}home{% else %}away{% endif %}"
                                                     data-badge
                                                     data-location-type="{% if is_home %}home{% else %}away{% endif %}">
                                                    {% if is_home %}H{% else %}A{% endif %}
                                                </div>
                                                <div>
                                                    <h6 class="c-match-card__matchup-text">
                                                        {% if match.week_type in ['FUN', 'TST', 'BYE', 'BONUS', 'PLAYOFF'] %}
                                                            <span class="c-badge c-badge--info" data-badge data-week-type="{{ match.week_type }}">
                                                                {% if match.week_type == 'FUN' %}
                                                                    Fun Week
                                                                {% elif match.week_type == 'TST' %}
                                                                    TST Week
                                                                {% elif match.week_type == 'BYE' %}
                                                                    Bye Week
                                                                {% elif match.week_type == 'BONUS' %}
                                                                    Bonus Week
                                                                {% elif match.week_type == 'PLAYOFF' %}
                                                                    Playoff Week
                                                                {% endif %}
                                                            </span>
                                                            <span class="c-match-card__text--muted">
                                                                {% if match.week_type == 'FUN' %}
                                                                    - Special activities
                                                                {% elif match.week_type == 'TST' %}
                                                                    - Tournament events
                                                                {% elif match.week_type == 'BYE' %}
                                                                    - Week off
                                                                {% elif match.week_type == 'BONUS' %}
                                                                    - Additional activities
                                                                {% elif match.week_type == 'PLAYOFF' %}
                                                                    {% if match.home_team_id != match.away_team_id %}
                                                                        - vs {{ opponent_name }}
                                                                    {% else %}
                                                                        - TBD
                                                                    {% endif %}
                                                                {% endif %}
                                                            </span>
                                                        {% else %}
                                                            {% if is_home %}
                                                                <span class="c-match-card__team--highlight">{{ t.name }}</span> vs {{ opponent_name }}
                                                            {% else %}
                                                                {{ opponent_name }} vs <span class="c-match-card__team--highlight">{{ t.name }}</span>
                                                            {% endif %}
                                                        {% endif %}
                                                    </h6>
                                                    <div class="c-match-card__details">
                                                        <span class="c-match-card__detail">
                                                            {{ date.strftime('%a, %b %d') }} · {{ match.time.strftime('%I:%M %p') }} · {{ match.location }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="c-match-card__actions">
                                            {% if has_permission('view_match_page') %}
                                            <a href="{{ url_for('match_pages.view_match', match_id=match.id) }}"
                                               class="c-btn c-btn--primary"
                                               data-action="view-match-details"
                                               data-match-id="{{ match.id }}">
                                                Details
                                            </a>
                                            {% endif %}
                                            {% if has_permission('report_match') %}
                                            <button class="c-btn c-btn--outline"
                                                    data-action="edit-match"
                                                    data-match-id="{{ match.id }}"
                                                    data-reported="{{ match.reported | lower }}"
                                                    type="button">
                                                <i class="ti ti-{% if match.reported %}edit{% else %}report{% endif %} me-1"></i>
                                                <span class="d-none d-sm-inline">{% if match.reported %}Edit Match Report{% else %}Submit Match Report{% endif %}</span>
                                                <span class="d-sm-none">{% if match.reported %}Edit{% else %}Report{% endif %}</span>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="c-empty-state" data-component="empty-state">
                            <img src="{{ url_for('static', filename='img/undraw_goal_-0-v5v.svg') }}"
                                 alt="No Matches" class="c-empty-state__image">
                            <h5 class="c-empty-state__title">No Recent Matches</h5>
                            <p class="c-empty-state__text">There are no recent matches for {{ t.name }}.</p>
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <div class="c-empty-state" data-component="empty-state">
                    <img src="{{ url_for('static', filename='img/undraw_goal_-0-v5v.svg') }}"
                         alt="No Matches" class="c-empty-state__image">
                    <h5 class="c-empty-state__title">No Recent Matches</h5>
                    <p class="c-empty-state__text">You are not currently assigned to any teams.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block modals %}
{{ super() }}
<!-- Enhanced Onboarding Modal -->
{% if show_onboarding or session.get('force_onboarding') %}
<div class="modal c-modal fade" data-modal id="onboardingSlideModal" tabindex="-1" aria-labelledby="onboardingModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog c-modal__dialog modal-lg c-modal__dialog--lg modal-dialog-centered c-modal__dialog--centered" data-modal-dialog>
        <div class="modal-content c-modal__content shadow-lg border-0" data-modal-content>
            <!-- Modal Header -->
            <div class="modal-header c-modal__header bg-light border-bottom-0 py-3" data-modal-header>
                <h5 class="modal-title c-modal__title fw-bold" id="onboardingModalLabel">
                    <i class="ti ti-user-circle me-2 text-primary"></i>Player Profile Setup
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-action="close-modal" aria-label="Close"></button>
            </div>
            <!-- Modal Body -->
            <div class="modal-body c-modal__body p-0" data-modal-body>
                {% include 'onboarding_modal_content.html' %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock modals %}

{% block custom_css %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/home-modern.css') }}">
{% endif %}
{% endblock %}

{% block custom_js %}
<script>
    // Make show_tour and player_choices globally available
    window.showTour = {{ show_tour | tojson }};
    window.playerChoices = {{ player_choices | tojson }};
</script>
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<!-- Page-specific JS (only in development - bundled in production) -->
<script src="{{ url_for('static', filename='custom_js/tour.js') }}"></script>
<!-- report_match.js loaded globally in base.html -->
{% endif %}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="{{ url_for('static', filename='custom_js/home.js') }}"></script>
{% endif %}
{% if show_onboarding or session.get('force_onboarding') %}
{% if not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="{{ url_for('static', filename='custom_js/onboarding.js') }}"></script>
{% endif %}
<script>
    // Auto-open the onboarding modal when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        const modalElement = document.getElementById('onboardingSlideModal');
        if (modalElement) {
            console.log("Auto-opening onboarding modal");
            try {
                ModalManager.show('onboardingSlideModal', {
                    backdrop: 'static',
                    keyboard: false
                });
            } catch (error) {
                console.error("Error auto-opening modal:", error);
            }
        }
    });
</script>
{% endif %}
{% if player and not config.get('ASSETS_PRODUCTION_MODE') and (vite_production_mode is not defined or not vite_production_mode()) %}
<script src="{{ url_for('static', filename='custom_js/rsvp.js') }}"></script>
<script src="{{ url_for('static', filename='custom_js/simple-cropper.js') }}"></script>
{% endif %}
{% endblock %}
