{% extends "base.html" %}
{% block title %}Discord Role Status and Management{% endblock %}

{% block custom_css %}
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
<style>
    .badge {
        padding: 0.5em 0.8em;
        font-size: 0.85em;
        font-weight: 500;
    }

    .badge-status-synced {
        background-color: #28c76f !important;
        color: #fff;
    }

    .badge-status-missing {
        background-color: #ff9f43 !important;
        color: #fff;
    }

    .badge-status-not-found {
        background-color: #6e6b7b !important;
        color: #fff;
    }

    .role-list {
        font-size: 0.9em;
        margin-bottom: 0.5rem;
    }

        .role-list li {
            padding: 0.2rem 0;
        }

    .role-badge {
        display: inline-block;
        padding: 0.25em 0.6em;
        font-size: 0.85em;
        font-weight: normal;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        margin-bottom: 0.2rem;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(115, 103, 240, 0.05);
    }

    .dataTables_filter input {
        border: 1px solid #d8d6de;
        padding: 0.438rem 1rem;
        border-radius: 0.357rem;
        margin-left: 0.5rem;
    }

    .dataTables_length select {
        border: 1px solid #d8d6de;
        padding: 0.438rem 1rem;
        border-radius: 0.357rem;
        margin: 0 0.5rem;
    }
</style>
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <h4 class="fw-bold py-3 mb-4">
        <span class="text-muted fw-light">Discord /</span> Role Status and Management
    </h4>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Discord Role Status</h5>
            <button type="button" class="btn btn-primary" onclick="massUpdateRoles()">
                <i class="fas fa-sync-alt me-1"></i> Mass Update Roles
            </button>
        </div>

        <div class="card-body">
            <div class="table-responsive">
                <table id="roleStatusTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Team / League</th>
                            <th>Roles</th>
                            <th>Status</th>
                            <th>Last Verified</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in players %}
                        <tr>
                            <td>
                                <div class="d-flex flex-column">
                                    <strong>{{ player.name }}</strong>
                                    <small class="text-muted">{{ player.discord_id }}</small>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span>{{ player.team }}</span>
                                    <small class="text-muted">{{ player.league }}</small>
                                </div>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                        onclick="$('#roles-{{ player.id }}').collapse('toggle')">
                                    <i class="fas fa-list-ul me-1"></i> Show Roles
                                </button>
                                <div id="roles-{{ player.id }}" class="collapse mt-2">
                                    <div class="card card-body p-2 border-light">
                                        <div class="role-list">
                                            <strong class="text-primary">Current:</strong>
                                            <div class="mt-1">
                                                {% for role in player.current_roles %}
                                                <span class="role-badge">{{ role }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="role-list">
                                            <strong class="text-primary">Expected:</strong>
                                            <div class="mt-1">
                                                {% for role in player.expected_roles %}
                                                <span class="role-badge">{{ role }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% set has_all_roles = true %}
                                {% for role in player.expected_roles %}
                                {% if role not in player.current_roles %}
                                {% set has_all_roles = false %}
                                {% endif %}
                                {% endfor %}

                                <span id="status-{{ player.id }}" class="badge
                                    {%- if not player.current_roles -%}
                                        badge-status-not-found
                                    {%- elif has_all_roles -%}
                                        badge-status-synced
                                    {%- else -%}
                                        badge-status-missing
                                    {%- endif -%}">
                                    <i class="fas {% if not player.current_roles %}fa-user-slash
                                               {% elif has_all_roles %}fa-check-circle
                                               {% else %}fa-exclamation-circle{% endif %} me-1"></i>
                                    {%- if not player.current_roles -%}
                                    Not Found In Server
                                    {%- elif has_all_roles -%}
                                    Synced
                                    {%- else -%}
                                    Missing Expected Roles
                                    {%- endif -%}
                                </span>
                            </td>
                            <td data-order="{{ player.last_verified }}">
                                {{ player.last_verified }}
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary"
                                        onclick="updatePlayerRoles({{ player.id }})">
                                    <i class="fas fa-sync-alt me-1"></i> Update
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<!-- Dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>

<!-- Custom Script -->
<script>
    // Initialize Socket.IO
    const socket = io();

    // Configure toastr notifications
    toastr.options = {
        closeButton: true,
        progressBar: true,
        positionClass: "toast-top-right",
        timeOut: 3000,
        extendedTimeOut: 1000,
        preventDuplicates: true,
        newestOnTop: true
    };

    // Initialize DataTable
    $(document).ready(function () {
        const table = $('#roleStatusTable').DataTable({
            pageLength: 25,
            order: [[3, 'desc']], // Sort by status by default
            columns: [
                { orderable: true }, // Player
                { orderable: true }, // Team/League
                { orderable: false }, // Roles
                { orderable: true }, // Status
                {
                    orderable: true,
                    render: function (data, type, row) {
                        if (type === 'display') {
                            const date = new Date(data);
                            return date.toLocaleString();
                        }
                        return data;
                    }
                }, // Last Verified
                { orderable: false } // Actions
            ],
            dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center"l><"d-flex align-items-center"f>>' +
                '<"row"<"col-sm-12"tr>>' +
                '<"d-flex justify-content-between align-items-center mt-3"<"d-flex align-items-center"i><"d-flex align-items-center"p>>',
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search records...",
                lengthMenu: "Show _MENU_ entries"
            }
        });
    });

    function updatePlayerRoles(playerId) {
        const button = $(`button[onclick*="${playerId}"]`).filter((i, el) => el.textContent.trim() === 'Update');
        button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Updating...');

        fetch(`/discord/update_roles/${playerId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success('Roles updated successfully');
                } else {
                    toastr.error(data.message || 'Error updating roles');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                toastr.error('Error updating roles');
            })
            .finally(() => {
                button.prop('disabled', false).text('Update');
            });
    }

    function massUpdateRoles() {
        const button = $('.card-header button');
        button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Updating...');

        fetch('/discord/mass_update_roles', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success('Mass role update initiated');
                } else {
                    toastr.error(data.message || 'Error initiating mass role update');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                toastr.error('Error initiating mass role update');
            })
            .finally(() => {
                button.prop('disabled', false).text('Mass Update Roles');
            });
    }

    // Helper function to escape HTML special characters
    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // Socket.IO event handlers
    socket.on('role_status_update', function (data) {
        const table = $('#roleStatusTable').DataTable();

        data.results.forEach(player => {
            // Find the row for this player
            const row = table.rows().nodes().toArray()
                .find(row => {
                    const button = row.querySelector(`button[onclick*="${player.id}"]`);
                    return button && button.closest('tr');
                });

            if (row) {
                // Update status badge
                const statusBadge = row.querySelector(`#status-${player.id}`);
                const hasAllRoles = player.expected_roles.every(role =>
                    player.current_roles.includes(role));

                if (statusBadge) {
                    if (!player.current_roles.length) {
                        statusBadge.className = 'badge bg-secondary';
                        statusBadge.textContent = 'Not Found In Server';
                    } else if (hasAllRoles) {
                        statusBadge.className = 'badge bg-success';
                        statusBadge.textContent = 'Synced';
                    } else {
                        statusBadge.className = 'badge bg-warning';
                        statusBadge.textContent = 'Missing Expected Roles';
                    }
                }

                // Update roles lists
                const rolesDiv = row.querySelector(`#roles-${player.id}`);
                if (rolesDiv) {
                    const currentRolesList = rolesDiv.querySelector('.current-roles ul');
                    const expectedRolesList = rolesDiv.querySelector('.expected-roles ul');

                    if (currentRolesList) {
                        currentRolesList.innerHTML = player.current_roles
                            .map(role => `<li>${escapeHtml(role)}</li>`)
                            .join('');
                    }

                    if (expectedRolesList) {
                        expectedRolesList.innerHTML = player.expected_roles
                            .map(role => `<li>${escapeHtml(role)}</li>`)
                            .join('');
                    }
                }

                // Update last verified timestamp
                const lastVerifiedCell = row.querySelector('td:nth-child(5)');
                if (lastVerifiedCell) {
                    lastVerifiedCell.textContent = player.last_verified;
                }
            }
        });

        // Redraw table to ensure proper display
        table.draw(false);
    });

    socket.on('role_update', function (player) {
        const table = $('#roleStatusTable').DataTable();
        const row = table.rows().nodes().toArray()
            .find(row => {
                const button = row.querySelector(`button[onclick*="${player.id}"]`);
                return button && button.closest('tr');
            });

        if (row) {
            // Update status badge
            const statusBadge = row.querySelector(`#status-${player.id}`);
            const hasAllRoles = player.expected_roles.every(role =>
                player.current_roles.includes(role));

            if (statusBadge) {
                if (!player.current_roles.length) {
                    statusBadge.className = 'badge bg-secondary';
                    statusBadge.textContent = 'Not Found In Server';
                } else if (hasAllRoles) {
                    statusBadge.className = 'badge bg-success';
                    statusBadge.textContent = 'Synced';
                } else {
                    statusBadge.className = 'badge bg-warning';
                    statusBadge.textContent = 'Missing Expected Roles';
                }
            }

            // Update roles lists
            const rolesDiv = row.querySelector(`#roles-${player.id}`);
            if (rolesDiv) {
                const currentRolesList = rolesDiv.querySelector('.current-roles ul');
                const expectedRolesList = rolesDiv.querySelector('.expected-roles ul');

                if (currentRolesList) {
                    currentRolesList.innerHTML = player.current_roles
                        .map(role => `<li>${escapeHtml(role)}</li>`)
                        .join('');
                }

                if (expectedRolesList) {
                    expectedRolesList.innerHTML = player.expected_roles
                        .map(role => `<li>${escapeHtml(role)}</li>`)
                        .join('');
                }
            }

            // Update last verified timestamp
            const lastVerifiedCell = row.querySelector('td:nth-child(5)');
            if (lastVerifiedCell) {
                lastVerifiedCell.textContent = player.last_verified;
            }

            // Redraw table to ensure proper display
            table.draw(false);
        }
    });
</script>
{% endblock %}