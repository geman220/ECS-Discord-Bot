{% extends "base.html" %}
{% block title %}Discord Role Status and Management{% endblock %}

{% block custom_css %}
<style>
    .role-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.25rem;
        background-color: #f3f4f6;
        border: 1px solid #e5e7eb;
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .loading-spinner {
        animation: spin 1s linear infinite;
    }

    .roles-container {
        display: none;
    }

        .roles-container.show {
            display: block;
            padding: 1rem;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

    .expanded-row {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block main_content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <h4 class="fw-bold py-3 mb-4">
        <span class="text-muted fw-light">Discord /</span> Role Status and Management
    </h4>

    <div id="roleManagementRoot"></div>
</div>
{% endblock %}

{% block custom_js %}
<script type="text/babel">
// CSRF Token helper
const getCSRFToken = () => {
  const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  if (!token) {
    throw new Error('CSRF token not found');
  }
  return token;
};

const { useState, useEffect, useRef } = React;

// Status Badge Component
const StatusBadge = ({ status }) => {
  const getStatusInfo = () => {
    switch (status) {
      case 'Synced':
        return { color: 'bg-success text-white', icon: 'check-circle' };
      case 'Out of Sync':
        return { color: 'bg-warning text-dark', icon: 'exclamation-triangle' };
      case 'Never Verified':
        return { color: 'bg-info text-white', icon: 'info-circle' };
      case 'Not in Discord':
        return { color: 'bg-secondary text-white', icon: 'user-slash' };
      default:
        return { color: 'bg-secondary text-white', icon: 'question-circle' };
    }
  };

  const { color, icon } = getStatusInfo();

  return (
    <span className={`badge ${color} d-inline-flex align-items-center gap-1`}>
      <i className={`fas fa-${icon}`}></i>
      {status}
    </span>
  );
};

// Update Button Component
const UpdateButton = ({ playerId, onUpdate, isLoading }) => {
  const handleClick = async () => {
    if (!isLoading) {
      onUpdate(playerId);
    }
  };

  return (
    <button
      onClick={handleClick}
      disabled={isLoading}
      className="btn btn-primary btn-sm d-inline-flex align-items-center gap-1"
    >
      <i className={`fas fa-sync-alt ${isLoading ? 'loading-spinner' : ''}`}></i>
      {isLoading ? 'Updating...' : 'Update Roles'}
    </button>
  );
};

// Mass Update Button Component
const MassUpdateButton = ({ onMassUpdate, isLoading }) => (
  <button
    onClick={onMassUpdate}
    disabled={isLoading}
    className="btn btn-primary d-inline-flex align-items-center gap-2"
  >
    <i className={`fas fa-sync-alt ${isLoading ? 'loading-spinner' : ''}`}></i>
    {isLoading ? 'Updating All...' : 'Mass Update Roles'}
  </button>
);

// Main Component
const DiscordRoleManagement = () => {
  const [players, setPlayers] = useState([]);
  const [updatingPlayers, setUpdatingPlayers] = useState(new Set());
  const [isMassUpdating, setIsMassUpdating] = useState(false);
  const [isTableLoading, setIsTableLoading] = useState(true);
  const [expandedRows, setExpandedRows] = useState(new Set());

  const handleUpdate = async (playerId) => {
    setUpdatingPlayers(prev => new Set([...prev, playerId]));
    try {
      const token = getCSRFToken();
      const response = await fetch(`/admin/update_player_roles/${playerId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': token
        },
        credentials: 'same-origin'
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || `Server responded with ${response.status}`);
      }

      if (data.success && data.player_data) {
        setPlayers(prevPlayers =>
          prevPlayers.map(p => p.id === playerId
            ? {
                ...p,
                current_roles: data.player_data.current_roles,
                expected_roles: data.player_data.expected_roles,
                status_text: data.player_data.status_text,
                last_verified: data.player_data.last_verified,
                discord_roles_synced: data.player_data.discord_roles_synced
              }
            : p
          )
        );
        toastr.success('Roles updated successfully');
      } else {
        throw new Error(data.error || 'Update failed');
      }
    } catch (error) {
      console.error('Update failed:', error);
      toastr.error(`Failed to update roles: ${error.message}`);
    } finally {
      setUpdatingPlayers(prev => {
        const next = new Set(prev);
        next.delete(playerId);
        return next;
      });
    }
  };

  const handleMassUpdate = async () => {
    setIsMassUpdating(true);
    try {
      const token = getCSRFToken();
      const response = await fetch('/admin/update_discord_roles', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': token
        },
        credentials: 'same-origin'
      });

      if (!response.ok) {
        throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      if (data.success) {
        toastr.success('Mass update initiated');
        setTimeout(() => window.location.reload(), 2000);
      } else {
        throw new Error(data.error || 'Mass update failed');
      }
    } catch (error) {
      console.error('Mass update failed:', error);
      toastr.error(`Failed to initiate mass update: ${error.message}`);
    } finally {
      setIsMassUpdating(false);
    }
  };

  const handleToggleRoles = (playerId) => {
    setExpandedRows((prev) => {
      const newSet = new Set(prev);
      if (newSet.has(playerId)) {
        newSet.delete(playerId);
      } else {
        newSet.add(playerId);
      }
      return newSet;
    });
  };

  useEffect(() => {
    const checkTaskStatus = async () => {
      try {
        const response = await fetch(`/admin/check_role_status/{{ task_id }}`);
        const data = await response.json();

        if (data.state === 'COMPLETE') {
          setPlayers(data.results);  // Update players with task result
          setIsTableLoading(false);  // Loading complete
        } else if (data.state === 'FAILED') {
          toastr.error(`Error loading data: ${data.error}`);
          setIsTableLoading(false);
        } else if (data.state === 'PENDING') {
          setTimeout(checkTaskStatus, 2000); // Retry after delay if still pending
        }
      } catch (error) {
        console.error('Error checking task status:', error);
        toastr.error('Failed to load data');
        setIsTableLoading(false);
      }
    };

    checkTaskStatus();  // Start polling on component load
  }, []);

  return (
    <div className="card">
      <div className="card-header d-flex justify-content-between align-items-center">
        <h5 className="mb-0">Discord Role Status</h5>
        <MassUpdateButton onMassUpdate={handleMassUpdate} isLoading={isMassUpdating} />
      </div>

      <div className="card-body">
        {isTableLoading ? (
          <div className="text-center py-4">
            <i className="fas fa-spinner fa-spin me-2"></i> Loading table...
          </div>
        ) : (
          <div className="table-responsive">
            <table id="roleStatusTable" className="table table-striped">
              <thead>
                <tr>
                  <th>Player</th>
                  <th>Team / League</th>
                  <th>Roles</th>
                  <th>Status</th>
                  <th>Last Verified</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {players.map(player => (
                  <React.Fragment key={player.id}>
                    <tr>
                      <td>
                        <div className="d-flex flex-column">
                          <span className="fw-medium">{player.name}</span>
                          <small className="text-muted">{player.discord_id}</small>
                        </div>
                      </td>
                      <td>
                        <div className="d-flex flex-column">
                          <span>{player.team}</span>
                          <small className="text-muted">{player.league}</small>
                        </div>
                      </td>
                      <td>
                        <button
                          onClick={() => handleToggleRoles(player.id)}
                          className="btn btn-outline-secondary btn-sm d-inline-flex align-items-center gap-1"
                        >
                          <i className={`fas fa-${expandedRows.has(player.id) ? 'minus' : 'plus'}`}></i> Show Roles
                        </button>
                      </td>
                      <td>
                        <StatusBadge status={player.status_text} />
                      </td>
                      <td>{player.last_verified}</td>
                      <td>
                        <UpdateButton
                          playerId={player.id}
                          onUpdate={handleUpdate}
                          isLoading={updatingPlayers.has(player.id)}
                        />
                      </td>
                    </tr>
                    {expandedRows.has(player.id) && (
                      <tr className="expanded-row">
                        <td colSpan="6">
                          <div className="roles-container show">
                            <div className="p-3">
                              <div className="mb-3">
                                <strong className="text-primary">Current Roles:</strong>
                                <div className="mt-1">
                                  {player.current_roles.map(role => (
                                    <span key={role} className="role-badge">{role}</span>
                                  ))}
                                </div>
                              </div>
                              <div>
                                <strong className="text-primary">Expected Roles:</strong>
                                <div className="mt-1">
                                  {player.expected_roles.map(role => (
                                    <span key={role} className="role-badge">{role}</span>
                                  ))}
                                </div>
                              </div>
                            </div>
                          </div>
                        </td>
                      </tr>
                    )}
                  </React.Fragment>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
};

// Initialize React application
ReactDOM.createRoot(document.getElementById('roleManagementRoot')).render(<DiscordRoleManagement />);

// Configure toastr
toastr.options = {
  closeButton: true,
  progressBar: true,
  positionClass: "toast-top-right",
  timeOut: 3000
};
</script>
{% endblock %}
