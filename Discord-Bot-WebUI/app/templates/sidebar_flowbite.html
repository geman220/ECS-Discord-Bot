<!-- Flowbite Sidebar Menu -->
<aside id="sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen transition-transform -translate-x-full lg:translate-x-0" aria-label="Sidebar">
    <div class="h-full flex flex-col bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700">
        <!-- Logo -->
        <div class="flex items-center justify-between px-4 py-4 border-b border-gray-200 dark:border-gray-700">
            <a href="{{ url_for('main.index') }}" class="flex items-center">
                <img src="{{ url_for('static', filename='img/ecs_logo.png') }}" class="h-8 mr-3" alt="ECS Logo" />
                <span class="text-xl font-semibold text-gray-900 dark:text-white">ECS FC</span>
            </a>
            <button type="button" data-drawer-hide="sidebar" class="lg:hidden p-1.5 text-gray-500 rounded-lg hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700">
                <i class="ti ti-x w-5 h-5"></i>
            </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto px-3 py-4">
            <!-- Main Section -->
            <div class="mb-4">
                <span class="px-3 text-xs font-semibold text-gray-500 uppercase dark:text-gray-400">Main</span>
            </div>

            <ul class="space-y-1">
                <!-- Dashboard -->
                {% if safe_current_user.is_authenticated %}
                <li>
                    <a href="{{ url_for('main.index') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-ecs-green/10 text-ecs-green dark:bg-ecs-green/20' if request.endpoint == 'main.index' else '' }}">
                        <i class="ti ti-home w-5 h-5 {{ 'text-ecs-green' if request.endpoint == 'main.index' else 'text-gray-500 dark:text-gray-400' }}"></i>
                        <span class="ml-3">Dashboard</span>
                    </a>
                </li>
                {% endif %}

                <!-- Feedback -->
                {% if safe_current_user.is_authenticated %}
                <li>
                    <a href="{{ url_for('feedback.submit_feedback') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-ecs-green/10 text-ecs-green dark:bg-ecs-green/20' if request.endpoint == 'feedback.submit_feedback' else '' }}">
                        <i class="ti ti-message-report w-5 h-5 {{ 'text-ecs-green' if request.endpoint == 'feedback.submit_feedback' else 'text-gray-500 dark:text-gray-400' }}"></i>
                        <span class="ml-3">Submit Feedback</span>
                    </a>
                </li>
                {% endif %}

                <!-- Coach Dashboard -->
                {% if 'Pub League Coach' in user_roles or 'ECS FC Coach' in user_roles or 'Pub League Admin' in user_roles or 'Global Admin' in user_roles %}
                <li>
                    <a href="{{ url_for('teams.coach_dashboard') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-ecs-green/10 text-ecs-green dark:bg-ecs-green/20' if request.endpoint == 'teams.coach_dashboard' else '' }}">
                        <i class="ti ti-clipboard w-5 h-5 {{ 'text-ecs-green' if request.endpoint == 'teams.coach_dashboard' else 'text-gray-500 dark:text-gray-400' }}"></i>
                        <span class="ml-3">Coach Dashboard</span>
                    </a>
                </li>
                {% endif %}

                <!-- Help Topics -->
                {% if safe_current_user.is_authenticated %}
                <li>
                    <a href="{{ url_for('help.index') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-ecs-green/10 text-ecs-green dark:bg-ecs-green/20' if request.endpoint == 'help.index' else '' }}">
                        <i class="ti ti-help-circle w-5 h-5 {{ 'text-ecs-green' if request.endpoint == 'help.index' else 'text-gray-500 dark:text-gray-400' }}"></i>
                        <span class="ml-3">Help Topics</span>
                    </a>
                </li>
                {% endif %}
            </ul>

            {% set can_view_season_management = 'Pub League Admin' in user_roles or 'Global Admin' in user_roles %}
            {% set can_view_draft = 'Pub League Admin' in user_roles or 'Global Admin' in user_roles or 'Pub League Coach' in user_roles or 'ECS FC Coach' in user_roles %}
            {% set can_view_draft_predictions = 'Pub League Admin' in user_roles or 'Global Admin' in user_roles or 'Pub League Coach' in user_roles %}
            {% set can_view_teams = 'Pub League Admin' in user_roles or 'Global Admin' in user_roles or 'Pub League Coach' in user_roles or 'ECS FC Coach' in user_roles or 'pl-classic' in user_roles or 'pl-ecs-fc' in user_roles or 'pl-premier' in user_roles %}
            {% set can_view_standings = 'Pub League Admin' in user_roles or 'Global Admin' in user_roles or 'Pub League Coach' in user_roles or 'ECS FC Coach' in user_roles %}
            {% set can_view_calendar = 'Pub League Admin' in user_roles or 'Global Admin' in user_roles or 'Pub League Coach' in user_roles or 'ECS FC Coach' in user_roles or 'Pub League Ref' in user_roles %}
            {% set can_view_any_ecsfc_section = can_view_season_management or can_view_draft or can_view_draft_predictions or can_view_standings or can_view_calendar or can_view_teams %}

            <!-- ECS FC League Section -->
            {% if can_view_any_ecsfc_section %}
            <div class="mt-6 mb-4">
                <span class="px-3 text-xs font-semibold text-gray-500 uppercase dark:text-gray-400">ECS FC League</span>
            </div>

            <ul class="space-y-1">
                {% if can_view_season_management %}
                <!-- League Management -->
                <li>
                    <button type="button" class="flex items-center w-full p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group" aria-controls="dropdown-league" data-collapse-toggle="dropdown-league">
                        <i class="ti ti-tournament w-5 h-5 text-gray-500 dark:text-gray-400"></i>
                        <span class="flex-1 ml-3 text-left whitespace-nowrap">League Management</span>
                        <span class="ml-2 px-1.5 py-0.5 text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300 rounded">NEW</span>
                        <i class="ti ti-chevron-down w-4 h-4"></i>
                    </button>
                    <ul id="dropdown-league" class="hidden py-2 space-y-1">
                        <li>
                            <a href="{{ url_for('admin_panel.league_management_dashboard') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">League Hub</a>
                        </li>
                        <li>
                            <a href="{{ url_for('admin_panel.season_wizard') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Season Wizard</a>
                        </li>
                        <li>
                            <a href="{{ url_for('admin_panel.league_management_teams') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Teams</a>
                        </li>
                        <li>
                            <a href="{{ url_for('admin_panel.league_management_seasons') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Seasons</a>
                        </li>
                    </ul>
                </li>
                {% endif %}

                {% if can_view_draft %}
                <!-- Draft -->
                <li>
                    <button type="button" class="flex items-center w-full p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group" aria-controls="dropdown-draft" data-collapse-toggle="dropdown-draft">
                        <i class="ti ti-list w-5 h-5 text-gray-500 dark:text-gray-400"></i>
                        <span class="flex-1 ml-3 text-left whitespace-nowrap">Draft</span>
                        <i class="ti ti-chevron-down w-4 h-4"></i>
                    </button>
                    <ul id="dropdown-draft" class="hidden py-2 space-y-1">
                        <li>
                            <a href="{{ url_for('draft_enhanced.draft_league', league_name='classic') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Classic Division</a>
                        </li>
                        <li>
                            <a href="{{ url_for('draft_enhanced.draft_league', league_name='premier') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Premier Division</a>
                        </li>
                        <li>
                            <a href="{{ url_for('draft_enhanced.draft_league', league_name='ecs_fc') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">ECS FC Division</a>
                        </li>
                        {% if can_view_draft_predictions %}
                        <li>
                            <a href="{{ url_for('draft_predictions.index') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Draft Predictions</a>
                        </li>
                        {% endif %}
                        {% if 'Pub League Admin' in user_roles or 'Global Admin' in user_roles %}
                        <li>
                            <a href="{{ url_for('admin.draft_history') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Draft History</a>
                        </li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- Teams Overview -->
                {% if can_view_teams and admin_settings.teams_navigation_enabled %}
                <li>
                    <a href="{{ url_for('teams.teams_overview') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-ecs-green/10 text-ecs-green dark:bg-ecs-green/20' if request.endpoint == 'teams.teams_overview' else '' }}">
                        <i class="ti ti-users w-5 h-5 {{ 'text-ecs-green' if request.endpoint == 'teams.teams_overview' else 'text-gray-500 dark:text-gray-400' }}"></i>
                        <span class="ml-3">Teams</span>
                    </a>
                </li>
                {% endif %}

                <!-- Standings -->
                {% if can_view_standings %}
                <li>
                    <a href="{{ url_for('teams.view_standings') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-ecs-green/10 text-ecs-green dark:bg-ecs-green/20' if request.endpoint == 'teams.view_standings' else '' }}">
                        <i class="ti ti-chart-bar w-5 h-5 {{ 'text-ecs-green' if request.endpoint == 'teams.view_standings' else 'text-gray-500 dark:text-gray-400' }}"></i>
                        <span class="ml-3">Standings</span>
                    </a>
                </li>
                {% endif %}

                <!-- League Store -->
                {% set store_enabled = admin_settings.get('store_navigation_enabled', True) %}
                {% if ('Pub League Coach' in user_roles or 'Pub League Admin' in user_roles or 'Global Admin' in user_roles) and (store_enabled or 'Global Admin' in user_roles) %}
                <li>
                    <a href="{{ url_for('store.index') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-ecs-green/10 text-ecs-green dark:bg-ecs-green/20' if 'store' in request.path else '' }}">
                        <i class="ti ti-shopping-cart w-5 h-5 {{ 'text-ecs-green' if 'store' in request.path else 'text-gray-500 dark:text-gray-400' }}"></i>
                        <span class="ml-3">League Store</span>
                    </a>
                </li>
                {% endif %}

                <!-- Calendar -->
                {% if can_view_calendar %}
                <li>
                    <a href="{{ url_for('calendar.calendar_view') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-ecs-green/10 text-ecs-green dark:bg-ecs-green/20' if request.endpoint == 'calendar.calendar_view' else '' }}">
                        <i class="ti ti-calendar w-5 h-5 {{ 'text-ecs-green' if request.endpoint == 'calendar.calendar_view' else 'text-gray-500 dark:text-gray-400' }}"></i>
                        <span class="ml-3">Pub League Calendar</span>
                    </a>
                </li>
                {% endif %}
            </ul>
            {% endif %}

            <!-- Admin Panel -->
            {% if 'Global Admin' in user_roles or 'Pub League Admin' in user_roles %}
            <div class="mt-6 mb-4">
                <span class="px-3 text-xs font-semibold text-gray-500 uppercase dark:text-gray-400">Administration</span>
            </div>

            <ul class="space-y-1">
                <li>
                    <a href="{{ url_for('admin_panel.dashboard') }}" class="flex items-center p-2 text-white bg-ecs-green rounded-lg hover:bg-ecs-green/90 group">
                        <i class="ti ti-layout-dashboard w-5 h-5"></i>
                        <span class="ml-3 font-medium">Admin Panel</span>
                        <span class="ml-2 px-1.5 py-0.5 text-xs font-medium bg-white/20 rounded">NEW</span>
                    </a>
                </li>

                <!-- Digital Wallets -->
                <li>
                    <button type="button" class="flex items-center w-full p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group" aria-controls="dropdown-wallets" data-collapse-toggle="dropdown-wallets">
                        <i class="ti ti-device-mobile w-5 h-5 text-gray-500 dark:text-gray-400"></i>
                        <span class="flex-1 ml-3 text-left whitespace-nowrap">Digital Wallets</span>
                        <i class="ti ti-chevron-down w-4 h-4"></i>
                    </button>
                    <ul id="dropdown-wallets" class="hidden py-2 space-y-1">
                        <li>
                            <a href="{{ url_for('wallet_config.setup_wizard') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Setup Wizard</a>
                        </li>
                        <li>
                            <a href="{{ url_for('wallet_admin.wallet_management') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Dashboard</a>
                        </li>
                        <li>
                            <a href="{{ url_for('pass_studio.index') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Pass Studio</a>
                        </li>
                        <li>
                            <a href="{{ url_for('wallet_admin.passes_list') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Manage Passes</a>
                        </li>
                        <li>
                            <a href="{{ url_for('wallet_admin.scanner') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Scanner</a>
                        </li>
                        <li>
                            <a href="{{ url_for('wallet_admin.checkins_list') }}" class="flex items-center w-full p-2 pl-11 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Check-ins</a>
                        </li>
                    </ul>
                </li>
            </ul>
            {% endif %}

            <!-- Legacy Admin Section -->
            {% if 'Pub League Admin' in user_roles or 'Global Admin' in user_roles or 'Discord Admin' in user_roles %}
            <div class="mt-6 mb-4">
                <span class="px-3 text-xs font-semibold text-amber-600 dark:text-amber-400 uppercase flex items-center gap-2">
                    <i class="ti ti-archive w-4 h-4"></i>
                    Legacy Admin
                </span>
            </div>

            <ul class="space-y-1">
                <li class="px-3 py-2 text-xs text-gray-500 dark:text-gray-400 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
                    <i class="ti ti-info-circle w-3 h-3 inline mr-1"></i>
                    Use <a href="{{ url_for('admin_panel.dashboard') }}" class="text-ecs-green hover:underline">Admin Panel</a> instead
                </li>

                {% if 'Pub League Admin' in user_roles or 'Global Admin' in user_roles %}
                <li>
                    <a href="{{ url_for('admin.discord_management') }}" class="flex items-center p-2 text-gray-600 rounded-lg dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 group text-sm">
                        <span class="ml-3">Discord Join Status</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('admin.manage_polls') }}" class="flex items-center p-2 text-gray-600 rounded-lg dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 group text-sm">
                        <span class="ml-3">League Polls</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('admin.message_config.list_categories') }}" class="flex items-center p-2 text-gray-600 rounded-lg dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 group text-sm">
                        <span class="ml-3">Message Management</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('admin.user_approvals') }}" class="flex items-center p-2 text-gray-600 rounded-lg dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 group text-sm">
                        <span class="ml-3">User Approvals</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('user_management.manage_users') }}" class="flex items-center p-2 text-gray-600 rounded-lg dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 group text-sm">
                        <span class="ml-3">Manage Players</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('admin.substitute_pool.manage_substitute_pools') }}" class="flex items-center p-2 text-gray-600 rounded-lg dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 group text-sm">
                        <span class="ml-3">Substitute Pools</span>
                    </a>
                </li>
                {% endif %}

                {% if 'Global Admin' in user_roles %}
                <li>
                    <a href="{{ url_for('monitoring.monitor_dashboard') }}" class="flex items-center p-2 text-gray-600 rounded-lg dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 group text-sm">
                        <span class="ml-3">Task Monitor</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('monitoring.db_monitoring') }}" class="flex items-center p-2 text-gray-600 rounded-lg dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 group text-sm">
                        <span class="ml-3">Database Monitor</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('security_status.security_dashboard') }}" class="flex items-center p-2 text-gray-600 rounded-lg dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 group text-sm">
                        <span class="ml-3">Security Dashboard</span>
                    </a>
                </li>
                {% endif %}
            </ul>
            {% endif %}

            <!-- Players Link (Always visible) -->
            {% if safe_current_user.is_authenticated %}
            <div class="mt-6 mb-4">
                <span class="px-3 text-xs font-semibold text-gray-500 uppercase dark:text-gray-400">Directory</span>
            </div>
            <ul class="space-y-1">
                <li>
                    <a href="{{ url_for('players.view_players') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-ecs-green/10 text-ecs-green dark:bg-ecs-green/20' if request.endpoint == 'players.view_players' else '' }}">
                        <i class="ti ti-users w-5 h-5 {{ 'text-ecs-green' if request.endpoint == 'players.view_players' else 'text-gray-500 dark:text-gray-400' }}"></i>
                        <span class="ml-3">All Players</span>
                    </a>
                </li>
            </ul>
            {% endif %}
        </nav>
    </div>
</aside>
