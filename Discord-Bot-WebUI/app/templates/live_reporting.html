{% extends "base.html" %}

{% block title %}Live Match Reporting{% endblock %}

{% block head %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
{% if not config.get('ASSETS_PRODUCTION_MODE') %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/features/live-reporting.css') }}">
{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3">Live Match Reporting</h1>
            <div id="notifications" class="live-reporting-notifications"></div>

            <div id="reportCompleteMessage" class="live-reporting-report-complete d-none">
                <h4>Match Report Submitted</h4>
                <p>This match has been reported and the data has been saved. Thank you for your contribution!</p>
            </div>

            <div class="live-reporting-match-details">
                <div class="row align-items-center">
                    <div class="col-md-4 text-center">
                        <h3 id="homeTeamName" class="live-reporting-team-name">Home Team</h3>
                        <div class="live-reporting-team-score" id="homeScore">0</div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="live-reporting-status-container">
                            <span id="matchStatusBadge" class="badge bg-success" data-badge>In Progress</span>
                        </div>
                        <div id="timerDisplay" class="live-reporting-timer mt-2 mb-2">00:00</div>
                        <div class="btn-group live-reporting-timer-controls">
                            <button id="startStopTimer" class="c-btn c-btn--success">Start Timer</button>
                            <button id="resetTimer" class="c-btn c-btn--outline-danger">Reset</button>
                        </div>
                        <div class="live-reporting-period-selector">
                            <select id="periodSelector" class="form-select" data-form-select>
                                <option value="first_half">First Half</option>
                                <option value="second_half">Second Half</option>
                                <option value="halftime">Halftime</option>
                                <option value="extra_time_1">Extra Time 1</option>
                                <option value="extra_time_2">Extra Time 2</option>
                                <option value="penalties">Penalties</option>
                                <option value="fulltime">Full Time</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <h3 id="awayTeamName" class="live-reporting-team-name">Away Team</h3>
                        <div class="live-reporting-team-score" id="awayScore">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Score Control Panel -->
        <div class="col-md-3">
            <div class="c-card live-reporting-card">
                <div class="c-card__header">
                    <h5>Score Controls</h5>
                </div>
                <div class="c-card__body">
                    <div class="live-reporting-score-controls">
                        <div>
                            <label for="homeScoreControls">Home Score</label>
                            <div id="homeScoreControls" class="input-group live-reporting-input-group" data-input-group>
                                <button id="decreaseHomeScore" class="c-btn c-btn--outline-secondary">-</button>
                                <span class="form-control live-reporting-score-display" id="homeScoreDisplay">0</span>
                                <button id="increaseHomeScore" class="c-btn c-btn--outline-secondary">+</button>
                            </div>
                        </div>
                        <div>
                            <label for="awayScoreControls">Away Score</label>
                            <div id="awayScoreControls" class="input-group live-reporting-input-group" data-input-group>
                                <button id="decreaseAwayScore" class="c-btn c-btn--outline-secondary">-</button>
                                <span class="form-control live-reporting-score-display" id="awayScoreDisplay">0</span>
                                <button id="increaseAwayScore" class="c-btn c-btn--outline-secondary">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="c-card live-reporting-card mt-3">
                <div class="c-card__header">
                    <h5>Active Reporters</h5>
                </div>
                <div class="c-card__body">
                    <ul id="reportersList" class="list-group live-reporting-reporters-list">
                        <li class="list-group-item live-reporting-loading">Loading reporters...</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Event Entry Panel -->
        <div class="col-md-5">
            <div class="c-card live-reporting-card">
                <div class="c-card__header">
                    <h5>Add Match Event</h5>
                </div>
                <div class="c-card__body">
                    <form id="addEventForm" class="live-reporting-event-form">
                        <div class="mb-3">
                            <label for="eventType" class="form-label">Event Type</label>
                            <select id="eventType" class="form-select" required data-form-select>
                                <option value="">Select Event Type</option>
                                <option value="GOAL">Goal</option>
                                <option value="YELLOW_CARD">Yellow Card</option>
                                <option value="RED_CARD">Red Card</option>
                                <option value="SUBSTITUTION">Substitution</option>
                                <option value="INJURY">Injury</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="eventTeam" class="form-label">Team</label>
                            <select id="eventTeam" class="form-select" required data-form-select>
                                <option value="">Select Team</option>
                                {% if match %}
                                <option value="{{ match.home_team_id }}">{{ match.home_team.name }}</option>
                                <option value="{{ match.away_team_id }}">{{ match.away_team.name }}</option>
                                {% endif %}
                            </select>
                        </div>
                        
                        <div id="playerSelectGroup" class="mb-3 d-none">
                            <label for="eventPlayer" class="form-label">Player</label>
                            <select id="eventPlayer" class="form-select" data-form-select>
                                <option value="">Select Player</option>
                                <!-- Will be populated via JavaScript -->
                            </select>
                        </div>
                        
                        <div id="substitutionFields" class="mb-3 d-none">
                            <label for="playerOut" class="form-label">Player Out</label>
                            <select id="playerOut" class="form-select" data-form-select>
                                <option value="">Select Player Out</option>
                                <!-- Will be populated via JavaScript -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="eventMinute" class="form-label">Minute</label>
                            <input type="number" id="eventMinute" class="form-control" min="0" placeholder="Match minute" data-form-control>
                        </div>
                        
                        <button type="submit" class="c-btn c-btn--primary">Add Event</button>
                    </form>
                </div>
            </div>

            <div class="c-card live-reporting-card mt-3">
                <div class="c-card__header">
                    <h5>Match Events</h5>
                </div>
                <div class="c-card__body">
                    <div id="eventsList" class="live-reporting-events-list"></div>
                </div>
            </div>
        </div>
        
        <!-- Player Shifts & Notes Panel -->
        <div class="col-md-4">
            <div class="c-card live-reporting-card">
                <div class="c-card__header">
                    <h5>Player Shifts (Your Team Only)</h5>
                </div>
                <div class="c-card__body">
                    <div id="playerShiftsContainer" class="live-reporting-shifts-container">
                        <p class="live-reporting-loading">Loading player shifts...</p>
                    </div>
                </div>
            </div>

            <div class="c-card live-reporting-card mt-3">
                <div class="c-card__header">
                    <h5>Match Notes</h5>
                </div>
                <div class="c-card__body">
                    <textarea id="matchNotes" class="form-control live-reporting-notes" rows="5" placeholder="Enter any additional notes about the match here..." data-form-control></textarea>

                    <div>
                        <button id="submitReportBtn" class="c-btn c-btn--success c-btn--lg w-100 live-reporting-submit-btn">Submit Final Report</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<div id="homeTeamPlayers" data-players="{{ home_players|tojson }}" class="live-reporting-hidden-data"></div>
<div id="awayTeamPlayers" data-players="{{ away_players|tojson }}" class="live-reporting-hidden-data"></div>
{% endblock %}

{% block custom_js %}
{{ super() }}
{% if not config.get('ASSETS_PRODUCTION_MODE') %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='custom_js/live_reporting.js') }}"></script>
<script
    data-match-id="{{ match.id }}"
    data-team-id="{{ team_id }}"
    data-socket-url="{{ request.host_url }}">
// Initialize live reporting using data attributes
document.addEventListener('DOMContentLoaded', function() {
    const script = document.currentScript;
    const config = {
        matchId: parseInt(script.dataset.matchId),
        teamId: parseInt(script.dataset.teamId),
        socketUrl: script.dataset.socketUrl.replace(/\/$/, '') // Remove trailing slash
    };

    if (typeof LiveReporting !== 'undefined') {
        LiveReporting.init(config);

        // Update score displays to match the score controls
        const homeScore = document.getElementById('homeScore');
        const awayScore = document.getElementById('awayScore');
        const homeScoreDisplay = document.getElementById('homeScoreDisplay');
        const awayScoreDisplay = document.getElementById('awayScoreDisplay');

        if (homeScore && homeScoreDisplay) {
            homeScoreDisplay.textContent = homeScore.textContent;
        }
        if (awayScore && awayScoreDisplay) {
            awayScoreDisplay.textContent = awayScore.textContent;
        }
    }
});
</script>
{% endif %}
{% endblock %}